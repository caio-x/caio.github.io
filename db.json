{"meta":{"version":1,"warehouse":"4.0.1"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":1,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/spade-logo.png","path":"images/spade-logo.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/spade-logo.svg","path":"images/spade-logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/timg.gif","path":"images/timg.gif","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/js.cookie.js","path":"js/src/js.cookie.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/scroll-cookie.js","path":"js/src/scroll-cookie.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/LICENSE","path":"lib/algolia-instant-search/LICENSE","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/README.md","path":"lib/algolia-instant-search/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css.map","path":"lib/algolia-instant-search/instantsearch.min.css.map","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js.map","path":"lib/algolia-instant-search/instantsearch.min.js.map","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/LICENSE","path":"lib/fancybox/LICENSE","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/README.md","path":"lib/fancybox/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/LICENSE","path":"lib/pace/LICENSE","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/README.md","path":"lib/pace/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","path":"lib/pace/pace-theme-barber-shop.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","path":"lib/pace/pace-theme-big-counter.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","path":"lib/pace/pace-theme-bounce.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","path":"lib/pace/pace-theme-center-atom.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","path":"lib/pace/pace-theme-center-circle.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","path":"lib/pace/pace-theme-center-radar.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","path":"lib/pace/pace-theme-center-simple.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","path":"lib/pace/pace-theme-corner-indicator.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","path":"lib/pace/pace-theme-fill-left.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","path":"lib/pace/pace-theme-flash.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-flat-top.min.css","path":"lib/pace/pace-theme-flat-top.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","path":"lib/pace/pace-theme-loading-bar.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","path":"lib/pace/pace-theme-mac-osx.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-material.min.css","path":"lib/pace/pace-theme-material.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","path":"lib/pace/pace-theme-minimal.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/pace/pace.min.js","path":"lib/pace/pace.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/reading_progress/LICENSE","path":"lib/reading_progress/LICENSE","modified":1,"renderable":1},{"_id":"themes/next/source/lib/reading_progress/README.md","path":"lib/reading_progress/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/lib/reading_progress/package.json","path":"lib/reading_progress/package.json","modified":1,"renderable":1},{"_id":"themes/next/source/lib/reading_progress/reading_progress.js","path":"lib/reading_progress/reading_progress.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/reading_progress/reading_progress.min.js","path":"lib/reading_progress/reading_progress.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/reading_progress/renovate.json","path":"lib/reading_progress/renovate.json","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.css","path":"lib/fancybox/source/jquery.fancybox.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.js","path":"lib/fancybox/source/jquery.fancybox.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":1,"renderable":1}],"Cache":[{"_id":"source/_posts/.DS_Store","hash":"1e230a78a607cfcc7a3553eb0c1c0ee02aed2561","modified":1653118993115},{"_id":"source/_posts/10.runloop-binary-search.md","hash":"e5b5b1f381a4011ef321f30d930b7e6b51ef6454","modified":1598712178494},{"_id":"source/_posts/1.leetcode41.md","hash":"a0d9aec95748a26924adef09e5121ba7b5bf71b7","modified":1598712178493},{"_id":"source/_posts/12.compiler-autorelease-opt.md","hash":"271cb477ad399a52cc1648ac4b4a350b217c17d2","modified":1598712178495},{"_id":"source/_posts/11.dyld.md","hash":"9a5d0b14490de88c3dcebb8d5c6affcaf4b55ed9","modified":1598712178494},{"_id":"source/_posts/15.Sqlite-OS.md","hash":"9afafc4cc1cf7b85f13b50494b02ccfdad59e533","modified":1598712178497},{"_id":"source/_posts/13.sqlite-os-shm.md","hash":"79c24a488b8856d173405467dc4efe501add7bb3","modified":1598712178496},{"_id":"source/_posts/14.gomobile-bind.md","hash":"d35992422356e12492e988c326d69f9cbb3fbe68","modified":1598712178496},{"_id":"source/_posts/17.inside-sqlite-chapter-6.md","hash":"4a10e7786f5fb10f24526a1041f3e8b1c7f0cbb1","modified":1598712178498},{"_id":"source/_posts/2.leetcode5.md","hash":"2c01adccd4b0bcc9133191b7c6097807a7c120fc","modified":1598712178499},{"_id":"source/_posts/18.db-system-design-imp(VM).md","hash":"37a2541c79b80c69ef931b34c97218195c26b1a6","modified":1598858173373},{"_id":"source/_posts/19.SQLite-KeywordHash.md","hash":"492771bc4fa2f55fb6c255898f376a6b77564c84","modified":1598712178499},{"_id":"source/_posts/20.SQLite-Tokenize.md","hash":"129f5bfe447c09ad51eaf74215a07084753ed07c","modified":1598712178500},{"_id":"source/_posts/2020-08-21_db-system-design-imp(Transaction).md","hash":"cac711201a366c4eef541aed738a64251013521d","modified":1598858494085},{"_id":"source/_posts/2020-08-17_db-system-design-imp(Pager).md","hash":"e06f5f3536fd95c39c5e568574266a3bff791d3e","modified":1598858494085},{"_id":"source/_posts/3.binding-symbols.md","hash":"91feb898da3290d3fbdc2960e3058289889a505d","modified":1598712178501},{"_id":"source/_posts/4.synchronized.md","hash":"70b7af21538e9e9271c700ec8cb43fb8f0ca4dc0","modified":1598712178501},{"_id":"source/_posts/2020-08-25_db-system-design-im(storage).md","hash":"6b19ba27f693213051db55fe7d29e69da03b8c98","modified":1598858494086},{"_id":"source/_posts/6.leetcode32.md","hash":"b2a8ab82a4d374d06deac99b1827823d6d2ee614","modified":1598712178502},{"_id":"source/_posts/2020-08-29_db_system_design_imp(WAL).md","hash":"ecc853aa3ef20cb06ae94a7321d0cc388d3f6bb9","modified":1598858494086},{"_id":"source/_posts/5.OC-Block-imp.md","hash":"292cac00516608e7232529b4493308d6f4cad7de","modified":1598712178502},{"_id":"source/_posts/9.LeetCode-week-match.md","hash":"6647510b98c99b6266aa2687bc44eb8356242c2f","modified":1598712178503},{"_id":"source/_posts/8.leetcode47.md","hash":"bb9720e537822af51c82a4baa669b3befee70880","modified":1598712178503},{"_id":"source/_posts/7.leetcode46.md","hash":"9fcd6e50f7fd812ab1a3335f05d90155c50e5e96","modified":1598712178502},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651224},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651159},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651159},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651205},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651205},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651206},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651220},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1591693651222},{"_id":"themes/next/.bowerrc","hash":"3228a58ed0ece9f85e1e3136352094080b8dece1","modified":1591693651122},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1591693651122},{"_id":"themes/next/.gitattributes","hash":"44bd4729c74ccb88110804f41746fec07bf487d4","modified":1591693651122},{"_id":"themes/next/.gitignore","hash":"a18c2e83bb20991b899b58e6aeadcb87dd8aa16e","modified":1591693651124},{"_id":"themes/next/.hound.yml","hash":"b76daa84c9ca3ad292c78412603370a367cc2bc3","modified":1591693651124},{"_id":"themes/next/.javascript_ignore","hash":"8a224b381155f10e6eb132a4d815c5b52962a9d1","modified":1591693651124},{"_id":"themes/next/.stylintrc","hash":"b28e24704a5d8de08346c45286574c8e76cc109f","modified":1591693651124},{"_id":"themes/next/.travis.yml","hash":"d60d4a5375fea23d53b2156b764a99b2e56fa660","modified":1591693651125},{"_id":"themes/next/LICENSE.md","hash":"fc7227c508af3351120181cbf2f9b99dc41f063e","modified":1591693651125},{"_id":"themes/next/.jshintrc","hash":"9928f81bd822f6a8d67fdbc909b517178533bca9","modified":1591693651124},{"_id":"themes/next/README.md","hash":"81c51e4b0fe5eaab6becfc0d6ef342bdd749a781","modified":1591693651125},{"_id":"themes/next/bower.json","hash":"3f8f416899ab12c48a5cc936265d475fa99ce9fe","modified":1591693651126},{"_id":"themes/next/crowdin.yml","hash":"fe22a450cc1272b7ac5476e6b33a999f8b8a2034","modified":1591693651126},{"_id":"themes/next/package.json","hash":"f27fff901d4e34f53cf98cb120d365a8b66c6fd3","modified":1591693651173},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"b63696d41f022525e40d7e7870c3785b6bc7536b","modified":1591693651123},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"476c9bb6616818be9d86567ad4e2e539c0e0da2f","modified":1591693651123},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"7abbb4c8a29b2c14e576a00f53dbc0b4f5669c13","modified":1591693651123},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"00c25366764e6b9ccb40b877c60dc13b2916bbf7","modified":1591693651123},{"_id":"themes/next/.github/browserstack_logo.png","hash":"a6c43887f64a7f48a2814e3714eaa1215e542037","modified":1591693651123},{"_id":"themes/next/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1591693651124},{"_id":"themes/next/gulpfile.coffee","hash":"48d2f9fa88a4210308fc41cc7d3f6d53989f71b7","modified":1591693651132},{"_id":"themes/next/docs/ALGOLIA-SEARCH.md","hash":"141e989844d0b5ae2e09fb162a280715afb39b0d","modified":1591693651126},{"_id":"themes/next/_config.yml","hash":"10142c88853c06409f0fba742ba4d5529ecf5f59","modified":1653120542506},{"_id":"themes/next/docs/AUTHORS.md","hash":"7b24be2891167bdedb9284a682c2344ec63e50b5","modified":1591693651126},{"_id":"themes/next/docs/DATA-FILES.md","hash":"8e1962dd3e1b700169b3ae5bba43992f100651ce","modified":1591693651127},{"_id":"themes/next/docs/INSTALLATION.md","hash":"2bbdd6c1751b2b42ce9b9335da420c6026a483e9","modified":1591693651127},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1591693590887},{"_id":"themes/next/docs/LICENSE","hash":"fe607fe22fc9308f6434b892a7f2d2c5514b8f0d","modified":1591693651127},{"_id":"themes/next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"bbd5aa9a79cac0f630b666bc6db87025e08fb1ac","modified":1591693651127},{"_id":"themes/next/docs/MATH.md","hash":"d047b8a3d9aa49b478a33e5a326195d460cb4589","modified":1591693651128},{"_id":"themes/next/docs/UPDATE-FROM-5.1.X.md","hash":"ad57c168d12ba01cf144a1ea0627b2ffd1847d3e","modified":1591693651128},{"_id":"themes/next/languages/ar.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651133},{"_id":"themes/next/languages/_en.yml","hash":"2397256c752276df666c1ff579902abb367b2380","modified":1591693651133},{"_id":"themes/next/languages/bg.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651133},{"_id":"themes/next/languages/cs.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651134},{"_id":"themes/next/languages/da.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651134},{"_id":"themes/next/languages/bn.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651133},{"_id":"themes/next/languages/de.yml","hash":"31022b4e7caa10ad7551919159fb37c820788398","modified":1591693651134},{"_id":"themes/next/languages/el.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651134},{"_id":"themes/next/languages/es.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651135},{"_id":"themes/next/languages/et.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651135},{"_id":"themes/next/languages/fa.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651135},{"_id":"themes/next/languages/fi.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651135},{"_id":"themes/next/languages/he.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651136},{"_id":"themes/next/languages/fr.yml","hash":"059d66eea84757a2c330e865262cbf5d22e384ca","modified":1591693651136},{"_id":"themes/next/languages/hr.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651137},{"_id":"themes/next/languages/hi.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651136},{"_id":"themes/next/languages/hu.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651137},{"_id":"themes/next/languages/ja.yml","hash":"7ff7c14c97291e2e29ad1e10fa96bcab8fe35a18","modified":1591693651138},{"_id":"themes/next/languages/it.yml","hash":"2f183ebc0e26c0ce899e57f1b98b0d1727f8ac06","modified":1591693651138},{"_id":"themes/next/languages/id.yml","hash":"6aedba65605a6b63451767f6ac4359c7ca72b4b5","modified":1591693651137},{"_id":"themes/next/languages/jv.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651138},{"_id":"themes/next/languages/ko.yml","hash":"e8f29cb1684262cc7de8807f70f22ce25b68ae4e","modified":1591693651139},{"_id":"themes/next/languages/lt.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651139},{"_id":"themes/next/languages/lv.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651140},{"_id":"themes/next/languages/ms.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651140},{"_id":"themes/next/languages/nl.yml","hash":"b9e752c19a2fa8b9b24ab382c903da3fcefb48df","modified":1591693651140},{"_id":"themes/next/languages/no.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651141},{"_id":"themes/next/languages/pl.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651141},{"_id":"themes/next/languages/pa.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651141},{"_id":"themes/next/languages/pt-BR.yml","hash":"08a9d21e2ed1c7871ad2e4c14f57cd5d21fecb20","modified":1591693651142},{"_id":"themes/next/languages/pt.yml","hash":"bc1e2b1857b3dbf15632950bd3c06971b9eb7b17","modified":1591693651142},{"_id":"themes/next/languages/ro.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651143},{"_id":"themes/next/languages/ru.yml","hash":"13af9d32b823628453ac732e888e95b80ba03c0a","modified":1591693651143},{"_id":"themes/next/languages/sl.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651144},{"_id":"themes/next/languages/sr.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651144},{"_id":"themes/next/languages/sv.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651144},{"_id":"themes/next/languages/th.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651144},{"_id":"themes/next/languages/tr.yml","hash":"65b9d8ef239de9d449ff47ed9ba543d2b7665885","modified":1591693651144},{"_id":"themes/next/languages/uk.yml","hash":"371331112a7ec4a61991cb12870ca85b7856b43d","modified":1591693651145},{"_id":"themes/next/languages/vi.yml","hash":"946a5cf34dd0595cd5a4f41706dfb742264f4a27","modified":1591693651145},{"_id":"themes/next/languages/zh-CN.yml","hash":"7f2ddf4653fc62fabd85bd36130cd53653426fb5","modified":1591693651145},{"_id":"themes/next/languages/zh-HK.yml","hash":"40f3543ec83f15d4d6f5af1782a0424c0cd8a009","modified":1591693651146},{"_id":"themes/next/languages/zh-TW.yml","hash":"475359a40f23133d33da29f161239f180e208ace","modified":1591693651146},{"_id":"themes/next/layout/_layout.swig","hash":"2a64ba9244060f691b2b4236847bebb4c061e8f2","modified":1591717395816},{"_id":"themes/next/layout/archive.swig","hash":"833a2213d31be45a12b8e4e5e609073978bd251b","modified":1591693651171},{"_id":"themes/next/layout/category.swig","hash":"4472255f4a3e3dd6d79201523a9526dcabdfbf18","modified":1591693651171},{"_id":"themes/next/layout/index.swig","hash":"783611349c941848a0e26ee2f1dc44dd14879bd1","modified":1591693651171},{"_id":"themes/next/layout/page.swig","hash":"3f9b2444f12251727ebbc28159f02e9e9489742e","modified":1591693651171},{"_id":"themes/next/layout/post.swig","hash":"8e2d079b46076996cc9343213d5bf7da8178d32d","modified":1591693651172},{"_id":"themes/next/layout/schedule.swig","hash":"d86f8de4e118f8c4d778b285c140474084a271db","modified":1591693651172},{"_id":"themes/next/scripts/merge-configs.js","hash":"ca9845dc76f5710b4c6fba5fe25ff0d2fcf0adaa","modified":1591693651173},{"_id":"themes/next/layout/tag.swig","hash":"7e0a7d7d832883eddb1297483ad22c184e4368de","modified":1591693651172},{"_id":"themes/next/scripts/merge.js","hash":"9130dabe6a674c54b535f322b17d75fe6081472f","modified":1591693651173},{"_id":"themes/next/source/.DS_Store","hash":"495dc0d217dbc3e7cb0c015a4aa9af3e7011d37f","modified":1653120481129},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1591693651244},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1591693651245},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1591693651245},{"_id":"themes/next/docs/ru/DATA-FILES.md","hash":"d6d20f60f77a76c77f8e65d0c9adbd79d0274557","modified":1591693651128},{"_id":"themes/next/docs/ru/INSTALLATION.md","hash":"6c5d69e94961c793da156217ecf1179e868d7ba1","modified":1591693651129},{"_id":"themes/next/docs/ru/README.md","hash":"fd2ee8e3f5afed406f11f24b13e3174dd0d40611","modified":1591693651129},{"_id":"themes/next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"b1dd18d9b890b21718883ea1832e7e02a773104a","modified":1591693651129},{"_id":"themes/next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"6855402e2ef59aae307e8bd2a990647d3a605eb8","modified":1591693651130},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"a45a791b49954331390d548ac34169d573ea5922","modified":1591693651130},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"98ef4dc1a7a12320211ffb36d264cd86ffcce0dd","modified":1591693651130},{"_id":"themes/next/docs/zh-CN/DATA-FILES.md","hash":"f3eec572a7d83542e2710a7404082014aaa1a5e7","modified":1591693651131},{"_id":"themes/next/docs/zh-CN/INSTALLATION.md","hash":"b19a6e0ae96eb7c756fb5b1ba03934c7f9cbb3c3","modified":1591693651131},{"_id":"themes/next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"0bc0c3eb909f137c859f38c5c66dcb7c29f76ead","modified":1591693651131},{"_id":"themes/next/docs/zh-CN/MATH.md","hash":"1c7df019737656fdfd8d124c7c045a64ac8a2a8d","modified":1591693651132},{"_id":"themes/next/docs/zh-CN/README.md","hash":"c561c6e3ce4d0941d60d1217c597b19eb00095ff","modified":1591693651132},{"_id":"themes/next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"c1ba919f70efe87a39e6217883e1625af0b2c23c","modified":1591693651132},{"_id":"themes/next/layout/_custom/head.swig","hash":"9e1b9666efa77f4cf8d8261bcfa445a9ac608e53","modified":1591693651147},{"_id":"themes/next/layout/_custom/header.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1591693651147},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1591693651147},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"31322a7f57936cf2dc62e824af5490da5354cf02","modified":1591693651149},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"464082e431ea5b06df782d5f312ee25be9e5f169","modified":1591693651149},{"_id":"themes/next/layout/_macro/post-related.swig","hash":"08fe30ce8909b920540231e36c97e28cfbce62b6","modified":1591693651149},{"_id":"themes/next/layout/_macro/reward.swig","hash":"aa620c582143f43ba1cb1a5e59240041a911185b","modified":1591693651150},{"_id":"themes/next/layout/_macro/post.swig","hash":"7b85cd74fe673d1c842e705a18ae2e2e04f5d391","modified":1591693651150},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"355ddd5b8af696f7bffb183addd7e84c0a4e2123","modified":1591693651151},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"fea45ab314b9ea23edab25c2b8620f909d856b1d","modified":1591693651151},{"_id":"themes/next/layout/_partials/breadcrumb.swig","hash":"6994d891e064f10607bce23f6e2997db7994010e","modified":1591693651151},{"_id":"themes/next/layout/_partials/comments.swig","hash":"5df32b286a8265ba82a4ef5e1439ff34751545ad","modified":1591693651152},{"_id":"themes/next/layout/_partials/footer.swig","hash":"f62e6198dcc41b1cb6a1036094e724065d4e4008","modified":1591693651152},{"_id":"themes/next/layout/_partials/header.swig","hash":"6bdae92508fb5009b023386341f3b161a4ac6c70","modified":1591693651154},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"1aaf32bed57b976c4c1913fd801be34d4838cc72","modified":1591693651154},{"_id":"themes/next/layout/_partials/search.swig","hash":"9dbd378e94abfcb3f864a5b8dbbf18d212ca2ee0","modified":1591693651154},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"928cec3bd26f7aae7d20bf23e1917ad009933f0f","modified":1591721135072},{"_id":"themes/next/layout/_partials/sub-menu.swig","hash":"9783a9569fe8344ed287013156e52ca1b0a25544","modified":1591693651156},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"03aaebe9d50f6acb007ec38cc04acd1cfceb404d","modified":1591693651157},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"766b2bdda29523ed6cd8d7aa197f996022f8fd94","modified":1591693651157},{"_id":"themes/next/layout/_scripts/noscript.swig","hash":"ac3ad2c0eccdf16edaa48816d111aaf51200a54b","modified":1591693651158},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"e0bdc723d1dc858b41fd66e44e2786e6519f259f","modified":1591693651160},{"_id":"themes/next/layout/_third-party/bookmark.swig","hash":"60001c8e08b21bf3a7afaf029839e1455340e95d","modified":1591693651163},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"7c04a42319d728be356746363aff8ea247791d24","modified":1591693651166},{"_id":"themes/next/layout/_third-party/needsharebutton.swig","hash":"927f19160ae14e7030df306fc7114ba777476282","modified":1591693651168},{"_id":"themes/next/layout/_third-party/github-banner.swig","hash":"cabd9640dc3027a0b3ac06f5ebce777e50754065","modified":1591693651166},{"_id":"themes/next/layout/_third-party/pangu.swig","hash":"6b75c5fd76ae7cf0a7b04024510bd5221607eab3","modified":1591693651168},{"_id":"themes/next/scripts/tags/button.js","hash":"5a61c2da25970a4981fbd65f4a57c5e85db4dcda","modified":1591693651174},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"db70a841e7c1708f95ca97b44413b526b267fa9b","modified":1591693651174},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"fc93b1a7e6aed0dddb1f3910142b48d8ab61174e","modified":1591693651169},{"_id":"themes/next/scripts/tags/exturl.js","hash":"2b3a4dc15dea33972c0b6d46a1483dabbf06fb5b","modified":1591693651174},{"_id":"themes/next/scripts/tags/full-image.js","hash":"a98fc19a90924f2368e1982f8c449cbc09df8439","modified":1591693651175},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"22369026c87fc23893c35a7f250b42f3bb1b60f1","modified":1591693651169},{"_id":"themes/next/layout/_third-party/scroll-cookie.swig","hash":"1ddb2336a1a19b47af3017047012c01ec5f54529","modified":1591693651169},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"1b97b1b5364945b8ab3e50813bef84273055234f","modified":1591693651175},{"_id":"themes/next/scripts/tags/include-raw.js","hash":"b7600f6b868d8f4f7032126242d9738cd1e6ad71","modified":1591693651175},{"_id":"themes/next/scripts/tags/label.js","hash":"621004f2836040b12c4e8fef77e62cf22c561297","modified":1591693651176},{"_id":"themes/next/scripts/tags/lazy-image.js","hash":"460e5e1f305847dcd4bcab9da2038a85f0a1c273","modified":1591693651176},{"_id":"themes/next/scripts/tags/note.js","hash":"4975d4433e11161b2e9a5744b7287c2d667b3c76","modified":1591693651176},{"_id":"themes/next/scripts/tags/tabs.js","hash":"5786545d51c38e8ca38d1bfc7dd9e946fc70a316","modified":1591693651177},{"_id":"themes/next/source/css/main.styl","hash":"c26ca6e7b5bd910b9046d6722c8e00be672890e0","modified":1591693651222},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1591693651224},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1591693590943},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1591693590943},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1591693590944},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1591693590944},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1591693590944},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1591693590945},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1591693590946},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1591693590945},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1591693590945},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1591693590946},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1591693590946},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1591693590946},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1591693651226},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1591693651226},{"_id":"themes/next/source/images/spade-logo.png","hash":"96977336310ca4a0401c1cc396179012ddf6b5f8","modified":1653120339042},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1591693651226},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1591693651227},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1591693651227},{"_id":"themes/next/layout/_macro/menu/menu-badge-2.swig","hash":"7b96a0e6079e845573338523cea4437817a4b1e1","modified":1591693651148},{"_id":"themes/next/layout/_macro/menu/menu-badge-1.swig","hash":"7ffc5c159ab566805ceda6b8c7a4149a7e296116","modified":1591693651148},{"_id":"themes/next/layout/_macro/menu/menu-item.swig","hash":"6a04cd1ef9ebac103d86b61505fa9b0f26268fdc","modified":1591693651148},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"7ce76358411184482bb0934e70037949dd0da8ca","modified":1591693651152},{"_id":"themes/next/source/images/spade-logo.svg","hash":"4fd1156094ba99ceebb68436bfdcdcc529ed8cda","modified":1653120524719},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"957701729b85fb0c5bfcf2fb99c19d54582f91ed","modified":1591693651155},{"_id":"themes/next/layout/_partials/head/head.swig","hash":"9f7aa33a620aea6ede1fb907b61fd071c018c525","modified":1591693651153},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"959b7e04a96a5596056e4009b73b6489c117597e","modified":1591693651155},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"eefe2388ff3d424694045eda21346989b123977c","modified":1591693651155},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"23e23dc0f76ef3c631f24c65277adf7ea517b383","modified":1591693651155},{"_id":"themes/next/layout/_partials/head/head-unique.swig","hash":"cd7e3331a61939c820e0437bf5d815cb0a42fefb","modified":1591693651153},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"1f1107468aaf03f7d0dcd7eb2b653e2813a675b4","modified":1591693651156},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"048fd5e98149469f8c28c21ba3561a7a67952c9b","modified":1591693651156},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"89c5a5240ecb223acfe1d12377df5562a943fd5d","modified":1591693651156},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1591693651159},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1591693651158},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"069d1357c717572256e5cdee09574ebce529cbae","modified":1591693651158},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"60426bf73f8a89ba61fb1be2df3ad5398e32c4ef","modified":1591693651160},{"_id":"themes/next/layout/_third-party/analytics/analytics-with-widget.swig","hash":"98df9d72e37dd071e882f2d5623c9d817815b139","modified":1591693651160},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"deda6a814ed48debc694c4e0c466f06c127163d0","modified":1591693651160},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"67f0cb55e6702c492e99a9f697827629da036a0c","modified":1591693651161},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"8160b27bee0aa372c7dc7c8476c05bae57f58d0f","modified":1591693651161},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"a234c5cd1f75ca5731e814d0dbb92fdcf9240d1b","modified":1591693651161},{"_id":"themes/next/layout/_third-party/analytics/firestore.swig","hash":"94b26dfbcd1cf2eb87dd9752d58213338926af27","modified":1591693651161},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"beb53371c035b62e1a2c7bb76c63afbb595fe6e5","modified":1591693651162},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"5e9bb24c750b49513d9a65799e832f07410002ac","modified":1591693651162},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"cee047575ae324398025423696b760db64d04e6f","modified":1591693651163},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"0ddc94ed4ba0c19627765fdf1abc4d8efbe53d5a","modified":1591693651163},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"3658414379e0e8a34c45c40feadc3edc8dc55f88","modified":1591693651163},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"0e3378f7c39b2b0f69638290873ede6b6b6825c0","modified":1591693651164},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"c3971fd154d781088e1cc665035f8561a4098f4c","modified":1591693651163},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"2fbee33a4ccd7c8217c73e85a9a1488170e05629","modified":1591693651164},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"17a54796f6e03fc834880a58efca45c286e40e40","modified":1591693651164},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"40e3cacbd5fa5f2948d0179eff6dd88053e8648e","modified":1591693651165},{"_id":"themes/next/layout/_third-party/comments/gitment.swig","hash":"fe8177e4698df764e470354b6acde8292a3515e0","modified":1591693651164},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"6f340d122a9816ccdf4b45b662880a4b2d087671","modified":1591693651165},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"c0eb6123464d745ac5324ce6deac8ded601f432f","modified":1591693651165},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"42f62695029834d45934705c619035733762309e","modified":1591693651165},{"_id":"themes/next/layout/_third-party/math/index.swig","hash":"a6fc00ec7f5642aabd66aa1cf51c6acc5b10e012","modified":1591693651167},{"_id":"themes/next/layout/_third-party/math/katex.swig","hash":"97dbc2035bcb5aa7eafb80a4202dc827cce34983","modified":1591693651168},{"_id":"themes/next/layout/_third-party/math/mathjax.swig","hash":"011ae6303afacddabc4ddf570fe3dd227569cd4f","modified":1591693651168},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"c747fb5c6b1f500e8f0c583e44195878b66e4e29","modified":1591693651170},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"b15e10abe85b4270860a56c970b559baa258b2a8","modified":1591693651170},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"cb3a5d36dbe1630bab84e03a52733a46df7c219b","modified":1591693651170},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"c057b17f79e8261680fbae8dc4e81317a127c799","modified":1591693651170},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"328d9a9696cc2ccf59c67d3c26000d569f46344c","modified":1591693651204},{"_id":"themes/next/source/css/_mixins/Gemini.styl","hash":"2aa5b7166a85a8aa34b17792ae4f58a5a96df6cc","modified":1591693651204},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"2640a54fa63bdd4c547eab7ce2fc1192cf0ccec8","modified":1591693651205},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"81ca13d6d0beff8b1a4b542a51e3b0fb68f08efd","modified":1591693651206},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"7a2706304465b9e673d5561b715e7c72a238437c","modified":1591693651219},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"be087dcc060e8179f7e7f60ab4feb65817bd3d9f","modified":1591693651219},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"32392d213f5d05bc26b2dc452f2fc6fea9d44f6d","modified":1591693651220},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1591693651228},{"_id":"themes/next/source/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1591693651228},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"531cdedd7fbe8cb1dab2e4328774a9f6b15b59da","modified":1591693651228},{"_id":"themes/next/source/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1591693651229},{"_id":"themes/next/source/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1591693651229},{"_id":"themes/next/source/css/_variables/base.styl","hash":"cfb03ec629f13883509eac66e561e9dba562333f","modified":1591693651221},{"_id":"themes/next/source/js/src/motion.js","hash":"50e57f8acb6924c6999cdcc664ddd3f0730d2061","modified":1591693651229},{"_id":"themes/next/source/js/src/post-details.js","hash":"d1333fb588d4521b4d1e9c69aef06e0ad1bf0b12","modified":1591693651230},{"_id":"themes/next/source/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1591693651230},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1591693651231},{"_id":"themes/next/source/js/src/utils.js","hash":"9543f124adba1f6e3c93d61f85e3e6f74ed5fff4","modified":1591693651231},{"_id":"themes/next/source/lib/algolia-instant-search/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1591704216482},{"_id":"themes/next/source/lib/algolia-instant-search/README.md","hash":"73c4092f53b27d322f89dc33ba26f826e10bd3fc","modified":1591704216482},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"6e01a39d7f6d58a0895957361b0a942543c18332","modified":1591704216482},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css.map","hash":"d055d06395af598682873d1b458166dc6f513072","modified":1591704216483},{"_id":"themes/next/source/lib/fancybox/.bower.json","hash":"d8bf9cb15d9d91c7ad022ba2954b5b4d326f17f7","modified":1591694693841},{"_id":"themes/next/source/lib/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1591694693841},{"_id":"themes/next/source/lib/fancybox/README.md","hash":"8286582ed7c338fce8bb03566b769fba378bce83","modified":1591694693842},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"a2aaaf12378db56bd10596ba3daae30950eac051","modified":1591693651231},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1591693651231},{"_id":"themes/next/source/lib/fancybox/LICENSE","hash":"8624bcdae55baeef00cd11d5dfcfa60f68710a02","modified":1591694693842},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1591693651232},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1591693651232},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1591693651232},{"_id":"themes/next/source/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1591696396231},{"_id":"themes/next/source/lib/pace/README.md","hash":"168f57bb63563b9671d0c4f10c0940e7eec261f0","modified":1591696396231},{"_id":"themes/next/source/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1591696396231},{"_id":"themes/next/source/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1591696396231},{"_id":"themes/next/source/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1591696396231},{"_id":"themes/next/source/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1591696396232},{"_id":"themes/next/source/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1591696396232},{"_id":"themes/next/source/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1591696396232},{"_id":"themes/next/source/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1591696396232},{"_id":"themes/next/source/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1591696396232},{"_id":"themes/next/source/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1591696396233},{"_id":"themes/next/source/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1591696396233},{"_id":"themes/next/source/lib/pace/pace-theme-flat-top.min.css","hash":"5e1c97e232b46e48592a8e4983ae5a89e0a7da6a","modified":1591696396233},{"_id":"themes/next/source/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1591696396233},{"_id":"themes/next/source/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1591696396234},{"_id":"themes/next/source/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1591696396234},{"_id":"themes/next/source/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1591696396234},{"_id":"themes/next/source/lib/pace/pace-theme-material.min.css","hash":"f1ff83985c090f3a3236554c5ef69542dcceb049","modified":1591696396234},{"_id":"themes/next/source/lib/reading_progress/.editorconfig","hash":"7d47ecd70ca58d26af4f69ff1b23034edcf4475e","modified":1591694856744},{"_id":"themes/next/source/lib/reading_progress/.gitignore","hash":"09cde1060b4213a7eee528b54560777d2d3756e8","modified":1591694856745},{"_id":"themes/next/source/lib/reading_progress/README.md","hash":"d370ea928bad9e91fd8f1590e23e279b9a959516","modified":1591694856745},{"_id":"themes/next/source/lib/reading_progress/reading_progress.js","hash":"ec68a79421cfba022ac53f46813d013dd48617c0","modified":1591694856745},{"_id":"themes/next/source/lib/reading_progress/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1591694856745},{"_id":"themes/next/source/lib/reading_progress/package.json","hash":"b48a3293b45d8cab41e0ab61a64104a854f6dc94","modified":1591694856745},{"_id":"themes/next/source/lib/reading_progress/renovate.json","hash":"cb29cc16e61b0b8a6dac34657d76822ae29ad5aa","modified":1591694856746},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1591693590953},{"_id":"themes/next/source/lib/reading_progress/reading_progress.min.js","hash":"b768dc009e6d37dd952632c317f6c33e6e2d89ad","modified":1591694856746},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"28ff4ed6714c59124569ffcbd10f1173d53ca923","modified":1591693651169},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"ba698f49dd3a868c95b240d802f5b1b24ff287e4","modified":1591693651170},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1591693590953},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1591693651244},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"4719ce717962663c5c33ef97b1119a0b3a4ecdc3","modified":1591693651178},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"7e509c7c28c59f905b847304dd3d14d94b6f3b8e","modified":1591693651179},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"31050fc7a25784805b4843550151c93bfa55c9c8","modified":1591693651178},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"a6bb5256be6195e76addbda12f4ed7c662d65e7a","modified":1591693651179},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"c5d48863f332ff8ce7c88dec2c893f709d7331d3","modified":1591693651184},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1591693651179},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"9c25c75311e1bd4d68df031d3f2ae6d141a90766","modified":1591693651201},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"18309b68ff33163a6f76a39437e618bb6ed411f8","modified":1591693651201},{"_id":"themes/next/source/css/_common/scaffolding/mobile.styl","hash":"47a46583a1f3731157a3f53f80ed1ed5e2753e8e","modified":1591693651201},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"a280a583b7615e939aaddbf778f5c108ef8a2a6c","modified":1591693651203},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"ece571f38180febaf02ace8187ead8318a300ea7","modified":1591693651202},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"dd8a3b22fc2f222ac6e6c05bd8a773fb039169c0","modified":1591693651195},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"0810e7c43d6c8adc8434a8fa66eabe0436ab8178","modified":1591693651203},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"f362fbc791dafb378807cabbc58abf03e097af6d","modified":1591693651207},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"2186be20e317505cd31886f1291429cc21f76703","modified":1591693651200},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"0bef9f0dc134215bc4d0984ba3a16a1a0b6f87ec","modified":1591693651207},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"5ae7906dc7c1d9468c7f4b4a6feddddc555797a1","modified":1591693651208},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1591693651209},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"f43c821ea272f80703862260b140932fe4aa0e1f","modified":1591693651210},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"3b25edfa187d1bbbd0d38b50dd013cef54758abf","modified":1591693651210},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1591693651211},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"5e12572b18846250e016a872a738026478ceef37","modified":1591693651211},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c4ed249798296f60bda02351fe6404fb3ef2126f","modified":1591693651215},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"ba1842dbeb97e46c6c4d2ae0e7a2ca6d610ada67","modified":1591693651216},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"05a5abf02e84ba8f639b6f9533418359f0ae4ecb","modified":1591693651216},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"2f878213cb24c5ddc18877f6d15ec5c5f57745ac","modified":1591693651217},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"41f9cdafa00e256561c50ae0b97ab7fcd7c1d6a2","modified":1591693651217},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"a863f2c8bae1fbccdc181a5d178b808cd80c5b5e","modified":1591693651218},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"5779cc8086b1cfde9bc4f1afdd85223bdc45f0a0","modified":1591693651218},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"0efa036a15c18f5abb058b7c0fad1dd9ac5eed4c","modified":1591693651213},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"8829bc556ca38bfec4add4f15a2f028092ac6d46","modified":1591693651213},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"35f093fe4c1861661ac1542d6e8ea5a9bbfeb659","modified":1591693651214},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1591693651214},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"d5e8ea6336bc2e237d501ed0d5bbcbbfe296c832","modified":1591693651215},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"8050a5b2683d1d77238c5762b6bd89c543daed6e","modified":1591693651230},{"_id":"themes/next/source/lib/algolia-instant-search/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1591704216481},{"_id":"themes/next/source/lib/algolia-instant-search/.git/config","hash":"ae057b7f33eac7ddf41bed1c7a3323eb69ec0b7c","modified":1591704216478},{"_id":"themes/next/source/lib/algolia-instant-search/.git/index","hash":"473ec3dcf4d3b1dd545731c33ee785418f86a99d","modified":1591704216500},{"_id":"themes/next/source/lib/fancybox/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1591694693835},{"_id":"themes/next/source/lib/algolia-instant-search/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1591704144470},{"_id":"themes/next/source/lib/fancybox/.git/config","hash":"0bd9061daa1ae14bc8c15ccb2616123858620669","modified":1591694693837},{"_id":"themes/next/source/lib/algolia-instant-search/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1591704216476},{"_id":"themes/next/source/lib/algolia-instant-search/.git/packed-refs","hash":"dc5939fb60e7abf14be4a48afc6f33d2ef552182","modified":1591704216474},{"_id":"themes/next/source/lib/fancybox/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1591694693841},{"_id":"themes/next/source/lib/fancybox/.git/index","hash":"4e8e12837c84bbeef892b8c3e8739c7961e62b54","modified":1591694693844},{"_id":"themes/next/source/lib/fancybox/.git/packed-refs","hash":"b6ffcdb23c4f9b3e5576fe104e8596ea71603c84","modified":1591694693833},{"_id":"themes/next/source/lib/fancybox/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1591694683143},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"e43435fb9eaa918f5b8e35c9e110124b8bd13751","modified":1591694693842},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1591694693842},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1591693651233},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1591693651233},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1591693651234},{"_id":"themes/next/source/lib/pace/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1591696396225},{"_id":"themes/next/source/lib/pace/.git/config","hash":"46d590e05dc25560a69d5cc71b337adad9654443","modified":1591696396227},{"_id":"themes/next/source/lib/pace/.git/index","hash":"c00e77521f0abcdf5b7f22f4fd2b5638be3dc050","modified":1591696396235},{"_id":"themes/next/source/lib/pace/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1591696396230},{"_id":"themes/next/source/lib/reading_progress/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1591694856739},{"_id":"themes/next/source/lib/pace/.git/packed-refs","hash":"7728d474cdaa7943851d42c42eaa718b8afbab97","modified":1591696396223},{"_id":"themes/next/source/lib/reading_progress/.git/config","hash":"961f76a65d5278408c0317ac92bff35cfe52dfe8","modified":1591694856741},{"_id":"themes/next/source/lib/pace/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1591696391377},{"_id":"themes/next/source/lib/reading_progress/.git/ORIG_HEAD","hash":"c3a5b4d087fc215a47ada68f273f638af2748aed","modified":1591703175524},{"_id":"themes/next/source/lib/reading_progress/.git/FETCH_HEAD","hash":"667367eb6a4e1446ae947ec12e04817cf3eae906","modified":1591703175512},{"_id":"themes/next/source/lib/reading_progress/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1591694853138},{"_id":"themes/next/source/lib/reading_progress/.git/index","hash":"c4b4ce66d5adf472211323368451df8b02bf1e13","modified":1591703165407},{"_id":"themes/next/source/lib/reading_progress/.git/packed-refs","hash":"597329f8dc2dcf3e89a864dc1f0b5401fd87acf2","modified":1591694856737},{"_id":"themes/next/source/lib/reading_progress/.github/stale.yml","hash":"fd0856f6745db8bd0228079ccb92a662830cc4fb","modified":1591694856744},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"39dee82d481dd9d44e33658960ec63e47cd0a715","modified":1591693651179},{"_id":"themes/next/source/css/_common/components/header/github-banner.styl","hash":"ee37e6c465b9b2a7e39175fccfcbed14f2db039b","modified":1591693651180},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"7cc3f36222494c9a1325c5347d7eb9ae53755a32","modified":1591693651180},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1591693651180},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"8a2421cb9005352905fae9d41a847ae56957247e","modified":1591693651180},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"6c00f6e0978f4d8f9a846a15579963728aaa6a17","modified":1591693651180},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1591693651241},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"49c2b2c14a1e7fcc810c6be4b632975d0204c281","modified":1591693651181},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"96f32ea6c3265a3889e6abe57587f6e2a2a40dfb","modified":1591693651181},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"17b95828f9db7f131ec0361a8c0e89b0b5c9bff5","modified":1591693651181},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"b76387934fb6bb75212b23c1a194486892cc495e","modified":1591693651181},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"f5aa2ba3bfffc15475e7e72a55b5c9d18609fdf5","modified":1591693651182},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"7dd9a0378ccff3e4a2003f486b1a34e74c20dac6","modified":1591693651182},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"4eff5b252d7b614e500fc7d52c97ce325e57d3ab","modified":1591693651182},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"fb451dc4cc0355b57849c27d3eb110c73562f794","modified":1591693651183},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1591693651183},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1591693651240},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"a82afbb72d83ee394aedc7b37ac0008a9823b4f4","modified":1591693651183},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"e72a89e0f421444453e149ba32c77a64bd8e44e8","modified":1591693651184},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"0f7f522cc6bfb3401d5afd62b0fcdf48bb2d604b","modified":1591693651184},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"2cdc094ecf907a02fce25ad4a607cd5c40da0f2b","modified":1591693651185},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f54367c0feda6986c030cc4d15a0ca6ceea14bcb","modified":1591693651185},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"ca89b167d368eac50a4f808fa53ba67e69cbef94","modified":1591693651186},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"387ce23bba52b22a586b2dfb4ec618fe1ffd3926","modified":1591693651186},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"0b57ca04dc3998cf70bb90d777b0db05f3928b82","modified":1591693651187},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"a5d8617a24d7cb6c5ad91ea621183ca2c0917331","modified":1591693651187},{"_id":"themes/next/source/css/_common/components/post/post-reading_progress.styl","hash":"f4e9f870baa56eae423a123062f00e24cc780be1","modified":1591693651188},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"36332c8a91f089f545f3c3e8ea90d08aa4d6e60c","modified":1591693651188},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"017074ef58166e2d69c53bb7590a0e7a8947a1ed","modified":1591693651189},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1591693651189},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"10251257aceecb117233c9554dcf8ecfef8e2104","modified":1591693651190},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"d5a4e4fc17f1f7e7c3a61b52d8e2e9677e139de7","modified":1591693651190},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"e4055a0d2cd2b0ad9dc55928e2f3e7bd4e499da3","modified":1591693651190},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"8bf095377d28881f63a30bd7db97526829103bf2","modified":1591693651191},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"35c0350096921dd8e2222ec41b6c17a4ea6b44f2","modified":1591693651191},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"920343e41c124221a17f050bbb989494d44f7a24","modified":1591693651191},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"89dd4f8b1f1cce3ad46cf2256038472712387d02","modified":1591693651191},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"efa5e5022e205b52786ce495d4879f5e7b8f84b2","modified":1591693651192},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"9486ddd2cb255227db102d09a7df4cae0fabad72","modified":1591693651192},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"45fa7193435a8eae9960267438750b4c9fa9587f","modified":1591693651192},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"4427ed3250483ed5b7baad74fa93474bd1eda729","modified":1591693651194},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"f7784aba0c1cd20d824c918c120012d57a5eaa2a","modified":1591693651194},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"43bc58daa8d35d5d515dc787ceb21dd77633fe49","modified":1591693651195},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"3623e7fa4324ec1307370f33d8f287a9e20a5578","modified":1591693651195},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"c2abe4d87148e23e15d49ee225bc650de60baf46","modified":1591693651196},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"5d15cc8bbefe44c77a9b9f96bf04a6033a4b35b8","modified":1591693651196},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"1b3cc9f4e5a7f6e05b4100e9990b37b20d4a2005","modified":1591693651196},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"4851b981020c5cbc354a1af9b831a2dcb3cf9d39","modified":1591693651196},{"_id":"themes/next/source/css/_common/components/tags/label.styl","hash":"4a457d265d62f287c63d48764ce45d9bcfc9ec5a","modified":1591693651196},{"_id":"themes/next/source/css/_common/components/tags/note-modern.styl","hash":"ee7528900578ef4753effe05b346381c40de5499","modified":1591693651197},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"32c9156bea5bac9e9ad0b4c08ffbca8b3d9aac4b","modified":1591693651197},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"ead0d0f2321dc71505788c7f689f92257cf14947","modified":1591693651197},{"_id":"themes/next/source/css/_common/components/tags/tabs.styl","hash":"4ab5deed8c3b0c338212380f678f8382672e1bcb","modified":1591693651197},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"10e9bb3392826a5a8f4cabfc14c6d81645f33fe6","modified":1591693651197},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"93b08815c4d17e2b96fef8530ec1f1064dede6ef","modified":1591693651198},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"d4e6d8d7b34dc69994593c208f875ae8f7e8a3ae","modified":1591693651198},{"_id":"themes/next/source/css/_common/components/third-party/gitment.styl","hash":"34935b40237c074be5f5e8818c14ccfd802b7439","modified":1591693651198},{"_id":"themes/next/source/css/_common/components/third-party/han.styl","hash":"cce6772e2cdb4db85d35486ae4c6c59367fbdd40","modified":1591693651198},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"327b5f63d55ec26f7663185c1a778440588d9803","modified":1591693651199},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"d89c4b562b528e4746696b2ad8935764d133bdae","modified":1591693651199},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"76937db9702053d772f6758d9cea4088c2a6e2a3","modified":1591693651199},{"_id":"themes/next/source/css/_common/components/third-party/needsharebutton.styl","hash":"a5e3e6b4b4b814a9fe40b34d784fed67d6d977fa","modified":1591693651199},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"1c06be422bc41fd35e5c7948cdea2c09961207f6","modified":1591693651200},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1591693651212},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1591693651212},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1591693651215},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1591704144470},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1591704144471},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1591704144472},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1591704144471},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1591704144473},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1591704144471},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1591704144473},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/pre-merge-commit.sample","hash":"04c64e58bc25c149482ed45dbd79e40effb89eb7","modified":1591704144473},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1591704144474},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1591704144472},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1591704144472},{"_id":"themes/next/source/lib/algolia-instant-search/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1591704144469},{"_id":"themes/next/source/lib/algolia-instant-search/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1591704144474},{"_id":"themes/next/source/lib/algolia-instant-search/.git/logs/HEAD","hash":"4c7f2fc196480a5a7a8bd688701c70a2263b9e0b","modified":1591704216477},{"_id":"themes/next/source/lib/fancybox/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1591694683143},{"_id":"themes/next/source/lib/fancybox/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1591694683144},{"_id":"themes/next/source/lib/fancybox/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1591694683145},{"_id":"themes/next/source/lib/fancybox/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1591694683144},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1591694683145},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1591694683144},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-merge-commit.sample","hash":"04c64e58bc25c149482ed45dbd79e40effb89eb7","modified":1591694683145},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1591694683145},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1591694683144},{"_id":"themes/next/source/lib/fancybox/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1591694683144},{"_id":"themes/next/source/lib/fancybox/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1591694683145},{"_id":"themes/next/source/lib/fancybox/.git/logs/HEAD","hash":"f2d932b7f3351aaa9583cb59085aaf7fa8d64b24","modified":1591694693836},{"_id":"themes/next/source/lib/fancybox/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1591694683143},{"_id":"themes/next/source/lib/fancybox/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1591694683142},{"_id":"themes/next/source/lib/pace/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1591696391377},{"_id":"themes/next/source/lib/pace/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1591696391378},{"_id":"themes/next/source/lib/pace/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1591696391380},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1591696391380},{"_id":"themes/next/source/lib/pace/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1591696391378},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1591696391378},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-merge-commit.sample","hash":"04c64e58bc25c149482ed45dbd79e40effb89eb7","modified":1591696391380},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1591696391380},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1591696391379},{"_id":"themes/next/source/lib/pace/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1591696391378},{"_id":"themes/next/source/lib/pace/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1591696391380},{"_id":"themes/next/source/lib/pace/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1591696391379},{"_id":"themes/next/source/lib/pace/.git/logs/HEAD","hash":"92278856710cd90783f24138db792a19e14e2943","modified":1591696396226},{"_id":"themes/next/source/lib/pace/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1591696391376},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1591694853138},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1591694853139},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1591694853139},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1591694853139},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1591694853138},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1591694853140},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1591694853140},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/pre-merge-commit.sample","hash":"04c64e58bc25c149482ed45dbd79e40effb89eb7","modified":1591694853139},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1591694853140},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1591694853138},{"_id":"themes/next/source/lib/reading_progress/.git/logs/HEAD","hash":"61e070c6de6c54acd58b56671aee75ab5c244bc3","modified":1591694856740},{"_id":"themes/next/source/lib/reading_progress/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1591694853138},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1591694853139},{"_id":"themes/next/source/lib/reading_progress/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1591694853139},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/26/041255661ec27600579e1ba00c5898aa6f8b48","hash":"d6013a8e8a369061c0ef69f48f89ec61320f0ba7","modified":1591704216466},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/08/777d50ffb9e517f20d2cbf2ea19130862fb501","hash":"110fcf7830673d2a7715f8347834f7393597ecd0","modified":1591704216464},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1591704148855},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/0d/49463cf444a6411519b6d7b5bb65fa7e96c4dc","hash":"8baa9ed7c87fbf1a9fdeb378c656471cb98c48e5","modified":1591704148858},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1591704148855},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/2b/a3834eb798ac34ab72ed5fdf7a56d175fee554","hash":"e8edf92b35519a3ec9333c7b54243eca7edc37f2","modified":1591704209546},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/54/7b348ba5c8725ea590087860a352c8ff41cb98","hash":"79281e0d03b3acdbce61914bbfef33ae0c29be6d","modified":1591704148854},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/59/0f6f985f6018c397b2499bb49e599b7109ec06","hash":"650b4b24a81daa3b02646b7ffd5ccdac11ab6be8","modified":1591704209546},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1591704148856},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/6d/b4c7bd4b80f34ae7165de7d91291759569d572","hash":"f04a0f8b9dde5d5c36f470634ca8f958a3b6aa15","modified":1591704216465},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/92/1eb7be3c529d19b6c92ce67e4099e8f7d6adf3","hash":"023bef5405aee54ae6b00e1e02eb6984b691ccbf","modified":1591704216465},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/74/1e8eedaad6125d0feee4afcc124ba0bffc48c5","hash":"0963b162d9de3c8df0d966c07299efd39389da5d","modified":1591704148858},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/6d/c836cd5e780134d73d56944a2e7039bacc7cb3","hash":"5a6fc74f4eff0b3bf6429b28df2a5d721c92933a","modified":1591704209545},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/72/77a0daac0e35928cb7e7905e28b7d490f18fea","hash":"fd53bdb026530aa2254de2dbc21f91c6ac4ca66a","modified":1591704149698},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/a4/0c9f2635389a60948f0f2235f037277f8acff6","hash":"ec4074d54b477aea533dab38384dd9a52fa58854","modified":1591704148857},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/be/20adccf394f75e31e8f8b5fdf22728a1770602","hash":"665067f8dc3adcb99fa753845e7be4440eed9fc3","modified":1591704148851},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/c7/fbb078f1639009ff35512e07a344065d222948","hash":"123afd34f26169b38c32f4b035562726036fd960","modified":1591704148852},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/b2/88437db05849d7556c1ca77f48e1e467c49837","hash":"08035d18e8af952a4da5c5b726fa291fcf5664db","modified":1591704216467},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/c9/af6112eed1dab47eba55651562f768bfbc861d","hash":"a3ce783cca46bdcba0a1eda2d034c77221e07e06","modified":1591704148853},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/da/0b2b5f2ab8f750444499f17e4cbf6074aef7f0","hash":"b343b66897d47a95d9a4363eaab8ff61a1c8a683","modified":1591704148853},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/eb/c17e345ba26077f759ce9f3af0868234200765","hash":"7e458a3ddef5d0a43916751453e8d404ab22cc2a","modified":1591704216467},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/f5/e09255981809338b668b56510e360595fc12fa","hash":"c385e27cf914367d1fde121a2c920b93832cf2ed","modified":1591704216463},{"_id":"themes/next/source/lib/algolia-instant-search/.git/refs/heads/master","hash":"cb263068622d3a28d619a3576c4efbed8e9e546d","modified":1591704216477},{"_id":"themes/next/source/lib/fancybox/.git/objects/00/c03f6be011e8878608eec12f68caf42b73f38e","hash":"8516bd35bc8f9223e13de5877778c8d14d49d6db","modified":1591694693822},{"_id":"themes/next/source/lib/fancybox/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1591694686537},{"_id":"themes/next/source/lib/fancybox/.git/objects/19/3567a3107003507fafacd255c349857e417926","hash":"ef5eab75e8c6998cb223edb4eb8a26c4cfc9415c","modified":1591694693093},{"_id":"themes/next/source/lib/fancybox/.git/objects/16/b01254a56610f4c6b7721c534ed4fc40ae51dd","hash":"88ca5fd99322d3a4067e0711af79f41c078f2ef5","modified":1591694687982},{"_id":"themes/next/source/lib/fancybox/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1591694686537},{"_id":"themes/next/source/lib/fancybox/.git/objects/36/9bab09306448a2970d378b59bb21c059edad63","hash":"877e0c15623d0d6ff8f09bb627fc60a489f3c105","modified":1591694686955},{"_id":"themes/next/source/lib/fancybox/.git/objects/1f/a2c5f332b7e304431213aec21012e53f8781d7","hash":"7632806182aa989d3b7029579d5c03c34b113ee3","modified":1591694686531},{"_id":"themes/next/source/lib/fancybox/.git/objects/40/9607f1ba381a64c3ccb8d5440299e8ef868ef8","hash":"a462f7a9efebb70c4051f92c09ccbd9885132c77","modified":1591694693824},{"_id":"themes/next/source/lib/fancybox/.git/objects/47/d427b6c52396bbab53a05f57aaa82b52c805b1","hash":"c5626bbb62f4d1d1e39034e7f44baf4c509410d6","modified":1591694691156},{"_id":"themes/next/source/lib/fancybox/.git/objects/3d/521bfc64755e348870094e85323dc1b9c96a6b","hash":"e9660fc4f89ecb176b0ab6e4860579c1bfe9f9cb","modified":1591694686535},{"_id":"themes/next/source/lib/fancybox/.git/objects/53/ceaabe0f8677333c5be196778b3e40840a1869","hash":"7bc1c1c42059d5402335b5293bfb5e54bee22557","modified":1591694686533},{"_id":"themes/next/source/lib/fancybox/.git/objects/51/cf05811ed7d35e92551db1ba5a6e267ce781a5","hash":"99c009035ea86e3876b586577677d4d62ae12379","modified":1591694686534},{"_id":"themes/next/source/lib/fancybox/.git/objects/54/0a7b36ee26decfc3f0f34bf73bc85c48899128","hash":"2e5447a9dd879d71368e9dddd34d93849d00b934","modified":1591694693823},{"_id":"themes/next/source/lib/fancybox/.git/objects/64/c47e893a0fef71c8c0930975ef114d9812da56","hash":"eaad75fab15724f9c2b069fc1ce9b8216be149d7","modified":1591694686957},{"_id":"themes/next/source/lib/fancybox/.git/objects/78/068b93f813cecbbd50c8247de547035009d512","hash":"4bc2bee779bd7e3cca13ee34801cf1e12585e5ae","modified":1591694686956},{"_id":"themes/next/source/lib/fancybox/.git/objects/63/c555caede30ab06d6dba16644a827e9574c8cb","hash":"846603220288272ad5d35ebdc3c917cc4adce424","modified":1591694686530},{"_id":"themes/next/source/lib/fancybox/.git/objects/7b/15d3cb03fda86241f8b2b335f04e9b9de0e1c4","hash":"d1fe3bd82c90f7d93874798a8ee8ebf1391d7207","modified":1591694692420},{"_id":"themes/next/source/lib/fancybox/.git/objects/7c/c60b295fa2dcb82537a63792c9b3b3c2e74c33","hash":"b2dc23c71b13726c391aaefaa5312227a9b6ab7e","modified":1591694687984},{"_id":"themes/next/source/lib/fancybox/.git/objects/89/9d7a75b543fbed2a785f67d995bc77e06eb2e9","hash":"5651e2b80703225f642625c0fb2646543096d2cf","modified":1591694686532},{"_id":"themes/next/source/lib/fancybox/.git/objects/7c/00ef8195b73793d477d22e723ecdac9553ebf3","hash":"fd8c4fd143b32fb3e86367f123feb7c35b305262","modified":1591694691151},{"_id":"themes/next/source/lib/fancybox/.git/objects/92/4369c371444afb18fb86309229f5b4c24c6cf4","hash":"9eb6fa8ff9081e6650f6bee350d21567df105737","modified":1591694693091},{"_id":"themes/next/source/lib/fancybox/.git/objects/94/a9ed024d3859793618152ea559a168bbcbb5e2","hash":"1c2d080a86f03eb960e112a94910a5115addf57a","modified":1591694686954},{"_id":"themes/next/source/lib/fancybox/.git/objects/9b/fe9361836240600c1bcc3cab9d42b35e731fad","hash":"3d38ffc7ac1ae85224691ef15d7f32e40c40b3a2","modified":1591694687981},{"_id":"themes/next/source/lib/fancybox/.git/objects/80/6b27034bd69d563e4243c2f12b43c7064b32dd","hash":"b7d3e8020767ae60a2029da8eccb0068623dc618","modified":1591694691155},{"_id":"themes/next/source/lib/fancybox/.git/objects/ad/569256343419017e8832a38faaa1c786716a1d","hash":"0538e4abd112b0a843035f28a511edabbe73f2ce","modified":1591694686531},{"_id":"themes/next/source/lib/fancybox/.git/objects/b3/b3098638624b56be968573e2dab1684f8a7f06","hash":"6fa11a2d904dff2b8f4ae1bd88bdbb66736438a1","modified":1591694689554},{"_id":"themes/next/source/lib/fancybox/.git/objects/b6/c361c8dcf2f5a7572e81b956272e4cfe1198c1","hash":"3e160c605dbd94dcef2b9692a4a5a82bddb76264","modified":1591694693826},{"_id":"themes/next/source/lib/fancybox/.git/objects/bd/e1f741357b44b49290d43fdd193125202fef81","hash":"9beefc75cc0c37d04e98dd13b51ad85df40e77b9","modified":1591694686536},{"_id":"themes/next/source/lib/fancybox/.git/objects/c2/fc5def1b6c38369e5e8b849adb956bd79b549e","hash":"27f03b9616e615b2724bac0fa4507d152697f3f1","modified":1591694686533},{"_id":"themes/next/source/lib/fancybox/.git/objects/aa/654e17af8c354994f706c4e33bba6b5b70caeb","hash":"22b1bdf0b0974bf5e9022953ac26066056c235ff","modified":1591694693821},{"_id":"themes/next/source/lib/fancybox/.git/objects/ce/c0e316bee5d497ee834dbd29e0c5aad8331052","hash":"3d769fa5f55014841d10bb3bdf1b9725c43e9043","modified":1591694693825},{"_id":"themes/next/source/lib/fancybox/.git/objects/f6/bb280a0b2c68256a8e906b35c6976c80c1b3be","hash":"5daaee11fc384fbe0f02c7123036c954ee9a73fd","modified":1591694686536},{"_id":"themes/next/source/lib/fancybox/.git/objects/d5/d10f6be62acc10fec6e11e8dc4affe1184a17b","hash":"cec51b2539349d2aba1ec5d11eaded3815eccdc5","modified":1591694689557},{"_id":"themes/next/source/lib/fancybox/.git/refs/heads/master","hash":"0b56bdb897316a3b4ec6c120673249f65f4cb420","modified":1591694693836},{"_id":"themes/next/source/lib/fancybox/.git/objects/ac/97c2cc9f61c52753abe4174a4a74b2064e5af0","hash":"272e74036b0612de83d9d0aa9604d3edf888b249","modified":1591694692419},{"_id":"themes/next/source/lib/pace/.git/objects/1c/159365320ef5dde63906912f3df067376b40d0","hash":"1dd6b7373c3f9c67e34aa319c9c08fd0f667156a","modified":1591696396209},{"_id":"themes/next/source/lib/pace/.git/objects/08/38a9623fabb4014d7ed7c0fa4ff8a5bc5e697e","hash":"aeee9d11c3a4c1dec1ad8414dca14e5aa9ca2b7d","modified":1591696395657},{"_id":"themes/next/source/lib/pace/.git/objects/27/8da13dccb38df6bb34360d4919ee2ba81ea6c7","hash":"c5618315849061059ddd6cbea8e11252c561cf48","modified":1591696396215},{"_id":"themes/next/source/lib/pace/.git/objects/00/13175fe71888324d9142744034e8296501174a","hash":"0ad0e50f7fe91fe14491924aa4b1e2e8f060a5cd","modified":1591696395664},{"_id":"themes/next/source/lib/pace/.git/objects/23/4f9b3e93f06a85cb2ec01acc872ccdc2bec7cb","hash":"63f8640eceff35a80175a102fcbd8789e690cfaa","modified":1591696396210},{"_id":"themes/next/source/lib/pace/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1591696395662},{"_id":"themes/next/source/lib/pace/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1591696395663},{"_id":"themes/next/source/lib/pace/.git/objects/3e/dcd352d2a1a60dbb6a43e7e9f00bab8b55791a","hash":"725bf5094855cd943dd1cd351906fb1ebec1d861","modified":1591696395667},{"_id":"themes/next/source/lib/pace/.git/objects/35/a749d823ad0aae6111a76dc501a1170478f376","hash":"e757129fb6bca3170b62b05f3e850e4b55f3ae88","modified":1591696396206},{"_id":"themes/next/source/lib/pace/.git/objects/41/28e69301ad36a283c0fc523f3aef89644d2467","hash":"d8b985cf431fbdc5b4fa3be89e27db7a3437c920","modified":1591696396211},{"_id":"themes/next/source/lib/pace/.git/objects/49/0db22b657dd64430d003fe2831905a54858b22","hash":"43694656c4c331cfa3667afca630bd486ac0d0fe","modified":1591696396203},{"_id":"themes/next/source/lib/pace/.git/objects/49/234ebf40b265bb9664d22bc391237ff856a3df","hash":"b527eb3cde1e78771ff68c5f633a3cf91816e274","modified":1591696396216},{"_id":"themes/next/source/lib/pace/.git/objects/4d/fbb499a4f7b2f26a535c335cd66c966ff8b261","hash":"14e4cdcc137045c7efed32f796273d40c9fcef87","modified":1591696396204},{"_id":"themes/next/source/lib/pace/.git/objects/53/3d55db0342c2b011ac05703c3b42e88a25c1ed","hash":"c48454760d2e04602a5499188b33d38839c58aee","modified":1591696396205},{"_id":"themes/next/source/lib/pace/.git/objects/5f/2920b23993e6476c3edc77f76eba566e74dd7e","hash":"122d8ac05247282340317587435273e6f3c5a188","modified":1591696396208},{"_id":"themes/next/source/lib/pace/.git/objects/60/8cf35556105f51783ede3fa1e6c2102e8945de","hash":"2c71f7a2ff047119ee898a8edec216238710b89b","modified":1591696395665},{"_id":"themes/next/source/lib/pace/.git/objects/68/54b8cf544e974998061fb08ea2bd96b561ed68","hash":"1aa0706b6495a5ebd70c3822ac3533df41940fb7","modified":1591696396207},{"_id":"themes/next/source/lib/pace/.git/objects/61/fcbe3a99ad371eacdf3a3703883f8e95e072c8","hash":"480b60d684f9a077ade5dda0acfc75bcd9597aff","modified":1591696395660},{"_id":"themes/next/source/lib/pace/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1591696395664},{"_id":"themes/next/source/lib/pace/.git/objects/6a/fa2f52022b00caac3817898d4338ce4d99aa45","hash":"1a6e249ff197293bc3733ddb7eb99d82a21b9342","modified":1591696396212},{"_id":"themes/next/source/lib/pace/.git/objects/7e/7e5cf8a2a18caf4e0262d1656dea658374d5ae","hash":"47eb39060193e0032e3223b4dfc1a6a55f6612fd","modified":1591696396213},{"_id":"themes/next/source/lib/pace/.git/objects/82/8dcba3c8a21de08d1eb38f2eee453b51543188","hash":"629aad2ee2e564790e78cd46e99ad396544960ab","modified":1591696395667},{"_id":"themes/next/source/lib/pace/.git/objects/86/ab4cb05d5132451e71dc4ecf6ef663f7404126","hash":"53f157552aa57d405ce6ab58c424bb948c2820d8","modified":1591696395661},{"_id":"themes/next/source/lib/pace/.git/objects/8b/b4535a79cc15127f8906b24c4e0bb4a38a5947","hash":"9c2d65a63f18929b09f3592dda064f24309ff98b","modified":1591696395669},{"_id":"themes/next/source/lib/pace/.git/objects/60/0378418401f2b0e7c58407a7bbc5a5196cfa51","hash":"20489d796247dda758599f40cbfcf14d194ef64a","modified":1591696395659},{"_id":"themes/next/source/lib/pace/.git/objects/84/a17ac7b4fe9cea559de91f00af88f810bff7f1","hash":"b41b6d3cbccd75b711f0523bba1c26bf19b0a862","modified":1591696395658},{"_id":"themes/next/source/lib/pace/.git/objects/97/1e8a1f2ad6d45f693980c106af0aead9d1c215","hash":"e45f0963920a53a57f6b53d178e5b05a8e315189","modified":1591696395666},{"_id":"themes/next/source/lib/pace/.git/objects/9b/3058068409f2282607ebb91717d7a6a1406230","hash":"651c5857021e11dc397df86dbe0f01e6c7dc7f16","modified":1591696395669},{"_id":"themes/next/source/lib/pace/.git/objects/a6/dbd9c99e726f621e2bdcd3c6fe2795a5d4272d","hash":"25350dd31f504af7206610ced355d162aabda8dd","modified":1591696395670},{"_id":"themes/next/source/lib/pace/.git/objects/aa/813c5a6398600e01b740696cd889eb3becad84","hash":"c62a1513ca820dc59fe1cd6d9ec16c92e0e2fbf0","modified":1591696395659},{"_id":"themes/next/source/lib/pace/.git/objects/c0/05c71f1a000d8187df58083d215c962d7f5505","hash":"dffd212ca2ec705233fabe82a6f483d6be4b151d","modified":1591696395668},{"_id":"themes/next/source/lib/pace/.git/objects/d4/7aaf8effab41aa414596c56dff4d35ff8da1f5","hash":"33e758f44ad48eb1540363a06c31bed1ed929c60","modified":1591696396214},{"_id":"themes/next/source/lib/pace/.git/objects/da/79363b808519d44a7eda67d7bc81e1587a06e8","hash":"0dc5dc27991da9a09d705e488bc3f1fe5a4d4728","modified":1591696395657},{"_id":"themes/next/source/lib/pace/.git/objects/db/d45db3a1d6c09fdf30fc1f0bdc2c6fab5a0680","hash":"5c0bc5c141068651fcb47ef549f556d67153eecf","modified":1591696395656},{"_id":"themes/next/source/lib/pace/.git/objects/e8/83088ed2cfe69a983e9e277a6b54b7de226344","hash":"2386487a5933380ac3305ea6b5744d75bdd07292","modified":1591696395662},{"_id":"themes/next/source/lib/pace/.git/objects/de/79ab6539ac3702aaac64b879d95e6575f4eefa","hash":"0046fefd52ed4679e0fee757cc91ced94e3ddc12","modified":1591696396211},{"_id":"themes/next/source/lib/pace/.git/refs/heads/master","hash":"22684435265b2bb504024b34b80ffbd6786a2411","modified":1591696396226},{"_id":"themes/next/source/lib/pace/.git/objects/ec/6708dc18a5dd312a6735d4d09eddbdb76e75c2","hash":"66e03a78b2f1d36feb9f9347dd5e68e344c3ee68","modified":1591696396214},{"_id":"themes/next/source/lib/pace/.git/objects/f3/0e0a99bb016267bde55537dd47b3657ae59544","hash":"8bf0bc17a6111b6a82981073133f33cc8e815c41","modified":1591696395666},{"_id":"themes/next/source/lib/reading_progress/.git/objects/03/f74f308aba6eaa459b8e5b1c7e7203aa9d06ef","hash":"fafadfedfbd5b6b7d49061ee85d3568c791e0f3a","modified":1591694856714},{"_id":"themes/next/source/lib/reading_progress/.git/objects/00/4fa4280892c7d18f6151fac22daf51344c02ea","hash":"7a81ed1087c3792f37bd83137d4034179c911627","modified":1591694856712},{"_id":"themes/next/source/lib/reading_progress/.git/objects/01/9a385ce3e8b0232ee5edfa6b4e1dcd44cf142e","hash":"6894d6df0722077c5d21d116f33046625cd57ab8","modified":1591694856722},{"_id":"themes/next/source/lib/reading_progress/.git/objects/01/36e1990fcbef0586e0bd4b9d90b96900dcd575","hash":"37ac2f94a41384f4cb66cd74c8313099367a5603","modified":1591694856709},{"_id":"themes/next/source/lib/reading_progress/.git/objects/0c/dada082d621dbfdd00f7020c33dc751129167f","hash":"b490c11cdefde6b331a7d4ddb055e34ad08459d8","modified":1591694856715},{"_id":"themes/next/source/lib/reading_progress/.git/objects/2b/c9c88e86c252b037a36df9a3d3df519b254bfc","hash":"e647f9721e4f2e1cd52bfff3c80683b787f76a11","modified":1591694856710},{"_id":"themes/next/source/lib/reading_progress/.git/objects/2d/488e7ac12f9be4cba8a7a383e972449b4ecef7","hash":"e477cea6ada0896804b0e8dab23c9d56825a0ece","modified":1591694856713},{"_id":"themes/next/source/lib/reading_progress/.git/objects/08/4d73e711ab990007314dab66ac8da236a98212","hash":"aca52af21085b7a579b275a1e7bb5f1a8818e3d4","modified":1591694856716},{"_id":"themes/next/source/lib/reading_progress/.git/objects/2f/9eba51ec174b1e0c719d12cafa7c3c07140471","hash":"fc994d9d8b3b21ec7c941eea7e3862970e297e9b","modified":1591694856715},{"_id":"themes/next/source/lib/reading_progress/.git/objects/0f/1d02f84180d20e5abcaabc0c1bd312a873867b","hash":"192e0e348a38739f606fdef8bd5f710339067ff6","modified":1591694856707},{"_id":"themes/next/source/lib/reading_progress/.git/objects/48/1ebe947f06e440e41c1a971be0844e852c1d37","hash":"61fea90ca1824db58df6cfc662bc5b371db02224","modified":1591694856718},{"_id":"themes/next/source/lib/reading_progress/.git/objects/71/4aebae4e17e00cdb0e82893d9fa39d35b20b59","hash":"d09daa7d244ee40035e6eb67f13867182fb8af86","modified":1591694856718},{"_id":"themes/next/source/lib/reading_progress/.git/objects/69/a20d65d83035fdb01734a8eabe3340f740a4cb","hash":"9e95b02d8e43ec92e06bee3f60dffb74e8e7b9fa","modified":1591694856716},{"_id":"themes/next/source/lib/reading_progress/.git/objects/82/2aa7ea95e2f40a1c9808fcdba0353650781cf9","hash":"07db481043efdac756c39b1a1c9f11048787bb1a","modified":1591694856719},{"_id":"themes/next/source/lib/reading_progress/.git/objects/72/14afbfc63460dc013ba6368e8c0886597db666","hash":"f67bc8964bd60f5f78fd2437ae946b4e4021a8d6","modified":1591694856721},{"_id":"themes/next/source/lib/reading_progress/.git/objects/36/58085a9181df88f19f04603b28f6ea21d199cc","hash":"6a467dd51d39b28c1af9c25869e25c6821f6602a","modified":1591694856726},{"_id":"themes/next/source/lib/reading_progress/.git/objects/5c/b144a14fd24b0f4c05c467a48738f74fd9b223","hash":"940c8c9bc0f373bd5900d8b7c0f70f29e884c448","modified":1591694856729},{"_id":"themes/next/source/lib/reading_progress/.git/objects/8e/0a48f30df2d542c8e86197067f80ce5f794583","hash":"02367707e47c2549ef585f3b2da72c864d6a8307","modified":1591694856720},{"_id":"themes/next/source/lib/reading_progress/.git/objects/a2/7bba2bf42630fc03150b64fc74f2a29c151a27","hash":"b1afe600ba94298a2905a2cf64c900f5954cc146","modified":1591694856717},{"_id":"themes/next/source/lib/reading_progress/.git/objects/8f/ca1e70cfeea939105e31d7d17f7c3516120b30","hash":"312d55b1a7fbdcc14c54b3805f0827fc42ad94ed","modified":1591694856711},{"_id":"themes/next/source/lib/reading_progress/.git/objects/98/a2041bc808f55bbcb9d8b53560e22558338bda","hash":"ebb53379aa2d77ea0832973fa3e44846df0f170f","modified":1591694856725},{"_id":"themes/next/source/lib/reading_progress/.git/objects/83/d5a97b3daaa59cccb44af55f6723f431f2e94a","hash":"448c16fa4f53e5123838d4c3593dcfb15f309905","modified":1591694856724},{"_id":"themes/next/source/lib/reading_progress/.git/objects/a8/63332915ebfd107ca4418c25c80674875c422b","hash":"f12e708237bcf98c072e73e45f1542cfb5646839","modified":1591694856723},{"_id":"themes/next/source/lib/reading_progress/.git/objects/ae/aa7a68a7131bd03e0bce06f45bfdfa1cd93587","hash":"d7d37380ba502a4050834df40227d612cf911595","modified":1591694856725},{"_id":"themes/next/source/lib/reading_progress/.git/objects/a5/3476a996e477ae4494a5b47aff4237b9859a73","hash":"cd32f255f625f6325f13df5acdef0df20c1a982a","modified":1591694856719},{"_id":"themes/next/source/lib/reading_progress/.git/objects/a5/f44e93420f9699fc1098208f41870dde883800","hash":"bdb633a7512f31f9f3ce8c71d8cfcb6b12fb02db","modified":1591694856729},{"_id":"themes/next/source/lib/reading_progress/.git/objects/b2/6b015c6a0aacd5fcbd3fd3a09b0b216855f35c","hash":"6924e4c4558366a76578a2497d2fca15ef39a9f8","modified":1591694856722},{"_id":"themes/next/source/lib/reading_progress/.git/objects/b1/97881becc7883ad3d3e37cbc6b33f29ef89512","hash":"c044f51aeff15821889c1a2b036ee99b742a35db","modified":1591694856709},{"_id":"themes/next/source/lib/reading_progress/.git/objects/b2/a5ab8715685d92c3dcef47eda3d50a6b6cd8d6","hash":"bb5b934846b6e900f28cdddae374f67b7879a7da","modified":1591694856730},{"_id":"themes/next/source/lib/reading_progress/.git/objects/c0/018cb7262951a7eea4001bea16bf6c1db1de0e","hash":"b54299894dbbf00b3187ae3e16a480a91ca75e73","modified":1591694856714},{"_id":"themes/next/source/lib/reading_progress/.git/objects/b6/eda56cb9647d239b26d86f579204cbccf745fe","hash":"12e479d3dfe08df6f9d4d56be2f0a17d9720d846","modified":1591694856724},{"_id":"themes/next/source/lib/reading_progress/.git/objects/c7/8ceb135b768a369ded42f77d4db3f6363bde20","hash":"aa90e157f2a043dad6017bab2e4aa699f6236a63","modified":1591694856723},{"_id":"themes/next/source/lib/reading_progress/.git/objects/c7/de860f5155ff6452b96dd2b8b0eb1b40af1122","hash":"425ba4ae2621514d4df8ebf92a3ce16439f3ffa6","modified":1591694856730},{"_id":"themes/next/source/lib/reading_progress/.git/objects/d1/94060fce08431ebef4cb5f4c02739b913373cb","hash":"b9022b117b03703b5fa8af85fc076b692bde33cf","modified":1591694856727},{"_id":"themes/next/source/lib/reading_progress/.git/objects/d4/fae8aef4e5c5f67c66bed49f498bda90b633ba","hash":"73c8866ae2b25b8891487999ea6e04020450fbd7","modified":1591694856731},{"_id":"themes/next/source/lib/reading_progress/.git/objects/e5/dc795cdf7d9163cc736be938a9707f73869c9f","hash":"57163dfa4eebe09d57ede37ee259b7cbb2b1e643","modified":1591694856711},{"_id":"themes/next/source/lib/reading_progress/.git/objects/ee/6a2119087ac7c6a491fe8377ec143269b8d929","hash":"d0517ff53639972cc1f1f38a4b9fd75dbfa672af","modified":1591694856728},{"_id":"themes/next/source/lib/reading_progress/.git/objects/f0/acd06a59665dabfb6eb0608f0a797fdcd44158","hash":"f85f3dbe326b8752f6e32c7169ed3b409f4167b7","modified":1591694856713},{"_id":"themes/next/source/lib/reading_progress/.git/objects/f1/dcdfc585f60cb1614c480c3b06a1632b1b6d8e","hash":"606959b7d91b2ed28c670c607623ce36ab3a0c07","modified":1591694856708},{"_id":"themes/next/source/lib/reading_progress/.git/objects/f4/5d8f110c3034162a1091dafe4b03d2e56b323e","hash":"963dad8248030a8d7b185f4726e40a65a0583c0e","modified":1591694856720},{"_id":"themes/next/source/lib/reading_progress/.git/objects/f6/8184f97255dfd504e22775df6450edb9b51d70","hash":"b0a36dcf81780a9f82db6318daa065200e16efee","modified":1591694856727},{"_id":"themes/next/source/lib/reading_progress/.git/objects/fc/911ed1517240b7722c388cbb78810da207728c","hash":"63d9651501295514a7091729938eed86711dc134","modified":1591694856728},{"_id":"themes/next/source/lib/reading_progress/.git/refs/heads/master","hash":"c3a5b4d087fc215a47ada68f273f638af2748aed","modified":1591694856740},{"_id":"themes/next/source/lib/algolia-instant-search/.git/logs/refs/heads/master","hash":"4c7f2fc196480a5a7a8bd688701c70a2263b9e0b","modified":1591704216477},{"_id":"themes/next/source/lib/algolia-instant-search/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1591704216476},{"_id":"themes/next/source/lib/fancybox/.git/logs/refs/heads/master","hash":"f2d932b7f3351aaa9583cb59085aaf7fa8d64b24","modified":1591694693836},{"_id":"themes/next/source/lib/fancybox/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1591694693835},{"_id":"themes/next/source/lib/pace/.git/logs/refs/heads/master","hash":"92278856710cd90783f24138db792a19e14e2943","modified":1591696396226},{"_id":"themes/next/source/lib/pace/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1591696396225},{"_id":"themes/next/source/lib/reading_progress/.git/logs/refs/heads/master","hash":"61e070c6de6c54acd58b56671aee75ab5c244bc3","modified":1591694856740},{"_id":"themes/next/source/lib/reading_progress/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1591694856739},{"_id":"themes/next/source/lib/algolia-instant-search/.git/logs/refs/remotes/origin/HEAD","hash":"4c7f2fc196480a5a7a8bd688701c70a2263b9e0b","modified":1591704216476},{"_id":"themes/next/source/lib/fancybox/.git/logs/refs/remotes/origin/HEAD","hash":"f2d932b7f3351aaa9583cb59085aaf7fa8d64b24","modified":1591694693835},{"_id":"themes/next/source/lib/pace/.git/logs/refs/remotes/origin/HEAD","hash":"92278856710cd90783f24138db792a19e14e2943","modified":1591696396225},{"_id":"themes/next/source/lib/reading_progress/.git/logs/refs/remotes/origin/HEAD","hash":"61e070c6de6c54acd58b56671aee75ab5c244bc3","modified":1591694856739},{"_id":"themes/next/source/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1591693651239},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1591694693843},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1591693651237},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1591693651238},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/2b/d5d590d07a161741477ace2339eb37c07cc40c","hash":"10a1f52729a36d3b9d594e93473fef26fed768e1","modified":1591704216463},{"_id":"themes/next/source/images/timg.gif","hash":"1ff7e8df9671f590629a9c2228fa1e4b3bba8af3","modified":1591758522081},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"27f034e5db8c32e268e2959b9a7c1258d36e4510","modified":1591694693844},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1591693651236},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/a7/8511a30ca600e9db1ecc1a835c0d4b65fbec6b","hash":"c5fbf2c49ade74e34a3ed2cce39a6b54e4686e3e","modified":1591704159312},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1591693651244},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"d8f2e1de2142c44500d41debeeb319ba8adb1ccd","modified":1591704216485},{"_id":"themes/next/source/lib/algolia-instant-search/.git/objects/e4/c7790c85a26069925132383ac286502de41c71","hash":"76b2ebe5b1dc357c9c59c97dbe17c35069257531","modified":1591704209544},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js.map","hash":"753adf35c67993265fb13b827aeee3f95e3442af","modified":1591704216499},{"_id":"public/2020/08/29/2020-08-29_db_system_design_imp(WAL)/index.html","hash":"333ceb383f357879b30ed29138046b4cc217535c","modified":1653120624985},{"_id":"public/2020/08/25/2020-08-25_db-system-design-im(storage)/index.html","hash":"2f9a277c7c2d0012176894eb0fc47da795444ea3","modified":1653120624985},{"_id":"public/2020/08/21/2020-08-21_db-system-design-imp(Transaction)/index.html","hash":"6d16d35a961b4d0e253b26b7371ef3dbad1417d3","modified":1653120624985},{"_id":"public/2020/08/17/2020-08-17_db-system-design-imp(Pager)/index.html","hash":"dde191c0fb2fe90e76f0ab28e806e13e05e0d81f","modified":1653120624985},{"_id":"public/2020/07/21/20.SQLite-Tokenize/index.html","hash":"ce35b4427d8898d1cff7047c48b96fef555e3a6c","modified":1653120624985},{"_id":"public/2020/07/16/19.SQLite-KeywordHash/index.html","hash":"f3b121c301c92b91ef197494425dd379331c4a30","modified":1653120624985},{"_id":"public/2020/06/29/18.db-system-design-imp(VM)/index.html","hash":"a4e19814ce4ae4c03dd989843dfaef1d88f7f126","modified":1653120624985},{"_id":"public/2020/06/12/17.inside-sqlite-chapter-6/index.html","hash":"ad03bc4b734532d90f55b2da94f5788c9a69805b","modified":1653120624985},{"_id":"public/2020/04/19/15.Sqlite-OS/index.html","hash":"7a0008c40ca5ef27f6b27d2d5c91b728153ee540","modified":1653120624985},{"_id":"public/2020/04/01/14.gomobile-bind/index.html","hash":"5dc8e73c18c9af512267d3a2742a1761b9da6af5","modified":1653120624985},{"_id":"public/2020/03/18/13.sqlite-os-shm/index.html","hash":"853bce93b9e87e7e8a2acbc459ea0ccf7f9e4b9e","modified":1653120624985},{"_id":"public/2020/03/15/12.compiler-autorelease-opt/index.html","hash":"cf684162d82adfa514266cf79c7cda06990dfb79","modified":1653120624985},{"_id":"public/2020/03/13/11.dyld/index.html","hash":"806714545d475b79632e65be7f1061c4ba779945","modified":1653120624985},{"_id":"public/2020/03/04/10.runloop-binary-search/index.html","hash":"5a91bf04a2bc68235c6ed9e21925e6c44dcf13f4","modified":1653120624985},{"_id":"public/2020/01/13/9.LeetCode-week-match/index.html","hash":"580aa4800857271e0f743cc6253b5462a83ded87","modified":1653120624985},{"_id":"public/2020/01/07/8.leetcode47/index.html","hash":"447f970bad917e9b7d4e2c1d2727b4c137aea0b7","modified":1653120624985},{"_id":"public/2020/01/05/7.leetcode46/index.html","hash":"ce6b9899fb3c3f8235b152a9f5514c9e784cd3d5","modified":1653120624985},{"_id":"public/2019/12/21/5.OC-Block-imp/index.html","hash":"d033dbb4382e10b662d95227534ad122646373f6","modified":1653120624985},{"_id":"public/2019/12/21/6.leetcode32/index.html","hash":"ac05d885e4d33d50b3f6c83e5f4b749bcef25995","modified":1653120624985},{"_id":"public/2019/12/20/4.synchronized/index.html","hash":"fb84bd09144a18194e483ef99bf88ff6b977dff7","modified":1653120624985},{"_id":"public/2019/12/17/3.binding-symbols/index.html","hash":"9afd544aa0e98b52beafd279c6a45e85a755e211","modified":1653120624985},{"_id":"public/2019/12/11/2.leetcode5/index.html","hash":"eb07565b78e941985fb7760cef8c9ab06e4f417d","modified":1653120624985},{"_id":"public/2019/12/10/1.leetcode41/index.html","hash":"7ccdf5d3a35cd54694f5de5336cb0e0e8868fcea","modified":1653120624985},{"_id":"public/archives/index.html","hash":"e37995cf5d2159a892c5baa9be9b0d0c5ba95509","modified":1653120624985},{"_id":"public/archives/page/2/index.html","hash":"28cef260de1c9e834d42c3dd95d360030b71638e","modified":1653120624985},{"_id":"public/archives/page/3/index.html","hash":"c8dc3f250be87ea7d6e8f6f95bcd25a46c3a7b2e","modified":1653120624985},{"_id":"public/archives/2019/index.html","hash":"bf56c65364fee0feca930ab8bf2f824fae205b5c","modified":1653120624985},{"_id":"public/archives/2019/12/index.html","hash":"1fcbb7bc5567629212523123f293107266b0ab41","modified":1653120624985},{"_id":"public/archives/2020/index.html","hash":"4ed2753d4236efd40e4e621a748ebe5defcf75f4","modified":1653120624985},{"_id":"public/archives/2020/page/2/index.html","hash":"3a526236546b49274c37c16869f82c22945d2bd6","modified":1653120624985},{"_id":"public/archives/2020/01/index.html","hash":"e49de43671693e6b8aa34d62fb46b1de2612eda3","modified":1653120624985},{"_id":"public/archives/2020/03/index.html","hash":"5e4cc8e21c1322bf59d031144d5cd3e0f8320acf","modified":1653120624985},{"_id":"public/archives/2020/04/index.html","hash":"a855bed95e703fe237056c900a7aca25b7d10f13","modified":1653120624985},{"_id":"public/archives/2020/06/index.html","hash":"40928a7eef6a4491915ecd6ce13ed9c081277334","modified":1653120624985},{"_id":"public/archives/2020/07/index.html","hash":"957906ec43eab0d0161843ca0914923e6733554c","modified":1653120624985},{"_id":"public/archives/2020/08/index.html","hash":"08ed3c9c1ea92d63c8e7a1da45dd412f12e383d8","modified":1653120624985},{"_id":"public/index.html","hash":"0d3150e12279be4e07d347c851665b53349c4098","modified":1653120624985},{"_id":"public/page/2/index.html","hash":"569cc5eca748bfc72e332f2d2f89a3969fa89cf9","modified":1653120624985},{"_id":"public/page/3/index.html","hash":"c30efade527936ab216f95c3e917535d2815c34a","modified":1653120624985},{"_id":"public/categories//index.html","hash":"f5742e248f7025545baeb04a940eeeb439012779","modified":1653120624985},{"_id":"public/categories/object-c/index.html","hash":"fc3cb4f0edac5cbff451e9c6825eeda046198700","modified":1653120624985},{"_id":"public/categories/sqlite3/index.html","hash":"5e4a28718f03af144d779bdb54c56b529aa9ec37","modified":1653120624985},{"_id":"public/categories/GoMobile/index.html","hash":"660abda376699a9f8eb23671fddfd716880f214c","modified":1653120624985},{"_id":"public/categories//index.html","hash":"62e3b72ccfd62b20d08c00c88972633f6a6c1cee","modified":1653120624985},{"_id":"public/categories//index.html","hash":"f5dcca1663be085976be9736ef9744ccfef9d55c","modified":1653120624985},{"_id":"public/tags/object-c/index.html","hash":"5c8c94b9788094c93d73a5fad73ae16f9589f95d","modified":1653120624985},{"_id":"public/tags//index.html","hash":"a5b715e51c8bac760ca39ed000d84998f4344a5c","modified":1653120624985},{"_id":"public/tags/leetcode/index.html","hash":"06fd9f28db40e0ca9bd97a5452fdcc61b4c2d392","modified":1653120624985},{"_id":"public/tags//index.html","hash":"a1f54f6a4526329ac300347a659ae796ab29321c","modified":1653120624985},{"_id":"public/tags/sqlite3/index.html","hash":"c574b80018d038be6aaafe4b1352a1017dec5a85","modified":1653120624985},{"_id":"public/tags/os/index.html","hash":"92c7df84c2b60ada595759dbe1762af82b18ba52","modified":1653120624985},{"_id":"public/tags/GoMobile/index.html","hash":"76170ec784929f2a8dd93a17617fbd979896d52a","modified":1653120624985},{"_id":"public/tags//index.html","hash":"912ced85cd3d6565716ad03d1875bcdd2a0708d1","modified":1653120624985},{"_id":"public/tags//index.html","hash":"0b65c496ab6ca78fea2b6f641ab07ac90fac8acf","modified":1653120624985},{"_id":"public/tags/shm/index.html","hash":"d5089e1960ff0511e933dd3301c76a9aa2f099a3","modified":1653120624985},{"_id":"public/tags//index.html","hash":"000da2f6453686b8269175ba717ddeb95ecb4191","modified":1653120624985},{"_id":"public/tags//index.html","hash":"2a2aeca4965ac97bab58b321cf3db1404a11f91d","modified":1653120624985},{"_id":"public/tags//index.html","hash":"2b327bfecb1788768eca22c00feff13e9bcddcc0","modified":1653120624985},{"_id":"public/tags//index.html","hash":"e0b3a00fda93f129fbf55f2bc856215f095c7222","modified":1653120624985},{"_id":"public/tags//index.html","hash":"4132ada04c4a6feddabec9b616204b730ed2e83a","modified":1653120624985},{"_id":"public/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1653120624985},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1653120624985},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1653120624985},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1653120624985},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1653120624985},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1653120624985},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1653120624985},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1653120624985},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1653120624985},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1653120624985},{"_id":"public/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1653120624985},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1653120624985},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1653120624985},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1653120624985},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1653120624985},{"_id":"public/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1653120624985},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1653120624985},{"_id":"public/images/spade-logo.svg","hash":"4fd1156094ba99ceebb68436bfdcdcc529ed8cda","modified":1653120624985},{"_id":"public/images/spade-logo.png","hash":"96977336310ca4a0401c1cc396179012ddf6b5f8","modified":1653120624985},{"_id":"public/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1653120624985},{"_id":"public/lib/algolia-instant-search/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1653120624985},{"_id":"public/lib/algolia-instant-search/instantsearch.min.css.map","hash":"d055d06395af598682873d1b458166dc6f513072","modified":1653120624985},{"_id":"public/lib/fancybox/LICENSE","hash":"8624bcdae55baeef00cd11d5dfcfa60f68710a02","modified":1653120624985},{"_id":"public/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1653120624985},{"_id":"public/lib/reading_progress/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1653120624985},{"_id":"public/lib/pace/LICENSE","hash":"b29db4c99aa5b8d574026f68804051ff4b75466e","modified":1653120624985},{"_id":"public/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1653120624985},{"_id":"public/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1653120624985},{"_id":"public/js/src/bootstrap.js","hash":"531cdedd7fbe8cb1dab2e4328774a9f6b15b59da","modified":1653120624985},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1653120624985},{"_id":"public/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1653120624985},{"_id":"public/js/src/motion.js","hash":"50e57f8acb6924c6999cdcc664ddd3f0730d2061","modified":1653120624985},{"_id":"public/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1653120624985},{"_id":"public/js/src/post-details.js","hash":"d1333fb588d4521b4d1e9c69aef06e0ad1bf0b12","modified":1653120624985},{"_id":"public/js/src/utils.js","hash":"9543f124adba1f6e3c93d61f85e3e6f74ed5fff4","modified":1653120624985},{"_id":"public/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1653120624985},{"_id":"public/lib/algolia-instant-search/README.html","hash":"6395c6cce0e7de33f557857adca4d20d8069a3f9","modified":1653120624985},{"_id":"public/lib/algolia-instant-search/instantsearch.min.css","hash":"6e01a39d7f6d58a0895957361b0a942543c18332","modified":1653120624985},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1653120624985},{"_id":"public/lib/fancybox/README.html","hash":"a4aaf51e67fb87df01c2a65f9fc2882bc53a8f54","modified":1653120624985},{"_id":"public/lib/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1653120624985},{"_id":"public/lib/pace/README.html","hash":"b1db0e6c71c25fbdc5a161e1bd70382846ce99ab","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-barber-shop.min.css","hash":"ee0d51446cb4ffe1bb96bd7bc8c8e046dddfcf46","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-big-counter.min.css","hash":"5b561dc328af4c4d512e20a76fe964d113a32ba8","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-bounce.min.css","hash":"f6bdb9a785b7979dd8ec5c60e278af955ef1e585","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-center-atom.min.css","hash":"dcf79c24fe5350fb73d8038573a104e73639e9d3","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-center-circle.min.css","hash":"a4066769c78affbfbc5e30a600e2c7862cd532e0","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-center-radar.min.css","hash":"ab7cba998bf4c03b13df342bf43647fa4f419783","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-center-simple.min.css","hash":"67f44c947548bd4d77e7590d3f59e236cbf9e98a","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-corner-indicator.min.css","hash":"b3c64c973f31884e3d8145989476707333406b9a","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-fill-left.min.css","hash":"0bec1e235a4a2cccda3f993b205424e1441a44ae","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-flash.min.css","hash":"13ace22c40312d7bbd8d9c1e50eff897a7a497d8","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-flat-top.min.css","hash":"5e1c97e232b46e48592a8e4983ae5a89e0a7da6a","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-loading-bar.min.css","hash":"7ee28875dfc1230d76c537f6605766e8d4011e9f","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-mac-osx.min.css","hash":"9f2e7b51b084da407863826b25265b31150b3821","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-minimal.min.css","hash":"9cd783cceb8a191f3c8b5d81f7a430ecc3e489d3","modified":1653120624985},{"_id":"public/lib/pace/pace.min.js","hash":"9944dfb7814b911090e96446cea4d36e2b487234","modified":1653120624985},{"_id":"public/lib/reading_progress/README.html","hash":"af8a97cb3146ff6047f6deaa3e20cd583dc69259","modified":1653120624985},{"_id":"public/lib/reading_progress/package.json","hash":"8d6815f29afe52968881f536aee8d9267ba53bd2","modified":1653120624985},{"_id":"public/lib/reading_progress/reading_progress.js","hash":"ec68a79421cfba022ac53f46813d013dd48617c0","modified":1653120624985},{"_id":"public/lib/reading_progress/reading_progress.min.js","hash":"b768dc009e6d37dd952632c317f6c33e6e2d89ad","modified":1653120624985},{"_id":"public/lib/reading_progress/renovate.json","hash":"94990e0ad04ce4a7c6f0ac3543318d9e02db1264","modified":1653120624985},{"_id":"public/js/src/schemes/pisces.js","hash":"8050a5b2683d1d77238c5762b6bd89c543daed6e","modified":1653120624985},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1653120624985},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.css","hash":"1be9b79be02a1cfc5d96c4a5e0feb8f472babd95","modified":1653120624985},{"_id":"public/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1653120624985},{"_id":"public/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1653120624985},{"_id":"public/css/main.css","hash":"1e64881e4d24fa71ec2ef31ea89c21de8b3f8c6f","modified":1653120624985},{"_id":"public/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1653120624985},{"_id":"public/lib/algolia-instant-search/instantsearch.min.js","hash":"d8f2e1de2142c44500d41debeeb319ba8adb1ccd","modified":1653120624985},{"_id":"public/lib/pace/pace-theme-material.min.css","hash":"f1ff83985c090f3a3236554c5ef69542dcceb049","modified":1653120624985},{"_id":"public/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1653120624985},{"_id":"public/lib/fancybox/source/jquery.fancybox.css","hash":"e43435fb9eaa918f5b8e35c9e110124b8bd13751","modified":1653120624985},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1653120624985},{"_id":"public/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1653120624985},{"_id":"public/lib/fancybox/source/jquery.fancybox.min.js","hash":"6181412e73966696d08e1e5b1243a572d0f22ba6","modified":1653120624985},{"_id":"public/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1653120624985},{"_id":"public/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1653120624985},{"_id":"public/lib/fancybox/source/jquery.fancybox.pack.js","hash":"27f034e5db8c32e268e2959b9a7c1258d36e4510","modified":1653120624985},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1653120624985},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1653120624985},{"_id":"public/images/timg.gif","hash":"1ff7e8df9671f590629a9c2228fa1e4b3bba8af3","modified":1653120624985},{"_id":"public/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1653120624985},{"_id":"public/lib/algolia-instant-search/instantsearch.min.js.map","hash":"753adf35c67993265fb13b827aeee3f95e3442af","modified":1653120624985}],"Category":[{"name":"","_id":"cl3flc60u0001elc98lis9k0w"},{"name":"object-c","_id":"cl3flc6170009elc963e0gs83"},{"name":"sqlite3","_id":"cl3flc61a000gelc9btk9bgza"},{"name":"GoMobile","_id":"cl3flc61c000lelc91ackhvpa"},{"name":"","_id":"cl3flc61k001delc9fv1010pg"},{"name":"","_id":"cl3flc61o001uelc94fds9d19"}],"Data":[],"Page":[],"Post":[{"title":"RunLoop\"\"","date":"2020-03-03T16:00:00.000Z","_content":"\n> RunLoopTimer------RunLoop \n\n<!-- more -->\n\n### \n````objective-c\n//fireTSR\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) {\n    CFIndex cnt = CFArrayGetCount(array);\n    if (cnt <= 0) {\n        return 0;\n    }\n    if (256 < cnt) {//count 256 \n        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);\n        if (item->_fireTSR <= rlt->_fireTSR) {\n            return cnt;\n        }\n        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);\n        if (rlt->_fireTSR < item->_fireTSR) {\n            return 0;\n        }\n    }\n\n\t//\n    CFIndex add = (1 << flsl(cnt)) * 2;\n    CFIndex idx = 0;\n    Boolean lastTestLEQ;\n    do {\n        add = add / 2;\n\t    lastTestLEQ = false;\n        CFIndex testIdx = idx + add;\n        if (testIdx < cnt) {\n            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);\n            if (item->_fireTSR <= rlt->_fireTSR) {\n                idx = testIdx;\n\t\t        lastTestLEQ = true;\n            }\n        }\n    } while (0 < add);\n\n    return lastTestLEQ ? idx + 1 : idx;\n}\n````\n\n\n\nO(log N)log N\n\n> \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png)\n\n `add` `idx` ``  start `idx`  `testIdx` `` `end = idx + start` add  end\n\n\nIndex\n\n1. 256256..ifO(log n)\n\n2. :`CFIndex add = (1 << flsl(cnt)) * 2;` add`cnt``flsl()``cnt`(flsl(256)  9)cnt256add10241951251221024``add2n\n\nps928","source":"_posts/10.runloop-binary-search.md","raw":"---\ntitle: RunLoop\"\"\ndate: 2020-03-04\ntags: [object-c,]\ncategories: \n---\n\n> RunLoopTimer------RunLoop \n\n<!-- more -->\n\n### \n````objective-c\n//fireTSR\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) {\n    CFIndex cnt = CFArrayGetCount(array);\n    if (cnt <= 0) {\n        return 0;\n    }\n    if (256 < cnt) {//count 256 \n        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);\n        if (item->_fireTSR <= rlt->_fireTSR) {\n            return cnt;\n        }\n        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);\n        if (rlt->_fireTSR < item->_fireTSR) {\n            return 0;\n        }\n    }\n\n\t//\n    CFIndex add = (1 << flsl(cnt)) * 2;\n    CFIndex idx = 0;\n    Boolean lastTestLEQ;\n    do {\n        add = add / 2;\n\t    lastTestLEQ = false;\n        CFIndex testIdx = idx + add;\n        if (testIdx < cnt) {\n            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);\n            if (item->_fireTSR <= rlt->_fireTSR) {\n                idx = testIdx;\n\t\t        lastTestLEQ = true;\n            }\n        }\n    } while (0 < add);\n\n    return lastTestLEQ ? idx + 1 : idx;\n}\n````\n\n\n\nO(log N)log N\n\n> \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png)\n\n `add` `idx` ``  start `idx`  `testIdx` `` `end = idx + start` add  end\n\n\nIndex\n\n1. 256256..ifO(log n)\n\n2. :`CFIndex add = (1 << flsl(cnt)) * 2;` add`cnt``flsl()``cnt`(flsl(256)  9)cnt256add10241951251221024``add2n\n\nps928","slug":"10.runloop-binary-search","published":1,"updated":"2020-08-29T14:42:58.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc60o0000elc9ajfnc03p","content":"<blockquote>\n<p>RunLoopTimerRunLoop </p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//fireTSR</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) &#123;</span><br><span class=\"line\">    CFIndex cnt = CFArrayGetCount(array);</span><br><span class=\"line\">    if (cnt &lt;= 0) &#123;</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (256 &lt; cnt) &#123;//count 256 </span><br><span class=\"line\">        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);</span><br><span class=\"line\">        if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return cnt;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);</span><br><span class=\"line\">        if (rlt-&gt;_fireTSR &lt; item-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return 0;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//</span><br><span class=\"line\">    CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</span><br><span class=\"line\">    CFIndex idx = 0;</span><br><span class=\"line\">    Boolean lastTestLEQ;</span><br><span class=\"line\">    do &#123;</span><br><span class=\"line\">        add = add / 2;</span><br><span class=\"line\">\t    lastTestLEQ = false;</span><br><span class=\"line\">        CFIndex testIdx = idx + add;</span><br><span class=\"line\">        if (testIdx &lt; cnt) &#123;</span><br><span class=\"line\">            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);</span><br><span class=\"line\">            if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">                idx = testIdx;</span><br><span class=\"line\">\t\t        lastTestLEQ = true;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; while (0 &lt; add);</span><br><span class=\"line\"></span><br><span class=\"line\">    return lastTestLEQ ? idx + 1 : idx;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>O(log N)log N</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png\"></p>\n<p> <code>add</code> <code>idx</code> <code></code>  start <code>idx</code>  <code>testIdx</code> <code></code> <code>end = idx + start</code> add  end</p>\n<p>Index</p>\n<ol>\n<li><p>256256..ifO(log n)</p>\n</li>\n<li><p>:<code>CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</code> add<code>cnt</code><code>flsl()</code><code>cnt</code>(flsl(256)  9)cnt256add10241951251221024<code></code>add2n</p>\n</li>\n</ol>\n<p>ps928</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>RunLoopTimerRunLoop </p>\n</blockquote>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//fireTSR</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) &#123;</span><br><span class=\"line\">    CFIndex cnt = CFArrayGetCount(array);</span><br><span class=\"line\">    if (cnt &lt;= 0) &#123;</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (256 &lt; cnt) &#123;//count 256 </span><br><span class=\"line\">        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);</span><br><span class=\"line\">        if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return cnt;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);</span><br><span class=\"line\">        if (rlt-&gt;_fireTSR &lt; item-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return 0;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//</span><br><span class=\"line\">    CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</span><br><span class=\"line\">    CFIndex idx = 0;</span><br><span class=\"line\">    Boolean lastTestLEQ;</span><br><span class=\"line\">    do &#123;</span><br><span class=\"line\">        add = add / 2;</span><br><span class=\"line\">\t    lastTestLEQ = false;</span><br><span class=\"line\">        CFIndex testIdx = idx + add;</span><br><span class=\"line\">        if (testIdx &lt; cnt) &#123;</span><br><span class=\"line\">            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);</span><br><span class=\"line\">            if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">                idx = testIdx;</span><br><span class=\"line\">\t\t        lastTestLEQ = true;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; while (0 &lt; add);</span><br><span class=\"line\"></span><br><span class=\"line\">    return lastTestLEQ ? idx + 1 : idx;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>O(log N)log N</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png\"></p>\n<p> <code>add</code> <code>idx</code> <code></code>  start <code>idx</code>  <code>testIdx</code> <code></code> <code>end = idx + start</code> add  end</p>\n<p>Index</p>\n<ol>\n<li><p>256256..ifO(log n)</p>\n</li>\n<li><p>:<code>CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</code> add<code>cnt</code><code>flsl()</code><code>cnt</code>(flsl(256)  9)cnt256add10241951251221024<code></code>add2n</p>\n</li>\n</ol>\n<p>ps928</p>"},{"title":"AutoRelease","date":"2020-03-14T16:00:00.000Z","_content":"\nARCruntime`objc_autoreleaseReturnValue``objc_retainAutoreleaseReturnValue`...\n\n<!-- more -->\n\n## \n:autorelease\n**MRC**\n\nMRC\n\n  1\n\n\n\n**ARC**\n\nARCMRCARCautoreleaseautorelease\n\n\n**runtime**\n\nMRC\n\nps:\n\nARC\n\nruntimeruntimeMRC\n\n`__builtin_return_address(int depth)``objc_retainAutoreleaseReturnValue`MRC`objc_autoreleaseReturnValue`flagTLS\n\n`objc_retainAutoreleaseReturnValue`TLSretain\n\n\n\n\n\nTLSflag\n\n`__builtin_return_address(int depth)`\n\n## \nARC...\n\nXcode Mac DemoARC\n\n..\n\n```objective-c\nextern void _objc_autoreleasePoolPrint(void);\n\nint main(int argc, const char * argv[]) {\n    ///////////////////////////////////////////////////////////////////////////////////////////// 1.\n        id obj0;\n        {\n            id obj1 = [NSMutableArray array];\n            obj0 = obj1;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj0-%@\", obj0);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 2.\n        id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            obj2 = obj3;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 3.\n        id __weak obj4;\n        @autoreleasepool {\n            id obj5 = [NSMutableArray array];\n            obj4 = obj5;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj4-%@\", obj4);\n    return 0;\n}\n```\n\n3__weak\n\n [](https://www.jianshu.com/p/e920d1ff570c)....\n\n\n\nretain\n\n## \nRuntime\n\n...\nARM\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png)\n\nruntime`objc_retainAutoreleasedReturnValue``objc_retainAutoreleasedReturnValue`\n\nweak\n```objective-c\n\t\t id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n```\n\n....\n\n\n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png)\n\nDebug`None`Release`Fastest,Smallest[-Os]`DebugRelease...\n\n......\n\n `objc_retainAutoreleasedReturnValue`...\n\n...\n\nx86iOSmaclevel...","source":"_posts/12.compiler-autorelease-opt.md","raw":"---\ntitle: AutoRelease\ndate: 2020-03-15\ntags: [object-c]\ncategories: object-c\n---\n\nARCruntime`objc_autoreleaseReturnValue``objc_retainAutoreleaseReturnValue`...\n\n<!-- more -->\n\n## \n:autorelease\n**MRC**\n\nMRC\n\n  1\n\n\n\n**ARC**\n\nARCMRCARCautoreleaseautorelease\n\n\n**runtime**\n\nMRC\n\nps:\n\nARC\n\nruntimeruntimeMRC\n\n`__builtin_return_address(int depth)``objc_retainAutoreleaseReturnValue`MRC`objc_autoreleaseReturnValue`flagTLS\n\n`objc_retainAutoreleaseReturnValue`TLSretain\n\n\n\n\n\nTLSflag\n\n`__builtin_return_address(int depth)`\n\n## \nARC...\n\nXcode Mac DemoARC\n\n..\n\n```objective-c\nextern void _objc_autoreleasePoolPrint(void);\n\nint main(int argc, const char * argv[]) {\n    ///////////////////////////////////////////////////////////////////////////////////////////// 1.\n        id obj0;\n        {\n            id obj1 = [NSMutableArray array];\n            obj0 = obj1;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj0-%@\", obj0);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 2.\n        id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            obj2 = obj3;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 3.\n        id __weak obj4;\n        @autoreleasepool {\n            id obj5 = [NSMutableArray array];\n            obj4 = obj5;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj4-%@\", obj4);\n    return 0;\n}\n```\n\n3__weak\n\n [](https://www.jianshu.com/p/e920d1ff570c)....\n\n\n\nretain\n\n## \nRuntime\n\n...\nARM\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png)\n\nruntime`objc_retainAutoreleasedReturnValue``objc_retainAutoreleasedReturnValue`\n\nweak\n```objective-c\n\t\t id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n```\n\n....\n\n\n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png)\n\nDebug`None`Release`Fastest,Smallest[-Os]`DebugRelease...\n\n......\n\n `objc_retainAutoreleasedReturnValue`...\n\n...\n\nx86iOSmaclevel...","slug":"12.compiler-autorelease-opt","published":1,"updated":"2020-08-29T14:42:58.495Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc6150007elc91hzb4uvs","content":"<p>ARCruntime<code>objc_autoreleaseReturnValue</code><code>objc_retainAutoreleaseReturnValue</code></p>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:autorelease<br><strong>MRC</strong></p>\n<p>MRC</p>\n<p>  1</p>\n<p></p>\n<p><strong>ARC</strong></p>\n<p>ARCMRCARCautoreleaseautorelease</p>\n<p><strong>runtime</strong></p>\n<p>MRC</p>\n<p>ps:</p>\n<p>ARC</p>\n<p>runtimeruntimeMRC</p>\n<p><code>__builtin_return_address(int depth)</code><code>objc_retainAutoreleaseReturnValue</code>MRC<code>objc_autoreleaseReturnValue</code>flagTLS</p>\n<p><code>objc_retainAutoreleaseReturnValue</code>TLSretain</p>\n<p></p>\n<p></p>\n<p>TLSflag</p>\n<p><code>__builtin_return_address(int depth)</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>ARC</p>\n<p>Xcode Mac DemoARC</p>\n<p>..</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extern void _objc_autoreleasePoolPrint(void);</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, const char * argv[]) &#123;</span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 1.</span><br><span class=\"line\">        id obj0;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj1 = [NSMutableArray array];</span><br><span class=\"line\">            obj0 = obj1;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj0-%@&quot;, obj0);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 2.</span><br><span class=\"line\">        id __weak obj2;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj3 = [NSMutableArray array];</span><br><span class=\"line\">            obj2 = obj3;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj2-%@&quot;, obj2);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 3.</span><br><span class=\"line\">        id __weak obj4;</span><br><span class=\"line\">        @autoreleasepool &#123;</span><br><span class=\"line\">            id obj5 = [NSMutableArray array];</span><br><span class=\"line\">            obj4 = obj5;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj4-%@&quot;, obj4);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>3__weak</p>\n<p> <a href=\"https://www.jianshu.com/p/e920d1ff570c\"></a>.</p>\n<p></p>\n<p>retain</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Runtime</p>\n<p><br>ARM<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png\"></p>\n<p>runtime<code>objc_retainAutoreleasedReturnValue</code><code>objc_retainAutoreleasedReturnValue</code></p>\n<p>weak</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">id __weak obj2;</span><br><span class=\"line\">     &#123;</span><br><span class=\"line\">         id obj3 = [NSMutableArray array];</span><br><span class=\"line\">         _objc_autoreleasePoolPrint();</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     NSLog(@&quot;obj2-%@&quot;, obj2);</span><br></pre></td></tr></table></figure>\n\n<p>.</p>\n<p></p>\n<p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png\"></p>\n<p>Debug<code>None</code>Release<code>Fastest,Smallest[-Os]</code>DebugRelease</p>\n<p></p>\n<p> <code>objc_retainAutoreleasedReturnValue</code></p>\n<p></p>\n<p>x86iOSmaclevel</p>\n","site":{"data":{}},"excerpt":"<p>ARCruntime<code>objc_autoreleaseReturnValue</code><code>objc_retainAutoreleaseReturnValue</code></p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:autorelease<br><strong>MRC</strong></p>\n<p>MRC</p>\n<p>  1</p>\n<p></p>\n<p><strong>ARC</strong></p>\n<p>ARCMRCARCautoreleaseautorelease</p>\n<p><strong>runtime</strong></p>\n<p>MRC</p>\n<p>ps:</p>\n<p>ARC</p>\n<p>runtimeruntimeMRC</p>\n<p><code>__builtin_return_address(int depth)</code><code>objc_retainAutoreleaseReturnValue</code>MRC<code>objc_autoreleaseReturnValue</code>flagTLS</p>\n<p><code>objc_retainAutoreleaseReturnValue</code>TLSretain</p>\n<p></p>\n<p></p>\n<p>TLSflag</p>\n<p><code>__builtin_return_address(int depth)</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>ARC</p>\n<p>Xcode Mac DemoARC</p>\n<p>..</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extern void _objc_autoreleasePoolPrint(void);</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, const char * argv[]) &#123;</span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 1.</span><br><span class=\"line\">        id obj0;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj1 = [NSMutableArray array];</span><br><span class=\"line\">            obj0 = obj1;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj0-%@&quot;, obj0);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 2.</span><br><span class=\"line\">        id __weak obj2;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj3 = [NSMutableArray array];</span><br><span class=\"line\">            obj2 = obj3;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj2-%@&quot;, obj2);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 3.</span><br><span class=\"line\">        id __weak obj4;</span><br><span class=\"line\">        @autoreleasepool &#123;</span><br><span class=\"line\">            id obj5 = [NSMutableArray array];</span><br><span class=\"line\">            obj4 = obj5;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj4-%@&quot;, obj4);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>3__weak</p>\n<p> <a href=\"https://www.jianshu.com/p/e920d1ff570c\"></a>.</p>\n<p></p>\n<p>retain</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Runtime</p>\n<p><br>ARM<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png\"></p>\n<p>runtime<code>objc_retainAutoreleasedReturnValue</code><code>objc_retainAutoreleasedReturnValue</code></p>\n<p>weak</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">id __weak obj2;</span><br><span class=\"line\">     &#123;</span><br><span class=\"line\">         id obj3 = [NSMutableArray array];</span><br><span class=\"line\">         _objc_autoreleasePoolPrint();</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     NSLog(@&quot;obj2-%@&quot;, obj2);</span><br></pre></td></tr></table></figure>\n\n<p>.</p>\n<p></p>\n<p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png\"></p>\n<p>Debug<code>None</code>Release<code>Fastest,Smallest[-Os]</code>DebugRelease</p>\n<p></p>\n<p> <code>objc_retainAutoreleasedReturnValue</code></p>\n<p></p>\n<p>x86iOSmaclevel</p>"},{"title":" -- LeetCode[41]","date":"2019-12-09T16:00:00.000Z","_content":"\n> O(n)\n\n<!-- more -->\n\n hard MediumHard...\n\n \"\"\n\n \n\n\n\n1\n\n------------\n\n\n****\n\n\n10\n\n\n\n****\n1. 01\n2. \n3. swap\n4. ,exp:[1,1]\n\n****\n```go\nfunc firstMissingPositive(nums []int) int {\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val > 0 && val <= len(nums) {\n\t\t\tif val != index+1 && nums[val-1] != val {\n\t\t\t\tnums[val-1], nums[index] = val, nums[val-1]\n\t\t\t\tindex--\n\t\t\t}\n\t\t}\n\t}\n\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val != index+1 {\n\t\t\treturn index + 1\n\t\t}\n\t}\n\n\treturn len(nums) + 1\n}\n```","source":"_posts/1.leetcode41.md","raw":"---\ntitle:  -- LeetCode[41]\ndate: 2019-12-10\ntags: [leetcode,]\ncategories: \n---\n\n> O(n)\n\n<!-- more -->\n\n hard MediumHard...\n\n \"\"\n\n \n\n\n\n1\n\n------------\n\n\n****\n\n\n10\n\n\n\n****\n1. 01\n2. \n3. swap\n4. ,exp:[1,1]\n\n****\n```go\nfunc firstMissingPositive(nums []int) int {\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val > 0 && val <= len(nums) {\n\t\t\tif val != index+1 && nums[val-1] != val {\n\t\t\t\tnums[val-1], nums[index] = val, nums[val-1]\n\t\t\t\tindex--\n\t\t\t}\n\t\t}\n\t}\n\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val != index+1 {\n\t\t\treturn index + 1\n\t\t}\n\t}\n\n\treturn len(nums) + 1\n}\n```","slug":"1.leetcode41","published":1,"updated":"2020-08-29T14:42:58.493Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc6170008elc9anki42hn","content":"<blockquote>\n<p>O(n)</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p> hard MediumHard</p>\n<p> </p>\n<p> </p>\n<p></p>\n<p>1</p>\n<hr>\n<p><strong></strong><br></p>\n<p>10<br><br></p>\n<p><strong></strong></p>\n<ol>\n<li>01</li>\n<li></li>\n<li>swap</li>\n<li>,exp:[1,1]</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">firstMissingPositive</span><span class=\"params\">(nums []<span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val &gt; <span class=\"number\">0</span> &amp;&amp; val &lt;= <span class=\"built_in\">len</span>(nums) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &amp;&amp; nums[val<span class=\"number\">-1</span>] != val &#123;</span><br><span class=\"line\">\t\t\t\tnums[val<span class=\"number\">-1</span>], nums[index] = val, nums[val<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t\t\tindex--</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> index + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(nums) + <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<blockquote>\n<p>O(n)</p>\n</blockquote>","more":"<p> hard MediumHard</p>\n<p> </p>\n<p> </p>\n<p></p>\n<p>1</p>\n<hr>\n<p><strong></strong><br></p>\n<p>10<br><br></p>\n<p><strong></strong></p>\n<ol>\n<li>01</li>\n<li></li>\n<li>swap</li>\n<li>,exp:[1,1]</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">firstMissingPositive</span><span class=\"params\">(nums []<span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val &gt; <span class=\"number\">0</span> &amp;&amp; val &lt;= <span class=\"built_in\">len</span>(nums) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &amp;&amp; nums[val<span class=\"number\">-1</span>] != val &#123;</span><br><span class=\"line\">\t\t\t\tnums[val<span class=\"number\">-1</span>], nums[index] = val, nums[val<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t\t\tindex--</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> index + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(nums) + <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"SQLite--OS","date":"2020-03-17T16:00:00.000Z","_content":"\n>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm\n\n<!-- more -->\n\n## Shm-\nshm-shared memory walwal-index()`SQLITE_OMIT_WAL`sqlite osshm\n\n4\n```c\nint sqlite3OsShmMap(sqlite3_file *,int,int,int,void volatile **);//\nint sqlite3OsShmLock(sqlite3_file *id, int, int, int);//mmap\nvoid sqlite3OsShmBarrier(sqlite3_file *id);//\nint sqlite3OsShmUnmap(sqlite3_file *id, int);//\n```\n\nmmap...\n\n### mmap\n\n...mmap\n\nmmapmmapcrashflush...\n\n****\n\n********...memory cachedirtysync\n\nread()write()buffcpucpuDMADMAcpubuff\n\n\n\n**mmap**\n\nmmapvma****\n\n:mmap\n\nmmapmmap\n\n### \n\nunixFileunixShm\n```c\nstruct unixShm {\n  unixShmNode *pShmNode;     /* The underlying unixShmNode object */\n  unixShm *pNext;            /* Next unixShm with the same unixShmNode */\n  u8 hasMutex;               /* True if holding the unixShmNode->pShmMutex */\n  u8 id;                     /* Id of this connection within its unixShmNode */\n  u16 sharedMask;            /* Mask of shared locks held */\n  u16 exclMask;              /* Mask of exclusive locks held */\n};\n```\n\nunixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode\n\nunixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()\n\n```c\nstruct unixShmNode {\n  unixInodeInfo *pInode;     /* unixInodeInfo that owns this SHM node */\n  sqlite3_mutex *pShmMutex;  /* Mutex to access this object */\n  char *zFilename;           /* Name of the mmapped file */\n  int hShm;                  /* Open file descriptor */\n  int szRegion;              /* Size of shared-memory regions */\n  u16 nRegion;               /* Size of array apRegion */\n  u8 isReadonly;             /* True if read-only */\n  u8 isUnlocked;             /* True if no DMS lock held */\n  char **apRegion;           /* Array of mapped shared-memory regions */\n  int nRef;                  /* Number of unixShm objects pointing to this */\n  unixShm *pFirst;           /* All unixShm objects pointing to this */\n};\n```\n\nSqlite4\n\n### sqlite3OsShmMap\nshmMap\n```c\nstatic int unixShmMap(\n  sqlite3_file *fd,               /* Handle open on database file */\n  int iRegion,                    /* Region to retrieve */\n  int szRegion,                   /* Size of regions */\n  int bExtend,                    /* True to extend file if necessary */\n  void volatile **pp              /* OUT: Mapped memory */\n)\n```\n\nsqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(****unixShmNodeszRegion)\n\nshmiRegionszRegionbExtendmmap\n\nsqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region\n\n\n1. unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader\n2. regioniRegionregionnReqRegionnReqRegion<unixShmNode.nRegion,35\n3. \n4. mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion\n5. unixShmNode.apRegioniRegionregionmmap\n\n**mmap**\nSqlitemmapSIGBUS\n\n [mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5) \n\ncachemmap\n\n### sqlite3OsShmUnmap\n\n\n```c\nstatic int unixShmUnmap(\n  sqlite3_file *fd,               /* The underlying database file */\n  int deleteFlag                  /* Delete shared-memory if true */\n)\n```\nUnmapdeleteFlag1\n\n\n1. unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm\n2. unixShmNode0\n3. nShmPerMaposMunmapmmap\n\n### sqlite3OsShmLock\n\n\n```c\nstatic int unixShmLock(\n  sqlite3_file *fd,          /* Database file holding the shared memory */\n  int ofst,                  /* First lock to acquire or release */\n  int n,                     /* Number of locks to acquire or release */\n  int flags                  /* What to do with the lock */\n)\n```\n\n```\n#define SQLITE_SHM_UNLOCK       1\n#define SQLITE_SHM_LOCK         2\n#define SQLITE_SHM_SHARED       4\n#define SQLITE_SHM_EXCLUSIVE    8\n```\nshm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive\n**shmexcl<->sharedunlockunlock**\n\nposix\n unixShm sharedMaskexclMaskshmmmap\n\n1. SQLITE_SHM_UNLOCK\nunixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask\n\n2. SQLITE_SHM_SHARED\nunixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1\n\n3. SQLITE_SHM_EXCLUSIVE\nunixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1\n\n### sqlite3OsShmBarrier\n\n`__sync_synchronize()`\n\n>\nmmap\n[ - ccxikka - ](https://www.cnblogs.com/ccxikka/p/10527056.html)\n[mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5)\n[mmap()](https://blog.csdn.net/Holy_666/article/details/86532671)\n\n[ - ](https://www.jianshu.com/p/64240319ed60)","source":"_posts/13.sqlite-os-shm.md","raw":"---\ntitle: SQLite--OS\ndate: 2020-03-18\ntags: [sqlite3,os,shm]\ncategories: sqlite3\n---\n\n>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm\n\n<!-- more -->\n\n## Shm-\nshm-shared memory walwal-index()`SQLITE_OMIT_WAL`sqlite osshm\n\n4\n```c\nint sqlite3OsShmMap(sqlite3_file *,int,int,int,void volatile **);//\nint sqlite3OsShmLock(sqlite3_file *id, int, int, int);//mmap\nvoid sqlite3OsShmBarrier(sqlite3_file *id);//\nint sqlite3OsShmUnmap(sqlite3_file *id, int);//\n```\n\nmmap...\n\n### mmap\n\n...mmap\n\nmmapmmapcrashflush...\n\n****\n\n********...memory cachedirtysync\n\nread()write()buffcpucpuDMADMAcpubuff\n\n\n\n**mmap**\n\nmmapvma****\n\n:mmap\n\nmmapmmap\n\n### \n\nunixFileunixShm\n```c\nstruct unixShm {\n  unixShmNode *pShmNode;     /* The underlying unixShmNode object */\n  unixShm *pNext;            /* Next unixShm with the same unixShmNode */\n  u8 hasMutex;               /* True if holding the unixShmNode->pShmMutex */\n  u8 id;                     /* Id of this connection within its unixShmNode */\n  u16 sharedMask;            /* Mask of shared locks held */\n  u16 exclMask;              /* Mask of exclusive locks held */\n};\n```\n\nunixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode\n\nunixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()\n\n```c\nstruct unixShmNode {\n  unixInodeInfo *pInode;     /* unixInodeInfo that owns this SHM node */\n  sqlite3_mutex *pShmMutex;  /* Mutex to access this object */\n  char *zFilename;           /* Name of the mmapped file */\n  int hShm;                  /* Open file descriptor */\n  int szRegion;              /* Size of shared-memory regions */\n  u16 nRegion;               /* Size of array apRegion */\n  u8 isReadonly;             /* True if read-only */\n  u8 isUnlocked;             /* True if no DMS lock held */\n  char **apRegion;           /* Array of mapped shared-memory regions */\n  int nRef;                  /* Number of unixShm objects pointing to this */\n  unixShm *pFirst;           /* All unixShm objects pointing to this */\n};\n```\n\nSqlite4\n\n### sqlite3OsShmMap\nshmMap\n```c\nstatic int unixShmMap(\n  sqlite3_file *fd,               /* Handle open on database file */\n  int iRegion,                    /* Region to retrieve */\n  int szRegion,                   /* Size of regions */\n  int bExtend,                    /* True to extend file if necessary */\n  void volatile **pp              /* OUT: Mapped memory */\n)\n```\n\nsqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(****unixShmNodeszRegion)\n\nshmiRegionszRegionbExtendmmap\n\nsqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region\n\n\n1. unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader\n2. regioniRegionregionnReqRegionnReqRegion<unixShmNode.nRegion,35\n3. \n4. mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion\n5. unixShmNode.apRegioniRegionregionmmap\n\n**mmap**\nSqlitemmapSIGBUS\n\n [mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5) \n\ncachemmap\n\n### sqlite3OsShmUnmap\n\n\n```c\nstatic int unixShmUnmap(\n  sqlite3_file *fd,               /* The underlying database file */\n  int deleteFlag                  /* Delete shared-memory if true */\n)\n```\nUnmapdeleteFlag1\n\n\n1. unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm\n2. unixShmNode0\n3. nShmPerMaposMunmapmmap\n\n### sqlite3OsShmLock\n\n\n```c\nstatic int unixShmLock(\n  sqlite3_file *fd,          /* Database file holding the shared memory */\n  int ofst,                  /* First lock to acquire or release */\n  int n,                     /* Number of locks to acquire or release */\n  int flags                  /* What to do with the lock */\n)\n```\n\n```\n#define SQLITE_SHM_UNLOCK       1\n#define SQLITE_SHM_LOCK         2\n#define SQLITE_SHM_SHARED       4\n#define SQLITE_SHM_EXCLUSIVE    8\n```\nshm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive\n**shmexcl<->sharedunlockunlock**\n\nposix\n unixShm sharedMaskexclMaskshmmmap\n\n1. SQLITE_SHM_UNLOCK\nunixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask\n\n2. SQLITE_SHM_SHARED\nunixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1\n\n3. SQLITE_SHM_EXCLUSIVE\nunixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1\n\n### sqlite3OsShmBarrier\n\n`__sync_synchronize()`\n\n>\nmmap\n[ - ccxikka - ](https://www.cnblogs.com/ccxikka/p/10527056.html)\n[mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5)\n[mmap()](https://blog.csdn.net/Holy_666/article/details/86532671)\n\n[ - ](https://www.jianshu.com/p/64240319ed60)","slug":"13.sqlite-os-shm","published":1,"updated":"2020-08-29T14:42:58.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc618000belc94whra2qx","content":"<blockquote>\n<p>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"Shm-\"><a href=\"#Shm-\" class=\"headerlink\" title=\"Shm-\"></a>Shm-</h2><p>shm-shared memory walwal-index()<code>SQLITE_OMIT_WAL</code>sqlite osshm</p>\n<p>4</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmMap</span><span class=\"params\">(sqlite3_file *,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmLock</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>, <span class=\"type\">int</span>, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//mmap</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sqlite3OsShmBarrier</span><span class=\"params\">(sqlite3_file *id)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmUnmap</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//</span></span><br></pre></td></tr></table></figure>\n\n<p>mmap</p>\n<h3 id=\"mmap\"><a href=\"#mmap\" class=\"headerlink\" title=\"mmap\"></a>mmap</h3><p>mmap</p>\n<p>mmapmmapcrashflush</p>\n<p><strong></strong></p>\n<p><strong></strong><strong></strong>memory cachedirtysync</p>\n<p>read()write()buffcpucpuDMADMAcpubuff</p>\n<p></p>\n<p><strong>mmap</strong></p>\n<p>mmapvma<strong></strong></p>\n<p>:mmap</p>\n<p>mmapmmap</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>unixFileunixShm</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShm</span> &#123;</span></span><br><span class=\"line\">  unixShmNode *pShmNode;     <span class=\"comment\">/* The underlying unixShmNode object */</span></span><br><span class=\"line\">  unixShm *pNext;            <span class=\"comment\">/* Next unixShm with the same unixShmNode */</span></span><br><span class=\"line\">  u8 hasMutex;               <span class=\"comment\">/* True if holding the unixShmNode-&gt;pShmMutex */</span></span><br><span class=\"line\">  u8 id;                     <span class=\"comment\">/* Id of this connection within its unixShmNode */</span></span><br><span class=\"line\">  u16 sharedMask;            <span class=\"comment\">/* Mask of shared locks held */</span></span><br><span class=\"line\">  u16 exclMask;              <span class=\"comment\">/* Mask of exclusive locks held */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>unixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode</p>\n<p>unixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShmNode</span> &#123;</span></span><br><span class=\"line\">  unixInodeInfo *pInode;     <span class=\"comment\">/* unixInodeInfo that owns this SHM node */</span></span><br><span class=\"line\">  sqlite3_mutex *pShmMutex;  <span class=\"comment\">/* Mutex to access this object */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zFilename;           <span class=\"comment\">/* Name of the mmapped file */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hShm;                  <span class=\"comment\">/* Open file descriptor */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> szRegion;              <span class=\"comment\">/* Size of shared-memory regions */</span></span><br><span class=\"line\">  u16 nRegion;               <span class=\"comment\">/* Size of array apRegion */</span></span><br><span class=\"line\">  u8 isReadonly;             <span class=\"comment\">/* True if read-only */</span></span><br><span class=\"line\">  u8 isUnlocked;             <span class=\"comment\">/* True if no DMS lock held */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **apRegion;           <span class=\"comment\">/* Array of mapped shared-memory regions */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                  <span class=\"comment\">/* Number of unixShm objects pointing to this */</span></span><br><span class=\"line\">  unixShm *pFirst;           <span class=\"comment\">/* All unixShm objects pointing to this */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite4</p>\n<h3 id=\"sqlite3OsShmMap\"><a href=\"#sqlite3OsShmMap\" class=\"headerlink\" title=\"sqlite3OsShmMap\"></a>sqlite3OsShmMap</h3><p>shmMap</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmMap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* Handle open on database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> iRegion,                    <span class=\"comment\">/* Region to retrieve */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> szRegion,                   <span class=\"comment\">/* Size of regions */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> bExtend,                    <span class=\"comment\">/* True to extend file if necessary */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **pp              <span class=\"comment\">/* OUT: Mapped memory */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>sqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(<strong></strong>unixShmNodeszRegion)</p>\n<p>shmiRegionszRegionbExtendmmap</p>\n<p>sqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region</p>\n<p></p>\n<ol>\n<li>unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader</li>\n<li>regioniRegionregionnReqRegionnReqRegion&lt;unixShmNode.nRegion,35</li>\n<li></li>\n<li>mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion</li>\n<li>unixShmNode.apRegioniRegionregionmmap</li>\n</ol>\n<p><strong>mmap</strong><br>SqlitemmapSIGBUS</p>\n<p> <a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a> </p>\n<p>cachemmap</p>\n<h3 id=\"sqlite3OsShmUnmap\"><a href=\"#sqlite3OsShmUnmap\" class=\"headerlink\" title=\"sqlite3OsShmUnmap\"></a>sqlite3OsShmUnmap</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmUnmap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* The underlying database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> deleteFlag                  <span class=\"comment\">/* Delete shared-memory if true */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n<p>UnmapdeleteFlag1</p>\n<p></p>\n<ol>\n<li>unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm</li>\n<li>unixShmNode0</li>\n<li>nShmPerMaposMunmapmmap</li>\n</ol>\n<h3 id=\"sqlite3OsShmLock\"><a href=\"#sqlite3OsShmLock\" class=\"headerlink\" title=\"sqlite3OsShmLock\"></a>sqlite3OsShmLock</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmLock</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,          <span class=\"comment\">/* Database file holding the shared memory */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> ofst,                  <span class=\"comment\">/* First lock to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> n,                     <span class=\"comment\">/* Number of locks to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> flags                  <span class=\"comment\">/* What to do with the lock */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define SQLITE_SHM_UNLOCK       1</span><br><span class=\"line\">#define SQLITE_SHM_LOCK         2</span><br><span class=\"line\">#define SQLITE_SHM_SHARED       4</span><br><span class=\"line\">#define SQLITE_SHM_EXCLUSIVE    8</span><br></pre></td></tr></table></figure>\n<p>shm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive<br><strong>shmexcl&lt;-&gt;sharedunlockunlock</strong></p>\n<p>posix<br> unixShm sharedMaskexclMaskshmmmap</p>\n<ol>\n<li><p>SQLITE_SHM_UNLOCK<br>unixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask</p>\n</li>\n<li><p>SQLITE_SHM_SHARED<br>unixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1</p>\n</li>\n<li><p>SQLITE_SHM_EXCLUSIVE<br>unixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1</p>\n</li>\n</ol>\n<h3 id=\"sqlite3OsShmBarrier\"><a href=\"#sqlite3OsShmBarrier\" class=\"headerlink\" title=\"sqlite3OsShmBarrier\"></a>sqlite3OsShmBarrier</h3><p><code>__sync_synchronize()</code></p>\n<blockquote>\n<p><br>mmap<br><a href=\"https://www.cnblogs.com/ccxikka/p/10527056.html\"> - ccxikka - </a><br><a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a><br><a href=\"https://blog.csdn.net/Holy_666/article/details/86532671\">mmap()</a><br><br><a href=\"https://www.jianshu.com/p/64240319ed60\"> - </a></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm</p>\n</blockquote>","more":"<h2 id=\"Shm-\"><a href=\"#Shm-\" class=\"headerlink\" title=\"Shm-\"></a>Shm-</h2><p>shm-shared memory walwal-index()<code>SQLITE_OMIT_WAL</code>sqlite osshm</p>\n<p>4</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmMap</span><span class=\"params\">(sqlite3_file *,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmLock</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>, <span class=\"type\">int</span>, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//mmap</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sqlite3OsShmBarrier</span><span class=\"params\">(sqlite3_file *id)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmUnmap</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//</span></span><br></pre></td></tr></table></figure>\n\n<p>mmap</p>\n<h3 id=\"mmap\"><a href=\"#mmap\" class=\"headerlink\" title=\"mmap\"></a>mmap</h3><p>mmap</p>\n<p>mmapmmapcrashflush</p>\n<p><strong></strong></p>\n<p><strong></strong><strong></strong>memory cachedirtysync</p>\n<p>read()write()buffcpucpuDMADMAcpubuff</p>\n<p></p>\n<p><strong>mmap</strong></p>\n<p>mmapvma<strong></strong></p>\n<p>:mmap</p>\n<p>mmapmmap</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>unixFileunixShm</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShm</span> &#123;</span></span><br><span class=\"line\">  unixShmNode *pShmNode;     <span class=\"comment\">/* The underlying unixShmNode object */</span></span><br><span class=\"line\">  unixShm *pNext;            <span class=\"comment\">/* Next unixShm with the same unixShmNode */</span></span><br><span class=\"line\">  u8 hasMutex;               <span class=\"comment\">/* True if holding the unixShmNode-&gt;pShmMutex */</span></span><br><span class=\"line\">  u8 id;                     <span class=\"comment\">/* Id of this connection within its unixShmNode */</span></span><br><span class=\"line\">  u16 sharedMask;            <span class=\"comment\">/* Mask of shared locks held */</span></span><br><span class=\"line\">  u16 exclMask;              <span class=\"comment\">/* Mask of exclusive locks held */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>unixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode</p>\n<p>unixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShmNode</span> &#123;</span></span><br><span class=\"line\">  unixInodeInfo *pInode;     <span class=\"comment\">/* unixInodeInfo that owns this SHM node */</span></span><br><span class=\"line\">  sqlite3_mutex *pShmMutex;  <span class=\"comment\">/* Mutex to access this object */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zFilename;           <span class=\"comment\">/* Name of the mmapped file */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hShm;                  <span class=\"comment\">/* Open file descriptor */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> szRegion;              <span class=\"comment\">/* Size of shared-memory regions */</span></span><br><span class=\"line\">  u16 nRegion;               <span class=\"comment\">/* Size of array apRegion */</span></span><br><span class=\"line\">  u8 isReadonly;             <span class=\"comment\">/* True if read-only */</span></span><br><span class=\"line\">  u8 isUnlocked;             <span class=\"comment\">/* True if no DMS lock held */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **apRegion;           <span class=\"comment\">/* Array of mapped shared-memory regions */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                  <span class=\"comment\">/* Number of unixShm objects pointing to this */</span></span><br><span class=\"line\">  unixShm *pFirst;           <span class=\"comment\">/* All unixShm objects pointing to this */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite4</p>\n<h3 id=\"sqlite3OsShmMap\"><a href=\"#sqlite3OsShmMap\" class=\"headerlink\" title=\"sqlite3OsShmMap\"></a>sqlite3OsShmMap</h3><p>shmMap</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmMap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* Handle open on database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> iRegion,                    <span class=\"comment\">/* Region to retrieve */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> szRegion,                   <span class=\"comment\">/* Size of regions */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> bExtend,                    <span class=\"comment\">/* True to extend file if necessary */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **pp              <span class=\"comment\">/* OUT: Mapped memory */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>sqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(<strong></strong>unixShmNodeszRegion)</p>\n<p>shmiRegionszRegionbExtendmmap</p>\n<p>sqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region</p>\n<p></p>\n<ol>\n<li>unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader</li>\n<li>regioniRegionregionnReqRegionnReqRegion&lt;unixShmNode.nRegion,35</li>\n<li></li>\n<li>mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion</li>\n<li>unixShmNode.apRegioniRegionregionmmap</li>\n</ol>\n<p><strong>mmap</strong><br>SqlitemmapSIGBUS</p>\n<p> <a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a> </p>\n<p>cachemmap</p>\n<h3 id=\"sqlite3OsShmUnmap\"><a href=\"#sqlite3OsShmUnmap\" class=\"headerlink\" title=\"sqlite3OsShmUnmap\"></a>sqlite3OsShmUnmap</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmUnmap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* The underlying database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> deleteFlag                  <span class=\"comment\">/* Delete shared-memory if true */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n<p>UnmapdeleteFlag1</p>\n<p></p>\n<ol>\n<li>unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm</li>\n<li>unixShmNode0</li>\n<li>nShmPerMaposMunmapmmap</li>\n</ol>\n<h3 id=\"sqlite3OsShmLock\"><a href=\"#sqlite3OsShmLock\" class=\"headerlink\" title=\"sqlite3OsShmLock\"></a>sqlite3OsShmLock</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmLock</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,          <span class=\"comment\">/* Database file holding the shared memory */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> ofst,                  <span class=\"comment\">/* First lock to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> n,                     <span class=\"comment\">/* Number of locks to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> flags                  <span class=\"comment\">/* What to do with the lock */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define SQLITE_SHM_UNLOCK       1</span><br><span class=\"line\">#define SQLITE_SHM_LOCK         2</span><br><span class=\"line\">#define SQLITE_SHM_SHARED       4</span><br><span class=\"line\">#define SQLITE_SHM_EXCLUSIVE    8</span><br></pre></td></tr></table></figure>\n<p>shm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive<br><strong>shmexcl&lt;-&gt;sharedunlockunlock</strong></p>\n<p>posix<br> unixShm sharedMaskexclMaskshmmmap</p>\n<ol>\n<li><p>SQLITE_SHM_UNLOCK<br>unixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask</p>\n</li>\n<li><p>SQLITE_SHM_SHARED<br>unixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1</p>\n</li>\n<li><p>SQLITE_SHM_EXCLUSIVE<br>unixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1</p>\n</li>\n</ol>\n<h3 id=\"sqlite3OsShmBarrier\"><a href=\"#sqlite3OsShmBarrier\" class=\"headerlink\" title=\"sqlite3OsShmBarrier\"></a>sqlite3OsShmBarrier</h3><p><code>__sync_synchronize()</code></p>\n<blockquote>\n<p><br>mmap<br><a href=\"https://www.cnblogs.com/ccxikka/p/10527056.html\"> - ccxikka - </a><br><a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a><br><a href=\"https://blog.csdn.net/Holy_666/article/details/86532671\">mmap()</a><br><br><a href=\"https://www.jianshu.com/p/64240319ed60\"> - </a></p>\n</blockquote>"},{"title":"GoMobile\"\"","date":"2020-03-31T16:00:00.000Z","_content":"\n> ...Golanggomobile bind -target=ios xxx framework\n\nGolangOCGoOCGolang\n\nGobind\n\n<!-- more -->\n\nGo\n```\npackage g_mb_test\n\ntype GMBInterface interface {\n\tInterfaceTest()\n}\ntype GMBTest struct {\n}\n\nfunc (t *GMBTest) GMBTestOne(value int32) {\n\n}\n\nfunc (t *GMBTest) GMBTestSecond(data []byte, str string) {\n\n}\n\nfunc (t *GMBTest) GMBTest3() string {\n    return \n}\n\nfunc (t *GMBTest) GMBTest4() []byte {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest5() GMBInterface {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest6() *GMBTest {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest7(i GMBInterface) {\n}\n```\n\n1. Go OC\n2. OCGolang\n3. OCGolangNSData -> []byte, NSString -> string, interface(OC) -> interface\n4. OCGolang GolangOC\n5. Golang[]byte -> NSData, string -> NSString, interface -> interface(OC)?\n6. Golang \n\n\nGolangCGolang\"\"C(cgo)OCCOCCOCGolang C\n\n\n`gomobile bind -target=ios/amd64 -work Caio/g_mb_test`\n\ngo-buildxxxsrcgomobile\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png)\n\n### \n```\n- (instancetype)init {\n    self = [super init];\n    if (self) {\n        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());\n    }\n    return self;\n}\n```\n\nnew_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego\n\niOS frameworknew_g_mb_test_GMBTest()frameworkGo\n\n new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m\n```\nGoSeqRef *go_seq_from_refnum(int32_t refnum) {\n  if (refnum == NULL_REFNUM) {\n    return nil;\n  }\n  if (IS_FROM_GO(refnum)) {\n    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];\n  }\n  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];\n}\n```\n\nGoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj\n\nint32\n*Go*\n\n```\n*go_g_mb_testmain.go*\n//export new_g_mb_test_GMBTest\nfunc new_g_mb_test_GMBTest() C.int32_t {\n    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))\n}\n```\n\n new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org/x/mobile/bind/seq/ref.go bindgo struct\n\n```\n*golang.org/x/mobile/bind/seq/ref.go*\n// ToRefNum increments the reference count for an object and\n// returns its refnum.\nfunc ToRefNum(obj interface{}) int32 {\n    // We dont track foreign objects, so if obj is a proxy\n    // return its refnum.\n    if r, ok := obj.(proxy); ok {\n        refnum := r.Bind_proxy_refnum__()\n        if refnum <= 0 {\n            panic(fmt.Errorf(\"seq: proxy contained invalid Go refnum: %d\", refnum))\n        }\n        return refnum\n    }\n    refs.Lock()\n    num := refs.refs[obj]\n    if num != 0 {\n        s := refs.objs[num]\n        refs.objs[num] = countedObj{s.obj, s.cnt + 1}\n    } else {\n        num = refs.next\n        refs.next--\n        if refs.next > 0 {\n            panic(refs.next underflow)\n        }\n        refs.refs[obj] = num\n        refs.objs[num] = countedObj{obj, 1}\n    }\n    refs.Unlock()\n\n    return int32(num)\n}\n```\n\nproxyrefs\n```\n// refs stores Go objects that have been passed to another language.\nvar refs struct {\n    sync.Mutex\n    next int32 // next reference number to use for Go object, always negative\n    refs map[interface{}]int32\n    objs map[int32]countedObj\n}\n```\n\nrefsGolang\n\nmaprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum\n\nrefobjnumnext-1refnummap\n\n****\n1. GoGo\n2. Gorefnum\n3. +1\n4. Gorefnum\n\n**\n Go oc :\n\nOCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo\n\n#### OC\nGolang gmbTestOne \n\n```\n- (void)gmbTestOne:(int32_t)value {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _value = (int32_t)value;\n    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);\n}\n\n```\ngo_seq_go_to_refnum()Seq_darwin.m\n```\n- (int32_t)incNum {\n  IncGoRef(_refnum);\n  return _refnum;\n}\n```\n_refnumIncGoRef(_refnum);\nref.goGo\n**OC ARCint32_t refnum int\n\nproxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue\n\n refnumGoGo\n*Go*\n```\n//export proxyg_mb_test_GMBTest_GMBTestOne\nfunc proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    _param_value := int32(param_value)\n    v.GMBTestOne(_param_value)\n}\n```\n\n```\n// FromRefNum returns the Ref for a refnum. If the refnum specifies a\n// foreign object, a finalizer is set to track its lifetime.\nfunc FromRefNum(num int32) *Ref {\n    if num == NullRefNum {\n        return nil\n    }\n    ref := &Ref{num}\n    if num > 0 {\n        // This is a foreign object reference.\n        // Track its lifetime with a finalizer.\n        runtime.SetFinalizer(ref, FinalizeRef)\n    }\n\n    return ref\n}\n```\nOCGoRefrefnum\nnum > 0\n\n```\n// Get returns the underlying object.\nfunc (r *Ref) Get() interface{} {\n    refnum := r.Bind_Num\n    refs.Lock()\n    o, ok := refs.objs[refnum]\n    refs.Unlock()\n    if !ok {\n        panic(fmt.Sprintf(unknown ref %d, refnum))\n    }\n    // This is a Go reference and its refnum was incremented\n    // before crossing the language barrier.\n    Delete(refnum)\n    return o.obj\n}\n```\nDelete-10map\n\n**GolangGolang v := ref.Get().(*g_mb_test.GMBTest) GolangGolang\n\nGoint\n\n****\nOCGolangOCself.ref  refnumGoGorefnumGolang\n\n#### Golang\nGolangGoGoGoGoOCNSDataNSString\n\n```\n- (G_mb_testGMBTest*)gmbTest6 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);\n    G_mb_testGMBTest* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest6()intGolang\n```\n//export proxyg_mb_test_GMBTest_GMBTest6\nfunc proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    res_0 := v.GMBTest6()\n    var _res_0 C.int32_t = _seq.NullRefNum\n    if res_0 != nil {\n        _res_0 = C.int32_t(_seq.ToRefNum(res_0))\n    }\n    return _res_0\n}\n```\n\nres_0nil_seq.NullRefNum = 41null\nOCgo_seq_from_refnum()41\n\n****\nGorefnumOCGoSeqRefGo\n\n#### Golang\nGo\n\n```\n- (id<G_mb_testGMBInterface>)gmbTest5 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);\n    G_mb_testGMBInterface* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum\n\n```\n@implementation G_mb_testGMBInterface {\n}\n\n- (instancetype)initWithRef:(id)ref {\n    self = [super init];\n    if (self) { __ref = ref; }\n    return self;\n}\n\n- (void)interfaceTest {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);\n}\n\n@end\n```\n\ng_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo\n\n****\nGoOCrefnumGoSeqRefGoSeqRefGo\n\nGoNSDataNSStringOCGo\n\n#### OCGo\n\n\n```\n- (void)gmbTest7:(id<G_mb_testGMBInterface>)i {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _i;\n    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) {\n        id<goSeqRefInterface> i_proxy = (id<goSeqRefInterface>)(i);\n        _i = go_seq_go_to_refnum(i_proxy._ref);\n    } else {\n        _i = go_seq_to_refnum(i);\n    }\n    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);\n}\n```\ngoSeqRefInterfaceGoGoSeqRef)\nGo\nGoOC newgo_seq_to_refnum()\n\ntracker\nOCGorefsOCGo\nGoOCGoGorefnumOC\n\nproxyg_mb_test_GMBTest_GMBTest7()\n```\n//export proxyg_mb_test_GMBTest_GMBTest7\nfunc proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    var _param_i g_mb_test.GMBInterface\n    _param_i_ref := _seq.FromRefNum(int32(param_i))\n    if _param_i_ref != nil {\n        if param_i < 0 { // go object\n            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)\n        } else { // foreign object\n            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)\n        }\n    }\n    v.GMBTest7(_param_i)\n}\n```\n\n_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface\n\nproxyg_mb_test_GMBInterface \n```\ntype proxyg_mb_test_GMBInterface _seq.Ref\n\nfunc (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 { return (*_seq.Ref)(p).Bind_IncNum() }\n\nfunc (p *proxyg_mb_test_GMBInterface) InterfaceTest() {\n    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))\n}\n```\n\nBind_proxy_refnum__()RefBind_IncNum(),\n```\nfunc init() {\n    _seq.FinalizeRef = func(ref *_seq.Ref) {\n        refnum := ref.Bind_Num\n        if refnum < 0 {\n            panic(fmt.Sprintf(not a foreign ref: %d, refnum))\n        }\n        C.go_seq_dec_ref(C.int32_t(refnum))\n    }\n    _seq.IncForeignRef = func(refnum int32) {\n        if refnum < 0 {\n            panic(fmt.Sprintf(\"not a foreign ref: %d\", refnum))\n        }\n        C.go_seq_inc_ref(C.int32_t(refnum))\n    }\n}\n```\nseqBind_IncNum()_seq.IncForeignRef()\nC.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),\n\n```\nvoid go_seq_dec_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker dec:refnum];\n  }\n}\n\nvoid go_seq_inc_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker inc:refnum];\n  }\n}\n\n```\nseq_darwin.m\n\nFromRefNumGoRef\nGoRefGoRef \n\nInterfaceTest()\n```\nvoid cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) {\n    @autoreleasepool {\n        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);\n        [o interfaceTest];\n    }\n}\n```\n_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];\nOC\n\n****\nOCGoGoGoOC+11GoGoRef -1\nGoGoRefOCOCOCOC-1Go\n\ngo_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum\n\n## \n1. GoCOCOC\n2. GoOCint32(refnum)refnum>0OC<0Go\n3. GoOCrefnumGoRef structGoSeqRef class\n4. GoOC\n5. OCGorefnum\n6. OCGoGoCrefnumGoGo\n7. GoOCC.mrefnumOCOC\n8. OCGoGoSeqRefrefnumGo\n9. GoOCC.mGoRefOCrefnum.mOC\n10. GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1\n11. OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1\n12. GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1\n13. OCGoGoBind_IncNum()+1OCrefnumoc obj -1\n\n\n\n//\n\n## \n NSString  NSDataGo <> OC gomobile \n```\ntypedef struct nstring {\n  void *ptr;\n  int len;\n} nstring;\n\ntypedef struct nbyteslice {\n  void *ptr;\n  int len;\n} nbyteslice;\ntypedef int nint;\n```\nCstruct\n\n### String\n```\n// encodeString copies a Go string and returns it as a nstring.\nfunc encodeString(s string) C.nstring {\n    n := C.int(len(s))\n    if n == 0 {\n        return C.nstring{}\n    }\n    ptr := C.malloc(C.size_t(n))\n    if ptr == nil {\n        panic(\"encodeString: malloc failed\")\n    }\n    copy((*[1<<31 - 1]byte)(ptr)[:n], s)\n    return C.nstring{ptr: ptr, len: n}\n}\n\n// decodeString converts a nstring to a Go string. The\n// data in str is freed after use.\nfunc decodeString(str C.nstring) string {\n    if str.ptr == nil {\n        return \"\"\n    }\n    s := C.GoStringN((*C.char)(str.ptr), str.len)\n    C.free(str.ptr)\n    return s\n}\n```\n\nGo  string encodedecodecstringgo string*copy*\n\n```\nNSString *go_seq_to_objc_string(nstring str) {\n  if (str.len == 0) {  // empty string.\n    return @;\n  }\n  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr\n                                                  length:str.len\n                                                encoding:NSUTF8StringEncoding\n                                            freeWhenDone:YES];\n  return res;\n}\n\nnstring go_seq_from_objc_string(NSString *s) {\n  nstring res = {NULL, 0};\n  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];\n\n  if (len == 0) {\n    if (s.length > 0) {\n      LOG_INFO(@unable to encode an NSString into UTF-8);\n    }\n    return res;\n  }\n\n  char *buf = (char *)malloc(len);\n  if (buf == NULL) {\n    LOG_FATAL(@\"malloc failed\");\n  }\n  NSUInteger used;\n  [s getBytes:buf\n           maxLength:len\n          usedLength:&used\n            encoding:NSUTF8StringEncoding\n             options:0\n               range:NSMakeRange(0, [s length])\n      remainingRange:NULL];\n  res.ptr = buf;\n  res.len = used;\n  return res;\n}\n```\n\nOC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring*copy*\n\ncstring\n\n### Bytes\n```\n\n// fromSlice converts a slice to a nbyteslice.\n// If cpy is set, a malloced copy of the data is returned.\nfunc fromSlice(s []byte, cpy bool) C.nbyteslice {\n    if s == nil || len(s) == 0 {\n        return C.nbyteslice{}\n    }\n    ptr, n := unsafe.Pointer(&s[0]), C.int(len(s))\n    if cpy {\n        nptr := C.malloc(C.size_t(n))\n        if nptr == nil {\n            panic(\"fromSlice: malloc failed\")\n        }\n        copy((*[1<<31 - 1]byte)(nptr)[:n], (*[1<<31 - 1]byte)(ptr)[:n])\n        ptr = nptr\n    }\n    return C.nbyteslice{ptr: ptr, len: n}\n}\n\n// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is\n// set, the slice contains a copy of the data. If not, the generated Go code\n// calls releaseByteSlice after use.\nfunc toSlice(s C.nbyteslice, cpy bool) []byte {\n    if s.ptr == nil || s.len == 0 {\n        return nil\n    }\n    var b []byte\n    if cpy {\n        b = C.GoBytes(s.ptr, C.int(s.len))\n        C.free(s.ptr)\n    } else {\n        b = (*[1<<31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]\n    }\n    return b\n}\n```\n\nGo  nbyteslice fromSlicetoSlicenbyteslicego slice\n\nOC -> Go OCcopy == trueGonbyteslice\nGo -> OC  (copy go->OC copy=true)\n\n```\nNSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) {\n  if (s.ptr == NULL) {\n    return NULL;\n  }\n  BOOL freeWhenDone = copy ? YES : NO;\n  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];\n}\n\nnbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) {\n  struct nbyteslice res = {NULL, 0};\n  int sz = data.length;\n  if (sz == 0) {\n    return res;\n  }\n  void *ptr;\n  // If the argument was not a NSMutableData, copy the data so that\n  // the NSData is not changed from Go. The corresponding free is called\n  // by releaseByteSlice.\n  if (copy || ![data isKindOfClass:[NSMutableData class]]) {\n    void *arr_copy = malloc(sz);\n    if (arr_copy == NULL) {\n      LOG_FATAL(@\"malloc failed\");\n    }\n    memcpy(arr_copy, [data bytes], sz);\n    ptr = arr_copy;\n  } else {\n    ptr = (void *)[data bytes];\n  }\n  res.ptr = ptr;\n  res.len = sz;\n  return res;\n}\n\n```\n\nOC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData\n\nOC -> Go (NSMutableData && !copy OC->Go copy = falseNSDataNSMutableData)*bytes*Goslicebytes\nGo -> OC  OCGobytesOCNSDatanbyteslice.\n\n*copycopyNSDatafalse*\n\n---\n\n2020-3-18 \n[ Dart  Objective-C ](http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/)\n\nDartOCGoMobile...","source":"_posts/14.gomobile-bind.md","raw":"---\ntitle: GoMobile\"\"\ndate: 2020-04-01\ntags: [GoMobile]\ncategories: GoMobile\n---\n\n> ...Golanggomobile bind -target=ios xxx framework\n\nGolangOCGoOCGolang\n\nGobind\n\n<!-- more -->\n\nGo\n```\npackage g_mb_test\n\ntype GMBInterface interface {\n\tInterfaceTest()\n}\ntype GMBTest struct {\n}\n\nfunc (t *GMBTest) GMBTestOne(value int32) {\n\n}\n\nfunc (t *GMBTest) GMBTestSecond(data []byte, str string) {\n\n}\n\nfunc (t *GMBTest) GMBTest3() string {\n    return \n}\n\nfunc (t *GMBTest) GMBTest4() []byte {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest5() GMBInterface {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest6() *GMBTest {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest7(i GMBInterface) {\n}\n```\n\n1. Go OC\n2. OCGolang\n3. OCGolangNSData -> []byte, NSString -> string, interface(OC) -> interface\n4. OCGolang GolangOC\n5. Golang[]byte -> NSData, string -> NSString, interface -> interface(OC)?\n6. Golang \n\n\nGolangCGolang\"\"C(cgo)OCCOCCOCGolang C\n\n\n`gomobile bind -target=ios/amd64 -work Caio/g_mb_test`\n\ngo-buildxxxsrcgomobile\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png)\n\n### \n```\n- (instancetype)init {\n    self = [super init];\n    if (self) {\n        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());\n    }\n    return self;\n}\n```\n\nnew_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego\n\niOS frameworknew_g_mb_test_GMBTest()frameworkGo\n\n new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m\n```\nGoSeqRef *go_seq_from_refnum(int32_t refnum) {\n  if (refnum == NULL_REFNUM) {\n    return nil;\n  }\n  if (IS_FROM_GO(refnum)) {\n    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];\n  }\n  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];\n}\n```\n\nGoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj\n\nint32\n*Go*\n\n```\n*go_g_mb_testmain.go*\n//export new_g_mb_test_GMBTest\nfunc new_g_mb_test_GMBTest() C.int32_t {\n    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))\n}\n```\n\n new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org/x/mobile/bind/seq/ref.go bindgo struct\n\n```\n*golang.org/x/mobile/bind/seq/ref.go*\n// ToRefNum increments the reference count for an object and\n// returns its refnum.\nfunc ToRefNum(obj interface{}) int32 {\n    // We dont track foreign objects, so if obj is a proxy\n    // return its refnum.\n    if r, ok := obj.(proxy); ok {\n        refnum := r.Bind_proxy_refnum__()\n        if refnum <= 0 {\n            panic(fmt.Errorf(\"seq: proxy contained invalid Go refnum: %d\", refnum))\n        }\n        return refnum\n    }\n    refs.Lock()\n    num := refs.refs[obj]\n    if num != 0 {\n        s := refs.objs[num]\n        refs.objs[num] = countedObj{s.obj, s.cnt + 1}\n    } else {\n        num = refs.next\n        refs.next--\n        if refs.next > 0 {\n            panic(refs.next underflow)\n        }\n        refs.refs[obj] = num\n        refs.objs[num] = countedObj{obj, 1}\n    }\n    refs.Unlock()\n\n    return int32(num)\n}\n```\n\nproxyrefs\n```\n// refs stores Go objects that have been passed to another language.\nvar refs struct {\n    sync.Mutex\n    next int32 // next reference number to use for Go object, always negative\n    refs map[interface{}]int32\n    objs map[int32]countedObj\n}\n```\n\nrefsGolang\n\nmaprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum\n\nrefobjnumnext-1refnummap\n\n****\n1. GoGo\n2. Gorefnum\n3. +1\n4. Gorefnum\n\n**\n Go oc :\n\nOCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo\n\n#### OC\nGolang gmbTestOne \n\n```\n- (void)gmbTestOne:(int32_t)value {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _value = (int32_t)value;\n    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);\n}\n\n```\ngo_seq_go_to_refnum()Seq_darwin.m\n```\n- (int32_t)incNum {\n  IncGoRef(_refnum);\n  return _refnum;\n}\n```\n_refnumIncGoRef(_refnum);\nref.goGo\n**OC ARCint32_t refnum int\n\nproxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue\n\n refnumGoGo\n*Go*\n```\n//export proxyg_mb_test_GMBTest_GMBTestOne\nfunc proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    _param_value := int32(param_value)\n    v.GMBTestOne(_param_value)\n}\n```\n\n```\n// FromRefNum returns the Ref for a refnum. If the refnum specifies a\n// foreign object, a finalizer is set to track its lifetime.\nfunc FromRefNum(num int32) *Ref {\n    if num == NullRefNum {\n        return nil\n    }\n    ref := &Ref{num}\n    if num > 0 {\n        // This is a foreign object reference.\n        // Track its lifetime with a finalizer.\n        runtime.SetFinalizer(ref, FinalizeRef)\n    }\n\n    return ref\n}\n```\nOCGoRefrefnum\nnum > 0\n\n```\n// Get returns the underlying object.\nfunc (r *Ref) Get() interface{} {\n    refnum := r.Bind_Num\n    refs.Lock()\n    o, ok := refs.objs[refnum]\n    refs.Unlock()\n    if !ok {\n        panic(fmt.Sprintf(unknown ref %d, refnum))\n    }\n    // This is a Go reference and its refnum was incremented\n    // before crossing the language barrier.\n    Delete(refnum)\n    return o.obj\n}\n```\nDelete-10map\n\n**GolangGolang v := ref.Get().(*g_mb_test.GMBTest) GolangGolang\n\nGoint\n\n****\nOCGolangOCself.ref  refnumGoGorefnumGolang\n\n#### Golang\nGolangGoGoGoGoOCNSDataNSString\n\n```\n- (G_mb_testGMBTest*)gmbTest6 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);\n    G_mb_testGMBTest* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest6()intGolang\n```\n//export proxyg_mb_test_GMBTest_GMBTest6\nfunc proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    res_0 := v.GMBTest6()\n    var _res_0 C.int32_t = _seq.NullRefNum\n    if res_0 != nil {\n        _res_0 = C.int32_t(_seq.ToRefNum(res_0))\n    }\n    return _res_0\n}\n```\n\nres_0nil_seq.NullRefNum = 41null\nOCgo_seq_from_refnum()41\n\n****\nGorefnumOCGoSeqRefGo\n\n#### Golang\nGo\n\n```\n- (id<G_mb_testGMBInterface>)gmbTest5 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);\n    G_mb_testGMBInterface* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum\n\n```\n@implementation G_mb_testGMBInterface {\n}\n\n- (instancetype)initWithRef:(id)ref {\n    self = [super init];\n    if (self) { __ref = ref; }\n    return self;\n}\n\n- (void)interfaceTest {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);\n}\n\n@end\n```\n\ng_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo\n\n****\nGoOCrefnumGoSeqRefGoSeqRefGo\n\nGoNSDataNSStringOCGo\n\n#### OCGo\n\n\n```\n- (void)gmbTest7:(id<G_mb_testGMBInterface>)i {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _i;\n    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) {\n        id<goSeqRefInterface> i_proxy = (id<goSeqRefInterface>)(i);\n        _i = go_seq_go_to_refnum(i_proxy._ref);\n    } else {\n        _i = go_seq_to_refnum(i);\n    }\n    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);\n}\n```\ngoSeqRefInterfaceGoGoSeqRef)\nGo\nGoOC newgo_seq_to_refnum()\n\ntracker\nOCGorefsOCGo\nGoOCGoGorefnumOC\n\nproxyg_mb_test_GMBTest_GMBTest7()\n```\n//export proxyg_mb_test_GMBTest_GMBTest7\nfunc proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    var _param_i g_mb_test.GMBInterface\n    _param_i_ref := _seq.FromRefNum(int32(param_i))\n    if _param_i_ref != nil {\n        if param_i < 0 { // go object\n            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)\n        } else { // foreign object\n            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)\n        }\n    }\n    v.GMBTest7(_param_i)\n}\n```\n\n_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface\n\nproxyg_mb_test_GMBInterface \n```\ntype proxyg_mb_test_GMBInterface _seq.Ref\n\nfunc (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 { return (*_seq.Ref)(p).Bind_IncNum() }\n\nfunc (p *proxyg_mb_test_GMBInterface) InterfaceTest() {\n    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))\n}\n```\n\nBind_proxy_refnum__()RefBind_IncNum(),\n```\nfunc init() {\n    _seq.FinalizeRef = func(ref *_seq.Ref) {\n        refnum := ref.Bind_Num\n        if refnum < 0 {\n            panic(fmt.Sprintf(not a foreign ref: %d, refnum))\n        }\n        C.go_seq_dec_ref(C.int32_t(refnum))\n    }\n    _seq.IncForeignRef = func(refnum int32) {\n        if refnum < 0 {\n            panic(fmt.Sprintf(\"not a foreign ref: %d\", refnum))\n        }\n        C.go_seq_inc_ref(C.int32_t(refnum))\n    }\n}\n```\nseqBind_IncNum()_seq.IncForeignRef()\nC.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),\n\n```\nvoid go_seq_dec_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker dec:refnum];\n  }\n}\n\nvoid go_seq_inc_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker inc:refnum];\n  }\n}\n\n```\nseq_darwin.m\n\nFromRefNumGoRef\nGoRefGoRef \n\nInterfaceTest()\n```\nvoid cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) {\n    @autoreleasepool {\n        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);\n        [o interfaceTest];\n    }\n}\n```\n_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];\nOC\n\n****\nOCGoGoGoOC+11GoGoRef -1\nGoGoRefOCOCOCOC-1Go\n\ngo_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum\n\n## \n1. GoCOCOC\n2. GoOCint32(refnum)refnum>0OC<0Go\n3. GoOCrefnumGoRef structGoSeqRef class\n4. GoOC\n5. OCGorefnum\n6. OCGoGoCrefnumGoGo\n7. GoOCC.mrefnumOCOC\n8. OCGoGoSeqRefrefnumGo\n9. GoOCC.mGoRefOCrefnum.mOC\n10. GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1\n11. OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1\n12. GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1\n13. OCGoGoBind_IncNum()+1OCrefnumoc obj -1\n\n\n\n//\n\n## \n NSString  NSDataGo <> OC gomobile \n```\ntypedef struct nstring {\n  void *ptr;\n  int len;\n} nstring;\n\ntypedef struct nbyteslice {\n  void *ptr;\n  int len;\n} nbyteslice;\ntypedef int nint;\n```\nCstruct\n\n### String\n```\n// encodeString copies a Go string and returns it as a nstring.\nfunc encodeString(s string) C.nstring {\n    n := C.int(len(s))\n    if n == 0 {\n        return C.nstring{}\n    }\n    ptr := C.malloc(C.size_t(n))\n    if ptr == nil {\n        panic(\"encodeString: malloc failed\")\n    }\n    copy((*[1<<31 - 1]byte)(ptr)[:n], s)\n    return C.nstring{ptr: ptr, len: n}\n}\n\n// decodeString converts a nstring to a Go string. The\n// data in str is freed after use.\nfunc decodeString(str C.nstring) string {\n    if str.ptr == nil {\n        return \"\"\n    }\n    s := C.GoStringN((*C.char)(str.ptr), str.len)\n    C.free(str.ptr)\n    return s\n}\n```\n\nGo  string encodedecodecstringgo string*copy*\n\n```\nNSString *go_seq_to_objc_string(nstring str) {\n  if (str.len == 0) {  // empty string.\n    return @;\n  }\n  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr\n                                                  length:str.len\n                                                encoding:NSUTF8StringEncoding\n                                            freeWhenDone:YES];\n  return res;\n}\n\nnstring go_seq_from_objc_string(NSString *s) {\n  nstring res = {NULL, 0};\n  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];\n\n  if (len == 0) {\n    if (s.length > 0) {\n      LOG_INFO(@unable to encode an NSString into UTF-8);\n    }\n    return res;\n  }\n\n  char *buf = (char *)malloc(len);\n  if (buf == NULL) {\n    LOG_FATAL(@\"malloc failed\");\n  }\n  NSUInteger used;\n  [s getBytes:buf\n           maxLength:len\n          usedLength:&used\n            encoding:NSUTF8StringEncoding\n             options:0\n               range:NSMakeRange(0, [s length])\n      remainingRange:NULL];\n  res.ptr = buf;\n  res.len = used;\n  return res;\n}\n```\n\nOC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring*copy*\n\ncstring\n\n### Bytes\n```\n\n// fromSlice converts a slice to a nbyteslice.\n// If cpy is set, a malloced copy of the data is returned.\nfunc fromSlice(s []byte, cpy bool) C.nbyteslice {\n    if s == nil || len(s) == 0 {\n        return C.nbyteslice{}\n    }\n    ptr, n := unsafe.Pointer(&s[0]), C.int(len(s))\n    if cpy {\n        nptr := C.malloc(C.size_t(n))\n        if nptr == nil {\n            panic(\"fromSlice: malloc failed\")\n        }\n        copy((*[1<<31 - 1]byte)(nptr)[:n], (*[1<<31 - 1]byte)(ptr)[:n])\n        ptr = nptr\n    }\n    return C.nbyteslice{ptr: ptr, len: n}\n}\n\n// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is\n// set, the slice contains a copy of the data. If not, the generated Go code\n// calls releaseByteSlice after use.\nfunc toSlice(s C.nbyteslice, cpy bool) []byte {\n    if s.ptr == nil || s.len == 0 {\n        return nil\n    }\n    var b []byte\n    if cpy {\n        b = C.GoBytes(s.ptr, C.int(s.len))\n        C.free(s.ptr)\n    } else {\n        b = (*[1<<31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]\n    }\n    return b\n}\n```\n\nGo  nbyteslice fromSlicetoSlicenbyteslicego slice\n\nOC -> Go OCcopy == trueGonbyteslice\nGo -> OC  (copy go->OC copy=true)\n\n```\nNSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) {\n  if (s.ptr == NULL) {\n    return NULL;\n  }\n  BOOL freeWhenDone = copy ? YES : NO;\n  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];\n}\n\nnbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) {\n  struct nbyteslice res = {NULL, 0};\n  int sz = data.length;\n  if (sz == 0) {\n    return res;\n  }\n  void *ptr;\n  // If the argument was not a NSMutableData, copy the data so that\n  // the NSData is not changed from Go. The corresponding free is called\n  // by releaseByteSlice.\n  if (copy || ![data isKindOfClass:[NSMutableData class]]) {\n    void *arr_copy = malloc(sz);\n    if (arr_copy == NULL) {\n      LOG_FATAL(@\"malloc failed\");\n    }\n    memcpy(arr_copy, [data bytes], sz);\n    ptr = arr_copy;\n  } else {\n    ptr = (void *)[data bytes];\n  }\n  res.ptr = ptr;\n  res.len = sz;\n  return res;\n}\n\n```\n\nOC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData\n\nOC -> Go (NSMutableData && !copy OC->Go copy = falseNSDataNSMutableData)*bytes*Goslicebytes\nGo -> OC  OCGobytesOCNSDatanbyteslice.\n\n*copycopyNSDatafalse*\n\n---\n\n2020-3-18 \n[ Dart  Objective-C ](http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/)\n\nDartOCGoMobile...","slug":"14.gomobile-bind","published":1,"updated":"2020-08-29T14:42:58.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc619000delc90cuk7yu5","content":"<blockquote>\n<p>Golanggomobile bind -target&#x3D;ios xxx framework</p>\n</blockquote>\n<p>GolangOCGoOCGolang</p>\n<p>Gobind</p>\n<span id=\"more\"></span>\n\n<p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package g_mb_test</span><br><span class=\"line\"></span><br><span class=\"line\">type GMBInterface interface &#123;</span><br><span class=\"line\">\tInterfaceTest()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type GMBTest struct &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestOne(value int32) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestSecond(data []byte, str string) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest3() string &#123;</span><br><span class=\"line\">    return </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest4() []byte &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest5() GMBInterface &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest6() *GMBTest &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest7(i GMBInterface) &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>Go OC</li>\n<li>OCGolang</li>\n<li>OCGolangNSData -&gt; []byte, NSString -&gt; string, interface(OC) -&gt; interface</li>\n<li>OCGolang GolangOC</li>\n<li>Golang[]byte -&gt; NSData, string -&gt; NSString, interface -&gt; interface(OC)?</li>\n<li>Golang </li>\n</ol>\n<p>GolangCGolangC(cgo)OCCOCCOCGolang C</p>\n<p><code>gomobile bind -target=ios/amd64 -work Caio/g_mb_test</code></p>\n<p>go-buildxxxsrcgomobile<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (instancetype)init &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123;</span><br><span class=\"line\">        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>new_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego</p>\n<p>iOS frameworknew_g_mb_test_GMBTest()frameworkGo</p>\n<p> new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GoSeqRef *go_seq_from_refnum(int32_t refnum) &#123;</span><br><span class=\"line\">  if (refnum == NULL_REFNUM) &#123;</span><br><span class=\"line\">    return nil;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  if (IS_FROM_GO(refnum)) &#123;</span><br><span class=\"line\">    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>GoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj</p>\n<p>int32<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*go_g_mb_testmain.go*</span><br><span class=\"line\">//export new_g_mb_test_GMBTest</span><br><span class=\"line\">func new_g_mb_test_GMBTest() C.int32_t &#123;</span><br><span class=\"line\">    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org&#x2F;x&#x2F;mobile&#x2F;bind&#x2F;seq&#x2F;ref.go bindgo struct</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*golang.org/x/mobile/bind/seq/ref.go*</span><br><span class=\"line\">// ToRefNum increments the reference count for an object and</span><br><span class=\"line\">// returns its refnum.</span><br><span class=\"line\">func ToRefNum(obj interface&#123;&#125;) int32 &#123;</span><br><span class=\"line\">    // We dont track foreign objects, so if obj is a proxy</span><br><span class=\"line\">    // return its refnum.</span><br><span class=\"line\">    if r, ok := obj.(proxy); ok &#123;</span><br><span class=\"line\">        refnum := r.Bind_proxy_refnum__()</span><br><span class=\"line\">        if refnum &lt;= 0 &#123;</span><br><span class=\"line\">            panic(fmt.Errorf(&quot;seq: proxy contained invalid Go refnum: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return refnum</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    num := refs.refs[obj]</span><br><span class=\"line\">    if num != 0 &#123;</span><br><span class=\"line\">        s := refs.objs[num]</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;s.obj, s.cnt + 1&#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        num = refs.next</span><br><span class=\"line\">        refs.next--</span><br><span class=\"line\">        if refs.next &gt; 0 &#123;</span><br><span class=\"line\">            panic(refs.next underflow)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        refs.refs[obj] = num</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;obj, 1&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">    return int32(num)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>proxyrefs</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// refs stores Go objects that have been passed to another language.</span><br><span class=\"line\">var refs struct &#123;</span><br><span class=\"line\">    sync.Mutex</span><br><span class=\"line\">    next int32 // next reference number to use for Go object, always negative</span><br><span class=\"line\">    refs map[interface&#123;&#125;]int32</span><br><span class=\"line\">    objs map[int32]countedObj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>refsGolang</p>\n<p>maprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum</p>\n<p>refobjnumnext-1refnummap</p>\n<p><strong></strong></p>\n<ol>\n<li>GoGo</li>\n<li>Gorefnum</li>\n<li>+1</li>\n<li>Gorefnum</li>\n</ol>\n<p><em></em><br> Go oc :</p>\n<p>OCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo</p>\n<h4 id=\"OC\"><a href=\"#OC\" class=\"headerlink\" title=\"OC\"></a>OC</h4><p>Golang gmbTestOne </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTestOne:(int32_t)value &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _value = (int32_t)value;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>go_seq_go_to_refnum()Seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (int32_t)incNum &#123;</span><br><span class=\"line\">  IncGoRef(_refnum);</span><br><span class=\"line\">  return _refnum;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_refnumIncGoRef(_refnum);<br>ref.goGo<br><em></em>OC ARCint32_t refnum int</p>\n<p>proxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue</p>\n<p> refnumGoGo<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTestOne</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    _param_value := int32(param_value)</span><br><span class=\"line\">    v.GMBTestOne(_param_value)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// FromRefNum returns the Ref for a refnum. If the refnum specifies a</span><br><span class=\"line\">// foreign object, a finalizer is set to track its lifetime.</span><br><span class=\"line\">func FromRefNum(num int32) *Ref &#123;</span><br><span class=\"line\">    if num == NullRefNum &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ref := &amp;Ref&#123;num&#125;</span><br><span class=\"line\">    if num &gt; 0 &#123;</span><br><span class=\"line\">        // This is a foreign object reference.</span><br><span class=\"line\">        // Track its lifetime with a finalizer.</span><br><span class=\"line\">        runtime.SetFinalizer(ref, FinalizeRef)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    return ref</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>OCGoRefrefnum<br>num &gt; 0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Get returns the underlying object.</span><br><span class=\"line\">func (r *Ref) Get() interface&#123;&#125; &#123;</span><br><span class=\"line\">    refnum := r.Bind_Num</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    o, ok := refs.objs[refnum]</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\">    if !ok &#123;</span><br><span class=\"line\">        panic(fmt.Sprintf(unknown ref %d, refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // This is a Go reference and its refnum was incremented</span><br><span class=\"line\">    // before crossing the language barrier.</span><br><span class=\"line\">    Delete(refnum)</span><br><span class=\"line\">    return o.obj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Delete-10map</p>\n<p><em></em>GolangGolang v :&#x3D; ref.Get().(*g_mb_test.GMBTest) GolangGolang</p>\n<p>Goint</p>\n<p><strong></strong><br>OCGolangOCself.ref  refnumGoGorefnumGolang</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>GolangGoGoGoGoOCNSDataNSString</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (G_mb_testGMBTest*)gmbTest6 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);</span><br><span class=\"line\">    G_mb_testGMBTest* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest6()intGolang</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest6</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    res_0 := v.GMBTest6()</span><br><span class=\"line\">    var _res_0 C.int32_t = _seq.NullRefNum</span><br><span class=\"line\">    if res_0 != nil &#123;</span><br><span class=\"line\">        _res_0 = C.int32_t(_seq.ToRefNum(res_0))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _res_0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>res_0nil_seq.NullRefNum &#x3D; 41null<br>OCgo_seq_from_refnum()41</p>\n<p><strong></strong><br>GorefnumOCGoSeqRefGo</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (id&lt;G_mb_testGMBInterface&gt;)gmbTest5 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);</span><br><span class=\"line\">    G_mb_testGMBInterface* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@implementation G_mb_testGMBInterface &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (instancetype)initWithRef:(id)ref &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123; __ref = ref; &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (void)interfaceTest &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<p>g_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo</p>\n<p><strong></strong><br>GoOCrefnumGoSeqRefGoSeqRefGo</p>\n<p>GoNSDataNSStringOCGo</p>\n<h4 id=\"OCGo\"><a href=\"#OCGo\" class=\"headerlink\" title=\"OCGo\"></a>OCGo</h4><p></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTest7:(id&lt;G_mb_testGMBInterface&gt;)i &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _i;</span><br><span class=\"line\">    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) &#123;</span><br><span class=\"line\">        id&lt;goSeqRefInterface&gt; i_proxy = (id&lt;goSeqRefInterface&gt;)(i);</span><br><span class=\"line\">        _i = go_seq_go_to_refnum(i_proxy._ref);</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        _i = go_seq_to_refnum(i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>goSeqRefInterfaceGoGoSeqRef)<br>Go<br>GoOC newgo_seq_to_refnum()</p>\n<p>tracker<br>OCGorefsOCGo<br>GoOCGoGorefnumOC</p>\n<p>proxyg_mb_test_GMBTest_GMBTest7()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest7</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    var _param_i g_mb_test.GMBInterface</span><br><span class=\"line\">    _param_i_ref := _seq.FromRefNum(int32(param_i))</span><br><span class=\"line\">    if _param_i_ref != nil &#123;</span><br><span class=\"line\">        if param_i &lt; 0 &#123; // go object</span><br><span class=\"line\">            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)</span><br><span class=\"line\">        &#125; else &#123; // foreign object</span><br><span class=\"line\">            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v.GMBTest7(_param_i)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface</p>\n<p>proxyg_mb_test_GMBInterface </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type proxyg_mb_test_GMBInterface _seq.Ref</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 &#123; return (*_seq.Ref)(p).Bind_IncNum() &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) InterfaceTest() &#123;</span><br><span class=\"line\">    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br>Bind_proxy_refnum__()RefBind_IncNum(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func init() &#123;</span><br><span class=\"line\">    _seq.FinalizeRef = func(ref *_seq.Ref) &#123;</span><br><span class=\"line\">        refnum := ref.Bind_Num</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(not a foreign ref: %d, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_dec_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    _seq.IncForeignRef = func(refnum int32) &#123;</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(&quot;not a foreign ref: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_inc_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>seqBind_IncNum()_seq.IncForeignRef()<br>C.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void go_seq_dec_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker dec:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void go_seq_inc_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker inc:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>seq_darwin.m</p>\n<p>FromRefNumGoRef<br>GoRefGoRef </p>\n<p>InterfaceTest()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) &#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);</span><br><span class=\"line\">        [o interfaceTest];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];<br>OC</p>\n<p><strong></strong><br>OCGoGoGoOC+11GoGoRef -1<br>GoGoRefOCOCOCOC-1Go</p>\n<p>go_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>GoCOCOC</li>\n<li>GoOCint32(refnum)refnum&gt;0OC&lt;0Go</li>\n<li>GoOCrefnumGoRef structGoSeqRef class</li>\n<li>GoOC</li>\n<li>OCGorefnum</li>\n<li>OCGoGoCrefnumGoGo</li>\n<li>GoOCC.mrefnumOCOC</li>\n<li>OCGoGoSeqRefrefnumGo</li>\n<li>GoOCC.mGoRefOCrefnum.mOC</li>\n<li>GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1</li>\n<li>OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1</li>\n<li>GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1</li>\n<li>OCGoGoBind_IncNum()+1OCrefnumoc obj -1</li>\n</ol>\n<p></p>\n<p>&#x2F;&#x2F;</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> NSString  NSDataGo &lt;&gt; OC gomobile </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct nstring &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nstring;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct nbyteslice &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nbyteslice;</span><br><span class=\"line\">typedef int nint;</span><br></pre></td></tr></table></figure>\n<p>Cstruct</p>\n<h3 id=\"String\"><a href=\"#String\" class=\"headerlink\" title=\"String\"></a>String</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// encodeString copies a Go string and returns it as a nstring.</span><br><span class=\"line\">func encodeString(s string) C.nstring &#123;</span><br><span class=\"line\">    n := C.int(len(s))</span><br><span class=\"line\">    if n == 0 &#123;</span><br><span class=\"line\">        return C.nstring&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">    if ptr == nil &#123;</span><br><span class=\"line\">        panic(&quot;encodeString: malloc failed&quot;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    copy((*[1&lt;&lt;31 - 1]byte)(ptr)[:n], s)</span><br><span class=\"line\">    return C.nstring&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// decodeString converts a nstring to a Go string. The</span><br><span class=\"line\">// data in str is freed after use.</span><br><span class=\"line\">func decodeString(str C.nstring) string &#123;</span><br><span class=\"line\">    if str.ptr == nil &#123;</span><br><span class=\"line\">        return &quot;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    s := C.GoStringN((*C.char)(str.ptr), str.len)</span><br><span class=\"line\">    C.free(str.ptr)</span><br><span class=\"line\">    return s</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  string encodedecodecstringgo string<em>copy</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSString *go_seq_to_objc_string(nstring str) &#123;</span><br><span class=\"line\">  if (str.len == 0) &#123;  // empty string.</span><br><span class=\"line\">    return @;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr</span><br><span class=\"line\">                                                  length:str.len</span><br><span class=\"line\">                                                encoding:NSUTF8StringEncoding</span><br><span class=\"line\">                                            freeWhenDone:YES];</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nstring go_seq_from_objc_string(NSString *s) &#123;</span><br><span class=\"line\">  nstring res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];</span><br><span class=\"line\"></span><br><span class=\"line\">  if (len == 0) &#123;</span><br><span class=\"line\">    if (s.length &gt; 0) &#123;</span><br><span class=\"line\">      LOG_INFO(@unable to encode an NSString into UTF-8);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  char *buf = (char *)malloc(len);</span><br><span class=\"line\">  if (buf == NULL) &#123;</span><br><span class=\"line\">    LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSUInteger used;</span><br><span class=\"line\">  [s getBytes:buf</span><br><span class=\"line\">           maxLength:len</span><br><span class=\"line\">          usedLength:&amp;used</span><br><span class=\"line\">            encoding:NSUTF8StringEncoding</span><br><span class=\"line\">             options:0</span><br><span class=\"line\">               range:NSMakeRange(0, [s length])</span><br><span class=\"line\">      remainingRange:NULL];</span><br><span class=\"line\">  res.ptr = buf;</span><br><span class=\"line\">  res.len = used;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>OC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring<em>copy</em></p>\n<p>cstring</p>\n<h3 id=\"Bytes\"><a href=\"#Bytes\" class=\"headerlink\" title=\"Bytes\"></a>Bytes</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">// fromSlice converts a slice to a nbyteslice.</span><br><span class=\"line\">// If cpy is set, a malloced copy of the data is returned.</span><br><span class=\"line\">func fromSlice(s []byte, cpy bool) C.nbyteslice &#123;</span><br><span class=\"line\">    if s == nil || len(s) == 0 &#123;</span><br><span class=\"line\">        return C.nbyteslice&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr, n := unsafe.Pointer(&amp;s[0]), C.int(len(s))</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        nptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">        if nptr == nil &#123;</span><br><span class=\"line\">            panic(&quot;fromSlice: malloc failed&quot;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        copy((*[1&lt;&lt;31 - 1]byte)(nptr)[:n], (*[1&lt;&lt;31 - 1]byte)(ptr)[:n])</span><br><span class=\"line\">        ptr = nptr</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return C.nbyteslice&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is</span><br><span class=\"line\">// set, the slice contains a copy of the data. If not, the generated Go code</span><br><span class=\"line\">// calls releaseByteSlice after use.</span><br><span class=\"line\">func toSlice(s C.nbyteslice, cpy bool) []byte &#123;</span><br><span class=\"line\">    if s.ptr == nil || s.len == 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var b []byte</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        b = C.GoBytes(s.ptr, C.int(s.len))</span><br><span class=\"line\">        C.free(s.ptr)</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        b = (*[1&lt;&lt;31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return b</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  nbyteslice fromSlicetoSlicenbyteslicego slice</p>\n<p>OC -&gt; Go OCcopy &#x3D;&#x3D; trueGonbyteslice<br>Go -&gt; OC  (copy go-&gt;OC copy&#x3D;true)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) &#123;</span><br><span class=\"line\">  if (s.ptr == NULL) &#123;</span><br><span class=\"line\">    return NULL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  BOOL freeWhenDone = copy ? YES : NO;</span><br><span class=\"line\">  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) &#123;</span><br><span class=\"line\">  struct nbyteslice res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int sz = data.length;</span><br><span class=\"line\">  if (sz == 0) &#123;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  // If the argument was not a NSMutableData, copy the data so that</span><br><span class=\"line\">  // the NSData is not changed from Go. The corresponding free is called</span><br><span class=\"line\">  // by releaseByteSlice.</span><br><span class=\"line\">  if (copy || ![data isKindOfClass:[NSMutableData class]]) &#123;</span><br><span class=\"line\">    void *arr_copy = malloc(sz);</span><br><span class=\"line\">    if (arr_copy == NULL) &#123;</span><br><span class=\"line\">      LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    memcpy(arr_copy, [data bytes], sz);</span><br><span class=\"line\">    ptr = arr_copy;</span><br><span class=\"line\">  &#125; else &#123;</span><br><span class=\"line\">    ptr = (void *)[data bytes];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  res.ptr = ptr;</span><br><span class=\"line\">  res.len = sz;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>OC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData</p>\n<p>OC -&gt; Go (NSMutableData &amp;&amp; !copy OC-&gt;Go copy &#x3D; falseNSDataNSMutableData)<em>bytes</em>Goslicebytes<br>Go -&gt; OC  OCGobytesOCNSDatanbyteslice.</p>\n<p><em>copycopyNSDatafalse</em></p>\n<hr>\n<p>2020-3-18 <br><a href=\"http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/\"> Dart  Objective-C </a></p>\n<p>DartOCGoMobile</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Golanggomobile bind -target&#x3D;ios xxx framework</p>\n</blockquote>\n<p>GolangOCGoOCGolang</p>\n<p>Gobind</p>","more":"<p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package g_mb_test</span><br><span class=\"line\"></span><br><span class=\"line\">type GMBInterface interface &#123;</span><br><span class=\"line\">\tInterfaceTest()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type GMBTest struct &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestOne(value int32) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestSecond(data []byte, str string) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest3() string &#123;</span><br><span class=\"line\">    return </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest4() []byte &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest5() GMBInterface &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest6() *GMBTest &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest7(i GMBInterface) &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>Go OC</li>\n<li>OCGolang</li>\n<li>OCGolangNSData -&gt; []byte, NSString -&gt; string, interface(OC) -&gt; interface</li>\n<li>OCGolang GolangOC</li>\n<li>Golang[]byte -&gt; NSData, string -&gt; NSString, interface -&gt; interface(OC)?</li>\n<li>Golang </li>\n</ol>\n<p>GolangCGolangC(cgo)OCCOCCOCGolang C</p>\n<p><code>gomobile bind -target=ios/amd64 -work Caio/g_mb_test</code></p>\n<p>go-buildxxxsrcgomobile<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (instancetype)init &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123;</span><br><span class=\"line\">        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>new_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego</p>\n<p>iOS frameworknew_g_mb_test_GMBTest()frameworkGo</p>\n<p> new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GoSeqRef *go_seq_from_refnum(int32_t refnum) &#123;</span><br><span class=\"line\">  if (refnum == NULL_REFNUM) &#123;</span><br><span class=\"line\">    return nil;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  if (IS_FROM_GO(refnum)) &#123;</span><br><span class=\"line\">    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>GoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj</p>\n<p>int32<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*go_g_mb_testmain.go*</span><br><span class=\"line\">//export new_g_mb_test_GMBTest</span><br><span class=\"line\">func new_g_mb_test_GMBTest() C.int32_t &#123;</span><br><span class=\"line\">    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org&#x2F;x&#x2F;mobile&#x2F;bind&#x2F;seq&#x2F;ref.go bindgo struct</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*golang.org/x/mobile/bind/seq/ref.go*</span><br><span class=\"line\">// ToRefNum increments the reference count for an object and</span><br><span class=\"line\">// returns its refnum.</span><br><span class=\"line\">func ToRefNum(obj interface&#123;&#125;) int32 &#123;</span><br><span class=\"line\">    // We dont track foreign objects, so if obj is a proxy</span><br><span class=\"line\">    // return its refnum.</span><br><span class=\"line\">    if r, ok := obj.(proxy); ok &#123;</span><br><span class=\"line\">        refnum := r.Bind_proxy_refnum__()</span><br><span class=\"line\">        if refnum &lt;= 0 &#123;</span><br><span class=\"line\">            panic(fmt.Errorf(&quot;seq: proxy contained invalid Go refnum: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return refnum</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    num := refs.refs[obj]</span><br><span class=\"line\">    if num != 0 &#123;</span><br><span class=\"line\">        s := refs.objs[num]</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;s.obj, s.cnt + 1&#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        num = refs.next</span><br><span class=\"line\">        refs.next--</span><br><span class=\"line\">        if refs.next &gt; 0 &#123;</span><br><span class=\"line\">            panic(refs.next underflow)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        refs.refs[obj] = num</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;obj, 1&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">    return int32(num)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>proxyrefs</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// refs stores Go objects that have been passed to another language.</span><br><span class=\"line\">var refs struct &#123;</span><br><span class=\"line\">    sync.Mutex</span><br><span class=\"line\">    next int32 // next reference number to use for Go object, always negative</span><br><span class=\"line\">    refs map[interface&#123;&#125;]int32</span><br><span class=\"line\">    objs map[int32]countedObj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>refsGolang</p>\n<p>maprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum</p>\n<p>refobjnumnext-1refnummap</p>\n<p><strong></strong></p>\n<ol>\n<li>GoGo</li>\n<li>Gorefnum</li>\n<li>+1</li>\n<li>Gorefnum</li>\n</ol>\n<p><em></em><br> Go oc :</p>\n<p>OCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo</p>\n<h4 id=\"OC\"><a href=\"#OC\" class=\"headerlink\" title=\"OC\"></a>OC</h4><p>Golang gmbTestOne </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTestOne:(int32_t)value &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _value = (int32_t)value;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>go_seq_go_to_refnum()Seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (int32_t)incNum &#123;</span><br><span class=\"line\">  IncGoRef(_refnum);</span><br><span class=\"line\">  return _refnum;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_refnumIncGoRef(_refnum);<br>ref.goGo<br><em></em>OC ARCint32_t refnum int</p>\n<p>proxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue</p>\n<p> refnumGoGo<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTestOne</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    _param_value := int32(param_value)</span><br><span class=\"line\">    v.GMBTestOne(_param_value)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// FromRefNum returns the Ref for a refnum. If the refnum specifies a</span><br><span class=\"line\">// foreign object, a finalizer is set to track its lifetime.</span><br><span class=\"line\">func FromRefNum(num int32) *Ref &#123;</span><br><span class=\"line\">    if num == NullRefNum &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ref := &amp;Ref&#123;num&#125;</span><br><span class=\"line\">    if num &gt; 0 &#123;</span><br><span class=\"line\">        // This is a foreign object reference.</span><br><span class=\"line\">        // Track its lifetime with a finalizer.</span><br><span class=\"line\">        runtime.SetFinalizer(ref, FinalizeRef)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    return ref</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>OCGoRefrefnum<br>num &gt; 0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Get returns the underlying object.</span><br><span class=\"line\">func (r *Ref) Get() interface&#123;&#125; &#123;</span><br><span class=\"line\">    refnum := r.Bind_Num</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    o, ok := refs.objs[refnum]</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\">    if !ok &#123;</span><br><span class=\"line\">        panic(fmt.Sprintf(unknown ref %d, refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // This is a Go reference and its refnum was incremented</span><br><span class=\"line\">    // before crossing the language barrier.</span><br><span class=\"line\">    Delete(refnum)</span><br><span class=\"line\">    return o.obj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Delete-10map</p>\n<p><em></em>GolangGolang v :&#x3D; ref.Get().(*g_mb_test.GMBTest) GolangGolang</p>\n<p>Goint</p>\n<p><strong></strong><br>OCGolangOCself.ref  refnumGoGorefnumGolang</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>GolangGoGoGoGoOCNSDataNSString</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (G_mb_testGMBTest*)gmbTest6 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);</span><br><span class=\"line\">    G_mb_testGMBTest* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest6()intGolang</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest6</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    res_0 := v.GMBTest6()</span><br><span class=\"line\">    var _res_0 C.int32_t = _seq.NullRefNum</span><br><span class=\"line\">    if res_0 != nil &#123;</span><br><span class=\"line\">        _res_0 = C.int32_t(_seq.ToRefNum(res_0))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _res_0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>res_0nil_seq.NullRefNum &#x3D; 41null<br>OCgo_seq_from_refnum()41</p>\n<p><strong></strong><br>GorefnumOCGoSeqRefGo</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (id&lt;G_mb_testGMBInterface&gt;)gmbTest5 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);</span><br><span class=\"line\">    G_mb_testGMBInterface* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@implementation G_mb_testGMBInterface &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (instancetype)initWithRef:(id)ref &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123; __ref = ref; &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (void)interfaceTest &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<p>g_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo</p>\n<p><strong></strong><br>GoOCrefnumGoSeqRefGoSeqRefGo</p>\n<p>GoNSDataNSStringOCGo</p>\n<h4 id=\"OCGo\"><a href=\"#OCGo\" class=\"headerlink\" title=\"OCGo\"></a>OCGo</h4><p></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTest7:(id&lt;G_mb_testGMBInterface&gt;)i &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _i;</span><br><span class=\"line\">    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) &#123;</span><br><span class=\"line\">        id&lt;goSeqRefInterface&gt; i_proxy = (id&lt;goSeqRefInterface&gt;)(i);</span><br><span class=\"line\">        _i = go_seq_go_to_refnum(i_proxy._ref);</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        _i = go_seq_to_refnum(i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>goSeqRefInterfaceGoGoSeqRef)<br>Go<br>GoOC newgo_seq_to_refnum()</p>\n<p>tracker<br>OCGorefsOCGo<br>GoOCGoGorefnumOC</p>\n<p>proxyg_mb_test_GMBTest_GMBTest7()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest7</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    var _param_i g_mb_test.GMBInterface</span><br><span class=\"line\">    _param_i_ref := _seq.FromRefNum(int32(param_i))</span><br><span class=\"line\">    if _param_i_ref != nil &#123;</span><br><span class=\"line\">        if param_i &lt; 0 &#123; // go object</span><br><span class=\"line\">            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)</span><br><span class=\"line\">        &#125; else &#123; // foreign object</span><br><span class=\"line\">            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v.GMBTest7(_param_i)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface</p>\n<p>proxyg_mb_test_GMBInterface </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type proxyg_mb_test_GMBInterface _seq.Ref</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 &#123; return (*_seq.Ref)(p).Bind_IncNum() &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) InterfaceTest() &#123;</span><br><span class=\"line\">    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br>Bind_proxy_refnum__()RefBind_IncNum(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func init() &#123;</span><br><span class=\"line\">    _seq.FinalizeRef = func(ref *_seq.Ref) &#123;</span><br><span class=\"line\">        refnum := ref.Bind_Num</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(not a foreign ref: %d, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_dec_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    _seq.IncForeignRef = func(refnum int32) &#123;</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(&quot;not a foreign ref: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_inc_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>seqBind_IncNum()_seq.IncForeignRef()<br>C.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void go_seq_dec_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker dec:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void go_seq_inc_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker inc:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>seq_darwin.m</p>\n<p>FromRefNumGoRef<br>GoRefGoRef </p>\n<p>InterfaceTest()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) &#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);</span><br><span class=\"line\">        [o interfaceTest];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];<br>OC</p>\n<p><strong></strong><br>OCGoGoGoOC+11GoGoRef -1<br>GoGoRefOCOCOCOC-1Go</p>\n<p>go_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>GoCOCOC</li>\n<li>GoOCint32(refnum)refnum&gt;0OC&lt;0Go</li>\n<li>GoOCrefnumGoRef structGoSeqRef class</li>\n<li>GoOC</li>\n<li>OCGorefnum</li>\n<li>OCGoGoCrefnumGoGo</li>\n<li>GoOCC.mrefnumOCOC</li>\n<li>OCGoGoSeqRefrefnumGo</li>\n<li>GoOCC.mGoRefOCrefnum.mOC</li>\n<li>GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1</li>\n<li>OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1</li>\n<li>GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1</li>\n<li>OCGoGoBind_IncNum()+1OCrefnumoc obj -1</li>\n</ol>\n<p></p>\n<p>&#x2F;&#x2F;</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> NSString  NSDataGo &lt;&gt; OC gomobile </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct nstring &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nstring;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct nbyteslice &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nbyteslice;</span><br><span class=\"line\">typedef int nint;</span><br></pre></td></tr></table></figure>\n<p>Cstruct</p>\n<h3 id=\"String\"><a href=\"#String\" class=\"headerlink\" title=\"String\"></a>String</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// encodeString copies a Go string and returns it as a nstring.</span><br><span class=\"line\">func encodeString(s string) C.nstring &#123;</span><br><span class=\"line\">    n := C.int(len(s))</span><br><span class=\"line\">    if n == 0 &#123;</span><br><span class=\"line\">        return C.nstring&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">    if ptr == nil &#123;</span><br><span class=\"line\">        panic(&quot;encodeString: malloc failed&quot;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    copy((*[1&lt;&lt;31 - 1]byte)(ptr)[:n], s)</span><br><span class=\"line\">    return C.nstring&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// decodeString converts a nstring to a Go string. The</span><br><span class=\"line\">// data in str is freed after use.</span><br><span class=\"line\">func decodeString(str C.nstring) string &#123;</span><br><span class=\"line\">    if str.ptr == nil &#123;</span><br><span class=\"line\">        return &quot;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    s := C.GoStringN((*C.char)(str.ptr), str.len)</span><br><span class=\"line\">    C.free(str.ptr)</span><br><span class=\"line\">    return s</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  string encodedecodecstringgo string<em>copy</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSString *go_seq_to_objc_string(nstring str) &#123;</span><br><span class=\"line\">  if (str.len == 0) &#123;  // empty string.</span><br><span class=\"line\">    return @;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr</span><br><span class=\"line\">                                                  length:str.len</span><br><span class=\"line\">                                                encoding:NSUTF8StringEncoding</span><br><span class=\"line\">                                            freeWhenDone:YES];</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nstring go_seq_from_objc_string(NSString *s) &#123;</span><br><span class=\"line\">  nstring res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];</span><br><span class=\"line\"></span><br><span class=\"line\">  if (len == 0) &#123;</span><br><span class=\"line\">    if (s.length &gt; 0) &#123;</span><br><span class=\"line\">      LOG_INFO(@unable to encode an NSString into UTF-8);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  char *buf = (char *)malloc(len);</span><br><span class=\"line\">  if (buf == NULL) &#123;</span><br><span class=\"line\">    LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSUInteger used;</span><br><span class=\"line\">  [s getBytes:buf</span><br><span class=\"line\">           maxLength:len</span><br><span class=\"line\">          usedLength:&amp;used</span><br><span class=\"line\">            encoding:NSUTF8StringEncoding</span><br><span class=\"line\">             options:0</span><br><span class=\"line\">               range:NSMakeRange(0, [s length])</span><br><span class=\"line\">      remainingRange:NULL];</span><br><span class=\"line\">  res.ptr = buf;</span><br><span class=\"line\">  res.len = used;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>OC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring<em>copy</em></p>\n<p>cstring</p>\n<h3 id=\"Bytes\"><a href=\"#Bytes\" class=\"headerlink\" title=\"Bytes\"></a>Bytes</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">// fromSlice converts a slice to a nbyteslice.</span><br><span class=\"line\">// If cpy is set, a malloced copy of the data is returned.</span><br><span class=\"line\">func fromSlice(s []byte, cpy bool) C.nbyteslice &#123;</span><br><span class=\"line\">    if s == nil || len(s) == 0 &#123;</span><br><span class=\"line\">        return C.nbyteslice&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr, n := unsafe.Pointer(&amp;s[0]), C.int(len(s))</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        nptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">        if nptr == nil &#123;</span><br><span class=\"line\">            panic(&quot;fromSlice: malloc failed&quot;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        copy((*[1&lt;&lt;31 - 1]byte)(nptr)[:n], (*[1&lt;&lt;31 - 1]byte)(ptr)[:n])</span><br><span class=\"line\">        ptr = nptr</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return C.nbyteslice&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is</span><br><span class=\"line\">// set, the slice contains a copy of the data. If not, the generated Go code</span><br><span class=\"line\">// calls releaseByteSlice after use.</span><br><span class=\"line\">func toSlice(s C.nbyteslice, cpy bool) []byte &#123;</span><br><span class=\"line\">    if s.ptr == nil || s.len == 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var b []byte</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        b = C.GoBytes(s.ptr, C.int(s.len))</span><br><span class=\"line\">        C.free(s.ptr)</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        b = (*[1&lt;&lt;31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return b</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  nbyteslice fromSlicetoSlicenbyteslicego slice</p>\n<p>OC -&gt; Go OCcopy &#x3D;&#x3D; trueGonbyteslice<br>Go -&gt; OC  (copy go-&gt;OC copy&#x3D;true)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) &#123;</span><br><span class=\"line\">  if (s.ptr == NULL) &#123;</span><br><span class=\"line\">    return NULL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  BOOL freeWhenDone = copy ? YES : NO;</span><br><span class=\"line\">  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) &#123;</span><br><span class=\"line\">  struct nbyteslice res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int sz = data.length;</span><br><span class=\"line\">  if (sz == 0) &#123;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  // If the argument was not a NSMutableData, copy the data so that</span><br><span class=\"line\">  // the NSData is not changed from Go. The corresponding free is called</span><br><span class=\"line\">  // by releaseByteSlice.</span><br><span class=\"line\">  if (copy || ![data isKindOfClass:[NSMutableData class]]) &#123;</span><br><span class=\"line\">    void *arr_copy = malloc(sz);</span><br><span class=\"line\">    if (arr_copy == NULL) &#123;</span><br><span class=\"line\">      LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    memcpy(arr_copy, [data bytes], sz);</span><br><span class=\"line\">    ptr = arr_copy;</span><br><span class=\"line\">  &#125; else &#123;</span><br><span class=\"line\">    ptr = (void *)[data bytes];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  res.ptr = ptr;</span><br><span class=\"line\">  res.len = sz;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>OC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData</p>\n<p>OC -&gt; Go (NSMutableData &amp;&amp; !copy OC-&gt;Go copy &#x3D; falseNSDataNSMutableData)<em>bytes</em>Goslicebytes<br>Go -&gt; OC  OCGobytesOCNSDatanbyteslice.</p>\n<p><em>copycopyNSDatafalse</em></p>\n<hr>\n<p>2020-3-18 <br><a href=\"http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/\"> Dart  Objective-C </a></p>\n<p>DartOCGoMobile</p>"},{"title":"SQLite--OS","date":"2020-04-18T16:00:00.000Z","_content":"\n>sqlitesqlite :)\n\n<!-- more -->\n\n## \n\nSqliteOS-Interface(os)\n\nOSOS`sqlite3Os`/sqlite`Util``sqlite3OsSleep``sqlite3OsCurrentTimeInt64``os.h`\n\nOS[](https://caio.ink/sqlite-os-shm/)OS  SQLite\n\n> iOSWCDB\n\n## \n\nosvfsvirtual file systemsqlitecacheextension...vfs\n\nsqlite`sqlite3_os_init()`mallocvfs\n\n\n```c\nint sqlite3_os_init(void);\n```\n\n> sqliteunix\n\n## \n\n### \n\nSqliteOS*sqlite3_file**sqlite3_file*vfsvfs*unixFile*Unixvfs\n\n*unixFile**UnixFile**sqlite3_file* file\n\n### inode\n\nUnixsqlite3fileUnixvfsfile node\n\ninode\n\n*unixInodeInfo*unix*unixFile**unixInodeInfo**unixInodeInfo*nRef(*unixFile*)nRef++nRef--Sqlite*unixInodeInfo*`UnixUnusedFd`nRef0Sqlite\n\n\n```c\n/*\n * UNIX,InodeInfoUnixFile\n */\nstruct unixInodeInfo {\n  struct unixFileId fileId;       /* The lookup key */\n  sqlite3_mutex *pLockMutex;      /* Hold this mutex for... */\n  int nShared;                      /* Number of SHARED locks held */\n  int nLock;                        /* Number of outstanding file locks */\n  unsigned char eFileLock;          /* One of SHARED_LOCK, RESERVED_LOCK etc. */\n  unsigned char bProcessLock;       /* An exclusive process lock is held */\n  UnixUnusedFd *pUnused;            /* Unused file descriptors to close */\n  int nRef;                       /* Number of pointers to this structure */\n  unixShmNode *pShmNode;          /* Shared memory associated with this inode */\n  unixInodeInfo *pNext;           /* List of all unixInodeInfo objects */\n  unixInodeInfo *pPrev;           /*    .... doubly linked */\n};\n```\n\nSqlite `static unixInodeInfo *inodeList = 0;` \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png)\n\n## \n\nPOSIXPOSIX\n\n\n> ABAB\n\n\n\n> \n\n1. Sqlite Sqlite\n2. \n\n### Sqlite \n\nSqlite5`UNLOCKED`,`SHARED`,`RESERVED`,`PENDING`,`EXCLUSIVE`5*inode*eFileLock\n\n- UNLOCKED:\n- SHARED:SHARED\n- RESERVED:\n- PENDING:\n- EXCLUSIVE:\n\nos5os4PENDINGos\n\nSqlite\n\n### \n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png)\n\n\n\n:SharedShared->ReservedShared->Reserved->Pending Shared->PendingShared->Reserved->Pending->ExclusiveShared->Pending->Exclusive\n\n- 1GB:\n\tWindowspagepage[512,32768]page512 bytes\n\t\n- SharedBytes:\n\tWin95/98/MEshared bytesqlite510510\n\t\n- fileinodeunixInodeInfo\n\n### \n\n```c\n//os.h 4\nint sqlite3OsLock(sqlite3_file*, int);\n```\n\n\n- UNLOCKED -> SHARED\n\t  \n\t\n\tInodeInfonSharednLock\n\t1. pending byte\n\t2. SHARED_BYTES\n\t3. pending byte\n\t\n- SHARED -> RESERVED\n\t\n\t1. \n\t\n- SHARED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. InodeInfoPendingpending\n\t2. InodeInfonShared>1SQLITE_BUSYInodeInfounixFilePendingPending\n\t3. SHARED_BYTES\n\t\n- RESERVED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. \n\t\n- PENDING -> EXCLUSIVE\n\t\n\t1.  *SHARED -> (PENDING) -> EXCLUSIVE* 3\n\n\n1. unlockedshared\n2. SqlitependingPending\n3. SQLITE_BUSY:\n\t\n\ta. Inode  >= pendingpendingshared\n\tb. Inode  < pending > shared\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png)\n\n>OSPENDING->EXCLUSIVEPENDING*unixFile*Pending\n\n### \n\n```c\n// \nint sqlite3OsUnlock(sqlite3_file*, int);\n```\n\n SHARE_LOCK  NO_LOCK...\n\n\n\n- \n\t1. pending + reserved + shared_size  UNLOCK\n\t2. Inode nShared--  nLock--\n\t\n- \n\n\tpending+reservedUNLOCKshared_sizeBSD NFSbug\n\t\n\tSqlite(shared_size - 1)bytesbytesbyte\n","source":"_posts/15.Sqlite-OS.md","raw":"---\ntitle: SQLite--OS\ndate: 2020-04-19\ntags: [sqlite3,os]\ncategories: sqlite3\n---\n\n>sqlitesqlite :)\n\n<!-- more -->\n\n## \n\nSqliteOS-Interface(os)\n\nOSOS`sqlite3Os`/sqlite`Util``sqlite3OsSleep``sqlite3OsCurrentTimeInt64``os.h`\n\nOS[](https://caio.ink/sqlite-os-shm/)OS  SQLite\n\n> iOSWCDB\n\n## \n\nosvfsvirtual file systemsqlitecacheextension...vfs\n\nsqlite`sqlite3_os_init()`mallocvfs\n\n\n```c\nint sqlite3_os_init(void);\n```\n\n> sqliteunix\n\n## \n\n### \n\nSqliteOS*sqlite3_file**sqlite3_file*vfsvfs*unixFile*Unixvfs\n\n*unixFile**UnixFile**sqlite3_file* file\n\n### inode\n\nUnixsqlite3fileUnixvfsfile node\n\ninode\n\n*unixInodeInfo*unix*unixFile**unixInodeInfo**unixInodeInfo*nRef(*unixFile*)nRef++nRef--Sqlite*unixInodeInfo*`UnixUnusedFd`nRef0Sqlite\n\n\n```c\n/*\n * UNIX,InodeInfoUnixFile\n */\nstruct unixInodeInfo {\n  struct unixFileId fileId;       /* The lookup key */\n  sqlite3_mutex *pLockMutex;      /* Hold this mutex for... */\n  int nShared;                      /* Number of SHARED locks held */\n  int nLock;                        /* Number of outstanding file locks */\n  unsigned char eFileLock;          /* One of SHARED_LOCK, RESERVED_LOCK etc. */\n  unsigned char bProcessLock;       /* An exclusive process lock is held */\n  UnixUnusedFd *pUnused;            /* Unused file descriptors to close */\n  int nRef;                       /* Number of pointers to this structure */\n  unixShmNode *pShmNode;          /* Shared memory associated with this inode */\n  unixInodeInfo *pNext;           /* List of all unixInodeInfo objects */\n  unixInodeInfo *pPrev;           /*    .... doubly linked */\n};\n```\n\nSqlite `static unixInodeInfo *inodeList = 0;` \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png)\n\n## \n\nPOSIXPOSIX\n\n\n> ABAB\n\n\n\n> \n\n1. Sqlite Sqlite\n2. \n\n### Sqlite \n\nSqlite5`UNLOCKED`,`SHARED`,`RESERVED`,`PENDING`,`EXCLUSIVE`5*inode*eFileLock\n\n- UNLOCKED:\n- SHARED:SHARED\n- RESERVED:\n- PENDING:\n- EXCLUSIVE:\n\nos5os4PENDINGos\n\nSqlite\n\n### \n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png)\n\n\n\n:SharedShared->ReservedShared->Reserved->Pending Shared->PendingShared->Reserved->Pending->ExclusiveShared->Pending->Exclusive\n\n- 1GB:\n\tWindowspagepage[512,32768]page512 bytes\n\t\n- SharedBytes:\n\tWin95/98/MEshared bytesqlite510510\n\t\n- fileinodeunixInodeInfo\n\n### \n\n```c\n//os.h 4\nint sqlite3OsLock(sqlite3_file*, int);\n```\n\n\n- UNLOCKED -> SHARED\n\t  \n\t\n\tInodeInfonSharednLock\n\t1. pending byte\n\t2. SHARED_BYTES\n\t3. pending byte\n\t\n- SHARED -> RESERVED\n\t\n\t1. \n\t\n- SHARED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. InodeInfoPendingpending\n\t2. InodeInfonShared>1SQLITE_BUSYInodeInfounixFilePendingPending\n\t3. SHARED_BYTES\n\t\n- RESERVED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. \n\t\n- PENDING -> EXCLUSIVE\n\t\n\t1.  *SHARED -> (PENDING) -> EXCLUSIVE* 3\n\n\n1. unlockedshared\n2. SqlitependingPending\n3. SQLITE_BUSY:\n\t\n\ta. Inode  >= pendingpendingshared\n\tb. Inode  < pending > shared\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png)\n\n>OSPENDING->EXCLUSIVEPENDING*unixFile*Pending\n\n### \n\n```c\n// \nint sqlite3OsUnlock(sqlite3_file*, int);\n```\n\n SHARE_LOCK  NO_LOCK...\n\n\n\n- \n\t1. pending + reserved + shared_size  UNLOCK\n\t2. Inode nShared--  nLock--\n\t\n- \n\n\tpending+reservedUNLOCKshared_sizeBSD NFSbug\n\t\n\tSqlite(shared_size - 1)bytesbytesbyte\n","slug":"15.Sqlite-OS","published":1,"updated":"2020-08-29T14:42:58.497Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc619000eelc9b4jmfk82","content":"<blockquote>\n<p>sqlitesqlite :)</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SqliteOS-Interface(os)</p>\n<p>OSOS<code>sqlite3Os</code>&#x2F;sqlite<code>Util</code><code>sqlite3OsSleep</code><code>sqlite3OsCurrentTimeInt64</code><code>os.h</code></p>\n<p>OS<a href=\"https://caio.ink/sqlite-os-shm/\"></a>OS  SQLite</p>\n<blockquote>\n<p>iOSWCDB</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>osvfsvirtual file systemsqlitecacheextensionvfs</p>\n<p>sqlite<code>sqlite3_os_init()</code>mallocvfs</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3_os_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>sqliteunix</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SqliteOS<em>sqlite3_file</em><em>sqlite3_file</em>vfsvfs<em>unixFile</em>Unixvfs</p>\n<p><em>unixFile</em><em>UnixFile</em><em>sqlite3_file</em> file</p>\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><p>Unixsqlite3fileUnixvfsfile node</p>\n<p>inode</p>\n<p><em>unixInodeInfo</em>unix<em>unixFile</em><em>unixInodeInfo</em><em>unixInodeInfo</em>nRef(<em>unixFile</em>)nRef++nRefSqlite<em>unixInodeInfo</em><code>UnixUnusedFd</code>nRef0Sqlite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * UNIX,InodeInfoUnixFile</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixInodeInfo</span> &#123;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixFileId</span> <span class=\"title\">fileId</span>;</span>       <span class=\"comment\">/* The lookup key */</span></span><br><span class=\"line\">  sqlite3_mutex *pLockMutex;      <span class=\"comment\">/* Hold this mutex for... */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nShared;                      <span class=\"comment\">/* Number of SHARED locks held */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nLock;                        <span class=\"comment\">/* Number of outstanding file locks */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> eFileLock;          <span class=\"comment\">/* One of SHARED_LOCK, RESERVED_LOCK etc. */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> bProcessLock;       <span class=\"comment\">/* An exclusive process lock is held */</span></span><br><span class=\"line\">  UnixUnusedFd *pUnused;            <span class=\"comment\">/* Unused file descriptors to close */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                       <span class=\"comment\">/* Number of pointers to this structure */</span></span><br><span class=\"line\">  unixShmNode *pShmNode;          <span class=\"comment\">/* Shared memory associated with this inode */</span></span><br><span class=\"line\">  unixInodeInfo *pNext;           <span class=\"comment\">/* List of all unixInodeInfo objects */</span></span><br><span class=\"line\">  unixInodeInfo *pPrev;           <span class=\"comment\">/*    .... doubly linked */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite <code>static unixInodeInfo *inodeList = 0;</code> </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>POSIXPOSIX<br></p>\n<blockquote>\n<p>ABAB</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<ol>\n<li>Sqlite Sqlite</li>\n<li></li>\n</ol>\n<h3 id=\"Sqlite-\"><a href=\"#Sqlite-\" class=\"headerlink\" title=\"Sqlite \"></a>Sqlite </h3><p>Sqlite5<code>UNLOCKED</code>,<code>SHARED</code>,<code>RESERVED</code>,<code>PENDING</code>,<code>EXCLUSIVE</code>5<em>inode</em>eFileLock</p>\n<ul>\n<li>UNLOCKED:</li>\n<li>SHARED:SHARED</li>\n<li>RESERVED:</li>\n<li>PENDING:</li>\n<li>EXCLUSIVE:</li>\n</ul>\n<p>os5os4PENDINGos</p>\n<p>Sqlite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png\"></p>\n<p></p>\n<p>:SharedShared-&gt;ReservedShared-&gt;Reserved-&gt;Pending Shared-&gt;PendingShared-&gt;Reserved-&gt;Pending-&gt;ExclusiveShared-&gt;Pending-&gt;Exclusive</p>\n<ul>\n<li><p>1GB:<br>  Windowspagepage[512,32768]page512 bytes</p>\n</li>\n<li><p>SharedBytes:<br>  Win95&#x2F;98&#x2F;MEshared bytesqlite510510</p>\n</li>\n<li><p>fileinodeunixInodeInfo</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//os.h 4</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsLock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p>UNLOCKED -&gt; SHARED<br>    </p>\n<p>  InodeInfonSharednLock</p>\n<ol>\n<li>pending byte</li>\n<li>SHARED_BYTES</li>\n<li>pending byte</li>\n</ol>\n</li>\n<li><p>SHARED -&gt; RESERVED<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li>InodeInfoPendingpending</li>\n<li>InodeInfonShared&gt;1SQLITE_BUSYInodeInfounixFilePendingPending</li>\n<li>SHARED_BYTES</li>\n</ol>\n</li>\n<li><p>RESERVED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>PENDING -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li> <em>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE</em> 3</li>\n</ol>\n</li>\n</ul>\n<p></p>\n<ol>\n<li>unlockedshared</li>\n<li>SqlitependingPending</li>\n<li>SQLITE_BUSY:<br> <br> a. Inode  &gt;&#x3D; pendingpendingshared<br> b. Inode  &lt; pending &gt; shared</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png\"></p>\n<blockquote>\n<p>OSPENDING-&gt;EXCLUSIVEPENDING<em>unixFile</em>Pending</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsUnlock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p> SHARE_LOCK  NO_LOCK</p>\n<p></p>\n<ul>\n<li><p></p>\n<ol>\n<li>pending + reserved + shared_size  UNLOCK</li>\n<li>Inode nShared  nLock</li>\n</ol>\n</li>\n<li><p></p>\n<p>  pending+reservedUNLOCKshared_sizeBSD NFSbug</p>\n<p>  Sqlite(shared_size - 1)bytesbytesbyte</p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>sqlitesqlite :)</p>\n</blockquote>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SqliteOS-Interface(os)</p>\n<p>OSOS<code>sqlite3Os</code>&#x2F;sqlite<code>Util</code><code>sqlite3OsSleep</code><code>sqlite3OsCurrentTimeInt64</code><code>os.h</code></p>\n<p>OS<a href=\"https://caio.ink/sqlite-os-shm/\"></a>OS  SQLite</p>\n<blockquote>\n<p>iOSWCDB</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>osvfsvirtual file systemsqlitecacheextensionvfs</p>\n<p>sqlite<code>sqlite3_os_init()</code>mallocvfs</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3_os_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>sqliteunix</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SqliteOS<em>sqlite3_file</em><em>sqlite3_file</em>vfsvfs<em>unixFile</em>Unixvfs</p>\n<p><em>unixFile</em><em>UnixFile</em><em>sqlite3_file</em> file</p>\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><p>Unixsqlite3fileUnixvfsfile node</p>\n<p>inode</p>\n<p><em>unixInodeInfo</em>unix<em>unixFile</em><em>unixInodeInfo</em><em>unixInodeInfo</em>nRef(<em>unixFile</em>)nRef++nRefSqlite<em>unixInodeInfo</em><code>UnixUnusedFd</code>nRef0Sqlite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * UNIX,InodeInfoUnixFile</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixInodeInfo</span> &#123;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixFileId</span> <span class=\"title\">fileId</span>;</span>       <span class=\"comment\">/* The lookup key */</span></span><br><span class=\"line\">  sqlite3_mutex *pLockMutex;      <span class=\"comment\">/* Hold this mutex for... */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nShared;                      <span class=\"comment\">/* Number of SHARED locks held */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nLock;                        <span class=\"comment\">/* Number of outstanding file locks */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> eFileLock;          <span class=\"comment\">/* One of SHARED_LOCK, RESERVED_LOCK etc. */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> bProcessLock;       <span class=\"comment\">/* An exclusive process lock is held */</span></span><br><span class=\"line\">  UnixUnusedFd *pUnused;            <span class=\"comment\">/* Unused file descriptors to close */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                       <span class=\"comment\">/* Number of pointers to this structure */</span></span><br><span class=\"line\">  unixShmNode *pShmNode;          <span class=\"comment\">/* Shared memory associated with this inode */</span></span><br><span class=\"line\">  unixInodeInfo *pNext;           <span class=\"comment\">/* List of all unixInodeInfo objects */</span></span><br><span class=\"line\">  unixInodeInfo *pPrev;           <span class=\"comment\">/*    .... doubly linked */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite <code>static unixInodeInfo *inodeList = 0;</code> </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>POSIXPOSIX<br></p>\n<blockquote>\n<p>ABAB</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<ol>\n<li>Sqlite Sqlite</li>\n<li></li>\n</ol>\n<h3 id=\"Sqlite-\"><a href=\"#Sqlite-\" class=\"headerlink\" title=\"Sqlite \"></a>Sqlite </h3><p>Sqlite5<code>UNLOCKED</code>,<code>SHARED</code>,<code>RESERVED</code>,<code>PENDING</code>,<code>EXCLUSIVE</code>5<em>inode</em>eFileLock</p>\n<ul>\n<li>UNLOCKED:</li>\n<li>SHARED:SHARED</li>\n<li>RESERVED:</li>\n<li>PENDING:</li>\n<li>EXCLUSIVE:</li>\n</ul>\n<p>os5os4PENDINGos</p>\n<p>Sqlite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png\"></p>\n<p></p>\n<p>:SharedShared-&gt;ReservedShared-&gt;Reserved-&gt;Pending Shared-&gt;PendingShared-&gt;Reserved-&gt;Pending-&gt;ExclusiveShared-&gt;Pending-&gt;Exclusive</p>\n<ul>\n<li><p>1GB:<br>  Windowspagepage[512,32768]page512 bytes</p>\n</li>\n<li><p>SharedBytes:<br>  Win95&#x2F;98&#x2F;MEshared bytesqlite510510</p>\n</li>\n<li><p>fileinodeunixInodeInfo</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//os.h 4</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsLock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p>UNLOCKED -&gt; SHARED<br>    </p>\n<p>  InodeInfonSharednLock</p>\n<ol>\n<li>pending byte</li>\n<li>SHARED_BYTES</li>\n<li>pending byte</li>\n</ol>\n</li>\n<li><p>SHARED -&gt; RESERVED<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li>InodeInfoPendingpending</li>\n<li>InodeInfonShared&gt;1SQLITE_BUSYInodeInfounixFilePendingPending</li>\n<li>SHARED_BYTES</li>\n</ol>\n</li>\n<li><p>RESERVED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>PENDING -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li> <em>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE</em> 3</li>\n</ol>\n</li>\n</ul>\n<p></p>\n<ol>\n<li>unlockedshared</li>\n<li>SqlitependingPending</li>\n<li>SQLITE_BUSY:<br> <br> a. Inode  &gt;&#x3D; pendingpendingshared<br> b. Inode  &lt; pending &gt; shared</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png\"></p>\n<blockquote>\n<p>OSPENDING-&gt;EXCLUSIVEPENDING<em>unixFile</em>Pending</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsUnlock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p> SHARE_LOCK  NO_LOCK</p>\n<p></p>\n<ul>\n<li><p></p>\n<ol>\n<li>pending + reserved + shared_size  UNLOCK</li>\n<li>Inode nShared  nLock</li>\n</ol>\n</li>\n<li><p></p>\n<p>  pending+reservedUNLOCKshared_sizeBSD NFSbug</p>\n<p>  Sqlite(shared_size - 1)bytesbytesbyte</p>\n</li>\n</ul>"},{"title":"SQLite","date":"2020-06-11T16:00:00.000Z","_content":"\n> source: inside-sqlite\n\n<!-- more -->\n\n## SQLite \n\nSQLiteVMVMSQLiteVMSQLiteVMVMB+\"\"\n\nVMVM\n\n sqlite3_stmt(Vdbe)\n\nVdbe\n* \n* \n* \n* \n* \n* \n* BTree\n\n### 1 \n\nSQLite<opcode, P1, P2, P3>, opcode P1, P2, P3VMP132P2 31P2P3NullNULL\n\nVMSQLiteSQLiteSQLite\n\n[6-1]() SELECT * FROM t1 t1xy\n\n| Address | Opcode | p1 | p2 | p3 |\n| ---- | ---- | ---- | ---- | ---- |\n| 0 | Goto | 0 | 11 |  |\n| 1 | Integer | 0 | 0 |  |\n| 2 | OpenRead | 0 | 2 |  |\n| 3 | SetNumColumn | 0 | 2 | #t1 |\n| 4 | Rewind | 0 | 9 |\n| 5 | Column | 0 | 0 | #x |\n| 6 | Column | 0 | 1 | #y |\n| 7 | Callback | 2 | 0 |\n| 8 | Next | 0 | 5 |\n| 9 | Close | 0 | 0 |\n| 10 | Halt | 0 | 0 |\n| 11 | Transaction | 0 | 0 |\n| 12 | VerifyCookie | 0 | 1 |\n| 13 | Goto | 0 | 1 |\n\nVM:\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\nSwitchcase OP_ VMaOppcVM0\n\nVMkeyVM/\n\nVMSELECT\n\nVMrcVM\n\n### 2 \n\nVM(record)B/B+**key******VMkeyB+-treeVMVM\n\ndata/keySQLitebytesSQLite\n\nVMSQLSQLiteSQLiteSQLSQLite\n\n\n\n| Header size | Type 1 | Type 2| ... | Data1 | Data2 |\n| ---- | ---- | ---- | ---- | ---- | ---- |\n\n(row data)Header sizeData164integerData1header sizeType i2^64Data i\n\nVM5SQL NULL123NULL\n\n\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\nNULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\nSQLiteB+-TreekeySQLite\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]\n\nSQLSQL:`create table t1(x, y)`rowidSQLiterowidSQLite`insert into t1(rowid, x, y) values(100, 'hello', 'world')`rowid\n\nSQL\n\n| rowid | x | y |\n| ---- | ---- | ---- |\n| -5 | abc | xyz |\n| 1 | abc | 12345 |\n| 2 | 456 | def |\n| 100 | hello | world |\n| 54321 | NULL | 987|\n\n****\n\nrowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid\n\nrowidkeyrowid9rowidSQLiterowid-5\n\nB+key(key)rowidSQLiterowidB+\n\n\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ----|\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nSQLiteyx\n\nyx\n\n| y | x | rowid |\n| ---- | ----| ---- |\n| 987 | NULL | 54321 |\n| 12345 | abc | 1 |\n| def | 456 | 2 |\n| xyz | abc | -5 |\n| world | hello | 100 |\n\n`SELECT y FROM t1 WHERE x=`SQLite `t1(x)`x=?rowidrowidt1B+y\n\n### 3 \n\nSQLiteVMVMVMVMVM\n\nSQLiteSQL\"\"VMSQLSQLiteINTEGERREALTEXT\n\n#### 3.1.1 \n\nVMSQL:\n\n* TEXT\n* INTEGER\n* REAL\n* NULLNULL\n* X'ABCD'BLOB\n\nsqlite3_bind_ * APISQLsqlite3_bind_blob BLOB\n\nSQLSQLVM\n\n#### 3.1.2 \n\nSQLSQLSQLiteSQLite\"\"\n\n****\n\nSQLiterowidSQLiteSQL`create table T1(a, b, c)`SQLiteSQL\n\nTEXT, NUMERIC, INTEGER, REAL, and NONE\"text,\" \"integer,\"\"real\"`CREATE TABLE`SQLSQLiteSQL:\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE`create table table1 as select ...`SQLSQLNONErowid.\n\n#### 3.1.3 \nVM\n\n1. TEXTNULLTEXTBLOBTEXT\n2. NUMERICNUMERICINTEGERREALTEXTNULLBLOB\n3. INTEGERNUMERICINTEGER\n4. REALNUMERIC-\n5. NONE VM\n\n****\n\nSQLSQLiteSQLINTEGER(\"123\"\"abc\")VM(\"123\")REALINTEGER(\"abc\")TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug\n\n#### 3.1.4 \n\n\n\n`CREATE TABLE T1(a,b,c);`\n`INSERT INTO T1 VALUES(177,NULL,'hello');`\n\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\na,b,cintegerNULLTEXTNONEVM11(header+data)16\n\n1. Header440x04\n2. Type 12.\n3. Type 20.NULL\n4. Type 323.(23-13/2=)5\n5. Data 1200B1,117117B1-79177.\n6. Data 2NULL\n7. Data 3568 65 6C 6F0\n\n`sqlite3_column_*`APISQLiteFLOAT( sqlite3_column_text)VM`sprintf()`VM\n\n****\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER |  0 |\n| NULL | FLOAT |  0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() C |\n| TEXT | FLOAT | atof() C |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | atoi()  |\n| BLOB | FLOAT | atof()  |\n| BLOB | TEXT | \\000 |\n\nVM..\n\n\n#### 3.2.1 NULL\n\nNULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n\n#### 3.2.2 \n\nSQLite\n\n*  =, <, <=, >, >=  !=\n*  IN\n*  BETWEEN\n\n\n1. NULLNULL\n2. INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL\n3. TEXTBLOBTEXTCmemcmp\n4. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXTSQL\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)`=(,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)``INSERT INTO t1 VALUES(500500500)`a,b,cTEXTINTEGERTEXT\n\n* `SELECT a < 60,a < 40 FROM t1`6040\"60\"\"40\"aTEXTTEXT`1|0`\"500\"\"60\"\"40\"\n* `SELECT b < 60,b < 600 FROM t1``0|1`\n* `SELECT c < 60,c < 600 FROM t1`cNONENUMERIC\"500\"(TEXT)`0|0`\n\n#### 3.2.3 \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### 3.2.4 ORDER BY\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### 3.2.5 GROUP BY\nGROUP BYINTEGERREAL\n\n#### 3.2.6 SELECT\nSELECT(UNIONINTERSECTEXCEPT)SELECTSELECT","source":"_posts/17.inside-sqlite-chapter-6.md","raw":"---\ntitle: SQLite\ndate: 2020-06-12\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> source: inside-sqlite\n\n<!-- more -->\n\n## SQLite \n\nSQLiteVMVMSQLiteVMSQLiteVMVMB+\"\"\n\nVMVM\n\n sqlite3_stmt(Vdbe)\n\nVdbe\n* \n* \n* \n* \n* \n* \n* BTree\n\n### 1 \n\nSQLite<opcode, P1, P2, P3>, opcode P1, P2, P3VMP132P2 31P2P3NullNULL\n\nVMSQLiteSQLiteSQLite\n\n[6-1]() SELECT * FROM t1 t1xy\n\n| Address | Opcode | p1 | p2 | p3 |\n| ---- | ---- | ---- | ---- | ---- |\n| 0 | Goto | 0 | 11 |  |\n| 1 | Integer | 0 | 0 |  |\n| 2 | OpenRead | 0 | 2 |  |\n| 3 | SetNumColumn | 0 | 2 | #t1 |\n| 4 | Rewind | 0 | 9 |\n| 5 | Column | 0 | 0 | #x |\n| 6 | Column | 0 | 1 | #y |\n| 7 | Callback | 2 | 0 |\n| 8 | Next | 0 | 5 |\n| 9 | Close | 0 | 0 |\n| 10 | Halt | 0 | 0 |\n| 11 | Transaction | 0 | 0 |\n| 12 | VerifyCookie | 0 | 1 |\n| 13 | Goto | 0 | 1 |\n\nVM:\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\nSwitchcase OP_ VMaOppcVM0\n\nVMkeyVM/\n\nVMSELECT\n\nVMrcVM\n\n### 2 \n\nVM(record)B/B+**key******VMkeyB+-treeVMVM\n\ndata/keySQLitebytesSQLite\n\nVMSQLSQLiteSQLiteSQLSQLite\n\n\n\n| Header size | Type 1 | Type 2| ... | Data1 | Data2 |\n| ---- | ---- | ---- | ---- | ---- | ---- |\n\n(row data)Header sizeData164integerData1header sizeType i2^64Data i\n\nVM5SQL NULL123NULL\n\n\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\nNULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\nSQLiteB+-TreekeySQLite\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]\n\nSQLSQL:`create table t1(x, y)`rowidSQLiterowidSQLite`insert into t1(rowid, x, y) values(100, 'hello', 'world')`rowid\n\nSQL\n\n| rowid | x | y |\n| ---- | ---- | ---- |\n| -5 | abc | xyz |\n| 1 | abc | 12345 |\n| 2 | 456 | def |\n| 100 | hello | world |\n| 54321 | NULL | 987|\n\n****\n\nrowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid\n\nrowidkeyrowid9rowidSQLiterowid-5\n\nB+key(key)rowidSQLiterowidB+\n\n\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ----|\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nSQLiteyx\n\nyx\n\n| y | x | rowid |\n| ---- | ----| ---- |\n| 987 | NULL | 54321 |\n| 12345 | abc | 1 |\n| def | 456 | 2 |\n| xyz | abc | -5 |\n| world | hello | 100 |\n\n`SELECT y FROM t1 WHERE x=`SQLite `t1(x)`x=?rowidrowidt1B+y\n\n### 3 \n\nSQLiteVMVMVMVMVM\n\nSQLiteSQL\"\"VMSQLSQLiteINTEGERREALTEXT\n\n#### 3.1.1 \n\nVMSQL:\n\n* TEXT\n* INTEGER\n* REAL\n* NULLNULL\n* X'ABCD'BLOB\n\nsqlite3_bind_ * APISQLsqlite3_bind_blob BLOB\n\nSQLSQLVM\n\n#### 3.1.2 \n\nSQLSQLSQLiteSQLite\"\"\n\n****\n\nSQLiterowidSQLiteSQL`create table T1(a, b, c)`SQLiteSQL\n\nTEXT, NUMERIC, INTEGER, REAL, and NONE\"text,\" \"integer,\"\"real\"`CREATE TABLE`SQLSQLiteSQL:\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE`create table table1 as select ...`SQLSQLNONErowid.\n\n#### 3.1.3 \nVM\n\n1. TEXTNULLTEXTBLOBTEXT\n2. NUMERICNUMERICINTEGERREALTEXTNULLBLOB\n3. INTEGERNUMERICINTEGER\n4. REALNUMERIC-\n5. NONE VM\n\n****\n\nSQLSQLiteSQLINTEGER(\"123\"\"abc\")VM(\"123\")REALINTEGER(\"abc\")TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug\n\n#### 3.1.4 \n\n\n\n`CREATE TABLE T1(a,b,c);`\n`INSERT INTO T1 VALUES(177,NULL,'hello');`\n\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\na,b,cintegerNULLTEXTNONEVM11(header+data)16\n\n1. Header440x04\n2. Type 12.\n3. Type 20.NULL\n4. Type 323.(23-13/2=)5\n5. Data 1200B1,117117B1-79177.\n6. Data 2NULL\n7. Data 3568 65 6C 6F0\n\n`sqlite3_column_*`APISQLiteFLOAT( sqlite3_column_text)VM`sprintf()`VM\n\n****\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER |  0 |\n| NULL | FLOAT |  0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() C |\n| TEXT | FLOAT | atof() C |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | atoi()  |\n| BLOB | FLOAT | atof()  |\n| BLOB | TEXT | \\000 |\n\nVM..\n\n\n#### 3.2.1 NULL\n\nNULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n\n#### 3.2.2 \n\nSQLite\n\n*  =, <, <=, >, >=  !=\n*  IN\n*  BETWEEN\n\n\n1. NULLNULL\n2. INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL\n3. TEXTBLOBTEXTCmemcmp\n4. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXTSQL\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)`=(,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)``INSERT INTO t1 VALUES(500500500)`a,b,cTEXTINTEGERTEXT\n\n* `SELECT a < 60,a < 40 FROM t1`6040\"60\"\"40\"aTEXTTEXT`1|0`\"500\"\"60\"\"40\"\n* `SELECT b < 60,b < 600 FROM t1``0|1`\n* `SELECT c < 60,c < 600 FROM t1`cNONENUMERIC\"500\"(TEXT)`0|0`\n\n#### 3.2.3 \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### 3.2.4 ORDER BY\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### 3.2.5 GROUP BY\nGROUP BYINTEGERREAL\n\n#### 3.2.6 SELECT\nSELECT(UNIONINTERSECTEXCEPT)SELECTSELECT","slug":"17.inside-sqlite-chapter-6","published":1,"updated":"2020-08-29T14:42:58.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61a000helc92ienfpa2","content":"<blockquote>\n<p>source: inside-sqlite</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"SQLite-\"><a href=\"#SQLite-\" class=\"headerlink\" title=\"SQLite \"></a>SQLite </h2><p>SQLiteVMVMSQLiteVMSQLiteVMVMB+</p>\n<p>VMVM</p>\n<p> sqlite3_stmt(Vdbe)</p>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>BTree</li>\n</ul>\n<h3 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1 \"></a>1 </h3><p>SQLite&lt;opcode, P1, P2, P3&gt;, opcode P1, P2, P3VMP132P2 31P2P3NullNULL</p>\n<p>VMSQLiteSQLiteSQLite</p>\n<p><a href=\"\">6-1</a> SELECT * FROM t1 t1xy</p>\n<table>\n<thead>\n<tr>\n<th>Address</th>\n<th>Opcode</th>\n<th>p1</th>\n<th>p2</th>\n<th>p3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>Goto</td>\n<td>0</td>\n<td>11</td>\n<td></td>\n</tr>\n<tr>\n<td>1</td>\n<td>Integer</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>OpenRead</td>\n<td>0</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>SetNumColumn</td>\n<td>0</td>\n<td>2</td>\n<td>#t1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Rewind</td>\n<td>0</td>\n<td>9</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>Column</td>\n<td>0</td>\n<td>0</td>\n<td>#x</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Column</td>\n<td>0</td>\n<td>1</td>\n<td>#y</td>\n</tr>\n<tr>\n<td>7</td>\n<td>Callback</td>\n<td>2</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>Next</td>\n<td>0</td>\n<td>5</td>\n<td></td>\n</tr>\n<tr>\n<td>9</td>\n<td>Close</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>10</td>\n<td>Halt</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>11</td>\n<td>Transaction</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>VerifyCookie</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>13</td>\n<td>Goto</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Switchcase OP_ VMaOppcVM0</p>\n<p>VMkeyVM&#x2F;</p>\n<p>VMSELECT</p>\n<p>VMrcVM</p>\n<h3 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2 \"></a>2 </h3><p>VM(record)B&#x2F;B+<strong>key</strong><strong></strong>VMkeyB+-treeVMVM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<p>VMSQLSQLiteSQLiteSQLSQLite</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n</tr>\n</thead>\n</table>\n<p>(row data)Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>VM5SQL NULL123NULL</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<p>NULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>SQLiteB+-TreekeySQLite</p>\n<p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]</p>\n<p>SQLSQL:<code>create table t1(x, y)</code>rowidSQLiterowidSQLite<code>insert into t1(rowid, x, y) values(100, &#39;hello&#39;, &#39;world&#39;)</code>rowid</p>\n<p>SQL</p>\n<table>\n<thead>\n<tr>\n<th>rowid</th>\n<th>x</th>\n<th>y</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-5</td>\n<td>abc</td>\n<td>xyz</td>\n</tr>\n<tr>\n<td>1</td>\n<td>abc</td>\n<td>12345</td>\n</tr>\n<tr>\n<td>2</td>\n<td>456</td>\n<td>def</td>\n</tr>\n<tr>\n<td>100</td>\n<td>hello</td>\n<td>world</td>\n</tr>\n<tr>\n<td>54321</td>\n<td>NULL</td>\n<td>987</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>rowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid</p>\n<p>rowidkeyrowid9rowidSQLiterowid-5</p>\n<p>B+key(key)rowidSQLiterowidB+</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>SQLiteyx</p>\n<p>yx</p>\n<table>\n<thead>\n<tr>\n<th>y</th>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>987</td>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>12345</td>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>def</td>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>xyz</td>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>world</td>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p><code>SELECT y FROM t1 WHERE x=</code>SQLite <code>t1(x)</code>x&#x3D;?rowidrowidt1B+y</p>\n<h3 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3 \"></a>3 </h3><p>SQLiteVMVMVMVMVM</p>\n<p>SQLiteSQLVMSQLSQLiteINTEGERREALTEXT</p>\n<h4 id=\"3-1-1-\"><a href=\"#3-1-1-\" class=\"headerlink\" title=\"3.1.1 \"></a>3.1.1 </h4><p>VMSQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB</li>\n</ul>\n<p>sqlite3_bind_ * APISQLsqlite3_bind_blob BLOB</p>\n<p>SQLSQLVM</p>\n<h4 id=\"3-1-2-\"><a href=\"#3-1-2-\" class=\"headerlink\" title=\"3.1.2 \"></a>3.1.2 </h4><p>SQLSQLSQLiteSQLite</p>\n<p><strong></strong></p>\n<p>SQLiterowidSQLiteSQL<code>create table T1(a, b, c)</code>SQLiteSQL</p>\n<p>TEXT, NUMERIC, INTEGER, REAL, and NONEtext, integer,real<code>CREATE TABLE</code>SQLSQLiteSQL:</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE<code>create table table1 as select ...</code>SQLSQLNONErowid.</p>\n<h4 id=\"3-1-3-\"><a href=\"#3-1-3-\" class=\"headerlink\" title=\"3.1.3 \"></a>3.1.3 </h4><p>VM</p>\n<ol>\n<li>TEXTNULLTEXTBLOBTEXT</li>\n<li>NUMERICNUMERICINTEGERREALTEXTNULLBLOB</li>\n<li>INTEGERNUMERICINTEGER</li>\n<li>REALNUMERIC-</li>\n<li>NONE VM</li>\n</ol>\n<p><strong></strong></p>\n<p>SQLSQLiteSQLINTEGER(123abc)VM(123)REALINTEGER(abc)TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug</p>\n<h4 id=\"3-1-4-\"><a href=\"#3-1-4-\" class=\"headerlink\" title=\"3.1.4 \"></a>3.1.4 </h4><p></p>\n<p><code>CREATE TABLE T1(a,b,c);</code><br><code>INSERT INTO T1 VALUES(177,NULL,&#39;hello&#39;);</code></p>\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\n<p>a,b,cintegerNULLTEXTNONEVM11(header+data)16</p>\n<ol>\n<li>Header440x04</li>\n<li>Type 12.</li>\n<li>Type 20.NULL</li>\n<li>Type 323.(23-13&#x2F;2&#x3D;)5</li>\n<li>Data 1200B1,117117B1-79177.</li>\n<li>Data 2NULL</li>\n<li>Data 3568 65 6C 6F0</li>\n</ol>\n<p><code>sqlite3_column_*</code>APISQLiteFLOAT( sqlite3_column_text)VM<code>sprintf()</code>VM</p>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>atoi() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>atof() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<p>VM..</p>\n<h4 id=\"3-2-1-NULL\"><a href=\"#3-2-1-NULL\" class=\"headerlink\" title=\"3.2.1 NULL\"></a>3.2.1 NULL</h4><p>NULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"3-2-2-\"><a href=\"#3-2-2-\" class=\"headerlink\" title=\"3.2.2 \"></a>3.2.2 </h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;  !&#x3D;</li>\n<li> IN</li>\n<li> BETWEEN</li>\n</ul>\n<p></p>\n<ol>\n<li>NULLNULL</li>\n<li>INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL</li>\n<li>TEXTBLOBTEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXTSQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code>&#x3D;(,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)</code><code>INSERT INTO t1 VALUES(500500500)</code>a,b,cTEXTINTEGERTEXT</p>\n<ul>\n<li><code>SELECT a &lt; 60,a &lt; 40 FROM t1</code>60406040aTEXTTEXT<code>1|0</code>5006040</li>\n<li><code>SELECT b &lt; 60,b &lt; 600 FROM t1</code><code>0|1</code></li>\n<li><code>SELECT c &lt; 60,c &lt; 600 FROM t1</code>cNONENUMERIC500(TEXT)<code>0|0</code></li>\n</ul>\n<h4 id=\"3-2-3-\"><a href=\"#3-2-3-\" class=\"headerlink\" title=\"3.2.3 \"></a>3.2.3 </h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"3-2-4-ORDER-BY\"><a href=\"#3-2-4-ORDER-BY\" class=\"headerlink\" title=\"3.2.4 ORDER BY\"></a>3.2.4 ORDER BY</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"3-2-5-GROUP-BY\"><a href=\"#3-2-5-GROUP-BY\" class=\"headerlink\" title=\"3.2.5 GROUP BY\"></a>3.2.5 GROUP BY</h4><p>GROUP BYINTEGERREAL</p>\n<h4 id=\"3-2-6-SELECT\"><a href=\"#3-2-6-SELECT\" class=\"headerlink\" title=\"3.2.6 SELECT\"></a>3.2.6 SELECT</h4><p>SELECT(UNIONINTERSECTEXCEPT)SELECTSELECT</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>source: inside-sqlite</p>\n</blockquote>","more":"<h2 id=\"SQLite-\"><a href=\"#SQLite-\" class=\"headerlink\" title=\"SQLite \"></a>SQLite </h2><p>SQLiteVMVMSQLiteVMSQLiteVMVMB+</p>\n<p>VMVM</p>\n<p> sqlite3_stmt(Vdbe)</p>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>BTree</li>\n</ul>\n<h3 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1 \"></a>1 </h3><p>SQLite&lt;opcode, P1, P2, P3&gt;, opcode P1, P2, P3VMP132P2 31P2P3NullNULL</p>\n<p>VMSQLiteSQLiteSQLite</p>\n<p><a href=\"\">6-1</a> SELECT * FROM t1 t1xy</p>\n<table>\n<thead>\n<tr>\n<th>Address</th>\n<th>Opcode</th>\n<th>p1</th>\n<th>p2</th>\n<th>p3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>Goto</td>\n<td>0</td>\n<td>11</td>\n<td></td>\n</tr>\n<tr>\n<td>1</td>\n<td>Integer</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>OpenRead</td>\n<td>0</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>SetNumColumn</td>\n<td>0</td>\n<td>2</td>\n<td>#t1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Rewind</td>\n<td>0</td>\n<td>9</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>Column</td>\n<td>0</td>\n<td>0</td>\n<td>#x</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Column</td>\n<td>0</td>\n<td>1</td>\n<td>#y</td>\n</tr>\n<tr>\n<td>7</td>\n<td>Callback</td>\n<td>2</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>Next</td>\n<td>0</td>\n<td>5</td>\n<td></td>\n</tr>\n<tr>\n<td>9</td>\n<td>Close</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>10</td>\n<td>Halt</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>11</td>\n<td>Transaction</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>VerifyCookie</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>13</td>\n<td>Goto</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Switchcase OP_ VMaOppcVM0</p>\n<p>VMkeyVM&#x2F;</p>\n<p>VMSELECT</p>\n<p>VMrcVM</p>\n<h3 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2 \"></a>2 </h3><p>VM(record)B&#x2F;B+<strong>key</strong><strong></strong>VMkeyB+-treeVMVM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<p>VMSQLSQLiteSQLiteSQLSQLite</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n</tr>\n</thead>\n</table>\n<p>(row data)Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>VM5SQL NULL123NULL</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<p>NULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>SQLiteB+-TreekeySQLite</p>\n<p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]</p>\n<p>SQLSQL:<code>create table t1(x, y)</code>rowidSQLiterowidSQLite<code>insert into t1(rowid, x, y) values(100, &#39;hello&#39;, &#39;world&#39;)</code>rowid</p>\n<p>SQL</p>\n<table>\n<thead>\n<tr>\n<th>rowid</th>\n<th>x</th>\n<th>y</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-5</td>\n<td>abc</td>\n<td>xyz</td>\n</tr>\n<tr>\n<td>1</td>\n<td>abc</td>\n<td>12345</td>\n</tr>\n<tr>\n<td>2</td>\n<td>456</td>\n<td>def</td>\n</tr>\n<tr>\n<td>100</td>\n<td>hello</td>\n<td>world</td>\n</tr>\n<tr>\n<td>54321</td>\n<td>NULL</td>\n<td>987</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>rowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid</p>\n<p>rowidkeyrowid9rowidSQLiterowid-5</p>\n<p>B+key(key)rowidSQLiterowidB+</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>SQLiteyx</p>\n<p>yx</p>\n<table>\n<thead>\n<tr>\n<th>y</th>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>987</td>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>12345</td>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>def</td>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>xyz</td>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>world</td>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p><code>SELECT y FROM t1 WHERE x=</code>SQLite <code>t1(x)</code>x&#x3D;?rowidrowidt1B+y</p>\n<h3 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3 \"></a>3 </h3><p>SQLiteVMVMVMVMVM</p>\n<p>SQLiteSQLVMSQLSQLiteINTEGERREALTEXT</p>\n<h4 id=\"3-1-1-\"><a href=\"#3-1-1-\" class=\"headerlink\" title=\"3.1.1 \"></a>3.1.1 </h4><p>VMSQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB</li>\n</ul>\n<p>sqlite3_bind_ * APISQLsqlite3_bind_blob BLOB</p>\n<p>SQLSQLVM</p>\n<h4 id=\"3-1-2-\"><a href=\"#3-1-2-\" class=\"headerlink\" title=\"3.1.2 \"></a>3.1.2 </h4><p>SQLSQLSQLiteSQLite</p>\n<p><strong></strong></p>\n<p>SQLiterowidSQLiteSQL<code>create table T1(a, b, c)</code>SQLiteSQL</p>\n<p>TEXT, NUMERIC, INTEGER, REAL, and NONEtext, integer,real<code>CREATE TABLE</code>SQLSQLiteSQL:</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE<code>create table table1 as select ...</code>SQLSQLNONErowid.</p>\n<h4 id=\"3-1-3-\"><a href=\"#3-1-3-\" class=\"headerlink\" title=\"3.1.3 \"></a>3.1.3 </h4><p>VM</p>\n<ol>\n<li>TEXTNULLTEXTBLOBTEXT</li>\n<li>NUMERICNUMERICINTEGERREALTEXTNULLBLOB</li>\n<li>INTEGERNUMERICINTEGER</li>\n<li>REALNUMERIC-</li>\n<li>NONE VM</li>\n</ol>\n<p><strong></strong></p>\n<p>SQLSQLiteSQLINTEGER(123abc)VM(123)REALINTEGER(abc)TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug</p>\n<h4 id=\"3-1-4-\"><a href=\"#3-1-4-\" class=\"headerlink\" title=\"3.1.4 \"></a>3.1.4 </h4><p></p>\n<p><code>CREATE TABLE T1(a,b,c);</code><br><code>INSERT INTO T1 VALUES(177,NULL,&#39;hello&#39;);</code></p>\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\n<p>a,b,cintegerNULLTEXTNONEVM11(header+data)16</p>\n<ol>\n<li>Header440x04</li>\n<li>Type 12.</li>\n<li>Type 20.NULL</li>\n<li>Type 323.(23-13&#x2F;2&#x3D;)5</li>\n<li>Data 1200B1,117117B1-79177.</li>\n<li>Data 2NULL</li>\n<li>Data 3568 65 6C 6F0</li>\n</ol>\n<p><code>sqlite3_column_*</code>APISQLiteFLOAT( sqlite3_column_text)VM<code>sprintf()</code>VM</p>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>atoi() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>atof() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<p>VM..</p>\n<h4 id=\"3-2-1-NULL\"><a href=\"#3-2-1-NULL\" class=\"headerlink\" title=\"3.2.1 NULL\"></a>3.2.1 NULL</h4><p>NULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"3-2-2-\"><a href=\"#3-2-2-\" class=\"headerlink\" title=\"3.2.2 \"></a>3.2.2 </h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;  !&#x3D;</li>\n<li> IN</li>\n<li> BETWEEN</li>\n</ul>\n<p></p>\n<ol>\n<li>NULLNULL</li>\n<li>INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL</li>\n<li>TEXTBLOBTEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXTSQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code>&#x3D;(,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)</code><code>INSERT INTO t1 VALUES(500500500)</code>a,b,cTEXTINTEGERTEXT</p>\n<ul>\n<li><code>SELECT a &lt; 60,a &lt; 40 FROM t1</code>60406040aTEXTTEXT<code>1|0</code>5006040</li>\n<li><code>SELECT b &lt; 60,b &lt; 600 FROM t1</code><code>0|1</code></li>\n<li><code>SELECT c &lt; 60,c &lt; 600 FROM t1</code>cNONENUMERIC500(TEXT)<code>0|0</code></li>\n</ul>\n<h4 id=\"3-2-3-\"><a href=\"#3-2-3-\" class=\"headerlink\" title=\"3.2.3 \"></a>3.2.3 </h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"3-2-4-ORDER-BY\"><a href=\"#3-2-4-ORDER-BY\" class=\"headerlink\" title=\"3.2.4 ORDER BY\"></a>3.2.4 ORDER BY</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"3-2-5-GROUP-BY\"><a href=\"#3-2-5-GROUP-BY\" class=\"headerlink\" title=\"3.2.5 GROUP BY\"></a>3.2.5 GROUP BY</h4><p>GROUP BYINTEGERREAL</p>\n<h4 id=\"3-2-6-SELECT\"><a href=\"#3-2-6-SELECT\" class=\"headerlink\" title=\"3.2.6 SELECT\"></a>3.2.6 SELECT</h4><p>SELECT(UNIONINTERSECTEXCEPT)SELECTSELECT</p>"},{"title":"SQLite--KeywordHash","date":"2020-07-15T16:00:00.000Z","_content":"\n> SQLite (3.27.2136)SQLTokenize()SQLiteSQLite\"\"SQLite\n\n<!-- more -->\n\n## SQLite\n\nSQLitecmakeautoconfigMakefileMakefile`keywordhash.h`Makefilecommand\n\n``` c\nkeywordhash.h:\t$(TOP)/tool/mkkeywordhash.c\n\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c\n\t./mkkeywordhash >keywordhash.h\n```\n\n`$(TOP)/tool/mkkeywordhash.c`command:`mkkeywordhash.c``keywordhash.h``keywordhash.h``mkkeywordhash`\n\n`keywordhash.h`:\n\n``` c\n** The code in this file has been automatically generated by\n**\n**   sqlite/tool/mkkeywordhash.c\n**\n** The code in this file implements a function that determines whether\n** or not a given identifier is really an SQL keyword.  The same thing\n** might be implemented more directly using a hand-written hash table.\n** But by using this automatically generated code, the size of the code\n** is substantially reduced.  This is important for embedded applications\n** on platforms with limited memory.\n```\n\nhand-written()SQLite\n\n## mkkeywordhash\n\nSQLiteSQLSQLite136`mkkeywordhash`:\n\n1. SQLite(mkkeywordhash)\n2. `mkkeywordhash`:`REINDEX``INDEXED``INDEX``REINDEX`\n3. SQLite**\n\n**SQLite\n\n`mkkeywordhash.c`SQLite:\n\n## mkkeywordhash.c\n\n### \n\n``` c\n/*\n** All the keywords of the SQL language are stored in a hash\n** table composed of instances of the following structure.\n*/\ntypedef struct Keyword Keyword;\nstruct Keyword {\n  char *zName;         /* The keyword name */\n  char *zTokenType;    /* Token value for this keyword */\n  int mask;            /* Code this keyword if non-zero */\n  int id;              /* Unique ID for this record */\n  int hash;            /* Hash on the keyword */\n  int offset;          /* Offset to start of name string */\n  int len;             /* Length of this keyword, not counting final \\000 */\n  int prefix;          /* Number of characters in prefix */\n  int longestSuffix;   /* Longest suffix that is a prefix on another word */\n  int iNext;           /* Index in aKeywordTable[] of next with same hash */\n  int substrId;        /* Id to another keyword this keyword is embedded in */\n  int substrOffset;    /* Offset into substrId for start of this keyword */\n  char zOrigName[20];  /* Original keyword name before processing */\n};\n```\n\n`mkkeywordhash.c``mkkeywordhash``KeyWord``keywordhash.h`\n\n* char *zName:             \n* char *zTokenType:      tokenize\n* int mask:              mask\n* int id:                idid\n* int hash:              \n* int offset:            \n* int len:               \n* int prefix:            \n* int longestSuffix:     \n* int iNext:             \n* int substrId:          substrIdId\n* int substrOffset:      substrIdsubstrOffset\n* char zOrigName[20]:    \n\n aKeywordTable \n\n``` c\nstatic Keyword aKeywordTable[] = {\n  { \"ABORT\",            \"TK_ABORT\",        CONFLICT|TRIGGER       },\n  { \"ACTION\",           \"TK_ACTION\",       FKEY                   },\n  { \"ADD\",              \"TK_ADD\",          ALTER                  },\n  { \"AFTER\",            \"TK_AFTER\",        TRIGGER                },\n  /* ... 136 ... */\n};\n```\n\n### \n\n`mkkeywordhash`:\n\n### \n\n`mkkeywordhash` main\n\n aKeywordTable  `Keyword` maskmasktagmaskmaskmaskmaskSQLitemask\n\n``` c\n#ifdef SQLITE_OMIT_ALTERTABLE\n#  define ALTER      0\n#else\n#  define ALTER      0x00000001\n#endif\n```\n\n`SQLITE_OMIT_ALTERTABLE``ALTER`0`ALTER`maskmask0\n\n``` c\n/* Remove entries from the list of keywords that have mask==0 */\nfor(i=j=0; i<nKeyword; i++){\n    if( aKeywordTable[i].mask==0 ) continue;\n    if( j<i ){\n      aKeywordTable[j] = aKeywordTable[i];\n    }\n    j++;\n}\nnKeyword = j;\n```\n akeywordTable mask0\n\n### \n\n``` c\nfor(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    p->len = (int)strlen(p->zName);\n    assert( p->len<sizeof(p->zOrigName) );\n    memcpy(p->zOrigName, p->zName, p->len+1);\n    totalLen += p->len;\n    p->hash = (charMap(p->zName[0])*4) ^\n              (charMap(p->zName[p->len-1])*3) ^ (p->len*1);\n    p->id = i+1;\n}\n```\n\naKeywordTablenKeywordSQLite\n\n* id\n* p->len \n* p->zOrigName  p->zName \n* :(*4)^(*3)^()) aKeywordTable\n\n### \n\nABABAB\n\n``` c\n/* Sort the table from shortest to longest keyword */\n/*  */\nqsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare1);\n\n/* Look for short keywords embedded in longer keywords */\n/* ,ININDEXINDEXINDEXED*/\nfor(i=nKeyword-2; i>=0; i--){//\n    Keyword *p = &aKeywordTable[i];//p: \n    for(j=nKeyword-1; j>i && p->substrId==0; j--){//()\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->substrId ) continue;\n        if( pOther->len<=p->len ) continue;\n\n        // p  pOther \n        for(k=0; k<=pOther->len-p->len; k++){\n            if( memcmp(p->zName, &pOther->zName[k], p->len)==0 ){\n                p->substrId = pOther->id;\n                p->substrOffset = k;\n                break;\n            }\n        }\n    }\n}\n```\n\n* ABAB\n* ABAsubstrIdBIdAsubstrOffset\n\n### \n\n``` c\n  /* Compute the longestSuffix value for every word */\n  /* \n     */\n  for(i=0; i<nKeyword; i++){//\n    Keyword *p = &aKeywordTable[i];\n    if( p->substrId ) continue;//\n    for(j=0; j<nKeyword; j++){//\n      Keyword *pOther;\n      if( j==i ) continue;//\n      pOther = &aKeywordTable[j];\n      if( pOther->substrId ) continue;//\n\n      // p  pOther \n      for(k=p->longestSuffix+1; k<p->len && k<pOther->len; k++){\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p->longestSuffix = k;\n        }\n      }\n    }\n  }\n\n    /* Sort the table into reverse order by length */\n    /*    */\n    qsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare2);\n```\n\n\n\n### \n\n``` c\n  /* Fill in the offset for all entries */\n  nChar = 0;\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    if( p->offset>0 || p->substrId ) continue;\n    p->offset = nChar;\n    nChar += p->len;\n    for(k=p->len-1; k>=1; k--){\n      for(j=i+1; j<nKeyword; j++){\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->offset>0 || pOther->substrId ) continue;\n        if( pOther->len<=k ) continue;\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p = pOther;\n          p->offset = nChar - k;\n          nChar = p->offset + p->len;\n          p->zName += k;\n          p->len -= k;\n          p->prefix = k;\n          j = i;\n          k = p->len;\n        }\n      }\n    }\n  }\n\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    //subStrId\n    if( p->substrId ){\n      p->offset = findById(p->substrId)->offset + p->substrOffset;\n    }\n  }\n```\n\n: \n\n:`abcde``def``efg`,`def``de``abcde``f`3\n\n\n\n:\n1. \n2. (`k=p->len-1`)break\n\n\n\n\n* SQLiteSQLite\n* `p = pOther;`ppOtherpOther\n* check(i==nKeyword)\n\n### \n\n****\n\nsize\n\nSQLitebestCountscore()\n\n  * 1+ * 2 1+2=1SQLite\n\n\n\n``` c\n  /* Figure out how big to make the hash table in order to minimize the\n  ** number of collisions */\n  /*  */\n  // SQLite  [nKeyword, 2*nKeyword]\n  // \n  bestSize = nKeyword;\n  bestCount = nKeyword*nKeyword;\n  for(i=nKeyword/2; i<=2*nKeyword; i++){\n    for(j=0; j<i; j++) aKWHash[j] = 0;\n    for(j=0; j<nKeyword; j++){\n      h = aKeywordTable[j].hash % i;\n      aKWHash[h] *= 2;\n      aKWHash[h]++;\n    }\n    for(j=count=0; j<i; j++) count += aKWHash[j];\n    if( count<bestCount ){\n      bestCount = count;\n      bestSize = i;\n    }\n  }\n```\n\nSQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount\n\n\n\n1. aKWHash0\n2. \n3. *2 + 111*2+1=33*2+1=7\n4. aKWHashaKWHash\"score\"\n5. [nKeyword, 2 x nKeyword]\"score\"\n\n\n x2 \"\" x2 \"score\"2 \"\" 345...\n\n`keywordhash.h``Hash score`, (3.27.2) 2 `Hash score`*208*\n\n### \n\n``` c\n/* Compute the hash */\n  for(i=0; i<bestSize; i++) aKWHash[i] = 0;\n  for(i=0; i<nKeyword; i++) {\n    //..\n    h = aKeywordTable[i].hash % bestSize;\n    aKeywordTable[i].iNext = aKWHash[h];\n    aKWHash[h] = i+1;\n  }\n```\n\nbestSize -> bestCount -> \n\n+1`iNext`next\n\n......\n\n`aKeywordTable`N\n\n`zKWText`: `aKeywordTable``KeyWord``zName`\n`aKWHash`: ()\n`aKWNext`: \n`aKWLen` : i\n`aKWOffset` : `zKWText`\n`aKWCode` : `parser`\n\n\n## (keywordCode)\n\n`keywordCode(const char *z, int n, int *pType)`\n\n``` c\n/* Check to see if z[0..n-1] is a keyword. If it is, write the\n** parser symbol code for that keyword into *pType.  Always\n** return the integer n (the length of the token). */\nstatic int keywordCode(const char *z, int n, int *pType){\n  int i, j;\n  const char *zKW;\n  if( n>=2 ){\n    i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127;//\n    for(i=((int)aKWHash[i])-1; i>=0; i=((int)aKWNext[i])-1){\n      if( aKWLen[i]!=n ) continue;\n      j = 0;\n      zKW = &zKWText[aKWOffset[i]];\n#ifdef SQLITE_ASCII\n      while( j<n && (z[j]&~0x20)==zKW[j] ){ j++; }\n#endif\n#ifdef SQLITE_EBCDIC\n      while( j<n && toupper(z[j])==zKW[j] ){ j++; }\n#endif\n      if( j<n ) continue;\n      testcase( i==0 ); /* REINDEX */\n      testcase( i==1 ); /* INDEXED */\n    //   ......\n      testcase( i==135 ); /* PRIMARY */\n      *pType = aKWCode[i];\n      break;\n    }\n  }\n  return n;\n}\n```\n\n:(`parser`)n\n\n1. 2\n2. `i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127`127\n3. aKWHash[i]aKWNext\n4. \n5. zKWText\n6. 3\n","source":"_posts/19.SQLite-KeywordHash.md","raw":"---\ntitle: SQLite--KeywordHash\ndate: 2020-07-16\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLite (3.27.2136)SQLTokenize()SQLiteSQLite\"\"SQLite\n\n<!-- more -->\n\n## SQLite\n\nSQLitecmakeautoconfigMakefileMakefile`keywordhash.h`Makefilecommand\n\n``` c\nkeywordhash.h:\t$(TOP)/tool/mkkeywordhash.c\n\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c\n\t./mkkeywordhash >keywordhash.h\n```\n\n`$(TOP)/tool/mkkeywordhash.c`command:`mkkeywordhash.c``keywordhash.h``keywordhash.h``mkkeywordhash`\n\n`keywordhash.h`:\n\n``` c\n** The code in this file has been automatically generated by\n**\n**   sqlite/tool/mkkeywordhash.c\n**\n** The code in this file implements a function that determines whether\n** or not a given identifier is really an SQL keyword.  The same thing\n** might be implemented more directly using a hand-written hash table.\n** But by using this automatically generated code, the size of the code\n** is substantially reduced.  This is important for embedded applications\n** on platforms with limited memory.\n```\n\nhand-written()SQLite\n\n## mkkeywordhash\n\nSQLiteSQLSQLite136`mkkeywordhash`:\n\n1. SQLite(mkkeywordhash)\n2. `mkkeywordhash`:`REINDEX``INDEXED``INDEX``REINDEX`\n3. SQLite**\n\n**SQLite\n\n`mkkeywordhash.c`SQLite:\n\n## mkkeywordhash.c\n\n### \n\n``` c\n/*\n** All the keywords of the SQL language are stored in a hash\n** table composed of instances of the following structure.\n*/\ntypedef struct Keyword Keyword;\nstruct Keyword {\n  char *zName;         /* The keyword name */\n  char *zTokenType;    /* Token value for this keyword */\n  int mask;            /* Code this keyword if non-zero */\n  int id;              /* Unique ID for this record */\n  int hash;            /* Hash on the keyword */\n  int offset;          /* Offset to start of name string */\n  int len;             /* Length of this keyword, not counting final \\000 */\n  int prefix;          /* Number of characters in prefix */\n  int longestSuffix;   /* Longest suffix that is a prefix on another word */\n  int iNext;           /* Index in aKeywordTable[] of next with same hash */\n  int substrId;        /* Id to another keyword this keyword is embedded in */\n  int substrOffset;    /* Offset into substrId for start of this keyword */\n  char zOrigName[20];  /* Original keyword name before processing */\n};\n```\n\n`mkkeywordhash.c``mkkeywordhash``KeyWord``keywordhash.h`\n\n* char *zName:             \n* char *zTokenType:      tokenize\n* int mask:              mask\n* int id:                idid\n* int hash:              \n* int offset:            \n* int len:               \n* int prefix:            \n* int longestSuffix:     \n* int iNext:             \n* int substrId:          substrIdId\n* int substrOffset:      substrIdsubstrOffset\n* char zOrigName[20]:    \n\n aKeywordTable \n\n``` c\nstatic Keyword aKeywordTable[] = {\n  { \"ABORT\",            \"TK_ABORT\",        CONFLICT|TRIGGER       },\n  { \"ACTION\",           \"TK_ACTION\",       FKEY                   },\n  { \"ADD\",              \"TK_ADD\",          ALTER                  },\n  { \"AFTER\",            \"TK_AFTER\",        TRIGGER                },\n  /* ... 136 ... */\n};\n```\n\n### \n\n`mkkeywordhash`:\n\n### \n\n`mkkeywordhash` main\n\n aKeywordTable  `Keyword` maskmasktagmaskmaskmaskmaskSQLitemask\n\n``` c\n#ifdef SQLITE_OMIT_ALTERTABLE\n#  define ALTER      0\n#else\n#  define ALTER      0x00000001\n#endif\n```\n\n`SQLITE_OMIT_ALTERTABLE``ALTER`0`ALTER`maskmask0\n\n``` c\n/* Remove entries from the list of keywords that have mask==0 */\nfor(i=j=0; i<nKeyword; i++){\n    if( aKeywordTable[i].mask==0 ) continue;\n    if( j<i ){\n      aKeywordTable[j] = aKeywordTable[i];\n    }\n    j++;\n}\nnKeyword = j;\n```\n akeywordTable mask0\n\n### \n\n``` c\nfor(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    p->len = (int)strlen(p->zName);\n    assert( p->len<sizeof(p->zOrigName) );\n    memcpy(p->zOrigName, p->zName, p->len+1);\n    totalLen += p->len;\n    p->hash = (charMap(p->zName[0])*4) ^\n              (charMap(p->zName[p->len-1])*3) ^ (p->len*1);\n    p->id = i+1;\n}\n```\n\naKeywordTablenKeywordSQLite\n\n* id\n* p->len \n* p->zOrigName  p->zName \n* :(*4)^(*3)^()) aKeywordTable\n\n### \n\nABABAB\n\n``` c\n/* Sort the table from shortest to longest keyword */\n/*  */\nqsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare1);\n\n/* Look for short keywords embedded in longer keywords */\n/* ,ININDEXINDEXINDEXED*/\nfor(i=nKeyword-2; i>=0; i--){//\n    Keyword *p = &aKeywordTable[i];//p: \n    for(j=nKeyword-1; j>i && p->substrId==0; j--){//()\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->substrId ) continue;\n        if( pOther->len<=p->len ) continue;\n\n        // p  pOther \n        for(k=0; k<=pOther->len-p->len; k++){\n            if( memcmp(p->zName, &pOther->zName[k], p->len)==0 ){\n                p->substrId = pOther->id;\n                p->substrOffset = k;\n                break;\n            }\n        }\n    }\n}\n```\n\n* ABAB\n* ABAsubstrIdBIdAsubstrOffset\n\n### \n\n``` c\n  /* Compute the longestSuffix value for every word */\n  /* \n     */\n  for(i=0; i<nKeyword; i++){//\n    Keyword *p = &aKeywordTable[i];\n    if( p->substrId ) continue;//\n    for(j=0; j<nKeyword; j++){//\n      Keyword *pOther;\n      if( j==i ) continue;//\n      pOther = &aKeywordTable[j];\n      if( pOther->substrId ) continue;//\n\n      // p  pOther \n      for(k=p->longestSuffix+1; k<p->len && k<pOther->len; k++){\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p->longestSuffix = k;\n        }\n      }\n    }\n  }\n\n    /* Sort the table into reverse order by length */\n    /*    */\n    qsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare2);\n```\n\n\n\n### \n\n``` c\n  /* Fill in the offset for all entries */\n  nChar = 0;\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    if( p->offset>0 || p->substrId ) continue;\n    p->offset = nChar;\n    nChar += p->len;\n    for(k=p->len-1; k>=1; k--){\n      for(j=i+1; j<nKeyword; j++){\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->offset>0 || pOther->substrId ) continue;\n        if( pOther->len<=k ) continue;\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p = pOther;\n          p->offset = nChar - k;\n          nChar = p->offset + p->len;\n          p->zName += k;\n          p->len -= k;\n          p->prefix = k;\n          j = i;\n          k = p->len;\n        }\n      }\n    }\n  }\n\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    //subStrId\n    if( p->substrId ){\n      p->offset = findById(p->substrId)->offset + p->substrOffset;\n    }\n  }\n```\n\n: \n\n:`abcde``def``efg`,`def``de``abcde``f`3\n\n\n\n:\n1. \n2. (`k=p->len-1`)break\n\n\n\n\n* SQLiteSQLite\n* `p = pOther;`ppOtherpOther\n* check(i==nKeyword)\n\n### \n\n****\n\nsize\n\nSQLitebestCountscore()\n\n  * 1+ * 2 1+2=1SQLite\n\n\n\n``` c\n  /* Figure out how big to make the hash table in order to minimize the\n  ** number of collisions */\n  /*  */\n  // SQLite  [nKeyword, 2*nKeyword]\n  // \n  bestSize = nKeyword;\n  bestCount = nKeyword*nKeyword;\n  for(i=nKeyword/2; i<=2*nKeyword; i++){\n    for(j=0; j<i; j++) aKWHash[j] = 0;\n    for(j=0; j<nKeyword; j++){\n      h = aKeywordTable[j].hash % i;\n      aKWHash[h] *= 2;\n      aKWHash[h]++;\n    }\n    for(j=count=0; j<i; j++) count += aKWHash[j];\n    if( count<bestCount ){\n      bestCount = count;\n      bestSize = i;\n    }\n  }\n```\n\nSQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount\n\n\n\n1. aKWHash0\n2. \n3. *2 + 111*2+1=33*2+1=7\n4. aKWHashaKWHash\"score\"\n5. [nKeyword, 2 x nKeyword]\"score\"\n\n\n x2 \"\" x2 \"score\"2 \"\" 345...\n\n`keywordhash.h``Hash score`, (3.27.2) 2 `Hash score`*208*\n\n### \n\n``` c\n/* Compute the hash */\n  for(i=0; i<bestSize; i++) aKWHash[i] = 0;\n  for(i=0; i<nKeyword; i++) {\n    //..\n    h = aKeywordTable[i].hash % bestSize;\n    aKeywordTable[i].iNext = aKWHash[h];\n    aKWHash[h] = i+1;\n  }\n```\n\nbestSize -> bestCount -> \n\n+1`iNext`next\n\n......\n\n`aKeywordTable`N\n\n`zKWText`: `aKeywordTable``KeyWord``zName`\n`aKWHash`: ()\n`aKWNext`: \n`aKWLen` : i\n`aKWOffset` : `zKWText`\n`aKWCode` : `parser`\n\n\n## (keywordCode)\n\n`keywordCode(const char *z, int n, int *pType)`\n\n``` c\n/* Check to see if z[0..n-1] is a keyword. If it is, write the\n** parser symbol code for that keyword into *pType.  Always\n** return the integer n (the length of the token). */\nstatic int keywordCode(const char *z, int n, int *pType){\n  int i, j;\n  const char *zKW;\n  if( n>=2 ){\n    i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127;//\n    for(i=((int)aKWHash[i])-1; i>=0; i=((int)aKWNext[i])-1){\n      if( aKWLen[i]!=n ) continue;\n      j = 0;\n      zKW = &zKWText[aKWOffset[i]];\n#ifdef SQLITE_ASCII\n      while( j<n && (z[j]&~0x20)==zKW[j] ){ j++; }\n#endif\n#ifdef SQLITE_EBCDIC\n      while( j<n && toupper(z[j])==zKW[j] ){ j++; }\n#endif\n      if( j<n ) continue;\n      testcase( i==0 ); /* REINDEX */\n      testcase( i==1 ); /* INDEXED */\n    //   ......\n      testcase( i==135 ); /* PRIMARY */\n      *pType = aKWCode[i];\n      break;\n    }\n  }\n  return n;\n}\n```\n\n:(`parser`)n\n\n1. 2\n2. `i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127`127\n3. aKWHash[i]aKWNext\n4. \n5. zKWText\n6. 3\n","slug":"19.SQLite-KeywordHash","published":1,"updated":"2020-08-29T14:42:58.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61b000jelc92m5p5s1o","content":"<blockquote>\n<p>SQLite (3.27.2136)SQLTokenize()SQLiteSQLiteSQLite</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h2><p>SQLitecmakeautoconfigMakefileMakefile<code>keywordhash.h</code>Makefilecommand</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">keywordhash.h:\t$(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t./mkkeywordhash &gt;keywordhash.h</span><br></pre></td></tr></table></figure>\n\n<p><code>$(TOP)/tool/mkkeywordhash.c</code>command:<code>mkkeywordhash.c</code><code>keywordhash.h</code><code>keywordhash.h</code><code>mkkeywordhash</code></p>\n<p><code>keywordhash.h</code>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">** The code in this file has been automatically generated by</span><br><span class=\"line\">**</span><br><span class=\"line\">**   sqlite/tool/mkkeywordhash.c</span><br><span class=\"line\">**</span><br><span class=\"line\">** The code in this file implements a function that determines whether</span><br><span class=\"line\">** or not a given identifier is really an SQL keyword.  The same thing</span><br><span class=\"line\">** might be implemented more directly using a hand-written hash table.</span><br><span class=\"line\">** But by using this automatically generated code, the size of the code</span><br><span class=\"line\">** is substantially reduced.  This is important <span class=\"keyword\">for</span> embedded applications</span><br><span class=\"line\">** on platforms with limited memory.</span><br></pre></td></tr></table></figure>\n\n<p>hand-written()SQLite</p>\n<h2 id=\"mkkeywordhash\"><a href=\"#mkkeywordhash\" class=\"headerlink\" title=\"mkkeywordhash\"></a>mkkeywordhash</h2><p>SQLiteSQLSQLite136<code>mkkeywordhash</code>:</p>\n<ol>\n<li>SQLite(mkkeywordhash)</li>\n<li><code>mkkeywordhash</code>:<code>REINDEX</code><code>INDEXED</code><code>INDEX</code><code>REINDEX</code></li>\n<li>SQLite<em></em></li>\n</ol>\n<p><em></em>SQLite</p>\n<p><code>mkkeywordhash.c</code>SQLite:</p>\n<h2 id=\"mkkeywordhash-c\"><a href=\"#mkkeywordhash-c\" class=\"headerlink\" title=\"mkkeywordhash.c\"></a>mkkeywordhash.c</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** All the keywords of the SQL language are stored in a hash</span></span><br><span class=\"line\"><span class=\"comment\">** table composed of instances of the following structure.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> <span class=\"title\">Keyword</span>;</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> &#123;</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zName;         <span class=\"comment\">/* The keyword name */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zTokenType;    <span class=\"comment\">/* Token value for this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mask;            <span class=\"comment\">/* Code this keyword if non-zero */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> id;              <span class=\"comment\">/* Unique ID for this record */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hash;            <span class=\"comment\">/* Hash on the keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> offset;          <span class=\"comment\">/* Offset to start of name string */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> len;             <span class=\"comment\">/* Length of this keyword, not counting final \\000 */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> prefix;          <span class=\"comment\">/* Number of characters in prefix */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> longestSuffix;   <span class=\"comment\">/* Longest suffix that is a prefix on another word */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> iNext;           <span class=\"comment\">/* Index in aKeywordTable[] of next with same hash */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrId;        <span class=\"comment\">/* Id to another keyword this keyword is embedded in */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrOffset;    <span class=\"comment\">/* Offset into substrId for start of this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> zOrigName[<span class=\"number\">20</span>];  <span class=\"comment\">/* Original keyword name before processing */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><code>mkkeywordhash.c</code><code>mkkeywordhash</code><code>KeyWord</code><code>keywordhash.h</code></p>\n<ul>\n<li>char *zName:             </li>\n<li>char *zTokenType:      tokenize</li>\n<li>int mask:              mask</li>\n<li>int id:                idid</li>\n<li>int hash:              </li>\n<li>int offset:            </li>\n<li>int len:               </li>\n<li>int prefix:            </li>\n<li>int longestSuffix:     </li>\n<li>int iNext:             </li>\n<li>int substrId:          substrIdId</li>\n<li>int substrOffset:      substrIdsubstrOffset</li>\n<li>char zOrigName[20]:    </li>\n</ul>\n<p> aKeywordTable </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> Keyword aKeywordTable[] = &#123;</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ABORT&quot;</span>,            <span class=\"string\">&quot;TK_ABORT&quot;</span>,        CONFLICT|TRIGGER       &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ACTION&quot;</span>,           <span class=\"string\">&quot;TK_ACTION&quot;</span>,       FKEY                   &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ADD&quot;</span>,              <span class=\"string\">&quot;TK_ADD&quot;</span>,          ALTER                  &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;AFTER&quot;</span>,            <span class=\"string\">&quot;TK_AFTER&quot;</span>,        TRIGGER                &#125;,</span><br><span class=\"line\">  <span class=\"comment\">/* ... 136 ... */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code> main</p>\n<p> aKeywordTable  <code>Keyword</code> maskmasktagmaskmaskmaskmaskSQLitemask</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_OMIT_ALTERTABLE</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0x00000001</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n\n<p><code>SQLITE_OMIT_ALTERTABLE</code><code>ALTER</code>0<code>ALTER</code>maskmask0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Remove entries from the list of keywords that have mask==0 */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=j=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( aKeywordTable[i].mask==<span class=\"number\">0</span> ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j&lt;i )&#123;</span><br><span class=\"line\">      aKeywordTable[j] = aKeywordTable[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    j++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">nKeyword = j;</span><br></pre></td></tr></table></figure>\n<p> akeywordTable mask0</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">    p-&gt;len = (<span class=\"type\">int</span>)<span class=\"built_in\">strlen</span>(p-&gt;zName);</span><br><span class=\"line\">    assert( p-&gt;len&lt;<span class=\"keyword\">sizeof</span>(p-&gt;zOrigName) );</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(p-&gt;zOrigName, p-&gt;zName, p-&gt;len+<span class=\"number\">1</span>);</span><br><span class=\"line\">    totalLen += p-&gt;len;</span><br><span class=\"line\">    p-&gt;hash = (charMap(p-&gt;zName[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^</span><br><span class=\"line\">              (charMap(p-&gt;zName[p-&gt;len<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ (p-&gt;len*<span class=\"number\">1</span>);</span><br><span class=\"line\">    p-&gt;id = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>aKeywordTablenKeywordSQLite</p>\n<ul>\n<li>id</li>\n<li>p-&gt;len </li>\n<li>p-&gt;zOrigName  p-&gt;zName </li>\n<li>:(<em>4)^(</em>3)^()) aKeywordTable</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ABABAB</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Sort the table from shortest to longest keyword */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\">qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare1);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Look for short keywords embedded in longer keywords */</span></span><br><span class=\"line\"><span class=\"comment\">/* ,ININDEXINDEXINDEXED*/</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword<span class=\"number\">-2</span>; i&gt;=<span class=\"number\">0</span>; i--)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];<span class=\"comment\">//p: </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=nKeyword<span class=\"number\">-1</span>; j&gt;i &amp;&amp; p-&gt;substrId==<span class=\"number\">0</span>; j--)&#123;<span class=\"comment\">//()</span></span><br><span class=\"line\">        Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=p-&gt;len ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(k=<span class=\"number\">0</span>; k&lt;=pOther-&gt;len-p-&gt;len; k++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(p-&gt;zName, &amp;pOther-&gt;zName[k], p-&gt;len)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">                p-&gt;substrId = pOther-&gt;id;</span><br><span class=\"line\">                p-&gt;substrOffset = k;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ABAB</li>\n<li>ABAsubstrIdBIdAsubstrOffset</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the longestSuffix value for every word */</span></span><br><span class=\"line\"><span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *pOther;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j==i ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(k=p-&gt;longestSuffix+<span class=\"number\">1</span>; k&lt;p-&gt;len &amp;&amp; k&lt;pOther-&gt;len; k++)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p-&gt;longestSuffix = k;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Sort the table into reverse order by length */</span></span><br><span class=\"line\">  <span class=\"comment\">/*    */</span></span><br><span class=\"line\">  qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare2);</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Fill in the offset for all entries */</span></span><br><span class=\"line\">nChar = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;offset&gt;<span class=\"number\">0</span> || p-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">  p-&gt;offset = nChar;</span><br><span class=\"line\">  nChar += p-&gt;len;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(k=p-&gt;len<span class=\"number\">-1</span>; k&gt;=<span class=\"number\">1</span>; k--)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=i+<span class=\"number\">1</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">      Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;offset&gt;<span class=\"number\">0</span> || pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=k ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p = pOther;</span><br><span class=\"line\">        p-&gt;offset = nChar - k;</span><br><span class=\"line\">        nChar = p-&gt;offset + p-&gt;len;</span><br><span class=\"line\">        p-&gt;zName += k;</span><br><span class=\"line\">        p-&gt;len -= k;</span><br><span class=\"line\">        p-&gt;prefix = k;</span><br><span class=\"line\">        j = i;</span><br><span class=\"line\">        k = p-&gt;len;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"comment\">//subStrId</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId )&#123;</span><br><span class=\"line\">    p-&gt;offset = findById(p-&gt;substrId)-&gt;offset + p-&gt;substrOffset;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>: </p>\n<p>:<code>abcde``def``efg</code>,<code>def</code><code>de</code><code>abcde</code><code>f</code>3</p>\n<p></p>\n<p>:</p>\n<ol>\n<li></li>\n<li>(<code>k=p-&gt;len-1</code>)break</li>\n</ol>\n<p></p>\n<ul>\n<li>SQLiteSQLite</li>\n<li><code>p = pOther;</code>ppOtherpOther</li>\n<li>check(i&#x3D;&#x3D;nKeyword)</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><em></em><em></em></p>\n<p>size</p>\n<p>SQLitebestCountscore()</p>\n<p>  * 1+ * 2 1+2&#x3D;1SQLite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Figure out how big to make the hash table in order to minimize the</span></span><br><span class=\"line\"><span class=\"comment\">** number of collisions */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\"><span class=\"comment\">// SQLite  [nKeyword, 2*nKeyword]</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\">bestSize = nKeyword;</span><br><span class=\"line\">bestCount = nKeyword*nKeyword;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword/<span class=\"number\">2</span>; i&lt;=<span class=\"number\">2</span>*nKeyword; i++)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;i; j++) aKWHash[j] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">    h = aKeywordTable[j].hash % i;</span><br><span class=\"line\">    aKWHash[h] *= <span class=\"number\">2</span>;</span><br><span class=\"line\">    aKWHash[h]++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=count=<span class=\"number\">0</span>; j&lt;i; j++) count += aKWHash[j];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( count&lt;bestCount )&#123;</span><br><span class=\"line\">    bestCount = count;</span><br><span class=\"line\">    bestSize = i;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>SQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount</p>\n<p></p>\n<ol>\n<li>aKWHash0</li>\n<li></li>\n<li><em>2 + 111</em>2+1&#x3D;33*2+1&#x3D;7</li>\n<li>aKWHashaKWHashscore</li>\n<li>[nKeyword, 2 x nKeyword]score</li>\n</ol>\n<p> x2  x2 score2  345</p>\n<p><code>keywordhash.h</code><code>Hash score</code>, (3.27.2) 2 <code>Hash score</code><em>208</em></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the hash */</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;bestSize; i++) aKWHash[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//..</span></span><br><span class=\"line\">    h = aKeywordTable[i].hash % bestSize;</span><br><span class=\"line\">    aKeywordTable[i].iNext = aKWHash[h];</span><br><span class=\"line\">    aKWHash[h] = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>bestSize -&gt; bestCount -&gt; </p>\n<p>+1<code>iNext</code>next</p>\n<p></p>\n<p><code>aKeywordTable</code>N</p>\n<p><code>zKWText</code>: <code>aKeywordTable</code><code>KeyWord</code><code>zName</code><br><code>aKWHash</code>: ()<br><code>aKWNext</code>: <br><code>aKWLen</code> : i<br><code>aKWOffset</code> : <code>zKWText</code><br><code>aKWCode</code> : <code>parser</code></p>\n<h2 id=\"-keywordCode\"><a href=\"#-keywordCode\" class=\"headerlink\" title=\"(keywordCode)\"></a>(keywordCode)</h2><p><code>keywordCode(const char *z, int n, int *pType)</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Check to see if z[0..n-1] is a keyword. If it is, write the</span></span><br><span class=\"line\"><span class=\"comment\">** parser symbol code for that keyword into *pType.  Always</span></span><br><span class=\"line\"><span class=\"comment\">** return the integer n (the length of the token). */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">keywordCode</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> n, <span class=\"type\">int</span> *pType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, j;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *zKW;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( n&gt;=<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">    i = ((charMap(z[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^ (charMap(z[n<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ n) % <span class=\"number\">127</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=((<span class=\"type\">int</span>)aKWHash[i])<span class=\"number\">-1</span>; i&gt;=<span class=\"number\">0</span>; i=((<span class=\"type\">int</span>)aKWNext[i])<span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( aKWLen[i]!=n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      j = <span class=\"number\">0</span>;</span><br><span class=\"line\">      zKW = &amp;zKWText[aKWOffset[i]];</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; (z[j]&amp;~<span class=\"number\">0x20</span>)==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_EBCDIC</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; <span class=\"built_in\">toupper</span>(z[j])==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>( j&lt;n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      testcase( i==<span class=\"number\">0</span> ); <span class=\"comment\">/* REINDEX */</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">1</span> ); <span class=\"comment\">/* INDEXED */</span></span><br><span class=\"line\">    <span class=\"comment\">//   ......</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">135</span> ); <span class=\"comment\">/* PRIMARY */</span></span><br><span class=\"line\">      *pType = aKWCode[i];</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>:(<code>parser</code>)n</p>\n<ol>\n<li>2</li>\n<li><code>i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127</code>127</li>\n<li>aKWHash[i]aKWNext</li>\n<li></li>\n<li>zKWText</li>\n<li>3</li>\n</ol>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLite (3.27.2136)SQLTokenize()SQLiteSQLiteSQLite</p>\n</blockquote>","more":"<h2 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h2><p>SQLitecmakeautoconfigMakefileMakefile<code>keywordhash.h</code>Makefilecommand</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">keywordhash.h:\t$(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t./mkkeywordhash &gt;keywordhash.h</span><br></pre></td></tr></table></figure>\n\n<p><code>$(TOP)/tool/mkkeywordhash.c</code>command:<code>mkkeywordhash.c</code><code>keywordhash.h</code><code>keywordhash.h</code><code>mkkeywordhash</code></p>\n<p><code>keywordhash.h</code>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">** The code in this file has been automatically generated by</span><br><span class=\"line\">**</span><br><span class=\"line\">**   sqlite/tool/mkkeywordhash.c</span><br><span class=\"line\">**</span><br><span class=\"line\">** The code in this file implements a function that determines whether</span><br><span class=\"line\">** or not a given identifier is really an SQL keyword.  The same thing</span><br><span class=\"line\">** might be implemented more directly using a hand-written hash table.</span><br><span class=\"line\">** But by using this automatically generated code, the size of the code</span><br><span class=\"line\">** is substantially reduced.  This is important <span class=\"keyword\">for</span> embedded applications</span><br><span class=\"line\">** on platforms with limited memory.</span><br></pre></td></tr></table></figure>\n\n<p>hand-written()SQLite</p>\n<h2 id=\"mkkeywordhash\"><a href=\"#mkkeywordhash\" class=\"headerlink\" title=\"mkkeywordhash\"></a>mkkeywordhash</h2><p>SQLiteSQLSQLite136<code>mkkeywordhash</code>:</p>\n<ol>\n<li>SQLite(mkkeywordhash)</li>\n<li><code>mkkeywordhash</code>:<code>REINDEX</code><code>INDEXED</code><code>INDEX</code><code>REINDEX</code></li>\n<li>SQLite<em></em></li>\n</ol>\n<p><em></em>SQLite</p>\n<p><code>mkkeywordhash.c</code>SQLite:</p>\n<h2 id=\"mkkeywordhash-c\"><a href=\"#mkkeywordhash-c\" class=\"headerlink\" title=\"mkkeywordhash.c\"></a>mkkeywordhash.c</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** All the keywords of the SQL language are stored in a hash</span></span><br><span class=\"line\"><span class=\"comment\">** table composed of instances of the following structure.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> <span class=\"title\">Keyword</span>;</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> &#123;</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zName;         <span class=\"comment\">/* The keyword name */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zTokenType;    <span class=\"comment\">/* Token value for this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mask;            <span class=\"comment\">/* Code this keyword if non-zero */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> id;              <span class=\"comment\">/* Unique ID for this record */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hash;            <span class=\"comment\">/* Hash on the keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> offset;          <span class=\"comment\">/* Offset to start of name string */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> len;             <span class=\"comment\">/* Length of this keyword, not counting final \\000 */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> prefix;          <span class=\"comment\">/* Number of characters in prefix */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> longestSuffix;   <span class=\"comment\">/* Longest suffix that is a prefix on another word */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> iNext;           <span class=\"comment\">/* Index in aKeywordTable[] of next with same hash */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrId;        <span class=\"comment\">/* Id to another keyword this keyword is embedded in */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrOffset;    <span class=\"comment\">/* Offset into substrId for start of this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> zOrigName[<span class=\"number\">20</span>];  <span class=\"comment\">/* Original keyword name before processing */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><code>mkkeywordhash.c</code><code>mkkeywordhash</code><code>KeyWord</code><code>keywordhash.h</code></p>\n<ul>\n<li>char *zName:             </li>\n<li>char *zTokenType:      tokenize</li>\n<li>int mask:              mask</li>\n<li>int id:                idid</li>\n<li>int hash:              </li>\n<li>int offset:            </li>\n<li>int len:               </li>\n<li>int prefix:            </li>\n<li>int longestSuffix:     </li>\n<li>int iNext:             </li>\n<li>int substrId:          substrIdId</li>\n<li>int substrOffset:      substrIdsubstrOffset</li>\n<li>char zOrigName[20]:    </li>\n</ul>\n<p> aKeywordTable </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> Keyword aKeywordTable[] = &#123;</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ABORT&quot;</span>,            <span class=\"string\">&quot;TK_ABORT&quot;</span>,        CONFLICT|TRIGGER       &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ACTION&quot;</span>,           <span class=\"string\">&quot;TK_ACTION&quot;</span>,       FKEY                   &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ADD&quot;</span>,              <span class=\"string\">&quot;TK_ADD&quot;</span>,          ALTER                  &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;AFTER&quot;</span>,            <span class=\"string\">&quot;TK_AFTER&quot;</span>,        TRIGGER                &#125;,</span><br><span class=\"line\">  <span class=\"comment\">/* ... 136 ... */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code> main</p>\n<p> aKeywordTable  <code>Keyword</code> maskmasktagmaskmaskmaskmaskSQLitemask</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_OMIT_ALTERTABLE</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0x00000001</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n\n<p><code>SQLITE_OMIT_ALTERTABLE</code><code>ALTER</code>0<code>ALTER</code>maskmask0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Remove entries from the list of keywords that have mask==0 */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=j=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( aKeywordTable[i].mask==<span class=\"number\">0</span> ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j&lt;i )&#123;</span><br><span class=\"line\">      aKeywordTable[j] = aKeywordTable[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    j++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">nKeyword = j;</span><br></pre></td></tr></table></figure>\n<p> akeywordTable mask0</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">    p-&gt;len = (<span class=\"type\">int</span>)<span class=\"built_in\">strlen</span>(p-&gt;zName);</span><br><span class=\"line\">    assert( p-&gt;len&lt;<span class=\"keyword\">sizeof</span>(p-&gt;zOrigName) );</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(p-&gt;zOrigName, p-&gt;zName, p-&gt;len+<span class=\"number\">1</span>);</span><br><span class=\"line\">    totalLen += p-&gt;len;</span><br><span class=\"line\">    p-&gt;hash = (charMap(p-&gt;zName[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^</span><br><span class=\"line\">              (charMap(p-&gt;zName[p-&gt;len<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ (p-&gt;len*<span class=\"number\">1</span>);</span><br><span class=\"line\">    p-&gt;id = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>aKeywordTablenKeywordSQLite</p>\n<ul>\n<li>id</li>\n<li>p-&gt;len </li>\n<li>p-&gt;zOrigName  p-&gt;zName </li>\n<li>:(<em>4)^(</em>3)^()) aKeywordTable</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ABABAB</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Sort the table from shortest to longest keyword */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\">qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare1);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Look for short keywords embedded in longer keywords */</span></span><br><span class=\"line\"><span class=\"comment\">/* ,ININDEXINDEXINDEXED*/</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword<span class=\"number\">-2</span>; i&gt;=<span class=\"number\">0</span>; i--)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];<span class=\"comment\">//p: </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=nKeyword<span class=\"number\">-1</span>; j&gt;i &amp;&amp; p-&gt;substrId==<span class=\"number\">0</span>; j--)&#123;<span class=\"comment\">//()</span></span><br><span class=\"line\">        Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=p-&gt;len ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(k=<span class=\"number\">0</span>; k&lt;=pOther-&gt;len-p-&gt;len; k++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(p-&gt;zName, &amp;pOther-&gt;zName[k], p-&gt;len)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">                p-&gt;substrId = pOther-&gt;id;</span><br><span class=\"line\">                p-&gt;substrOffset = k;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ABAB</li>\n<li>ABAsubstrIdBIdAsubstrOffset</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the longestSuffix value for every word */</span></span><br><span class=\"line\"><span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *pOther;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j==i ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(k=p-&gt;longestSuffix+<span class=\"number\">1</span>; k&lt;p-&gt;len &amp;&amp; k&lt;pOther-&gt;len; k++)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p-&gt;longestSuffix = k;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Sort the table into reverse order by length */</span></span><br><span class=\"line\">  <span class=\"comment\">/*    */</span></span><br><span class=\"line\">  qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare2);</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Fill in the offset for all entries */</span></span><br><span class=\"line\">nChar = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;offset&gt;<span class=\"number\">0</span> || p-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">  p-&gt;offset = nChar;</span><br><span class=\"line\">  nChar += p-&gt;len;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(k=p-&gt;len<span class=\"number\">-1</span>; k&gt;=<span class=\"number\">1</span>; k--)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=i+<span class=\"number\">1</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">      Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;offset&gt;<span class=\"number\">0</span> || pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=k ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p = pOther;</span><br><span class=\"line\">        p-&gt;offset = nChar - k;</span><br><span class=\"line\">        nChar = p-&gt;offset + p-&gt;len;</span><br><span class=\"line\">        p-&gt;zName += k;</span><br><span class=\"line\">        p-&gt;len -= k;</span><br><span class=\"line\">        p-&gt;prefix = k;</span><br><span class=\"line\">        j = i;</span><br><span class=\"line\">        k = p-&gt;len;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"comment\">//subStrId</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId )&#123;</span><br><span class=\"line\">    p-&gt;offset = findById(p-&gt;substrId)-&gt;offset + p-&gt;substrOffset;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>: </p>\n<p>:<code>abcde``def``efg</code>,<code>def</code><code>de</code><code>abcde</code><code>f</code>3</p>\n<p></p>\n<p>:</p>\n<ol>\n<li></li>\n<li>(<code>k=p-&gt;len-1</code>)break</li>\n</ol>\n<p></p>\n<ul>\n<li>SQLiteSQLite</li>\n<li><code>p = pOther;</code>ppOtherpOther</li>\n<li>check(i&#x3D;&#x3D;nKeyword)</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><em></em><em></em></p>\n<p>size</p>\n<p>SQLitebestCountscore()</p>\n<p>  * 1+ * 2 1+2&#x3D;1SQLite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Figure out how big to make the hash table in order to minimize the</span></span><br><span class=\"line\"><span class=\"comment\">** number of collisions */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\"><span class=\"comment\">// SQLite  [nKeyword, 2*nKeyword]</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\">bestSize = nKeyword;</span><br><span class=\"line\">bestCount = nKeyword*nKeyword;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword/<span class=\"number\">2</span>; i&lt;=<span class=\"number\">2</span>*nKeyword; i++)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;i; j++) aKWHash[j] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">    h = aKeywordTable[j].hash % i;</span><br><span class=\"line\">    aKWHash[h] *= <span class=\"number\">2</span>;</span><br><span class=\"line\">    aKWHash[h]++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=count=<span class=\"number\">0</span>; j&lt;i; j++) count += aKWHash[j];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( count&lt;bestCount )&#123;</span><br><span class=\"line\">    bestCount = count;</span><br><span class=\"line\">    bestSize = i;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>SQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount</p>\n<p></p>\n<ol>\n<li>aKWHash0</li>\n<li></li>\n<li><em>2 + 111</em>2+1&#x3D;33*2+1&#x3D;7</li>\n<li>aKWHashaKWHashscore</li>\n<li>[nKeyword, 2 x nKeyword]score</li>\n</ol>\n<p> x2  x2 score2  345</p>\n<p><code>keywordhash.h</code><code>Hash score</code>, (3.27.2) 2 <code>Hash score</code><em>208</em></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the hash */</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;bestSize; i++) aKWHash[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//..</span></span><br><span class=\"line\">    h = aKeywordTable[i].hash % bestSize;</span><br><span class=\"line\">    aKeywordTable[i].iNext = aKWHash[h];</span><br><span class=\"line\">    aKWHash[h] = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>bestSize -&gt; bestCount -&gt; </p>\n<p>+1<code>iNext</code>next</p>\n<p></p>\n<p><code>aKeywordTable</code>N</p>\n<p><code>zKWText</code>: <code>aKeywordTable</code><code>KeyWord</code><code>zName</code><br><code>aKWHash</code>: ()<br><code>aKWNext</code>: <br><code>aKWLen</code> : i<br><code>aKWOffset</code> : <code>zKWText</code><br><code>aKWCode</code> : <code>parser</code></p>\n<h2 id=\"-keywordCode\"><a href=\"#-keywordCode\" class=\"headerlink\" title=\"(keywordCode)\"></a>(keywordCode)</h2><p><code>keywordCode(const char *z, int n, int *pType)</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Check to see if z[0..n-1] is a keyword. If it is, write the</span></span><br><span class=\"line\"><span class=\"comment\">** parser symbol code for that keyword into *pType.  Always</span></span><br><span class=\"line\"><span class=\"comment\">** return the integer n (the length of the token). */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">keywordCode</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> n, <span class=\"type\">int</span> *pType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, j;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *zKW;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( n&gt;=<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">    i = ((charMap(z[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^ (charMap(z[n<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ n) % <span class=\"number\">127</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=((<span class=\"type\">int</span>)aKWHash[i])<span class=\"number\">-1</span>; i&gt;=<span class=\"number\">0</span>; i=((<span class=\"type\">int</span>)aKWNext[i])<span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( aKWLen[i]!=n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      j = <span class=\"number\">0</span>;</span><br><span class=\"line\">      zKW = &amp;zKWText[aKWOffset[i]];</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; (z[j]&amp;~<span class=\"number\">0x20</span>)==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_EBCDIC</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; <span class=\"built_in\">toupper</span>(z[j])==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>( j&lt;n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      testcase( i==<span class=\"number\">0</span> ); <span class=\"comment\">/* REINDEX */</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">1</span> ); <span class=\"comment\">/* INDEXED */</span></span><br><span class=\"line\">    <span class=\"comment\">//   ......</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">135</span> ); <span class=\"comment\">/* PRIMARY */</span></span><br><span class=\"line\">      *pType = aKWCode[i];</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>:(<code>parser</code>)n</p>\n<ol>\n<li>2</li>\n<li><code>i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127</code>127</li>\n<li>aKWHash[i]aKWNext</li>\n<li></li>\n<li>zKWText</li>\n<li>3</li>\n</ol>"},{"title":"Manacher -- LeetCode[5]","date":"2019-12-10T16:00:00.000Z","_content":"\n>   LeetCodeMedium\n\n\n\n\"\"Mangcher\n\n<!-- more -->\n\n> \n1.Manacher\n2.dp[i]=fn(dp[i-n])\n----->\n\n\n\n\n  i-1    i-1  \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png)\n\niManacher\n\n****dp[i]=fn(dp[i-n])ii\n\n i \n\ni  \n1. i \n2. i \n\n\nm i\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png)\n\n### \n\n\n\ni  c , s,  si\n\nc s  s c\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png)\n\n s c\n\n c  s  c', c si-(i-si) = 2*si - i\n\n\n**1.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png)\ndp[i] = dp[2*si-1]\nc c'\n\nc'  c  c' s\n c  c' \n\n**2.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png)\ndp[i] = (i-si)*2+1\n\nc  s \n\n  c  s  s \n c  s \n\n**3.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png)\ndp[i] = dp[2*si-i] + fn(si+1)\n\n c , c \n\n### \n\n i = s  + 1  c  \n\n### \n1. #if else 2*s+1.\n2. #\n3.  i-1 i-1 i  i-1 <i>\n\n****\n```go\nfunc longestPalindrome(s string) string {\n\tfs := formatString(s)\n\tr := coreCal(fs)\n\tret := cutString(r)\n\treturn ret\n}\n\n//#\nfunc formatString(s string) []byte {\n\tc := byte('#')\n\tos := []byte(s)\n\tns := make([]byte, 2*len(s)+1)\n\tns[0] = c\n\tfor index := 0; index < len(s)*2+1; index++ {\n\t\tif index%2 == 0 {\n\t\t\tns[index] = c\n\t\t} else {\n\t\t\tns[index] = os[index/2]\n\t\t}\n\t}\n\n\treturn ns\n}\n\n// #\nfunc cutString(s []byte) string {\n\trs := make([]byte, len(s)/2)\n\tc := byte('#')\n\tfor index := 0; index < len(s); index++ {\n\t\tif s[index] != c {\n\t\t\trs[index/2] = s[index]\n\t\t}\n\t}\n\n\treturn string(rs)\n}\n\n//\nfunc coreCal(fs []byte) []byte {\n\t// fs.len \n\tdp := make([]int, len(fs))\n\n\tvar longestString []byte\n\n\trightEdge := -1\n\tsi := 0\n\n\tfor i := 0; i < len(fs); i++ {\n\t\tif i > rightEdge {\n\t\t\tpLen := deepFind(fs, i-1, i+1)\n\n\t\t\tsi = i\n\t\t\trightEdge = si + pLen/2\n\n\t\t\tif pLen > len(longestString) {\n\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t}\n\n\t\t\tdp[i] = pLen\n\t\t} else {\n\t\t\tii := 2*si - i //\n\t\t\tiiLeft := ii - dp[ii]/2\n\n\t\t\tsiLeft := si - dp[si]/2\n\t\t\tsiRight := si + dp[si]/2\n\n\t\t\tif iiLeft > siLeft {\n\t\t\t\tdp[i] = dp[ii]\n\t\t\t} else if iiLeft < siLeft {\n\t\t\t\tdp[i] = 2*(siRight-i) + 1\n\t\t\t} else {\n\t\t\t\tpLen := deepFind(fs, 2*i-siRight-1, siRight+1)\n\n\t\t\t\tsi = i\n\t\t\t\trightEdge = si + pLen/2\n\n\t\t\t\tif pLen > len(longestString) {\n\t\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t\t}\n\n\t\t\t\tdp[i] = pLen\n\t\t\t}\n\t\t}\n\t}\n\n\treturn longestString\n}\n\n//left=l,right=r\nfunc deepFind(fs []byte, l int, r int) int {\n\tfor l >= 0 && r < len(fs) {\n\t\tif fs[l] != fs[r] {\n\t\t\tbreak\n\t\t}\n\t\tl--\n\t\tr++\n\t}\n\n\treturn r - l - 1\n}\n```","source":"_posts/2.leetcode5.md","raw":"---\ntitle: Manacher -- LeetCode[5]\ndate: 2019-12-11\ntags: [leetcode,]\ncategories: \n---\n\n>   LeetCodeMedium\n\n\n\n\"\"Mangcher\n\n<!-- more -->\n\n> \n1.Manacher\n2.dp[i]=fn(dp[i-n])\n----->\n\n\n\n\n  i-1    i-1  \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png)\n\niManacher\n\n****dp[i]=fn(dp[i-n])ii\n\n i \n\ni  \n1. i \n2. i \n\n\nm i\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png)\n\n### \n\n\n\ni  c , s,  si\n\nc s  s c\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png)\n\n s c\n\n c  s  c', c si-(i-si) = 2*si - i\n\n\n**1.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png)\ndp[i] = dp[2*si-1]\nc c'\n\nc'  c  c' s\n c  c' \n\n**2.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png)\ndp[i] = (i-si)*2+1\n\nc  s \n\n  c  s  s \n c  s \n\n**3.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png)\ndp[i] = dp[2*si-i] + fn(si+1)\n\n c , c \n\n### \n\n i = s  + 1  c  \n\n### \n1. #if else 2*s+1.\n2. #\n3.  i-1 i-1 i  i-1 <i>\n\n****\n```go\nfunc longestPalindrome(s string) string {\n\tfs := formatString(s)\n\tr := coreCal(fs)\n\tret := cutString(r)\n\treturn ret\n}\n\n//#\nfunc formatString(s string) []byte {\n\tc := byte('#')\n\tos := []byte(s)\n\tns := make([]byte, 2*len(s)+1)\n\tns[0] = c\n\tfor index := 0; index < len(s)*2+1; index++ {\n\t\tif index%2 == 0 {\n\t\t\tns[index] = c\n\t\t} else {\n\t\t\tns[index] = os[index/2]\n\t\t}\n\t}\n\n\treturn ns\n}\n\n// #\nfunc cutString(s []byte) string {\n\trs := make([]byte, len(s)/2)\n\tc := byte('#')\n\tfor index := 0; index < len(s); index++ {\n\t\tif s[index] != c {\n\t\t\trs[index/2] = s[index]\n\t\t}\n\t}\n\n\treturn string(rs)\n}\n\n//\nfunc coreCal(fs []byte) []byte {\n\t// fs.len \n\tdp := make([]int, len(fs))\n\n\tvar longestString []byte\n\n\trightEdge := -1\n\tsi := 0\n\n\tfor i := 0; i < len(fs); i++ {\n\t\tif i > rightEdge {\n\t\t\tpLen := deepFind(fs, i-1, i+1)\n\n\t\t\tsi = i\n\t\t\trightEdge = si + pLen/2\n\n\t\t\tif pLen > len(longestString) {\n\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t}\n\n\t\t\tdp[i] = pLen\n\t\t} else {\n\t\t\tii := 2*si - i //\n\t\t\tiiLeft := ii - dp[ii]/2\n\n\t\t\tsiLeft := si - dp[si]/2\n\t\t\tsiRight := si + dp[si]/2\n\n\t\t\tif iiLeft > siLeft {\n\t\t\t\tdp[i] = dp[ii]\n\t\t\t} else if iiLeft < siLeft {\n\t\t\t\tdp[i] = 2*(siRight-i) + 1\n\t\t\t} else {\n\t\t\t\tpLen := deepFind(fs, 2*i-siRight-1, siRight+1)\n\n\t\t\t\tsi = i\n\t\t\t\trightEdge = si + pLen/2\n\n\t\t\t\tif pLen > len(longestString) {\n\t\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t\t}\n\n\t\t\t\tdp[i] = pLen\n\t\t\t}\n\t\t}\n\t}\n\n\treturn longestString\n}\n\n//left=l,right=r\nfunc deepFind(fs []byte, l int, r int) int {\n\tfor l >= 0 && r < len(fs) {\n\t\tif fs[l] != fs[r] {\n\t\t\tbreak\n\t\t}\n\t\tl--\n\t\tr++\n\t}\n\n\treturn r - l - 1\n}\n```","slug":"2.leetcode5","published":1,"updated":"2020-08-29T14:42:58.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61c000melc912on02xt","content":"<blockquote>\n<p>  LeetCodeMedium</p>\n</blockquote>\n<p></p>\n<p>Mangcher</p>\n<span id=\"more\"></span>\n\n<blockquote>\n<p><br>1.Manacher<br>2.dp[i]&#x3D;fn(dp[i-n])<br>&gt;</p>\n</blockquote>\n<p></p>\n<p>  i-1    i-1  </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png\"></p>\n<p>iManacher</p>\n<p><strong></strong>dp[i]&#x3D;fn(dp[i-n])ii</p>\n<p> i </p>\n<p>i  </p>\n<ol>\n<li>i </li>\n<li>i </li>\n</ol>\n<p><br>m i<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>i  c , s,  si</p>\n<p>c s  s c<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png\"></p>\n<p> s c</p>\n<p> c  s  c, c si-(i-si) &#x3D; 2*si - i<br></p>\n<p><strong>1.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png\"><br>dp[i] &#x3D; dp[2*si-1]<br>c c</p>\n<p>c  c  c s<br> c  c </p>\n<p><strong>2.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png\"><br>dp[i] &#x3D; (i-si)*2+1</p>\n<p>c  s </p>\n<p>  c  s  s <br> c  s </p>\n<p><strong>3.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png\"><br>dp[i] &#x3D; dp[2*si-i] + fn(si+1)</p>\n<p> c , c </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> i &#x3D; s  + 1  c  </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li>#if else 2*s+1.</li>\n<li>#</li>\n<li> i-1 i-1 i  i-1 &lt;i&gt;</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">longestPalindrome</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\tfs := formatString(s)</span><br><span class=\"line\">\tr := coreCal(fs)</span><br><span class=\"line\">\tret := cutString(r)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//#</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">formatString</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\tos := []<span class=\"type\">byte</span>(s)</span><br><span class=\"line\">\tns := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"number\">2</span>*<span class=\"built_in\">len</span>(s)+<span class=\"number\">1</span>)</span><br><span class=\"line\">\tns[<span class=\"number\">0</span>] = c</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s)*<span class=\"number\">2</span>+<span class=\"number\">1</span>; index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> index%<span class=\"number\">2</span> == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = c</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = os[index/<span class=\"number\">2</span>]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ns</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// #</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">cutString</span><span class=\"params\">(s []<span class=\"type\">byte</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\trs := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"built_in\">len</span>(s)/<span class=\"number\">2</span>)</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s); index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> s[index] != c &#123;</span><br><span class=\"line\">\t\t\trs[index/<span class=\"number\">2</span>] = s[index]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">string</span>(rs)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">coreCal</span><span class=\"params\">(fs []<span class=\"type\">byte</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// fs.len </span></span><br><span class=\"line\">\tdp := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"built_in\">len</span>(fs))</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> longestString []<span class=\"type\">byte</span></span><br><span class=\"line\"></span><br><span class=\"line\">\trightEdge := <span class=\"number\">-1</span></span><br><span class=\"line\">\tsi := <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(fs); i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i &gt; rightEdge &#123;</span><br><span class=\"line\">\t\t\tpLen := deepFind(fs, i<span class=\"number\">-1</span>, i+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsi = i</span><br><span class=\"line\">\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tii := <span class=\"number\">2</span>*si - i <span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\tiiLeft := ii - dp[ii]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsiLeft := si - dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\">\t\t\tsiRight := si + dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> iiLeft &gt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = dp[ii]</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> iiLeft &lt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = <span class=\"number\">2</span>*(siRight-i) + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tpLen := deepFind(fs, <span class=\"number\">2</span>*i-siRight<span class=\"number\">-1</span>, siRight+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tsi = i</span><br><span class=\"line\">\t\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> longestString</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//left=l,right=r</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">deepFind</span><span class=\"params\">(fs []<span class=\"type\">byte</span>, l <span class=\"type\">int</span>, r <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> l &gt;= <span class=\"number\">0</span> &amp;&amp; r &lt; <span class=\"built_in\">len</span>(fs) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> fs[l] != fs[r] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tl--</span><br><span class=\"line\">\t\tr++</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> r - l - <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<blockquote>\n<p>  LeetCodeMedium</p>\n</blockquote>\n<p></p>\n<p>Mangcher</p>","more":"<blockquote>\n<p><br>1.Manacher<br>2.dp[i]&#x3D;fn(dp[i-n])<br>&gt;</p>\n</blockquote>\n<p></p>\n<p>  i-1    i-1  </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png\"></p>\n<p>iManacher</p>\n<p><strong></strong>dp[i]&#x3D;fn(dp[i-n])ii</p>\n<p> i </p>\n<p>i  </p>\n<ol>\n<li>i </li>\n<li>i </li>\n</ol>\n<p><br>m i<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>i  c , s,  si</p>\n<p>c s  s c<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png\"></p>\n<p> s c</p>\n<p> c  s  c, c si-(i-si) &#x3D; 2*si - i<br></p>\n<p><strong>1.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png\"><br>dp[i] &#x3D; dp[2*si-1]<br>c c</p>\n<p>c  c  c s<br> c  c </p>\n<p><strong>2.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png\"><br>dp[i] &#x3D; (i-si)*2+1</p>\n<p>c  s </p>\n<p>  c  s  s <br> c  s </p>\n<p><strong>3.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png\"><br>dp[i] &#x3D; dp[2*si-i] + fn(si+1)</p>\n<p> c , c </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> i &#x3D; s  + 1  c  </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li>#if else 2*s+1.</li>\n<li>#</li>\n<li> i-1 i-1 i  i-1 &lt;i&gt;</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">longestPalindrome</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\tfs := formatString(s)</span><br><span class=\"line\">\tr := coreCal(fs)</span><br><span class=\"line\">\tret := cutString(r)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//#</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">formatString</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\tos := []<span class=\"type\">byte</span>(s)</span><br><span class=\"line\">\tns := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"number\">2</span>*<span class=\"built_in\">len</span>(s)+<span class=\"number\">1</span>)</span><br><span class=\"line\">\tns[<span class=\"number\">0</span>] = c</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s)*<span class=\"number\">2</span>+<span class=\"number\">1</span>; index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> index%<span class=\"number\">2</span> == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = c</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = os[index/<span class=\"number\">2</span>]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ns</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// #</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">cutString</span><span class=\"params\">(s []<span class=\"type\">byte</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\trs := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"built_in\">len</span>(s)/<span class=\"number\">2</span>)</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s); index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> s[index] != c &#123;</span><br><span class=\"line\">\t\t\trs[index/<span class=\"number\">2</span>] = s[index]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">string</span>(rs)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">coreCal</span><span class=\"params\">(fs []<span class=\"type\">byte</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// fs.len </span></span><br><span class=\"line\">\tdp := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"built_in\">len</span>(fs))</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> longestString []<span class=\"type\">byte</span></span><br><span class=\"line\"></span><br><span class=\"line\">\trightEdge := <span class=\"number\">-1</span></span><br><span class=\"line\">\tsi := <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(fs); i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i &gt; rightEdge &#123;</span><br><span class=\"line\">\t\t\tpLen := deepFind(fs, i<span class=\"number\">-1</span>, i+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsi = i</span><br><span class=\"line\">\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tii := <span class=\"number\">2</span>*si - i <span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\tiiLeft := ii - dp[ii]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsiLeft := si - dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\">\t\t\tsiRight := si + dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> iiLeft &gt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = dp[ii]</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> iiLeft &lt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = <span class=\"number\">2</span>*(siRight-i) + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tpLen := deepFind(fs, <span class=\"number\">2</span>*i-siRight<span class=\"number\">-1</span>, siRight+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tsi = i</span><br><span class=\"line\">\t\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> longestString</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//left=l,right=r</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">deepFind</span><span class=\"params\">(fs []<span class=\"type\">byte</span>, l <span class=\"type\">int</span>, r <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> l &gt;= <span class=\"number\">0</span> &amp;&amp; r &lt; <span class=\"built_in\">len</span>(fs) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> fs[l] != fs[r] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tl--</span><br><span class=\"line\">\t\tr++</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> r - l - <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"The Virtual Machine Module","date":"2020-06-28T16:00:00.000Z","_content":"\nSQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+\n\n<!-- more -->\n\n****\n\n* 5\n* SQL\n* SQLC\n* \n* \n\n# \n\nSQLiteVMVMSQLite()VMSQLiteVMVMB+\"\"\n\nSQLiteVMVMSQLVMSQLiteSQL\n\n****:VM--SQLite\n\n`sqlite3_stmt`(Vdbe)SQLite API SQL\n\n1. sqlite3_bind_*:SQL\n2. sqlite3_step:\n3. sqlite3_reset:\n4. sqlite3_column_*:\n5. sqlite3_finalize:sqlite3_stmt\n\nVdbe\n* \n* \n* \n* \n* \n* (BTree...)\n\nVMVM\n\n## \n\nSQLiteJava5<opcode,P1,P2,P3,P4,P5>,opcodeP1,P2,P3,P4,P532P2P432/6464SQLP55\n\n****\nVMSQLiteSQLiteSQLite\n\n`SELECT * FROM t1`x,y0\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png)\n\n### \n\n14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B/ B+, (ii)    B/B+ , (iii)     key, (iv),(v),  B/B+ ,(vi),    (a)rowid,(b)n(c)i\n\nVdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp\n\nSQLite[SQLite](http://www.sqlite.org/opcode.html)SQLiteOP_\n\n1. Trace: SQLitetracing modeP4(UTF8)`sqlite3_trace`API\n2. Goto: P2VMP2\n3. OpenRead: B/B+root pageP2P50P2pageP2P3--011P1()P4KeyInfoBSQLKeyInfo  P4\n    \nSQLITE_BUSY\n4. RewindP1P2 > 0,P2\n5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3\n6. MakeRecordP1P2keyP1P1+1\n7. ResultRow: P1P1+P2-1`sqlite_step`SQLITE_ROW\n8. Next: P1P2\n9. Close: P1P1\n10. Halt: FIFOsRowSetP1`sqlite3_exec`,`sqlite3_reset`,`sqlite3_finalize`APISQLITE_OK(=0)P1!=0P2P2=OE_FailP2=OE_RollbackP2=OE_AbortP4\n\n`Halt 0 0 0 0 0`\n11. Transaction: P1011P20P2P22\n12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead / Open Write\n13. TableLock: P1pageP2P30P31P4\n\nSQL insert joinVMSQL\n\n### \n\nT1c1 textc2 integer;`insert into T1 values('Hello,Wold!', 2000)`VM:\n\n1. \n2. schema\n3. \"T1\"B+\n4. rowid'Hello,Wold!'2000\n5. B+\n6. \n7. \n\nT1VM\n\n### \n\nSQLiteFROM\n\nSQL : `select * from t1, t2 where ...`\n\n1. \n2. schema\n3. T1t2\n4. \n``` c\nfor each record in T1, do:\n    for each record in T2, do:\n        if WHERETRUE\n            \n            \n            \n```\n5. \n\n### \n\nVM0(1)(2)(2)\n\nCVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\n`sqlite3_prepare`API`sqlite3_stmt`Vbe()VM`aOp``nMem``aMem`\n\n|  |  |\n| ---- | ---- |\n| db | sqlite3 |\n| aOp | VM |\n| nOp | aOp |\n| apCsr |  |\n| nCursor | apCsr |\n| aMem |  |\n| nMem | aMem |\n| rc |  |\n| pc |  |\n| ... |  |\n\nVM(Tree`BtCursors`)keyVMkey/value\n\nVMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM\n\n|  |  |\n| ---- | ---- |\n| pCursor | (BtCursor) |\n| iDb |  |\n| pBt |  |\n| pKeyInfo | key |\n| aType |  |\n| aOffset |  |\n| aRow | (page) |\n| ... |  |\n\n## \n\nVMVM:\n1. INTEGER: \n2. REAL: \n3. TEXT: \n4. BLOB: \n5. NULL: SQL NULL\n\nVM5123BLOBNULLSQLiteSQLite`typeof`--`select a,typeof(a) from t1`a`sqlite3_step`API`sqlite3_column_type`\n\nVMMemMem(Mem): (Vbe.aMemaMem)\n\n|  |  |\n| ---- | ---- |\n| type | Mem |\n| i |  |\n| r |  |\n| z |  |\n| n | z |\n| enc | zUTF |\n| ... |  |\n\n## \n\nVMBB+keyvalueVM(TreeVM)VM\n\ndata/keySQLitebytesSQLite\n\n\n### \n\nSQL:SQLiteSQLite(`integer primary key`[-2^63, 2^63-1])\n\n### \n\nNULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\n**:**89\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\n### \n\nsize(SQLite)\n\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\nHeader sizeData164integerData1header sizeType i2^64Data i\n\n**:**08912130\n\n### key\n\nSQLiteB+-TreekeySQLiterowid\n\n#### Rowid\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,_rowid_),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+\n\n#### Rowid\n\nrowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL\n\n#### Rowid\n\nRowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite\n\n### key\n\nB+keykeyrowidVMrowidB+SQLite\n\nSQLiteB''BrowidBVMTree\n\nSQLitecreate`UNIQUE``PRIMARY KEY``CREATE INDEX`SQLiteT1(a,b,c)a,b\n\n1. \n* `CREATE TABLE T1(a,b,c)`\n* `CREATE INDEX idx1 ON T1(a,b)`\n2. \n* `CREATE TABLE T1(a,b,c,UNIQUE(a,b))`\n3. \n* `CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))`\n\n**:**`INTEGER PRIMARY KEY`B+rowid\n\nSQLite\n`CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);`\n`CREATE INDEX idx2 ON T2(x);`\n\nSQLitex`PRIMARY KEY`,`UNIQUE``INSERT`,`UPDATE``DELETE`\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteBrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ---- |\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nB+\n\n**:**SQLiteSQLorder bygroup byexceptunionintersect\n\n## \n\nSQLiteVMVMVMSQLiteSQLiteVMVM\n\n### \n\nSQLite:(1)SQL,(2)(VM)VM\n\nVMSQLSQLiteINTEGERREALTEXT(SQL)\n\n#### \n\nSQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL`create table T1(a,b,c)`SQLiteSQLVM\n\nVMSQLite\n\n1. SQL:\n    * TEXT\n    * INTEGER\n    * REAL\n    * NULLNULL\n    * X'ABCD'BLOB(ABCD)\n\n    VM\n2. `sqlite3_bind_*`APISQL`sqlite3_bind_blob`BLOB\n\nSQLSQLVM\n\n#### \n\nSQLiteSQLSQLiteSQLiteSQLiteSQL\"\"\n\n5:TEXT,NUMERIC,INTEGER,REALNONE`CREATE TABLE`SQLSQLite\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE\n\n**:**`create table table1 as select ...`SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  \"\"SQL NULLrowidNULL\n\n#### \n\nSQLiteVM:\n\n1. TEXTNULL,TEXT,BLOB()TEXT\n2. NUMERIC5VM()TEXTVMNULLBLOB\n3. INTEGERNUMERIC:VMINTEGER\n4. REALNUMERIC:(SQLite)\n5. NONE5\n\n**:**SQLSQLiteSQL(123\"abc\"),VM()TEXTTEXTASCII\n\n#### \n\nT1B+(a,b,c)NULLNONEVM(+)11(SQLite:)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png)\n\n1. :\n2. 122\n3. 20NULL\n4. 322(22-12)/2=5\n5. 1200B1,177(177B1-79)\n6. 2NULL\n7. 35 68 65 6C 6C 6F\n\n#### \n\nSQL`create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)`SQL`insert into T1 values('1.0', '1.0', '1.0', '1.0', '1.0')`TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC'1.0'1NONE`insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)`REALTEXTINTEGERINTEGERREAL  REALTEXT1.0\"1.0\"TEXT`insert into T1 values(1, 1, 1, 1, 1)`INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER[](http://www.sqlite.org/datatype3.html.)\n\n#### \n\n''SQLite\n\n* **** \n* **** VM\n\n### \n\n`sqlite3_column_*`APISQLiteREALAPI`sqlite3_column_text`VMsprintf()VM\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER | 0 |\n| NULL | FLOAT | 0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() |\n| TEXT | FLOAT | atof() |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | TEXTatoi() |\n| BLOB | FLOAT | TEXTatof() |\n| BLOB | TEXT | \\000 |\n\n### \n\nVMVM\n\n#### SQL NULL\n\nSQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n#### \n\nSQLite\n\n*  =, ==, <, <=, >, >=, <>,  !=\n*  'BETWEEN'\n*  'IN'  'NOT IN'\n*  'IS NULL'  'IS NOT NULL'\n\n**:**'IS NULL''IS NOT NULL''=''!='\n\n\n1. NULLNULLNULL\n2. INTEGERREALTEXTBLOB\n3. INTEGERREALINTEGERREAL\n4. TEXTBLOB\n5. TEXTCmemcmp\n6. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL\n\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)` = (,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n[](http://www.sqlite.org/datatype3.html)`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)``INSERT INTO t1 VALUES(500500500, 500)`a,b,cTEXTINTEGERTEXT  INTEGER\n\n* `SELECT a < 600, a < 60, a < 40 FROM t1`600,6040\"600\",\"60\"\"40\"aTEXTTEXT`1|1|0`\"500\"\"600\"\"60\"\"40\"\n* `SELECT b < 40, b < 60, b < 600 FROM t1``0|0|1`\n* `SELECT c < 40, c < 60, c < 600 FROM t1`cNONE(NUMERIC)\"500\"(TEXT)`0|0|0`\n* `SELECT d < 40, d < 60, d < 600 FROM t1`dNUMERIC`0|0|1`\n\n#### \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### order by\n\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### group by\n\nGROUP BYINTEGERREALGROUP BY\n\n#### SELECTs\nSELECT(UNIONINTERSECTEXCEPT)VM\n\n# \nVM5\n\n`Vdbe`(`sqlite3_stmt`)SQLite API`sqlite3_step`API\n\nVMinteger,real,text,blobSQL NULLVMtypeof SQL\n\nVMSQLiteSQL\n\nSQLiteSQLiteSQL SQLite","source":"_posts/18.db-system-design-imp(VM).md","raw":"---\ntitle: The Virtual Machine Module\ndate: 2020-06-29\ntags: [sqlite3]\ncategories: sqlite3\n---\n\nSQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+\n\n<!-- more -->\n\n****\n\n* 5\n* SQL\n* SQLC\n* \n* \n\n# \n\nSQLiteVMVMSQLite()VMSQLiteVMVMB+\"\"\n\nSQLiteVMVMSQLVMSQLiteSQL\n\n****:VM--SQLite\n\n`sqlite3_stmt`(Vdbe)SQLite API SQL\n\n1. sqlite3_bind_*:SQL\n2. sqlite3_step:\n3. sqlite3_reset:\n4. sqlite3_column_*:\n5. sqlite3_finalize:sqlite3_stmt\n\nVdbe\n* \n* \n* \n* \n* \n* (BTree...)\n\nVMVM\n\n## \n\nSQLiteJava5<opcode,P1,P2,P3,P4,P5>,opcodeP1,P2,P3,P4,P532P2P432/6464SQLP55\n\n****\nVMSQLiteSQLiteSQLite\n\n`SELECT * FROM t1`x,y0\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png)\n\n### \n\n14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B/ B+, (ii)    B/B+ , (iii)     key, (iv),(v),  B/B+ ,(vi),    (a)rowid,(b)n(c)i\n\nVdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp\n\nSQLite[SQLite](http://www.sqlite.org/opcode.html)SQLiteOP_\n\n1. Trace: SQLitetracing modeP4(UTF8)`sqlite3_trace`API\n2. Goto: P2VMP2\n3. OpenRead: B/B+root pageP2P50P2pageP2P3--011P1()P4KeyInfoBSQLKeyInfo  P4\n    \nSQLITE_BUSY\n4. RewindP1P2 > 0,P2\n5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3\n6. MakeRecordP1P2keyP1P1+1\n7. ResultRow: P1P1+P2-1`sqlite_step`SQLITE_ROW\n8. Next: P1P2\n9. Close: P1P1\n10. Halt: FIFOsRowSetP1`sqlite3_exec`,`sqlite3_reset`,`sqlite3_finalize`APISQLITE_OK(=0)P1!=0P2P2=OE_FailP2=OE_RollbackP2=OE_AbortP4\n\n`Halt 0 0 0 0 0`\n11. Transaction: P1011P20P2P22\n12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead / Open Write\n13. TableLock: P1pageP2P30P31P4\n\nSQL insert joinVMSQL\n\n### \n\nT1c1 textc2 integer;`insert into T1 values('Hello,Wold!', 2000)`VM:\n\n1. \n2. schema\n3. \"T1\"B+\n4. rowid'Hello,Wold!'2000\n5. B+\n6. \n7. \n\nT1VM\n\n### \n\nSQLiteFROM\n\nSQL : `select * from t1, t2 where ...`\n\n1. \n2. schema\n3. T1t2\n4. \n``` c\nfor each record in T1, do:\n    for each record in T2, do:\n        if WHERETRUE\n            \n            \n            \n```\n5. \n\n### \n\nVM0(1)(2)(2)\n\nCVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\n`sqlite3_prepare`API`sqlite3_stmt`Vbe()VM`aOp``nMem``aMem`\n\n|  |  |\n| ---- | ---- |\n| db | sqlite3 |\n| aOp | VM |\n| nOp | aOp |\n| apCsr |  |\n| nCursor | apCsr |\n| aMem |  |\n| nMem | aMem |\n| rc |  |\n| pc |  |\n| ... |  |\n\nVM(Tree`BtCursors`)keyVMkey/value\n\nVMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM\n\n|  |  |\n| ---- | ---- |\n| pCursor | (BtCursor) |\n| iDb |  |\n| pBt |  |\n| pKeyInfo | key |\n| aType |  |\n| aOffset |  |\n| aRow | (page) |\n| ... |  |\n\n## \n\nVMVM:\n1. INTEGER: \n2. REAL: \n3. TEXT: \n4. BLOB: \n5. NULL: SQL NULL\n\nVM5123BLOBNULLSQLiteSQLite`typeof`--`select a,typeof(a) from t1`a`sqlite3_step`API`sqlite3_column_type`\n\nVMMemMem(Mem): (Vbe.aMemaMem)\n\n|  |  |\n| ---- | ---- |\n| type | Mem |\n| i |  |\n| r |  |\n| z |  |\n| n | z |\n| enc | zUTF |\n| ... |  |\n\n## \n\nVMBB+keyvalueVM(TreeVM)VM\n\ndata/keySQLitebytesSQLite\n\n\n### \n\nSQL:SQLiteSQLite(`integer primary key`[-2^63, 2^63-1])\n\n### \n\nNULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\n**:**89\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\n### \n\nsize(SQLite)\n\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\nHeader sizeData164integerData1header sizeType i2^64Data i\n\n**:**08912130\n\n### key\n\nSQLiteB+-TreekeySQLiterowid\n\n#### Rowid\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,_rowid_),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+\n\n#### Rowid\n\nrowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL\n\n#### Rowid\n\nRowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite\n\n### key\n\nB+keykeyrowidVMrowidB+SQLite\n\nSQLiteB''BrowidBVMTree\n\nSQLitecreate`UNIQUE``PRIMARY KEY``CREATE INDEX`SQLiteT1(a,b,c)a,b\n\n1. \n* `CREATE TABLE T1(a,b,c)`\n* `CREATE INDEX idx1 ON T1(a,b)`\n2. \n* `CREATE TABLE T1(a,b,c,UNIQUE(a,b))`\n3. \n* `CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))`\n\n**:**`INTEGER PRIMARY KEY`B+rowid\n\nSQLite\n`CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);`\n`CREATE INDEX idx2 ON T2(x);`\n\nSQLitex`PRIMARY KEY`,`UNIQUE``INSERT`,`UPDATE``DELETE`\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteBrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ---- |\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nB+\n\n**:**SQLiteSQLorder bygroup byexceptunionintersect\n\n## \n\nSQLiteVMVMVMSQLiteSQLiteVMVM\n\n### \n\nSQLite:(1)SQL,(2)(VM)VM\n\nVMSQLSQLiteINTEGERREALTEXT(SQL)\n\n#### \n\nSQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL`create table T1(a,b,c)`SQLiteSQLVM\n\nVMSQLite\n\n1. SQL:\n    * TEXT\n    * INTEGER\n    * REAL\n    * NULLNULL\n    * X'ABCD'BLOB(ABCD)\n\n    VM\n2. `sqlite3_bind_*`APISQL`sqlite3_bind_blob`BLOB\n\nSQLSQLVM\n\n#### \n\nSQLiteSQLSQLiteSQLiteSQLiteSQL\"\"\n\n5:TEXT,NUMERIC,INTEGER,REALNONE`CREATE TABLE`SQLSQLite\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE\n\n**:**`create table table1 as select ...`SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  \"\"SQL NULLrowidNULL\n\n#### \n\nSQLiteVM:\n\n1. TEXTNULL,TEXT,BLOB()TEXT\n2. NUMERIC5VM()TEXTVMNULLBLOB\n3. INTEGERNUMERIC:VMINTEGER\n4. REALNUMERIC:(SQLite)\n5. NONE5\n\n**:**SQLSQLiteSQL(123\"abc\"),VM()TEXTTEXTASCII\n\n#### \n\nT1B+(a,b,c)NULLNONEVM(+)11(SQLite:)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png)\n\n1. :\n2. 122\n3. 20NULL\n4. 322(22-12)/2=5\n5. 1200B1,177(177B1-79)\n6. 2NULL\n7. 35 68 65 6C 6C 6F\n\n#### \n\nSQL`create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)`SQL`insert into T1 values('1.0', '1.0', '1.0', '1.0', '1.0')`TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC'1.0'1NONE`insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)`REALTEXTINTEGERINTEGERREAL  REALTEXT1.0\"1.0\"TEXT`insert into T1 values(1, 1, 1, 1, 1)`INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER[](http://www.sqlite.org/datatype3.html.)\n\n#### \n\n''SQLite\n\n* **** \n* **** VM\n\n### \n\n`sqlite3_column_*`APISQLiteREALAPI`sqlite3_column_text`VMsprintf()VM\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER | 0 |\n| NULL | FLOAT | 0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() |\n| TEXT | FLOAT | atof() |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | TEXTatoi() |\n| BLOB | FLOAT | TEXTatof() |\n| BLOB | TEXT | \\000 |\n\n### \n\nVMVM\n\n#### SQL NULL\n\nSQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n#### \n\nSQLite\n\n*  =, ==, <, <=, >, >=, <>,  !=\n*  'BETWEEN'\n*  'IN'  'NOT IN'\n*  'IS NULL'  'IS NOT NULL'\n\n**:**'IS NULL''IS NOT NULL''=''!='\n\n\n1. NULLNULLNULL\n2. INTEGERREALTEXTBLOB\n3. INTEGERREALINTEGERREAL\n4. TEXTBLOB\n5. TEXTCmemcmp\n6. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL\n\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)` = (,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n[](http://www.sqlite.org/datatype3.html)`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)``INSERT INTO t1 VALUES(500500500, 500)`a,b,cTEXTINTEGERTEXT  INTEGER\n\n* `SELECT a < 600, a < 60, a < 40 FROM t1`600,6040\"600\",\"60\"\"40\"aTEXTTEXT`1|1|0`\"500\"\"600\"\"60\"\"40\"\n* `SELECT b < 40, b < 60, b < 600 FROM t1``0|0|1`\n* `SELECT c < 40, c < 60, c < 600 FROM t1`cNONE(NUMERIC)\"500\"(TEXT)`0|0|0`\n* `SELECT d < 40, d < 60, d < 600 FROM t1`dNUMERIC`0|0|1`\n\n#### \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### order by\n\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### group by\n\nGROUP BYINTEGERREALGROUP BY\n\n#### SELECTs\nSELECT(UNIONINTERSECTEXCEPT)VM\n\n# \nVM5\n\n`Vdbe`(`sqlite3_stmt`)SQLite API`sqlite3_step`API\n\nVMinteger,real,text,blobSQL NULLVMtypeof SQL\n\nVMSQLiteSQL\n\nSQLiteSQLiteSQL SQLite","slug":"18.db-system-design-imp(VM)","published":1,"updated":"2020-08-31T07:16:13.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61d000oelc93ctb2jz1","content":"<p>SQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+</p>\n<span id=\"more\"></span>\n\n<p><strong></strong></p>\n<ul>\n<li>5</li>\n<li>SQL</li>\n<li>SQLC</li>\n<li></li>\n<li></li>\n</ul>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteVMVMSQLite()VMSQLiteVMVMB+</p>\n<p>SQLiteVMVMSQLVMSQLiteSQL</p>\n<p><strong></strong>:VMSQLite</p>\n<p><code>sqlite3_stmt</code>(Vdbe)SQLite API SQL</p>\n<ol>\n<li>sqlite3_bind_*:SQL</li>\n<li>sqlite3_step:</li>\n<li>sqlite3_reset:</li>\n<li>sqlite3_column_*:</li>\n<li>sqlite3_finalize:sqlite3_stmt</li>\n</ol>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>(BTree)</li>\n</ul>\n<p>VMVM</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteJava5&lt;opcode,P1,P2,P3,P4,P5&gt;,opcodeP1,P2,P3,P4,P532P2P432&#x2F;6464SQLP55</p>\n<p><strong></strong><br>VMSQLiteSQLiteSQLite</p>\n<p><code>SELECT * FROM t1</code>x,y0<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B&#x2F; B+, (ii)    B&#x2F;B+ , (iii)     key, (iv),(v),  B&#x2F;B+ ,(vi),    (a)rowid,(b)n(c)i</p>\n<p>VdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp</p>\n<p>SQLite<a href=\"http://www.sqlite.org/opcode.html\">SQLite</a>SQLiteOP_</p>\n<ol>\n<li>Trace: SQLitetracing modeP4(UTF8)<code>sqlite3_trace</code>API</li>\n<li>Goto: P2VMP2</li>\n<li>OpenRead: B&#x2F;B+root pageP2P50P2pageP2P3011P1()P4KeyInfoBSQLKeyInfo  P4</li>\n</ol>\n<p>SQLITE_BUSY<br>4. RewindP1P2 &gt; 0,P2<br>5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3<br>6. MakeRecordP1P2keyP1P1+1<br>7. ResultRow: P1P1+P2-1<code>sqlite_step</code>SQLITE_ROW<br>8. Next: P1P2<br>9. Close: P1P1<br>10. Halt: FIFOsRowSetP1<code>sqlite3_exec</code>,<code>sqlite3_reset</code>,<code>sqlite3_finalize</code>APISQLITE_OK(&#x3D;0)P1!&#x3D;0P2P2&#x3D;OE_FailP2&#x3D;OE_RollbackP2&#x3D;OE_AbortP4</p>\n<p><code>Halt 0 0 0 0 0</code><br>11. Transaction: P1011P20P2P22<br>12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead &#x2F; Open Write<br>13. TableLock: P1pageP2P30P31P4</p>\n<p>SQL insert joinVMSQL</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>T1c1 textc2 integer;<code>insert into T1 values(&#39;Hello,Wold!&#39;, 2000)</code>VM:</p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1B+</li>\n<li>rowidHello,Wold!2000</li>\n<li>B+</li>\n<li></li>\n<li></li>\n</ol>\n<p>T1VM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteFROM</p>\n<p>SQL : <code>select * from t1, t2 where ...</code></p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1t2</li>\n<li><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> each record in T1, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> each record in T2, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> WHERETRUE</span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br></pre></td></tr></table></figure></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VM0(1)(2)(2)</p>\n<p>CVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3_prepare</code>API<code>sqlite3_stmt</code>Vbe()VM<code>aOp</code><code>nMem</code><code>aMem</code></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>db</td>\n<td>sqlite3</td>\n</tr>\n<tr>\n<td>aOp</td>\n<td>VM</td>\n</tr>\n<tr>\n<td>nOp</td>\n<td>aOp</td>\n</tr>\n<tr>\n<td>apCsr</td>\n<td></td>\n</tr>\n<tr>\n<td>nCursor</td>\n<td>apCsr</td>\n</tr>\n<tr>\n<td>aMem</td>\n<td></td>\n</tr>\n<tr>\n<td>nMem</td>\n<td>aMem</td>\n</tr>\n<tr>\n<td>rc</td>\n<td></td>\n</tr>\n<tr>\n<td>pc</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM(Tree<code>BtCursors</code>)keyVMkey&#x2F;value</p>\n<p>VMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>pCursor</td>\n<td>(BtCursor)</td>\n</tr>\n<tr>\n<td>iDb</td>\n<td></td>\n</tr>\n<tr>\n<td>pBt</td>\n<td></td>\n</tr>\n<tr>\n<td>pKeyInfo</td>\n<td>key</td>\n</tr>\n<tr>\n<td>aType</td>\n<td></td>\n</tr>\n<tr>\n<td>aOffset</td>\n<td></td>\n</tr>\n<tr>\n<td>aRow</td>\n<td>(page)</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMVM:</p>\n<ol>\n<li>INTEGER: </li>\n<li>REAL: </li>\n<li>TEXT: </li>\n<li>BLOB: </li>\n<li>NULL: SQL NULL</li>\n</ol>\n<p>VM5123BLOBNULLSQLiteSQLite<code>typeof</code><code>select a,typeof(a) from t1</code>a<code>sqlite3_step</code>API<code>sqlite3_column_type</code></p>\n<p>VMMemMem(Mem): (Vbe.aMemaMem)</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>type</td>\n<td>Mem</td>\n</tr>\n<tr>\n<td>i</td>\n<td></td>\n</tr>\n<tr>\n<td>r</td>\n<td></td>\n</tr>\n<tr>\n<td>z</td>\n<td></td>\n</tr>\n<tr>\n<td>n</td>\n<td>z</td>\n</tr>\n<tr>\n<td>enc</td>\n<td>zUTF</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMBB+keyvalueVM(TreeVM)VM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQL:SQLiteSQLite(<code>integer primary key</code>[-2^63, 2^63-1])</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>**:**89</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>size(SQLite)</p>\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\n<p>Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>**:**08912130</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>SQLiteB+-TreekeySQLiterowid</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,<em>rowid</em>),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>rowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>RowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>B+keykeyrowidVMrowidB+SQLite</p>\n<p>SQLiteBBrowidBVMTree</p>\n<p>SQLitecreate<code>UNIQUE</code><code>PRIMARY KEY</code><code>CREATE INDEX</code>SQLiteT1(a,b,c)a,b</p>\n<ol>\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c)</code></li>\n<li><code>CREATE INDEX idx1 ON T1(a,b)</code></li>\n</ul>\n<ol start=\"2\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,UNIQUE(a,b))</code></li>\n</ul>\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))</code></li>\n</ul>\n<p><strong>:</strong><code>INTEGER PRIMARY KEY</code>B+rowid</p>\n<p>SQLite<br><code>CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);</code><br><code>CREATE INDEX idx2 ON T2(x);</code></p>\n<p>SQLitex<code>PRIMARY KEY</code>,<code>UNIQUE</code><code>INSERT</code>,<code>UPDATE</code><code>DELETE</code></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteBrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>B+</p>\n<p>**:**SQLiteSQLorder bygroup byexceptunionintersect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteVMVMVMSQLiteSQLiteVMVM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite:(1)SQL,(2)(VM)VM</p>\n<p>VMSQLSQLiteINTEGERREALTEXT(SQL)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL<code>create table T1(a,b,c)</code>SQLiteSQLVM</p>\n<p>VMSQLite</p>\n<ol>\n<li><p>SQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB(ABCD)</li>\n</ul>\n<p> VM</p>\n</li>\n<li><p><code>sqlite3_bind_*</code>APISQL<code>sqlite3_bind_blob</code>BLOB</p>\n</li>\n</ol>\n<p>SQLSQLVM</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteSQLSQLiteSQLiteSQLiteSQL</p>\n<p>5:TEXT,NUMERIC,INTEGER,REALNONE<code>CREATE TABLE</code>SQLSQLite</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE</p>\n<p>**:**<code>create table table1 as select ...</code>SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  SQL NULLrowidNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteVM:</p>\n<ol>\n<li>TEXTNULL,TEXT,BLOB()TEXT</li>\n<li>NUMERIC5VM()TEXTVMNULLBLOB</li>\n<li>INTEGERNUMERIC:VMINTEGER</li>\n<li>REALNUMERIC:(SQLite)</li>\n<li>NONE5</li>\n</ol>\n<p>**:**SQLSQLiteSQL(123abc),VM()TEXTTEXTASCII</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>T1B+(a,b,c)NULLNONEVM(+)11(SQLite:)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png\"></p>\n<ol>\n<li>:</li>\n<li>122</li>\n<li>20NULL</li>\n<li>322(22-12)&#x2F;2&#x3D;5</li>\n<li>1200B1,177(177B1-79)</li>\n<li>2NULL</li>\n<li>35 68 65 6C 6C 6F</li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQL<code>create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)</code>SQL<code>insert into T1 values(&#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;)</code>TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC1.01NONE<code>insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)</code>REALTEXTINTEGERINTEGERREAL  REALTEXT1.01.0TEXT<code>insert into T1 values(1, 1, 1, 1, 1)</code>INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER<a href=\"http://www.sqlite.org/datatype3.html.\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li><strong></strong> </li>\n<li><strong></strong> VM</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>sqlite3_column_*</code>APISQLiteREALAPI<code>sqlite3_column_text</code>VMsprintf()VM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>TEXTatoi()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>TEXTatof()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VMVM</p>\n<h4 id=\"SQL-NULL\"><a href=\"#SQL-NULL\" class=\"headerlink\" title=\"SQL NULL\"></a>SQL NULL</h4><p>SQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &#x3D;&#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;, &lt;&gt;,  !&#x3D;</li>\n<li> BETWEEN</li>\n<li> IN  NOT IN</li>\n<li> IS NULL  IS NOT NULL</li>\n</ul>\n<p>**:**IS NULLIS NOT NULL&#x3D;!&#x3D;</p>\n<p></p>\n<ol>\n<li>NULLNULLNULL</li>\n<li>INTEGERREALTEXTBLOB</li>\n<li>INTEGERREALINTEGERREAL</li>\n<li>TEXTBLOB</li>\n<li>TEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code> &#x3D; (,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><a href=\"http://www.sqlite.org/datatype3.html\"></a><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)</code><code>INSERT INTO t1 VALUES(500500500, 500)</code>a,b,cTEXTINTEGERTEXT  INTEGER</p>\n<ul>\n<li><code>SELECT a &lt; 600, a &lt; 60, a &lt; 40 FROM t1</code>600,6040600,6040aTEXTTEXT<code>1|1|0</code>5006006040</li>\n<li><code>SELECT b &lt; 40, b &lt; 60, b &lt; 600 FROM t1</code><code>0|0|1</code></li>\n<li><code>SELECT c &lt; 40, c &lt; 60, c &lt; 600 FROM t1</code>cNONE(NUMERIC)500(TEXT)<code>0|0|0</code></li>\n<li><code>SELECT d &lt; 40, d &lt; 60, d &lt; 600 FROM t1</code>dNUMERIC<code>0|0|1</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"order-by\"><a href=\"#order-by\" class=\"headerlink\" title=\"order by\"></a>order by</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"group-by\"><a href=\"#group-by\" class=\"headerlink\" title=\"group by\"></a>group by</h4><p>GROUP BYINTEGERREALGROUP BY</p>\n<h4 id=\"SELECTs\"><a href=\"#SELECTs\" class=\"headerlink\" title=\"SELECTs\"></a>SELECTs</h4><p>SELECT(UNIONINTERSECTEXCEPT)VM</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>VM5</p>\n<p><code>Vdbe</code>(<code>sqlite3_stmt</code>)SQLite API<code>sqlite3_step</code>API</p>\n<p>VMinteger,real,text,blobSQL NULLVMtypeof SQL</p>\n<p>VMSQLiteSQL</p>\n<p>SQLiteSQLiteSQL SQLite</p>\n","site":{"data":{}},"excerpt":"<p>SQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+</p>","more":"<p><strong></strong></p>\n<ul>\n<li>5</li>\n<li>SQL</li>\n<li>SQLC</li>\n<li></li>\n<li></li>\n</ul>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteVMVMSQLite()VMSQLiteVMVMB+</p>\n<p>SQLiteVMVMSQLVMSQLiteSQL</p>\n<p><strong></strong>:VMSQLite</p>\n<p><code>sqlite3_stmt</code>(Vdbe)SQLite API SQL</p>\n<ol>\n<li>sqlite3_bind_*:SQL</li>\n<li>sqlite3_step:</li>\n<li>sqlite3_reset:</li>\n<li>sqlite3_column_*:</li>\n<li>sqlite3_finalize:sqlite3_stmt</li>\n</ol>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>(BTree)</li>\n</ul>\n<p>VMVM</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteJava5&lt;opcode,P1,P2,P3,P4,P5&gt;,opcodeP1,P2,P3,P4,P532P2P432&#x2F;6464SQLP55</p>\n<p><strong></strong><br>VMSQLiteSQLiteSQLite</p>\n<p><code>SELECT * FROM t1</code>x,y0<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B&#x2F; B+, (ii)    B&#x2F;B+ , (iii)     key, (iv),(v),  B&#x2F;B+ ,(vi),    (a)rowid,(b)n(c)i</p>\n<p>VdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp</p>\n<p>SQLite<a href=\"http://www.sqlite.org/opcode.html\">SQLite</a>SQLiteOP_</p>\n<ol>\n<li>Trace: SQLitetracing modeP4(UTF8)<code>sqlite3_trace</code>API</li>\n<li>Goto: P2VMP2</li>\n<li>OpenRead: B&#x2F;B+root pageP2P50P2pageP2P3011P1()P4KeyInfoBSQLKeyInfo  P4</li>\n</ol>\n<p>SQLITE_BUSY<br>4. RewindP1P2 &gt; 0,P2<br>5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3<br>6. MakeRecordP1P2keyP1P1+1<br>7. ResultRow: P1P1+P2-1<code>sqlite_step</code>SQLITE_ROW<br>8. Next: P1P2<br>9. Close: P1P1<br>10. Halt: FIFOsRowSetP1<code>sqlite3_exec</code>,<code>sqlite3_reset</code>,<code>sqlite3_finalize</code>APISQLITE_OK(&#x3D;0)P1!&#x3D;0P2P2&#x3D;OE_FailP2&#x3D;OE_RollbackP2&#x3D;OE_AbortP4</p>\n<p><code>Halt 0 0 0 0 0</code><br>11. Transaction: P1011P20P2P22<br>12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead &#x2F; Open Write<br>13. TableLock: P1pageP2P30P31P4</p>\n<p>SQL insert joinVMSQL</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>T1c1 textc2 integer;<code>insert into T1 values(&#39;Hello,Wold!&#39;, 2000)</code>VM:</p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1B+</li>\n<li>rowidHello,Wold!2000</li>\n<li>B+</li>\n<li></li>\n<li></li>\n</ol>\n<p>T1VM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteFROM</p>\n<p>SQL : <code>select * from t1, t2 where ...</code></p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1t2</li>\n<li><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> each record in T1, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> each record in T2, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> WHERETRUE</span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br></pre></td></tr></table></figure></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VM0(1)(2)(2)</p>\n<p>CVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3_prepare</code>API<code>sqlite3_stmt</code>Vbe()VM<code>aOp</code><code>nMem</code><code>aMem</code></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>db</td>\n<td>sqlite3</td>\n</tr>\n<tr>\n<td>aOp</td>\n<td>VM</td>\n</tr>\n<tr>\n<td>nOp</td>\n<td>aOp</td>\n</tr>\n<tr>\n<td>apCsr</td>\n<td></td>\n</tr>\n<tr>\n<td>nCursor</td>\n<td>apCsr</td>\n</tr>\n<tr>\n<td>aMem</td>\n<td></td>\n</tr>\n<tr>\n<td>nMem</td>\n<td>aMem</td>\n</tr>\n<tr>\n<td>rc</td>\n<td></td>\n</tr>\n<tr>\n<td>pc</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM(Tree<code>BtCursors</code>)keyVMkey&#x2F;value</p>\n<p>VMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>pCursor</td>\n<td>(BtCursor)</td>\n</tr>\n<tr>\n<td>iDb</td>\n<td></td>\n</tr>\n<tr>\n<td>pBt</td>\n<td></td>\n</tr>\n<tr>\n<td>pKeyInfo</td>\n<td>key</td>\n</tr>\n<tr>\n<td>aType</td>\n<td></td>\n</tr>\n<tr>\n<td>aOffset</td>\n<td></td>\n</tr>\n<tr>\n<td>aRow</td>\n<td>(page)</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMVM:</p>\n<ol>\n<li>INTEGER: </li>\n<li>REAL: </li>\n<li>TEXT: </li>\n<li>BLOB: </li>\n<li>NULL: SQL NULL</li>\n</ol>\n<p>VM5123BLOBNULLSQLiteSQLite<code>typeof</code><code>select a,typeof(a) from t1</code>a<code>sqlite3_step</code>API<code>sqlite3_column_type</code></p>\n<p>VMMemMem(Mem): (Vbe.aMemaMem)</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>type</td>\n<td>Mem</td>\n</tr>\n<tr>\n<td>i</td>\n<td></td>\n</tr>\n<tr>\n<td>r</td>\n<td></td>\n</tr>\n<tr>\n<td>z</td>\n<td></td>\n</tr>\n<tr>\n<td>n</td>\n<td>z</td>\n</tr>\n<tr>\n<td>enc</td>\n<td>zUTF</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMBB+keyvalueVM(TreeVM)VM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQL:SQLiteSQLite(<code>integer primary key</code>[-2^63, 2^63-1])</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>**:**89</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>size(SQLite)</p>\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\n<p>Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>**:**08912130</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>SQLiteB+-TreekeySQLiterowid</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,<em>rowid</em>),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>rowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>RowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>B+keykeyrowidVMrowidB+SQLite</p>\n<p>SQLiteBBrowidBVMTree</p>\n<p>SQLitecreate<code>UNIQUE</code><code>PRIMARY KEY</code><code>CREATE INDEX</code>SQLiteT1(a,b,c)a,b</p>\n<ol>\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c)</code></li>\n<li><code>CREATE INDEX idx1 ON T1(a,b)</code></li>\n</ul>\n<ol start=\"2\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,UNIQUE(a,b))</code></li>\n</ul>\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))</code></li>\n</ul>\n<p><strong>:</strong><code>INTEGER PRIMARY KEY</code>B+rowid</p>\n<p>SQLite<br><code>CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);</code><br><code>CREATE INDEX idx2 ON T2(x);</code></p>\n<p>SQLitex<code>PRIMARY KEY</code>,<code>UNIQUE</code><code>INSERT</code>,<code>UPDATE</code><code>DELETE</code></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteBrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>B+</p>\n<p>**:**SQLiteSQLorder bygroup byexceptunionintersect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteVMVMVMSQLiteSQLiteVMVM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite:(1)SQL,(2)(VM)VM</p>\n<p>VMSQLSQLiteINTEGERREALTEXT(SQL)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL<code>create table T1(a,b,c)</code>SQLiteSQLVM</p>\n<p>VMSQLite</p>\n<ol>\n<li><p>SQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB(ABCD)</li>\n</ul>\n<p> VM</p>\n</li>\n<li><p><code>sqlite3_bind_*</code>APISQL<code>sqlite3_bind_blob</code>BLOB</p>\n</li>\n</ol>\n<p>SQLSQLVM</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteSQLSQLiteSQLiteSQLiteSQL</p>\n<p>5:TEXT,NUMERIC,INTEGER,REALNONE<code>CREATE TABLE</code>SQLSQLite</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE</p>\n<p>**:**<code>create table table1 as select ...</code>SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  SQL NULLrowidNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteVM:</p>\n<ol>\n<li>TEXTNULL,TEXT,BLOB()TEXT</li>\n<li>NUMERIC5VM()TEXTVMNULLBLOB</li>\n<li>INTEGERNUMERIC:VMINTEGER</li>\n<li>REALNUMERIC:(SQLite)</li>\n<li>NONE5</li>\n</ol>\n<p>**:**SQLSQLiteSQL(123abc),VM()TEXTTEXTASCII</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>T1B+(a,b,c)NULLNONEVM(+)11(SQLite:)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png\"></p>\n<ol>\n<li>:</li>\n<li>122</li>\n<li>20NULL</li>\n<li>322(22-12)&#x2F;2&#x3D;5</li>\n<li>1200B1,177(177B1-79)</li>\n<li>2NULL</li>\n<li>35 68 65 6C 6C 6F</li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQL<code>create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)</code>SQL<code>insert into T1 values(&#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;)</code>TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC1.01NONE<code>insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)</code>REALTEXTINTEGERINTEGERREAL  REALTEXT1.01.0TEXT<code>insert into T1 values(1, 1, 1, 1, 1)</code>INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER<a href=\"http://www.sqlite.org/datatype3.html.\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li><strong></strong> </li>\n<li><strong></strong> VM</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>sqlite3_column_*</code>APISQLiteREALAPI<code>sqlite3_column_text</code>VMsprintf()VM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>TEXTatoi()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>TEXTatof()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VMVM</p>\n<h4 id=\"SQL-NULL\"><a href=\"#SQL-NULL\" class=\"headerlink\" title=\"SQL NULL\"></a>SQL NULL</h4><p>SQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &#x3D;&#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;, &lt;&gt;,  !&#x3D;</li>\n<li> BETWEEN</li>\n<li> IN  NOT IN</li>\n<li> IS NULL  IS NOT NULL</li>\n</ul>\n<p>**:**IS NULLIS NOT NULL&#x3D;!&#x3D;</p>\n<p></p>\n<ol>\n<li>NULLNULLNULL</li>\n<li>INTEGERREALTEXTBLOB</li>\n<li>INTEGERREALINTEGERREAL</li>\n<li>TEXTBLOB</li>\n<li>TEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code> &#x3D; (,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><a href=\"http://www.sqlite.org/datatype3.html\"></a><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)</code><code>INSERT INTO t1 VALUES(500500500, 500)</code>a,b,cTEXTINTEGERTEXT  INTEGER</p>\n<ul>\n<li><code>SELECT a &lt; 600, a &lt; 60, a &lt; 40 FROM t1</code>600,6040600,6040aTEXTTEXT<code>1|1|0</code>5006006040</li>\n<li><code>SELECT b &lt; 40, b &lt; 60, b &lt; 600 FROM t1</code><code>0|0|1</code></li>\n<li><code>SELECT c &lt; 40, c &lt; 60, c &lt; 600 FROM t1</code>cNONE(NUMERIC)500(TEXT)<code>0|0|0</code></li>\n<li><code>SELECT d &lt; 40, d &lt; 60, d &lt; 600 FROM t1</code>dNUMERIC<code>0|0|1</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"order-by\"><a href=\"#order-by\" class=\"headerlink\" title=\"order by\"></a>order by</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"group-by\"><a href=\"#group-by\" class=\"headerlink\" title=\"group by\"></a>group by</h4><p>GROUP BYINTEGERREALGROUP BY</p>\n<h4 id=\"SELECTs\"><a href=\"#SELECTs\" class=\"headerlink\" title=\"SELECTs\"></a>SELECTs</h4><p>SELECT(UNIONINTERSECTEXCEPT)VM</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>VM5</p>\n<p><code>Vdbe</code>(<code>sqlite3_stmt</code>)SQLite API<code>sqlite3_step</code>API</p>\n<p>VMinteger,real,text,blobSQL NULLVMtypeof SQL</p>\n<p>VMSQLiteSQL</p>\n<p>SQLiteSQLiteSQL SQLite</p>"},{"title":"SQLite--Tokenize()","date":"2020-07-20T16:00:00.000Z","_content":"\n> SQLiteSQLiteSQLite\n\n<!-- more -->\n\n## \n\nTokenizeSQLiteSQL*ID*Parserparser*ID*\n\nParser\n\nParserSQLite`$root/tool/``lemon.c`SQLite`cmake``autoconf`Makefile:\n\n```\n# lemon.clemon\n#\nlemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c\n\t$(BCC) -o $@ $(TOP)/tool/lemon.c\n\tcp $(TOP)/tool/lempar.c .\n```\n\n```\n# parse.h  parse.clemon\n# commandlemonparse.yparse.hparse.c\n#\nparse.h:\tparse.c\n\nparse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl\n\tcp $(TOP)/src/parse.y .\n\trm -f parse.h\n\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y\n\tmv parse.h parse.h.temp\n\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp >parse.h\n```\n\n```\n# fts5lemonfts5parse.y\nfts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon\n\tcp $(TOP)/ext/fts5/fts5parse.y .\n\trm -f fts5parse.h\n\t./lemon$(BEXE) $(OPTS) fts5parse.y\n```\n\nParserlemonparse.hID\n\nIDTokenize\n\nSQLite API\n`int sqlite3_prepare();`\n`int sqlite3_prepare_v2();`\n`int sqlite3_prepare_v3();`\n\nSQLtokenizeparservm****\n\n:\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg)\n\n## \n\n`tokenize.c` `int sqlite3GetToken(const unsigned char *z, int *tokenType)`  `int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)`\n\n`prepare``sqlite3RunParser`\n\n```c\nint sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg){\n  int nErr = 0;                   /* Number of errors encountered */\n  void *pEngine;                  /* The LEMON-generated LALR(1) parser */\n  int n = 0;                      /* Length of the next token token */\n  int tokenType;                  /* type of the next token */\n  int lastTokenParsed = -1;       /* type of the previous token */\n  sqlite3 *db = pParse->db;       /* The database connection */\n  int mxSqlLen;                   /* Max length of an SQL string */\n  pParse->zTail = zSql;\n\n  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);\n\n  while( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    mxSqlLen -= n;\n    if( mxSqlLen<0 ){\n      pParse->rc = SQLITE_TOOBIG;\n      break;\n    }\n    if( tokenType>=TK_SPACE ){\n      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );\n      if( db->u1.isInterrupted ){\n        pParse->rc = SQLITE_INTERRUPT;\n        break;\n      }\n      if( tokenType==TK_SPACE ){\n        zSql += n;\n        continue;\n      }\n      if( zSql[0]==0 ){\n        /* Upon reaching the end of input, call the parser two more times\n        ** with tokens TK_SEMI and 0, in that order. */\n        if( lastTokenParsed==TK_SEMI ){\n          tokenType = 0;\n        }else if( lastTokenParsed==0 ){\n          break;\n        }else{\n          tokenType = TK_SEMI;\n        }\n        n = 0;\n      }else{\n        sqlite3ErrorMsg(pParse, \"unrecognized token: \\\"%.*s\\\"\", n, zSql);\n        break;\n      }\n    }\n    pParse->sLastToken.z = zSql;\n    pParse->sLastToken.n = n;\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);\n    lastTokenParsed = tokenType;\n    zSql += n;\n    if( pParse->rc!=SQLITE_OK || db->mallocFailed ) break;\n  }\n  // mem free code...\n  return nErr;\n}\n```\n\n\n\n```c\nwhile( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);    \n}\n```\n\nparser\n\nSQLSQLite\n\n\n\n## \n\n`sqlite3RunParser``sqlite3GetToken`\n\n```c\n/*\n** Return the length (in bytes) of the token that begins at z[0]. \n** Store the token type in *tokenType before returning.\n*/\nint sqlite3GetToken(const unsigned char *z, int *tokenType){\n  int i, c;\n  switch( aiClass[*z] ){  /* Switch on the character-class of the first byte\n                          ** of the token. See the comment on the CC_ defines\n                          ** above. */\n    case CC_SPACE: {\n      testcase( z[0]==' ' );\n      testcase( z[0]=='\\t' );\n      testcase( z[0]=='\\n' );\n      testcase( z[0]=='\\f' );\n      testcase( z[0]=='\\r' );\n      for(i=1; sqlite3Isspace(z[i]); i++){}\n      *tokenType = TK_SPACE;\n      return i;\n    }\n    case CC_VARNUM: {\n      *tokenType = TK_VARIABLE;\n      for(i=1; sqlite3Isdigit(z[i]); i++){}\n      return i;\n    }\n\n    // .... more case\n\n    case CC_KYWD: {\n      for(i=1; aiClass[z[i]]<=CC_KYWD; i++){}\n      if( IdChar(z[i]) ){\n        /* This token started out using characters that can appear in keywords,\n        ** but z[i] is a character not allowed within keywords, so this must\n        ** be an identifier instead */\n        i++;\n        break;\n      }\n      *tokenType = TK_ID;\n      return keywordCode((char*)z, i, tokenType);\n    }\n    case CC_X: {\n#ifndef SQLITE_OMIT_BLOB_LITERAL\n      testcase( z[0]=='x' ); testcase( z[0]=='X' );\n      if( z[1]=='\\'' ){\n        *tokenType = TK_BLOB;\n        for(i=2; sqlite3Isxdigit(z[i]); i++){}\n        if( z[i]!='\\'' || i%2 ){\n          *tokenType = TK_ILLEGAL;\n          while( z[i] && z[i]!='\\'' ){ i++; }\n        }\n        if( z[i] ) i++;\n        return i;\n      }\n#endif\n      /* If it is not a BLOB literal, then it must be an ID, since no\n      ** SQL keywords start with the letter 'x'.  Fall through */\n    }\n    case CC_ID: {\n      i = 1;\n      break;\n    }\n    case CC_NUL: {\n      *tokenType = TK_ILLEGAL;\n      return 0;\n    }\n    default: {\n      *tokenType = TK_ILLEGAL;\n      return 1;\n    }\n  }\n  while( IdChar(z[i]) ){ i++; }\n  *tokenType = TK_ID;\n  return i;\n}\n```\n\n`sqlite3GetToken`SQL(CC_SPACE,CC_NUL,...)switch-case**(tokenType)Parser.h\n\n...`aiClass[*z]``switch(*z)`\n\n *Switch-Case* \n\nswitch-casecaseconstant[C/C++ switch](http://blog.csdn.net/simmerlee/article/details/50845706)\n\n1. casecase\n2. casecase\n3. O(logn)\n\ncaseO(1)O(logn)SQLite\"\"\n\nASCII:\n\nASCII7bit8bit128256128ASCIISQLite256ASCII256`aiClass`ASCIISQLite29tokenize.c29switch-caseO(1)\n\nASCII aiClass  \n\n``` c\n/* Character classes for tokenizing\n**\n** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented\n** using a lookup table, whereas a switch() directly on c uses a binary search.\n** The lookup table is much faster.  To maximize speed, and to ensure that\n** a lookup table is used, all of the classes need to be small integers and\n** all of them need to be used within the switch.\n*/\n#define CC_X          0    /* The letter 'x', or start of BLOB literal */\n#define CC_KYWD       1    /* Alphabetics or '_'.  Usable in a keyword */\n#define CC_ID         2    /* unicode characters usable in IDs */\n#define CC_DIGIT      3    /* Digits */\n#define CC_DOLLAR     4    /* '$' */\n#define CC_VARALPHA   5    /* '@', '#', ':'.  Alphabetic SQL variables */\n#define CC_VARNUM     6    /* '?'.  Numeric SQL variables */\n#define CC_SPACE      7    /* Space characters */\n#define CC_QUOTE      8    /* '\"', '\\'', or '`'.  String literals, quoted ids */\n#define CC_QUOTE2     9    /* '['.   [...] style quoted ids */\n#define CC_PIPE      10    /* '|'.   Bitwise OR or concatenate */\n#define CC_MINUS     11    /* '-'.  Minus or SQL-style comment */\n#define CC_LT        12    /* '<'.  Part of < or <= or <> */\n#define CC_GT        13    /* '>'.  Part of > or >= */\n#define CC_EQ        14    /* '='.  Part of = or == */\n#define CC_BANG      15    /* '!'.  Part of != */\n#define CC_SLASH     16    /* '/'.  / or c-style comment */\n#define CC_LP        17    /* '(' */\n#define CC_RP        18    /* ')' */\n#define CC_SEMI      19    /* ';' */\n#define CC_PLUS      20    /* '+' */\n#define CC_STAR      21    /* '*' */\n#define CC_PERCENT   22    /* '%' */\n#define CC_COMMA     23    /* ',' */\n#define CC_AND       24    /* '&' */\n#define CC_TILDA     25    /* '~' */\n#define CC_DOT       26    /* '.' */\n#define CC_ILLEGAL   27    /* Illegal character */\n#define CC_NUL       28    /* 0x00 */\n\nstatic const unsigned char aiClass[] = {\n#ifdef SQLITE_ASCII\n/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */\n/* 0x */   28, 27, 27, 27, 27, 27, 27, 27, 27,  7,  7, 27,  7,  7, 27, 27,\n/* 1x */   27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27,\n/* 2x */    7, 15,  8,  5,  4, 22, 24,  8, 17, 18, 21, 20, 23, 11, 26, 16,\n/* 3x */    3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  5, 19, 12, 14, 13,  6,\n/* 4x */    5,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 5x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1,  9, 27, 27, 27,  1,\n/* 6x */    8,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 7x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1, 27, 10, 27, 25, 27,\n/* 8x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2, //128 2 CC_ID\n/* 9x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ax */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Bx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Cx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Dx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ex */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Fx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2\n#endif\n};\n```\n\ncase CC_KYWD`keywordCode`SQLite*ID*`keywordCode`[SQLite--KeywordHash](https://caio.ink/2020/07/16/19.SQLite-KeywordHash/)","source":"_posts/20.SQLite-Tokenize.md","raw":"title: SQLite--Tokenize()\ndate: 2020-07-21\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLiteSQLiteSQLite\n\n<!-- more -->\n\n## \n\nTokenizeSQLiteSQL*ID*Parserparser*ID*\n\nParser\n\nParserSQLite`$root/tool/``lemon.c`SQLite`cmake``autoconf`Makefile:\n\n```\n# lemon.clemon\n#\nlemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c\n\t$(BCC) -o $@ $(TOP)/tool/lemon.c\n\tcp $(TOP)/tool/lempar.c .\n```\n\n```\n# parse.h  parse.clemon\n# commandlemonparse.yparse.hparse.c\n#\nparse.h:\tparse.c\n\nparse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl\n\tcp $(TOP)/src/parse.y .\n\trm -f parse.h\n\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y\n\tmv parse.h parse.h.temp\n\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp >parse.h\n```\n\n```\n# fts5lemonfts5parse.y\nfts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon\n\tcp $(TOP)/ext/fts5/fts5parse.y .\n\trm -f fts5parse.h\n\t./lemon$(BEXE) $(OPTS) fts5parse.y\n```\n\nParserlemonparse.hID\n\nIDTokenize\n\nSQLite API\n`int sqlite3_prepare();`\n`int sqlite3_prepare_v2();`\n`int sqlite3_prepare_v3();`\n\nSQLtokenizeparservm****\n\n:\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg)\n\n## \n\n`tokenize.c` `int sqlite3GetToken(const unsigned char *z, int *tokenType)`  `int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)`\n\n`prepare``sqlite3RunParser`\n\n```c\nint sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg){\n  int nErr = 0;                   /* Number of errors encountered */\n  void *pEngine;                  /* The LEMON-generated LALR(1) parser */\n  int n = 0;                      /* Length of the next token token */\n  int tokenType;                  /* type of the next token */\n  int lastTokenParsed = -1;       /* type of the previous token */\n  sqlite3 *db = pParse->db;       /* The database connection */\n  int mxSqlLen;                   /* Max length of an SQL string */\n  pParse->zTail = zSql;\n\n  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);\n\n  while( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    mxSqlLen -= n;\n    if( mxSqlLen<0 ){\n      pParse->rc = SQLITE_TOOBIG;\n      break;\n    }\n    if( tokenType>=TK_SPACE ){\n      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );\n      if( db->u1.isInterrupted ){\n        pParse->rc = SQLITE_INTERRUPT;\n        break;\n      }\n      if( tokenType==TK_SPACE ){\n        zSql += n;\n        continue;\n      }\n      if( zSql[0]==0 ){\n        /* Upon reaching the end of input, call the parser two more times\n        ** with tokens TK_SEMI and 0, in that order. */\n        if( lastTokenParsed==TK_SEMI ){\n          tokenType = 0;\n        }else if( lastTokenParsed==0 ){\n          break;\n        }else{\n          tokenType = TK_SEMI;\n        }\n        n = 0;\n      }else{\n        sqlite3ErrorMsg(pParse, \"unrecognized token: \\\"%.*s\\\"\", n, zSql);\n        break;\n      }\n    }\n    pParse->sLastToken.z = zSql;\n    pParse->sLastToken.n = n;\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);\n    lastTokenParsed = tokenType;\n    zSql += n;\n    if( pParse->rc!=SQLITE_OK || db->mallocFailed ) break;\n  }\n  // mem free code...\n  return nErr;\n}\n```\n\n\n\n```c\nwhile( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);    \n}\n```\n\nparser\n\nSQLSQLite\n\n\n\n## \n\n`sqlite3RunParser``sqlite3GetToken`\n\n```c\n/*\n** Return the length (in bytes) of the token that begins at z[0]. \n** Store the token type in *tokenType before returning.\n*/\nint sqlite3GetToken(const unsigned char *z, int *tokenType){\n  int i, c;\n  switch( aiClass[*z] ){  /* Switch on the character-class of the first byte\n                          ** of the token. See the comment on the CC_ defines\n                          ** above. */\n    case CC_SPACE: {\n      testcase( z[0]==' ' );\n      testcase( z[0]=='\\t' );\n      testcase( z[0]=='\\n' );\n      testcase( z[0]=='\\f' );\n      testcase( z[0]=='\\r' );\n      for(i=1; sqlite3Isspace(z[i]); i++){}\n      *tokenType = TK_SPACE;\n      return i;\n    }\n    case CC_VARNUM: {\n      *tokenType = TK_VARIABLE;\n      for(i=1; sqlite3Isdigit(z[i]); i++){}\n      return i;\n    }\n\n    // .... more case\n\n    case CC_KYWD: {\n      for(i=1; aiClass[z[i]]<=CC_KYWD; i++){}\n      if( IdChar(z[i]) ){\n        /* This token started out using characters that can appear in keywords,\n        ** but z[i] is a character not allowed within keywords, so this must\n        ** be an identifier instead */\n        i++;\n        break;\n      }\n      *tokenType = TK_ID;\n      return keywordCode((char*)z, i, tokenType);\n    }\n    case CC_X: {\n#ifndef SQLITE_OMIT_BLOB_LITERAL\n      testcase( z[0]=='x' ); testcase( z[0]=='X' );\n      if( z[1]=='\\'' ){\n        *tokenType = TK_BLOB;\n        for(i=2; sqlite3Isxdigit(z[i]); i++){}\n        if( z[i]!='\\'' || i%2 ){\n          *tokenType = TK_ILLEGAL;\n          while( z[i] && z[i]!='\\'' ){ i++; }\n        }\n        if( z[i] ) i++;\n        return i;\n      }\n#endif\n      /* If it is not a BLOB literal, then it must be an ID, since no\n      ** SQL keywords start with the letter 'x'.  Fall through */\n    }\n    case CC_ID: {\n      i = 1;\n      break;\n    }\n    case CC_NUL: {\n      *tokenType = TK_ILLEGAL;\n      return 0;\n    }\n    default: {\n      *tokenType = TK_ILLEGAL;\n      return 1;\n    }\n  }\n  while( IdChar(z[i]) ){ i++; }\n  *tokenType = TK_ID;\n  return i;\n}\n```\n\n`sqlite3GetToken`SQL(CC_SPACE,CC_NUL,...)switch-case**(tokenType)Parser.h\n\n...`aiClass[*z]``switch(*z)`\n\n *Switch-Case* \n\nswitch-casecaseconstant[C/C++ switch](http://blog.csdn.net/simmerlee/article/details/50845706)\n\n1. casecase\n2. casecase\n3. O(logn)\n\ncaseO(1)O(logn)SQLite\"\"\n\nASCII:\n\nASCII7bit8bit128256128ASCIISQLite256ASCII256`aiClass`ASCIISQLite29tokenize.c29switch-caseO(1)\n\nASCII aiClass  \n\n``` c\n/* Character classes for tokenizing\n**\n** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented\n** using a lookup table, whereas a switch() directly on c uses a binary search.\n** The lookup table is much faster.  To maximize speed, and to ensure that\n** a lookup table is used, all of the classes need to be small integers and\n** all of them need to be used within the switch.\n*/\n#define CC_X          0    /* The letter 'x', or start of BLOB literal */\n#define CC_KYWD       1    /* Alphabetics or '_'.  Usable in a keyword */\n#define CC_ID         2    /* unicode characters usable in IDs */\n#define CC_DIGIT      3    /* Digits */\n#define CC_DOLLAR     4    /* '$' */\n#define CC_VARALPHA   5    /* '@', '#', ':'.  Alphabetic SQL variables */\n#define CC_VARNUM     6    /* '?'.  Numeric SQL variables */\n#define CC_SPACE      7    /* Space characters */\n#define CC_QUOTE      8    /* '\"', '\\'', or '`'.  String literals, quoted ids */\n#define CC_QUOTE2     9    /* '['.   [...] style quoted ids */\n#define CC_PIPE      10    /* '|'.   Bitwise OR or concatenate */\n#define CC_MINUS     11    /* '-'.  Minus or SQL-style comment */\n#define CC_LT        12    /* '<'.  Part of < or <= or <> */\n#define CC_GT        13    /* '>'.  Part of > or >= */\n#define CC_EQ        14    /* '='.  Part of = or == */\n#define CC_BANG      15    /* '!'.  Part of != */\n#define CC_SLASH     16    /* '/'.  / or c-style comment */\n#define CC_LP        17    /* '(' */\n#define CC_RP        18    /* ')' */\n#define CC_SEMI      19    /* ';' */\n#define CC_PLUS      20    /* '+' */\n#define CC_STAR      21    /* '*' */\n#define CC_PERCENT   22    /* '%' */\n#define CC_COMMA     23    /* ',' */\n#define CC_AND       24    /* '&' */\n#define CC_TILDA     25    /* '~' */\n#define CC_DOT       26    /* '.' */\n#define CC_ILLEGAL   27    /* Illegal character */\n#define CC_NUL       28    /* 0x00 */\n\nstatic const unsigned char aiClass[] = {\n#ifdef SQLITE_ASCII\n/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */\n/* 0x */   28, 27, 27, 27, 27, 27, 27, 27, 27,  7,  7, 27,  7,  7, 27, 27,\n/* 1x */   27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27,\n/* 2x */    7, 15,  8,  5,  4, 22, 24,  8, 17, 18, 21, 20, 23, 11, 26, 16,\n/* 3x */    3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  5, 19, 12, 14, 13,  6,\n/* 4x */    5,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 5x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1,  9, 27, 27, 27,  1,\n/* 6x */    8,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 7x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1, 27, 10, 27, 25, 27,\n/* 8x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2, //128 2 CC_ID\n/* 9x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ax */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Bx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Cx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Dx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ex */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Fx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2\n#endif\n};\n```\n\ncase CC_KYWD`keywordCode`SQLite*ID*`keywordCode`[SQLite--KeywordHash](https://caio.ink/2020/07/16/19.SQLite-KeywordHash/)","slug":"20.SQLite-Tokenize","published":1,"updated":"2020-08-29T14:42:58.500Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61f000selc912w97x07","content":"<blockquote>\n<p>SQLiteSQLiteSQLite</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>TokenizeSQLiteSQL<em>ID</em>Parserparser<em>ID</em></p>\n<p>Parser</p>\n<p>ParserSQLite<code>$root/tool/</code><code>lemon.c</code>SQLite<code>cmake</code><code>autoconf</code>Makefile:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># lemon.clemon</span><br><span class=\"line\">#</span><br><span class=\"line\">lemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c</span><br><span class=\"line\">\t$(BCC) -o $@ $(TOP)/tool/lemon.c</span><br><span class=\"line\">\tcp $(TOP)/tool/lempar.c .</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># parse.h  parse.clemon</span><br><span class=\"line\"># commandlemonparse.yparse.hparse.c</span><br><span class=\"line\">#</span><br><span class=\"line\">parse.h:\tparse.c</span><br><span class=\"line\"></span><br><span class=\"line\">parse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl</span><br><span class=\"line\">\tcp $(TOP)/src/parse.y .</span><br><span class=\"line\">\trm -f parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y</span><br><span class=\"line\">\tmv parse.h parse.h.temp</span><br><span class=\"line\">\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp &gt;parse.h</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># fts5lemonfts5parse.y</span><br><span class=\"line\">fts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon</span><br><span class=\"line\">\tcp $(TOP)/ext/fts5/fts5parse.y .</span><br><span class=\"line\">\trm -f fts5parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPTS) fts5parse.y</span><br></pre></td></tr></table></figure>\n\n<p>Parserlemonparse.hID</p>\n<p>IDTokenize</p>\n<p>SQLite API<br><code>int sqlite3_prepare();</code><br><code>int sqlite3_prepare_v2();</code><br><code>int sqlite3_prepare_v3();</code></p>\n<p>SQLtokenizeparservm<em></em><em></em></p>\n<p>:</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>tokenize.c</code> <code>int sqlite3GetToken(const unsigned char *z, int *tokenType)</code>  <code>int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)</code></p>\n<p><code>prepare</code><code>sqlite3RunParser</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3RunParser</span><span class=\"params\">(Parse *pParse, <span class=\"type\">const</span> <span class=\"type\">char</span> *zSql, <span class=\"type\">char</span> **pzErrMsg)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> nErr = <span class=\"number\">0</span>;                   <span class=\"comment\">/* Number of errors encountered */</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *pEngine;                  <span class=\"comment\">/* The LEMON-generated LALR(1) parser */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> n = <span class=\"number\">0</span>;                      <span class=\"comment\">/* Length of the next token token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> tokenType;                  <span class=\"comment\">/* type of the next token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> lastTokenParsed = <span class=\"number\">-1</span>;       <span class=\"comment\">/* type of the previous token */</span></span><br><span class=\"line\">  sqlite3 *db = pParse-&gt;db;       <span class=\"comment\">/* The database connection */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mxSqlLen;                   <span class=\"comment\">/* Max length of an SQL string */</span></span><br><span class=\"line\">  pParse-&gt;zTail = zSql;</span><br><span class=\"line\"></span><br><span class=\"line\">  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    mxSqlLen -= n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( mxSqlLen&lt;<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">      pParse-&gt;rc = SQLITE_TOOBIG;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( tokenType&gt;=TK_SPACE )&#123;</span><br><span class=\"line\">      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( db-&gt;u1.isInterrupted )&#123;</span><br><span class=\"line\">        pParse-&gt;rc = SQLITE_INTERRUPT;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( tokenType==TK_SPACE )&#123;</span><br><span class=\"line\">        zSql += n;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( zSql[<span class=\"number\">0</span>]==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* Upon reaching the end of input, call the parser two more times</span></span><br><span class=\"line\"><span class=\"comment\">        ** with tokens TK_SEMI and 0, in that order. */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>( lastTokenParsed==TK_SEMI )&#123;</span><br><span class=\"line\">          tokenType = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>( lastTokenParsed==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">          tokenType = TK_SEMI;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        n = <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        sqlite3ErrorMsg(pParse, <span class=\"string\">&quot;unrecognized token: \\&quot;%.*s\\&quot;&quot;</span>, n, zSql);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    pParse-&gt;sLastToken.z = zSql;</span><br><span class=\"line\">    pParse-&gt;sLastToken.n = n;</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);</span><br><span class=\"line\">    lastTokenParsed = tokenType;</span><br><span class=\"line\">    zSql += n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pParse-&gt;rc!=SQLITE_OK || db-&gt;mallocFailed ) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// mem free code...</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> nErr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>parser</p>\n<p>SQLSQLite</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3RunParser</code><code>sqlite3GetToken</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** Return the length (in bytes) of the token that begins at z[0]. </span></span><br><span class=\"line\"><span class=\"comment\">** Store the token type in *tokenType before returning.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3GetToken</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> *tokenType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, c;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>( aiClass[*z] )&#123;  <span class=\"comment\">/* Switch on the character-class of the first byte</span></span><br><span class=\"line\"><span class=\"comment\">                          ** of the token. See the comment on the CC_ defines</span></span><br><span class=\"line\"><span class=\"comment\">                          ** above. */</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_SPACE: &#123;</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27; &#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\t&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\n&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\f&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\r&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isspace(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      *tokenType = TK_SPACE;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_VARNUM: &#123;</span><br><span class=\"line\">      *tokenType = TK_VARIABLE;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// .... more case</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_KYWD: &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; aiClass[z[i]]&lt;=CC_KYWD; i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( IdChar(z[i]) )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* This token started out using characters that can appear in keywords,</span></span><br><span class=\"line\"><span class=\"comment\">        ** but z[i] is a character not allowed within keywords, so this must</span></span><br><span class=\"line\"><span class=\"comment\">        ** be an identifier instead */</span></span><br><span class=\"line\">        i++;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      *tokenType = TK_ID;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> keywordCode((<span class=\"type\">char</span>*)z, i, tokenType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_X: &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> SQLITE_OMIT_BLOB_LITERAL</span></span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;x&#x27;</span> ); testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;X&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( z[<span class=\"number\">1</span>]==<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123;</span><br><span class=\"line\">        *tokenType = TK_BLOB;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(i=<span class=\"number\">2</span>; sqlite3Isxdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> || i%<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">          *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">          <span class=\"keyword\">while</span>( z[i] &amp;&amp; z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123; i++; &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i] ) i++;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"comment\">/* If it is not a BLOB literal, then it must be an ID, since no</span></span><br><span class=\"line\"><span class=\"comment\">      ** SQL keywords start with the letter &#x27;x&#x27;.  Fall through */</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_ID: &#123;</span><br><span class=\"line\">      i = <span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_NUL: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span>( IdChar(z[i]) )&#123; i++; &#125;</span><br><span class=\"line\">  *tokenType = TK_ID;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3GetToken</code>SQL(CC_SPACE,CC_NUL,)switch-case<em></em>(tokenType)Parser.h</p>\n<p><code>aiClass[*z]</code><code>switch(*z)</code></p>\n<p> <em>Switch-Case</em> </p>\n<p>switch-casecaseconstant<a href=\"http://blog.csdn.net/simmerlee/article/details/50845706\">C&#x2F;C++ switch</a></p>\n<ol>\n<li>casecase</li>\n<li>casecase</li>\n<li>O(logn)</li>\n</ol>\n<p>caseO(1)O(logn)SQLite</p>\n<p>ASCII:</p>\n<p>ASCII7bit8bit128256128ASCIISQLite256ASCII256<code>aiClass</code>ASCIISQLite29tokenize.c29switch-caseO(1)</p>\n<p>ASCII aiClass  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Character classes for tokenizing</span></span><br><span class=\"line\"><span class=\"comment\">**</span></span><br><span class=\"line\"><span class=\"comment\">** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented</span></span><br><span class=\"line\"><span class=\"comment\">** using a lookup table, whereas a switch() directly on c uses a binary search.</span></span><br><span class=\"line\"><span class=\"comment\">** The lookup table is much faster.  To maximize speed, and to ensure that</span></span><br><span class=\"line\"><span class=\"comment\">** a lookup table is used, all of the classes need to be small integers and</span></span><br><span class=\"line\"><span class=\"comment\">** all of them need to be used within the switch.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_X          0    <span class=\"comment\">/* The letter &#x27;x&#x27;, or start of BLOB literal */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_KYWD       1    <span class=\"comment\">/* Alphabetics or &#x27;_&#x27;.  Usable in a keyword */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ID         2    <span class=\"comment\">/* unicode characters usable in IDs */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DIGIT      3    <span class=\"comment\">/* Digits */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOLLAR     4    <span class=\"comment\">/* &#x27;$&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARALPHA   5    <span class=\"comment\">/* &#x27;@&#x27;, &#x27;#&#x27;, &#x27;:&#x27;.  Alphabetic SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARNUM     6    <span class=\"comment\">/* &#x27;?&#x27;.  Numeric SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SPACE      7    <span class=\"comment\">/* Space characters */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE      8    <span class=\"comment\">/* &#x27;&quot;&#x27;, &#x27;\\&#x27;&#x27;, or &#x27;`&#x27;.  String literals, quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE2     9    <span class=\"comment\">/* &#x27;[&#x27;.   [...] style quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PIPE      10    <span class=\"comment\">/* &#x27;|&#x27;.   Bitwise OR or concatenate */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_MINUS     11    <span class=\"comment\">/* &#x27;-&#x27;.  Minus or SQL-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LT        12    <span class=\"comment\">/* &#x27;&lt;&#x27;.  Part of &lt; or &lt;= or &lt;&gt; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_GT        13    <span class=\"comment\">/* &#x27;&gt;&#x27;.  Part of &gt; or &gt;= */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_EQ        14    <span class=\"comment\">/* &#x27;=&#x27;.  Part of = or == */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_BANG      15    <span class=\"comment\">/* &#x27;!&#x27;.  Part of != */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SLASH     16    <span class=\"comment\">/* &#x27;/&#x27;.  / or c-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LP        17    <span class=\"comment\">/* &#x27;(&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_RP        18    <span class=\"comment\">/* &#x27;)&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SEMI      19    <span class=\"comment\">/* &#x27;;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PLUS      20    <span class=\"comment\">/* &#x27;+&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_STAR      21    <span class=\"comment\">/* &#x27;*&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PERCENT   22    <span class=\"comment\">/* &#x27;%&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_COMMA     23    <span class=\"comment\">/* &#x27;,&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_AND       24    <span class=\"comment\">/* &#x27;&amp;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_TILDA     25    <span class=\"comment\">/* &#x27;~&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOT       26    <span class=\"comment\">/* &#x27;.&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ILLEGAL   27    <span class=\"comment\">/* Illegal character */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_NUL       28    <span class=\"comment\">/* 0x00 */</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> aiClass[] = &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\"><span class=\"comment\">/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */</span></span><br><span class=\"line\"><span class=\"comment\">/* 0x */</span>   <span class=\"number\">28</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 1x */</span>   <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 2x */</span>    <span class=\"number\">7</span>, <span class=\"number\">15</span>,  <span class=\"number\">8</span>,  <span class=\"number\">5</span>,  <span class=\"number\">4</span>, <span class=\"number\">22</span>, <span class=\"number\">24</span>,  <span class=\"number\">8</span>, <span class=\"number\">17</span>, <span class=\"number\">18</span>, <span class=\"number\">21</span>, <span class=\"number\">20</span>, <span class=\"number\">23</span>, <span class=\"number\">11</span>, <span class=\"number\">26</span>, <span class=\"number\">16</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 3x */</span>    <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">5</span>, <span class=\"number\">19</span>, <span class=\"number\">12</span>, <span class=\"number\">14</span>, <span class=\"number\">13</span>,  <span class=\"number\">6</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 4x */</span>    <span class=\"number\">5</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 5x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">9</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 6x */</span>    <span class=\"number\">8</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 7x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>, <span class=\"number\">27</span>, <span class=\"number\">10</span>, <span class=\"number\">27</span>, <span class=\"number\">25</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 8x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>, <span class=\"comment\">//128 2 CC_ID</span></span><br><span class=\"line\"><span class=\"comment\">/* 9x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ax */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Bx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Cx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Dx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ex */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Fx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>case CC_KYWD<code>keywordCode</code>SQLite<em>ID</em><code>keywordCode</code><a href=\"https://caio.ink/2020/07/16/19.SQLite-KeywordHash/\">SQLiteKeywordHash</a></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLiteSQLiteSQLite</p>\n</blockquote>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>TokenizeSQLiteSQL<em>ID</em>Parserparser<em>ID</em></p>\n<p>Parser</p>\n<p>ParserSQLite<code>$root/tool/</code><code>lemon.c</code>SQLite<code>cmake</code><code>autoconf</code>Makefile:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># lemon.clemon</span><br><span class=\"line\">#</span><br><span class=\"line\">lemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c</span><br><span class=\"line\">\t$(BCC) -o $@ $(TOP)/tool/lemon.c</span><br><span class=\"line\">\tcp $(TOP)/tool/lempar.c .</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># parse.h  parse.clemon</span><br><span class=\"line\"># commandlemonparse.yparse.hparse.c</span><br><span class=\"line\">#</span><br><span class=\"line\">parse.h:\tparse.c</span><br><span class=\"line\"></span><br><span class=\"line\">parse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl</span><br><span class=\"line\">\tcp $(TOP)/src/parse.y .</span><br><span class=\"line\">\trm -f parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y</span><br><span class=\"line\">\tmv parse.h parse.h.temp</span><br><span class=\"line\">\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp &gt;parse.h</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># fts5lemonfts5parse.y</span><br><span class=\"line\">fts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon</span><br><span class=\"line\">\tcp $(TOP)/ext/fts5/fts5parse.y .</span><br><span class=\"line\">\trm -f fts5parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPTS) fts5parse.y</span><br></pre></td></tr></table></figure>\n\n<p>Parserlemonparse.hID</p>\n<p>IDTokenize</p>\n<p>SQLite API<br><code>int sqlite3_prepare();</code><br><code>int sqlite3_prepare_v2();</code><br><code>int sqlite3_prepare_v3();</code></p>\n<p>SQLtokenizeparservm<em></em><em></em></p>\n<p>:</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>tokenize.c</code> <code>int sqlite3GetToken(const unsigned char *z, int *tokenType)</code>  <code>int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)</code></p>\n<p><code>prepare</code><code>sqlite3RunParser</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3RunParser</span><span class=\"params\">(Parse *pParse, <span class=\"type\">const</span> <span class=\"type\">char</span> *zSql, <span class=\"type\">char</span> **pzErrMsg)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> nErr = <span class=\"number\">0</span>;                   <span class=\"comment\">/* Number of errors encountered */</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *pEngine;                  <span class=\"comment\">/* The LEMON-generated LALR(1) parser */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> n = <span class=\"number\">0</span>;                      <span class=\"comment\">/* Length of the next token token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> tokenType;                  <span class=\"comment\">/* type of the next token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> lastTokenParsed = <span class=\"number\">-1</span>;       <span class=\"comment\">/* type of the previous token */</span></span><br><span class=\"line\">  sqlite3 *db = pParse-&gt;db;       <span class=\"comment\">/* The database connection */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mxSqlLen;                   <span class=\"comment\">/* Max length of an SQL string */</span></span><br><span class=\"line\">  pParse-&gt;zTail = zSql;</span><br><span class=\"line\"></span><br><span class=\"line\">  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    mxSqlLen -= n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( mxSqlLen&lt;<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">      pParse-&gt;rc = SQLITE_TOOBIG;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( tokenType&gt;=TK_SPACE )&#123;</span><br><span class=\"line\">      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( db-&gt;u1.isInterrupted )&#123;</span><br><span class=\"line\">        pParse-&gt;rc = SQLITE_INTERRUPT;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( tokenType==TK_SPACE )&#123;</span><br><span class=\"line\">        zSql += n;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( zSql[<span class=\"number\">0</span>]==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* Upon reaching the end of input, call the parser two more times</span></span><br><span class=\"line\"><span class=\"comment\">        ** with tokens TK_SEMI and 0, in that order. */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>( lastTokenParsed==TK_SEMI )&#123;</span><br><span class=\"line\">          tokenType = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>( lastTokenParsed==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">          tokenType = TK_SEMI;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        n = <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        sqlite3ErrorMsg(pParse, <span class=\"string\">&quot;unrecognized token: \\&quot;%.*s\\&quot;&quot;</span>, n, zSql);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    pParse-&gt;sLastToken.z = zSql;</span><br><span class=\"line\">    pParse-&gt;sLastToken.n = n;</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);</span><br><span class=\"line\">    lastTokenParsed = tokenType;</span><br><span class=\"line\">    zSql += n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pParse-&gt;rc!=SQLITE_OK || db-&gt;mallocFailed ) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// mem free code...</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> nErr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>parser</p>\n<p>SQLSQLite</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3RunParser</code><code>sqlite3GetToken</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** Return the length (in bytes) of the token that begins at z[0]. </span></span><br><span class=\"line\"><span class=\"comment\">** Store the token type in *tokenType before returning.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3GetToken</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> *tokenType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, c;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>( aiClass[*z] )&#123;  <span class=\"comment\">/* Switch on the character-class of the first byte</span></span><br><span class=\"line\"><span class=\"comment\">                          ** of the token. See the comment on the CC_ defines</span></span><br><span class=\"line\"><span class=\"comment\">                          ** above. */</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_SPACE: &#123;</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27; &#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\t&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\n&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\f&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\r&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isspace(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      *tokenType = TK_SPACE;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_VARNUM: &#123;</span><br><span class=\"line\">      *tokenType = TK_VARIABLE;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// .... more case</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_KYWD: &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; aiClass[z[i]]&lt;=CC_KYWD; i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( IdChar(z[i]) )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* This token started out using characters that can appear in keywords,</span></span><br><span class=\"line\"><span class=\"comment\">        ** but z[i] is a character not allowed within keywords, so this must</span></span><br><span class=\"line\"><span class=\"comment\">        ** be an identifier instead */</span></span><br><span class=\"line\">        i++;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      *tokenType = TK_ID;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> keywordCode((<span class=\"type\">char</span>*)z, i, tokenType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_X: &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> SQLITE_OMIT_BLOB_LITERAL</span></span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;x&#x27;</span> ); testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;X&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( z[<span class=\"number\">1</span>]==<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123;</span><br><span class=\"line\">        *tokenType = TK_BLOB;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(i=<span class=\"number\">2</span>; sqlite3Isxdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> || i%<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">          *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">          <span class=\"keyword\">while</span>( z[i] &amp;&amp; z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123; i++; &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i] ) i++;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"comment\">/* If it is not a BLOB literal, then it must be an ID, since no</span></span><br><span class=\"line\"><span class=\"comment\">      ** SQL keywords start with the letter &#x27;x&#x27;.  Fall through */</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_ID: &#123;</span><br><span class=\"line\">      i = <span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_NUL: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span>( IdChar(z[i]) )&#123; i++; &#125;</span><br><span class=\"line\">  *tokenType = TK_ID;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3GetToken</code>SQL(CC_SPACE,CC_NUL,)switch-case<em></em>(tokenType)Parser.h</p>\n<p><code>aiClass[*z]</code><code>switch(*z)</code></p>\n<p> <em>Switch-Case</em> </p>\n<p>switch-casecaseconstant<a href=\"http://blog.csdn.net/simmerlee/article/details/50845706\">C&#x2F;C++ switch</a></p>\n<ol>\n<li>casecase</li>\n<li>casecase</li>\n<li>O(logn)</li>\n</ol>\n<p>caseO(1)O(logn)SQLite</p>\n<p>ASCII:</p>\n<p>ASCII7bit8bit128256128ASCIISQLite256ASCII256<code>aiClass</code>ASCIISQLite29tokenize.c29switch-caseO(1)</p>\n<p>ASCII aiClass  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Character classes for tokenizing</span></span><br><span class=\"line\"><span class=\"comment\">**</span></span><br><span class=\"line\"><span class=\"comment\">** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented</span></span><br><span class=\"line\"><span class=\"comment\">** using a lookup table, whereas a switch() directly on c uses a binary search.</span></span><br><span class=\"line\"><span class=\"comment\">** The lookup table is much faster.  To maximize speed, and to ensure that</span></span><br><span class=\"line\"><span class=\"comment\">** a lookup table is used, all of the classes need to be small integers and</span></span><br><span class=\"line\"><span class=\"comment\">** all of them need to be used within the switch.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_X          0    <span class=\"comment\">/* The letter &#x27;x&#x27;, or start of BLOB literal */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_KYWD       1    <span class=\"comment\">/* Alphabetics or &#x27;_&#x27;.  Usable in a keyword */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ID         2    <span class=\"comment\">/* unicode characters usable in IDs */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DIGIT      3    <span class=\"comment\">/* Digits */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOLLAR     4    <span class=\"comment\">/* &#x27;$&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARALPHA   5    <span class=\"comment\">/* &#x27;@&#x27;, &#x27;#&#x27;, &#x27;:&#x27;.  Alphabetic SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARNUM     6    <span class=\"comment\">/* &#x27;?&#x27;.  Numeric SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SPACE      7    <span class=\"comment\">/* Space characters */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE      8    <span class=\"comment\">/* &#x27;&quot;&#x27;, &#x27;\\&#x27;&#x27;, or &#x27;`&#x27;.  String literals, quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE2     9    <span class=\"comment\">/* &#x27;[&#x27;.   [...] style quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PIPE      10    <span class=\"comment\">/* &#x27;|&#x27;.   Bitwise OR or concatenate */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_MINUS     11    <span class=\"comment\">/* &#x27;-&#x27;.  Minus or SQL-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LT        12    <span class=\"comment\">/* &#x27;&lt;&#x27;.  Part of &lt; or &lt;= or &lt;&gt; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_GT        13    <span class=\"comment\">/* &#x27;&gt;&#x27;.  Part of &gt; or &gt;= */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_EQ        14    <span class=\"comment\">/* &#x27;=&#x27;.  Part of = or == */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_BANG      15    <span class=\"comment\">/* &#x27;!&#x27;.  Part of != */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SLASH     16    <span class=\"comment\">/* &#x27;/&#x27;.  / or c-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LP        17    <span class=\"comment\">/* &#x27;(&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_RP        18    <span class=\"comment\">/* &#x27;)&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SEMI      19    <span class=\"comment\">/* &#x27;;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PLUS      20    <span class=\"comment\">/* &#x27;+&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_STAR      21    <span class=\"comment\">/* &#x27;*&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PERCENT   22    <span class=\"comment\">/* &#x27;%&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_COMMA     23    <span class=\"comment\">/* &#x27;,&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_AND       24    <span class=\"comment\">/* &#x27;&amp;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_TILDA     25    <span class=\"comment\">/* &#x27;~&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOT       26    <span class=\"comment\">/* &#x27;.&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ILLEGAL   27    <span class=\"comment\">/* Illegal character */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_NUL       28    <span class=\"comment\">/* 0x00 */</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> aiClass[] = &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\"><span class=\"comment\">/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */</span></span><br><span class=\"line\"><span class=\"comment\">/* 0x */</span>   <span class=\"number\">28</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 1x */</span>   <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 2x */</span>    <span class=\"number\">7</span>, <span class=\"number\">15</span>,  <span class=\"number\">8</span>,  <span class=\"number\">5</span>,  <span class=\"number\">4</span>, <span class=\"number\">22</span>, <span class=\"number\">24</span>,  <span class=\"number\">8</span>, <span class=\"number\">17</span>, <span class=\"number\">18</span>, <span class=\"number\">21</span>, <span class=\"number\">20</span>, <span class=\"number\">23</span>, <span class=\"number\">11</span>, <span class=\"number\">26</span>, <span class=\"number\">16</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 3x */</span>    <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">5</span>, <span class=\"number\">19</span>, <span class=\"number\">12</span>, <span class=\"number\">14</span>, <span class=\"number\">13</span>,  <span class=\"number\">6</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 4x */</span>    <span class=\"number\">5</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 5x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">9</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 6x */</span>    <span class=\"number\">8</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 7x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>, <span class=\"number\">27</span>, <span class=\"number\">10</span>, <span class=\"number\">27</span>, <span class=\"number\">25</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 8x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>, <span class=\"comment\">//128 2 CC_ID</span></span><br><span class=\"line\"><span class=\"comment\">/* 9x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ax */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Bx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Cx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Dx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ex */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Fx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>case CC_KYWD<code>keywordCode</code>SQLite<em>ID</em><code>keywordCode</code><a href=\"https://caio.ink/2020/07/16/19.SQLite-KeywordHash/\">SQLiteKeywordHash</a></p>"},{"title":"Transaction Management","date":"2020-08-20T16:00:00.000Z","_content":"\n> DBMSDBMSSQLiteACIDSQLiteSQLiteACID`Pager`SQLitepager\n\n<!-- more -->\n\n# \nDBMSDBMS()DBMSDBMSDBMSDBMSSQLite\n\n## \nSQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite\n\nSELECTSELECT\n\nselectSQLiteselectselectselectselectselectselectselect\n\n## \nselectSQL()SQL`BEGIN TRANSACTION`(`COMMIT TRANACTION``ROLLBACKTRANACTION`)SQL`begin-commit``begin-rolback`selectselect\n\n`BEGIN`SQLiteSQLselectselect`COMMIT``ROLLBACK`SQLiteSQLite\n\nSQLite\n\n## \nSQLiteSQLiteOK\n\n## \nselectSQLiteCOMMITABORTSQLite();SQLSQLite:\n\n```\nBEGIN TRANSACTION;\n    INSERT INTO table1 VALUES(100);\n    INSERT INTO table2 VALUES(20,100);\n    UPDATE table1 SET x=x+1 WHERE y > 10;\n    INSERT INTO table3 VALUES(1,2,3);\nCOMMIT TRANSACTION;\n```\n\ntable1table2table3`begin transaction`UPDATEINSERT`COMMIT TRANSACTIOIN`\n\n****:insertupdate5`Rollback`:`Abort`:`Fail`:`Ignore`:;`Replace`:;\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n# \nSQLite()-journal\n\n**vs**:SQLite`journal mode`(wal)(`pragma locking_mode=exclusive`)SQLite\n\nSQLite/SQLite(SQLite)SQLite\n\n:()SQLite\n\n****:SQLitemap\n\n****:page\n\nSQLiteattach(attach)\n\n****:()\n\n## \nSQLiteWALSQLite:SQLite\n\n## \nSQLiteflush\n\n****:SQLiteSQLiteSQLiteflushflush\n\n# \nSQLiteSQLite\n","source":"_posts/2020-08-21_db-system-design-imp(Transaction).md","raw":"---\ntitle: Transaction Management\ndate: 2020-08-21\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> DBMSDBMSSQLiteACIDSQLiteSQLiteACID`Pager`SQLitepager\n\n<!-- more -->\n\n# \nDBMSDBMS()DBMSDBMSDBMSDBMSSQLite\n\n## \nSQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite\n\nSELECTSELECT\n\nselectSQLiteselectselectselectselectselectselectselect\n\n## \nselectSQL()SQL`BEGIN TRANSACTION`(`COMMIT TRANACTION``ROLLBACKTRANACTION`)SQL`begin-commit``begin-rolback`selectselect\n\n`BEGIN`SQLiteSQLselectselect`COMMIT``ROLLBACK`SQLiteSQLite\n\nSQLite\n\n## \nSQLiteSQLiteOK\n\n## \nselectSQLiteCOMMITABORTSQLite();SQLSQLite:\n\n```\nBEGIN TRANSACTION;\n    INSERT INTO table1 VALUES(100);\n    INSERT INTO table2 VALUES(20,100);\n    UPDATE table1 SET x=x+1 WHERE y > 10;\n    INSERT INTO table3 VALUES(1,2,3);\nCOMMIT TRANSACTION;\n```\n\ntable1table2table3`begin transaction`UPDATEINSERT`COMMIT TRANSACTIOIN`\n\n****:insertupdate5`Rollback`:`Abort`:`Fail`:`Ignore`:;`Replace`:;\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n# \nSQLite()-journal\n\n**vs**:SQLite`journal mode`(wal)(`pragma locking_mode=exclusive`)SQLite\n\nSQLite/SQLite(SQLite)SQLite\n\n:()SQLite\n\n****:SQLitemap\n\n****:page\n\nSQLiteattach(attach)\n\n****:()\n\n## \nSQLiteWALSQLite:SQLite\n\n## \nSQLiteflush\n\n****:SQLiteSQLiteSQLiteflushflush\n\n# \nSQLiteSQLite\n","slug":"2020-08-21_db-system-design-imp(Transaction)","published":1,"updated":"2020-08-31T07:21:34.085Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61g000welc90rsi0nu0","content":"<blockquote>\n<p>DBMSDBMSSQLiteACIDSQLiteSQLiteACID<code>Pager</code>SQLitepager</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>DBMSDBMS()DBMSDBMSDBMSDBMSSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite</p>\n<p>SELECTSELECT</p>\n<p>selectSQLiteselectselectselectselectselectselectselect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQL()SQL<code>BEGIN TRANSACTION</code>(<code>COMMIT TRANACTION</code><code>ROLLBACKTRANACTION</code>)SQL<code>begin-commit</code><code>begin-rolback</code>selectselect</p>\n<p><code>BEGIN</code>SQLiteSQLselectselect<code>COMMIT</code><code>ROLLBACK</code>SQLiteSQLite</p>\n<p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQLiteOK</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQLiteCOMMITABORTSQLite();SQLSQLite:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BEGIN TRANSACTION;</span><br><span class=\"line\">    INSERT INTO table1 VALUES(100);</span><br><span class=\"line\">    INSERT INTO table2 VALUES(20,100);</span><br><span class=\"line\">    UPDATE table1 SET x=x+1 WHERE y &gt; 10;</span><br><span class=\"line\">    INSERT INTO table3 VALUES(1,2,3);</span><br><span class=\"line\">COMMIT TRANSACTION;</span><br></pre></td></tr></table></figure>\n\n<p>table1table2table3<code>begin transaction</code>UPDATEINSERT<code>COMMIT TRANSACTIOIN</code></p>\n<p><strong></strong>:insertupdate5<code>Rollback</code>:<code>Abort</code>:<code>Fail</code>:<code>Ignore</code>:;<code>Replace</code>:;</p>\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()-journal</p>\n<p><strong>vs</strong>:SQLite<code>journal mode</code>(wal)(<code>pragma locking_mode=exclusive</code>)SQLite</p>\n<p>SQLite&#x2F;SQLite(SQLite)SQLite</p>\n<p>:()SQLite</p>\n<p><strong></strong>:SQLitemap</p>\n<p><strong></strong>:page</p>\n<p>SQLiteattach(attach)</p>\n<p><strong></strong>:()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteWALSQLite:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteflush</p>\n<p><strong></strong>:SQLiteSQLiteSQLiteflushflush</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteSQLite</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>DBMSDBMSSQLiteACIDSQLiteSQLiteACID<code>Pager</code>SQLitepager</p>\n</blockquote>","more":"<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>DBMSDBMS()DBMSDBMSDBMSDBMSSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite</p>\n<p>SELECTSELECT</p>\n<p>selectSQLiteselectselectselectselectselectselectselect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQL()SQL<code>BEGIN TRANSACTION</code>(<code>COMMIT TRANACTION</code><code>ROLLBACKTRANACTION</code>)SQL<code>begin-commit</code><code>begin-rolback</code>selectselect</p>\n<p><code>BEGIN</code>SQLiteSQLselectselect<code>COMMIT</code><code>ROLLBACK</code>SQLiteSQLite</p>\n<p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQLiteOK</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQLiteCOMMITABORTSQLite();SQLSQLite:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BEGIN TRANSACTION;</span><br><span class=\"line\">    INSERT INTO table1 VALUES(100);</span><br><span class=\"line\">    INSERT INTO table2 VALUES(20,100);</span><br><span class=\"line\">    UPDATE table1 SET x=x+1 WHERE y &gt; 10;</span><br><span class=\"line\">    INSERT INTO table3 VALUES(1,2,3);</span><br><span class=\"line\">COMMIT TRANSACTION;</span><br></pre></td></tr></table></figure>\n\n<p>table1table2table3<code>begin transaction</code>UPDATEINSERT<code>COMMIT TRANSACTIOIN</code></p>\n<p><strong></strong>:insertupdate5<code>Rollback</code>:<code>Abort</code>:<code>Fail</code>:<code>Ignore</code>:;<code>Replace</code>:;</p>\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()-journal</p>\n<p><strong>vs</strong>:SQLite<code>journal mode</code>(wal)(<code>pragma locking_mode=exclusive</code>)SQLite</p>\n<p>SQLite&#x2F;SQLite(SQLite)SQLite</p>\n<p>:()SQLite</p>\n<p><strong></strong>:SQLitemap</p>\n<p><strong></strong>:page</p>\n<p>SQLiteattach(attach)</p>\n<p><strong></strong>:()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteWALSQLite:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteflush</p>\n<p><strong></strong>:SQLiteSQLiteSQLiteflushflush</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteSQLite</p>"},{"title":"Storage","date":"2020-08-24T16:00:00.000Z","_content":"\n> SQLiteB/B+WAL\n\n<!-- more -->\n\n<!---\n# \n--->\n\n# \nSQLite//(flush)\n\n## \n/SQLite()112001(Pager)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png)\n\n## \n10242[512(=2^9),65536(=2^16)]2(2^31-1)pager.c`PAGER_MAX_PGNO`140TB\n\n****:SQLitepragmaSQLiteSQLite\n\n## \nSQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()\n\n## \nSQLite1B+`sqlite_master``sqlite_temp_master`1000\n\nSQLite\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 16 | \"SQLite format 3\" |\n| 16 | 2 |  |\n| 18 | 1 |  |\n| 19 | 1 |  |\n| 20 | 1 |  |\n| 21 | 1 |  |\n| 22 | 1 |  |\n| 23 | 1 |  |\n| 24 | 4 |  |\n| 28 | 4 |  |\n| 32 | 4 |  |\n| 36 | 4 |  |\n| 40 | 4 |  |\n| 44 | 56 | 144 |\n\n* ****:16UTF-8\"SQLite format 3\"\n* ****:2n[51232768]165536SQLite()\n* ****:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)\n* ****:SQLite255200SQLite480\n* ****:21B/B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B\n* ****:0pager(WAL)\n* ****:28\n* ****:3236\n* ****:4040()\n* ****:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296\n\n** vs. **:5246440`vacuum`\n\n1B+`sqlite_master``sqlite_temp_master`1SQLite\n\n## \n3236()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png)\n\n:(1)4(0)(2)(3)\n\nSQLiteSQLite()SQLite\n\n`VACUUM``autovacuum`\n\n****`vacuum`\n\n# \nSQLite(SQLite3.7.0SQLiteWALWAL)\n\n## \nSQLite()SQLite\n\nSQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png)\n\n### \n8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 `nRec`)`nRec`-10\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png)\n\n****:SQLite512SQLite\n\nSQLite(pager****)`nRec`-1\n\n****:00\n\n****:SQLite`nRec`-1SQLite`pragma`case\n\n### \nselectSQLite432432SQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png)\n\n****:SQLite\n\n## \nSQLiteetilqs_SQLite`nRec`\n\n****:SAVEPOINTSQLite\n\n## \n`ATTACH`SQLiteSQLiteUTF-8()'-mj'816\n\n()UTF-8SQLitewindowsPOSIX()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png)","source":"_posts/2020-08-25_db-system-design-im(storage).md","raw":"---\ntitle: Storage\ndate: 2020-08-25\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLiteB/B+WAL\n\n<!-- more -->\n\n<!---\n# \n--->\n\n# \nSQLite//(flush)\n\n## \n/SQLite()112001(Pager)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png)\n\n## \n10242[512(=2^9),65536(=2^16)]2(2^31-1)pager.c`PAGER_MAX_PGNO`140TB\n\n****:SQLitepragmaSQLiteSQLite\n\n## \nSQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()\n\n## \nSQLite1B+`sqlite_master``sqlite_temp_master`1000\n\nSQLite\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 16 | \"SQLite format 3\" |\n| 16 | 2 |  |\n| 18 | 1 |  |\n| 19 | 1 |  |\n| 20 | 1 |  |\n| 21 | 1 |  |\n| 22 | 1 |  |\n| 23 | 1 |  |\n| 24 | 4 |  |\n| 28 | 4 |  |\n| 32 | 4 |  |\n| 36 | 4 |  |\n| 40 | 4 |  |\n| 44 | 56 | 144 |\n\n* ****:16UTF-8\"SQLite format 3\"\n* ****:2n[51232768]165536SQLite()\n* ****:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)\n* ****:SQLite255200SQLite480\n* ****:21B/B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B\n* ****:0pager(WAL)\n* ****:28\n* ****:3236\n* ****:4040()\n* ****:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296\n\n** vs. **:5246440`vacuum`\n\n1B+`sqlite_master``sqlite_temp_master`1SQLite\n\n## \n3236()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png)\n\n:(1)4(0)(2)(3)\n\nSQLiteSQLite()SQLite\n\n`VACUUM``autovacuum`\n\n****`vacuum`\n\n# \nSQLite(SQLite3.7.0SQLiteWALWAL)\n\n## \nSQLite()SQLite\n\nSQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png)\n\n### \n8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 `nRec`)`nRec`-10\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png)\n\n****:SQLite512SQLite\n\nSQLite(pager****)`nRec`-1\n\n****:00\n\n****:SQLite`nRec`-1SQLite`pragma`case\n\n### \nselectSQLite432432SQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png)\n\n****:SQLite\n\n## \nSQLiteetilqs_SQLite`nRec`\n\n****:SAVEPOINTSQLite\n\n## \n`ATTACH`SQLiteSQLiteUTF-8()'-mj'816\n\n()UTF-8SQLitewindowsPOSIX()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png)","slug":"2020-08-25_db-system-design-im(storage)","published":1,"updated":"2020-08-31T07:21:34.086Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61h000zelc905q9bk63","content":"<blockquote>\n<p>SQLiteB&#x2F;B+WAL</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<!---\n# \n--->\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite&#x2F;&#x2F;(flush)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>&#x2F;SQLite()112001(Pager)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>10242[512(&#x3D;2^9),65536(&#x3D;2^16)]2(2^31-1)pager.c<code>PAGER_MAX_PGNO</code>140TB</p>\n<p><strong></strong>:SQLitepragmaSQLiteSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1000</p>\n<p>SQLite</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>16</td>\n<td>SQLite format 3</td>\n</tr>\n<tr>\n<td>16</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>18</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>19</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>20</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>21</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>22</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>23</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>32</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>36</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>40</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>44</td>\n<td>56</td>\n<td>144</td>\n</tr>\n</tbody></table>\n<ul>\n<li><strong></strong>:16UTF-8SQLite format 3</li>\n<li><strong></strong>:2n[51232768]165536SQLite()</li>\n<li><strong></strong>:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)</li>\n<li><strong></strong>:SQLite255200SQLite480</li>\n<li><strong></strong>:21B&#x2F;B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B</li>\n<li><strong></strong>:0pager(WAL)</li>\n<li><strong></strong>:28</li>\n<li><strong></strong>:3236</li>\n<li><strong></strong>:4040()</li>\n<li><strong></strong>:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296</li>\n</ul>\n<p><strong> vs. </strong>:5246440<code>vacuum</code></p>\n<p>1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>3236()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png\"></p>\n<p>:(1)4(0)(2)(3)</p>\n<p>SQLiteSQLite()SQLite</p>\n<p><code>VACUUM</code><code>autovacuum</code></p>\n<p><strong></strong><code>vacuum</code></p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite(SQLite3.7.0SQLiteWALWAL)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()SQLite</p>\n<p>SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 <code>nRec</code>)<code>nRec</code>-10</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png\"></p>\n<p><strong></strong>:SQLite512SQLite</p>\n<p>SQLite(pager<strong></strong>)<code>nRec</code>-1</p>\n<p><strong></strong>:00</p>\n<p><strong></strong>:SQLite<code>nRec</code>-1SQLite<code>pragma</code>case</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>selectSQLite432432SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png\"></p>\n<p><strong></strong>:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteetilqs_SQLite<code>nRec</code></p>\n<p><strong></strong>:SAVEPOINTSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>ATTACH</code>SQLiteSQLiteUTF-8()-mj816</p>\n<p>()UTF-8SQLitewindowsPOSIX()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png\"></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLiteB&#x2F;B+WAL</p>\n</blockquote>","more":"<!---\n# \n--->\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite&#x2F;&#x2F;(flush)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>&#x2F;SQLite()112001(Pager)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>10242[512(&#x3D;2^9),65536(&#x3D;2^16)]2(2^31-1)pager.c<code>PAGER_MAX_PGNO</code>140TB</p>\n<p><strong></strong>:SQLitepragmaSQLiteSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1000</p>\n<p>SQLite</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>16</td>\n<td>SQLite format 3</td>\n</tr>\n<tr>\n<td>16</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>18</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>19</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>20</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>21</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>22</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>23</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>32</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>36</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>40</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>44</td>\n<td>56</td>\n<td>144</td>\n</tr>\n</tbody></table>\n<ul>\n<li><strong></strong>:16UTF-8SQLite format 3</li>\n<li><strong></strong>:2n[51232768]165536SQLite()</li>\n<li><strong></strong>:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)</li>\n<li><strong></strong>:SQLite255200SQLite480</li>\n<li><strong></strong>:21B&#x2F;B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B</li>\n<li><strong></strong>:0pager(WAL)</li>\n<li><strong></strong>:28</li>\n<li><strong></strong>:3236</li>\n<li><strong></strong>:4040()</li>\n<li><strong></strong>:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296</li>\n</ul>\n<p><strong> vs. </strong>:5246440<code>vacuum</code></p>\n<p>1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>3236()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png\"></p>\n<p>:(1)4(0)(2)(3)</p>\n<p>SQLiteSQLite()SQLite</p>\n<p><code>VACUUM</code><code>autovacuum</code></p>\n<p><strong></strong><code>vacuum</code></p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite(SQLite3.7.0SQLiteWALWAL)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()SQLite</p>\n<p>SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 <code>nRec</code>)<code>nRec</code>-10</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png\"></p>\n<p><strong></strong>:SQLite512SQLite</p>\n<p>SQLite(pager<strong></strong>)<code>nRec</code>-1</p>\n<p><strong></strong>:00</p>\n<p><strong></strong>:SQLite<code>nRec</code>-1SQLite<code>pragma</code>case</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>selectSQLite432432SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png\"></p>\n<p><strong></strong>:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteetilqs_SQLite<code>nRec</code></p>\n<p><strong></strong>:SAVEPOINTSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>ATTACH</code>SQLiteSQLiteUTF-8()-mj816</p>\n<p>()UTF-8SQLitewindowsPOSIX()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png\"></p>"},{"title":"WAL Mode","date":"2020-08-28T16:00:00.000Z","_content":"\nrelease 3.7.0SQLiteWAL`pragma journal_mode=WAL`WAL(Pager182)SQLiteWALwal'-wal'\n\n()walwal\n\nwal32wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 | :0x377f0682()  0x377f0683() |\n| 4 | 4 |  |\n| 8 | 4 |  |\n| 12 | 4 |  |\n| 16 | 4 | -1:  |\n| 20 | 4 | -2:  |\n| 24 | 4 | -1: 24 |\n| 28 | 4 | -2: 24 |\n\nwal24wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 |  |\n| 4 | 4 | <br/>0 |\n| 8 | 4 | -1 WAL |\n| 12 | 4 | -2 WAL |\n| 16 | 4 | -1:8 |\n| 20 | 4 | -2:8 |\n\nwalpagerWAL()pagerpWALppagerpwalpagerpSQLite`wal-index`p\n\n`wal-index`'-shm'(wal)SQLite`wal-index``wal-index`wal`wal-index`\n\nwalwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:\n\n* flushwal\n* \n* flush(wal)\n* wal-1-2(wal)\n* `wal-index`\n\nwal;wal\n\nflush(journalflushflush`nRec`)WALflushflush(`PRAGMA synchronous=FULL`flush`PRAGMA synchronous=NORMAL`flush)\n\n`sqlite3_wal_hook()`WALhook`sqlite3_wal_checkpoint()`  `sqlite3_wal_checkpoint_v2()` `sqlite3_wal_hook()`checkpointPASSIVEFULLRESTART`sqlite3_wal_checkpoint()`PASSIVEFULLRESTART`sqlite3_wal_checkpoint_v2()`\n\n**:**48x(0)-x(N),x4N:\n\n```c\ns0 = s1 = 0\nfor i from 0 to n-1 step 2:\n   s0 += x(i) + s1;\n   s1 += x(i+1) + s0;\nend for\n//result in s0 and s1\n```\n\ns0s1()s132s0\n\n\n\n:\n1. flush\n2. \n3. \n\n:\n1. \n2. \n3. NFS\n4. \n5. \n6. (-wal,-shm)\n7. ","source":"_posts/2020-08-29_db_system_design_imp(WAL).md","raw":"---\ntitle: WAL Mode\ndate: 2020-08-29\ntags: [sqlite3]\ncategories: sqlite3\n---\n\nrelease 3.7.0SQLiteWAL`pragma journal_mode=WAL`WAL(Pager182)SQLiteWALwal'-wal'\n\n()walwal\n\nwal32wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 | :0x377f0682()  0x377f0683() |\n| 4 | 4 |  |\n| 8 | 4 |  |\n| 12 | 4 |  |\n| 16 | 4 | -1:  |\n| 20 | 4 | -2:  |\n| 24 | 4 | -1: 24 |\n| 28 | 4 | -2: 24 |\n\nwal24wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 |  |\n| 4 | 4 | <br/>0 |\n| 8 | 4 | -1 WAL |\n| 12 | 4 | -2 WAL |\n| 16 | 4 | -1:8 |\n| 20 | 4 | -2:8 |\n\nwalpagerWAL()pagerpWALppagerpwalpagerpSQLite`wal-index`p\n\n`wal-index`'-shm'(wal)SQLite`wal-index``wal-index`wal`wal-index`\n\nwalwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:\n\n* flushwal\n* \n* flush(wal)\n* wal-1-2(wal)\n* `wal-index`\n\nwal;wal\n\nflush(journalflushflush`nRec`)WALflushflush(`PRAGMA synchronous=FULL`flush`PRAGMA synchronous=NORMAL`flush)\n\n`sqlite3_wal_hook()`WALhook`sqlite3_wal_checkpoint()`  `sqlite3_wal_checkpoint_v2()` `sqlite3_wal_hook()`checkpointPASSIVEFULLRESTART`sqlite3_wal_checkpoint()`PASSIVEFULLRESTART`sqlite3_wal_checkpoint_v2()`\n\n**:**48x(0)-x(N),x4N:\n\n```c\ns0 = s1 = 0\nfor i from 0 to n-1 step 2:\n   s0 += x(i) + s1;\n   s1 += x(i+1) + s0;\nend for\n//result in s0 and s1\n```\n\ns0s1()s132s0\n\n\n\n:\n1. flush\n2. \n3. \n\n:\n1. \n2. \n3. NFS\n4. \n5. \n6. (-wal,-shm)\n7. ","slug":"2020-08-29_db_system_design_imp(WAL)","published":1,"updated":"2020-08-31T07:21:34.086Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61i0013elc9cb4t7pz9","content":"<p>release 3.7.0SQLiteWAL<code>pragma journal_mode=WAL</code>WAL(Pager182)SQLiteWALwal-wal</p>\n<p>()walwal</p>\n<p>wal32wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td>:0x377f0682()  0x377f0683()</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1: </td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2: </td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td>-1: 24</td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td>-2: 24</td>\n</tr>\n</tbody></table>\n<p>wal24wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td><br/>0</td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td>-1 WAL</td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td>-2 WAL</td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1:8</td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2:8</td>\n</tr>\n</tbody></table>\n<p>walpagerWAL()pagerpWALppagerpwalpagerpSQLite<code>wal-index</code>p</p>\n<p><code>wal-index</code>-shm(wal)SQLite<code>wal-index</code><code>wal-index</code>wal<code>wal-index</code></p>\n<p>walwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:</p>\n<ul>\n<li>flushwal</li>\n<li></li>\n<li>flush(wal)</li>\n<li>wal-1-2(wal)</li>\n<li><code>wal-index</code></li>\n</ul>\n<p>wal;wal</p>\n<p>flush(journalflushflush<code>nRec</code>)WALflushflush(<code>PRAGMA synchronous=FULL</code>flush<code>PRAGMA synchronous=NORMAL</code>flush)</p>\n<p><code>sqlite3_wal_hook()</code>WALhook<code>sqlite3_wal_checkpoint()</code>  <code>sqlite3_wal_checkpoint_v2()</code> <code>sqlite3_wal_hook()</code>checkpointPASSIVEFULLRESTART<code>sqlite3_wal_checkpoint()</code>PASSIVEFULLRESTART<code>sqlite3_wal_checkpoint_v2()</code></p>\n<p>**:**48x(0)-x(N),x4N:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s0 = s1 = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i from <span class=\"number\">0</span> to n<span class=\"number\">-1</span> step <span class=\"number\">2</span>:</span><br><span class=\"line\">   s0 += x(i) + s1;</span><br><span class=\"line\">   s1 += x(i+<span class=\"number\">1</span>) + s0;</span><br><span class=\"line\">end <span class=\"keyword\">for</span></span><br><span class=\"line\"><span class=\"comment\">//result in s0 and s1</span></span><br></pre></td></tr></table></figure>\n\n<p>s0s1()s132s0</p>\n<p></p>\n<p>:</p>\n<ol>\n<li>flush</li>\n<li></li>\n<li></li>\n</ol>\n<p>:</p>\n<ol>\n<li></li>\n<li></li>\n<li>NFS</li>\n<li></li>\n<li></li>\n<li>(-wal,-shm)</li>\n<li></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>release 3.7.0SQLiteWAL<code>pragma journal_mode=WAL</code>WAL(Pager182)SQLiteWALwal-wal</p>\n<p>()walwal</p>\n<p>wal32wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td>:0x377f0682()  0x377f0683()</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1: </td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2: </td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td>-1: 24</td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td>-2: 24</td>\n</tr>\n</tbody></table>\n<p>wal24wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td><br/>0</td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td>-1 WAL</td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td>-2 WAL</td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1:8</td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2:8</td>\n</tr>\n</tbody></table>\n<p>walpagerWAL()pagerpWALppagerpwalpagerpSQLite<code>wal-index</code>p</p>\n<p><code>wal-index</code>-shm(wal)SQLite<code>wal-index</code><code>wal-index</code>wal<code>wal-index</code></p>\n<p>walwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:</p>\n<ul>\n<li>flushwal</li>\n<li></li>\n<li>flush(wal)</li>\n<li>wal-1-2(wal)</li>\n<li><code>wal-index</code></li>\n</ul>\n<p>wal;wal</p>\n<p>flush(journalflushflush<code>nRec</code>)WALflushflush(<code>PRAGMA synchronous=FULL</code>flush<code>PRAGMA synchronous=NORMAL</code>flush)</p>\n<p><code>sqlite3_wal_hook()</code>WALhook<code>sqlite3_wal_checkpoint()</code>  <code>sqlite3_wal_checkpoint_v2()</code> <code>sqlite3_wal_hook()</code>checkpointPASSIVEFULLRESTART<code>sqlite3_wal_checkpoint()</code>PASSIVEFULLRESTART<code>sqlite3_wal_checkpoint_v2()</code></p>\n<p>**:**48x(0)-x(N),x4N:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s0 = s1 = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i from <span class=\"number\">0</span> to n<span class=\"number\">-1</span> step <span class=\"number\">2</span>:</span><br><span class=\"line\">   s0 += x(i) + s1;</span><br><span class=\"line\">   s1 += x(i+<span class=\"number\">1</span>) + s0;</span><br><span class=\"line\">end <span class=\"keyword\">for</span></span><br><span class=\"line\"><span class=\"comment\">//result in s0 and s1</span></span><br></pre></td></tr></table></figure>\n\n<p>s0s1()s132s0</p>\n<p></p>\n<p>:</p>\n<ol>\n<li>flush</li>\n<li></li>\n<li></li>\n</ol>\n<p>:</p>\n<ol>\n<li></li>\n<li></li>\n<li>NFS</li>\n<li></li>\n<li></li>\n<li>(-wal,-shm)</li>\n<li></li>\n</ol>\n"},{"title":"","date":"2019-12-16T16:00:00.000Z","_content":"\n## Linux\n\n\n1. \n2. PIC\n\n### \n\n\n\n\n\n...TEXT\n\n\n\n\n\nTEXT\n\nPIC\n\n### PIC\n\nPIC\n\n1. \n\nTEXT\n\n +\n\nTEXTDATA\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png)\n\n\n\nx86\n```\n    call TMPLABEL\nTMPLABEL:\n    pop ebx\n```\n\ncall TMPLABEL TMPLABEL pop ebxebxebx\n\n2. \n\nGOTGOT\n\nTEXT(A)TEXTAGOTA\n\nGOT\n\nPIC\n1. PICGOTPICGOT\n2. PICPIC\n\n### PIC\n\nPICPICGOT\n\n80%20%\n\n\n\nBind\n\n\n\nPLT\n\n1. \"\",GOT.\n2. GOT\n3. GOT\n\nPLT()\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png)\n\nGOTBindGOT\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png)\n\n## iOS\niOSLinux\n\nDemoNSLog\n\n```\n@interface ViewController ()\n@end\n\n@implementation ViewController\n- (void)viewDidLoad {\n    [super viewDidLoad];\n    // Do any additional setup after loading the view.\n    NSLog(@\"1\");\n    NSLog(@\"2\");\n}\n@end\n```\n\n### \n\n\n __TEXT  __text \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png)\n\nNSLogbl  0x100006558NSLog\n\n0x6558Text0x100000000,Load Commands\n\n0x6558__TEXT__stubsLinuxNSLog\n\n...MachOView\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png)\n\n...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png)\n\n__stubsimp__sthubs_NSLog\n```\nldr x16#0x10000c000\nbl x16\n```\nNSLog #0x10000c000 ...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png)\n\n__la_symbol_ptr,---GOTGOTNSLog0x660C\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png)\n\n__stub_helper...PLT\n\n```\nldr w16,0x100006614\nb 0x1000065f4\n.long 0x000000000\n```\n 0x100006614 w160 0x1000065f4\n0x1000065f4 __stub_helper dyld_stub_binder\n 0x100006614 dyld\n\n __la_symbol_ptr Bind\n\n**iOS**\n1. \n2. GOTGOT__stub_helper\n3. helperdyldBindBind\n\niOSLinuxiOSdyld\"__stub_helper\" \n\n### \nNSLog...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png)\n\n bl 0x100f46558 (NSLog)\n\n Xcode dis\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png)\n\n`ldr  x16, #0x5aa4` x1  +0x5aa4 = 0x100F4C000 Xcode\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png)\n\n 0x100f4660c  __la_symbol_ptr  __stubs_helper \n\n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png)\n\nNSLog...\n\n 0x100F4C000 \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png)\n\n 0x109c76e754\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png)\n\nNSLog~\n\n> Linux iOSiOSdyld\n\n\n\n[iOS  - ](https://www.jianshu.com/p/857855cda602)\n[](https://blog.csdn.net/parallelyk/article/details/42747239)\n[](https://blog.csdn.net/wuhui_gdnt/article/details/51035557)\n[PIC](https://blog.csdn.net/wuhui_gdnt/article/details/51094732)\n\n","source":"_posts/3.binding-symbols.md","raw":"---\ntitle: \ndate: 2019-12-17\ntags: [,]\ncategories: \n---\n\n## Linux\n\n\n1. \n2. PIC\n\n### \n\n\n\n\n\n...TEXT\n\n\n\n\n\nTEXT\n\nPIC\n\n### PIC\n\nPIC\n\n1. \n\nTEXT\n\n +\n\nTEXTDATA\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png)\n\n\n\nx86\n```\n    call TMPLABEL\nTMPLABEL:\n    pop ebx\n```\n\ncall TMPLABEL TMPLABEL pop ebxebxebx\n\n2. \n\nGOTGOT\n\nTEXT(A)TEXTAGOTA\n\nGOT\n\nPIC\n1. PICGOTPICGOT\n2. PICPIC\n\n### PIC\n\nPICPICGOT\n\n80%20%\n\n\n\nBind\n\n\n\nPLT\n\n1. \"\",GOT.\n2. GOT\n3. GOT\n\nPLT()\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png)\n\nGOTBindGOT\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png)\n\n## iOS\niOSLinux\n\nDemoNSLog\n\n```\n@interface ViewController ()\n@end\n\n@implementation ViewController\n- (void)viewDidLoad {\n    [super viewDidLoad];\n    // Do any additional setup after loading the view.\n    NSLog(@\"1\");\n    NSLog(@\"2\");\n}\n@end\n```\n\n### \n\n\n __TEXT  __text \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png)\n\nNSLogbl  0x100006558NSLog\n\n0x6558Text0x100000000,Load Commands\n\n0x6558__TEXT__stubsLinuxNSLog\n\n...MachOView\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png)\n\n...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png)\n\n__stubsimp__sthubs_NSLog\n```\nldr x16#0x10000c000\nbl x16\n```\nNSLog #0x10000c000 ...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png)\n\n__la_symbol_ptr,---GOTGOTNSLog0x660C\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png)\n\n__stub_helper...PLT\n\n```\nldr w16,0x100006614\nb 0x1000065f4\n.long 0x000000000\n```\n 0x100006614 w160 0x1000065f4\n0x1000065f4 __stub_helper dyld_stub_binder\n 0x100006614 dyld\n\n __la_symbol_ptr Bind\n\n**iOS**\n1. \n2. GOTGOT__stub_helper\n3. helperdyldBindBind\n\niOSLinuxiOSdyld\"__stub_helper\" \n\n### \nNSLog...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png)\n\n bl 0x100f46558 (NSLog)\n\n Xcode dis\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png)\n\n`ldr  x16, #0x5aa4` x1  +0x5aa4 = 0x100F4C000 Xcode\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png)\n\n 0x100f4660c  __la_symbol_ptr  __stubs_helper \n\n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png)\n\nNSLog...\n\n 0x100F4C000 \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png)\n\n 0x109c76e754\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png)\n\nNSLog~\n\n> Linux iOSiOSdyld\n\n\n\n[iOS  - ](https://www.jianshu.com/p/857855cda602)\n[](https://blog.csdn.net/parallelyk/article/details/42747239)\n[](https://blog.csdn.net/wuhui_gdnt/article/details/51035557)\n[PIC](https://blog.csdn.net/wuhui_gdnt/article/details/51094732)\n\n","slug":"3.binding-symbols","published":1,"updated":"2020-08-29T14:42:58.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61j0016elc97ag28wjy","content":"<h2 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h2><p></p>\n<ol>\n<li></li>\n<li>PIC</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p></p>\n<p>TEXT</p>\n<p></p>\n<p></p>\n<p>TEXT</p>\n<p>PIC</p>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PIC</p>\n<ol>\n<li></li>\n</ol>\n<p>TEXT</p>\n<p> +</p>\n<p>TEXTDATA</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png\"></p>\n<p></p>\n<p>x86</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    call TMPLABEL</span><br><span class=\"line\">TMPLABEL:</span><br><span class=\"line\">    pop ebx</span><br></pre></td></tr></table></figure>\n\n<p>call TMPLABEL TMPLABEL pop ebxebxebx</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>GOTGOT</p>\n<p>TEXT(A)TEXTAGOTA</p>\n<p>GOT</p>\n<p>PIC</p>\n<ol>\n<li>PICGOTPICGOT</li>\n<li>PICPIC</li>\n</ol>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PICPICGOT</p>\n<p>80%20%</p>\n<p></p>\n<p>Bind</p>\n<p></p>\n<p>PLT</p>\n<ol>\n<li>,GOT.</li>\n<li>GOT</li>\n<li>GOT</li>\n</ol>\n<p>PLT()<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png\"></p>\n<p>GOTBindGOT</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png\"></p>\n<h2 id=\"iOS\"><a href=\"#iOS\" class=\"headerlink\" title=\"iOS\"></a>iOS</h2><p>iOSLinux</p>\n<p>DemoNSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@interface ViewController ()</span><br><span class=\"line\">@end</span><br><span class=\"line\"></span><br><span class=\"line\">@implementation ViewController</span><br><span class=\"line\">- (void)viewDidLoad &#123;</span><br><span class=\"line\">    [super viewDidLoad];</span><br><span class=\"line\">    // Do any additional setup after loading the view.</span><br><span class=\"line\">    NSLog(@&quot;1&quot;);</span><br><span class=\"line\">    NSLog(@&quot;2&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p> __TEXT  __text </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png\"></p>\n<p>NSLogbl  0x100006558NSLog</p>\n<p>0x6558Text0x100000000,Load Commands</p>\n<p>0x6558__TEXT__stubsLinuxNSLog</p>\n<p>MachOView<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png\"></p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png\"></p>\n<p>__stubsimp__sthubs_NSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr x16#0x10000c000</span><br><span class=\"line\">bl x16</span><br></pre></td></tr></table></figure>\n<p>NSLog #0x10000c000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png\"></p>\n<p>__la_symbol_ptr,GOTGOTNSLog0x660C</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png\"></p>\n<p>__stub_helperPLT</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr w16,0x100006614</span><br><span class=\"line\">b 0x1000065f4</span><br><span class=\"line\">.long 0x000000000</span><br></pre></td></tr></table></figure>\n<p> 0x100006614 w160 0x1000065f4<br>0x1000065f4 __stub_helper dyld_stub_binder<br> 0x100006614 dyld</p>\n<p> __la_symbol_ptr Bind</p>\n<p><strong>iOS</strong></p>\n<ol>\n<li></li>\n<li>GOTGOT__stub_helper</li>\n<li>helperdyldBindBind</li>\n</ol>\n<p>iOSLinuxiOSdyld__stub_helper </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NSLog<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png\"></p>\n<p> bl 0x100f46558 (NSLog)</p>\n<p> Xcode dis<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png\"></p>\n<p><code>ldr  x16, #0x5aa4</code> x1  +0x5aa4 &#x3D; 0x100F4C000 Xcode<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png\"></p>\n<p> 0x100f4660c  __la_symbol_ptr  __stubs_helper </p>\n<p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png\"></p>\n<p>NSLog</p>\n<p> 0x100F4C000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png\"></p>\n<p> 0x109c76e754<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png\"></p>\n<p>NSLog~</p>\n<blockquote>\n<p>Linux iOSiOSdyld</p>\n</blockquote>\n<p><br><a href=\"https://www.jianshu.com/p/857855cda602\">iOS  - </a><br><a href=\"https://blog.csdn.net/parallelyk/article/details/42747239\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51035557\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51094732\">PIC</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h2><p></p>\n<ol>\n<li></li>\n<li>PIC</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p></p>\n<p>TEXT</p>\n<p></p>\n<p></p>\n<p>TEXT</p>\n<p>PIC</p>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PIC</p>\n<ol>\n<li></li>\n</ol>\n<p>TEXT</p>\n<p> +</p>\n<p>TEXTDATA</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png\"></p>\n<p></p>\n<p>x86</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    call TMPLABEL</span><br><span class=\"line\">TMPLABEL:</span><br><span class=\"line\">    pop ebx</span><br></pre></td></tr></table></figure>\n\n<p>call TMPLABEL TMPLABEL pop ebxebxebx</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>GOTGOT</p>\n<p>TEXT(A)TEXTAGOTA</p>\n<p>GOT</p>\n<p>PIC</p>\n<ol>\n<li>PICGOTPICGOT</li>\n<li>PICPIC</li>\n</ol>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PICPICGOT</p>\n<p>80%20%</p>\n<p></p>\n<p>Bind</p>\n<p></p>\n<p>PLT</p>\n<ol>\n<li>,GOT.</li>\n<li>GOT</li>\n<li>GOT</li>\n</ol>\n<p>PLT()<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png\"></p>\n<p>GOTBindGOT</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png\"></p>\n<h2 id=\"iOS\"><a href=\"#iOS\" class=\"headerlink\" title=\"iOS\"></a>iOS</h2><p>iOSLinux</p>\n<p>DemoNSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@interface ViewController ()</span><br><span class=\"line\">@end</span><br><span class=\"line\"></span><br><span class=\"line\">@implementation ViewController</span><br><span class=\"line\">- (void)viewDidLoad &#123;</span><br><span class=\"line\">    [super viewDidLoad];</span><br><span class=\"line\">    // Do any additional setup after loading the view.</span><br><span class=\"line\">    NSLog(@&quot;1&quot;);</span><br><span class=\"line\">    NSLog(@&quot;2&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p> __TEXT  __text </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png\"></p>\n<p>NSLogbl  0x100006558NSLog</p>\n<p>0x6558Text0x100000000,Load Commands</p>\n<p>0x6558__TEXT__stubsLinuxNSLog</p>\n<p>MachOView<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png\"></p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png\"></p>\n<p>__stubsimp__sthubs_NSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr x16#0x10000c000</span><br><span class=\"line\">bl x16</span><br></pre></td></tr></table></figure>\n<p>NSLog #0x10000c000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png\"></p>\n<p>__la_symbol_ptr,GOTGOTNSLog0x660C</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png\"></p>\n<p>__stub_helperPLT</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr w16,0x100006614</span><br><span class=\"line\">b 0x1000065f4</span><br><span class=\"line\">.long 0x000000000</span><br></pre></td></tr></table></figure>\n<p> 0x100006614 w160 0x1000065f4<br>0x1000065f4 __stub_helper dyld_stub_binder<br> 0x100006614 dyld</p>\n<p> __la_symbol_ptr Bind</p>\n<p><strong>iOS</strong></p>\n<ol>\n<li></li>\n<li>GOTGOT__stub_helper</li>\n<li>helperdyldBindBind</li>\n</ol>\n<p>iOSLinuxiOSdyld__stub_helper </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NSLog<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png\"></p>\n<p> bl 0x100f46558 (NSLog)</p>\n<p> Xcode dis<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png\"></p>\n<p><code>ldr  x16, #0x5aa4</code> x1  +0x5aa4 &#x3D; 0x100F4C000 Xcode<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png\"></p>\n<p> 0x100f4660c  __la_symbol_ptr  __stubs_helper </p>\n<p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png\"></p>\n<p>NSLog</p>\n<p> 0x100F4C000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png\"></p>\n<p> 0x109c76e754<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png\"></p>\n<p>NSLog~</p>\n<blockquote>\n<p>Linux iOSiOSdyld</p>\n</blockquote>\n<p><br><a href=\"https://www.jianshu.com/p/857855cda602\">iOS  - </a><br><a href=\"https://blog.csdn.net/parallelyk/article/details/42747239\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51035557\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51094732\">PIC</a></p>\n"},{"title":" dyld ","date":"2020-03-12T16:00:00.000Z","_content":"\n.......\n\ndyld/dyld ASLRobjcruntimedyld\n\n<!-- more -->\n\n## dyld \ndyld dyldStartup.s :load dyld`__dyld_start``dyld::start` \n\n`dyld::start`\n\n```cpp\nuintptr_t start(const struct macho_header* appsMachHeader, int argc, const char* argv[], \n\t\t\t\tintptr_t slide, const struct macho_header* dyldsMachHeader,\n\t\t\t\tuintptr_t* startGlue)\n{\n\t// if kernel had to slide dyld, we need to fix up load sensitive locations\n\t// we have to do this before using any global variables\n    //dyld\n    slide = slideOfMainExecutable(dyldsMachHeader);\n    bool shouldRebase = slide != 0;\n    if ( shouldRebase ) {\n        //rebase Dyld\n        rebaseDyld(dyldsMachHeader, slide);\n    }\n\n\t// allow dyld to use mach messaging\n    //mach\n\tmach_init();\n\n\t// kernel sets up env pointer to be just past end of agv array\n    //\n\tconst char** envp = &argv[argc+1];\n\t\n\t// kernel sets up apple pointer to be just past end of envp array\n\tconst char** apple = envp;\n\twhile(*apple != NULL) { ++apple; }\n\t++apple;\n\n\t// set up random value for stack canary\n\t__guard_setup(apple);\n\n#if DYLD_INITIALIZER_SUPPORT\n\t// run all C++ initializers inside dyld\n    // dyld C++\n\trunDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);\n#endif\n\n\t// now that we are done bootstrapping dyld, call dyld's main\n    //bootstrap dyld dyld  main \n\tuintptr_t appsSlide = slideOfMainExecutable(appsMachHeader);\n\treturn dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);\n}\n```\n\n`dyld::start`\n1. <span id=\"return_rebaseDyld\">rebase dyld</span>\n[rebase dyld](#jump_rebaseDyld)\n2.  mach_msg\n\t<mach/mach_init.h>\n3. \n\tappleenvp\n4. \n\tapplestack_guard=xx\n5. <span id=\"return_runDyldInitializers\"> dyld </span>\n\tdyld(PIC )dylddyld[](#jump_runDyldInitializers)\n6.  dyld (bootstrap) dyld main\n\nstartdyld\n\n[  dyld _main](#jump__main)\n\n### <span id=\"jump_rebaseDyld\">RebaseDyld</span>\nDyldmach_oload_commanddylddyld\n\n1. Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info\n2. rebase  bind  Opcodes\n\nrebase/bind \n\n[](#return_rebaseDyld)\n\n### <span id=\"jump_runDyldInitializers\">Dyld</span>\n\n```cpp\nextern const Initializer  inits_start  __asm(\"section$start$__DATA$__mod_init_func\");\nextern const Initializer  inits_end    __asm(\"section$end$__DATA$__mod_init_func\");\n\n//\n// For a regular executable, the crt code calls dyld to run the executables initializers.\n// For a static executable, crt directly runs the initializers.\n// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.\n// We pass argc, argv, etc in case libc.a uses those arguments\n//\nstatic void runDyldInitializers(const struct macho_header* mh, intptr_t slide, int argc, const char* argv[], const char* envp[], const char* apple[])\n{\n\tfor (const Initializer* p = &inits_start; p < &inits_end; ++p) {\n\t\t(*p)(argc, argv, envp, apple);\n\t}\n}\n```\n\ndyldcrtdyldcrtdyldhack\n\n`__asm(\"section$start$__DATA$__mod_init_func\")``__DATA``__mod_init_func`\n\nDemo\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png)\n\nmach-o \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png)\n\n`__mod_init_func`,Sectiondemo_init10xED0\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png)\n\n`demo_init2`\n\ndyld`inits_start``inits_end`dyld\n\ndyld\n[](#jump_end) 1  2\n\n[](#return_runDyldInitializers)\n\n## <span id=\"jump__main\">dyld::_main</span>\ndyldrebasebindmach_msgdyld`dyld::_main` \n\n`dyld::_main`Appmain`dyld::start``__dyld_start`main\n\n_main\n\n1.  crashloglog...\n2. `// iOS cannot run without shared region`,iOS\n\tlibpath\n3. <span id=\"return_initMainExecutable\">:</span>\n\t`ImageLoaderMachO`[](#jump_initMainExecutable)\n\tClassicCompressed`ImageLoaderMachOCompressed``ImageLoaderMachOClassic``ImageLoaderMachO`\n4. `loadInsertedDylib`[Load ](#jump_loaddylib)<span id=\"return_loaddylib\">.</span>\n5. <span id=\"return_link_execution\"></span>[](#jump_link_execution)\n6. \n7. \n\n### <span id=\"jump_initMainExecutable\"></span>\ndylddyld macho_headerdyldImageLoaderMachOdyld\n\n```cpp\nstatic ImageLoaderMachO* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path)\n{\n\t// try mach-o loader\n\tif ( isCompatibleMachO((const uint8_t*)mh, path) ) {\n\t\tImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);\n\t\taddImage(image);\n\t\treturn (ImageLoaderMachO*)image;\n\t}\n\t\n\tthrow \"main executable not a known format\";\n}\n```\n\n`instantiateMainExecutable`mach-o(compress  classic)ImageLoader\n\n`addImage(image);`\n1. ImageLoader`sAllImages`\n2.  `sMappedRangesStart`  `ImageLoader`\n\n[](#return_initMainExecutable)\n\n### <span id=\"jump_loaddylib\"></span>\nDYLD_INSERT_LIBRARIESloadInsertedDylib()\n\nload()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH->LD_LIBRARY_PATH->DYLD_FRAMEWORK_PATH->->DYLD_FALLBACK_LIBRARY_PATH\n\nImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() \n\nloadPhase0()ImageLoaderMachO::instantiateFromCache()\n\n\n\n\n```cpp\n// map in file and instantiate an ImageLoader\n// ImagerLoader\nstatic ImageLoader* loadPhase6(int fd, const struct stat& stat_buf, const char* path, const LoadContext& context)\n{\n\t//dyld::log(\"%s(%s)\\n\", __func__ , path);\n\tuint64_t fileOffset = 0;\n\tuint64_t fileLength = stat_buf.st_size;\n\n\t// validate it is a file (not directory)\n\tif ( (stat_buf.st_mode & S_IFMT) != S_IFREG ) \n\t\tthrow \"not a file\";\n\n\tuint8_t firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];\n\tuint8_t *firstPagesPtr = firstPages;\n\tbool shortPage = false;\n\t\n\t// min mach-o file is 4K\n\t// mach-o4k\n\tif ( fileLength < 4096 ) {\n\t\tif ( pread(fd, firstPages, (size_t)fileLength, 0) != (ssize_t)fileLength )\n\t\t\tthrowf(\"pread of short file failed: %d\", errno);\n\t\tshortPage = true;\n\t} \n\telse {\n\t\t// optimistically read only first 4KB\n\t\t// header4kb4k\n\t\tif ( pread(fd, firstPages, 4096, 0) != 4096 )\n\t\t\tthrowf(\"pread of first 4K failed: %d\", errno);\n\t}\n\t\n\t// if fat wrapper, find usable sub-file\n\t// fat\n\tconst fat_header* fileStartAsFat = (fat_header*)firstPages;\n\tif ( fileStartAsFat->magic == OSSwapBigToHostInt32(FAT_MAGIC) ) {\n\t\tif ( OSSwapBigToHostInt32(fileStartAsFat->nfat_arch) > ((4096 - sizeof(fat_header)) / sizeof(fat_arch)) )\n\t\t\tthrowf(\"fat header too large: %u entries\", OSSwapBigToHostInt32(fileStartAsFat->nfat_arch));\n\t\tif ( fatFindBest(fileStartAsFat, &fileOffset, &fileLength) ) {\n\t\t\tif ( (fileOffset+fileLength) > (uint64_t)(stat_buf.st_size) )\n\t\t\t\tthrowf(\"truncated fat file.  file length=%llu, but needed slice goes to %llu\", stat_buf.st_size, fileOffset+fileLength);\n\t\t\tif (pread(fd, firstPages, 4096, fileOffset) != 4096)\n\t\t\t\tthrowf(\"pread of fat file failed: %d\", errno);\n\t\t}\n\t\telse {\n\t\t\tthrow \"no matching architecture in universal wrapper\";\n\t\t}\n\t}\n\t\n\t// try mach-o loader\n\tif ( shortPage ) \n\t\tthrow \"file too short\";\n\n\tif ( isCompatibleMachO(firstPages, path) ) {\n\n\t\t// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded\n\t\tconst mach_header* mh = (mach_header*)firstPages;\n\t\tswitch ( mh->filetype ) {\n\t\t\tcase MH_EXECUTE:\n\t\t\tcase MH_DYLIB:\n\t\t\tcase MH_BUNDLE:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow \"mach-o, but wrong filetype\";\n\t\t}\n\n\t\tuint32_t headerAndLoadCommandsSize = sizeof(macho_header) + mh->sizeofcmds;\n\t\tif ( headerAndLoadCommandsSize > MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )\n\t\t\tthrowf(\"malformed mach-o: load commands size (%u) > %u\", headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);\n\n\t\tif ( headerAndLoadCommandsSize > fileLength )\n\t\t\tdyld::throwf(\"malformed mach-o: load commands size (%u) > mach-o file size (%llu)\", headerAndLoadCommandsSize, fileLength);\n\n\t\tif ( headerAndLoadCommandsSize > 4096 ) {\n\t\t\t// read more pages\n\t\t\t//  head  LC_COMMANDS4096 headerAndLoadCommandsSize \n\t\t\tunsigned readAmount = headerAndLoadCommandsSize - 4096;\n\t\t\tif ( pread(fd, &firstPages[4096], readAmount, fileOffset+4096) != readAmount )\n\t\t\t\tthrowf(\"pread of extra load commands past 4KB failed: %d\", errno);\n\t\t}\n\n#if TARGET_IPHONE_SIMULATOR\t\n\t\t// <rdar://problem/14168872> dyld_sim should restrict loading osx binaries\n\t\tif ( !isSimulatorBinary(firstPages, path) ) {\n\t#if TARGET_OS_WATCH\n\t\t\tthrow \"mach-o, but not built for watchOS simulator\";\n\t#elif TARGET_OS_TV\n\t\t\tthrow \"mach-o, but not built for tvOS simulator\";\n\t#else\n\t\t\tthrow \"mach-o, but not built for iOS simulator\";\n\t#endif\n\t\t}\n#endif\n\n#if __MAC_OS_X_VERSION_MIN_REQUIRED\n\t\tif ( gLinkContext.marzipan ) {\n\t\t\tconst dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;\n\t\t\tbool isiOSMacBinary = mf->supportsPlatform(dyld3::Platform::iOSMac) || iOSMacWhiteListed(path);\n\t\t\tbool isProhibitedMacOSBinary = !isiOSMacBinary && iOSMacBlackListed(path);\n\t\t\tif ( (context.enforceIOSMac && !isiOSMacBinary) || isProhibitedMacOSBinary ) {\n\t\t\t\tthrow \"mach-o, but not built for iOSMac\";\n\t\t\t}\n\t\t}\n#endif\n\n#if __arm64e__\n\t\tif ( (sMainExecutableMachHeader->cpusubtype == CPU_SUBTYPE_ARM64_E) && (mh->cpusubtype != CPU_SUBTYPE_ARM64_E) )\n\t\t\tthrow \"arm64 dylibs cannot be loaded into arm64e processes\";\n#endif\n\t\tImageLoader* image = nullptr;\n\t\t{\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_MAP_IMAGE, path, 0, 0);\n\t\t\t// instantiateFromFile  ImageLoader\n\t\t\timage = ImageLoaderMachO::instantiateFromFile(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);\n\t\t\ttimer.setData4((uint64_t)image->machHeader());\n\t\t}\n\t\t\n\t\t// validate\n\t\t// \n\t\treturn checkandAddImage(image, context);\n\t}\n\t\n\t// try other file formats here...\n\t\n\t\n\t// throw error about what was found\n\tswitch (*(uint32_t*)firstPages) {\n\t\tcase MH_MAGIC:\n\t\tcase MH_CIGAM:\n\t\tcase MH_MAGIC_64:\n\t\tcase MH_CIGAM_64:\n\t\t\tthrow \"mach-o, but wrong architecture\";\n\t\tdefault:\n\t\tthrowf(\"unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X\", \n\t\t\tfirstPages[0], firstPages[1], firstPages[2], firstPages[3], firstPages[4], firstPages[5], firstPages[6],firstPages[7]);\n\t}\n}\n```\n\n`ImageLoader`\n\n\n1. 4k4k, fat_header\n2. fatCPU\n3. \n4.  head  Load_Commands 4k headerAndLoadCommandsSize `ImageLoader``ImageLoader` Load_Commands \n5. checkandAddImage\n\n\n checkandAddImage\n```cpp\nstatic ImageLoader* checkandAddImage(ImageLoader* image, const LoadContext& context)\n{\n\t// now sanity check that this loaded image does not have the same install path as any existing image\n\t// sAllImages \n\tconst char* loadedImageInstallPath = image->getInstallPath();\n\tif ( image->isDylib() && (loadedImageInstallPath != NULL) && (loadedImageInstallPath[0] == '/') ) {\n\t\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\t\tImageLoader* anImage = *it;\n\t\t\tconst char* installPath = anImage->getInstallPath();\n\t\t\tif ( installPath != NULL) {\n\t\t\t\tif ( strcmp(loadedImageInstallPath, installPath) == 0 ) {\n\t\t\t\t\t//dyld::log(\"duplicate(%s) => %p\\n\", installPath, anImage);\n\t\t\t\t\tremoveImage(image);\n\t\t\t\t\tImageLoader::deleteImage(image);\n\t\t\t\t\treturn anImage;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// some API's restrict what they can load\n\tif ( context.mustBeBundle && !image->isBundle() )\n\t\tthrow \"not a bundle\";\n\tif ( context.mustBeDylib && !image->isDylib() )\n\t\tthrow \"not a dylib\";\n\n\t// regular main executables cannot be loaded \n\tif ( image->isExecutable() ) {\n\t\tif ( !context.canBePIE || !image->isPositionIndependentExecutable() )\n\t\t\tthrow \"can't load a main executable\";\n\t}\n\t\n\t// don't add bundles to global list, they can be loaded but not linked.  When linked it will be added to list\n\tif ( ! image->isBundle() )\n\t\t//\n\t\taddImage(image);\n\t\n\treturn image;\n}\n```\n\n`AddImage`\n\n[](#return_loaddylib)\n\n### <span id=\"jump_link_execution\">Link </span>\ndyld\n\n`void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain& loaderRPaths, unsigned cacheIndex)`\n\n_main mach-o   `ImageLoader.link`\n\n```cpp\nvoid ImageLoader::link(const LinkContext& context, bool forceLazysBound, bool preflightOnly, bool neverUnload, const RPathChain& loaderRPaths, const char* imagePath)\n{\n\t//dyld::log(\"ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n\", imagePath, fDlopenReferenceCount, fNeverUnload);\n\t\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\tuint64_t t0 = mach_absolute_time();\n\tthis->recursiveLoadLibraries(context, preflightOnly, loaderRPaths, imagePath);\n\tcontext.notifyBatch(dyld_image_state_dependents_mapped, preflightOnly);\n\n\t// we only do the loading step for preflights\n\tif ( preflightOnly )\n\t\treturn;\n\n\tuint64_t t1 = mach_absolute_time();\n\tcontext.clearAllDepths();\n\tthis->recursiveUpdateDepth(context.imageCount());\n\n\t__block uint64_t t2, t3, t4, t5;\n\t{\n\t\tdyld3::ScopedTimer(DBG_DYLD_TIMING_APPLY_FIXUPS, 0, 0, 0);\n\t\tt2 = mach_absolute_time();\n\t\tthis->recursiveRebase(context);\n\t\tcontext.notifyBatch(dyld_image_state_rebased, false);\n\n\t\tt3 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->recursiveBindWithAccounting(context, forceLazysBound, neverUnload);\n\n\t\tt4 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->weakBind(context);\n\t\tt5 = mach_absolute_time();\n\t}\n\n    if ( !context.linkingMainExecutable )\n        context.notifyBatch(dyld_image_state_bound, false);\n\tuint64_t t6 = mach_absolute_time();\t\n\n\tstd::vector<DOFInfo> dofs;\n\tthis->recursiveGetDOFSections(context, dofs);\n\tcontext.registerDOFs(dofs);\n\tuint64_t t7 = mach_absolute_time();\t\n\n\t// interpose any dynamically loaded images\n\tif ( !context.linkingMainExecutable && (fgInterposingTuples.size() != 0) ) {\n\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_APPLY_INTERPOSING, 0, 0, 0);\n\t\tthis->recursiveApplyInterposing(context);\n\t}\n\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\t//log\n\tfgTotalLoadLibrariesTime += t1 - t0;\n\tfgTotalRebaseTime += t3 - t2;\n\tfgTotalBindTime += t4 - t3;\n\tfgTotalWeakBindTime += t5 - t4;\n\tfgTotalDOF += t7 - t6;\n\t\n\t// done with initial dylib loads\n\tfgNextPIEDylibAddress = 0;\n}\n```\n\n\n1. `this->recursiveLoadLibraries`  (LoadLoadopenImageLoader)Load\n2. `this->recursiveUpdateDepth` \n3. <span id=\"return_rebase\">`this->recursiveRebase`</span>\n\trebaserecursiveRebaserebase`rebase(const LinkContext& context, uintptr_t slide)`[Rebase](#jump_rebase)\n4. `this->recursiveBindWithAccounting`\n\tnon-lazy bindlazy bindRebaserebind`doBind(const LinkContext& context, bool forceLazysBound)`\n5. `this->weakBind` \n6. `this->recursiveGetDOFSections` DOF\n7. `this->recursiveApplyInterposing`\n\nlog\n\n### <span id=\"jump_rebase\">Rebase</span>\n Rebase \n\nRebaseASLRmach-oPIC\"rebase\"\n\nPICrebase\n\n/  ()mach-o`__mod_init_func`dyld vmaddr -- slide\n\ncompressed mach-o(mach-o) `ImageLoaderMachOCompressed`\n\n rebase mach-o\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png)\n\n rebase   --  opcode  immediate\n\n\nREBASE_OPCODE_TYPE_IMM == 11:TypeType\nREBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB == 22:rebase2segmentuleb\nuleb128 == 24:uleb\nREBASE_OPCODE_DO_REBASE_IMM_TIMES == 2:rebase2\n\n224rebase\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png)\n\n02 0x3000 +  24 =0x3018 \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png)\n\n`__mod_init_func`~\n\nrebase    \n```cpp\nvoid ImageLoaderMachOCompressed::rebase(const LinkContext& context, uintptr_t slide)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\t// fLinkEditBase __LINKEDIT    == slide\n\t// start  rebase\n\tconst uint8_t* const start = fLinkEditBase + fDyldInfo->rebase_off;\n\t// end  rebase\n\tconst uint8_t* const end = &start[fDyldInfo->rebase_size];\n\tconst uint8_t* p = start;\n\n\ttry {\n\t\tuint8_t type = 0;\n\t\tint segmentIndex = 0;\n\t\tuintptr_t address = segActualLoadAddress(0);\n\t\tuintptr_t segmentStartAddress = segActualLoadAddress(0);//N\n\t\tuintptr_t segmentEndAddress = segActualEndAddress(0);//N\n\t\tuintptr_t count;\n\t\tuintptr_t skip;\n\t\tbool done = false;\n\t\twhile ( !done && (p < end) ) {\n\t\t\tuint8_t immediate = *p & REBASE_IMMEDIATE_MASK;\n\t\t\tuint8_t opcode = *p & REBASE_OPCODE_MASK;\n\t\t\t++p;\n\t\t\tswitch (opcode) {\n\t\t\t\tcase REBASE_OPCODE_DONE:\n\t\t\t\t\tdone = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_TYPE_IMM:\n\t\t\t\t\ttype = immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:\n\t\t\t\t\tsegmentIndex = immediate;\n\t\t\t\t\tif ( segmentIndex >= fSegmentsCount )\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)\",\n\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount-1);\n\t\t\t#if TEXT_RELOC_SUPPORT\n\t\t\t\t\tif ( !segWriteable(segmentIndex) && !segHasRebaseFixUps(segmentIndex) && !segHasBindFixUps(segmentIndex) )\n\t\t\t#else\n\t\t\t\t\tif ( !segWriteable(segmentIndex) )\n\t\t\t#endif\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)\",\n\t\t\t\t\t\t\t\tsegmentIndex, segName(segmentIndex));\n\t\t\t\t\t//\n\t\t\t\t\tsegmentStartAddress = segActualLoadAddress(segmentIndex);\n\t\t\t\t\tsegmentEndAddress = segActualEndAddress(segmentIndex);\n\t\t\t\t\t\n\t\t\t\t\taddress = segmentStartAddress + read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_ULEB:\n\t\t\t\t\taddress += read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_IMM_SCALED:\n\t\t\t\t\taddress += immediate*sizeof(uintptr_t);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_IMM_TIMES:\n\t\t\t\t\tfor (int i=0; i < immediate; ++i) {//N\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:\n\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\taddress += read_uleb128(p, end) + sizeof(uintptr_t);\n\t\t\t\t\t++fgTotalRebaseFixups;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tskip = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += skip + sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdyld::throwf(\"bad rebase opcode %d\", *(p-1));\n\t\t\t}\n\t\t}\n\t}\n\tcatch (const char* msg) {\n\t\tconst char* newMsg = dyld::mkstringf(\"%s in %s\", msg, this->getPath());\n\t\tfree((void*)msg);\n\t\tthrow newMsg;\n\t}\n\tCRSetCrashLogMessage2(NULL);\n}\n```\n## <span id=\"jump_init_main_execution\">initializeMainExecutable</span>\n/rebase/bind...runtime\n\n```cpp\nvoid initializeMainExecutable()\n{\n\t// record that we've reached this step\n\tgLinkContext.startedInitializingMainExecutable = true;\n\n\t// run initialzers for any inserted dylibs\n\tImageLoader::InitializerTimingList initializerTimes[allImagesCount()];\n\tinitializerTimes[0].count = 0;\n\tconst size_t rootCount = sImageRoots.size();\n\tif ( rootCount > 1 ) {\n\t\tfor(size_t i=1; i < rootCount; ++i) {\n\t\t\tsImageRoots[i]->runInitializers(gLinkContext, initializerTimes[0]);\n\t\t}\n\t}\n\t\n\t// run initializers for main executable and everything it brings up \n\tsMainExecutable->runInitializers(gLinkContext, initializerTimes[0]);\n\t\n\t// register cxa_atexit() handler to run static terminators in all loaded images when this process exits\n\tif ( gLibSystemHelpers != NULL ) \n\t\t(*gLibSystemHelpers->cxa_atexit)(&runAllStaticTerminators, NULL, NULL);\n\n\t// dump info if requested\n\tif ( sEnv.DYLD_PRINT_STATISTICS )\n\t\tImageLoader::printStatistics((unsigned int)allImagesCount(), initializerTimes[0]);\n\tif ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )\n\t\tImageLoaderMachO::printStatisticsDetails((unsigned int)allImagesCount(), initializerTimes[0]);\n}\n\n```\n\n\n\nsMainExecutable->runInitializers \n```cpp\nvoid ImageLoader::runInitializers(const LinkContext& context, InitializerTimingList& timingInfo)\n{\n\tuint64_t t1 = mach_absolute_time();\n\tmach_port_t thisThread = mach_thread_self();\n\tImageLoader::UninitedUpwards up;\n\tup.count = 1;\n\tup.images[0] = this;\n\tprocessInitializers(context, thisThread, timingInfo, up);\n\tcontext.notifyBatch(dyld_image_state_initialized, false);\n\tmach_port_deallocate(mach_task_self(), thisThread);\n\tuint64_t t2 = mach_absolute_time();\n\tfgTotalInitTime += (t2 - t1);\n}\n```\nprocessInitializers \n```cpp\nvoid ImageLoader::processInitializers(const LinkContext& context, mach_port_t thisThread,\n\t\t\t\t\t\t\t\t\t InitializerTimingList& timingInfo, ImageLoader::UninitedUpwards& images)\n{\n\tuint32_t maxImageCount = context.imageCount()+2;\n\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];\n\tImageLoader::UninitedUpwards& ups = upsBuffer[0];\n\tups.count = 0;\n\t// Calling recursive init on all images in images list, building a new list of\n\t// uninitialized upward dependencies.\n\tfor (uintptr_t i=0; i < images.count; ++i) {\n\t\timages.images[i]->recursiveInitialization(context, thisThread, images.images[i]->getPath(), timingInfo, ups);\n\t}\n\t// If any upward dependencies remain, init them.\n\tif ( ups.count > 0 )\n\t\tprocessInitializers(context, thisThread, timingInfo, ups);\n}\n```\n\nrecursiveInitialization \n```cpp\nvoid ImageLoader::recursiveInitialization(const LinkContext& context, mach_port_t this_thread, const char* pathToInitialize,\n\t\t\t\t\t\t\t\t\t\t  InitializerTimingList& timingInfo, UninitedUpwards& uninitUps)\n{\n\trecursive_lock lock_info(this_thread);\n\trecursiveSpinLock(lock_info);\n\n\tif ( fState < dyld_image_state_dependents_initialized-1 ) {\n\t\tuint8_t oldState = fState;\n\t\t// break cycles\n\t\tfState = dyld_image_state_dependents_initialized-1;\n\t\ttry {\n\t\t\t// initialize lower level libraries first\n\t\t\tfor(unsigned int i=0; i < libraryCount(); ++i) {\n\t\t\t\tImageLoader* dependentImage = libImage(i);\n\t\t\t\tif ( dependentImage != NULL ) {\n\t\t\t\t\t// don't try to initialize stuff \"above\" me yet\n\t\t\t\t\tif ( libIsUpward(i) ) {\n\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;\n\t\t\t\t\t\tuninitUps.count++;\n\t\t\t\t\t}\n\t\t\t\t\telse if ( dependentImage->fDepth >= fDepth ) {\n\t\t\t\t\t\tdependentImage->recursiveInitialization(context, this_thread, libPath(i), timingInfo, uninitUps);\n\t\t\t\t\t}\n                }\n\t\t\t}\n\t\t\t\n\t\t\t// record termination order\n\t\t\tif ( this->needsTermination() )\n\t\t\t\tcontext.terminationRecorder(this);\n\t\t\t\n\t\t\t// let objc know we are about to initialize this image\n\t\t\tuint64_t t1 = mach_absolute_time();\n\t\t\tfState = dyld_image_state_dependents_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_dependents_initialized, this, &timingInfo);\n\t\t\t\n\t\t\t// initialize this image\n\t\t\tbool hasInitializers = this->doInitialization(context);\n\n\t\t\t// let anyone know we finished initializing this image\n\t\t\tfState = dyld_image_state_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_initialized, this, NULL);\n\t\t\t\n\t\t\tif ( hasInitializers ) {\n\t\t\t\tuint64_t t2 = mach_absolute_time();\n\t\t\t\ttimingInfo.addTime(this->getShortName(), t2-t1);\n\t\t\t}\n\t\t}\n\t\tcatch (const char* msg) {\n\t\t\t// this image is not initialized\n\t\t\tfState = oldState;\n\t\t\trecursiveSpinUnLock();\n\t\t\tthrow;\n\t\t}\n\t}\n\t\n\trecursiveSpinUnLock();\n}\n```\n\ndoInitialization \n```cpp\nbool ImageLoaderMachO::doInitialization(const LinkContext& context)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\n\t// mach-o has -init and static initializers\n\tdoImageInit(context);\n\tdoModInitFunctions(context);\n\t\n\tCRSetCrashLogMessage2(NULL);\n\t\n\treturn (fHasDashInit || fHasInitializers);\n}\n```\n\n doModInitFunctions dyld_mod_init_func\n\nruntime:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png)\n\n libSystem.B.dylib -> libdispatch.dylib -> libobjc.A.dylib runtime\nruntime dyld\n`_dyld_objc_notify_register(&map_images, load_images, unmap_image);`\n\nloadruntime\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png)\n\n\n```cpp\nvoid registerObjCNotifiers(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)\n{\n\t// record functions to call\n\tsNotifyObjCMapped\t= mapped;\n\tsNotifyObjCInit\t\t= init;\n\tsNotifyObjCUnmapped = unmapped;\n\n\t// call 'mapped' function with all images mapped so far\n\ttry {\n\t\tnotifyBatchPartial(dyld_image_state_bound, true, NULL, false, true);\n\t}\n\tcatch (const char* msg) {\n\t\t// ignore request to abort during registration\n\t}\n\n\t// <rdar://problem/32209809> call 'init' function on all images already init'ed (below libSystem)\n\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\tImageLoader* image = *it;\n\t\tif ( (image->getState() == dyld_image_state_initialized) && image->notifyObjC() ) {\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_OBJC_INIT, (uint64_t)image->machHeader(), 0, 0);\n\t\t\t(*sNotifyObjCInit)(image->getRealPath(), image->machHeader());\n\t\t}\n\t}\n}\n```\n\n sAllImages  `_dyld_objc_notify_init init`runtimemach-o class  section \n\n## <span id=\"jump_end\"></span>\n1. [Mach-O](https://www.dllhook.com/post/249.html)\n2. [Mach-O](https://paper.seebug.org/202/)\n3. [dyld](https://www.dllhook.com/post/238.html)\n4. [iOS  main ](http://blog.sunnyxx.com/2014/08/30/objc-pre-main/)\n5. [dylib](https://feicong.github.io/2017/01/14/dylib/index.html)\n\n","source":"_posts/11.dyld.md","raw":"---\ntitle:  dyld \ndate: 2020-03-13\ntags: []\ncategories: \n---\n\n.......\n\ndyld/dyld ASLRobjcruntimedyld\n\n<!-- more -->\n\n## dyld \ndyld dyldStartup.s :load dyld`__dyld_start``dyld::start` \n\n`dyld::start`\n\n```cpp\nuintptr_t start(const struct macho_header* appsMachHeader, int argc, const char* argv[], \n\t\t\t\tintptr_t slide, const struct macho_header* dyldsMachHeader,\n\t\t\t\tuintptr_t* startGlue)\n{\n\t// if kernel had to slide dyld, we need to fix up load sensitive locations\n\t// we have to do this before using any global variables\n    //dyld\n    slide = slideOfMainExecutable(dyldsMachHeader);\n    bool shouldRebase = slide != 0;\n    if ( shouldRebase ) {\n        //rebase Dyld\n        rebaseDyld(dyldsMachHeader, slide);\n    }\n\n\t// allow dyld to use mach messaging\n    //mach\n\tmach_init();\n\n\t// kernel sets up env pointer to be just past end of agv array\n    //\n\tconst char** envp = &argv[argc+1];\n\t\n\t// kernel sets up apple pointer to be just past end of envp array\n\tconst char** apple = envp;\n\twhile(*apple != NULL) { ++apple; }\n\t++apple;\n\n\t// set up random value for stack canary\n\t__guard_setup(apple);\n\n#if DYLD_INITIALIZER_SUPPORT\n\t// run all C++ initializers inside dyld\n    // dyld C++\n\trunDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);\n#endif\n\n\t// now that we are done bootstrapping dyld, call dyld's main\n    //bootstrap dyld dyld  main \n\tuintptr_t appsSlide = slideOfMainExecutable(appsMachHeader);\n\treturn dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);\n}\n```\n\n`dyld::start`\n1. <span id=\"return_rebaseDyld\">rebase dyld</span>\n[rebase dyld](#jump_rebaseDyld)\n2.  mach_msg\n\t<mach/mach_init.h>\n3. \n\tappleenvp\n4. \n\tapplestack_guard=xx\n5. <span id=\"return_runDyldInitializers\"> dyld </span>\n\tdyld(PIC )dylddyld[](#jump_runDyldInitializers)\n6.  dyld (bootstrap) dyld main\n\nstartdyld\n\n[  dyld _main](#jump__main)\n\n### <span id=\"jump_rebaseDyld\">RebaseDyld</span>\nDyldmach_oload_commanddylddyld\n\n1. Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info\n2. rebase  bind  Opcodes\n\nrebase/bind \n\n[](#return_rebaseDyld)\n\n### <span id=\"jump_runDyldInitializers\">Dyld</span>\n\n```cpp\nextern const Initializer  inits_start  __asm(\"section$start$__DATA$__mod_init_func\");\nextern const Initializer  inits_end    __asm(\"section$end$__DATA$__mod_init_func\");\n\n//\n// For a regular executable, the crt code calls dyld to run the executables initializers.\n// For a static executable, crt directly runs the initializers.\n// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.\n// We pass argc, argv, etc in case libc.a uses those arguments\n//\nstatic void runDyldInitializers(const struct macho_header* mh, intptr_t slide, int argc, const char* argv[], const char* envp[], const char* apple[])\n{\n\tfor (const Initializer* p = &inits_start; p < &inits_end; ++p) {\n\t\t(*p)(argc, argv, envp, apple);\n\t}\n}\n```\n\ndyldcrtdyldcrtdyldhack\n\n`__asm(\"section$start$__DATA$__mod_init_func\")``__DATA``__mod_init_func`\n\nDemo\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png)\n\nmach-o \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png)\n\n`__mod_init_func`,Sectiondemo_init10xED0\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png)\n\n`demo_init2`\n\ndyld`inits_start``inits_end`dyld\n\ndyld\n[](#jump_end) 1  2\n\n[](#return_runDyldInitializers)\n\n## <span id=\"jump__main\">dyld::_main</span>\ndyldrebasebindmach_msgdyld`dyld::_main` \n\n`dyld::_main`Appmain`dyld::start``__dyld_start`main\n\n_main\n\n1.  crashloglog...\n2. `// iOS cannot run without shared region`,iOS\n\tlibpath\n3. <span id=\"return_initMainExecutable\">:</span>\n\t`ImageLoaderMachO`[](#jump_initMainExecutable)\n\tClassicCompressed`ImageLoaderMachOCompressed``ImageLoaderMachOClassic``ImageLoaderMachO`\n4. `loadInsertedDylib`[Load ](#jump_loaddylib)<span id=\"return_loaddylib\">.</span>\n5. <span id=\"return_link_execution\"></span>[](#jump_link_execution)\n6. \n7. \n\n### <span id=\"jump_initMainExecutable\"></span>\ndylddyld macho_headerdyldImageLoaderMachOdyld\n\n```cpp\nstatic ImageLoaderMachO* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path)\n{\n\t// try mach-o loader\n\tif ( isCompatibleMachO((const uint8_t*)mh, path) ) {\n\t\tImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);\n\t\taddImage(image);\n\t\treturn (ImageLoaderMachO*)image;\n\t}\n\t\n\tthrow \"main executable not a known format\";\n}\n```\n\n`instantiateMainExecutable`mach-o(compress  classic)ImageLoader\n\n`addImage(image);`\n1. ImageLoader`sAllImages`\n2.  `sMappedRangesStart`  `ImageLoader`\n\n[](#return_initMainExecutable)\n\n### <span id=\"jump_loaddylib\"></span>\nDYLD_INSERT_LIBRARIESloadInsertedDylib()\n\nload()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH->LD_LIBRARY_PATH->DYLD_FRAMEWORK_PATH->->DYLD_FALLBACK_LIBRARY_PATH\n\nImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() \n\nloadPhase0()ImageLoaderMachO::instantiateFromCache()\n\n\n\n\n```cpp\n// map in file and instantiate an ImageLoader\n// ImagerLoader\nstatic ImageLoader* loadPhase6(int fd, const struct stat& stat_buf, const char* path, const LoadContext& context)\n{\n\t//dyld::log(\"%s(%s)\\n\", __func__ , path);\n\tuint64_t fileOffset = 0;\n\tuint64_t fileLength = stat_buf.st_size;\n\n\t// validate it is a file (not directory)\n\tif ( (stat_buf.st_mode & S_IFMT) != S_IFREG ) \n\t\tthrow \"not a file\";\n\n\tuint8_t firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];\n\tuint8_t *firstPagesPtr = firstPages;\n\tbool shortPage = false;\n\t\n\t// min mach-o file is 4K\n\t// mach-o4k\n\tif ( fileLength < 4096 ) {\n\t\tif ( pread(fd, firstPages, (size_t)fileLength, 0) != (ssize_t)fileLength )\n\t\t\tthrowf(\"pread of short file failed: %d\", errno);\n\t\tshortPage = true;\n\t} \n\telse {\n\t\t// optimistically read only first 4KB\n\t\t// header4kb4k\n\t\tif ( pread(fd, firstPages, 4096, 0) != 4096 )\n\t\t\tthrowf(\"pread of first 4K failed: %d\", errno);\n\t}\n\t\n\t// if fat wrapper, find usable sub-file\n\t// fat\n\tconst fat_header* fileStartAsFat = (fat_header*)firstPages;\n\tif ( fileStartAsFat->magic == OSSwapBigToHostInt32(FAT_MAGIC) ) {\n\t\tif ( OSSwapBigToHostInt32(fileStartAsFat->nfat_arch) > ((4096 - sizeof(fat_header)) / sizeof(fat_arch)) )\n\t\t\tthrowf(\"fat header too large: %u entries\", OSSwapBigToHostInt32(fileStartAsFat->nfat_arch));\n\t\tif ( fatFindBest(fileStartAsFat, &fileOffset, &fileLength) ) {\n\t\t\tif ( (fileOffset+fileLength) > (uint64_t)(stat_buf.st_size) )\n\t\t\t\tthrowf(\"truncated fat file.  file length=%llu, but needed slice goes to %llu\", stat_buf.st_size, fileOffset+fileLength);\n\t\t\tif (pread(fd, firstPages, 4096, fileOffset) != 4096)\n\t\t\t\tthrowf(\"pread of fat file failed: %d\", errno);\n\t\t}\n\t\telse {\n\t\t\tthrow \"no matching architecture in universal wrapper\";\n\t\t}\n\t}\n\t\n\t// try mach-o loader\n\tif ( shortPage ) \n\t\tthrow \"file too short\";\n\n\tif ( isCompatibleMachO(firstPages, path) ) {\n\n\t\t// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded\n\t\tconst mach_header* mh = (mach_header*)firstPages;\n\t\tswitch ( mh->filetype ) {\n\t\t\tcase MH_EXECUTE:\n\t\t\tcase MH_DYLIB:\n\t\t\tcase MH_BUNDLE:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow \"mach-o, but wrong filetype\";\n\t\t}\n\n\t\tuint32_t headerAndLoadCommandsSize = sizeof(macho_header) + mh->sizeofcmds;\n\t\tif ( headerAndLoadCommandsSize > MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )\n\t\t\tthrowf(\"malformed mach-o: load commands size (%u) > %u\", headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);\n\n\t\tif ( headerAndLoadCommandsSize > fileLength )\n\t\t\tdyld::throwf(\"malformed mach-o: load commands size (%u) > mach-o file size (%llu)\", headerAndLoadCommandsSize, fileLength);\n\n\t\tif ( headerAndLoadCommandsSize > 4096 ) {\n\t\t\t// read more pages\n\t\t\t//  head  LC_COMMANDS4096 headerAndLoadCommandsSize \n\t\t\tunsigned readAmount = headerAndLoadCommandsSize - 4096;\n\t\t\tif ( pread(fd, &firstPages[4096], readAmount, fileOffset+4096) != readAmount )\n\t\t\t\tthrowf(\"pread of extra load commands past 4KB failed: %d\", errno);\n\t\t}\n\n#if TARGET_IPHONE_SIMULATOR\t\n\t\t// <rdar://problem/14168872> dyld_sim should restrict loading osx binaries\n\t\tif ( !isSimulatorBinary(firstPages, path) ) {\n\t#if TARGET_OS_WATCH\n\t\t\tthrow \"mach-o, but not built for watchOS simulator\";\n\t#elif TARGET_OS_TV\n\t\t\tthrow \"mach-o, but not built for tvOS simulator\";\n\t#else\n\t\t\tthrow \"mach-o, but not built for iOS simulator\";\n\t#endif\n\t\t}\n#endif\n\n#if __MAC_OS_X_VERSION_MIN_REQUIRED\n\t\tif ( gLinkContext.marzipan ) {\n\t\t\tconst dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;\n\t\t\tbool isiOSMacBinary = mf->supportsPlatform(dyld3::Platform::iOSMac) || iOSMacWhiteListed(path);\n\t\t\tbool isProhibitedMacOSBinary = !isiOSMacBinary && iOSMacBlackListed(path);\n\t\t\tif ( (context.enforceIOSMac && !isiOSMacBinary) || isProhibitedMacOSBinary ) {\n\t\t\t\tthrow \"mach-o, but not built for iOSMac\";\n\t\t\t}\n\t\t}\n#endif\n\n#if __arm64e__\n\t\tif ( (sMainExecutableMachHeader->cpusubtype == CPU_SUBTYPE_ARM64_E) && (mh->cpusubtype != CPU_SUBTYPE_ARM64_E) )\n\t\t\tthrow \"arm64 dylibs cannot be loaded into arm64e processes\";\n#endif\n\t\tImageLoader* image = nullptr;\n\t\t{\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_MAP_IMAGE, path, 0, 0);\n\t\t\t// instantiateFromFile  ImageLoader\n\t\t\timage = ImageLoaderMachO::instantiateFromFile(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);\n\t\t\ttimer.setData4((uint64_t)image->machHeader());\n\t\t}\n\t\t\n\t\t// validate\n\t\t// \n\t\treturn checkandAddImage(image, context);\n\t}\n\t\n\t// try other file formats here...\n\t\n\t\n\t// throw error about what was found\n\tswitch (*(uint32_t*)firstPages) {\n\t\tcase MH_MAGIC:\n\t\tcase MH_CIGAM:\n\t\tcase MH_MAGIC_64:\n\t\tcase MH_CIGAM_64:\n\t\t\tthrow \"mach-o, but wrong architecture\";\n\t\tdefault:\n\t\tthrowf(\"unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X\", \n\t\t\tfirstPages[0], firstPages[1], firstPages[2], firstPages[3], firstPages[4], firstPages[5], firstPages[6],firstPages[7]);\n\t}\n}\n```\n\n`ImageLoader`\n\n\n1. 4k4k, fat_header\n2. fatCPU\n3. \n4.  head  Load_Commands 4k headerAndLoadCommandsSize `ImageLoader``ImageLoader` Load_Commands \n5. checkandAddImage\n\n\n checkandAddImage\n```cpp\nstatic ImageLoader* checkandAddImage(ImageLoader* image, const LoadContext& context)\n{\n\t// now sanity check that this loaded image does not have the same install path as any existing image\n\t// sAllImages \n\tconst char* loadedImageInstallPath = image->getInstallPath();\n\tif ( image->isDylib() && (loadedImageInstallPath != NULL) && (loadedImageInstallPath[0] == '/') ) {\n\t\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\t\tImageLoader* anImage = *it;\n\t\t\tconst char* installPath = anImage->getInstallPath();\n\t\t\tif ( installPath != NULL) {\n\t\t\t\tif ( strcmp(loadedImageInstallPath, installPath) == 0 ) {\n\t\t\t\t\t//dyld::log(\"duplicate(%s) => %p\\n\", installPath, anImage);\n\t\t\t\t\tremoveImage(image);\n\t\t\t\t\tImageLoader::deleteImage(image);\n\t\t\t\t\treturn anImage;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// some API's restrict what they can load\n\tif ( context.mustBeBundle && !image->isBundle() )\n\t\tthrow \"not a bundle\";\n\tif ( context.mustBeDylib && !image->isDylib() )\n\t\tthrow \"not a dylib\";\n\n\t// regular main executables cannot be loaded \n\tif ( image->isExecutable() ) {\n\t\tif ( !context.canBePIE || !image->isPositionIndependentExecutable() )\n\t\t\tthrow \"can't load a main executable\";\n\t}\n\t\n\t// don't add bundles to global list, they can be loaded but not linked.  When linked it will be added to list\n\tif ( ! image->isBundle() )\n\t\t//\n\t\taddImage(image);\n\t\n\treturn image;\n}\n```\n\n`AddImage`\n\n[](#return_loaddylib)\n\n### <span id=\"jump_link_execution\">Link </span>\ndyld\n\n`void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain& loaderRPaths, unsigned cacheIndex)`\n\n_main mach-o   `ImageLoader.link`\n\n```cpp\nvoid ImageLoader::link(const LinkContext& context, bool forceLazysBound, bool preflightOnly, bool neverUnload, const RPathChain& loaderRPaths, const char* imagePath)\n{\n\t//dyld::log(\"ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n\", imagePath, fDlopenReferenceCount, fNeverUnload);\n\t\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\tuint64_t t0 = mach_absolute_time();\n\tthis->recursiveLoadLibraries(context, preflightOnly, loaderRPaths, imagePath);\n\tcontext.notifyBatch(dyld_image_state_dependents_mapped, preflightOnly);\n\n\t// we only do the loading step for preflights\n\tif ( preflightOnly )\n\t\treturn;\n\n\tuint64_t t1 = mach_absolute_time();\n\tcontext.clearAllDepths();\n\tthis->recursiveUpdateDepth(context.imageCount());\n\n\t__block uint64_t t2, t3, t4, t5;\n\t{\n\t\tdyld3::ScopedTimer(DBG_DYLD_TIMING_APPLY_FIXUPS, 0, 0, 0);\n\t\tt2 = mach_absolute_time();\n\t\tthis->recursiveRebase(context);\n\t\tcontext.notifyBatch(dyld_image_state_rebased, false);\n\n\t\tt3 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->recursiveBindWithAccounting(context, forceLazysBound, neverUnload);\n\n\t\tt4 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->weakBind(context);\n\t\tt5 = mach_absolute_time();\n\t}\n\n    if ( !context.linkingMainExecutable )\n        context.notifyBatch(dyld_image_state_bound, false);\n\tuint64_t t6 = mach_absolute_time();\t\n\n\tstd::vector<DOFInfo> dofs;\n\tthis->recursiveGetDOFSections(context, dofs);\n\tcontext.registerDOFs(dofs);\n\tuint64_t t7 = mach_absolute_time();\t\n\n\t// interpose any dynamically loaded images\n\tif ( !context.linkingMainExecutable && (fgInterposingTuples.size() != 0) ) {\n\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_APPLY_INTERPOSING, 0, 0, 0);\n\t\tthis->recursiveApplyInterposing(context);\n\t}\n\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\t//log\n\tfgTotalLoadLibrariesTime += t1 - t0;\n\tfgTotalRebaseTime += t3 - t2;\n\tfgTotalBindTime += t4 - t3;\n\tfgTotalWeakBindTime += t5 - t4;\n\tfgTotalDOF += t7 - t6;\n\t\n\t// done with initial dylib loads\n\tfgNextPIEDylibAddress = 0;\n}\n```\n\n\n1. `this->recursiveLoadLibraries`  (LoadLoadopenImageLoader)Load\n2. `this->recursiveUpdateDepth` \n3. <span id=\"return_rebase\">`this->recursiveRebase`</span>\n\trebaserecursiveRebaserebase`rebase(const LinkContext& context, uintptr_t slide)`[Rebase](#jump_rebase)\n4. `this->recursiveBindWithAccounting`\n\tnon-lazy bindlazy bindRebaserebind`doBind(const LinkContext& context, bool forceLazysBound)`\n5. `this->weakBind` \n6. `this->recursiveGetDOFSections` DOF\n7. `this->recursiveApplyInterposing`\n\nlog\n\n### <span id=\"jump_rebase\">Rebase</span>\n Rebase \n\nRebaseASLRmach-oPIC\"rebase\"\n\nPICrebase\n\n/  ()mach-o`__mod_init_func`dyld vmaddr -- slide\n\ncompressed mach-o(mach-o) `ImageLoaderMachOCompressed`\n\n rebase mach-o\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png)\n\n rebase   --  opcode  immediate\n\n\nREBASE_OPCODE_TYPE_IMM == 11:TypeType\nREBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB == 22:rebase2segmentuleb\nuleb128 == 24:uleb\nREBASE_OPCODE_DO_REBASE_IMM_TIMES == 2:rebase2\n\n224rebase\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png)\n\n02 0x3000 +  24 =0x3018 \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png)\n\n`__mod_init_func`~\n\nrebase    \n```cpp\nvoid ImageLoaderMachOCompressed::rebase(const LinkContext& context, uintptr_t slide)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\t// fLinkEditBase __LINKEDIT    == slide\n\t// start  rebase\n\tconst uint8_t* const start = fLinkEditBase + fDyldInfo->rebase_off;\n\t// end  rebase\n\tconst uint8_t* const end = &start[fDyldInfo->rebase_size];\n\tconst uint8_t* p = start;\n\n\ttry {\n\t\tuint8_t type = 0;\n\t\tint segmentIndex = 0;\n\t\tuintptr_t address = segActualLoadAddress(0);\n\t\tuintptr_t segmentStartAddress = segActualLoadAddress(0);//N\n\t\tuintptr_t segmentEndAddress = segActualEndAddress(0);//N\n\t\tuintptr_t count;\n\t\tuintptr_t skip;\n\t\tbool done = false;\n\t\twhile ( !done && (p < end) ) {\n\t\t\tuint8_t immediate = *p & REBASE_IMMEDIATE_MASK;\n\t\t\tuint8_t opcode = *p & REBASE_OPCODE_MASK;\n\t\t\t++p;\n\t\t\tswitch (opcode) {\n\t\t\t\tcase REBASE_OPCODE_DONE:\n\t\t\t\t\tdone = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_TYPE_IMM:\n\t\t\t\t\ttype = immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:\n\t\t\t\t\tsegmentIndex = immediate;\n\t\t\t\t\tif ( segmentIndex >= fSegmentsCount )\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)\",\n\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount-1);\n\t\t\t#if TEXT_RELOC_SUPPORT\n\t\t\t\t\tif ( !segWriteable(segmentIndex) && !segHasRebaseFixUps(segmentIndex) && !segHasBindFixUps(segmentIndex) )\n\t\t\t#else\n\t\t\t\t\tif ( !segWriteable(segmentIndex) )\n\t\t\t#endif\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)\",\n\t\t\t\t\t\t\t\tsegmentIndex, segName(segmentIndex));\n\t\t\t\t\t//\n\t\t\t\t\tsegmentStartAddress = segActualLoadAddress(segmentIndex);\n\t\t\t\t\tsegmentEndAddress = segActualEndAddress(segmentIndex);\n\t\t\t\t\t\n\t\t\t\t\taddress = segmentStartAddress + read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_ULEB:\n\t\t\t\t\taddress += read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_IMM_SCALED:\n\t\t\t\t\taddress += immediate*sizeof(uintptr_t);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_IMM_TIMES:\n\t\t\t\t\tfor (int i=0; i < immediate; ++i) {//N\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:\n\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\taddress += read_uleb128(p, end) + sizeof(uintptr_t);\n\t\t\t\t\t++fgTotalRebaseFixups;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tskip = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += skip + sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdyld::throwf(\"bad rebase opcode %d\", *(p-1));\n\t\t\t}\n\t\t}\n\t}\n\tcatch (const char* msg) {\n\t\tconst char* newMsg = dyld::mkstringf(\"%s in %s\", msg, this->getPath());\n\t\tfree((void*)msg);\n\t\tthrow newMsg;\n\t}\n\tCRSetCrashLogMessage2(NULL);\n}\n```\n## <span id=\"jump_init_main_execution\">initializeMainExecutable</span>\n/rebase/bind...runtime\n\n```cpp\nvoid initializeMainExecutable()\n{\n\t// record that we've reached this step\n\tgLinkContext.startedInitializingMainExecutable = true;\n\n\t// run initialzers for any inserted dylibs\n\tImageLoader::InitializerTimingList initializerTimes[allImagesCount()];\n\tinitializerTimes[0].count = 0;\n\tconst size_t rootCount = sImageRoots.size();\n\tif ( rootCount > 1 ) {\n\t\tfor(size_t i=1; i < rootCount; ++i) {\n\t\t\tsImageRoots[i]->runInitializers(gLinkContext, initializerTimes[0]);\n\t\t}\n\t}\n\t\n\t// run initializers for main executable and everything it brings up \n\tsMainExecutable->runInitializers(gLinkContext, initializerTimes[0]);\n\t\n\t// register cxa_atexit() handler to run static terminators in all loaded images when this process exits\n\tif ( gLibSystemHelpers != NULL ) \n\t\t(*gLibSystemHelpers->cxa_atexit)(&runAllStaticTerminators, NULL, NULL);\n\n\t// dump info if requested\n\tif ( sEnv.DYLD_PRINT_STATISTICS )\n\t\tImageLoader::printStatistics((unsigned int)allImagesCount(), initializerTimes[0]);\n\tif ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )\n\t\tImageLoaderMachO::printStatisticsDetails((unsigned int)allImagesCount(), initializerTimes[0]);\n}\n\n```\n\n\n\nsMainExecutable->runInitializers \n```cpp\nvoid ImageLoader::runInitializers(const LinkContext& context, InitializerTimingList& timingInfo)\n{\n\tuint64_t t1 = mach_absolute_time();\n\tmach_port_t thisThread = mach_thread_self();\n\tImageLoader::UninitedUpwards up;\n\tup.count = 1;\n\tup.images[0] = this;\n\tprocessInitializers(context, thisThread, timingInfo, up);\n\tcontext.notifyBatch(dyld_image_state_initialized, false);\n\tmach_port_deallocate(mach_task_self(), thisThread);\n\tuint64_t t2 = mach_absolute_time();\n\tfgTotalInitTime += (t2 - t1);\n}\n```\nprocessInitializers \n```cpp\nvoid ImageLoader::processInitializers(const LinkContext& context, mach_port_t thisThread,\n\t\t\t\t\t\t\t\t\t InitializerTimingList& timingInfo, ImageLoader::UninitedUpwards& images)\n{\n\tuint32_t maxImageCount = context.imageCount()+2;\n\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];\n\tImageLoader::UninitedUpwards& ups = upsBuffer[0];\n\tups.count = 0;\n\t// Calling recursive init on all images in images list, building a new list of\n\t// uninitialized upward dependencies.\n\tfor (uintptr_t i=0; i < images.count; ++i) {\n\t\timages.images[i]->recursiveInitialization(context, thisThread, images.images[i]->getPath(), timingInfo, ups);\n\t}\n\t// If any upward dependencies remain, init them.\n\tif ( ups.count > 0 )\n\t\tprocessInitializers(context, thisThread, timingInfo, ups);\n}\n```\n\nrecursiveInitialization \n```cpp\nvoid ImageLoader::recursiveInitialization(const LinkContext& context, mach_port_t this_thread, const char* pathToInitialize,\n\t\t\t\t\t\t\t\t\t\t  InitializerTimingList& timingInfo, UninitedUpwards& uninitUps)\n{\n\trecursive_lock lock_info(this_thread);\n\trecursiveSpinLock(lock_info);\n\n\tif ( fState < dyld_image_state_dependents_initialized-1 ) {\n\t\tuint8_t oldState = fState;\n\t\t// break cycles\n\t\tfState = dyld_image_state_dependents_initialized-1;\n\t\ttry {\n\t\t\t// initialize lower level libraries first\n\t\t\tfor(unsigned int i=0; i < libraryCount(); ++i) {\n\t\t\t\tImageLoader* dependentImage = libImage(i);\n\t\t\t\tif ( dependentImage != NULL ) {\n\t\t\t\t\t// don't try to initialize stuff \"above\" me yet\n\t\t\t\t\tif ( libIsUpward(i) ) {\n\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;\n\t\t\t\t\t\tuninitUps.count++;\n\t\t\t\t\t}\n\t\t\t\t\telse if ( dependentImage->fDepth >= fDepth ) {\n\t\t\t\t\t\tdependentImage->recursiveInitialization(context, this_thread, libPath(i), timingInfo, uninitUps);\n\t\t\t\t\t}\n                }\n\t\t\t}\n\t\t\t\n\t\t\t// record termination order\n\t\t\tif ( this->needsTermination() )\n\t\t\t\tcontext.terminationRecorder(this);\n\t\t\t\n\t\t\t// let objc know we are about to initialize this image\n\t\t\tuint64_t t1 = mach_absolute_time();\n\t\t\tfState = dyld_image_state_dependents_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_dependents_initialized, this, &timingInfo);\n\t\t\t\n\t\t\t// initialize this image\n\t\t\tbool hasInitializers = this->doInitialization(context);\n\n\t\t\t// let anyone know we finished initializing this image\n\t\t\tfState = dyld_image_state_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_initialized, this, NULL);\n\t\t\t\n\t\t\tif ( hasInitializers ) {\n\t\t\t\tuint64_t t2 = mach_absolute_time();\n\t\t\t\ttimingInfo.addTime(this->getShortName(), t2-t1);\n\t\t\t}\n\t\t}\n\t\tcatch (const char* msg) {\n\t\t\t// this image is not initialized\n\t\t\tfState = oldState;\n\t\t\trecursiveSpinUnLock();\n\t\t\tthrow;\n\t\t}\n\t}\n\t\n\trecursiveSpinUnLock();\n}\n```\n\ndoInitialization \n```cpp\nbool ImageLoaderMachO::doInitialization(const LinkContext& context)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\n\t// mach-o has -init and static initializers\n\tdoImageInit(context);\n\tdoModInitFunctions(context);\n\t\n\tCRSetCrashLogMessage2(NULL);\n\t\n\treturn (fHasDashInit || fHasInitializers);\n}\n```\n\n doModInitFunctions dyld_mod_init_func\n\nruntime:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png)\n\n libSystem.B.dylib -> libdispatch.dylib -> libobjc.A.dylib runtime\nruntime dyld\n`_dyld_objc_notify_register(&map_images, load_images, unmap_image);`\n\nloadruntime\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png)\n\n\n```cpp\nvoid registerObjCNotifiers(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)\n{\n\t// record functions to call\n\tsNotifyObjCMapped\t= mapped;\n\tsNotifyObjCInit\t\t= init;\n\tsNotifyObjCUnmapped = unmapped;\n\n\t// call 'mapped' function with all images mapped so far\n\ttry {\n\t\tnotifyBatchPartial(dyld_image_state_bound, true, NULL, false, true);\n\t}\n\tcatch (const char* msg) {\n\t\t// ignore request to abort during registration\n\t}\n\n\t// <rdar://problem/32209809> call 'init' function on all images already init'ed (below libSystem)\n\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\tImageLoader* image = *it;\n\t\tif ( (image->getState() == dyld_image_state_initialized) && image->notifyObjC() ) {\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_OBJC_INIT, (uint64_t)image->machHeader(), 0, 0);\n\t\t\t(*sNotifyObjCInit)(image->getRealPath(), image->machHeader());\n\t\t}\n\t}\n}\n```\n\n sAllImages  `_dyld_objc_notify_init init`runtimemach-o class  section \n\n## <span id=\"jump_end\"></span>\n1. [Mach-O](https://www.dllhook.com/post/249.html)\n2. [Mach-O](https://paper.seebug.org/202/)\n3. [dyld](https://www.dllhook.com/post/238.html)\n4. [iOS  main ](http://blog.sunnyxx.com/2014/08/30/objc-pre-main/)\n5. [dylib](https://feicong.github.io/2017/01/14/dylib/index.html)\n\n","slug":"11.dyld","published":1,"updated":"2020-08-29T14:42:58.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61j0019elc932mkc3i6","content":"<p>.</p>\n<p>dyld&#x2F;dyld ASLRobjcruntimedyld</p>\n<span id=\"more\"></span>\n\n<h2 id=\"dyld-\"><a href=\"#dyld-\" class=\"headerlink\" title=\"dyld \"></a>dyld </h2><p>dyld dyldStartup.s :load dyld<code>__dyld_start</code><code>dyld::start</code> </p>\n<p><code>dyld::start</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">uintptr_t</span> <span class=\"title\">start</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* appsMachHeader, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">intptr_t</span> slide, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* dyldsMachHeader,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">uintptr_t</span>* startGlue)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class=\"line\">\t<span class=\"comment\">// we have to do this before using any global variables</span></span><br><span class=\"line\">    <span class=\"comment\">//dyld</span></span><br><span class=\"line\">    slide = <span class=\"built_in\">slideOfMainExecutable</span>(dyldsMachHeader);</span><br><span class=\"line\">    <span class=\"type\">bool</span> shouldRebase = slide != <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( shouldRebase ) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//rebase Dyld</span></span><br><span class=\"line\">        <span class=\"built_in\">rebaseDyld</span>(dyldsMachHeader, slide);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// allow dyld to use mach messaging</span></span><br><span class=\"line\">    <span class=\"comment\">//mach</span></span><br><span class=\"line\">\t<span class=\"built_in\">mach_init</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** envp = &amp;argv[argc+<span class=\"number\">1</span>];</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** apple = envp;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*apple != <span class=\"literal\">NULL</span>) &#123; ++apple; &#125;</span><br><span class=\"line\">\t++apple;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// set up random value for stack canary</span></span><br><span class=\"line\">\t__guard_setup(apple);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class=\"line\">\t<span class=\"comment\">// run all C++ initializers inside dyld</span></span><br><span class=\"line\">    <span class=\"comment\">// dyld C++</span></span><br><span class=\"line\">\t<span class=\"built_in\">runDyldInitializers</span>(dyldsMachHeader, slide, argc, argv, envp, apple);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class=\"line\">    <span class=\"comment\">//bootstrap dyld dyld  main </span></span><br><span class=\"line\">\t<span class=\"type\">uintptr_t</span> appsSlide = <span class=\"built_in\">slideOfMainExecutable</span>(appsMachHeader);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>dyld::start</code></p>\n<ol>\n<li><span id=\"return_rebaseDyld\">rebase dyld</span><br><a href=\"#jump_rebaseDyld\">rebase dyld</a></li>\n<li> mach_msg<br> &lt;mach&#x2F;mach_init.h&gt;</li>\n<li><br> appleenvp</li>\n<li><br> applestack_guard&#x3D;xx</li>\n<li><span id=\"return_runDyldInitializers\"> dyld </span><br> dyld(PIC )dylddyld<a href=\"#jump_runDyldInitializers\"></a></li>\n<li> dyld (bootstrap) dyld main</li>\n</ol>\n<p>startdyld</p>\n<p><a href=\"#jump__main\">  dyld _main</a></p>\n<h3 id=\"RebaseDyld\"><a href=\"#RebaseDyld\" class=\"headerlink\" title=\"RebaseDyld\"></a><span id=\"jump_rebaseDyld\">RebaseDyld</span></h3><p>Dyldmach_oload_commanddylddyld</p>\n<ol>\n<li>Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info</li>\n<li>rebase  bind  Opcodes</li>\n</ol>\n<p>rebase&#x2F;bind </p>\n<p><a href=\"#return_rebaseDyld\"></a></p>\n<h3 id=\"Dyld\"><a href=\"#Dyld\" class=\"headerlink\" title=\"Dyld\"></a><span id=\"jump_runDyldInitializers\">Dyld</span></h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_start  __asm(<span class=\"string\">&quot;section$start$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_end    __asm(<span class=\"string\">&quot;section$end$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// For a regular executable, the crt code calls dyld to run the executables initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// For a static executable, crt directly runs the initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// We pass argc, argv, etc in case libc.a uses those arguments</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">runDyldInitializers</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* mh, <span class=\"type\">intptr_t</span> slide, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], <span class=\"type\">const</span> <span class=\"type\">char</span>* envp[], <span class=\"type\">const</span> <span class=\"type\">char</span>* apple[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">const</span> Initializer* p = &amp;inits_start; p &lt; &amp;inits_end; ++p) &#123;</span><br><span class=\"line\">\t\t(*p)(argc, argv, envp, apple);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>dyldcrtdyldcrtdyldhack</p>\n<p><code>__asm(&quot;section$start$__DATA$__mod_init_func&quot;)</code><code>__DATA</code><code>__mod_init_func</code></p>\n<p>Demo<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png\"></p>\n<p>mach-o <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png\"></p>\n<p><code>__mod_init_func</code>,Sectiondemo_init10xED0</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png\"></p>\n<p><code>demo_init2</code></p>\n<p>dyld<code>inits_start</code><code>inits_end</code>dyld</p>\n<p>dyld<br><a href=\"#jump_end\"></a> 1  2</p>\n<p><a href=\"#return_runDyldInitializers\"></a></p>\n<h2 id=\"dyld-main\"><a href=\"#dyld-main\" class=\"headerlink\" title=\"dyld::_main\"></a><span id=\"jump__main\">dyld::_main</span></h2><p>dyldrebasebindmach_msgdyld<code>dyld::_main</code> </p>\n<p><code>dyld::_main</code>Appmain<code>dyld::start</code><code>__dyld_start</code>main</p>\n<p>_main</p>\n<ol>\n<li> crashloglog</li>\n<li><code>// iOS cannot run without shared region</code>,iOS<br> libpath</li>\n<li><span id=\"return_initMainExecutable\">:</span><br> <code>ImageLoaderMachO</code><a href=\"#jump_initMainExecutable\"></a><br> ClassicCompressed<code>ImageLoaderMachOCompressed</code><code>ImageLoaderMachOClassic</code><code>ImageLoaderMachO</code></li>\n<li><code>loadInsertedDylib</code><a href=\"#jump_loaddylib\">Load </a><span id=\"return_loaddylib\">.</span></li>\n<li><span id=\"return_link_execution\"></span><a href=\"#jump_link_execution\"></a></li>\n<li></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_initMainExecutable\"></span></h3><p>dylddyld macho_headerdyldImageLoaderMachOdyld</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoaderMachO* <span class=\"title\">instantiateFromLoadedImage</span><span class=\"params\">(<span class=\"type\">const</span> macho_header* mh, <span class=\"type\">uintptr_t</span> slide, <span class=\"type\">const</span> <span class=\"type\">char</span>* path)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>((<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>*)mh, path) ) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = ImageLoaderMachO::<span class=\"built_in\">instantiateMainExecutable</span>(mh, slide, path, gLinkContext);</span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (ImageLoaderMachO*)image;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;main executable not a known format&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>instantiateMainExecutable</code>mach-o(compress  classic)ImageLoader</p>\n<p><code>addImage(image);</code></p>\n<ol>\n<li>ImageLoader<code>sAllImages</code></li>\n<li> <code>sMappedRangesStart</code>  <code>ImageLoader</code></li>\n</ol>\n<p><a href=\"#return_initMainExecutable\"></a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_loaddylib\"></span></h3><p>DYLD_INSERT_LIBRARIESloadInsertedDylib()</p>\n<p>load()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH-&gt;LD_LIBRARY_PATH-&gt;DYLD_FRAMEWORK_PATH-&gt;-&gt;DYLD_FALLBACK_LIBRARY_PATH</p>\n<p>ImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() </p>\n<p>loadPhase0()ImageLoaderMachO::instantiateFromCache()</p>\n<p></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// map in file and instantiate an ImageLoader</span></span><br><span class=\"line\"><span class=\"comment\">// ImagerLoader</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">loadPhase6</span><span class=\"params\">(<span class=\"type\">int</span> fd, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> stat&amp; stat_buf, <span class=\"type\">const</span> <span class=\"type\">char</span>* path, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;%s(%s)\\n&quot;, __func__ , path);</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileOffset = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileLength = stat_buf.st_size;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// validate it is a file (not directory)</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( (stat_buf.st_mode &amp; S_IFMT) != S_IFREG ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a file&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];</span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> *firstPagesPtr = firstPages;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> shortPage = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// min mach-o file is 4K</span></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o4k</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileLength &lt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, (<span class=\"type\">size_t</span>)fileLength, <span class=\"number\">0</span>) != (<span class=\"type\">ssize_t</span>)fileLength )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of short file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\tshortPage = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125; </span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// optimistically read only first 4KB</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// header4kb4k</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, <span class=\"number\">0</span>) != <span class=\"number\">4096</span> )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of first 4K failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// if fat wrapper, find usable sub-file</span></span><br><span class=\"line\">\t<span class=\"comment\">// fat</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> fat_header* fileStartAsFat = (fat_header*)firstPages;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileStartAsFat-&gt;magic == <span class=\"built_in\">OSSwapBigToHostInt32</span>(FAT_MAGIC) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch) &gt; ((<span class=\"number\">4096</span> - <span class=\"built_in\">sizeof</span>(fat_header)) / <span class=\"built_in\">sizeof</span>(fat_arch)) )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;fat header too large: %u entries&quot;</span>, <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch));</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">fatFindBest</span>(fileStartAsFat, &amp;fileOffset, &amp;fileLength) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (fileOffset+fileLength) &gt; (<span class=\"type\">uint64_t</span>)(stat_buf.st_size) )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;truncated fat file.  file length=%llu, but needed slice goes to %llu&quot;</span>, stat_buf.st_size, fileOffset+fileLength);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, fileOffset) != <span class=\"number\">4096</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of fat file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;no matching architecture in universal wrapper&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( shortPage ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;file too short&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>(firstPages, path) ) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded</span></span><br><span class=\"line\">\t\t<span class=\"type\">const</span> mach_header* mh = (mach_header*)firstPages;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> ( mh-&gt;filetype ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_EXECUTE:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_DYLIB:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_BUNDLE:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong filetype&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> headerAndLoadCommandsSize = <span class=\"built_in\">sizeof</span>(macho_header) + mh-&gt;sizeofcmds;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; %u&quot;</span>, headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; fileLength )</span><br><span class=\"line\">\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; mach-o file size (%llu)&quot;</span>, headerAndLoadCommandsSize, fileLength);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// read more pages</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//  head  LC_COMMANDS4096 headerAndLoadCommandsSize </span></span><br><span class=\"line\">\t\t\t<span class=\"type\">unsigned</span> readAmount = headerAndLoadCommandsSize - <span class=\"number\">4096</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, &amp;firstPages[<span class=\"number\">4096</span>], readAmount, fileOffset+<span class=\"number\">4096</span>) != readAmount )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of extra load commands past 4KB failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_IPHONE_SIMULATOR\t</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// &lt;rdar://problem/14168872&gt; dyld_sim should restrict loading osx binaries</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">isSimulatorBinary</span>(firstPages, path) ) &#123;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_OS_WATCH</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for watchOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">elif</span> TARGET_OS_TV</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for tvOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( gLinkContext.marzipan ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isiOSMacBinary = mf-&gt;<span class=\"built_in\">supportsPlatform</span>(dyld3::Platform::iOSMac) || <span class=\"built_in\">iOSMacWhiteListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isProhibitedMacOSBinary = !isiOSMacBinary &amp;&amp; <span class=\"built_in\">iOSMacBlackListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (context.enforceIOSMac &amp;&amp; !isiOSMacBinary) || isProhibitedMacOSBinary ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOSMac&quot;</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __arm64e__</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (sMainExecutableMachHeader-&gt;cpusubtype == CPU_SUBTYPE_ARM64_E) &amp;&amp; (mh-&gt;cpusubtype != CPU_SUBTYPE_ARM64_E) )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;arm64 dylibs cannot be loaded into arm64e processes&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\tImageLoader* image = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_MAP_IMAGE, path, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// instantiateFromFile  ImageLoader</span></span><br><span class=\"line\">\t\t\timage = ImageLoaderMachO::<span class=\"built_in\">instantiateFromFile</span>(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);</span><br><span class=\"line\">\t\t\ttimer.<span class=\"built_in\">setData4</span>((<span class=\"type\">uint64_t</span>)image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"comment\">// validate</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// </span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"built_in\">checkandAddImage</span>(image, context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try other file formats here...</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// throw error about what was found</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> (*(<span class=\"type\">uint32_t</span>*)firstPages) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC_64:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM_64:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong architecture&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X&quot;</span>, </span><br><span class=\"line\">\t\t\tfirstPages[<span class=\"number\">0</span>], firstPages[<span class=\"number\">1</span>], firstPages[<span class=\"number\">2</span>], firstPages[<span class=\"number\">3</span>], firstPages[<span class=\"number\">4</span>], firstPages[<span class=\"number\">5</span>], firstPages[<span class=\"number\">6</span>],firstPages[<span class=\"number\">7</span>]);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>ImageLoader</code></p>\n<p></p>\n<ol>\n<li>4k4k, fat_header</li>\n<li>fatCPU</li>\n<li></li>\n<li> head  Load_Commands 4k headerAndLoadCommandsSize <code>ImageLoader</code><code>ImageLoader</code> Load_Commands </li>\n<li>checkandAddImage</li>\n</ol>\n<p> checkandAddImage</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">checkandAddImage</span><span class=\"params\">(ImageLoader* image, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// now sanity check that this loaded image does not have the same install path as any existing image</span></span><br><span class=\"line\">\t<span class=\"comment\">// sAllImages </span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>* loadedImageInstallPath = image-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isDylib</span>() &amp;&amp; (loadedImageInstallPath != <span class=\"literal\">NULL</span>) &amp;&amp; (loadedImageInstallPath[<span class=\"number\">0</span>] == <span class=\"string\">&#x27;/&#x27;</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\t\tImageLoader* anImage = *it;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* installPath = anImage-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( installPath != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(loadedImageInstallPath, installPath) == <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//dyld::log(&quot;duplicate(%s) =&gt; %p\\n&quot;, installPath, anImage);</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">removeImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\tImageLoader::<span class=\"built_in\">deleteImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> anImage;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// some API&#x27;s restrict what they can load</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeBundle &amp;&amp; !image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a bundle&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeDylib &amp;&amp; !image-&gt;<span class=\"built_in\">isDylib</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a dylib&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// regular main executables cannot be loaded </span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isExecutable</span>() ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.canBePIE || !image-&gt;<span class=\"built_in\">isPositionIndependentExecutable</span>() )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;can&#x27;t load a main executable&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// don&#x27;t add bundles to global list, they can be loaded but not linked.  When linked it will be added to list</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ! image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> image;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>AddImage</code></p>\n<p><a href=\"#return_loaddylib\"></a></p>\n<h3 id=\"Link-\"><a href=\"#Link-\" class=\"headerlink\" title=\"Link \"></a><span id=\"jump_link_execution\">Link </span></h3><p>dyld</p>\n<p><code>void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain&amp; loaderRPaths, unsigned cacheIndex)</code></p>\n<p>_main mach-o   <code>ImageLoader.link</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::link</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">bool</span> forceLazysBound, <span class=\"type\">bool</span> preflightOnly, <span class=\"type\">bool</span> neverUnload, <span class=\"type\">const</span> RPathChain&amp; loaderRPaths, <span class=\"type\">const</span> <span class=\"type\">char</span>* imagePath)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n&quot;, imagePath, fDlopenReferenceCount, fNeverUnload);</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t0 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveLoadLibraries</span>(context, preflightOnly, loaderRPaths, imagePath);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_dependents_mapped, preflightOnly);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// we only do the loading step for preflights</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( preflightOnly )</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">clearAllDepths</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveUpdateDepth</span>(context.<span class=\"built_in\">imageCount</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t__block <span class=\"type\">uint64_t</span> t2, t3, t4, t5;</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdyld3::<span class=\"built_in\">ScopedTimer</span>(DBG_DYLD_TIMING_APPLY_FIXUPS, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t\tt2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveRebase</span>(context);</span><br><span class=\"line\">\t\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_rebased, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt3 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveBindWithAccounting</span>(context, forceLazysBound, neverUnload);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt4 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">weakBind</span>(context);</span><br><span class=\"line\">\t\tt5 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">        context.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_bound, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t6 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::vector&lt;DOFInfo&gt; dofs;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveGetDOFSections</span>(context, dofs);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">registerDOFs</span>(dofs);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t7 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// interpose any dynamically loaded images</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable &amp;&amp; (fgInterposingTuples.<span class=\"built_in\">size</span>() != <span class=\"number\">0</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_APPLY_INTERPOSING, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveApplyInterposing</span>(context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//log</span></span><br><span class=\"line\">\tfgTotalLoadLibrariesTime += t1 - t0;</span><br><span class=\"line\">\tfgTotalRebaseTime += t3 - t2;</span><br><span class=\"line\">\tfgTotalBindTime += t4 - t3;</span><br><span class=\"line\">\tfgTotalWeakBindTime += t5 - t4;</span><br><span class=\"line\">\tfgTotalDOF += t7 - t6;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// done with initial dylib loads</span></span><br><span class=\"line\">\tfgNextPIEDylibAddress = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>this-&gt;recursiveLoadLibraries</code>  (LoadLoadopenImageLoader)Load</li>\n<li><code>this-&gt;recursiveUpdateDepth</code> </li>\n<li><span id=\"return_rebase\"><code>this-&gt;recursiveRebase</code></span><br> rebaserecursiveRebaserebase<code>rebase(const LinkContext&amp; context, uintptr_t slide)</code><a href=\"#jump_rebase\">Rebase</a></li>\n<li><code>this-&gt;recursiveBindWithAccounting</code><br> non-lazy bindlazy bindRebaserebind<code>doBind(const LinkContext&amp; context, bool forceLazysBound)</code></li>\n<li><code>this-&gt;weakBind</code> </li>\n<li><code>this-&gt;recursiveGetDOFSections</code> DOF</li>\n<li><code>this-&gt;recursiveApplyInterposing</code></li>\n</ol>\n<p>log</p>\n<h3 id=\"Rebase\"><a href=\"#Rebase\" class=\"headerlink\" title=\"Rebase\"></a><span id=\"jump_rebase\">Rebase</span></h3><p> Rebase </p>\n<p>RebaseASLRmach-oPICrebase</p>\n<p>PICrebase</p>\n<p>&#x2F;  ()mach-o<code>__mod_init_func</code>dyld vmaddr  slide</p>\n<p>compressed mach-o(mach-o) <code>ImageLoaderMachOCompressed</code></p>\n<p> rebase mach-o<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png\"></p>\n<p> rebase     opcode  immediate</p>\n<p><br>REBASE_OPCODE_TYPE_IMM &#x3D;&#x3D; 11:TypeType<br>REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB &#x3D;&#x3D; 22:rebase2segmentuleb<br>uleb128 &#x3D;&#x3D; 24:uleb<br>REBASE_OPCODE_DO_REBASE_IMM_TIMES &#x3D;&#x3D; 2:rebase2</p>\n<p>224rebase</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png\"></p>\n<p>02 0x3000 +  24 &#x3D;0x3018 </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png\"></p>\n<p><code>__mod_init_func</code>~</p>\n<p>rebase    </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoaderMachOCompressed::rebase</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">uintptr_t</span> slide)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t<span class=\"comment\">// fLinkEditBase __LINKEDIT    == slide</span></span><br><span class=\"line\">\t<span class=\"comment\">// start  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> start = fLinkEditBase + fDyldInfo-&gt;rebase_off;</span><br><span class=\"line\">\t<span class=\"comment\">// end  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> end = &amp;start[fDyldInfo-&gt;rebase_size];</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* p = start;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> type = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> segmentIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> address = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> count;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> skip;</span><br><span class=\"line\">\t\t<span class=\"type\">bool</span> done = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> ( !done &amp;&amp; (p &lt; end) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> immediate = *p &amp; REBASE_IMMEDIATE_MASK;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> opcode = *p &amp; REBASE_OPCODE_MASK;</span><br><span class=\"line\">\t\t\t++p;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span> (opcode) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DONE:</span><br><span class=\"line\">\t\t\t\t\tdone = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_TYPE_IMM:</span><br><span class=\"line\">\t\t\t\t\ttype = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:</span><br><span class=\"line\">\t\t\t\t\tsegmentIndex = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( segmentIndex &gt;= fSegmentsCount )</span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount<span class=\"number\">-1</span>);</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">if</span> TEXT_RELOC_SUPPORT</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasRebaseFixUps</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasBindFixUps</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, <span class=\"built_in\">segName</span>(segmentIndex));</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\t\t\tsegmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\tsegmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\taddress = segmentStartAddress + <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_IMM_SCALED:</span><br><span class=\"line\">\t\t\t\t\taddress += immediate*<span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_IMM_TIMES:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; immediate; ++i) &#123;<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end) + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t++fgTotalRebaseFixups;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\tskip = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += skip + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;bad rebase opcode %d&quot;</span>, *(p<span class=\"number\">-1</span>));</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* newMsg = dyld::<span class=\"built_in\">mkstringf</span>(<span class=\"string\">&quot;%s in %s&quot;</span>, msg, <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>((<span class=\"type\">void</span>*)msg);</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> newMsg;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"initializeMainExecutable\"><a href=\"#initializeMainExecutable\" class=\"headerlink\" title=\"initializeMainExecutable\"></a><span id=\"jump_init_main_execution\">initializeMainExecutable</span></h2><p>&#x2F;rebase&#x2F;bindruntime</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">initializeMainExecutable</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record that we&#x27;ve reached this step</span></span><br><span class=\"line\">\tgLinkContext.startedInitializingMainExecutable = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// run initialzers for any inserted dylibs</span></span><br><span class=\"line\">\tImageLoader::InitializerTimingList initializerTimes[<span class=\"built_in\">allImagesCount</span>()];</span><br><span class=\"line\">\tinitializerTimes[<span class=\"number\">0</span>].count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">size_t</span> rootCount = sImageRoots.<span class=\"built_in\">size</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( rootCount &gt; <span class=\"number\">1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">size_t</span> i=<span class=\"number\">1</span>; i &lt; rootCount; ++i) &#123;</span><br><span class=\"line\">\t\t\tsImageRoots[i]-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// run initializers for main executable and everything it brings up </span></span><br><span class=\"line\">\tsMainExecutable-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// register cxa_atexit() handler to run static terminators in all loaded images when this process exits</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( gLibSystemHelpers != <span class=\"literal\">NULL</span> ) </span><br><span class=\"line\">\t\t(*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// dump info if requested</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS )</span><br><span class=\"line\">\t\tImageLoader::<span class=\"built_in\">printStatistics</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )</span><br><span class=\"line\">\t\tImageLoaderMachO::<span class=\"built_in\">printStatisticsDetails</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>sMainExecutable-&gt;runInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::runInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, InitializerTimingList&amp; timingInfo)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"type\">mach_port_t</span> thisThread = <span class=\"built_in\">mach_thread_self</span>();</span><br><span class=\"line\">\tImageLoader::UninitedUpwards up;</span><br><span class=\"line\">\tup.count = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tup.images[<span class=\"number\">0</span>] = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, up);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_initialized, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">mach_port_deallocate</span>(<span class=\"built_in\">mach_task_self</span>(), thisThread);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tfgTotalInitTime += (t2 - t1);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>processInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::processInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> thisThread,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> maxImageCount = context.<span class=\"built_in\">imageCount</span>()+<span class=\"number\">2</span>;</span><br><span class=\"line\">\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];</span><br><span class=\"line\">\tImageLoader::UninitedUpwards&amp; ups = upsBuffer[<span class=\"number\">0</span>];</span><br><span class=\"line\">\tups.count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">// Calling recursive init on all images in images list, building a new list of</span></span><br><span class=\"line\">\t<span class=\"comment\">// uninitialized upward dependencies.</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">uintptr_t</span> i=<span class=\"number\">0</span>; i &lt; images.count; ++i) &#123;</span><br><span class=\"line\">\t\timages.images[i]-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, thisThread, images.images[i]-&gt;<span class=\"built_in\">getPath</span>(), timingInfo, ups);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// If any upward dependencies remain, init them.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ups.count &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">\t\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, ups);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>recursiveInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::recursiveInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> this_thread, <span class=\"type\">const</span> <span class=\"type\">char</span>* pathToInitialize,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t\t  InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"function\">recursive_lock <span class=\"title\">lock_info</span><span class=\"params\">(this_thread)</span></span>;</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinLock</span>(lock_info);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fState &lt; dyld_image_state_dependents_initialized<span class=\"number\">-1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> oldState = fState;</span><br><span class=\"line\">\t\t<span class=\"comment\">// break cycles</span></span><br><span class=\"line\">\t\tfState = dyld_image_state_dependents_initialized<span class=\"number\">-1</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize lower level libraries first</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span>(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; <span class=\"built_in\">libraryCount</span>(); ++i) &#123;</span><br><span class=\"line\">\t\t\t\tImageLoader* dependentImage = <span class=\"built_in\">libImage</span>(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( dependentImage != <span class=\"literal\">NULL</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// don&#x27;t try to initialize stuff &quot;above&quot; me yet</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">libIsUpward</span>(i) ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.count++;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( dependentImage-&gt;fDepth &gt;= fDepth ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tdependentImage-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, this_thread, <span class=\"built_in\">libPath</span>(i), timingInfo, uninitUps);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// record termination order</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">needsTermination</span>() )</span><br><span class=\"line\">\t\t\t\tcontext.<span class=\"built_in\">terminationRecorder</span>(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let objc know we are about to initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\tfState = dyld_image_state_dependents_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_dependents_initialized, <span class=\"keyword\">this</span>, &amp;timingInfo);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> hasInitializers = <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">doInitialization</span>(context);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let anyone know we finished initializing this image</span></span><br><span class=\"line\">\t\t\tfState = dyld_image_state_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_initialized, <span class=\"keyword\">this</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( hasInitializers ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\t\ttimingInfo.<span class=\"built_in\">addTime</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getShortName</span>(), t2-t1);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// this image is not initialized</span></span><br><span class=\"line\">\t\t\tfState = oldState;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>doInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">ImageLoaderMachO::doInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o has -init and static initializers</span></span><br><span class=\"line\">\t<span class=\"built_in\">doImageInit</span>(context);</span><br><span class=\"line\">\t<span class=\"built_in\">doModInitFunctions</span>(context);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (fHasDashInit || fHasInitializers);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> doModInitFunctions dyld_mod_init_func</p>\n<p>runtime:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png\"></p>\n<p> libSystem.B.dylib -&gt; libdispatch.dylib -&gt; libobjc.A.dylib runtime<br>runtime dyld<br><code>_dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</code></p>\n<p>loadruntime</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png\"></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">registerObjCNotifiers</span><span class=\"params\">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record functions to call</span></span><br><span class=\"line\">\tsNotifyObjCMapped\t= mapped;</span><br><span class=\"line\">\tsNotifyObjCInit\t\t= init;</span><br><span class=\"line\">\tsNotifyObjCUnmapped = unmapped;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// call &#x27;mapped&#x27; function with all images mapped so far</span></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">notifyBatchPartial</span>(dyld_image_state_bound, <span class=\"literal\">true</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// ignore request to abort during registration</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// &lt;rdar://problem/32209809&gt; call &#x27;init&#x27; function on all images already init&#x27;ed (below libSystem)</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = *it;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (image-&gt;<span class=\"built_in\">getState</span>() == dyld_image_state_initialized) &amp;&amp; image-&gt;<span class=\"built_in\">notifyObjC</span>() ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_OBJC_INIT, (<span class=\"type\">uint64_t</span>)image-&gt;machHeader(), <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t(*sNotifyObjCInit)(image-&gt;<span class=\"built_in\">getRealPath</span>(), image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> sAllImages  <code>_dyld_objc_notify_init init</code>runtimemach-o class  section </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_end\"></span></h2><ol>\n<li><a href=\"https://www.dllhook.com/post/249.html\">Mach-O</a></li>\n<li><a href=\"https://paper.seebug.org/202/\">Mach-O</a></li>\n<li><a href=\"https://www.dllhook.com/post/238.html\">dyld</a></li>\n<li><a href=\"http://blog.sunnyxx.com/2014/08/30/objc-pre-main/\">iOS  main </a></li>\n<li><a href=\"https://feicong.github.io/2017/01/14/dylib/index.html\">dylib</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<p>.</p>\n<p>dyld&#x2F;dyld ASLRobjcruntimedyld</p>","more":"<h2 id=\"dyld-\"><a href=\"#dyld-\" class=\"headerlink\" title=\"dyld \"></a>dyld </h2><p>dyld dyldStartup.s :load dyld<code>__dyld_start</code><code>dyld::start</code> </p>\n<p><code>dyld::start</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">uintptr_t</span> <span class=\"title\">start</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* appsMachHeader, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">intptr_t</span> slide, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* dyldsMachHeader,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">uintptr_t</span>* startGlue)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class=\"line\">\t<span class=\"comment\">// we have to do this before using any global variables</span></span><br><span class=\"line\">    <span class=\"comment\">//dyld</span></span><br><span class=\"line\">    slide = <span class=\"built_in\">slideOfMainExecutable</span>(dyldsMachHeader);</span><br><span class=\"line\">    <span class=\"type\">bool</span> shouldRebase = slide != <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( shouldRebase ) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//rebase Dyld</span></span><br><span class=\"line\">        <span class=\"built_in\">rebaseDyld</span>(dyldsMachHeader, slide);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// allow dyld to use mach messaging</span></span><br><span class=\"line\">    <span class=\"comment\">//mach</span></span><br><span class=\"line\">\t<span class=\"built_in\">mach_init</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** envp = &amp;argv[argc+<span class=\"number\">1</span>];</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** apple = envp;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*apple != <span class=\"literal\">NULL</span>) &#123; ++apple; &#125;</span><br><span class=\"line\">\t++apple;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// set up random value for stack canary</span></span><br><span class=\"line\">\t__guard_setup(apple);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class=\"line\">\t<span class=\"comment\">// run all C++ initializers inside dyld</span></span><br><span class=\"line\">    <span class=\"comment\">// dyld C++</span></span><br><span class=\"line\">\t<span class=\"built_in\">runDyldInitializers</span>(dyldsMachHeader, slide, argc, argv, envp, apple);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class=\"line\">    <span class=\"comment\">//bootstrap dyld dyld  main </span></span><br><span class=\"line\">\t<span class=\"type\">uintptr_t</span> appsSlide = <span class=\"built_in\">slideOfMainExecutable</span>(appsMachHeader);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>dyld::start</code></p>\n<ol>\n<li><span id=\"return_rebaseDyld\">rebase dyld</span><br><a href=\"#jump_rebaseDyld\">rebase dyld</a></li>\n<li> mach_msg<br> &lt;mach&#x2F;mach_init.h&gt;</li>\n<li><br> appleenvp</li>\n<li><br> applestack_guard&#x3D;xx</li>\n<li><span id=\"return_runDyldInitializers\"> dyld </span><br> dyld(PIC )dylddyld<a href=\"#jump_runDyldInitializers\"></a></li>\n<li> dyld (bootstrap) dyld main</li>\n</ol>\n<p>startdyld</p>\n<p><a href=\"#jump__main\">  dyld _main</a></p>\n<h3 id=\"RebaseDyld\"><a href=\"#RebaseDyld\" class=\"headerlink\" title=\"RebaseDyld\"></a><span id=\"jump_rebaseDyld\">RebaseDyld</span></h3><p>Dyldmach_oload_commanddylddyld</p>\n<ol>\n<li>Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info</li>\n<li>rebase  bind  Opcodes</li>\n</ol>\n<p>rebase&#x2F;bind </p>\n<p><a href=\"#return_rebaseDyld\"></a></p>\n<h3 id=\"Dyld\"><a href=\"#Dyld\" class=\"headerlink\" title=\"Dyld\"></a><span id=\"jump_runDyldInitializers\">Dyld</span></h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_start  __asm(<span class=\"string\">&quot;section$start$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_end    __asm(<span class=\"string\">&quot;section$end$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// For a regular executable, the crt code calls dyld to run the executables initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// For a static executable, crt directly runs the initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// We pass argc, argv, etc in case libc.a uses those arguments</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">runDyldInitializers</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* mh, <span class=\"type\">intptr_t</span> slide, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], <span class=\"type\">const</span> <span class=\"type\">char</span>* envp[], <span class=\"type\">const</span> <span class=\"type\">char</span>* apple[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">const</span> Initializer* p = &amp;inits_start; p &lt; &amp;inits_end; ++p) &#123;</span><br><span class=\"line\">\t\t(*p)(argc, argv, envp, apple);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>dyldcrtdyldcrtdyldhack</p>\n<p><code>__asm(&quot;section$start$__DATA$__mod_init_func&quot;)</code><code>__DATA</code><code>__mod_init_func</code></p>\n<p>Demo<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png\"></p>\n<p>mach-o <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png\"></p>\n<p><code>__mod_init_func</code>,Sectiondemo_init10xED0</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png\"></p>\n<p><code>demo_init2</code></p>\n<p>dyld<code>inits_start</code><code>inits_end</code>dyld</p>\n<p>dyld<br><a href=\"#jump_end\"></a> 1  2</p>\n<p><a href=\"#return_runDyldInitializers\"></a></p>\n<h2 id=\"dyld-main\"><a href=\"#dyld-main\" class=\"headerlink\" title=\"dyld::_main\"></a><span id=\"jump__main\">dyld::_main</span></h2><p>dyldrebasebindmach_msgdyld<code>dyld::_main</code> </p>\n<p><code>dyld::_main</code>Appmain<code>dyld::start</code><code>__dyld_start</code>main</p>\n<p>_main</p>\n<ol>\n<li> crashloglog</li>\n<li><code>// iOS cannot run without shared region</code>,iOS<br> libpath</li>\n<li><span id=\"return_initMainExecutable\">:</span><br> <code>ImageLoaderMachO</code><a href=\"#jump_initMainExecutable\"></a><br> ClassicCompressed<code>ImageLoaderMachOCompressed</code><code>ImageLoaderMachOClassic</code><code>ImageLoaderMachO</code></li>\n<li><code>loadInsertedDylib</code><a href=\"#jump_loaddylib\">Load </a><span id=\"return_loaddylib\">.</span></li>\n<li><span id=\"return_link_execution\"></span><a href=\"#jump_link_execution\"></a></li>\n<li></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_initMainExecutable\"></span></h3><p>dylddyld macho_headerdyldImageLoaderMachOdyld</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoaderMachO* <span class=\"title\">instantiateFromLoadedImage</span><span class=\"params\">(<span class=\"type\">const</span> macho_header* mh, <span class=\"type\">uintptr_t</span> slide, <span class=\"type\">const</span> <span class=\"type\">char</span>* path)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>((<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>*)mh, path) ) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = ImageLoaderMachO::<span class=\"built_in\">instantiateMainExecutable</span>(mh, slide, path, gLinkContext);</span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (ImageLoaderMachO*)image;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;main executable not a known format&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>instantiateMainExecutable</code>mach-o(compress  classic)ImageLoader</p>\n<p><code>addImage(image);</code></p>\n<ol>\n<li>ImageLoader<code>sAllImages</code></li>\n<li> <code>sMappedRangesStart</code>  <code>ImageLoader</code></li>\n</ol>\n<p><a href=\"#return_initMainExecutable\"></a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_loaddylib\"></span></h3><p>DYLD_INSERT_LIBRARIESloadInsertedDylib()</p>\n<p>load()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH-&gt;LD_LIBRARY_PATH-&gt;DYLD_FRAMEWORK_PATH-&gt;-&gt;DYLD_FALLBACK_LIBRARY_PATH</p>\n<p>ImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() </p>\n<p>loadPhase0()ImageLoaderMachO::instantiateFromCache()</p>\n<p></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// map in file and instantiate an ImageLoader</span></span><br><span class=\"line\"><span class=\"comment\">// ImagerLoader</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">loadPhase6</span><span class=\"params\">(<span class=\"type\">int</span> fd, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> stat&amp; stat_buf, <span class=\"type\">const</span> <span class=\"type\">char</span>* path, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;%s(%s)\\n&quot;, __func__ , path);</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileOffset = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileLength = stat_buf.st_size;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// validate it is a file (not directory)</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( (stat_buf.st_mode &amp; S_IFMT) != S_IFREG ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a file&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];</span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> *firstPagesPtr = firstPages;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> shortPage = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// min mach-o file is 4K</span></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o4k</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileLength &lt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, (<span class=\"type\">size_t</span>)fileLength, <span class=\"number\">0</span>) != (<span class=\"type\">ssize_t</span>)fileLength )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of short file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\tshortPage = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125; </span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// optimistically read only first 4KB</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// header4kb4k</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, <span class=\"number\">0</span>) != <span class=\"number\">4096</span> )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of first 4K failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// if fat wrapper, find usable sub-file</span></span><br><span class=\"line\">\t<span class=\"comment\">// fat</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> fat_header* fileStartAsFat = (fat_header*)firstPages;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileStartAsFat-&gt;magic == <span class=\"built_in\">OSSwapBigToHostInt32</span>(FAT_MAGIC) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch) &gt; ((<span class=\"number\">4096</span> - <span class=\"built_in\">sizeof</span>(fat_header)) / <span class=\"built_in\">sizeof</span>(fat_arch)) )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;fat header too large: %u entries&quot;</span>, <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch));</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">fatFindBest</span>(fileStartAsFat, &amp;fileOffset, &amp;fileLength) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (fileOffset+fileLength) &gt; (<span class=\"type\">uint64_t</span>)(stat_buf.st_size) )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;truncated fat file.  file length=%llu, but needed slice goes to %llu&quot;</span>, stat_buf.st_size, fileOffset+fileLength);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, fileOffset) != <span class=\"number\">4096</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of fat file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;no matching architecture in universal wrapper&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( shortPage ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;file too short&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>(firstPages, path) ) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded</span></span><br><span class=\"line\">\t\t<span class=\"type\">const</span> mach_header* mh = (mach_header*)firstPages;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> ( mh-&gt;filetype ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_EXECUTE:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_DYLIB:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_BUNDLE:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong filetype&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> headerAndLoadCommandsSize = <span class=\"built_in\">sizeof</span>(macho_header) + mh-&gt;sizeofcmds;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; %u&quot;</span>, headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; fileLength )</span><br><span class=\"line\">\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; mach-o file size (%llu)&quot;</span>, headerAndLoadCommandsSize, fileLength);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// read more pages</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//  head  LC_COMMANDS4096 headerAndLoadCommandsSize </span></span><br><span class=\"line\">\t\t\t<span class=\"type\">unsigned</span> readAmount = headerAndLoadCommandsSize - <span class=\"number\">4096</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, &amp;firstPages[<span class=\"number\">4096</span>], readAmount, fileOffset+<span class=\"number\">4096</span>) != readAmount )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of extra load commands past 4KB failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_IPHONE_SIMULATOR\t</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// &lt;rdar://problem/14168872&gt; dyld_sim should restrict loading osx binaries</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">isSimulatorBinary</span>(firstPages, path) ) &#123;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_OS_WATCH</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for watchOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">elif</span> TARGET_OS_TV</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for tvOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( gLinkContext.marzipan ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isiOSMacBinary = mf-&gt;<span class=\"built_in\">supportsPlatform</span>(dyld3::Platform::iOSMac) || <span class=\"built_in\">iOSMacWhiteListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isProhibitedMacOSBinary = !isiOSMacBinary &amp;&amp; <span class=\"built_in\">iOSMacBlackListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (context.enforceIOSMac &amp;&amp; !isiOSMacBinary) || isProhibitedMacOSBinary ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOSMac&quot;</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __arm64e__</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (sMainExecutableMachHeader-&gt;cpusubtype == CPU_SUBTYPE_ARM64_E) &amp;&amp; (mh-&gt;cpusubtype != CPU_SUBTYPE_ARM64_E) )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;arm64 dylibs cannot be loaded into arm64e processes&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\tImageLoader* image = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_MAP_IMAGE, path, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// instantiateFromFile  ImageLoader</span></span><br><span class=\"line\">\t\t\timage = ImageLoaderMachO::<span class=\"built_in\">instantiateFromFile</span>(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);</span><br><span class=\"line\">\t\t\ttimer.<span class=\"built_in\">setData4</span>((<span class=\"type\">uint64_t</span>)image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"comment\">// validate</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// </span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"built_in\">checkandAddImage</span>(image, context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try other file formats here...</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// throw error about what was found</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> (*(<span class=\"type\">uint32_t</span>*)firstPages) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC_64:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM_64:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong architecture&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X&quot;</span>, </span><br><span class=\"line\">\t\t\tfirstPages[<span class=\"number\">0</span>], firstPages[<span class=\"number\">1</span>], firstPages[<span class=\"number\">2</span>], firstPages[<span class=\"number\">3</span>], firstPages[<span class=\"number\">4</span>], firstPages[<span class=\"number\">5</span>], firstPages[<span class=\"number\">6</span>],firstPages[<span class=\"number\">7</span>]);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>ImageLoader</code></p>\n<p></p>\n<ol>\n<li>4k4k, fat_header</li>\n<li>fatCPU</li>\n<li></li>\n<li> head  Load_Commands 4k headerAndLoadCommandsSize <code>ImageLoader</code><code>ImageLoader</code> Load_Commands </li>\n<li>checkandAddImage</li>\n</ol>\n<p> checkandAddImage</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">checkandAddImage</span><span class=\"params\">(ImageLoader* image, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// now sanity check that this loaded image does not have the same install path as any existing image</span></span><br><span class=\"line\">\t<span class=\"comment\">// sAllImages </span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>* loadedImageInstallPath = image-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isDylib</span>() &amp;&amp; (loadedImageInstallPath != <span class=\"literal\">NULL</span>) &amp;&amp; (loadedImageInstallPath[<span class=\"number\">0</span>] == <span class=\"string\">&#x27;/&#x27;</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\t\tImageLoader* anImage = *it;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* installPath = anImage-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( installPath != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(loadedImageInstallPath, installPath) == <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//dyld::log(&quot;duplicate(%s) =&gt; %p\\n&quot;, installPath, anImage);</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">removeImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\tImageLoader::<span class=\"built_in\">deleteImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> anImage;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// some API&#x27;s restrict what they can load</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeBundle &amp;&amp; !image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a bundle&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeDylib &amp;&amp; !image-&gt;<span class=\"built_in\">isDylib</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a dylib&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// regular main executables cannot be loaded </span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isExecutable</span>() ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.canBePIE || !image-&gt;<span class=\"built_in\">isPositionIndependentExecutable</span>() )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;can&#x27;t load a main executable&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// don&#x27;t add bundles to global list, they can be loaded but not linked.  When linked it will be added to list</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ! image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> image;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>AddImage</code></p>\n<p><a href=\"#return_loaddylib\"></a></p>\n<h3 id=\"Link-\"><a href=\"#Link-\" class=\"headerlink\" title=\"Link \"></a><span id=\"jump_link_execution\">Link </span></h3><p>dyld</p>\n<p><code>void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain&amp; loaderRPaths, unsigned cacheIndex)</code></p>\n<p>_main mach-o   <code>ImageLoader.link</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::link</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">bool</span> forceLazysBound, <span class=\"type\">bool</span> preflightOnly, <span class=\"type\">bool</span> neverUnload, <span class=\"type\">const</span> RPathChain&amp; loaderRPaths, <span class=\"type\">const</span> <span class=\"type\">char</span>* imagePath)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n&quot;, imagePath, fDlopenReferenceCount, fNeverUnload);</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t0 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveLoadLibraries</span>(context, preflightOnly, loaderRPaths, imagePath);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_dependents_mapped, preflightOnly);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// we only do the loading step for preflights</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( preflightOnly )</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">clearAllDepths</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveUpdateDepth</span>(context.<span class=\"built_in\">imageCount</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t__block <span class=\"type\">uint64_t</span> t2, t3, t4, t5;</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdyld3::<span class=\"built_in\">ScopedTimer</span>(DBG_DYLD_TIMING_APPLY_FIXUPS, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t\tt2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveRebase</span>(context);</span><br><span class=\"line\">\t\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_rebased, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt3 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveBindWithAccounting</span>(context, forceLazysBound, neverUnload);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt4 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">weakBind</span>(context);</span><br><span class=\"line\">\t\tt5 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">        context.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_bound, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t6 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::vector&lt;DOFInfo&gt; dofs;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveGetDOFSections</span>(context, dofs);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">registerDOFs</span>(dofs);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t7 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// interpose any dynamically loaded images</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable &amp;&amp; (fgInterposingTuples.<span class=\"built_in\">size</span>() != <span class=\"number\">0</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_APPLY_INTERPOSING, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveApplyInterposing</span>(context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//log</span></span><br><span class=\"line\">\tfgTotalLoadLibrariesTime += t1 - t0;</span><br><span class=\"line\">\tfgTotalRebaseTime += t3 - t2;</span><br><span class=\"line\">\tfgTotalBindTime += t4 - t3;</span><br><span class=\"line\">\tfgTotalWeakBindTime += t5 - t4;</span><br><span class=\"line\">\tfgTotalDOF += t7 - t6;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// done with initial dylib loads</span></span><br><span class=\"line\">\tfgNextPIEDylibAddress = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>this-&gt;recursiveLoadLibraries</code>  (LoadLoadopenImageLoader)Load</li>\n<li><code>this-&gt;recursiveUpdateDepth</code> </li>\n<li><span id=\"return_rebase\"><code>this-&gt;recursiveRebase</code></span><br> rebaserecursiveRebaserebase<code>rebase(const LinkContext&amp; context, uintptr_t slide)</code><a href=\"#jump_rebase\">Rebase</a></li>\n<li><code>this-&gt;recursiveBindWithAccounting</code><br> non-lazy bindlazy bindRebaserebind<code>doBind(const LinkContext&amp; context, bool forceLazysBound)</code></li>\n<li><code>this-&gt;weakBind</code> </li>\n<li><code>this-&gt;recursiveGetDOFSections</code> DOF</li>\n<li><code>this-&gt;recursiveApplyInterposing</code></li>\n</ol>\n<p>log</p>\n<h3 id=\"Rebase\"><a href=\"#Rebase\" class=\"headerlink\" title=\"Rebase\"></a><span id=\"jump_rebase\">Rebase</span></h3><p> Rebase </p>\n<p>RebaseASLRmach-oPICrebase</p>\n<p>PICrebase</p>\n<p>&#x2F;  ()mach-o<code>__mod_init_func</code>dyld vmaddr  slide</p>\n<p>compressed mach-o(mach-o) <code>ImageLoaderMachOCompressed</code></p>\n<p> rebase mach-o<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png\"></p>\n<p> rebase     opcode  immediate</p>\n<p><br>REBASE_OPCODE_TYPE_IMM &#x3D;&#x3D; 11:TypeType<br>REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB &#x3D;&#x3D; 22:rebase2segmentuleb<br>uleb128 &#x3D;&#x3D; 24:uleb<br>REBASE_OPCODE_DO_REBASE_IMM_TIMES &#x3D;&#x3D; 2:rebase2</p>\n<p>224rebase</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png\"></p>\n<p>02 0x3000 +  24 &#x3D;0x3018 </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png\"></p>\n<p><code>__mod_init_func</code>~</p>\n<p>rebase    </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoaderMachOCompressed::rebase</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">uintptr_t</span> slide)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t<span class=\"comment\">// fLinkEditBase __LINKEDIT    == slide</span></span><br><span class=\"line\">\t<span class=\"comment\">// start  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> start = fLinkEditBase + fDyldInfo-&gt;rebase_off;</span><br><span class=\"line\">\t<span class=\"comment\">// end  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> end = &amp;start[fDyldInfo-&gt;rebase_size];</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* p = start;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> type = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> segmentIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> address = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> count;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> skip;</span><br><span class=\"line\">\t\t<span class=\"type\">bool</span> done = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> ( !done &amp;&amp; (p &lt; end) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> immediate = *p &amp; REBASE_IMMEDIATE_MASK;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> opcode = *p &amp; REBASE_OPCODE_MASK;</span><br><span class=\"line\">\t\t\t++p;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span> (opcode) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DONE:</span><br><span class=\"line\">\t\t\t\t\tdone = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_TYPE_IMM:</span><br><span class=\"line\">\t\t\t\t\ttype = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:</span><br><span class=\"line\">\t\t\t\t\tsegmentIndex = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( segmentIndex &gt;= fSegmentsCount )</span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount<span class=\"number\">-1</span>);</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">if</span> TEXT_RELOC_SUPPORT</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasRebaseFixUps</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasBindFixUps</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, <span class=\"built_in\">segName</span>(segmentIndex));</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\t\t\tsegmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\tsegmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\taddress = segmentStartAddress + <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_IMM_SCALED:</span><br><span class=\"line\">\t\t\t\t\taddress += immediate*<span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_IMM_TIMES:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; immediate; ++i) &#123;<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end) + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t++fgTotalRebaseFixups;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\tskip = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += skip + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;bad rebase opcode %d&quot;</span>, *(p<span class=\"number\">-1</span>));</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* newMsg = dyld::<span class=\"built_in\">mkstringf</span>(<span class=\"string\">&quot;%s in %s&quot;</span>, msg, <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>((<span class=\"type\">void</span>*)msg);</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> newMsg;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"initializeMainExecutable\"><a href=\"#initializeMainExecutable\" class=\"headerlink\" title=\"initializeMainExecutable\"></a><span id=\"jump_init_main_execution\">initializeMainExecutable</span></h2><p>&#x2F;rebase&#x2F;bindruntime</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">initializeMainExecutable</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record that we&#x27;ve reached this step</span></span><br><span class=\"line\">\tgLinkContext.startedInitializingMainExecutable = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// run initialzers for any inserted dylibs</span></span><br><span class=\"line\">\tImageLoader::InitializerTimingList initializerTimes[<span class=\"built_in\">allImagesCount</span>()];</span><br><span class=\"line\">\tinitializerTimes[<span class=\"number\">0</span>].count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">size_t</span> rootCount = sImageRoots.<span class=\"built_in\">size</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( rootCount &gt; <span class=\"number\">1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">size_t</span> i=<span class=\"number\">1</span>; i &lt; rootCount; ++i) &#123;</span><br><span class=\"line\">\t\t\tsImageRoots[i]-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// run initializers for main executable and everything it brings up </span></span><br><span class=\"line\">\tsMainExecutable-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// register cxa_atexit() handler to run static terminators in all loaded images when this process exits</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( gLibSystemHelpers != <span class=\"literal\">NULL</span> ) </span><br><span class=\"line\">\t\t(*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// dump info if requested</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS )</span><br><span class=\"line\">\t\tImageLoader::<span class=\"built_in\">printStatistics</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )</span><br><span class=\"line\">\t\tImageLoaderMachO::<span class=\"built_in\">printStatisticsDetails</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>sMainExecutable-&gt;runInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::runInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, InitializerTimingList&amp; timingInfo)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"type\">mach_port_t</span> thisThread = <span class=\"built_in\">mach_thread_self</span>();</span><br><span class=\"line\">\tImageLoader::UninitedUpwards up;</span><br><span class=\"line\">\tup.count = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tup.images[<span class=\"number\">0</span>] = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, up);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_initialized, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">mach_port_deallocate</span>(<span class=\"built_in\">mach_task_self</span>(), thisThread);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tfgTotalInitTime += (t2 - t1);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>processInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::processInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> thisThread,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> maxImageCount = context.<span class=\"built_in\">imageCount</span>()+<span class=\"number\">2</span>;</span><br><span class=\"line\">\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];</span><br><span class=\"line\">\tImageLoader::UninitedUpwards&amp; ups = upsBuffer[<span class=\"number\">0</span>];</span><br><span class=\"line\">\tups.count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">// Calling recursive init on all images in images list, building a new list of</span></span><br><span class=\"line\">\t<span class=\"comment\">// uninitialized upward dependencies.</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">uintptr_t</span> i=<span class=\"number\">0</span>; i &lt; images.count; ++i) &#123;</span><br><span class=\"line\">\t\timages.images[i]-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, thisThread, images.images[i]-&gt;<span class=\"built_in\">getPath</span>(), timingInfo, ups);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// If any upward dependencies remain, init them.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ups.count &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">\t\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, ups);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>recursiveInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::recursiveInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> this_thread, <span class=\"type\">const</span> <span class=\"type\">char</span>* pathToInitialize,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t\t  InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"function\">recursive_lock <span class=\"title\">lock_info</span><span class=\"params\">(this_thread)</span></span>;</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinLock</span>(lock_info);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fState &lt; dyld_image_state_dependents_initialized<span class=\"number\">-1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> oldState = fState;</span><br><span class=\"line\">\t\t<span class=\"comment\">// break cycles</span></span><br><span class=\"line\">\t\tfState = dyld_image_state_dependents_initialized<span class=\"number\">-1</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize lower level libraries first</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span>(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; <span class=\"built_in\">libraryCount</span>(); ++i) &#123;</span><br><span class=\"line\">\t\t\t\tImageLoader* dependentImage = <span class=\"built_in\">libImage</span>(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( dependentImage != <span class=\"literal\">NULL</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// don&#x27;t try to initialize stuff &quot;above&quot; me yet</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">libIsUpward</span>(i) ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.count++;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( dependentImage-&gt;fDepth &gt;= fDepth ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tdependentImage-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, this_thread, <span class=\"built_in\">libPath</span>(i), timingInfo, uninitUps);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// record termination order</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">needsTermination</span>() )</span><br><span class=\"line\">\t\t\t\tcontext.<span class=\"built_in\">terminationRecorder</span>(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let objc know we are about to initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\tfState = dyld_image_state_dependents_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_dependents_initialized, <span class=\"keyword\">this</span>, &amp;timingInfo);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> hasInitializers = <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">doInitialization</span>(context);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let anyone know we finished initializing this image</span></span><br><span class=\"line\">\t\t\tfState = dyld_image_state_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_initialized, <span class=\"keyword\">this</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( hasInitializers ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\t\ttimingInfo.<span class=\"built_in\">addTime</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getShortName</span>(), t2-t1);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// this image is not initialized</span></span><br><span class=\"line\">\t\t\tfState = oldState;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>doInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">ImageLoaderMachO::doInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o has -init and static initializers</span></span><br><span class=\"line\">\t<span class=\"built_in\">doImageInit</span>(context);</span><br><span class=\"line\">\t<span class=\"built_in\">doModInitFunctions</span>(context);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (fHasDashInit || fHasInitializers);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> doModInitFunctions dyld_mod_init_func</p>\n<p>runtime:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png\"></p>\n<p> libSystem.B.dylib -&gt; libdispatch.dylib -&gt; libobjc.A.dylib runtime<br>runtime dyld<br><code>_dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</code></p>\n<p>loadruntime</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png\"></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">registerObjCNotifiers</span><span class=\"params\">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record functions to call</span></span><br><span class=\"line\">\tsNotifyObjCMapped\t= mapped;</span><br><span class=\"line\">\tsNotifyObjCInit\t\t= init;</span><br><span class=\"line\">\tsNotifyObjCUnmapped = unmapped;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// call &#x27;mapped&#x27; function with all images mapped so far</span></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">notifyBatchPartial</span>(dyld_image_state_bound, <span class=\"literal\">true</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// ignore request to abort during registration</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// &lt;rdar://problem/32209809&gt; call &#x27;init&#x27; function on all images already init&#x27;ed (below libSystem)</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = *it;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (image-&gt;<span class=\"built_in\">getState</span>() == dyld_image_state_initialized) &amp;&amp; image-&gt;<span class=\"built_in\">notifyObjC</span>() ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_OBJC_INIT, (<span class=\"type\">uint64_t</span>)image-&gt;machHeader(), <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t(*sNotifyObjCInit)(image-&gt;<span class=\"built_in\">getRealPath</span>(), image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> sAllImages  <code>_dyld_objc_notify_init init</code>runtimemach-o class  section </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_end\"></span></h2><ol>\n<li><a href=\"https://www.dllhook.com/post/249.html\">Mach-O</a></li>\n<li><a href=\"https://paper.seebug.org/202/\">Mach-O</a></li>\n<li><a href=\"https://www.dllhook.com/post/238.html\">dyld</a></li>\n<li><a href=\"http://blog.sunnyxx.com/2014/08/30/objc-pre-main/\">iOS  main </a></li>\n<li><a href=\"https://feicong.github.io/2017/01/14/dylib/index.html\">dylib</a></li>\n</ol>"},{"title":"The Pager Module","date":"2020-08-16T16:00:00.000Z","_content":"\n> SQLitePagerBTreeACID\n\n<!-- more -->\n\n# Pager\nSQLite;SQLitepage cache()\n\npageSQLitePagerPagerTreePagerTree\n\nSQLite()PagerPager(SQLite)Tree\n\nSQLitePagerI/O APIPager(file change counter)\n\nPagerTreePager\n\npagerDBMS:ACID\n\n# Pager\nPagerTreePagerTree\n\n## Pager-client\nPagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager\n\n### Pager\nPager`Pager``Pager``Pager`(Pager)TreePagerPager`Pager`(`Pager`)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png)\n\n`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png)\n\nSQlite(insert,delete,update)savepointaSavepointSQLitesavepoint`iHdrOffset`0savepoint`iHdrOffset``PagerSavepoint`,`iOffset`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png)\n\n### Pager\nPagerTree`sqlite3Pager`SQLite\n\n1. sqlite3PagerOpen:`Pager``Pager`/()\n\n2. sqlite3PagerClose:`Pager`pager\n\n3. sqlite3PagerGet:--(244)()()pager0.()\n\n4. sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite\n\n5. sqlite3PagerLookup:NULL\n\n6. sqlite3PagerRef:+1\n\n7. sqlite3PagerUnref:-10(`Pager`\n\n8. sqlite3PagerBegin:()`sqlite3PagerWrite`Tree\n\n9. sqlite3PagerCommitPhaseOne::+1()\n\n10. sqlite3PagerCommitPhaseTwo:()\n\n11. sqlite3PagerRollback::\n\n12. sqlite3PagerOpenSavepoint:\n\n13. sqlite3PagerSavepoint:\n\n# \nSQLite()SQLite`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png)\n\n## \n(`Pager`)Pager`eState``eLock`Pager7(`Pager.eState`)7\n\n1. **PAGER_OPEN**:`Pager`pager`Pager`\n\n2. **PAGER_READER**:pager()\n\n3. **PAGER_WRITER_LOCKED**:`Pager`pager\n\n4. **PAGER_WRITER_CACHEMOD**:`Pager`pagerTreeTree\n\n5. **PAGER_WRITER_DBMOD**:`Pager`pager\n\n6. **PAGER_WRITER_FINISHED**:`Pager`pager\n\n7. **PAGER_ERROR**:I/O\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png)\n\n`eLock``Pager`4\n\n1. **NO_LOCK**:\n\n2. **SHARED_LOCK**:Pager`Pager`\n\n3. **RESERVED_LOCK**:pagerpagerPager\n\n4. **EXCLUSIVE_LOCK**:pagerpagerpager\n\nNO_LOCKTree`sqlite3PagerGet`pagerSHARED_LOCKTree`sqlite3PagerUnref`pagerNO_LOCK()Tree`sqlite3PagerWrite`pagerRESERVED_LOCK(`sqlite3PagerWrite`pager)pagerEXCLUSIVE_LOCK`sqlite3PagerRollback``sqlite3PagerCommitPhasTwo`pagerNO_LOCK\n\n* `Pager.eLock`EXCLUSICE_LOCK\n\n## \n\n`PCache`pager`PCache`(pager)`PCache`SQLite(pcache1.c)`PCache`pCache,\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png)\n\nSQLitepager`PCache.nMax`attach2000500\n\nSQLite`PgHdr`pagerSQLite`PCache1``PgHdr1`pager`PgHdr1``PCache1.szSize``PgHdr`Tree(:pager)pager0`PCache1.aphash``PCache1.nHash`(bucket)\n\n`PgHdr`pagerTree`pgno``needSync`flush`dirty``nRef``nRef`0`pDirtyNext``pDirtyPrev`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png)\n\n****:SQLite`PCache1`\n\n## \n`PCache1.apHash`(Tree)`sqlite3PagerGet`P\n\n1. \n    * P`apHash`:`apHash`\n    * `apHash`\n    * `pNext`P(`PgHdr.nRef`+1)\n\n2. P(`PCache.nMax`)\n\n3. P()\n\n4. (WAL)\n\n5. (a)PP(`PgHdr.nRef`1)(b)P00(`PgHdr.nRef`1)\n\nSQLite()\n\n(Tree)pagerSQLite:()SQLite3.7.810\n\n## \n`sqlite3PagerWrite`\n\n`sqlite3PagerWrite`pager`PgHdr.needSync`pager(SQLiteSQL:`needSync`)`sqlite3PagerWrite``PgHdr.dirty`pagerpagerpager\n\n\n\n## \nSQLite\n\n## \n:\n\n1. \n\n2. \n\n3. \n\n()265\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png)\n\n### \n\n\nPSQLite(LRU)\n\n### LRU\nLRU()\n\n### SQLite\nSQLitepager()LRUSQLiteSQLite\n\n# \nSQLitePagerACIDSQLitepager\n\nDBMSSQLite:1. 2.pager\n\n## \npager\n\n### \n(Tree)`sqlite3PagerGet`:pagerSQLITE_BUSY\n\n0Tree\n\npager()pager`sqlite3PagerGet`\n\npager\n\n### \n(Tree)(`sqlite3PagerGet`)`sqlite3PagerWrite`pagerpager`sqlite3PagerWrite`pagerpagerpagerSQLITE_BUSY\n\npager()pager('-journal')()\n\npagerlog\n\n****:SQLitelog\n\n**log**:`sqlite3PagerWrite`\n\n### \npager(Tree)pager():1.2.pagerpagerSQLiteWALpager:\n\n1. ()pagerflush`fsync`pager(`nRec`)(`nRec`0-1)pager`nRec``fsync``nRec`pagerSQLite\n\n2. (pagerSQLITE_BUSY)\n\n3. ()()\n\npager\n\n****:\n\n### \nSQLite\n\n****:Tree`sqlite3PagerCommitPhaseOne``sqlite3PagerCommitPhaseTwo`pagerNO_LOCK(\"\")pager:\n\n1. (`sqlite3PagerCommitPhaseOne`SQLITE_BUSY)metadata+1(****1-3)\n\n2. Linuxpager`fsync`\n\n3. \n\n4. SHARED_LOCKNO_LOCK\n\n\n\n****:VM`VdbeCommit`pager():\n\n1. ()\n\n2.  \n\n3. ('-mj',8)flush()\n\n4. flush(pager)\n\n5. flush\n\n6. flush\n\n7. \n\n8. pagerSHARED_LOCKNO_LOCKpager\n\n\n\n****:journal_mode\n\n****:SQLiteVM\n\n****:COMMITSQLiteSQLITE_BUSYSQLite\n\n### \n\n\n****:\n\n****::(`etilqs_`pager`sqlite3PagerWrite`\n\n1. pager(log)\n\n2. pager(logpager)\n\npagerflush\n\n****:pager()\n\n### \nSQLiteSQLite:\n\n### \n`release sp`SQLite`PagerSavepoint``sp`\n\n## \nSQLite()(),4\n\n### \nSQLitepagerpagerpager\n\npagerpagerpagerflush\n\n### \nSQLite\n\n### \n`roll to sp`SQLite`sp``PagerSavepoint``iOffset``iHdrOffset``iSubRec`iOffset`iSubRec``iHdrOffset`:(1)`iOffset``iHdrOffset`(2)pager`Pager.dbSize`(PagerSavepoint.nOrig)SQLite`sp``PagerSavepoint``sp`\n\n### \nSQLite\n\n****::(1)(0)(2)\n\n****:SQLite\n\npager\n\n1. (SQLITE_BUSY)\n\n2. \n\n3. (pagerpager) pagerSQLITE_BUSY\n\n4. ()\n\n5. flush\n\n6. ()\n\n7. \n\n8. (pager`sqlite3PagerGet`)\n\n\n\n****:pagerpager\n\n## \n### \nSQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)\n\n### \nDBMSDBMSSQLite:SQLite\n\n:pagerSQLITE_FULLSQLite","source":"_posts/2020-08-17_db-system-design-imp(Pager).md","raw":"---\ntitle: The Pager Module\ndate: 2020-08-17\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLitePagerBTreeACID\n\n<!-- more -->\n\n# Pager\nSQLite;SQLitepage cache()\n\npageSQLitePagerPagerTreePagerTree\n\nSQLite()PagerPager(SQLite)Tree\n\nSQLitePagerI/O APIPager(file change counter)\n\nPagerTreePager\n\npagerDBMS:ACID\n\n# Pager\nPagerTreePagerTree\n\n## Pager-client\nPagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager\n\n### Pager\nPager`Pager``Pager``Pager`(Pager)TreePagerPager`Pager`(`Pager`)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png)\n\n`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png)\n\nSQlite(insert,delete,update)savepointaSavepointSQLitesavepoint`iHdrOffset`0savepoint`iHdrOffset``PagerSavepoint`,`iOffset`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png)\n\n### Pager\nPagerTree`sqlite3Pager`SQLite\n\n1. sqlite3PagerOpen:`Pager``Pager`/()\n\n2. sqlite3PagerClose:`Pager`pager\n\n3. sqlite3PagerGet:--(244)()()pager0.()\n\n4. sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite\n\n5. sqlite3PagerLookup:NULL\n\n6. sqlite3PagerRef:+1\n\n7. sqlite3PagerUnref:-10(`Pager`\n\n8. sqlite3PagerBegin:()`sqlite3PagerWrite`Tree\n\n9. sqlite3PagerCommitPhaseOne::+1()\n\n10. sqlite3PagerCommitPhaseTwo:()\n\n11. sqlite3PagerRollback::\n\n12. sqlite3PagerOpenSavepoint:\n\n13. sqlite3PagerSavepoint:\n\n# \nSQLite()SQLite`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png)\n\n## \n(`Pager`)Pager`eState``eLock`Pager7(`Pager.eState`)7\n\n1. **PAGER_OPEN**:`Pager`pager`Pager`\n\n2. **PAGER_READER**:pager()\n\n3. **PAGER_WRITER_LOCKED**:`Pager`pager\n\n4. **PAGER_WRITER_CACHEMOD**:`Pager`pagerTreeTree\n\n5. **PAGER_WRITER_DBMOD**:`Pager`pager\n\n6. **PAGER_WRITER_FINISHED**:`Pager`pager\n\n7. **PAGER_ERROR**:I/O\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png)\n\n`eLock``Pager`4\n\n1. **NO_LOCK**:\n\n2. **SHARED_LOCK**:Pager`Pager`\n\n3. **RESERVED_LOCK**:pagerpagerPager\n\n4. **EXCLUSIVE_LOCK**:pagerpagerpager\n\nNO_LOCKTree`sqlite3PagerGet`pagerSHARED_LOCKTree`sqlite3PagerUnref`pagerNO_LOCK()Tree`sqlite3PagerWrite`pagerRESERVED_LOCK(`sqlite3PagerWrite`pager)pagerEXCLUSIVE_LOCK`sqlite3PagerRollback``sqlite3PagerCommitPhasTwo`pagerNO_LOCK\n\n* `Pager.eLock`EXCLUSICE_LOCK\n\n## \n\n`PCache`pager`PCache`(pager)`PCache`SQLite(pcache1.c)`PCache`pCache,\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png)\n\nSQLitepager`PCache.nMax`attach2000500\n\nSQLite`PgHdr`pagerSQLite`PCache1``PgHdr1`pager`PgHdr1``PCache1.szSize``PgHdr`Tree(:pager)pager0`PCache1.aphash``PCache1.nHash`(bucket)\n\n`PgHdr`pagerTree`pgno``needSync`flush`dirty``nRef``nRef`0`pDirtyNext``pDirtyPrev`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png)\n\n****:SQLite`PCache1`\n\n## \n`PCache1.apHash`(Tree)`sqlite3PagerGet`P\n\n1. \n    * P`apHash`:`apHash`\n    * `apHash`\n    * `pNext`P(`PgHdr.nRef`+1)\n\n2. P(`PCache.nMax`)\n\n3. P()\n\n4. (WAL)\n\n5. (a)PP(`PgHdr.nRef`1)(b)P00(`PgHdr.nRef`1)\n\nSQLite()\n\n(Tree)pagerSQLite:()SQLite3.7.810\n\n## \n`sqlite3PagerWrite`\n\n`sqlite3PagerWrite`pager`PgHdr.needSync`pager(SQLiteSQL:`needSync`)`sqlite3PagerWrite``PgHdr.dirty`pagerpagerpager\n\n\n\n## \nSQLite\n\n## \n:\n\n1. \n\n2. \n\n3. \n\n()265\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png)\n\n### \n\n\nPSQLite(LRU)\n\n### LRU\nLRU()\n\n### SQLite\nSQLitepager()LRUSQLiteSQLite\n\n# \nSQLitePagerACIDSQLitepager\n\nDBMSSQLite:1. 2.pager\n\n## \npager\n\n### \n(Tree)`sqlite3PagerGet`:pagerSQLITE_BUSY\n\n0Tree\n\npager()pager`sqlite3PagerGet`\n\npager\n\n### \n(Tree)(`sqlite3PagerGet`)`sqlite3PagerWrite`pagerpager`sqlite3PagerWrite`pagerpagerpagerSQLITE_BUSY\n\npager()pager('-journal')()\n\npagerlog\n\n****:SQLitelog\n\n**log**:`sqlite3PagerWrite`\n\n### \npager(Tree)pager():1.2.pagerpagerSQLiteWALpager:\n\n1. ()pagerflush`fsync`pager(`nRec`)(`nRec`0-1)pager`nRec``fsync``nRec`pagerSQLite\n\n2. (pagerSQLITE_BUSY)\n\n3. ()()\n\npager\n\n****:\n\n### \nSQLite\n\n****:Tree`sqlite3PagerCommitPhaseOne``sqlite3PagerCommitPhaseTwo`pagerNO_LOCK(\"\")pager:\n\n1. (`sqlite3PagerCommitPhaseOne`SQLITE_BUSY)metadata+1(****1-3)\n\n2. Linuxpager`fsync`\n\n3. \n\n4. SHARED_LOCKNO_LOCK\n\n\n\n****:VM`VdbeCommit`pager():\n\n1. ()\n\n2.  \n\n3. ('-mj',8)flush()\n\n4. flush(pager)\n\n5. flush\n\n6. flush\n\n7. \n\n8. pagerSHARED_LOCKNO_LOCKpager\n\n\n\n****:journal_mode\n\n****:SQLiteVM\n\n****:COMMITSQLiteSQLITE_BUSYSQLite\n\n### \n\n\n****:\n\n****::(`etilqs_`pager`sqlite3PagerWrite`\n\n1. pager(log)\n\n2. pager(logpager)\n\npagerflush\n\n****:pager()\n\n### \nSQLiteSQLite:\n\n### \n`release sp`SQLite`PagerSavepoint``sp`\n\n## \nSQLite()(),4\n\n### \nSQLitepagerpagerpager\n\npagerpagerpagerflush\n\n### \nSQLite\n\n### \n`roll to sp`SQLite`sp``PagerSavepoint``iOffset``iHdrOffset``iSubRec`iOffset`iSubRec``iHdrOffset`:(1)`iOffset``iHdrOffset`(2)pager`Pager.dbSize`(PagerSavepoint.nOrig)SQLite`sp``PagerSavepoint``sp`\n\n### \nSQLite\n\n****::(1)(0)(2)\n\n****:SQLite\n\npager\n\n1. (SQLITE_BUSY)\n\n2. \n\n3. (pagerpager) pagerSQLITE_BUSY\n\n4. ()\n\n5. flush\n\n6. ()\n\n7. \n\n8. (pager`sqlite3PagerGet`)\n\n\n\n****:pagerpager\n\n## \n### \nSQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)\n\n### \nDBMSDBMSSQLite:SQLite\n\n:pagerSQLITE_FULLSQLite","slug":"2020-08-17_db-system-design-imp(Pager)","published":1,"updated":"2020-08-31T07:21:34.085Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61l001eelc921510pm3","content":"<blockquote>\n<p>SQLitePagerBTreeACID</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>SQLite;SQLitepage cache()</p>\n<p>pageSQLitePagerPagerTreePagerTree</p>\n<p>SQLite()PagerPager(SQLite)Tree</p>\n<p>SQLitePagerI&#x2F;O APIPager(file change counter)</p>\n<p>PagerTreePager</p>\n<p>pagerDBMS:ACID</p>\n<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>PagerTreePagerTree</p>\n<h2 id=\"Pager-client\"><a href=\"#Pager-client\" class=\"headerlink\" title=\"Pager-client\"></a>Pager-client</h2><p>PagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager</p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>Pager<code>Pager</code><code>Pager</code><code>Pager</code>(Pager)TreePagerPager<code>Pager</code>(<code>Pager</code>)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png\"></p>\n<p><code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png\"></p>\n<p>SQlite(insert,delete,update)savepointaSavepointSQLitesavepoint<code>iHdrOffset</code>0savepoint<code>iHdrOffset</code><code>PagerSavepoint</code>,<code>iOffset</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png\"></p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>PagerTree<code>sqlite3Pager</code>SQLite</p>\n<ol>\n<li><p>sqlite3PagerOpen:<code>Pager</code><code>Pager</code>&#x2F;()</p>\n</li>\n<li><p>sqlite3PagerClose:<code>Pager</code>pager</p>\n</li>\n<li><p>sqlite3PagerGet:(244)()()pager0.()</p>\n</li>\n<li><p>sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite</p>\n</li>\n<li><p>sqlite3PagerLookup:NULL</p>\n</li>\n<li><p>sqlite3PagerRef:+1</p>\n</li>\n<li><p>sqlite3PagerUnref:-10(<code>Pager</code></p>\n</li>\n<li><p>sqlite3PagerBegin:()<code>sqlite3PagerWrite</code>Tree</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseOne::+1()</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseTwo:()</p>\n</li>\n<li><p>sqlite3PagerRollback::</p>\n</li>\n<li><p>sqlite3PagerOpenSavepoint:</p>\n</li>\n<li><p>sqlite3PagerSavepoint:</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()SQLite<code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>(<code>Pager</code>)Pager<code>eState</code><code>eLock</code>Pager7(<code>Pager.eState</code>)7</p>\n<ol>\n<li><p><strong>PAGER_OPEN</strong>:<code>Pager</code>pager<code>Pager</code></p>\n</li>\n<li><p><strong>PAGER_READER</strong>:pager()</p>\n</li>\n<li><p><strong>PAGER_WRITER_LOCKED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_CACHEMOD</strong>:<code>Pager</code>pagerTreeTree</p>\n</li>\n<li><p><strong>PAGER_WRITER_DBMOD</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_FINISHED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_ERROR</strong>:I&#x2F;O</p>\n</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png\"></p>\n<p><code>eLock</code><code>Pager</code>4</p>\n<ol>\n<li><p><strong>NO_LOCK</strong>:</p>\n</li>\n<li><p><strong>SHARED_LOCK</strong>:Pager<code>Pager</code></p>\n</li>\n<li><p><strong>RESERVED_LOCK</strong>:pagerpagerPager</p>\n</li>\n<li><p><strong>EXCLUSIVE_LOCK</strong>:pagerpagerpager</p>\n</li>\n</ol>\n<p>NO_LOCKTree<code>sqlite3PagerGet</code>pagerSHARED_LOCKTree<code>sqlite3PagerUnref</code>pagerNO_LOCK()Tree<code>sqlite3PagerWrite</code>pagerRESERVED_LOCK(<code>sqlite3PagerWrite</code>pager)pagerEXCLUSIVE_LOCK<code>sqlite3PagerRollback</code><code>sqlite3PagerCommitPhasTwo</code>pagerNO_LOCK</p>\n<ul>\n<li><code>Pager.eLock</code>EXCLUSICE_LOCK</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache</code>pager<code>PCache</code>(pager)<code>PCache</code>SQLite(pcache1.c)<code>PCache</code>pCache,</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png\"></p>\n<p>SQLitepager<code>PCache.nMax</code>attach2000500</p>\n<p>SQLite<code>PgHdr</code>pagerSQLite<code>PCache1</code><code>PgHdr1</code>pager<code>PgHdr1</code><code>PCache1.szSize</code><code>PgHdr</code>Tree(:pager)pager0<code>PCache1.aphash</code><code>PCache1.nHash</code>(bucket)</p>\n<p><code>PgHdr</code>pagerTree<code>pgno</code><code>needSync</code>flush<code>dirty</code><code>nRef</code><code>nRef</code>0<code>pDirtyNext</code><code>pDirtyPrev</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png\"></p>\n<p><strong></strong>:SQLite<code>PCache1</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache1.apHash</code>(Tree)<code>sqlite3PagerGet</code>P</p>\n<ol>\n<li><p></p>\n<ul>\n<li>P<code>apHash</code>:<code>apHash</code></li>\n<li><code>apHash</code></li>\n<li><code>pNext</code>P(<code>PgHdr.nRef</code>+1)</li>\n</ul>\n</li>\n<li><p>P(<code>PCache.nMax</code>)</p>\n</li>\n<li><p>P()</p>\n</li>\n<li><p>(WAL)</p>\n</li>\n<li><p>(a)PP(<code>PgHdr.nRef</code>1)(b)P00(<code>PgHdr.nRef</code>1)</p>\n</li>\n</ol>\n<p>SQLite()</p>\n<p>(Tree)pagerSQLite:()SQLite3.7.810</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3PagerWrite</code></p>\n<p><code>sqlite3PagerWrite</code>pager<code>PgHdr.needSync</code>pager(SQLiteSQL:<code>needSync</code>)<code>sqlite3PagerWrite</code><code>PgHdr.dirty</code>pagerpagerpager</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:</p>\n<ol>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<p>()265</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>PSQLite(LRU)</p>\n<h3 id=\"LRU\"><a href=\"#LRU\" class=\"headerlink\" title=\"LRU\"></a>LRU</h3><p>LRU()</p>\n<h3 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h3><p>SQLitepager()LRUSQLiteSQLite</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLitePagerACIDSQLitepager</p>\n<p>DBMSSQLite:1. 2.pager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)<code>sqlite3PagerGet</code>:pagerSQLITE_BUSY</p>\n<p>0Tree</p>\n<p>pager()pager<code>sqlite3PagerGet</code></p>\n<p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)(<code>sqlite3PagerGet</code>)<code>sqlite3PagerWrite</code>pagerpager<code>sqlite3PagerWrite</code>pagerpagerpagerSQLITE_BUSY</p>\n<p>pager()pager(-journal)()</p>\n<p>pagerlog</p>\n<p><strong></strong>:SQLitelog</p>\n<p><strong>log</strong>:<code>sqlite3PagerWrite</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>pager(Tree)pager():1.2.pagerpagerSQLiteWALpager:</p>\n<ol>\n<li><p>()pagerflush<code>fsync</code>pager(<code>nRec</code>)(<code>nRec</code>0-1)pager<code>nRec</code><code>fsync</code><code>nRec</code>pagerSQLite</p>\n</li>\n<li><p>(pagerSQLITE_BUSY)</p>\n</li>\n<li><p>()()</p>\n</li>\n</ol>\n<p>pager</p>\n<p><strong></strong>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>:Tree<code>sqlite3PagerCommitPhaseOne</code><code>sqlite3PagerCommitPhaseTwo</code>pagerNO_LOCK()pager:</p>\n<ol>\n<li><p>(<code>sqlite3PagerCommitPhaseOne</code>SQLITE_BUSY)metadata+1(<strong></strong>1-3)</p>\n</li>\n<li><p>Linuxpager<code>fsync</code></p>\n</li>\n<li><p></p>\n</li>\n<li><p>SHARED_LOCKNO_LOCK</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:VM<code>VdbeCommit</code>pager():</p>\n<ol>\n<li><p>()</p>\n</li>\n<li><p> </p>\n</li>\n<li><p>(-mj,8)flush()</p>\n</li>\n<li><p>flush(pager)</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p></p>\n</li>\n<li><p>pagerSHARED_LOCKNO_LOCKpager</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:journal_mode</p>\n<p><strong></strong>:SQLiteVM</p>\n<p><strong></strong>:COMMITSQLiteSQLITE_BUSYSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><strong></strong>:</p>\n<p><strong></strong>::(<code>etilqs_</code>pager<code>sqlite3PagerWrite</code></p>\n<ol>\n<li><p>pager(log)</p>\n</li>\n<li><p>pager(logpager)</p>\n</li>\n</ol>\n<p>pagerflush</p>\n<p><strong></strong>:pager()</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLite:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>release sp</code>SQLite<code>PagerSavepoint</code><code>sp</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()(),4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLitepagerpagerpager</p>\n<p>pagerpagerpagerflush</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>roll to sp</code>SQLite<code>sp</code><code>PagerSavepoint</code><code>iOffset</code><code>iHdrOffset</code><code>iSubRec</code>iOffset<code>iSubRec</code><code>iHdrOffset</code>:(1)<code>iOffset</code><code>iHdrOffset</code>(2)pager<code>Pager.dbSize</code>(PagerSavepoint.nOrig)SQLite<code>sp</code><code>PagerSavepoint</code><code>sp</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>::(1)(0)(2)</p>\n<p><strong></strong>:SQLite</p>\n<p>pager</p>\n<ol>\n<li><p>(SQLITE_BUSY)</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pagerpager) pagerSQLITE_BUSY</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pager<code>sqlite3PagerGet</code>)</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:pagerpager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DBMSDBMSSQLite:SQLite</p>\n<p>:pagerSQLITE_FULLSQLite</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLitePagerBTreeACID</p>\n</blockquote>","more":"<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>SQLite;SQLitepage cache()</p>\n<p>pageSQLitePagerPagerTreePagerTree</p>\n<p>SQLite()PagerPager(SQLite)Tree</p>\n<p>SQLitePagerI&#x2F;O APIPager(file change counter)</p>\n<p>PagerTreePager</p>\n<p>pagerDBMS:ACID</p>\n<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>PagerTreePagerTree</p>\n<h2 id=\"Pager-client\"><a href=\"#Pager-client\" class=\"headerlink\" title=\"Pager-client\"></a>Pager-client</h2><p>PagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager</p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>Pager<code>Pager</code><code>Pager</code><code>Pager</code>(Pager)TreePagerPager<code>Pager</code>(<code>Pager</code>)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png\"></p>\n<p><code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png\"></p>\n<p>SQlite(insert,delete,update)savepointaSavepointSQLitesavepoint<code>iHdrOffset</code>0savepoint<code>iHdrOffset</code><code>PagerSavepoint</code>,<code>iOffset</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png\"></p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>PagerTree<code>sqlite3Pager</code>SQLite</p>\n<ol>\n<li><p>sqlite3PagerOpen:<code>Pager</code><code>Pager</code>&#x2F;()</p>\n</li>\n<li><p>sqlite3PagerClose:<code>Pager</code>pager</p>\n</li>\n<li><p>sqlite3PagerGet:(244)()()pager0.()</p>\n</li>\n<li><p>sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite</p>\n</li>\n<li><p>sqlite3PagerLookup:NULL</p>\n</li>\n<li><p>sqlite3PagerRef:+1</p>\n</li>\n<li><p>sqlite3PagerUnref:-10(<code>Pager</code></p>\n</li>\n<li><p>sqlite3PagerBegin:()<code>sqlite3PagerWrite</code>Tree</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseOne::+1()</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseTwo:()</p>\n</li>\n<li><p>sqlite3PagerRollback::</p>\n</li>\n<li><p>sqlite3PagerOpenSavepoint:</p>\n</li>\n<li><p>sqlite3PagerSavepoint:</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()SQLite<code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>(<code>Pager</code>)Pager<code>eState</code><code>eLock</code>Pager7(<code>Pager.eState</code>)7</p>\n<ol>\n<li><p><strong>PAGER_OPEN</strong>:<code>Pager</code>pager<code>Pager</code></p>\n</li>\n<li><p><strong>PAGER_READER</strong>:pager()</p>\n</li>\n<li><p><strong>PAGER_WRITER_LOCKED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_CACHEMOD</strong>:<code>Pager</code>pagerTreeTree</p>\n</li>\n<li><p><strong>PAGER_WRITER_DBMOD</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_FINISHED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_ERROR</strong>:I&#x2F;O</p>\n</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png\"></p>\n<p><code>eLock</code><code>Pager</code>4</p>\n<ol>\n<li><p><strong>NO_LOCK</strong>:</p>\n</li>\n<li><p><strong>SHARED_LOCK</strong>:Pager<code>Pager</code></p>\n</li>\n<li><p><strong>RESERVED_LOCK</strong>:pagerpagerPager</p>\n</li>\n<li><p><strong>EXCLUSIVE_LOCK</strong>:pagerpagerpager</p>\n</li>\n</ol>\n<p>NO_LOCKTree<code>sqlite3PagerGet</code>pagerSHARED_LOCKTree<code>sqlite3PagerUnref</code>pagerNO_LOCK()Tree<code>sqlite3PagerWrite</code>pagerRESERVED_LOCK(<code>sqlite3PagerWrite</code>pager)pagerEXCLUSIVE_LOCK<code>sqlite3PagerRollback</code><code>sqlite3PagerCommitPhasTwo</code>pagerNO_LOCK</p>\n<ul>\n<li><code>Pager.eLock</code>EXCLUSICE_LOCK</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache</code>pager<code>PCache</code>(pager)<code>PCache</code>SQLite(pcache1.c)<code>PCache</code>pCache,</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png\"></p>\n<p>SQLitepager<code>PCache.nMax</code>attach2000500</p>\n<p>SQLite<code>PgHdr</code>pagerSQLite<code>PCache1</code><code>PgHdr1</code>pager<code>PgHdr1</code><code>PCache1.szSize</code><code>PgHdr</code>Tree(:pager)pager0<code>PCache1.aphash</code><code>PCache1.nHash</code>(bucket)</p>\n<p><code>PgHdr</code>pagerTree<code>pgno</code><code>needSync</code>flush<code>dirty</code><code>nRef</code><code>nRef</code>0<code>pDirtyNext</code><code>pDirtyPrev</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png\"></p>\n<p><strong></strong>:SQLite<code>PCache1</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache1.apHash</code>(Tree)<code>sqlite3PagerGet</code>P</p>\n<ol>\n<li><p></p>\n<ul>\n<li>P<code>apHash</code>:<code>apHash</code></li>\n<li><code>apHash</code></li>\n<li><code>pNext</code>P(<code>PgHdr.nRef</code>+1)</li>\n</ul>\n</li>\n<li><p>P(<code>PCache.nMax</code>)</p>\n</li>\n<li><p>P()</p>\n</li>\n<li><p>(WAL)</p>\n</li>\n<li><p>(a)PP(<code>PgHdr.nRef</code>1)(b)P00(<code>PgHdr.nRef</code>1)</p>\n</li>\n</ol>\n<p>SQLite()</p>\n<p>(Tree)pagerSQLite:()SQLite3.7.810</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3PagerWrite</code></p>\n<p><code>sqlite3PagerWrite</code>pager<code>PgHdr.needSync</code>pager(SQLiteSQL:<code>needSync</code>)<code>sqlite3PagerWrite</code><code>PgHdr.dirty</code>pagerpagerpager</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:</p>\n<ol>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<p>()265</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>PSQLite(LRU)</p>\n<h3 id=\"LRU\"><a href=\"#LRU\" class=\"headerlink\" title=\"LRU\"></a>LRU</h3><p>LRU()</p>\n<h3 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h3><p>SQLitepager()LRUSQLiteSQLite</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLitePagerACIDSQLitepager</p>\n<p>DBMSSQLite:1. 2.pager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)<code>sqlite3PagerGet</code>:pagerSQLITE_BUSY</p>\n<p>0Tree</p>\n<p>pager()pager<code>sqlite3PagerGet</code></p>\n<p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)(<code>sqlite3PagerGet</code>)<code>sqlite3PagerWrite</code>pagerpager<code>sqlite3PagerWrite</code>pagerpagerpagerSQLITE_BUSY</p>\n<p>pager()pager(-journal)()</p>\n<p>pagerlog</p>\n<p><strong></strong>:SQLitelog</p>\n<p><strong>log</strong>:<code>sqlite3PagerWrite</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>pager(Tree)pager():1.2.pagerpagerSQLiteWALpager:</p>\n<ol>\n<li><p>()pagerflush<code>fsync</code>pager(<code>nRec</code>)(<code>nRec</code>0-1)pager<code>nRec</code><code>fsync</code><code>nRec</code>pagerSQLite</p>\n</li>\n<li><p>(pagerSQLITE_BUSY)</p>\n</li>\n<li><p>()()</p>\n</li>\n</ol>\n<p>pager</p>\n<p><strong></strong>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>:Tree<code>sqlite3PagerCommitPhaseOne</code><code>sqlite3PagerCommitPhaseTwo</code>pagerNO_LOCK()pager:</p>\n<ol>\n<li><p>(<code>sqlite3PagerCommitPhaseOne</code>SQLITE_BUSY)metadata+1(<strong></strong>1-3)</p>\n</li>\n<li><p>Linuxpager<code>fsync</code></p>\n</li>\n<li><p></p>\n</li>\n<li><p>SHARED_LOCKNO_LOCK</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:VM<code>VdbeCommit</code>pager():</p>\n<ol>\n<li><p>()</p>\n</li>\n<li><p> </p>\n</li>\n<li><p>(-mj,8)flush()</p>\n</li>\n<li><p>flush(pager)</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p></p>\n</li>\n<li><p>pagerSHARED_LOCKNO_LOCKpager</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:journal_mode</p>\n<p><strong></strong>:SQLiteVM</p>\n<p><strong></strong>:COMMITSQLiteSQLITE_BUSYSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><strong></strong>:</p>\n<p><strong></strong>::(<code>etilqs_</code>pager<code>sqlite3PagerWrite</code></p>\n<ol>\n<li><p>pager(log)</p>\n</li>\n<li><p>pager(logpager)</p>\n</li>\n</ol>\n<p>pagerflush</p>\n<p><strong></strong>:pager()</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLite:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>release sp</code>SQLite<code>PagerSavepoint</code><code>sp</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()(),4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLitepagerpagerpager</p>\n<p>pagerpagerpagerflush</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>roll to sp</code>SQLite<code>sp</code><code>PagerSavepoint</code><code>iOffset</code><code>iHdrOffset</code><code>iSubRec</code>iOffset<code>iSubRec</code><code>iHdrOffset</code>:(1)<code>iOffset</code><code>iHdrOffset</code>(2)pager<code>Pager.dbSize</code>(PagerSavepoint.nOrig)SQLite<code>sp</code><code>PagerSavepoint</code><code>sp</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>::(1)(0)(2)</p>\n<p><strong></strong>:SQLite</p>\n<p>pager</p>\n<ol>\n<li><p>(SQLITE_BUSY)</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pagerpager) pagerSQLITE_BUSY</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pager<code>sqlite3PagerGet</code>)</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:pagerpager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DBMSDBMSSQLite:SQLite</p>\n<p>:pagerSQLITE_FULLSQLite</p>"},{"title":"oc block","date":"2019-12-20T16:00:00.000Z","_content":"\n## Block\n\nOC `clang --rewrite-objc code.m` clang  c  c++ ocblock@autoreleasepool[@synchronized](https://caio.ink/article-for-synchronized/)\n\n<!-- more -->\n\n## \n\n1. BlockCStructCStruct\n```c\ntypedef int (^blk_t) (int)\nblk_t blk = ^(int count){return count;};\nblk_t *blkptr = &blk;\n(*blkptr)(10);\n```\n2. Block C\n```c\n//const char text[] = hello;\nconst char *text = hello;\nvoid (^blk)(void) = ^{\n\ttext[0];\n};\n```\n\n## &\nBlock\n\n### \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png)\n\nBlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl\n\n### \n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png)\n\nBlockBlockBlockvoid *FuncPtr\n\n**C**\n```c\n//C\n//C\nvoid funcA(char a[20]){\n    char b[20] = a;\n}\n```\n\n###  &&  && \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png)\n\n\n\nBlockBlock\n\n### ()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png)\n\nBlockcopydesc0__main_block_copy_0OC\n\nBlockreleasedesc0__main_block_dispose_0OC\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png)\n\n i __Block_byref_val_0block_imp\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png)\n\n`__Block_byref` Copydispose\n\n`__Block_byref` BlockCopy`__Block_byref`copydispose\n\n:ARCbyrefretainMRC\n\n## QA.\n###  __block\n\n`__block`\n\n### forwarding\n\nObjective-C iOSOS X\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png)\n\n__block__block`__Block_byref_id_object_copy_131``__forwarding`\n\n**BlockCopyCopy `__Block_byref`, __forwarding **\n\n### Block\n\n1.  ARC `__NSStackBlock__`blockblockcopy\n2. Block`__NSGlobalBlock__` \n3. GCDblockCocoaUsingBlockcopy\n4. `__NSStackBlock__`copy`__NSMallocBlock__`\n5. `__NSMallocBlock__`copy\n6. `__NSGlobalBlock__`copy\n\n### BlockObjc\n\n1. block oc objc_objectobjc_objectisaclassBlock `__NSMallocBlock__``__NSMallocBlock__``__NSMallocBlock__`classclassruntimeclass\n2. block  object\n","source":"_posts/5.OC-Block-imp.md","raw":"---\ntitle: oc block\ndate: 2019-12-21\ntags: [object-c]\ncategories: \n---\n\n## Block\n\nOC `clang --rewrite-objc code.m` clang  c  c++ ocblock@autoreleasepool[@synchronized](https://caio.ink/article-for-synchronized/)\n\n<!-- more -->\n\n## \n\n1. BlockCStructCStruct\n```c\ntypedef int (^blk_t) (int)\nblk_t blk = ^(int count){return count;};\nblk_t *blkptr = &blk;\n(*blkptr)(10);\n```\n2. Block C\n```c\n//const char text[] = hello;\nconst char *text = hello;\nvoid (^blk)(void) = ^{\n\ttext[0];\n};\n```\n\n## &\nBlock\n\n### \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png)\n\nBlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl\n\n### \n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png)\n\nBlockBlockBlockvoid *FuncPtr\n\n**C**\n```c\n//C\n//C\nvoid funcA(char a[20]){\n    char b[20] = a;\n}\n```\n\n###  &&  && \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png)\n\n\n\nBlockBlock\n\n### ()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png)\n\nBlockcopydesc0__main_block_copy_0OC\n\nBlockreleasedesc0__main_block_dispose_0OC\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png)\n\n i __Block_byref_val_0block_imp\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png)\n\n`__Block_byref` Copydispose\n\n`__Block_byref` BlockCopy`__Block_byref`copydispose\n\n:ARCbyrefretainMRC\n\n## QA.\n###  __block\n\n`__block`\n\n### forwarding\n\nObjective-C iOSOS X\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png)\n\n__block__block`__Block_byref_id_object_copy_131``__forwarding`\n\n**BlockCopyCopy `__Block_byref`, __forwarding **\n\n### Block\n\n1.  ARC `__NSStackBlock__`blockblockcopy\n2. Block`__NSGlobalBlock__` \n3. GCDblockCocoaUsingBlockcopy\n4. `__NSStackBlock__`copy`__NSMallocBlock__`\n5. `__NSMallocBlock__`copy\n6. `__NSGlobalBlock__`copy\n\n### BlockObjc\n\n1. block oc objc_objectobjc_objectisaclassBlock `__NSMallocBlock__``__NSMallocBlock__``__NSMallocBlock__`classclassruntimeclass\n2. block  object\n","slug":"5.OC-Block-imp","published":1,"updated":"2020-08-29T14:42:58.502Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61l001helc908uzdapz","content":"<h2 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ ocblock@autoreleasepool<a href=\"https://caio.ink/article-for-synchronized/\">@synchronized</a></p>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>BlockCStructCStruct<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"title function_\">int</span> <span class=\"params\">(^<span class=\"type\">blk_t</span>)</span> <span class=\"params\">(<span class=\"type\">int</span>)</span></span><br><span class=\"line\"><span class=\"type\">blk_t</span> blk = ^(<span class=\"type\">int</span> count)&#123;<span class=\"keyword\">return</span> count;&#125;;</span><br><span class=\"line\"><span class=\"type\">blk_t</span> *blkptr = &amp;blk;</span><br><span class=\"line\">(*blkptr)(<span class=\"number\">10</span>);</span><br></pre></td></tr></table></figure></li>\n<li>Block C<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//const char text[] = hello;</span></span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> *text = hello;</span><br><span class=\"line\"><span class=\"type\">void</span> (^blk)(<span class=\"type\">void</span>) = ^&#123;</span><br><span class=\"line\">\ttext[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"-amp-\"><a href=\"#-amp-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Block</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png\"></p>\n<p>BlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png\"></p>\n<p>BlockBlockBlockvoid *FuncPtr</p>\n<p><strong>C</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">funcA</span><span class=\"params\">(<span class=\"type\">char</span> a[<span class=\"number\">20</span>])</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> b[<span class=\"number\">20</span>] = a;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"-amp-amp--amp-amp-\"><a href=\"#-amp-amp--amp-amp-\" class=\"headerlink\" title=\" &amp;&amp;  &amp;&amp; \"></a> &amp;&amp;  &amp;&amp; </h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png\"></p>\n<p></p>\n<p>BlockBlock</p>\n<h3 id=\"--\"><a href=\"#--\" class=\"headerlink\" title=\"()\"></a>()</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png\"></p>\n<p>Blockcopydesc0__main_block_copy_0OC</p>\n<p>Blockreleasedesc0__main_block_dispose_0OC</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png\"></p>\n<p> i __Block_byref_val_0block_imp</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png\"></p>\n<p><code>__Block_byref</code> Copydispose</p>\n<p><code>__Block_byref</code> BlockCopy<code>__Block_byref</code>copydispose</p>\n<p>:ARCbyrefretainMRC</p>\n<h2 id=\"QA\"><a href=\"#QA\" class=\"headerlink\" title=\"QA.\"></a>QA.</h2><h3 id=\"block\"><a href=\"#block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><code>__block</code></p>\n<h3 id=\"forwarding\"><a href=\"#forwarding\" class=\"headerlink\" title=\"forwarding\"></a>forwarding</h3><p>Objective-C iOSOS X<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png\"></p>\n<p>__block__block<code>__Block_byref_id_object_copy_131</code><code>__forwarding</code></p>\n<p><strong>BlockCopyCopy <code>__Block_byref</code>, __forwarding </strong></p>\n<h3 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h3><ol>\n<li> ARC <code>__NSStackBlock__</code>blockblockcopy</li>\n<li>Block<code>__NSGlobalBlock__</code> </li>\n<li>GCDblockCocoaUsingBlockcopy</li>\n<li><code>__NSStackBlock__</code>copy<code>__NSMallocBlock__</code></li>\n<li><code>__NSMallocBlock__</code>copy</li>\n<li><code>__NSGlobalBlock__</code>copy</li>\n</ol>\n<h3 id=\"BlockObjc\"><a href=\"#BlockObjc\" class=\"headerlink\" title=\"BlockObjc\"></a>BlockObjc</h3><ol>\n<li>block oc objc_objectobjc_objectisaclassBlock <code>__NSMallocBlock__</code><code>__NSMallocBlock__</code><code>__NSMallocBlock__</code>classclassruntimeclass</li>\n<li>block  object</li>\n</ol>\n","site":{"data":{}},"excerpt":"<h2 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ ocblock@autoreleasepool<a href=\"https://caio.ink/article-for-synchronized/\">@synchronized</a></p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>BlockCStructCStruct<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"title function_\">int</span> <span class=\"params\">(^<span class=\"type\">blk_t</span>)</span> <span class=\"params\">(<span class=\"type\">int</span>)</span></span><br><span class=\"line\"><span class=\"type\">blk_t</span> blk = ^(<span class=\"type\">int</span> count)&#123;<span class=\"keyword\">return</span> count;&#125;;</span><br><span class=\"line\"><span class=\"type\">blk_t</span> *blkptr = &amp;blk;</span><br><span class=\"line\">(*blkptr)(<span class=\"number\">10</span>);</span><br></pre></td></tr></table></figure></li>\n<li>Block C<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//const char text[] = hello;</span></span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> *text = hello;</span><br><span class=\"line\"><span class=\"type\">void</span> (^blk)(<span class=\"type\">void</span>) = ^&#123;</span><br><span class=\"line\">\ttext[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"-amp-\"><a href=\"#-amp-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Block</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png\"></p>\n<p>BlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png\"></p>\n<p>BlockBlockBlockvoid *FuncPtr</p>\n<p><strong>C</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">funcA</span><span class=\"params\">(<span class=\"type\">char</span> a[<span class=\"number\">20</span>])</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> b[<span class=\"number\">20</span>] = a;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"-amp-amp--amp-amp-\"><a href=\"#-amp-amp--amp-amp-\" class=\"headerlink\" title=\" &amp;&amp;  &amp;&amp; \"></a> &amp;&amp;  &amp;&amp; </h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png\"></p>\n<p></p>\n<p>BlockBlock</p>\n<h3 id=\"--\"><a href=\"#--\" class=\"headerlink\" title=\"()\"></a>()</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png\"></p>\n<p>Blockcopydesc0__main_block_copy_0OC</p>\n<p>Blockreleasedesc0__main_block_dispose_0OC</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png\"></p>\n<p> i __Block_byref_val_0block_imp</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png\"></p>\n<p><code>__Block_byref</code> Copydispose</p>\n<p><code>__Block_byref</code> BlockCopy<code>__Block_byref</code>copydispose</p>\n<p>:ARCbyrefretainMRC</p>\n<h2 id=\"QA\"><a href=\"#QA\" class=\"headerlink\" title=\"QA.\"></a>QA.</h2><h3 id=\"block\"><a href=\"#block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><code>__block</code></p>\n<h3 id=\"forwarding\"><a href=\"#forwarding\" class=\"headerlink\" title=\"forwarding\"></a>forwarding</h3><p>Objective-C iOSOS X<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png\"></p>\n<p>__block__block<code>__Block_byref_id_object_copy_131</code><code>__forwarding</code></p>\n<p><strong>BlockCopyCopy <code>__Block_byref</code>, __forwarding </strong></p>\n<h3 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h3><ol>\n<li> ARC <code>__NSStackBlock__</code>blockblockcopy</li>\n<li>Block<code>__NSGlobalBlock__</code> </li>\n<li>GCDblockCocoaUsingBlockcopy</li>\n<li><code>__NSStackBlock__</code>copy<code>__NSMallocBlock__</code></li>\n<li><code>__NSMallocBlock__</code>copy</li>\n<li><code>__NSGlobalBlock__</code>copy</li>\n</ol>\n<h3 id=\"BlockObjc\"><a href=\"#BlockObjc\" class=\"headerlink\" title=\"BlockObjc\"></a>BlockObjc</h3><ol>\n<li>block oc objc_objectobjc_objectisaclassBlock <code>__NSMallocBlock__</code><code>__NSMallocBlock__</code><code>__NSMallocBlock__</code>classclassruntimeclass</li>\n<li>block  object</li>\n</ol>"},{"title":"oc@synchronized","date":"2019-12-19T16:00:00.000Z","_content":"\n## @synchronized\n\nOC `clang --rewrite-objc code.m` clang  c  c++ [ocblock](https://caio.ink/oc-block-imp/)@autoreleasepool@synchronized\n\n<!-- more -->\n\n:\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = [NSObject new];\n    @synchronized (o) {\n        NSLog(@\"helloworld\");\n    }\n}\n```\n\nclang :\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = ((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(\"NSObject\"), sel_registerName(\"new\"));\n    {\n        id _rethrow = 0;\n        id _sync_obj = (id)o;\n\t\t\n        objc_sync_enter(_sync_obj);\n\t\t\n        try {\n            struct _SYNC_EXIT {\n                _SYNC_EXIT(id arg) : sync_exit(arg) {}\n                ~_SYNC_EXIT()\n                {\n                    objc_sync_exit(sync_exit);\n                }\n                id sync_exit;\n            } _sync_exit(_sync_obj);\n\n            NSLog((NSString *)&__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);\n        } catch (id e) {\n            _rethrow = e;\n        }\n\t\t\n        {\n            struct _FIN {\n                _FIN(id reth) : rethrow(reth) {}\n                ~_FIN() {\n                    if (rethrow)\n                        objc_exception_throw(rethrow);\n                }\n                id rethrow;\n            } _fin_force_rethow(_rethrow);\n        }\n    }\n}\n```\n\n\n1. `@synchronized` try\n2. try `objc_sync_enter(_sync_obj)` \n3. tryC++C++\"\"C++\n4. tryC++`objc_sync_exit(sync_exit)`\"\"\n5. `@synchronized` catch\n\n> ``OC\n\n\n1. objc_sync_enter(obj); \n2. objc_sync_exit(obj); \n\n### objc_sync_enter  objc_sync_exit\n\n`libobjc.A.dylib`(Runtime) objc-sync.h/.m  \n\n```c\nint objc_sync_enter(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n\n    if (obj) {\n        SyncData* data = id2data(obj, ACQUIRE);\n        data->mutex.lock();\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\n    return result;\n}\n\nint objc_sync_exit(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n    \n    if (obj) {\n        SyncData* data = id2data(obj, RELEASE); \n        if (!data) {\n            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n        } else {\n            bool okay = data->mutex.tryUnlock();\n            if (!okay) {\n                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n            }\n        }\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\t\n    return result;\n}\n```\n\n`id2data`, obj  `SyncData`, mutex `@synchronized`ocmutex\n\n## id2data\n\n\n#### SyncData\n```c\ntypedef struct alignas(CacheLineSize) SyncData {\n    struct SyncData* nextData;\n    DisguisedPtr<objc_object> object;\n    int32_t threadCount;  // number of THREADS using this block\n    recursive_mutex_t mutex;\n} SyncData;\n```\n1. SyncData\"\"\n2. SyncDatanextData\n3. object\"\"\n4. threadCount\n5. mutex (os_unfair_recursive_lock),\n\n#### SyncCache\n```c\ntypedef struct SyncCache {\n    unsigned int allocated;\n    unsigned int used;\n    SyncCacheItem list[0];\n} SyncCache;\n```\n1. SyncCache TLS()`SyncData`TLS\n2. list`SyncCacheItem`,`SyncCacheItem``SyncData`lockCountlockCount@synchronized\n3. allocatedcacheused4size\n\n\nid2dataid()SyncData,...syncData.mutex.lock()\n\n**SyncData**\n\n\n1. `TLS`:****`TLS``SyncData``TLS`fast cache\n2. `SyncCache`:`TLS``SyncCache``SyncCache``SyncData`\n3.  12`static StripedMap<SyncList> sDataLists``sDataList`Mapkeyvalue`SyncList`\n\n aDataLists\n- StripedMapkey(id)mapsize64iPhone8`SyncData``SyncList``SyncList``spinlock_t`,\n- StripedMapSyncList`SyncData`(threadCount==0)\n\n\n`id2data`\n1.  `SYNC_DATA_DIRECT_KEY``SYNC_COUNT_DIRECT_KEY`keyTLS`SyncData`,TLS`SyncData`\n2. TLS`SyncCache``SyncData``SyncCacheItem`lockCount`SyncData`\n3. 12`SyncData``sDataLists``SyncList``SyncList``SyncData`\n4. 3`SyncData``SyncList`\n5. `TLS``SYNC_DATA_DIRECT_KEY`****`SyncCache`\n\n:\n12lockCount0SyncData`SyncData`threadCount,3`SyncData`\n\n### @synchronized\n\n@synchronized\n\n@synchronized\n\n\n1. `id2data``TLS`,`SyncCache`,`sDataLists`\n2. `SyncData`\n\n\n\n****\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n}\n```\n pthread_mutex  synchronized  \npthread_mutex:200ms\nsynchronized:6800ms\n\n...em......\n\n`..TLS....TLS`,`TLS`\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t@synchronized(t){\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n\t}\n}\n```\npthread_mutex:200ms\nsynchronized:2700ms\n\n......\n\nRuntime\n\n----\n:\n\n`synchronized`objc-sync.mm `objc_sync_enter`  `objc_sync_exit`\n\nsynchronized1000ms+\n\nobjc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png)\n\nsynchronized\n\nmrc\n\n 40ms+objc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png)\n\n1000ms+mrc\n\n#### \n\n `objc_sync_enter`  `objc_sync_exit`\n\n 900ms+\n\n#### \n\n`SyncData``os_unfair_recursive_lock`\n\n OSPinLock OSPinLockCPUGCD[](https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/)\n\n`os_unfair_lock`\n![](https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png)\n\n\n```c\ntypedef struct os_unfair_recursive_lock_s {\n    os_unfair_lock ourl_lock;\n    uint32_t ourl_count;\n} os_unfair_recursive_lock;\n```\n``` c\n        os_unfair_recursive_lock lock = ((os_unfair_recursive_lock){OS_UNFAIR_LOCK_INIT, 0});\n        os_unfair_recursive_lock *mlock = &lock;\n        for (int index = 0; index < 10000000; index++) {\n            os_unfair_recursive_lock_lock_with_options(&lock, 0x00000000);\n                count ++;\n            os_unfair_recursive_lock_tryunlock4objc(&lock);\n        }\n```\n\n200ms`os_unfair_lock``pthread_mutex`10%\n\n 1000ms+900ms+200ms = 2100ms\n\n500ms500ms\n\nobjc-os.hLOCKDEBUGdebug2900ms -> 2100ms\n\n> :\n1.synchronized os_unfair_lock pthread_mutex\n2.synchronizedTLSCache","source":"_posts/4.synchronized.md","raw":"---\ntitle: oc@synchronized\ndate: 2019-12-20\ntags: [object-c,]\ncategories: \n---\n\n## @synchronized\n\nOC `clang --rewrite-objc code.m` clang  c  c++ [ocblock](https://caio.ink/oc-block-imp/)@autoreleasepool@synchronized\n\n<!-- more -->\n\n:\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = [NSObject new];\n    @synchronized (o) {\n        NSLog(@\"helloworld\");\n    }\n}\n```\n\nclang :\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = ((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(\"NSObject\"), sel_registerName(\"new\"));\n    {\n        id _rethrow = 0;\n        id _sync_obj = (id)o;\n\t\t\n        objc_sync_enter(_sync_obj);\n\t\t\n        try {\n            struct _SYNC_EXIT {\n                _SYNC_EXIT(id arg) : sync_exit(arg) {}\n                ~_SYNC_EXIT()\n                {\n                    objc_sync_exit(sync_exit);\n                }\n                id sync_exit;\n            } _sync_exit(_sync_obj);\n\n            NSLog((NSString *)&__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);\n        } catch (id e) {\n            _rethrow = e;\n        }\n\t\t\n        {\n            struct _FIN {\n                _FIN(id reth) : rethrow(reth) {}\n                ~_FIN() {\n                    if (rethrow)\n                        objc_exception_throw(rethrow);\n                }\n                id rethrow;\n            } _fin_force_rethow(_rethrow);\n        }\n    }\n}\n```\n\n\n1. `@synchronized` try\n2. try `objc_sync_enter(_sync_obj)` \n3. tryC++C++\"\"C++\n4. tryC++`objc_sync_exit(sync_exit)`\"\"\n5. `@synchronized` catch\n\n> ``OC\n\n\n1. objc_sync_enter(obj); \n2. objc_sync_exit(obj); \n\n### objc_sync_enter  objc_sync_exit\n\n`libobjc.A.dylib`(Runtime) objc-sync.h/.m  \n\n```c\nint objc_sync_enter(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n\n    if (obj) {\n        SyncData* data = id2data(obj, ACQUIRE);\n        data->mutex.lock();\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\n    return result;\n}\n\nint objc_sync_exit(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n    \n    if (obj) {\n        SyncData* data = id2data(obj, RELEASE); \n        if (!data) {\n            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n        } else {\n            bool okay = data->mutex.tryUnlock();\n            if (!okay) {\n                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n            }\n        }\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\t\n    return result;\n}\n```\n\n`id2data`, obj  `SyncData`, mutex `@synchronized`ocmutex\n\n## id2data\n\n\n#### SyncData\n```c\ntypedef struct alignas(CacheLineSize) SyncData {\n    struct SyncData* nextData;\n    DisguisedPtr<objc_object> object;\n    int32_t threadCount;  // number of THREADS using this block\n    recursive_mutex_t mutex;\n} SyncData;\n```\n1. SyncData\"\"\n2. SyncDatanextData\n3. object\"\"\n4. threadCount\n5. mutex (os_unfair_recursive_lock),\n\n#### SyncCache\n```c\ntypedef struct SyncCache {\n    unsigned int allocated;\n    unsigned int used;\n    SyncCacheItem list[0];\n} SyncCache;\n```\n1. SyncCache TLS()`SyncData`TLS\n2. list`SyncCacheItem`,`SyncCacheItem``SyncData`lockCountlockCount@synchronized\n3. allocatedcacheused4size\n\n\nid2dataid()SyncData,...syncData.mutex.lock()\n\n**SyncData**\n\n\n1. `TLS`:****`TLS``SyncData``TLS`fast cache\n2. `SyncCache`:`TLS``SyncCache``SyncCache``SyncData`\n3.  12`static StripedMap<SyncList> sDataLists``sDataList`Mapkeyvalue`SyncList`\n\n aDataLists\n- StripedMapkey(id)mapsize64iPhone8`SyncData``SyncList``SyncList``spinlock_t`,\n- StripedMapSyncList`SyncData`(threadCount==0)\n\n\n`id2data`\n1.  `SYNC_DATA_DIRECT_KEY``SYNC_COUNT_DIRECT_KEY`keyTLS`SyncData`,TLS`SyncData`\n2. TLS`SyncCache``SyncData``SyncCacheItem`lockCount`SyncData`\n3. 12`SyncData``sDataLists``SyncList``SyncList``SyncData`\n4. 3`SyncData``SyncList`\n5. `TLS``SYNC_DATA_DIRECT_KEY`****`SyncCache`\n\n:\n12lockCount0SyncData`SyncData`threadCount,3`SyncData`\n\n### @synchronized\n\n@synchronized\n\n@synchronized\n\n\n1. `id2data``TLS`,`SyncCache`,`sDataLists`\n2. `SyncData`\n\n\n\n****\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n}\n```\n pthread_mutex  synchronized  \npthread_mutex:200ms\nsynchronized:6800ms\n\n...em......\n\n`..TLS....TLS`,`TLS`\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t@synchronized(t){\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n\t}\n}\n```\npthread_mutex:200ms\nsynchronized:2700ms\n\n......\n\nRuntime\n\n----\n:\n\n`synchronized`objc-sync.mm `objc_sync_enter`  `objc_sync_exit`\n\nsynchronized1000ms+\n\nobjc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png)\n\nsynchronized\n\nmrc\n\n 40ms+objc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png)\n\n1000ms+mrc\n\n#### \n\n `objc_sync_enter`  `objc_sync_exit`\n\n 900ms+\n\n#### \n\n`SyncData``os_unfair_recursive_lock`\n\n OSPinLock OSPinLockCPUGCD[](https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/)\n\n`os_unfair_lock`\n![](https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png)\n\n\n```c\ntypedef struct os_unfair_recursive_lock_s {\n    os_unfair_lock ourl_lock;\n    uint32_t ourl_count;\n} os_unfair_recursive_lock;\n```\n``` c\n        os_unfair_recursive_lock lock = ((os_unfair_recursive_lock){OS_UNFAIR_LOCK_INIT, 0});\n        os_unfair_recursive_lock *mlock = &lock;\n        for (int index = 0; index < 10000000; index++) {\n            os_unfair_recursive_lock_lock_with_options(&lock, 0x00000000);\n                count ++;\n            os_unfair_recursive_lock_tryunlock4objc(&lock);\n        }\n```\n\n200ms`os_unfair_lock``pthread_mutex`10%\n\n 1000ms+900ms+200ms = 2100ms\n\n500ms500ms\n\nobjc-os.hLOCKDEBUGdebug2900ms -> 2100ms\n\n> :\n1.synchronized os_unfair_lock pthread_mutex\n2.synchronizedTLSCache","slug":"4.synchronized","published":1,"updated":"2020-08-29T14:42:58.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61m001lelc91wgi9qer","content":"<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ <a href=\"https://caio.ink/oc-block-imp/\">ocblock</a>@autoreleasepool@synchronized</p>\n<span id=\"more\"></span>\n\n<p>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = [NSObject new];</span><br><span class=\"line\">    @synchronized (o) &#123;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;helloworld&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>clang :</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = ((NSObject *(*)(id, SEL))(<span class=\"type\">void</span> *)objc_msgSend)((id)objc_getClass(<span class=\"string\">&quot;NSObject&quot;</span>), sel_registerName(<span class=\"string\">&quot;new&quot;</span>));</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        id _rethrow = <span class=\"number\">0</span>;</span><br><span class=\"line\">        id _sync_obj = (id)o;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        objc_sync_enter(_sync_obj);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">SYNC_EXIT</span> &#123;</span></span><br><span class=\"line\">                _SYNC_EXIT(id arg) : sync_exit(arg) &#123;&#125;</span><br><span class=\"line\">                ~_SYNC_EXIT()</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    objc_sync_exit(sync_exit);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id sync_exit;</span><br><span class=\"line\">            &#125; _sync_exit(_sync_obj);</span><br><span class=\"line\"></span><br><span class=\"line\">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);</span><br><span class=\"line\">        &#125; catch (id e) &#123;</span><br><span class=\"line\">            _rethrow = e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">FIN</span> &#123;</span></span><br><span class=\"line\">                _FIN(id reth) : rethrow(reth) &#123;&#125;</span><br><span class=\"line\">                ~_FIN() &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (rethrow)</span><br><span class=\"line\">                        objc_exception_throw(rethrow);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id rethrow;</span><br><span class=\"line\">            &#125; _fin_force_rethow(_rethrow);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>@synchronized</code> try</li>\n<li>try <code>objc_sync_enter(_sync_obj)</code> </li>\n<li>tryC++C++C++</li>\n<li>tryC++<code>objc_sync_exit(sync_exit)</code></li>\n<li><code>@synchronized</code> catch</li>\n</ol>\n<blockquote>\n<p><code></code>OC</p>\n</blockquote>\n<p></p>\n<ol>\n<li>objc_sync_enter(obj); </li>\n<li>objc_sync_exit(obj); </li>\n</ol>\n<h3 id=\"objc-sync-enter--objc-sync-exit\"><a href=\"#objc-sync-enter--objc-sync-exit\" class=\"headerlink\" title=\"objc_sync_enter  objc_sync_exit\"></a>objc_sync_enter  objc_sync_exit</h3><p><code>libobjc.A.dylib</code>(Runtime) objc-sync.h&#x2F;.m  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_enter</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, ACQUIRE);</span><br><span class=\"line\">        data-&gt;mutex.lock();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_exit</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, RELEASE); </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!data) &#123;</span><br><span class=\"line\">            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">bool</span> okay = data-&gt;mutex.tryUnlock();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!okay) &#123;</span><br><span class=\"line\">                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>id2data</code>, obj  <code>SyncData</code>, mutex <code>@synchronized</code>ocmutex</p>\n<h2 id=\"id2data\"><a href=\"#id2data\" class=\"headerlink\" title=\"id2data\"></a>id2data</h2><p></p>\n<h4 id=\"SyncData\"><a href=\"#SyncData\" class=\"headerlink\" title=\"SyncData\"></a>SyncData</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> <span class=\"title function_\">alignas</span><span class=\"params\">(CacheLineSize)</span> SyncData &#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncData</span>* <span class=\"title\">nextData</span>;</span></span><br><span class=\"line\">    DisguisedPtr&lt;objc_object&gt; object;</span><br><span class=\"line\">    <span class=\"type\">int32_t</span> threadCount;  <span class=\"comment\">// number of THREADS using this block</span></span><br><span class=\"line\">    <span class=\"type\">recursive_mutex_t</span> mutex;</span><br><span class=\"line\">&#125; SyncData;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncData</li>\n<li>SyncDatanextData</li>\n<li>object</li>\n<li>threadCount</li>\n<li>mutex (os_unfair_recursive_lock),</li>\n</ol>\n<h4 id=\"SyncCache\"><a href=\"#SyncCache\" class=\"headerlink\" title=\"SyncCache\"></a>SyncCache</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncCache</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> allocated;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> used;</span><br><span class=\"line\">    SyncCacheItem <span class=\"built_in\">list</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125; SyncCache;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncCache TLS()<code>SyncData</code>TLS</li>\n<li>list<code>SyncCacheItem</code>,<code>SyncCacheItem</code><code>SyncData</code>lockCountlockCount@synchronized</li>\n<li>allocatedcacheused4size</li>\n</ol>\n<p>id2dataid()SyncData,syncData.mutex.lock()</p>\n<p><strong>SyncData</strong></p>\n<p></p>\n<ol>\n<li><code>TLS</code>:<strong></strong><code>TLS</code><code>SyncData</code><code>TLS</code>fast cache</li>\n<li><code>SyncCache</code>:<code>TLS</code><code>SyncCache</code><code>SyncCache</code><code>SyncData</code></li>\n<li> 12<code>static StripedMap&lt;SyncList&gt; sDataLists</code><code>sDataList</code>Mapkeyvalue<code>SyncList</code></li>\n</ol>\n<p> aDataLists</p>\n<ul>\n<li>StripedMapkey(id)mapsize64iPhone8<code>SyncData</code><code>SyncList</code><code>SyncList</code><code>spinlock_t</code>,</li>\n<li>StripedMapSyncList<code>SyncData</code>(threadCount&#x3D;&#x3D;0)</li>\n</ul>\n<p><code>id2data</code></p>\n<ol>\n<li> <code>SYNC_DATA_DIRECT_KEY</code><code>SYNC_COUNT_DIRECT_KEY</code>keyTLS<code>SyncData</code>,TLS<code>SyncData</code></li>\n<li>TLS<code>SyncCache</code><code>SyncData</code><code>SyncCacheItem</code>lockCount<code>SyncData</code></li>\n<li>12<code>SyncData</code><code>sDataLists</code><code>SyncList</code><code>SyncList</code><code>SyncData</code></li>\n<li>3<code>SyncData</code><code>SyncList</code></li>\n<li><code>TLS</code><code>SYNC_DATA_DIRECT_KEY</code><strong></strong><code>SyncCache</code></li>\n</ol>\n<p>:<br>12lockCount0SyncData<code>SyncData</code>threadCount,3<code>SyncData</code></p>\n<h3 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h3><p>@synchronized</p>\n<p>@synchronized</p>\n<p></p>\n<ol>\n<li><code>id2data</code><code>TLS</code>,<code>SyncCache</code>,<code>sDataLists</code></li>\n<li><code>SyncData</code></li>\n</ol>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> pthread_mutex  synchronized  <br>pthread_mutex:200ms<br>synchronized:6800ms</p>\n<p>em</p>\n<p><code>..TLS....TLS</code>,<code>TLS</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t@synchronized(t)&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>pthread_mutex:200ms<br>synchronized:2700ms</p>\n<p>......</p>\n<p>Runtime</p>\n<hr>\n<p>:</p>\n<p><code>synchronized</code>objc-sync.mm <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p>synchronized1000ms+</p>\n<p>objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png\"></p>\n<p>synchronized</p>\n<p>mrc</p>\n<p> 40ms+objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png\"></p>\n<p>1000ms+mrc</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p> 900ms+</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>SyncData</code><code>os_unfair_recursive_lock</code></p>\n<p> OSPinLock OSPinLockCPUGCD<a href=\"https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/\"></a></p>\n<p><code>os_unfair_lock</code><br><img src=\"https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png\"></p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">os_unfair_recursive_lock_s</span> &#123;</span></span><br><span class=\"line\">    os_unfair_lock ourl_lock;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> ourl_count;</span><br><span class=\"line\">&#125; os_unfair_recursive_lock;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">os_unfair_recursive_lock lock = ((os_unfair_recursive_lock)&#123;OS_UNFAIR_LOCK_INIT, <span class=\"number\">0</span>&#125;);</span><br><span class=\"line\">os_unfair_recursive_lock *mlock = &amp;lock;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">    os_unfair_recursive_lock_lock_with_options(&amp;lock, <span class=\"number\">0x00000000</span>);</span><br><span class=\"line\">        count ++;</span><br><span class=\"line\">    os_unfair_recursive_lock_tryunlock4objc(&amp;lock);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>200ms<code>os_unfair_lock</code><code>pthread_mutex</code>10%</p>\n<p> 1000ms+900ms+200ms &#x3D; 2100ms</p>\n<p>500ms500ms</p>\n<p>objc-os.hLOCKDEBUGdebug2900ms -&gt; 2100ms</p>\n<blockquote>\n<p>:<br>1.synchronized os_unfair_lock pthread_mutex<br>2.synchronizedTLSCache</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ <a href=\"https://caio.ink/oc-block-imp/\">ocblock</a>@autoreleasepool@synchronized</p>","more":"<p>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = [NSObject new];</span><br><span class=\"line\">    @synchronized (o) &#123;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;helloworld&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>clang :</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = ((NSObject *(*)(id, SEL))(<span class=\"type\">void</span> *)objc_msgSend)((id)objc_getClass(<span class=\"string\">&quot;NSObject&quot;</span>), sel_registerName(<span class=\"string\">&quot;new&quot;</span>));</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        id _rethrow = <span class=\"number\">0</span>;</span><br><span class=\"line\">        id _sync_obj = (id)o;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        objc_sync_enter(_sync_obj);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">SYNC_EXIT</span> &#123;</span></span><br><span class=\"line\">                _SYNC_EXIT(id arg) : sync_exit(arg) &#123;&#125;</span><br><span class=\"line\">                ~_SYNC_EXIT()</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    objc_sync_exit(sync_exit);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id sync_exit;</span><br><span class=\"line\">            &#125; _sync_exit(_sync_obj);</span><br><span class=\"line\"></span><br><span class=\"line\">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);</span><br><span class=\"line\">        &#125; catch (id e) &#123;</span><br><span class=\"line\">            _rethrow = e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">FIN</span> &#123;</span></span><br><span class=\"line\">                _FIN(id reth) : rethrow(reth) &#123;&#125;</span><br><span class=\"line\">                ~_FIN() &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (rethrow)</span><br><span class=\"line\">                        objc_exception_throw(rethrow);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id rethrow;</span><br><span class=\"line\">            &#125; _fin_force_rethow(_rethrow);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>@synchronized</code> try</li>\n<li>try <code>objc_sync_enter(_sync_obj)</code> </li>\n<li>tryC++C++C++</li>\n<li>tryC++<code>objc_sync_exit(sync_exit)</code></li>\n<li><code>@synchronized</code> catch</li>\n</ol>\n<blockquote>\n<p><code></code>OC</p>\n</blockquote>\n<p></p>\n<ol>\n<li>objc_sync_enter(obj); </li>\n<li>objc_sync_exit(obj); </li>\n</ol>\n<h3 id=\"objc-sync-enter--objc-sync-exit\"><a href=\"#objc-sync-enter--objc-sync-exit\" class=\"headerlink\" title=\"objc_sync_enter  objc_sync_exit\"></a>objc_sync_enter  objc_sync_exit</h3><p><code>libobjc.A.dylib</code>(Runtime) objc-sync.h&#x2F;.m  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_enter</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, ACQUIRE);</span><br><span class=\"line\">        data-&gt;mutex.lock();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_exit</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, RELEASE); </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!data) &#123;</span><br><span class=\"line\">            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">bool</span> okay = data-&gt;mutex.tryUnlock();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!okay) &#123;</span><br><span class=\"line\">                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>id2data</code>, obj  <code>SyncData</code>, mutex <code>@synchronized</code>ocmutex</p>\n<h2 id=\"id2data\"><a href=\"#id2data\" class=\"headerlink\" title=\"id2data\"></a>id2data</h2><p></p>\n<h4 id=\"SyncData\"><a href=\"#SyncData\" class=\"headerlink\" title=\"SyncData\"></a>SyncData</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> <span class=\"title function_\">alignas</span><span class=\"params\">(CacheLineSize)</span> SyncData &#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncData</span>* <span class=\"title\">nextData</span>;</span></span><br><span class=\"line\">    DisguisedPtr&lt;objc_object&gt; object;</span><br><span class=\"line\">    <span class=\"type\">int32_t</span> threadCount;  <span class=\"comment\">// number of THREADS using this block</span></span><br><span class=\"line\">    <span class=\"type\">recursive_mutex_t</span> mutex;</span><br><span class=\"line\">&#125; SyncData;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncData</li>\n<li>SyncDatanextData</li>\n<li>object</li>\n<li>threadCount</li>\n<li>mutex (os_unfair_recursive_lock),</li>\n</ol>\n<h4 id=\"SyncCache\"><a href=\"#SyncCache\" class=\"headerlink\" title=\"SyncCache\"></a>SyncCache</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncCache</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> allocated;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> used;</span><br><span class=\"line\">    SyncCacheItem <span class=\"built_in\">list</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125; SyncCache;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncCache TLS()<code>SyncData</code>TLS</li>\n<li>list<code>SyncCacheItem</code>,<code>SyncCacheItem</code><code>SyncData</code>lockCountlockCount@synchronized</li>\n<li>allocatedcacheused4size</li>\n</ol>\n<p>id2dataid()SyncData,syncData.mutex.lock()</p>\n<p><strong>SyncData</strong></p>\n<p></p>\n<ol>\n<li><code>TLS</code>:<strong></strong><code>TLS</code><code>SyncData</code><code>TLS</code>fast cache</li>\n<li><code>SyncCache</code>:<code>TLS</code><code>SyncCache</code><code>SyncCache</code><code>SyncData</code></li>\n<li> 12<code>static StripedMap&lt;SyncList&gt; sDataLists</code><code>sDataList</code>Mapkeyvalue<code>SyncList</code></li>\n</ol>\n<p> aDataLists</p>\n<ul>\n<li>StripedMapkey(id)mapsize64iPhone8<code>SyncData</code><code>SyncList</code><code>SyncList</code><code>spinlock_t</code>,</li>\n<li>StripedMapSyncList<code>SyncData</code>(threadCount&#x3D;&#x3D;0)</li>\n</ul>\n<p><code>id2data</code></p>\n<ol>\n<li> <code>SYNC_DATA_DIRECT_KEY</code><code>SYNC_COUNT_DIRECT_KEY</code>keyTLS<code>SyncData</code>,TLS<code>SyncData</code></li>\n<li>TLS<code>SyncCache</code><code>SyncData</code><code>SyncCacheItem</code>lockCount<code>SyncData</code></li>\n<li>12<code>SyncData</code><code>sDataLists</code><code>SyncList</code><code>SyncList</code><code>SyncData</code></li>\n<li>3<code>SyncData</code><code>SyncList</code></li>\n<li><code>TLS</code><code>SYNC_DATA_DIRECT_KEY</code><strong></strong><code>SyncCache</code></li>\n</ol>\n<p>:<br>12lockCount0SyncData<code>SyncData</code>threadCount,3<code>SyncData</code></p>\n<h3 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h3><p>@synchronized</p>\n<p>@synchronized</p>\n<p></p>\n<ol>\n<li><code>id2data</code><code>TLS</code>,<code>SyncCache</code>,<code>sDataLists</code></li>\n<li><code>SyncData</code></li>\n</ol>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> pthread_mutex  synchronized  <br>pthread_mutex:200ms<br>synchronized:6800ms</p>\n<p>em</p>\n<p><code>..TLS....TLS</code>,<code>TLS</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t@synchronized(t)&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>pthread_mutex:200ms<br>synchronized:2700ms</p>\n<p>......</p>\n<p>Runtime</p>\n<hr>\n<p>:</p>\n<p><code>synchronized</code>objc-sync.mm <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p>synchronized1000ms+</p>\n<p>objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png\"></p>\n<p>synchronized</p>\n<p>mrc</p>\n<p> 40ms+objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png\"></p>\n<p>1000ms+mrc</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p> 900ms+</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>SyncData</code><code>os_unfair_recursive_lock</code></p>\n<p> OSPinLock OSPinLockCPUGCD<a href=\"https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/\"></a></p>\n<p><code>os_unfair_lock</code><br><img src=\"https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png\"></p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">os_unfair_recursive_lock_s</span> &#123;</span></span><br><span class=\"line\">    os_unfair_lock ourl_lock;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> ourl_count;</span><br><span class=\"line\">&#125; os_unfair_recursive_lock;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">os_unfair_recursive_lock lock = ((os_unfair_recursive_lock)&#123;OS_UNFAIR_LOCK_INIT, <span class=\"number\">0</span>&#125;);</span><br><span class=\"line\">os_unfair_recursive_lock *mlock = &amp;lock;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">    os_unfair_recursive_lock_lock_with_options(&amp;lock, <span class=\"number\">0x00000000</span>);</span><br><span class=\"line\">        count ++;</span><br><span class=\"line\">    os_unfair_recursive_lock_tryunlock4objc(&amp;lock);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>200ms<code>os_unfair_lock</code><code>pthread_mutex</code>10%</p>\n<p> 1000ms+900ms+200ms &#x3D; 2100ms</p>\n<p>500ms500ms</p>\n<p>objc-os.hLOCKDEBUGdebug2900ms -&gt; 2100ms</p>\n<blockquote>\n<p>:<br>1.synchronized os_unfair_lock pthread_mutex<br>2.synchronizedTLSCache</p>\n</blockquote>"},{"title":" -- LeetCode[46]","date":"2020-01-04T16:00:00.000Z","_content":"\n> Medium\n\n<!-- more -->\n\n:\n: [1,2,3]\n:\n[\n  [1,2,3],\n  [1,3,2],\n  [2,1,3],\n  [2,3,1],\n  [3,1,2],\n  [3,2,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n\n     **** \n\n:\n\n, \n\n### \n\n```java\npublic class Solution46 {\n  public List<List<Integer>> permute(int[] nums) {\n\n    List<List<Integer>> res = new ArrayList<>();\n    int[] visited = new int[nums.length];//\n    backtrack(res, nums, new ArrayList<Integer>(), visited);\n    return res;\n\n  }\n\n  private void backtrack(List<List<Integer>> res, int[] nums, ArrayList<Integer> tmp, int[] visited) {\n    if (tmp.size() == nums.length) {\n      res.add(new ArrayList<>(tmp));\n      return;\n    }\n    for (int i = 0; i < nums.length; i++) {\n      if (visited[i] == 1)//\n        continue;\n      tmp.add(nums[i]);//\n      visited[i] = 1;//\n\n      backtrack(res, nums, tmp, visited);\n      //\n      visited[i] = 0;\n      tmp.remove(tmp.size() - 1);\n    }\n  }\n}\n```\n\n[]\n\n\n\nNValueN\nNValuevisited\n\n\n\n\nNvalue\n\n\n### \n\n```java\nclass Solution {\n    public void backtrack(int n, ArrayList<Integer> nums, List<List<Integer>> output, int first) {\n        // if all integers are used up\n        if (first == n)\n            output.add(new ArrayList<Integer>(nums));\n\n        for (int i = first; i < n; i++) {\n            // place i-th integer first\n            // in the current permutation\n            Collections.swap(nums, first, i);\n            // use next integers to complete the permutations\n            backtrack(n, nums, output, first + 1);\n            // backtrack\n            Collections.swap(nums, first, i);\n        }\n    }\n\n    public List<List<Integer>> permute(int[] nums) {\n        // init output list\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        // convert nums into list since the output is a list of lists\n        ArrayList<Integer> nums_lst = new ArrayList<Integer>();\n        for (int num : nums)\n            nums_lst.add(num);\n\n        int n = nums.length;\n        backtrack(n, nums_lst, output, 0);\n        return output;\n    }\n}\n```\n\n LeetCode\n\ntmpswapswap\n\nNvalue Arr[N]\n1. valueNi<NArr[i]N-1\n2.  1 ValueArr\n3. swap\n\n### \nNN-1N-2...\nO(n!)O(n^n)\nO(1) O(n)\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)\n","source":"_posts/7.leetcode46.md","raw":"---\ntitle:  -- LeetCode[46]\ndate: 2020-01-05\ntags: [leetcode,]\ncategories: \n---\n\n> Medium\n\n<!-- more -->\n\n:\n: [1,2,3]\n:\n[\n  [1,2,3],\n  [1,3,2],\n  [2,1,3],\n  [2,3,1],\n  [3,1,2],\n  [3,2,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n\n     **** \n\n:\n\n, \n\n### \n\n```java\npublic class Solution46 {\n  public List<List<Integer>> permute(int[] nums) {\n\n    List<List<Integer>> res = new ArrayList<>();\n    int[] visited = new int[nums.length];//\n    backtrack(res, nums, new ArrayList<Integer>(), visited);\n    return res;\n\n  }\n\n  private void backtrack(List<List<Integer>> res, int[] nums, ArrayList<Integer> tmp, int[] visited) {\n    if (tmp.size() == nums.length) {\n      res.add(new ArrayList<>(tmp));\n      return;\n    }\n    for (int i = 0; i < nums.length; i++) {\n      if (visited[i] == 1)//\n        continue;\n      tmp.add(nums[i]);//\n      visited[i] = 1;//\n\n      backtrack(res, nums, tmp, visited);\n      //\n      visited[i] = 0;\n      tmp.remove(tmp.size() - 1);\n    }\n  }\n}\n```\n\n[]\n\n\n\nNValueN\nNValuevisited\n\n\n\n\nNvalue\n\n\n### \n\n```java\nclass Solution {\n    public void backtrack(int n, ArrayList<Integer> nums, List<List<Integer>> output, int first) {\n        // if all integers are used up\n        if (first == n)\n            output.add(new ArrayList<Integer>(nums));\n\n        for (int i = first; i < n; i++) {\n            // place i-th integer first\n            // in the current permutation\n            Collections.swap(nums, first, i);\n            // use next integers to complete the permutations\n            backtrack(n, nums, output, first + 1);\n            // backtrack\n            Collections.swap(nums, first, i);\n        }\n    }\n\n    public List<List<Integer>> permute(int[] nums) {\n        // init output list\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        // convert nums into list since the output is a list of lists\n        ArrayList<Integer> nums_lst = new ArrayList<Integer>();\n        for (int num : nums)\n            nums_lst.add(num);\n\n        int n = nums.length;\n        backtrack(n, nums_lst, output, 0);\n        return output;\n    }\n}\n```\n\n LeetCode\n\ntmpswapswap\n\nNvalue Arr[N]\n1. valueNi<NArr[i]N-1\n2.  1 ValueArr\n3. swap\n\n### \nNN-1N-2...\nO(n!)O(n^n)\nO(1) O(n)\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)\n","slug":"7.leetcode46","published":1,"updated":"2020-08-29T14:42:58.502Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61n001pelc91bwi3zq2","content":"<blockquote>\n<p>Medium</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p>:<br>: [1,2,3]<br>:<br>[<br>  [1,2,3],<br>  [1,3,2],<br>  [2,1,3],<br>  [2,3,1],<br>  [3,1,2],<br>  [3,2,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p><br>     <strong></strong> </p>\n<p>:<br><br>, </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution46</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    List&lt;List&lt;Integer&gt;&gt; res = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">    <span class=\"type\">int</span>[] visited = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];<span class=\"comment\">//</span></span><br><span class=\"line\">    backtrack(res, nums, <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(), visited);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; res, <span class=\"type\">int</span>[] nums, ArrayList&lt;Integer&gt; tmp, <span class=\"type\">int</span>[] visited)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">      res.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;(tmp));</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (visited[i] == <span class=\"number\">1</span>)<span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      tmp.add(nums[i]);<span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">1</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">      backtrack(res, nums, tmp, visited);</span><br><span class=\"line\">      <span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">      tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>[]</p>\n<p></p>\n<p>NValueN<br>NValuevisited<br></p>\n<p></p>\n<p>Nvalue<br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(<span class=\"type\">int</span> n, ArrayList&lt;Integer&gt; nums, List&lt;List&lt;Integer&gt;&gt; output, <span class=\"type\">int</span> first)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// if all integers are used up</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first == n)</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(nums));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> first; i &lt; n; i++) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// place i-th integer first</span></span><br><span class=\"line\">            <span class=\"comment\">// in the current permutation</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">            <span class=\"comment\">// use next integers to complete the permutations</span></span><br><span class=\"line\">            backtrack(n, nums, output, first + <span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// backtrack</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// init output list</span></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// convert nums into list since the output is a list of lists</span></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; nums_lst = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> num : nums)</span><br><span class=\"line\">            nums_lst.add(num);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> nums.length;</span><br><span class=\"line\">        backtrack(n, nums_lst, output, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> LeetCode</p>\n<p>tmpswapswap</p>\n<p>Nvalue Arr[N]</p>\n<ol>\n<li>valueNi&lt;NArr[i]N-1</li>\n<li> 1 ValueArr</li>\n<li>swap</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NN-1N-2<br>O(n!)O(n^n)<br>O(1) O(n)</p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Medium</p>\n</blockquote>","more":"<p>:<br>: [1,2,3]<br>:<br>[<br>  [1,2,3],<br>  [1,3,2],<br>  [2,1,3],<br>  [2,3,1],<br>  [3,1,2],<br>  [3,2,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p><br>     <strong></strong> </p>\n<p>:<br><br>, </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution46</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    List&lt;List&lt;Integer&gt;&gt; res = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">    <span class=\"type\">int</span>[] visited = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];<span class=\"comment\">//</span></span><br><span class=\"line\">    backtrack(res, nums, <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(), visited);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; res, <span class=\"type\">int</span>[] nums, ArrayList&lt;Integer&gt; tmp, <span class=\"type\">int</span>[] visited)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">      res.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;(tmp));</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (visited[i] == <span class=\"number\">1</span>)<span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      tmp.add(nums[i]);<span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">1</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">      backtrack(res, nums, tmp, visited);</span><br><span class=\"line\">      <span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">      tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>[]</p>\n<p></p>\n<p>NValueN<br>NValuevisited<br></p>\n<p></p>\n<p>Nvalue<br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(<span class=\"type\">int</span> n, ArrayList&lt;Integer&gt; nums, List&lt;List&lt;Integer&gt;&gt; output, <span class=\"type\">int</span> first)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// if all integers are used up</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first == n)</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(nums));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> first; i &lt; n; i++) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// place i-th integer first</span></span><br><span class=\"line\">            <span class=\"comment\">// in the current permutation</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">            <span class=\"comment\">// use next integers to complete the permutations</span></span><br><span class=\"line\">            backtrack(n, nums, output, first + <span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// backtrack</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// init output list</span></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// convert nums into list since the output is a list of lists</span></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; nums_lst = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> num : nums)</span><br><span class=\"line\">            nums_lst.add(num);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> nums.length;</span><br><span class=\"line\">        backtrack(n, nums_lst, output, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> LeetCode</p>\n<p>tmpswapswap</p>\n<p>Nvalue Arr[N]</p>\n<ol>\n<li>valueNi&lt;NArr[i]N-1</li>\n<li> 1 ValueArr</li>\n<li>swap</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NN-1N-2<br>O(n!)O(n^n)<br>O(1) O(n)</p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>"},{"title":"II -- LeetCode[37]","date":"2020-01-06T16:00:00.000Z","_content":"\n> Medium\n\n<!-- more -->\n\n:\n: [1,1,2]\n:\n[\n  [1,1,2],\n  [1,2,1],\n  [2,1,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n [LeetCode 46](https://caio.ink/leetcode46/) case\n\n [LeetCode 46](https://caio.ink/leetcode46/) \n\n46\n\n### \n\n```java\npublic class Solution47 {\n    public void backTrace(int[] nums, int[] usedMark, List<List<Integer>> output, LinkedList<Integer> tmp) {\n        if (tmp.size() == nums.length) {\n            output.add(new LinkedList<Integer>(tmp));\n        }\n\n        for (int i = 0; i < nums.length;) {\n            if (usedMark[i] == 1){\n                i++;\n                continue;\n            }\n\n            tmp.add(nums[i]);\n\n            usedMark[i] = 1;\n\n            int startIndex = i;\n            int endIndex = i;\n\n            while ((endIndex != (nums.length - 1)) && (nums[endIndex + 1] == nums[i])) {\n                endIndex++;\n            }\n\n            backTrace(nums, usedMark, output, tmp);\n\n            // backtrace\n            tmp.remove(tmp.size() - 1);\n            usedMark[i] = 0;\n            // next index \n            i = endIndex + 1;\n        }\n\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        LinkedList<Integer> tmp = new LinkedList<Integer>();\n\n        int[] usedMark = new int[nums.length];\n\n        backTrace(nums, usedMark, output, tmp);\n        return output;\n    }\n}\n```\n\n46used\n\nmap\n\nindex=0used\n\n\n\n\n### \n\n```java\npublic class Solution47_2 {\n    private void backTrace(List<List<Integer>> output, ArrayList<Integer> data, int start) {\n        if (start == data.size()) {\n            output.add(new LinkedList<>(data));\n        }\n\n        int lastValue = 0;\n        for (int i = start; i < data.size(); i++) {\n            int value = data.get(i);\n            if (i != start && lastValue == value){\n                continue;\n            }\n            lastValue = value;\n            // \n            for (int j = i; j > start; j--) {\n                data.set(j, data.get(j-1));\n            }\n            data.set(start, value);\n\n            backTrace(output, data, start+1);\n            // \n            for (int j = start; j < i; j++) {\n                data.set(j, data.get(j+1));\n            }\n            data.set(i, value);\n        }\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        ArrayList<Integer> data = new ArrayList<>();\n\n        for (int value : nums) {\n            data.add(value);\n        }\n\n        backTrace(output, data, 0);\n\n        return output;\n    }\n}\n```\n\n4647\n\n46 ````range ````range``\n\n\n\n\n\n  `a a b c`a<b<c\n  `a` `a`\n `a``b`,`a``b` `a`\n `c``a`,`c``c`...\n\nrange start -> N (N) i ``\n\n`[start i)` ,istart``range\n\n`(start i]`starti\n\n### \n\n\n O(n)\n O(n^n)\n\n\n O(1)\nO(n!)\n\n``usedMark``\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)","source":"_posts/8.leetcode47.md","raw":"---\ntitle: II -- LeetCode[37]\ndate: 2020-01-07\ntags: [leetcode,]\ncategories: \n---\n\n> Medium\n\n<!-- more -->\n\n:\n: [1,1,2]\n:\n[\n  [1,1,2],\n  [1,2,1],\n  [2,1,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n [LeetCode 46](https://caio.ink/leetcode46/) case\n\n [LeetCode 46](https://caio.ink/leetcode46/) \n\n46\n\n### \n\n```java\npublic class Solution47 {\n    public void backTrace(int[] nums, int[] usedMark, List<List<Integer>> output, LinkedList<Integer> tmp) {\n        if (tmp.size() == nums.length) {\n            output.add(new LinkedList<Integer>(tmp));\n        }\n\n        for (int i = 0; i < nums.length;) {\n            if (usedMark[i] == 1){\n                i++;\n                continue;\n            }\n\n            tmp.add(nums[i]);\n\n            usedMark[i] = 1;\n\n            int startIndex = i;\n            int endIndex = i;\n\n            while ((endIndex != (nums.length - 1)) && (nums[endIndex + 1] == nums[i])) {\n                endIndex++;\n            }\n\n            backTrace(nums, usedMark, output, tmp);\n\n            // backtrace\n            tmp.remove(tmp.size() - 1);\n            usedMark[i] = 0;\n            // next index \n            i = endIndex + 1;\n        }\n\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        LinkedList<Integer> tmp = new LinkedList<Integer>();\n\n        int[] usedMark = new int[nums.length];\n\n        backTrace(nums, usedMark, output, tmp);\n        return output;\n    }\n}\n```\n\n46used\n\nmap\n\nindex=0used\n\n\n\n\n### \n\n```java\npublic class Solution47_2 {\n    private void backTrace(List<List<Integer>> output, ArrayList<Integer> data, int start) {\n        if (start == data.size()) {\n            output.add(new LinkedList<>(data));\n        }\n\n        int lastValue = 0;\n        for (int i = start; i < data.size(); i++) {\n            int value = data.get(i);\n            if (i != start && lastValue == value){\n                continue;\n            }\n            lastValue = value;\n            // \n            for (int j = i; j > start; j--) {\n                data.set(j, data.get(j-1));\n            }\n            data.set(start, value);\n\n            backTrace(output, data, start+1);\n            // \n            for (int j = start; j < i; j++) {\n                data.set(j, data.get(j+1));\n            }\n            data.set(i, value);\n        }\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        ArrayList<Integer> data = new ArrayList<>();\n\n        for (int value : nums) {\n            data.add(value);\n        }\n\n        backTrace(output, data, 0);\n\n        return output;\n    }\n}\n```\n\n4647\n\n46 ````range ````range``\n\n\n\n\n\n  `a a b c`a<b<c\n  `a` `a`\n `a``b`,`a``b` `a`\n `c``a`,`c``c`...\n\nrange start -> N (N) i ``\n\n`[start i)` ,istart``range\n\n`(start i]`starti\n\n### \n\n\n O(n)\n O(n^n)\n\n\n O(1)\nO(n!)\n\n``usedMark``\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)","slug":"8.leetcode47","published":1,"updated":"2020-08-29T14:42:58.503Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61o001telc92y010i5i","content":"<blockquote>\n<p>Medium</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p>:<br>: [1,1,2]<br>:<br>[<br>  [1,1,2],<br>  [1,2,1],<br>  [2,1,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> case</p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> </p>\n<p>46</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(<span class=\"type\">int</span>[] nums, <span class=\"type\">int</span>[] usedMark, List&lt;List&lt;Integer&gt;&gt; output, LinkedList&lt;Integer&gt; tmp)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;(tmp));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length;) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (usedMark[i] == <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">                i++;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            tmp.add(nums[i]);</span><br><span class=\"line\"></span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">startIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">endIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((endIndex != (nums.length - <span class=\"number\">1</span>)) &amp;&amp; (nums[endIndex + <span class=\"number\">1</span>] == nums[i])) &#123;</span><br><span class=\"line\">                endIndex++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// backtrace</span></span><br><span class=\"line\">            tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"comment\">// next index </span></span><br><span class=\"line\">            i = endIndex + <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        LinkedList&lt;Integer&gt; tmp = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span>[] usedMark = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>46used</p>\n<p>map</p>\n<p>index&#x3D;0used</p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47_2</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; output, ArrayList&lt;Integer&gt; data, <span class=\"type\">int</span> start)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (start == data.size()) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;&gt;(data));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">lastValue</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> start; i &lt; data.size(); i++) &#123;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> data.get(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i != start &amp;&amp; lastValue == value)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            lastValue = value;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> i; j &gt; start; j--) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j-<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(start, value);</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(output, data, start+<span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> start; j &lt; i; j++) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j+<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(i, value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; data = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> value : nums) &#123;</span><br><span class=\"line\">            data.add(value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(output, data, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>4647</p>\n<p>46 <code></code><code></code>range <code></code><code></code>range<code></code></p>\n<p></p>\n<p></p>\n<p>  <code>a a b c</code>a&lt;b&lt;c<br>  <code>a</code> <code>a</code><br> <code>a</code><code>b</code>,<code>a</code><code>b</code> <code>a</code><br> <code>c</code><code>a</code>,<code>c</code><code>c</code></p>\n<p>range start -&gt; N (N) i <code></code></p>\n<p><code>[start i)</code> ,istart<code></code>range</p>\n<p><code>(start i]</code>starti</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br> O(n)<br> O(n^n)</p>\n<p><br> O(1)<br>O(n!)</p>\n<p><code></code>usedMark<code></code></p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Medium</p>\n</blockquote>","more":"<p>:<br>: [1,1,2]<br>:<br>[<br>  [1,1,2],<br>  [1,2,1],<br>  [2,1,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> case</p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> </p>\n<p>46</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(<span class=\"type\">int</span>[] nums, <span class=\"type\">int</span>[] usedMark, List&lt;List&lt;Integer&gt;&gt; output, LinkedList&lt;Integer&gt; tmp)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;(tmp));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length;) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (usedMark[i] == <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">                i++;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            tmp.add(nums[i]);</span><br><span class=\"line\"></span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">startIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">endIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((endIndex != (nums.length - <span class=\"number\">1</span>)) &amp;&amp; (nums[endIndex + <span class=\"number\">1</span>] == nums[i])) &#123;</span><br><span class=\"line\">                endIndex++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// backtrace</span></span><br><span class=\"line\">            tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"comment\">// next index </span></span><br><span class=\"line\">            i = endIndex + <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        LinkedList&lt;Integer&gt; tmp = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span>[] usedMark = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>46used</p>\n<p>map</p>\n<p>index&#x3D;0used</p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47_2</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; output, ArrayList&lt;Integer&gt; data, <span class=\"type\">int</span> start)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (start == data.size()) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;&gt;(data));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">lastValue</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> start; i &lt; data.size(); i++) &#123;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> data.get(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i != start &amp;&amp; lastValue == value)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            lastValue = value;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> i; j &gt; start; j--) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j-<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(start, value);</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(output, data, start+<span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> start; j &lt; i; j++) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j+<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(i, value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; data = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> value : nums) &#123;</span><br><span class=\"line\">            data.add(value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(output, data, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>4647</p>\n<p>46 <code></code><code></code>range <code></code><code></code>range<code></code></p>\n<p></p>\n<p></p>\n<p>  <code>a a b c</code>a&lt;b&lt;c<br>  <code>a</code> <code>a</code><br> <code>a</code><code>b</code>,<code>a</code><code>b</code> <code>a</code><br> <code>c</code><code>a</code>,<code>c</code><code>c</code></p>\n<p>range start -&gt; N (N) i <code></code></p>\n<p><code>[start i)</code> ,istart<code></code>range</p>\n<p><code>(start i]</code>starti</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br> O(n)<br> O(n^n)</p>\n<p><br> O(1)<br>O(n!)</p>\n<p><code></code>usedMark<code></code></p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>"},{"title":" -- LeetCode[32]","date":"2019-12-20T16:00:00.000Z","_content":"\n> Hard '('  ')' \n\n<!-- more -->\n\nS\n\n## \n\n...\n\nidp[i]iS[i] `)`  `(`  dp 0 `)` dp\n\n `e()`  `(e)`edp[i-1]\n\n1. S[i] == `)` && S[i-1] == `(`:\n\tdp[i] = dp[i-2] + 2\n\t\n2. S[i] == `)` && S[i-1] == `)` && S[i-dp[i-1]-1] == `(`\n\tdp[i] = dp[i-1] + dp[i-dp[i-1]-2] + 2\n\t\ndp[i-dp[i-1]-2]...\n\n\nO(n)\nO(n)\n\ndiscuss\n\n## \n\n**A......B**\n\n\n1.  `(` \n2.  `)`\n\ndp[<i]i\n\nO(n)\nO(n)\n\n## \n\n...\n\n  \n1. `(`  `)` \n2.  `(`, `)`\n\n\n\n`)` >`(` `e)` e\n\n`(` >`)` `(e` e\n\nO(n)\nO(1)\n","source":"_posts/6.leetcode32.md","raw":"---\ntitle:  -- LeetCode[32]\ndate: 2019-12-21\ntags: [leetcode,]\ncategories: \n---\n\n> Hard '('  ')' \n\n<!-- more -->\n\nS\n\n## \n\n...\n\nidp[i]iS[i] `)`  `(`  dp 0 `)` dp\n\n `e()`  `(e)`edp[i-1]\n\n1. S[i] == `)` && S[i-1] == `(`:\n\tdp[i] = dp[i-2] + 2\n\t\n2. S[i] == `)` && S[i-1] == `)` && S[i-dp[i-1]-1] == `(`\n\tdp[i] = dp[i-1] + dp[i-dp[i-1]-2] + 2\n\t\ndp[i-dp[i-1]-2]...\n\n\nO(n)\nO(n)\n\ndiscuss\n\n## \n\n**A......B**\n\n\n1.  `(` \n2.  `)`\n\ndp[<i]i\n\nO(n)\nO(n)\n\n## \n\n...\n\n  \n1. `(`  `)` \n2.  `(`, `)`\n\n\n\n`)` >`(` `e)` e\n\n`(` >`)` `(e` e\n\nO(n)\nO(1)\n","slug":"6.leetcode32","published":1,"updated":"2020-08-29T14:42:58.502Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61p001xelc97x84d7jk","content":"<blockquote>\n<p>Hard (  ) </p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p>S</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>idp[i]iS[i] <code>)</code>  <code>(</code>  dp 0 <code>)</code> dp</p>\n<p> <code>e()</code>  <code>(e)</code>edp[i-1]</p>\n<ol>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>(</code>:<br> dp[i] &#x3D; dp[i-2] + 2</p>\n</li>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-dp[i-1]-1] &#x3D;&#x3D; <code>(</code><br> dp[i] &#x3D; dp[i-1] + dp[i-dp[i-1]-2] + 2</p>\n</li>\n</ol>\n<p>dp[i-dp[i-1]-2]</p>\n<p><br>O(n)<br>O(n)</p>\n<p>discuss</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>AB</strong></p>\n<p></p>\n<ol>\n<li> <code>(</code> </li>\n<li> <code>)</code></li>\n</ol>\n<p>dp[&lt;i]i</p>\n<p>O(n)<br>O(n)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>  </p>\n<ol>\n<li><code>(</code>  <code>)</code> </li>\n<li> <code>(</code>, <code>)</code></li>\n</ol>\n<p></p>\n<p><code>)</code> &gt;<code>(</code> <code>e)</code> e</p>\n<p><code>(</code> &gt;<code>)</code> <code>(e</code> e</p>\n<p>O(n)<br>O(1)</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Hard (  ) </p>\n</blockquote>","more":"<p>S</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>idp[i]iS[i] <code>)</code>  <code>(</code>  dp 0 <code>)</code> dp</p>\n<p> <code>e()</code>  <code>(e)</code>edp[i-1]</p>\n<ol>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>(</code>:<br> dp[i] &#x3D; dp[i-2] + 2</p>\n</li>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-dp[i-1]-1] &#x3D;&#x3D; <code>(</code><br> dp[i] &#x3D; dp[i-1] + dp[i-dp[i-1]-2] + 2</p>\n</li>\n</ol>\n<p>dp[i-dp[i-1]-2]</p>\n<p><br>O(n)<br>O(n)</p>\n<p>discuss</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>AB</strong></p>\n<p></p>\n<ol>\n<li> <code>(</code> </li>\n<li> <code>)</code></li>\n</ol>\n<p>dp[&lt;i]i</p>\n<p>O(n)<br>O(n)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>  </p>\n<ol>\n<li><code>(</code>  <code>)</code> </li>\n<li> <code>(</code>, <code>)</code></li>\n</ol>\n<p></p>\n<p><code>)</code> &gt;<code>(</code> <code>e)</code> e</p>\n<p><code>(</code> &gt;<code>)</code> <code>(e</code> e</p>\n<p>O(n)<br>O(1)</p>"},{"title":"leetcode -- ","date":"2020-01-12T16:00:00.000Z","_content":"\n## \n\n<!-- more -->\n\n### 2020-01-11 17\n\n#### \n[]()\n\n#### \n[]()\n\n\n#### \n[](https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/)\n\n****sumEvenGrandparent\n#### \n[](https://leetcode-cn.com/problems/distinct-echo-substrings/)\n\n\n---","source":"_posts/9.LeetCode-week-match.md","raw":"---\ntitle: leetcode -- \ndate: 2020-01-13\ntags: [leetcode,]\ncategories: \n---\n\n## \n\n<!-- more -->\n\n### 2020-01-11 17\n\n#### \n[]()\n\n#### \n[]()\n\n\n#### \n[](https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/)\n\n****sumEvenGrandparent\n#### \n[](https://leetcode-cn.com/problems/distinct-echo-substrings/)\n\n\n---","slug":"9.LeetCode-week-match","published":1,"updated":"2020-08-29T14:42:58.503Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3flc61q0021elc908cv59th","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><span id=\"more\"></span>\n\n<h3 id=\"2020-01-11-17\"><a href=\"#2020-01-11-17\" class=\"headerlink\" title=\"2020-01-11 17\"></a>2020-01-11 17</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/\"></a></p>\n<p><strong></strong>sumEvenGrandparent</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/distinct-echo-substrings/\"></a><br></p>\n<hr>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2>","more":"<h3 id=\"2020-01-11-17\"><a href=\"#2020-01-11-17\" class=\"headerlink\" title=\"2020-01-11 17\"></a>2020-01-11 17</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/\"></a></p>\n<p><strong></strong>sumEvenGrandparent</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/distinct-echo-substrings/\"></a><br></p>\n<hr>"}],"PostAsset":[],"PostCategory":[{"post_id":"cl3flc60o0000elc9ajfnc03p","category_id":"cl3flc60u0001elc98lis9k0w","_id":"cl3flc60w0004elc9bj90ae27"},{"post_id":"cl3flc6170008elc9anki42hn","category_id":"cl3flc60u0001elc98lis9k0w","_id":"cl3flc61a000felc9cne44z9u"},{"post_id":"cl3flc6150007elc91hzb4uvs","category_id":"cl3flc6170009elc963e0gs83","_id":"cl3flc61c000kelc9d15d8nq8"},{"post_id":"cl3flc61a000helc92ienfpa2","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61e000pelc9acyf18r6"},{"post_id":"cl3flc618000belc94whra2qx","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61f000telc9cra63enk"},{"post_id":"cl3flc61b000jelc92m5p5s1o","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61g000xelc9d0xcbcnl"},{"post_id":"cl3flc61c000melc912on02xt","category_id":"cl3flc60u0001elc98lis9k0w","_id":"cl3flc61h0010elc969wr7i0b"},{"post_id":"cl3flc619000delc90cuk7yu5","category_id":"cl3flc61c000lelc91ackhvpa","_id":"cl3flc61i0014elc914zvadxf"},{"post_id":"cl3flc61d000oelc93ctb2jz1","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61j0017elc98d4a0at3"},{"post_id":"cl3flc61f000selc912w97x07","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61k001aelc9gmj7b8xb"},{"post_id":"cl3flc619000eelc9b4jmfk82","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61l001felc90ra69hc5"},{"post_id":"cl3flc61g000welc90rsi0nu0","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61m001ielc96iztcyv3"},{"post_id":"cl3flc61h000zelc905q9bk63","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61n001nelc9a7vvdl3c"},{"post_id":"cl3flc61i0013elc9cb4t7pz9","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61n001qelc9f8bb6n6q"},{"post_id":"cl3flc61l001eelc921510pm3","category_id":"cl3flc61a000gelc9btk9bgza","_id":"cl3flc61p001velc9futwei95"},{"post_id":"cl3flc61j0016elc97ag28wjy","category_id":"cl3flc61k001delc9fv1010pg","_id":"cl3flc61p001yelc996l5e8gk"},{"post_id":"cl3flc61n001pelc91bwi3zq2","category_id":"cl3flc60u0001elc98lis9k0w","_id":"cl3flc61q0022elc94nhbb81i"},{"post_id":"cl3flc61j0019elc932mkc3i6","category_id":"cl3flc61k001delc9fv1010pg","_id":"cl3flc61r0025elc99bk11f0t"},{"post_id":"cl3flc61o001telc92y010i5i","category_id":"cl3flc60u0001elc98lis9k0w","_id":"cl3flc61r0028elc911ubg5y2"},{"post_id":"cl3flc61p001xelc97x84d7jk","category_id":"cl3flc60u0001elc98lis9k0w","_id":"cl3flc61r002aelc90bai1983"},{"post_id":"cl3flc61l001helc908uzdapz","category_id":"cl3flc61o001uelc94fds9d19","_id":"cl3flc61s002celc9a0g74xl2"},{"post_id":"cl3flc61q0021elc908cv59th","category_id":"cl3flc60u0001elc98lis9k0w","_id":"cl3flc61s002eelc9fll7762m"},{"post_id":"cl3flc61m001lelc91wgi9qer","category_id":"cl3flc61o001uelc94fds9d19","_id":"cl3flc61s002gelc94jhpf234"}],"PostTag":[{"post_id":"cl3flc60o0000elc9ajfnc03p","tag_id":"cl3flc60v0002elc91h7m4d5u","_id":"cl3flc60x0005elc94zvl9fpq"},{"post_id":"cl3flc60o0000elc9ajfnc03p","tag_id":"cl3flc60w0003elc90w5r6cv6","_id":"cl3flc60x0006elc9c1re8olx"},{"post_id":"cl3flc6150007elc91hzb4uvs","tag_id":"cl3flc60v0002elc91h7m4d5u","_id":"cl3flc618000aelc9bint2vqw"},{"post_id":"cl3flc6170008elc9anki42hn","tag_id":"cl3flc618000celc9dgjn8wln","_id":"cl3flc61e000qelc9fctb51ej"},{"post_id":"cl3flc6170008elc9anki42hn","tag_id":"cl3flc61b000ielc91ubv7abe","_id":"cl3flc61f000uelc97ren0bxz"},{"post_id":"cl3flc61d000oelc93ctb2jz1","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61h000yelc90iue08um"},{"post_id":"cl3flc61f000selc912w97x07","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61h0011elc9b22ga5cf"},{"post_id":"cl3flc61g000welc90rsi0nu0","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61i0015elc99fu744w9"},{"post_id":"cl3flc61h000zelc905q9bk63","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61j0018elc97s740gc8"},{"post_id":"cl3flc61i0013elc9cb4t7pz9","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61k001celc9amqz79kh"},{"post_id":"cl3flc618000belc94whra2qx","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61l001gelc97xdbgs2l"},{"post_id":"cl3flc618000belc94whra2qx","tag_id":"cl3flc61g000velc930w726fi","_id":"cl3flc61m001jelc9fihwe9h1"},{"post_id":"cl3flc618000belc94whra2qx","tag_id":"cl3flc61i0012elc93g9e2tlm","_id":"cl3flc61n001oelc92sti36fm"},{"post_id":"cl3flc61l001eelc921510pm3","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61n001relc903su9b6s"},{"post_id":"cl3flc619000delc90cuk7yu5","tag_id":"cl3flc61k001belc9724odvza","_id":"cl3flc61p001welc9c9rf0lyh"},{"post_id":"cl3flc61l001helc908uzdapz","tag_id":"cl3flc60v0002elc91h7m4d5u","_id":"cl3flc61p001zelc9anyd0lwu"},{"post_id":"cl3flc619000eelc9b4jmfk82","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61q0023elc9h8ujg0ea"},{"post_id":"cl3flc619000eelc9b4jmfk82","tag_id":"cl3flc61g000velc930w726fi","_id":"cl3flc61r0026elc9c92y3qqz"},{"post_id":"cl3flc61a000helc92ienfpa2","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61r0029elc97d8cbyn1"},{"post_id":"cl3flc61b000jelc92m5p5s1o","tag_id":"cl3flc61d000nelc9hlvy9odg","_id":"cl3flc61s002delc9918v44t3"},{"post_id":"cl3flc61c000melc912on02xt","tag_id":"cl3flc618000celc9dgjn8wln","_id":"cl3flc61s002helc9fbo01was"},{"post_id":"cl3flc61c000melc912on02xt","tag_id":"cl3flc61r002belc95nnl1z8v","_id":"cl3flc61s002ielc989mw3gvx"},{"post_id":"cl3flc61j0016elc97ag28wjy","tag_id":"cl3flc61s002felc90muf2fdg","_id":"cl3flc61t002lelc90ydt8whm"},{"post_id":"cl3flc61j0016elc97ag28wjy","tag_id":"cl3flc61s002jelc96dh04gja","_id":"cl3flc61t002melc985t7104t"},{"post_id":"cl3flc61j0019elc932mkc3i6","tag_id":"cl3flc61s002felc90muf2fdg","_id":"cl3flc61t002oelc93rteg0cy"},{"post_id":"cl3flc61m001lelc91wgi9qer","tag_id":"cl3flc60v0002elc91h7m4d5u","_id":"cl3flc61u002qelc90vph4r7l"},{"post_id":"cl3flc61m001lelc91wgi9qer","tag_id":"cl3flc61t002nelc906e46vlx","_id":"cl3flc61u002relc9gq7p8a8j"},{"post_id":"cl3flc61n001pelc91bwi3zq2","tag_id":"cl3flc618000celc9dgjn8wln","_id":"cl3flc61u002telc9ci4n3hks"},{"post_id":"cl3flc61n001pelc91bwi3zq2","tag_id":"cl3flc61t002pelc9c08w9wpo","_id":"cl3flc61u002uelc90qw66qnv"},{"post_id":"cl3flc61o001telc92y010i5i","tag_id":"cl3flc618000celc9dgjn8wln","_id":"cl3flc61v002welc9dlxl6a5b"},{"post_id":"cl3flc61o001telc92y010i5i","tag_id":"cl3flc61t002pelc9c08w9wpo","_id":"cl3flc61v002xelc9hbbk1goh"},{"post_id":"cl3flc61p001xelc97x84d7jk","tag_id":"cl3flc618000celc9dgjn8wln","_id":"cl3flc61v002zelc9dv10hg5g"},{"post_id":"cl3flc61p001xelc97x84d7jk","tag_id":"cl3flc61u002velc9gsh4gqxk","_id":"cl3flc61v0030elc91sx3ehsa"},{"post_id":"cl3flc61q0021elc908cv59th","tag_id":"cl3flc618000celc9dgjn8wln","_id":"cl3flc61v0031elc9aj35ejzc"},{"post_id":"cl3flc61q0021elc908cv59th","tag_id":"cl3flc61v002yelc992mu0trl","_id":"cl3flc61v0032elc97z5oc00x"}],"Tag":[{"name":"object-c","_id":"cl3flc60v0002elc91h7m4d5u"},{"name":"","_id":"cl3flc60w0003elc90w5r6cv6"},{"name":"leetcode","_id":"cl3flc618000celc9dgjn8wln"},{"name":"","_id":"cl3flc61b000ielc91ubv7abe"},{"name":"sqlite3","_id":"cl3flc61d000nelc9hlvy9odg"},{"name":"os","_id":"cl3flc61g000velc930w726fi"},{"name":"shm","_id":"cl3flc61i0012elc93g9e2tlm"},{"name":"GoMobile","_id":"cl3flc61k001belc9724odvza"},{"name":"","_id":"cl3flc61r002belc95nnl1z8v"},{"name":"","_id":"cl3flc61s002felc90muf2fdg"},{"name":"","_id":"cl3flc61s002jelc96dh04gja"},{"name":"","_id":"cl3flc61t002nelc906e46vlx"},{"name":"","_id":"cl3flc61t002pelc9c08w9wpo"},{"name":"","_id":"cl3flc61u002velc9gsh4gqxk"},{"name":"","_id":"cl3flc61v002yelc992mu0trl"}]}}