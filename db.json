{"meta":{"version":1,"warehouse":"4.0.1"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/css/noscript.styl","path":"css/noscript.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo-algolia-nebula-blue-full.svg","path":"images/logo-algolia-nebula-blue-full.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/spade-logo-next.png","path":"images/spade-logo-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/spade-logo-next.svg","path":"images/spade-logo-next.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/spade-logo.png","path":"images/spade-logo.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/spade-logo.svg","path":"images/spade-logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/timg.gif","path":"images/timg.gif","modified":0,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/comments-buttons.js","path":"js/comments-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/comments.js","path":"js/comments.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/config.js","path":"js/config.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/pjax.js","path":"js/pjax.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schedule.js","path":"js/schedule.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/fancybox.js","path":"js/third-party/fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/pace.js","path":"js/third-party/pace.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/quicklink.js","path":"js/third-party/quicklink.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/rating.js","path":"js/third-party/rating.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/analytics/baidu-analytics.js","path":"js/third-party/analytics/baidu-analytics.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/analytics/google-analytics.js","path":"js/third-party/analytics/google-analytics.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/analytics/growingio.js","path":"js/third-party/analytics/growingio.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/chat/chatra.js","path":"js/third-party/chat/chatra.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/chat/gitter.js","path":"js/third-party/chat/gitter.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/chat/tidio.js","path":"js/third-party/chat/tidio.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/changyan.js","path":"js/third-party/comments/changyan.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/disqus.js","path":"js/third-party/comments/disqus.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/disqusjs.js","path":"js/third-party/comments/disqusjs.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/gitalk.js","path":"js/third-party/comments/gitalk.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/isso.js","path":"js/third-party/comments/isso.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/livere.js","path":"js/third-party/comments/livere.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/utterances.js","path":"js/third-party/comments/utterances.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/math/mathjax.js","path":"js/third-party/math/mathjax.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/math/katex.js","path":"js/third-party/math/katex.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/search/algolia-search.js","path":"js/third-party/search/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/search/local-search.js","path":"js/third-party/search/local-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/statistics/firestore.js","path":"js/third-party/statistics/firestore.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/statistics/lean-analytics.js","path":"js/third-party/statistics/lean-analytics.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/tags/mermaid.js","path":"js/third-party/tags/mermaid.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/tags/pdf.js","path":"js/third-party/tags/pdf.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"5d5a1d9dcabeb42e5a73104429072d94372b647c","modified":1653127547858},{"_id":"source/_posts/.DS_Store","hash":"cd1e6c4dd4217df2bdbb272c6393ced3a1d880b1","modified":1653127542847},{"_id":"source/_posts/1.leetcode41.md","hash":"8be8e8a750a11785dd4103698ab0c9ce284efc82","modified":1653126938818},{"_id":"source/_posts/10.runloop-binary-search.md","hash":"e5b5b1f381a4011ef321f30d930b7e6b51ef6454","modified":1598712178494},{"_id":"source/_posts/11.dyld.md","hash":"9a5d0b14490de88c3dcebb8d5c6affcaf4b55ed9","modified":1598712178494},{"_id":"source/_posts/12.compiler-autorelease-opt.md","hash":"271cb477ad399a52cc1648ac4b4a350b217c17d2","modified":1598712178495},{"_id":"source/_posts/13.sqlite-os-shm.md","hash":"79c24a488b8856d173405467dc4efe501add7bb3","modified":1598712178496},{"_id":"source/_posts/14.gomobile-bind.md","hash":"d35992422356e12492e988c326d69f9cbb3fbe68","modified":1598712178496},{"_id":"source/_posts/15.Sqlite-OS.md","hash":"9afafc4cc1cf7b85f13b50494b02ccfdad59e533","modified":1598712178497},{"_id":"source/_posts/17.inside-sqlite-chapter-6.md","hash":"4a10e7786f5fb10f24526a1041f3e8b1c7f0cbb1","modified":1598712178498},{"_id":"source/_posts/18.db-system-design-imp(VM).md","hash":"37a2541c79b80c69ef931b34c97218195c26b1a6","modified":1598858173373},{"_id":"source/_posts/2.leetcode5.md","hash":"2c01adccd4b0bcc9133191b7c6097807a7c120fc","modified":1598712178499},{"_id":"source/_posts/19.SQLite-KeywordHash.md","hash":"492771bc4fa2f55fb6c255898f376a6b77564c84","modified":1598712178499},{"_id":"source/_posts/20.SQLite-Tokenize.md","hash":"129f5bfe447c09ad51eaf74215a07084753ed07c","modified":1598712178500},{"_id":"source/_posts/2020-08-17_db-system-design-imp(Pager).md","hash":"e06f5f3536fd95c39c5e568574266a3bff791d3e","modified":1598858494085},{"_id":"source/_posts/2020-08-21_db-system-design-imp(Transaction).md","hash":"cac711201a366c4eef541aed738a64251013521d","modified":1598858494085},{"_id":"source/_posts/2020-08-29_db_system_design_imp(WAL).md","hash":"68b7ffaff413fcb76b7b1d276a6a1ca8ff59a143","modified":1653134628558},{"_id":"source/_posts/2020-08-25_db-system-design-im(storage).md","hash":"6b19ba27f693213051db55fe7d29e69da03b8c98","modified":1598858494086},{"_id":"source/_posts/3.binding-symbols.md","hash":"91feb898da3290d3fbdc2960e3058289889a505d","modified":1598712178501},{"_id":"source/_posts/4.synchronized.md","hash":"70b7af21538e9e9271c700ec8cb43fb8f0ca4dc0","modified":1598712178501},{"_id":"source/_posts/5.OC-Block-imp.md","hash":"292cac00516608e7232529b4493308d6f4cad7de","modified":1598712178502},{"_id":"source/_posts/6.leetcode32.md","hash":"b2a8ab82a4d374d06deac99b1827823d6d2ee614","modified":1598712178502},{"_id":"source/_posts/7.leetcode46.md","hash":"9fcd6e50f7fd812ab1a3335f05d90155c50e5e96","modified":1598712178502},{"_id":"source/_posts/9.LeetCode-week-match.md","hash":"6647510b98c99b6266aa2687bc44eb8356242c2f","modified":1598712178503},{"_id":"source/_posts/8.leetcode47.md","hash":"bb9720e537822af51c82a4baa669b3befee70880","modified":1598712178503},{"_id":"source/tags/index.md","hash":"ed1a418b9e2b717d5d53e6d61c4838b1ae95d7dd","modified":1653127587933},{"_id":"source/categories/index.md","hash":"757adf3ab3e18694862b139cba48ec70a71e5c67","modified":1653127626072},{"_id":"themes/next/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1653121430560},{"_id":"themes/next/.eslintrc.json","hash":"9c0762486f24a8c5e60f8b6c875e4c4728942649","modified":1653121430560},{"_id":"themes/next/.gitattributes","hash":"ec43734985e1cafd53d88ded3020103f7416123c","modified":1653121430560},{"_id":"themes/next/.gitignore","hash":"417520c4dbbeab9c7e3ab10d944da0886366a0ee","modified":1653122276870},{"_id":"themes/next/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1653121430564},{"_id":"themes/next/LICENSE.md","hash":"68fc9a03d50fd4b5ea97092b05967d1819dea2c4","modified":1653122240655},{"_id":"themes/next/README.md","hash":"fb9016c2af9687beb68af174506ae54b11b8dbdf","modified":1653123114891},{"_id":"themes/next/_config.yml","hash":"cf51ba4ab02c00dd58e1f0c089dc4c67ad127ccd","modified":1653134793508},{"_id":"themes/next/_vendors.yml","hash":"bd8c9077ea59f836a6384d991178dfc22c7ad642","modified":1653123114891},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1653121430565},{"_id":"themes/next/package.json","hash":"cad27a427487eb491b6309773296a478c1caf068","modified":1653123114894},{"_id":"themes/next/renovate.json","hash":"cb29cc16e61b0b8a6dac34657d76822ae29ad5aa","modified":1653121430582},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"21cbff565a0445d3a880fff1ee417e309740a9ab","modified":1653122240654},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"330656d93b6c03df9fb1f2f0e3534c971969473b","modified":1653122276868},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"3e9fbb78e3dee0ca1dc886d0c28b0148ba0ca499","modified":1653121430562},{"_id":"themes/next/.github/config.yml","hash":"7984e665e9de481a0e0e51fca5668337713f810b","modified":1653121430562},{"_id":"themes/next/.github/issue_label_bot.yaml","hash":"fca600ddef6f80c5e61aeed21722d191e5606e5b","modified":1653121430562},{"_id":"themes/next/.github/label-commenter-config.yml","hash":"1097fc47beeacfc1edb0248c27b17bf64bde3565","modified":1653121430562},{"_id":"themes/next/.github/labeler.yml","hash":"5c4bc2bd561e6d9b33ee118cc12218c5de46f72d","modified":1653122276869},{"_id":"themes/next/.github/release-drafter.yml","hash":"423275ec021104b263cd88776936a8c8d6872b66","modified":1653122276869},{"_id":"themes/next/.githooks/install.js","hash":"4d77dbddf2eac1f3fc78f151d12ed22208ed655b","modified":1653122240653},{"_id":"themes/next/.githooks/pre-commit","hash":"f473eac1aaaa96c947d67988bbed140bbab1a821","modified":1653122240654},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1653121430565},{"_id":"themes/next/docs/AUTHORS.md","hash":"a648823121563c34a177ae91f5a774b5e29f01a0","modified":1653121430565},{"_id":"themes/next/docs/LICENSE.txt","hash":"f5b14f791b7cfa1d16da981d929152e088a5d1b8","modified":1653122240656},{"_id":"themes/next/layout/_layout.njk","hash":"20e4160cd0deb4fa272cc3aed0f43520b3cf4a9c","modified":1653122276873},{"_id":"themes/next/layout/archive.njk","hash":"d759f4d2cf5ddc6875ea250113a00662c1caf6d1","modified":1653121430581},{"_id":"themes/next/layout/category.njk","hash":"c68b7343d0f8145010f93351908cc36ef6212ec1","modified":1653122276882},{"_id":"themes/next/layout/index.njk","hash":"dd63e488ae8cc144335a5958acedf6a16edd7a92","modified":1653122276882},{"_id":"themes/next/layout/page.njk","hash":"6c40aa438c658eb7f0cd0f6a759f18b43e7e8f93","modified":1653122276882},{"_id":"themes/next/layout/post.njk","hash":"6abeb85fb3e4c382ed4bb6049b12a807e6226e67","modified":1653121430582},{"_id":"themes/next/layout/tag.njk","hash":"9e16ba20c28a7f2c6bc75aa427f48122301a30aa","modified":1653122276882},{"_id":"themes/next/languages/README.md","hash":"b2567e32805dda79601157351a07e5ca9fe01315","modified":1653121430567},{"_id":"themes/next/languages/ar.yml","hash":"bca66db21c015dbd32970d8708b898518a773e1e","modified":1653122240658},{"_id":"themes/next/languages/bn.yml","hash":"b5e2a35eb6fff56b6e32ce479e63b6fc5e44d5cb","modified":1653122292019},{"_id":"themes/next/languages/de.yml","hash":"4be7b8b76c81bf1853eb36d2e874b17546a0e792","modified":1653122240658},{"_id":"themes/next/languages/default.yml","hash":"814d81c27fed736055ee300e0a6505b26ff4313c","modified":1653122240658},{"_id":"themes/next/languages/en.yml","hash":"814d81c27fed736055ee300e0a6505b26ff4313c","modified":1653122240658},{"_id":"themes/next/languages/es.yml","hash":"b813da5aed9d73b809133db4dfb08f90ec56afd9","modified":1653122292019},{"_id":"themes/next/languages/fa.yml","hash":"6456d40dd42f44101d9d6e7054e9884e9163f948","modified":1653122240658},{"_id":"themes/next/languages/fr.yml","hash":"b15dc05afdc94de02e5d3fee4f8d3dc5594dd37e","modified":1653122240659},{"_id":"themes/next/languages/id.yml","hash":"14e794db4eca36b257994d81eb513e61d1edcbd6","modified":1653122240659},{"_id":"themes/next/languages/it.yml","hash":"c1eeab4992c76bfd436bb205ce58b1cfeef55ee6","modified":1653122240659},{"_id":"themes/next/languages/ja.yml","hash":"d48c4157e0e02e847aac7b513580d3364c81948c","modified":1653122240659},{"_id":"themes/next/languages/ko.yml","hash":"819c19eb9d142e5411f77cf3821d90f740ee114a","modified":1653123114892},{"_id":"themes/next/languages/nl.yml","hash":"ecb8e39c6225f3c068a5fdd569ee7dafd5c41a1f","modified":1653122240660},{"_id":"themes/next/languages/pt-BR.yml","hash":"a1f27b3a592fc58f17d247f5563ff4a90a3da5f2","modified":1653122240660},{"_id":"themes/next/languages/pt.yml","hash":"63a3e1e728ba5e6e22150de7331bb8a654f34960","modified":1653122240660},{"_id":"themes/next/languages/ru.yml","hash":"8c2b6361f2de17561c1a3eede2bf47b4e2ba6ce5","modified":1653122292019},{"_id":"themes/next/languages/si.yml","hash":"615d18d044f44df476d6bfbf73f7b0edc2632168","modified":1653122276872},{"_id":"themes/next/languages/tk.yml","hash":"519239e35c3bda7b62b00ff5d34644f45b16fe6a","modified":1653122276872},{"_id":"themes/next/languages/tr.yml","hash":"0bebba73d6f06c7dad61f80c0d7ad5f6f1791a01","modified":1653122276872},{"_id":"themes/next/languages/uk.yml","hash":"7dd24580c0865c5a7bc4d391855045366a598936","modified":1653122240661},{"_id":"themes/next/languages/vi.yml","hash":"c669c34da544a563ceae3e196addc9df6a78e024","modified":1653122240661},{"_id":"themes/next/languages/zh-CN.yml","hash":"5a3ab21210304efef736e96bad254f789f42c567","modified":1653122240661},{"_id":"themes/next/languages/zh-HK.yml","hash":"f195bb0502ffe66e850077a1af1033455ea65f93","modified":1653122276872},{"_id":"themes/next/languages/zh-TW.yml","hash":"92256b90028de9a1e79c6bc0e5885b93e7fb4b17","modified":1653122276873},{"_id":"themes/next/test/index.js","hash":"6bf0289846538be3e9a63809af98f00e1fbdd90b","modified":1653121430615},{"_id":"themes/next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"fc4dce84ed9a5d21d3a8833ff6d776c46f876115","modified":1653121430561},{"_id":"themes/next/.github/ISSUE_TEMPLATE/config.yml","hash":"c40ae7903b6cc99f94c9d45ac7ba8c2850bb1309","modified":1653122240654},{"_id":"themes/next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"4ecac91716eac59d7c2bc53cf6e95612d44da97b","modified":1653121430562},{"_id":"themes/next/.github/ISSUE_TEMPLATE/other.md","hash":"8cc5b5c116f6a052865a324512362f145d699202","modified":1653122240654},{"_id":"themes/next/.github/workflows/label-commenter.yml","hash":"434cc0674290958b1e9bbc46c3486f073c0722db","modified":1653123114890},{"_id":"themes/next/.github/workflows/labeler.yml","hash":"e9d51e93f239a2d4b69722c69db3463b4baf0f4c","modified":1653123114890},{"_id":"themes/next/.github/workflows/linter.yml","hash":"b6c111344bc0f3500ca69d7590791ff85ef1090d","modified":1653123114890},{"_id":"themes/next/.github/workflows/lock.yml","hash":"e48d1ced9a673d3f0911a700d3e68c0f4ca79263","modified":1653122276869},{"_id":"themes/next/.github/workflows/release-drafter.yml","hash":"4f3af81009cb922be91f718a67425377515ea69d","modified":1653121430563},{"_id":"themes/next/.github/workflows/tester.yml","hash":"80a20c3a7522249f051a48239db41d1317e9b552","modified":1653123114890},{"_id":"themes/next/docs/ru/README.md","hash":"3125f0cb4cdb448d9b92292f64d7612013fdd165","modified":1653123114892},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"7a06d443f374bd1e84294067a0ac796afd9fbe60","modified":1653122240657},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"a089f7a8368ab0b7d7b9b7ec0ac3767a453435df","modified":1653122276871},{"_id":"themes/next/docs/zh-CN/README.md","hash":"ef609aa9174ad61b7ab0bb578de57fec86d9b767","modified":1653123114892},{"_id":"themes/next/scripts/events/index.js","hash":"3ce10d4cce94e3d4c482c2e18bb6f0f0ca380d3d","modified":1653123114894},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"872f01cb10e422a648ea505436532e776e92926b","modified":1653121430585},{"_id":"themes/next/scripts/filters/locals.js","hash":"9eb5310664759931287dd28ea39165dfb67f12ed","modified":1653122292023},{"_id":"themes/next/scripts/filters/minify.js","hash":"3abdcb715562414063e0fb3eeb6244ce59c477e0","modified":1653122292024},{"_id":"themes/next/scripts/filters/post.js","hash":"30e03a1d4828259f82d46e64cbfe2955b6cff9a9","modified":1653123114895},{"_id":"themes/next/scripts/helpers/engine.js","hash":"d292b78485e8e8055712b0ed6de7cf559c5fbdcd","modified":1653123114896},{"_id":"themes/next/scripts/helpers/font.js","hash":"3394185a7f0393c16ce52c8028f90da3e9239c55","modified":1653122240668},{"_id":"themes/next/scripts/helpers/navigation.js","hash":"78107021101553c3d23e89290f7530b60cf4aa86","modified":1653123114896},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"9a07f2d979fc8fe0c5e07d48304187b9b03ea7ff","modified":1653122276887},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"a11b71ba0c5012e2cdcab31c15439156b215563e","modified":1653122276887},{"_id":"themes/next/scripts/helpers/next-vendors.js","hash":"afdd6a188a74c188f0dd154fac70efd4080ca262","modified":1653121430586},{"_id":"themes/next/scripts/tags/button.js","hash":"c6ad2ed544fbb25ecb5d820c36e76302504271b7","modified":1653121430587},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"935a311142a409c1896b3ae3f01fe7a9e2db1134","modified":1653121430587},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"92c19d796bdb3320df9caea59bf52df7a95d9da9","modified":1653121430587},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"9ed799c329abf830f623689d7e136991256a24ca","modified":1653122276887},{"_id":"themes/next/scripts/tags/index.js","hash":"17f9451ce1f10f78437f52218757d38d4e1591b0","modified":1653121430587},{"_id":"themes/next/scripts/tags/label.js","hash":"8a73348186113bae0a51ea2f891c1bb882fab05a","modified":1653121430587},{"_id":"themes/next/scripts/tags/link-grid.js","hash":"18a483c2d5afd701f6080ffdddf2d1321370336c","modified":1653122276887},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"4fb01ca650fa8b256b8d48f50dc1b18350bd3d6d","modified":1653122240669},{"_id":"themes/next/scripts/tags/note.js","hash":"7b94ddb46b7d4b0fe815f2fbe4bd375f07f55363","modified":1653121430588},{"_id":"themes/next/scripts/tags/pdf.js","hash":"344636b6fd7e27e8831c1e194039afc0d61931cd","modified":1653121430588},{"_id":"themes/next/scripts/tags/tabs.js","hash":"0eabe51da40b4b13e16419c8fe02452d9a4fef73","modified":1653122276888},{"_id":"themes/next/scripts/tags/video.js","hash":"2ee926448583be8f95af1f2884ae2c9c4830151d","modified":1653121430588},{"_id":"themes/next/layout/_macro/post-collapse.njk","hash":"1a30d751871dabfa80940042ddb1f77d07d830b9","modified":1653121430571},{"_id":"themes/next/layout/_macro/post.njk","hash":"434b3e76a040a816169e1929657e4176e7b8164c","modified":1653123114892},{"_id":"themes/next/layout/_macro/sidebar.njk","hash":"eb786e8b35e354287cda345c524cd35ec955f692","modified":1653134253678},{"_id":"themes/next/layout/_partials/comments.njk","hash":"d0c470b0f6690aa217e9ada848c5e2e73fb27c6f","modified":1653123114892},{"_id":"themes/next/layout/_partials/footer.njk","hash":"19713f472972caac33ae5fbcfe9105da61257de4","modified":1653122276873},{"_id":"themes/next/layout/_partials/languages.njk","hash":"e43f22198cccb5f6e306b1ce0d28d12a4fb891f8","modified":1653122240663},{"_id":"themes/next/layout/_partials/pagination.njk","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1653121430574},{"_id":"themes/next/layout/_scripts/index.njk","hash":"6668878a0f9a1166c6a879755f54a08d942da870","modified":1653122276876},{"_id":"themes/next/layout/_partials/widgets.njk","hash":"852a750524decf1efa587cd52b09e387ed8315de","modified":1653122240664},{"_id":"themes/next/layout/_scripts/vendors.njk","hash":"be80b9fe415a9a09d74c28e230995fd292dfc123","modified":1653122276876},{"_id":"themes/next/layout/_third-party/fancybox.njk","hash":"844559f46e2ff1c8be234d5763703106e2072a7b","modified":1653122276879},{"_id":"themes/next/layout/_third-party/index.njk","hash":"d41eeb262978e34de4679d8971a9e7ac5d90ecbc","modified":1653122276879},{"_id":"themes/next/layout/_third-party/pace.njk","hash":"d7ad5714079f7f65446f880baf14722435ca9061","modified":1653122276880},{"_id":"themes/next/layout/_third-party/quicklink.njk","hash":"0efed71ed530447718c4ea5bbd5fc8695b0b0d5f","modified":1653122276880},{"_id":"themes/next/layout/_third-party/rating.njk","hash":"1bcdbc7fde26d6d9ef4e7fa43ffcff5a9506b20e","modified":1653122276880},{"_id":"themes/next/source/css/_colors.styl","hash":"3c6798c10cc220d83481cb3f3782e78558cee789","modified":1653122276888},{"_id":"themes/next/source/css/_mixins.styl","hash":"32d31cb5a155681c19f5ad0bb56dcb08429f93ef","modified":1653122292025},{"_id":"themes/next/source/css/main.styl","hash":"78ce791cc4ac95386cf6839ca72f5f7b51f86ee9","modified":1653122240678},{"_id":"themes/next/source/css/noscript.styl","hash":"263eddabfae40e54c0591e7baa8403ade8cdd56d","modified":1653123114897},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1653121430606},{"_id":"themes/next/source/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1653122276902},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1653121430606},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1653121430606},{"_id":"themes/next/source/images/logo-algolia-nebula-blue-full.svg","hash":"b85e274207b1392782476a0430feac98db1e7da0","modified":1653121430607},{"_id":"themes/next/source/images/logo.svg","hash":"2cb74fd3ea2635e015eabc58a8d488aed6cf6417","modified":1653122276903},{"_id":"themes/next/source/images/spade-logo-next.png","hash":"28778f643f771955bda170923f842c21bb567d32","modified":1653134928389},{"_id":"themes/next/source/images/spade-logo-next.svg","hash":"5f1736ed90b046f36374919090822b96894f9090","modified":1653134930282},{"_id":"themes/next/source/images/spade-logo.png","hash":"96977336310ca4a0401c1cc396179012ddf6b5f8","modified":1653120339042},{"_id":"themes/next/source/images/spade-logo.svg","hash":"4fd1156094ba99ceebb68436bfdcdcc529ed8cda","modified":1653120524719},{"_id":"themes/next/source/js/bookmark.js","hash":"0f563ffbf05fad30e854e413ab17ff7164ab5a53","modified":1653122276903},{"_id":"themes/next/source/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1653122276903},{"_id":"themes/next/source/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1653122276903},{"_id":"themes/next/source/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1653122276903},{"_id":"themes/next/source/js/motion.js","hash":"f7c825cbff11885fa0dffa64824fd00e505d6a8d","modified":1653123114898},{"_id":"themes/next/source/js/next-boot.js","hash":"48497e2156a10155dc42311633a110c9685692c9","modified":1653122276903},{"_id":"themes/next/source/js/pjax.js","hash":"919f5281c4a04d11cfd94573ecf57b3dbabd3cc8","modified":1653122276903},{"_id":"themes/next/source/js/schedule.js","hash":"a1333258726caf84f368a8f8454639c7dc1626bb","modified":1653123114898},{"_id":"themes/next/source/js/utils.js","hash":"e447160d342b1f93df5214b6a733441039ced439","modified":1653122276908},{"_id":"themes/next/test/helpers/font.js","hash":"342ef3c6fd2dcca2a8802a516ed6d7f389fd2ca2","modified":1653122240681},{"_id":"themes/next/test/helpers/index.js","hash":"63ba28afed697f7b3574436b1133b8ecc9c0c357","modified":1653121430615},{"_id":"themes/next/test/helpers/next-url.js","hash":"a91d880cb75e0a8e65a7be4c7362b2c8ebfb7c4f","modified":1653122276909},{"_id":"themes/next/test/tags/button.js","hash":"48f2aa4c513e9e24bd6a811410520b74cd7ea88b","modified":1653121430616},{"_id":"themes/next/test/tags/caniuse.js","hash":"aa5e728445caeaf7c2ccd0f3fcb2cad0c93ca6d1","modified":1653121430616},{"_id":"themes/next/test/tags/center-quote.js","hash":"7667342fd1a1417eaf6a254012b84ae40e8d13dd","modified":1653121430616},{"_id":"themes/next/test/tags/group-pictures.js","hash":"5c68ae0184f9da6e00ba199f2554d503d8e6da71","modified":1653122276909},{"_id":"themes/next/test/tags/index.js","hash":"e8779e54f0979b221858f8bb74dd081bb503b910","modified":1653121430617},{"_id":"themes/next/test/tags/label.js","hash":"4ebf3698c258ca978b997acbdd0dece44069c09d","modified":1653121430617},{"_id":"themes/next/test/tags/link-grid.js","hash":"43d298fafb7c45a874b766d443843bd26346e689","modified":1653122276909},{"_id":"themes/next/test/tags/mermaid.js","hash":"ab77be5f3c6d9a57c7b9dda6decf1906a736fef9","modified":1653122240681},{"_id":"themes/next/test/tags/note.js","hash":"3dcfcd65bf9f326972ea7571fdb1444200f5d07e","modified":1653121430617},{"_id":"themes/next/test/tags/pdf.js","hash":"fd6ea5123560a90f7e7c1eface23dbe1455db25f","modified":1653121430617},{"_id":"themes/next/test/tags/tabs.js","hash":"d63722919f9da2e44d6b952801e10a2915ea9c12","modified":1653121430617},{"_id":"themes/next/test/tags/video.js","hash":"b796fc4dceb20a30e730c322bb5474c0162464cc","modified":1653121430618},{"_id":"themes/next/test/validate/index.js","hash":"5a95ccc8598667535bd022e988055c0e019f3670","modified":1653122240681},{"_id":"themes/next/scripts/events/lib/config.js","hash":"c8b59b404f5d2a0b3b5cd1a6c9a10af5f30e43b5","modified":1653122292022},{"_id":"themes/next/scripts/events/lib/highlight.js","hash":"6aec7b2c38c50989a23bfaa0d560e75c7f553e12","modified":1653121430583},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"d987709267a1bc6e5014411e9983d7c49c102c16","modified":1653122276883},{"_id":"themes/next/scripts/events/lib/navigation.js","hash":"dd3562686d95a50375e6fd32e717ccb0d99c1e3d","modified":1653123114895},{"_id":"themes/next/scripts/events/lib/utils.js","hash":"ec996d0673f766167c86df0966e9da1ae036e103","modified":1653123114895},{"_id":"themes/next/scripts/events/lib/vendors.js","hash":"0d94ac5daa95f99046d66160d9f0f34ee786736c","modified":1653123114895},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"7fa8701c86485b2fe7324e017101a32417902397","modified":1653122276884},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"19a402a225c31edffc50f202a14e0d582d3db23e","modified":1653123114895},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"93ee5f9109dad885dc38c49bcee630c10f9dce6e","modified":1653121430584},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"7f71d6b271ba65ff333d5682e7575711d368c0d2","modified":1653122276884},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"135b87d151055eefdbc711d9e704b112b3214a84","modified":1653122276884},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"7bb7dafdd7f6bca8464b54e17e552ce7f1714195","modified":1653122276885},{"_id":"themes/next/scripts/filters/comment/isso.js","hash":"ff8b5b5145220a17d0ecd9508ba9bd2d3b2da47d","modified":1653122240667},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"5a07d8bb52bc1d51a624ca8db54be144566c306b","modified":1653122276885},{"_id":"themes/next/scripts/filters/comment/utterances.js","hash":"d3bded697bc32dace689d2a6dfb6eb7514169d15","modified":1653122240668},{"_id":"themes/next/layout/_partials/head/head-unique.njk","hash":"8da52a144060db1a0a088ccb2e6cc8376d1fce70","modified":1653123114893},{"_id":"themes/next/layout/_partials/head/head.njk","hash":"0ba2bf0266f1fcb8edbd961869f8521b29685c56","modified":1653122292020},{"_id":"themes/next/layout/_partials/header/brand.njk","hash":"aff4613756456be26415febc668860fdab8d33c5","modified":1653122276874},{"_id":"themes/next/layout/_partials/header/index.njk","hash":"650de421a8ce4cf685428ffbe0087ff84cbd1356","modified":1653122276874},{"_id":"themes/next/layout/_partials/header/menu-item.njk","hash":"41a8b0cc16f60fa085cb719d07216d86b6bc4bf8","modified":1653123114893},{"_id":"themes/next/layout/_partials/header/menu.njk","hash":"ee6fc2f111572d3eeab0a2fecbb2d6b3e37ab26b","modified":1653123114893},{"_id":"themes/next/layout/_partials/header/sub-menu.njk","hash":"06480d8ec5f0b87eafd47f082f07968d7282dd5c","modified":1653123114893},{"_id":"themes/next/layout/_partials/page/breadcrumb.njk","hash":"89825e75cc45e9709fa6ba89883669eedaff6f46","modified":1653123114894},{"_id":"themes/next/layout/_partials/page/categories.njk","hash":"17156d99941f28a225951ffdcfa9a115e20dc2d2","modified":1653121430573},{"_id":"themes/next/layout/_partials/page/page-header.njk","hash":"7ed4f102a1825195cff8d7995bf9219f323a9034","modified":1653121430573},{"_id":"themes/next/layout/_partials/page/schedule.njk","hash":"0f4bc8e257da60f77c0c1738607b2bde55810684","modified":1653123114894},{"_id":"themes/next/layout/_partials/page/tags.njk","hash":"a18d1598e36cc72f2b0b24c3cc3c5990dfaa3254","modified":1653121430573},{"_id":"themes/next/layout/_partials/post/post-copyright.njk","hash":"133942922e34abae9e4de7ea5591d77c0caa4b37","modified":1653121430574},{"_id":"themes/next/layout/_partials/post/post-followme.njk","hash":"154df0bb323c332d8c25343f258ee865e5553423","modified":1653121430574},{"_id":"themes/next/layout/_partials/post/post-footer.njk","hash":"bde2c7356d9362972bde41cc206d5816f8ed714d","modified":1653122276875},{"_id":"themes/next/layout/_partials/post/post-meta.njk","hash":"9fa47e4fb342811da590ee4adc91cf81118c0a39","modified":1653122276875},{"_id":"themes/next/layout/_partials/post/post-related.njk","hash":"57eca76cfbbe9a65bc2a77f1deebf003ed335673","modified":1653122292021},{"_id":"themes/next/layout/_partials/post/post-reward.njk","hash":"002b51d0cae3f2e2e008bdc58be90c728282de5b","modified":1653122276875},{"_id":"themes/next/layout/_partials/search/algolia-search.njk","hash":"efb2b6f19df02ba5ae623a1f274fff52aed21e6f","modified":1653122240663},{"_id":"themes/next/layout/_partials/search/index.njk","hash":"8f6f256ab3b351ffc80f1f3f1d9834e9a7cfac31","modified":1653121430575},{"_id":"themes/next/layout/_partials/search/localsearch.njk","hash":"661f7acae43f0be694266323320f977d84119abe","modified":1653122240664},{"_id":"themes/next/layout/_partials/sidebar/site-overview.njk","hash":"3d8591bb92df77ceb9d5b07bc76da1ca89e5bd76","modified":1653122276876},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.njk","hash":"6215309aee028dcb734452beec448c5afb6c63fc","modified":1653122276876},{"_id":"themes/next/layout/_third-party/analytics/cloudflare.njk","hash":"c978e9efd472c4825f93b83524b11f1c4f7efaab","modified":1653122240664},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.njk","hash":"d89066ff53879693f023e540d59c86137172c529","modified":1653122276876},{"_id":"themes/next/layout/_third-party/analytics/growingio.njk","hash":"8afaa772c390bd9d53a5cff9645ac3168334eb98","modified":1653122276877},{"_id":"themes/next/layout/_third-party/analytics/index.njk","hash":"45477a04cf2b3c077061c8c3ada216c1ae288e0e","modified":1653122292021},{"_id":"themes/next/layout/_third-party/analytics/microsoft-clarity.njk","hash":"9dc00fcb0a05899f048eace9f9160b78956655d5","modified":1653123114894},{"_id":"themes/next/layout/_third-party/comments/changyan.njk","hash":"d1c950f8fbdf85e7a3eae5463767a89e858e8220","modified":1653122276877},{"_id":"themes/next/layout/_third-party/comments/disqus.njk","hash":"9375b19a89b7fa9474e558d085af5448d4c5c50c","modified":1653122276878},{"_id":"themes/next/layout/_third-party/comments/disqusjs.njk","hash":"0749cb6902baecdfd01f779a2a2513f6d2f6a823","modified":1653122276878},{"_id":"themes/next/layout/_third-party/comments/gitalk.njk","hash":"b63b7e2ede0d3e66e732fa1a06bda9b19e1e85d4","modified":1653122276878},{"_id":"themes/next/layout/_third-party/comments/isso.njk","hash":"64cc3bdaf644fd32c0d0a247f29f5b6904da9af3","modified":1653122276878},{"_id":"themes/next/layout/_third-party/comments/livere.njk","hash":"3b13b09fba84ec6000886890a6710736a2b8fafe","modified":1653122276878},{"_id":"themes/next/layout/_third-party/comments/utterances.njk","hash":"5a94032bc3512a10ad4328fc19ec07b819a1d687","modified":1653122276879},{"_id":"themes/next/layout/_third-party/chat/chatra.njk","hash":"d7263fca16d0278ccf1f6aa1c6df6902a6344a09","modified":1653122276877},{"_id":"themes/next/layout/_third-party/chat/gitter.njk","hash":"f8cc14b7aa949999a1faaeb7855e2f20b59a386d","modified":1653122276877},{"_id":"themes/next/layout/_third-party/chat/tidio.njk","hash":"02aab857c27fc103216029be991688b12a73a525","modified":1653122276877},{"_id":"themes/next/layout/_third-party/math/index.njk","hash":"abf37fc55aa86702118e8fdf5bf2d389dd589aa0","modified":1653122276879},{"_id":"themes/next/layout/_third-party/math/katex.njk","hash":"d82c24136bbd3443b85f07f5579845833b594684","modified":1653122276879},{"_id":"themes/next/layout/_third-party/math/mathjax.njk","hash":"3677017fd4572b158311f5f5d870590ab25184e0","modified":1653122276879},{"_id":"themes/next/layout/_third-party/search/algolia-search.njk","hash":"24ed76e0c72a25ac152820c750a05826a706b6f4","modified":1653122276880},{"_id":"themes/next/layout/_third-party/search/localsearch.njk","hash":"e45ea3542cdc9ed7ec8447b5e6f35df4c5e82758","modified":1653122276881},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.njk","hash":"a4bc501da0f22f7e420f0ca47e83988ce90b1368","modified":1653121430580},{"_id":"themes/next/layout/_third-party/statistics/firestore.njk","hash":"d32ebe94560fa95824478ebbff531bffc47b194d","modified":1653122276881},{"_id":"themes/next/layout/_third-party/statistics/index.njk","hash":"568ddf7955d11d93fb5e842b403a7ac8b1b7fdb1","modified":1653122240665},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.njk","hash":"2446e748cdc102c78492216319ac02148db7daf6","modified":1653122276881},{"_id":"themes/next/layout/_third-party/tags/mermaid.njk","hash":"099e031f52fb8e47b3af5b2684737efc9e643ee7","modified":1653122276881},{"_id":"themes/next/layout/_third-party/tags/pdf.njk","hash":"2c81984cc4f5123103460442f6e046f5b6c97127","modified":1653122276881},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"96e0a7c2a65ce68215e17e369085b2ea2f1334f2","modified":1653121430604},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"e1fbf169b9b6a194b518240cbd06ec3c48b83d61","modified":1653121430604},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"e3be898f5ebcf435a26542653a9297ff2c71aeb0","modified":1653121430605},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"c65536a128b9bc9dbe2fbb1b235a3cded2891002","modified":1653121430605},{"_id":"themes/next/source/css/_variables/base.styl","hash":"163c7441d777bee87042d475e6ce0fde199add28","modified":1653122276902},{"_id":"themes/next/source/js/schemes/muse.js","hash":"9794bd4fc6a458322949d6a0ade89cd1026bc69f","modified":1653123114898},{"_id":"themes/next/source/js/third-party/fancybox.js","hash":"c098d14e65dd170537134358d4b8359ad0539c2c","modified":1653122276906},{"_id":"themes/next/source/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1653122276907},{"_id":"themes/next/source/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1653122276907},{"_id":"themes/next/source/js/third-party/rating.js","hash":"4e92c2d107ba47b47826829f9668030d5ea9bfb8","modified":1653122276907},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"bab653bcf226311381e8411a0492202f1bf1fce9","modified":1653122276889},{"_id":"themes/next/source/css/_common/components/index.styl","hash":"fe1868f47681e00a33a96199302be85377282f63","modified":1653122276889},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"90a86045a33c1bae49fc2f6fa1e1b53170c7f77b","modified":1653122276892},{"_id":"themes/next/source/css/_common/outline/index.styl","hash":"8e34df131830d4fa3725e4590a672ba1cf1903e5","modified":1653122276897},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"64775c729512b30b144ab5ae9dc4a4dfd4e13f35","modified":1653122276897},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"d0a7c99095f490b0d2ed6b1be43d435960798cec","modified":1653122276899},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a042571d85ff7265f799004239a45f36b716b8a6","modified":1653121430596},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"e4fecc889ba3317a64e9abba5842c79dff9b7827","modified":1653121430596},{"_id":"themes/next/source/css/_common/scaffolding/index.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1653121430597},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1653121430597},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"b5c7782368889fa9fd93807d28ff2daf270e3703","modified":1653122276899},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"e840b23d33023e6d45e018f6e84b683dd56efd8d","modified":1653122240675},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"572a41499391677d84b16d8dbd6a996a3d5ce041","modified":1653121430600},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"fd49b521d67eaccc629f77b4e095cb7310327565","modified":1653122240676},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"4817e77577896ab5c0da434549917ee703a3f4cf","modified":1653122240676},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"5604ac1e161099a4d3e5657d53507268866dc717","modified":1653121430601},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"fb550935d374e0bdf1097fce187337dc05cad3e1","modified":1653123114897},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"be6cf377ae8f4a01ee76f9b3014e74161d4d5d17","modified":1653123114897},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"ab16a3dcdc0393b9b582ef59dcc13db9320e917c","modified":1653121430602},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"06080fd963c904d96c00eff098a284e337953013","modified":1653121430602},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"82a29572dd90451f75358a2ee2522b87304a0bb8","modified":1653121430602},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"b7f48be3c43bfa393d62142544a5487a67871713","modified":1653123114897},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"944364893bd7160d954c10ba931af641c91515a4","modified":1653122276901},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1653121430603},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1653121430603},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"b741ab96e73370711c63a6581159f2ea8b5bfa1b","modified":1653122276901},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"6eee86c8f0175d6c09e434053516cd8556f78d44","modified":1653121430603},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"72dc825c50357402c342d62ab60fc0c478ab6bc1","modified":1653122240677},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"d9141e6e14a56b5952488101e9a8388c2170e270","modified":1653122276902},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"778ed2ad5643b93970c95626b325defeb586733f","modified":1653122240678},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"8000075b227749a7495eaf417cac6ccfbe441580","modified":1653121430604},{"_id":"themes/next/source/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1653122276904},{"_id":"themes/next/source/js/third-party/analytics/google-analytics.js","hash":"59684383385059dc4f8a1ff85dbbeb703bcdbcb5","modified":1653122276904},{"_id":"themes/next/source/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1653122276904},{"_id":"themes/next/source/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1653122276905},{"_id":"themes/next/source/js/third-party/chat/gitter.js","hash":"cc38c94125f90dadde11b5ebac7d8bf99a1a08a2","modified":1653122276905},{"_id":"themes/next/source/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1653122276905},{"_id":"themes/next/source/js/third-party/comments/changyan.js","hash":"260d1a77d6a3bb33a579d3e4cca1997003e799b5","modified":1653122276905},{"_id":"themes/next/source/js/third-party/comments/disqus.js","hash":"e1cc671b0d524864fd445e3ab4ade9ee6d07e565","modified":1653122276905},{"_id":"themes/next/source/js/third-party/comments/disqusjs.js","hash":"b6c58f098473b526d6a3cd35655caf34b77f7cff","modified":1653122276905},{"_id":"themes/next/source/js/third-party/comments/gitalk.js","hash":"0ec038cf83e8ec067534f16a54041e47a3c1e59a","modified":1653122276906},{"_id":"themes/next/source/js/third-party/comments/isso.js","hash":"753a873b6f566aff5ba77ca23f91b78eb880ca64","modified":1653122276906},{"_id":"themes/next/source/js/third-party/comments/livere.js","hash":"2247d88c934c765c43013337860774aaa99f0b31","modified":1653122276906},{"_id":"themes/next/source/js/third-party/comments/utterances.js","hash":"f67f90eb03e284c82da2b8cf2f1e31801813c16d","modified":1653122276906},{"_id":"themes/next/source/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1653122276906},{"_id":"themes/next/source/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1653122276906},{"_id":"themes/next/source/js/third-party/search/algolia-search.js","hash":"fdb7b7cef1a147d897e7f7cd8903b58368ec2062","modified":1653123114898},{"_id":"themes/next/source/js/third-party/search/local-search.js","hash":"4536cb6d0a9bbaaa86fab3fa0101f6a3a3ec5a76","modified":1653123114899},{"_id":"themes/next/source/js/third-party/statistics/firestore.js","hash":"411a72df581f5b21317dc28633c7993207eb9e1c","modified":1653123114899},{"_id":"themes/next/source/js/third-party/statistics/lean-analytics.js","hash":"5a928990856b8e456f0663cf3b6b406733672e39","modified":1653122276908},{"_id":"themes/next/source/js/third-party/tags/mermaid.js","hash":"f27d817b0c2138dd3215b1f46af0753f60a008f3","modified":1653123114899},{"_id":"themes/next/source/js/third-party/tags/pdf.js","hash":"af78c22f0e61c8c8aa8794e585e0d632c6d4fcb8","modified":1653122276908},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"8afdc311c6b8db121758371f95cf1c5e77354f42","modified":1653121430589},{"_id":"themes/next/source/css/_common/components/pages/index.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1653122240669},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"6b816c2511242ee503fb5f34cd3e4dcdafc06b85","modified":1653122240669},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"1a81d1a71fcf0699629ce6e72dfd0a15f3a2dd0a","modified":1653121430590},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"b6e2eb1550a7845cb2adf86081a4ab6c7bde1e68","modified":1653121430589},{"_id":"themes/next/source/css/_common/components/post/index.styl","hash":"d0805a763176b3c0003967401644f41dfe3bc9e8","modified":1653122276889},{"_id":"themes/next/source/css/_common/components/post/post-body.styl","hash":"d757768a58743601d0d84158ba955eb15d4c3c01","modified":1653123114896},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"ec37a36e94ba791663607a5022f763915778578f","modified":1653122240670},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"fc1a7bac6493f24aa50665574f37f3dd954f210c","modified":1653122276890},{"_id":"themes/next/source/css/_common/components/post/post-footer.styl","hash":"1d284f3ea03ba9b4feb76b375e539a8e0bccf1c3","modified":1653122240670},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"aa366d37389760c8595529b850f461569577a1c5","modified":1653121430591},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"010c901e4ef49a606f8a350efbf09044e76d2ff3","modified":1653122276890},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"9ac6f477177264c26a46e8333b8456720a0444dc","modified":1653122240670},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"07cff69f2d57e6321595f64c16d8b763dc88df6a","modified":1653122276891},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"b6677dc2a2368084ab82bb4f145ac79e5966c150","modified":1653122276891},{"_id":"themes/next/source/css/_common/components/third-party/disqusjs.styl","hash":"c2326ee3e8b724d99c24a818ddee32813ea5bf89","modified":1653122276892},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"070737d101e7cd58e997e8c7af09958268c43a21","modified":1653122276893},{"_id":"themes/next/source/css/_common/components/third-party/gitter.styl","hash":"35104dc6883a61c31e0e368dac8ac2f697be62fe","modified":1653122292024},{"_id":"themes/next/source/css/_common/components/third-party/index.styl","hash":"979486a41a81f2a9fd8b0b87c4f87d6416c68c7d","modified":1653122292025},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"9d995eb4871a6c273d9d51558676a1fdabf69e72","modified":1653122276894},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"41ed817e1eb64078074e245e771446ee041e5790","modified":1653122276894},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"e72799ce3f9b79753e365b2f8c8ef6c310668d4a","modified":1653122276894},{"_id":"themes/next/source/css/_common/components/third-party/utterances.styl","hash":"56d90ae0559caa55b75f3c300ff2711f9ed65fc4","modified":1653122276895},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"e74f4bb47a101b014ee2a1783c87f3b87323f9a0","modified":1653122276896},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"38c64c2d04e46848382bfa246a0e9c508294767b","modified":1653122276896},{"_id":"themes/next/source/css/_common/outline/header/index.styl","hash":"ff642130354a0b3be0d708c43044ed4d710b5e83","modified":1653123114896},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"392fd53a8dd4e3f33a853ebb24290a622300e0ff","modified":1653122240672},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"759e582d34d08e3386c55d87a835a9523608619f","modified":1653122276896},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"bf3ad8b4268f763a1e26377681644887694bc009","modified":1653122240673},{"_id":"themes/next/source/css/_common/outline/sidebar/index.styl","hash":"cee43480eba028c37d51cb620c2d81486aa24e01","modified":1653122276897},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"52fc98b1435129eb3edb9293ced9e507741f1350","modified":1653122240673},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"5b38ac4a0f1ade0e681aff0e3366c481d9cf3dcd","modified":1653121430595},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"9950c3188a28e1c63b5498b7bdcd14b12ace3e28","modified":1653121430595},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"b926e368f702f8686aaa2eb98d3d2e533418958c","modified":1653122276897},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"fbdb63c6a8887d19b7137325ba7d6806f728139c","modified":1653121430595},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"ee94a1a27090ad24e3ed579093088d97ff96d77d","modified":1653122276898},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"3103b81fc76b59e1e2c161e2c484625c770ed66f","modified":1653122276898},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"021a37cf178440cc341940a299d3bca359996c6b","modified":1653122276898},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"26dd0adfcb1db6df29c6090c8d7e9b5a43583fb0","modified":1653122276898},{"_id":"themes/next/source/css/_common/outline/footer/index.styl","hash":"8b9407e5cfd0571ef8de7df19022b268f962fa2f","modified":1653122276895},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"83ee4993710fc8daa1c8dbfccd5d5091fd244c30","modified":1653121430597},{"_id":"themes/next/source/css/_common/scaffolding/highlight/index.styl","hash":"f2328caa94645836e06fb39a6a9c9a84ed68a8b5","modified":1653122276899},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"d6418fd2bbfba7b73ddf11ec62db9637fdf5d8af","modified":1653122276899},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"393ff96234e4196b569d4b11496774eb78e147de","modified":1653121430598},{"_id":"themes/next/source/css/_common/scaffolding/tags/index.styl","hash":"3f76c73a891bbc10679753e702feba9e8a5ffdd2","modified":1653122276900},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"debee14539272fbe3835a7d3853af2230baa3501","modified":1653122240675},{"_id":"themes/next/source/css/_common/scaffolding/tags/link-grid.styl","hash":"7f8a7345e6537a62cd9e9a94c8f7065b541d9b04","modified":1653122276900},{"_id":"themes/next/source/css/_common/scaffolding/tags/mermaid.styl","hash":"48d35dba575a7c9e8845b16652e76b7d4a4646de","modified":1653122276900},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"d27fbf7799695295dd5860a161a13ac4d90c5ba4","modified":1653122276900},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b6654a1d7cf82577d8263faffee8af3ad4a5c0e8","modified":1653122276900},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"7a39bcce7274284e87388743db62afc847fe6897","modified":1653123114896},{"_id":"themes/next/source/images/timg.gif","hash":"1ff7e8df9671f590629a9c2228fa1e4b3bba8af3","modified":1653123761030},{"_id":"public/categories/index.html","hash":"219d6b45baaab08cf9ddd3382cdbca2a2f631e15","modified":1653134803914},{"_id":"public/tags/index.html","hash":"8e82ae8acf8b2f2b2781eca5e8475141ae96457f","modified":1653134803914},{"_id":"public/2020/01/13/9.LeetCode-week-match/index.html","hash":"b1d5b1a53b4fb2652794c2c9b36901bf577d4377","modified":1653134803914},{"_id":"public/archives/index.html","hash":"7e54814334daabb6e7887f8b9aa3b6344724f099","modified":1653134803914},{"_id":"public/archives/page/2/index.html","hash":"db422465daf8bb425dd166e8f94a76448690670e","modified":1653134803914},{"_id":"public/archives/page/3/index.html","hash":"36f389d752c1610e465295ffbb44150984943fcc","modified":1653134803914},{"_id":"public/archives/2019/index.html","hash":"d07a81f3e6b5399ae9ba985623395171c2bd24cb","modified":1653134803914},{"_id":"public/archives/2019/12/index.html","hash":"71e7fafd2172476e86fc8de2992c3968e2fcfe15","modified":1653134803914},{"_id":"public/archives/2020/index.html","hash":"4ad9947567f958ad1e3d7e4795347e9146193c17","modified":1653134803914},{"_id":"public/archives/2020/page/2/index.html","hash":"028d0db5554cc97e3a4b85f636c4fa39737f8bc1","modified":1653134803914},{"_id":"public/archives/2020/01/index.html","hash":"a1bcd05bc9db759848a27c2c45e768e6d20984d8","modified":1653134803914},{"_id":"public/archives/2020/03/index.html","hash":"543f0384be2ccf7cc6a6d103ebeed14895ea8417","modified":1653134803914},{"_id":"public/archives/2020/04/index.html","hash":"e0acd11c03c28686711565c3a85d7c644d15732a","modified":1653134803914},{"_id":"public/archives/2020/06/index.html","hash":"09e98068f541a9e7295db6a9ec6b0535bfaa1804","modified":1653134803914},{"_id":"public/archives/2020/07/index.html","hash":"61e8fb83a079db8b371ea0cb50c06dfefa6b94f7","modified":1653134803914},{"_id":"public/archives/2020/08/index.html","hash":"76a22705f73d704aba0373d835782f90ac3c06a7","modified":1653134803914},{"_id":"public/categories//index.html","hash":"222d9d7f750683a37efc06e1ae67697bb21fe7c7","modified":1653134803914},{"_id":"public/categories//index.html","hash":"96861c93fde91904f47f42771ce456ea6d2ffb63","modified":1653134803914},{"_id":"public/categories/object-c/index.html","hash":"fd014658ea6839e4d65c49efcd8dd2da91c923f4","modified":1653134803914},{"_id":"public/categories/sqlite3/index.html","hash":"00486387b33492f3a1d0512fc6d58bcf3c5c5639","modified":1653134803914},{"_id":"public/categories/GoMobile/index.html","hash":"4ba9b636fc47bd3d6f31f72eac2c9647209ca92f","modified":1653134803914},{"_id":"public/categories//index.html","hash":"5be50959c20009c4489a72fa4fce4b21453d10bf","modified":1653134803914},{"_id":"public/tags/leetcode/index.html","hash":"74e9451b729740b674ae0af8803df00ba3c8de8d","modified":1653134803914},{"_id":"public/tags//index.html","hash":"b1265eb4c4906d88d5398c095256f11f4d4038a3","modified":1653134803914},{"_id":"public/tags/object-c/index.html","hash":"73c00294bbb45657dc714f71c73908a49af002ea","modified":1653134803914},{"_id":"public/tags//index.html","hash":"fdf33b7ac81b8e5705d2a924b364d4d6832c9c42","modified":1653134803914},{"_id":"public/tags//index.html","hash":"f4c2bda7b9a76b3aeb572bfb405921ec50c3ee1c","modified":1653134803914},{"_id":"public/tags/sqlite3/index.html","hash":"ec98cdd1ff5b3d201ca67abaf883a2aa5795e57f","modified":1653134803914},{"_id":"public/tags/os/index.html","hash":"2e62157095d9520ed74bf46a224b5b3bbb866064","modified":1653134803914},{"_id":"public/tags/shm/index.html","hash":"2d5c97215ac4df835e71f5c70cae697115c33cac","modified":1653134803914},{"_id":"public/tags/GoMobile/index.html","hash":"165cf090cd64b298a4c8c13373427b5dd610f13b","modified":1653134803914},{"_id":"public/tags//index.html","hash":"d5ad3c5f12b866e23a1994634fe16d61710ae22f","modified":1653134803914},{"_id":"public/tags//index.html","hash":"d3c2eb66d00560cfadc6a325ffbc6ad98e09d2c4","modified":1653134803914},{"_id":"public/tags//index.html","hash":"ccffd725717bc3f7ab3f1920920aa2dc1306f770","modified":1653134803914},{"_id":"public/tags//index.html","hash":"0e7a91dfecec1cf15789171760d23f175342baeb","modified":1653134803914},{"_id":"public/tags//index.html","hash":"2249d3315d7f8b3bd67c3eb28dd32d327dad844f","modified":1653134803914},{"_id":"public/tags//index.html","hash":"e38f32b2c2b2a48fc02498e0c9004ba0733db307","modified":1653134803914},{"_id":"public/2020/08/29/2020-08-29_db_system_design_imp(WAL)/index.html","hash":"69690393bd7309757a8485a9dd13a9b744d07a18","modified":1653134803914},{"_id":"public/2020/08/25/2020-08-25_db-system-design-im(storage)/index.html","hash":"24c6aef1283ab0e30da2aa07011f6177968a9c92","modified":1653134803914},{"_id":"public/2020/08/21/2020-08-21_db-system-design-imp(Transaction)/index.html","hash":"a91c0c3a097db3d3893dc24cf736b5a5b9c2e1b6","modified":1653134803914},{"_id":"public/2020/08/17/2020-08-17_db-system-design-imp(Pager)/index.html","hash":"a846ce39b3584050ad4dcfc2e8136b22fde7173d","modified":1653134803914},{"_id":"public/2020/07/21/20.SQLite-Tokenize/index.html","hash":"79d514df59a88e13a4ea02c03a1801c53bb7d144","modified":1653134803914},{"_id":"public/2020/07/16/19.SQLite-KeywordHash/index.html","hash":"b4cebd9fb69981a9fe4c6917e57b16df6569b80c","modified":1653134803914},{"_id":"public/2020/06/29/18.db-system-design-imp(VM)/index.html","hash":"48b89402e033f075ff720b03cb9a2b50f6b3e901","modified":1653134803914},{"_id":"public/2020/06/12/17.inside-sqlite-chapter-6/index.html","hash":"041c09e2144a971946c623e6578ef89ac59f9a63","modified":1653134803914},{"_id":"public/2020/04/19/15.Sqlite-OS/index.html","hash":"d27d926eb217815207c3632575473a1574a5d0d1","modified":1653134803914},{"_id":"public/2020/04/01/14.gomobile-bind/index.html","hash":"64e8692f1441f5400b609c7436707b4dddde9b11","modified":1653134803914},{"_id":"public/2020/03/18/13.sqlite-os-shm/index.html","hash":"46c24a4cef4e7be6262deebc294d6e9baeffdcce","modified":1653134803914},{"_id":"public/2020/03/15/12.compiler-autorelease-opt/index.html","hash":"4e60dea398ea5bf56a854d88784dcc101db5e1d7","modified":1653134803914},{"_id":"public/2020/03/13/11.dyld/index.html","hash":"e3e7830c8fe980d53bcfe0fc42657b597cae0ced","modified":1653134803914},{"_id":"public/2020/03/04/10.runloop-binary-search/index.html","hash":"26d1cba67f0de6bc77cb80d617913912eb570973","modified":1653134803914},{"_id":"public/2020/01/07/8.leetcode47/index.html","hash":"e49123650bb18f3ac7a474fa21fcbd9020a6ab7d","modified":1653134803914},{"_id":"public/2020/01/05/7.leetcode46/index.html","hash":"e4b4286725ab4dd47f3b61646f79da49dd032f29","modified":1653134803914},{"_id":"public/2019/12/21/5.OC-Block-imp/index.html","hash":"20c0ad50bf4218808ab18697ee548ab0546712c4","modified":1653134803914},{"_id":"public/2019/12/21/6.leetcode32/index.html","hash":"d9f793608d7156827f3a794a93a815bf33fa46c7","modified":1653134803914},{"_id":"public/2019/12/20/4.synchronized/index.html","hash":"99ce623b920ae449ffde2a68ee14b77168cd77f4","modified":1653134803914},{"_id":"public/2019/12/17/3.binding-symbols/index.html","hash":"74f1b16691bac7e2d97da3f654e1f2dd40213ec3","modified":1653134803914},{"_id":"public/2019/12/11/2.leetcode5/index.html","hash":"28e49bd10f2c60de363757ba8d5d27b1cc06f805","modified":1653134803914},{"_id":"public/2019/12/10/1.leetcode41/index.html","hash":"a3334a3b1ed072e08f6a7673e31eb59b7ec4fd8f","modified":1653134803914},{"_id":"public/index.html","hash":"4933b24ca2d677f1b3253418adcb08b093a6bc83","modified":1653134803914},{"_id":"public/page/2/index.html","hash":"30a3f4b115019ad1f588b7fc03e681494daa39ed","modified":1653134803914},{"_id":"public/page/3/index.html","hash":"5fcadc2595e1f70cea4365080cbee6a1ed3c7ab6","modified":1653134803914},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1653134803914},{"_id":"public/images/logo-algolia-nebula-blue-full.svg","hash":"b85e274207b1392782476a0430feac98db1e7da0","modified":1653134803914},{"_id":"public/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1653134803914},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1653134803914},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1653134803914},{"_id":"public/images/logo.svg","hash":"2cb74fd3ea2635e015eabc58a8d488aed6cf6417","modified":1653134803914},{"_id":"public/images/spade-logo-next.png","hash":"28778f643f771955bda170923f842c21bb567d32","modified":1653134972425},{"_id":"public/images/spade-logo-next.svg","hash":"5f1736ed90b046f36374919090822b96894f9090","modified":1653134972425},{"_id":"public/images/spade-logo.png","hash":"96977336310ca4a0401c1cc396179012ddf6b5f8","modified":1653134803914},{"_id":"public/images/spade-logo.svg","hash":"4fd1156094ba99ceebb68436bfdcdcc529ed8cda","modified":1653134803914},{"_id":"public/css/noscript.css","hash":"ec89b3425fbce20863d554c6fd495ea29c3c303d","modified":1653134803914},{"_id":"public/js/bookmark.js","hash":"0f563ffbf05fad30e854e413ab17ff7164ab5a53","modified":1653134803914},{"_id":"public/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1653134803914},{"_id":"public/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1653134803914},{"_id":"public/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1653134803914},{"_id":"public/js/motion.js","hash":"f7c825cbff11885fa0dffa64824fd00e505d6a8d","modified":1653134803914},{"_id":"public/js/next-boot.js","hash":"48497e2156a10155dc42311633a110c9685692c9","modified":1653134803914},{"_id":"public/js/pjax.js","hash":"919f5281c4a04d11cfd94573ecf57b3dbabd3cc8","modified":1653134803914},{"_id":"public/js/schedule.js","hash":"a1333258726caf84f368a8f8454639c7dc1626bb","modified":1653134803914},{"_id":"public/js/schemes/muse.js","hash":"9794bd4fc6a458322949d6a0ade89cd1026bc69f","modified":1653134803914},{"_id":"public/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1653134803914},{"_id":"public/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1653134803914},{"_id":"public/js/utils.js","hash":"e447160d342b1f93df5214b6a733441039ced439","modified":1653134803914},{"_id":"public/js/third-party/fancybox.js","hash":"c098d14e65dd170537134358d4b8359ad0539c2c","modified":1653134803914},{"_id":"public/js/third-party/rating.js","hash":"4e92c2d107ba47b47826829f9668030d5ea9bfb8","modified":1653134803914},{"_id":"public/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1653134803914},{"_id":"public/js/third-party/analytics/google-analytics.js","hash":"59684383385059dc4f8a1ff85dbbeb703bcdbcb5","modified":1653134803914},{"_id":"public/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1653134803914},{"_id":"public/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1653134803914},{"_id":"public/js/third-party/chat/gitter.js","hash":"cc38c94125f90dadde11b5ebac7d8bf99a1a08a2","modified":1653134803914},{"_id":"public/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1653134803914},{"_id":"public/js/third-party/comments/changyan.js","hash":"260d1a77d6a3bb33a579d3e4cca1997003e799b5","modified":1653134803914},{"_id":"public/js/third-party/comments/disqus.js","hash":"e1cc671b0d524864fd445e3ab4ade9ee6d07e565","modified":1653134803914},{"_id":"public/js/third-party/comments/disqusjs.js","hash":"b6c58f098473b526d6a3cd35655caf34b77f7cff","modified":1653134803914},{"_id":"public/js/third-party/comments/gitalk.js","hash":"0ec038cf83e8ec067534f16a54041e47a3c1e59a","modified":1653134803914},{"_id":"public/js/third-party/comments/livere.js","hash":"2247d88c934c765c43013337860774aaa99f0b31","modified":1653134803914},{"_id":"public/js/third-party/comments/isso.js","hash":"753a873b6f566aff5ba77ca23f91b78eb880ca64","modified":1653134803914},{"_id":"public/js/third-party/comments/utterances.js","hash":"f67f90eb03e284c82da2b8cf2f1e31801813c16d","modified":1653134803914},{"_id":"public/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1653134803914},{"_id":"public/js/third-party/search/algolia-search.js","hash":"fdb7b7cef1a147d897e7f7cd8903b58368ec2062","modified":1653134803914},{"_id":"public/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1653134803914},{"_id":"public/js/third-party/statistics/lean-analytics.js","hash":"5a928990856b8e456f0663cf3b6b406733672e39","modified":1653134803914},{"_id":"public/js/third-party/search/local-search.js","hash":"4536cb6d0a9bbaaa86fab3fa0101f6a3a3ec5a76","modified":1653134803914},{"_id":"public/js/third-party/statistics/firestore.js","hash":"411a72df581f5b21317dc28633c7993207eb9e1c","modified":1653134803914},{"_id":"public/js/third-party/tags/mermaid.js","hash":"f27d817b0c2138dd3215b1f46af0753f60a008f3","modified":1653134803914},{"_id":"public/js/third-party/tags/pdf.js","hash":"af78c22f0e61c8c8aa8794e585e0d632c6d4fcb8","modified":1653134803914},{"_id":"public/css/main.css","hash":"8426410004fa72340fe24f8e092f3a703943d9c1","modified":1653134803914},{"_id":"public/images/timg.gif","hash":"1ff7e8df9671f590629a9c2228fa1e4b3bba8af3","modified":1653134803914},{"_id":"themes/next/source/images/.DS_Store","hash":"df2fbeb1400acda0909a32c1cf6bf492f1121e07","modified":1653134969848}],"Category":[{"name":"","_id":"cl3fts2kv000493c903wp17p1"},{"name":"","_id":"cl3fts2l2000d93c9ga3vg2ez"},{"name":"object-c","_id":"cl3fts2l4000l93c9h7l5fdgu"},{"name":"sqlite3","_id":"cl3fts2l6000q93c954anbdah"},{"name":"GoMobile","_id":"cl3fts2l8000x93c9edyrb5uf"},{"name":"","_id":"cl3fts2li001w93c9ak64a850"}],"Data":[],"Page":[{"title":"categories","type":"categories","layout":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: \"categories\"\ntype: categories\nlayout: \"categories\"\n---\n","date":"2022-05-21T10:07:06.072Z","updated":"2022-05-21T10:07:06.072Z","path":"categories/index.html","comments":1,"_id":"cl3fts2ko000093c9b14y4hm4","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"tags","type":"tags","layout":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: \"tags\"\ntype: tags\nlayout: \"tags\"\n---\n","date":"2022-05-21T10:06:27.933Z","updated":"2022-05-21T10:06:27.933Z","path":"tags/index.html","comments":1,"_id":"cl3fts2kt000293c9hkooaawk","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":" -- LeetCode[41]","date":"2019-12-09T16:00:00.000Z","type":"tags","_content":"\n> O(n)\n\n<!-- more -->\n\n hard MediumHard...\n\n \"\"\n\n \n\n\n\n1\n\n------------\n\n\n****\n\n\n10\n\n\n\n****\n1. 01\n2. \n3. swap\n4. ,exp:[1,1]\n\n****\n```go\nfunc firstMissingPositive(nums []int) int {\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val > 0 && val <= len(nums) {\n\t\t\tif val != index+1 && nums[val-1] != val {\n\t\t\t\tnums[val-1], nums[index] = val, nums[val-1]\n\t\t\t\tindex--\n\t\t\t}\n\t\t}\n\t}\n\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val != index+1 {\n\t\t\treturn index + 1\n\t\t}\n\t}\n\n\treturn len(nums) + 1\n}\n```","source":"_posts/1.leetcode41.md","raw":"---\ntitle:  -- LeetCode[41]\ndate: 2019-12-10\ntype: tags\ntags: [leetcode,]\ncategories: \n---\n\n> O(n)\n\n<!-- more -->\n\n hard MediumHard...\n\n \"\"\n\n \n\n\n\n1\n\n------------\n\n\n****\n\n\n10\n\n\n\n****\n1. 01\n2. \n3. swap\n4. ,exp:[1,1]\n\n****\n```go\nfunc firstMissingPositive(nums []int) int {\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val > 0 && val <= len(nums) {\n\t\t\tif val != index+1 && nums[val-1] != val {\n\t\t\t\tnums[val-1], nums[index] = val, nums[val-1]\n\t\t\t\tindex--\n\t\t\t}\n\t\t}\n\t}\n\n\tfor index := 0; index < len(nums); index++ {\n\t\tval := nums[index]\n\t\tif val != index+1 {\n\t\t\treturn index + 1\n\t\t}\n\t}\n\n\treturn len(nums) + 1\n}\n```","slug":"1.leetcode41","published":1,"updated":"2022-05-21T09:55:38.818Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2kr000193c9etco91wu","content":"<blockquote>\n<p>O(n)</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p> hard MediumHard</p>\n<p> </p>\n<p> </p>\n<p></p>\n<p>1</p>\n<hr>\n<p><strong></strong><br></p>\n<p>10<br><br></p>\n<p><strong></strong></p>\n<ol>\n<li>01</li>\n<li></li>\n<li>swap</li>\n<li>,exp:[1,1]</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">firstMissingPositive</span><span class=\"params\">(nums []<span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val &gt; <span class=\"number\">0</span> &amp;&amp; val &lt;= <span class=\"built_in\">len</span>(nums) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &amp;&amp; nums[val<span class=\"number\">-1</span>] != val &#123;</span><br><span class=\"line\">\t\t\t\tnums[val<span class=\"number\">-1</span>], nums[index] = val, nums[val<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t\t\tindex--</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> index + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(nums) + <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<blockquote>\n<p>O(n)</p>\n</blockquote>","more":"<p> hard MediumHard</p>\n<p> </p>\n<p> </p>\n<p></p>\n<p>1</p>\n<hr>\n<p><strong></strong><br></p>\n<p>10<br><br></p>\n<p><strong></strong></p>\n<ol>\n<li>01</li>\n<li></li>\n<li>swap</li>\n<li>,exp:[1,1]</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">firstMissingPositive</span><span class=\"params\">(nums []<span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val &gt; <span class=\"number\">0</span> &amp;&amp; val &lt;= <span class=\"built_in\">len</span>(nums) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &amp;&amp; nums[val<span class=\"number\">-1</span>] != val &#123;</span><br><span class=\"line\">\t\t\t\tnums[val<span class=\"number\">-1</span>], nums[index] = val, nums[val<span class=\"number\">-1</span>]</span><br><span class=\"line\">\t\t\t\tindex--</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(nums); index++ &#123;</span><br><span class=\"line\">\t\tval := nums[index]</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> val != index+<span class=\"number\">1</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> index + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"built_in\">len</span>(nums) + <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"RunLoop\"\"","date":"2020-03-03T16:00:00.000Z","_content":"\n> RunLoopTimer------RunLoop \n\n<!-- more -->\n\n### \n````objective-c\n//fireTSR\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) {\n    CFIndex cnt = CFArrayGetCount(array);\n    if (cnt <= 0) {\n        return 0;\n    }\n    if (256 < cnt) {//count 256 \n        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);\n        if (item->_fireTSR <= rlt->_fireTSR) {\n            return cnt;\n        }\n        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);\n        if (rlt->_fireTSR < item->_fireTSR) {\n            return 0;\n        }\n    }\n\n\t//\n    CFIndex add = (1 << flsl(cnt)) * 2;\n    CFIndex idx = 0;\n    Boolean lastTestLEQ;\n    do {\n        add = add / 2;\n\t    lastTestLEQ = false;\n        CFIndex testIdx = idx + add;\n        if (testIdx < cnt) {\n            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);\n            if (item->_fireTSR <= rlt->_fireTSR) {\n                idx = testIdx;\n\t\t        lastTestLEQ = true;\n            }\n        }\n    } while (0 < add);\n\n    return lastTestLEQ ? idx + 1 : idx;\n}\n````\n\n\n\nO(log N)log N\n\n> \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png)\n\n `add` `idx` ``  start `idx`  `testIdx` `` `end = idx + start` add  end\n\n\nIndex\n\n1. 256256..ifO(log n)\n\n2. :`CFIndex add = (1 << flsl(cnt)) * 2;` add`cnt``flsl()``cnt`(flsl(256)  9)cnt256add10241951251221024``add2n\n\nps928","source":"_posts/10.runloop-binary-search.md","raw":"---\ntitle: RunLoop\"\"\ndate: 2020-03-04\ntags: [object-c,]\ncategories: \n---\n\n> RunLoopTimer------RunLoop \n\n<!-- more -->\n\n### \n````objective-c\n//fireTSR\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));\nstatic CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) {\n    CFIndex cnt = CFArrayGetCount(array);\n    if (cnt <= 0) {\n        return 0;\n    }\n    if (256 < cnt) {//count 256 \n        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);\n        if (item->_fireTSR <= rlt->_fireTSR) {\n            return cnt;\n        }\n        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);\n        if (rlt->_fireTSR < item->_fireTSR) {\n            return 0;\n        }\n    }\n\n\t//\n    CFIndex add = (1 << flsl(cnt)) * 2;\n    CFIndex idx = 0;\n    Boolean lastTestLEQ;\n    do {\n        add = add / 2;\n\t    lastTestLEQ = false;\n        CFIndex testIdx = idx + add;\n        if (testIdx < cnt) {\n            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);\n            if (item->_fireTSR <= rlt->_fireTSR) {\n                idx = testIdx;\n\t\t        lastTestLEQ = true;\n            }\n        }\n    } while (0 < add);\n\n    return lastTestLEQ ? idx + 1 : idx;\n}\n````\n\n\n\nO(log N)log N\n\n> \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png)\n\n `add` `idx` ``  start `idx`  `testIdx` `` `end = idx + start` add  end\n\n\nIndex\n\n1. 256256..ifO(log n)\n\n2. :`CFIndex add = (1 << flsl(cnt)) * 2;` add`cnt``flsl()``cnt`(flsl(256)  9)cnt256add10241951251221024``add2n\n\nps928","slug":"10.runloop-binary-search","published":1,"updated":"2020-08-29T14:42:58.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2kt000393c91dvigoxa","content":"<blockquote>\n<p>RunLoopTimerRunLoop </p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//fireTSR</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) &#123;</span><br><span class=\"line\">    CFIndex cnt = CFArrayGetCount(array);</span><br><span class=\"line\">    if (cnt &lt;= 0) &#123;</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (256 &lt; cnt) &#123;//count 256 </span><br><span class=\"line\">        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);</span><br><span class=\"line\">        if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return cnt;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);</span><br><span class=\"line\">        if (rlt-&gt;_fireTSR &lt; item-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return 0;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//</span><br><span class=\"line\">    CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</span><br><span class=\"line\">    CFIndex idx = 0;</span><br><span class=\"line\">    Boolean lastTestLEQ;</span><br><span class=\"line\">    do &#123;</span><br><span class=\"line\">        add = add / 2;</span><br><span class=\"line\">\t    lastTestLEQ = false;</span><br><span class=\"line\">        CFIndex testIdx = idx + add;</span><br><span class=\"line\">        if (testIdx &lt; cnt) &#123;</span><br><span class=\"line\">            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);</span><br><span class=\"line\">            if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">                idx = testIdx;</span><br><span class=\"line\">\t\t        lastTestLEQ = true;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; while (0 &lt; add);</span><br><span class=\"line\"></span><br><span class=\"line\">    return lastTestLEQ ? idx + 1 : idx;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>O(log N)log N</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png\"></p>\n<p> <code>add</code> <code>idx</code> <code></code>  start <code>idx</code>  <code>testIdx</code> <code></code> <code>end = idx + start</code> add  end</p>\n<p>Index</p>\n<ol>\n<li><p>256256..ifO(log n)</p>\n</li>\n<li><p>:<code>CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</code> add<code>cnt</code><code>flsl()</code><code>cnt</code>(flsl(256)  9)cnt256add10241951251221024<code></code>add2n</p>\n</li>\n</ol>\n<p>ps928</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>RunLoopTimerRunLoop </p>\n</blockquote>","more":"<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//fireTSR</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) __attribute__((noinline));</span><br><span class=\"line\">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) &#123;</span><br><span class=\"line\">    CFIndex cnt = CFArrayGetCount(array);</span><br><span class=\"line\">    if (cnt &lt;= 0) &#123;</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (256 &lt; cnt) &#123;//count 256 </span><br><span class=\"line\">        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);</span><br><span class=\"line\">        if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return cnt;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);</span><br><span class=\"line\">        if (rlt-&gt;_fireTSR &lt; item-&gt;_fireTSR) &#123;</span><br><span class=\"line\">            return 0;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t//</span><br><span class=\"line\">    CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</span><br><span class=\"line\">    CFIndex idx = 0;</span><br><span class=\"line\">    Boolean lastTestLEQ;</span><br><span class=\"line\">    do &#123;</span><br><span class=\"line\">        add = add / 2;</span><br><span class=\"line\">\t    lastTestLEQ = false;</span><br><span class=\"line\">        CFIndex testIdx = idx + add;</span><br><span class=\"line\">        if (testIdx &lt; cnt) &#123;</span><br><span class=\"line\">            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);</span><br><span class=\"line\">            if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</span><br><span class=\"line\">                idx = testIdx;</span><br><span class=\"line\">\t\t        lastTestLEQ = true;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; while (0 &lt; add);</span><br><span class=\"line\"></span><br><span class=\"line\">    return lastTestLEQ ? idx + 1 : idx;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>O(log N)log N</p>\n<blockquote>\n<p></p>\n</blockquote>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/639b55053de9d6dc5d2307c9d3787fb1.png\"></p>\n<p> <code>add</code> <code>idx</code> <code></code>  start <code>idx</code>  <code>testIdx</code> <code></code> <code>end = idx + start</code> add  end</p>\n<p>Index</p>\n<ol>\n<li><p>256256..ifO(log n)</p>\n</li>\n<li><p>:<code>CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</code> add<code>cnt</code><code>flsl()</code><code>cnt</code>(flsl(256)  9)cnt256add10241951251221024<code></code>add2n</p>\n</li>\n</ol>\n<p>ps928</p>"},{"title":" dyld ","date":"2020-03-12T16:00:00.000Z","_content":"\n.......\n\ndyld/dyld ASLRobjcruntimedyld\n\n<!-- more -->\n\n## dyld \ndyld dyldStartup.s :load dyld`__dyld_start``dyld::start` \n\n`dyld::start`\n\n```cpp\nuintptr_t start(const struct macho_header* appsMachHeader, int argc, const char* argv[], \n\t\t\t\tintptr_t slide, const struct macho_header* dyldsMachHeader,\n\t\t\t\tuintptr_t* startGlue)\n{\n\t// if kernel had to slide dyld, we need to fix up load sensitive locations\n\t// we have to do this before using any global variables\n    //dyld\n    slide = slideOfMainExecutable(dyldsMachHeader);\n    bool shouldRebase = slide != 0;\n    if ( shouldRebase ) {\n        //rebase Dyld\n        rebaseDyld(dyldsMachHeader, slide);\n    }\n\n\t// allow dyld to use mach messaging\n    //mach\n\tmach_init();\n\n\t// kernel sets up env pointer to be just past end of agv array\n    //\n\tconst char** envp = &argv[argc+1];\n\t\n\t// kernel sets up apple pointer to be just past end of envp array\n\tconst char** apple = envp;\n\twhile(*apple != NULL) { ++apple; }\n\t++apple;\n\n\t// set up random value for stack canary\n\t__guard_setup(apple);\n\n#if DYLD_INITIALIZER_SUPPORT\n\t// run all C++ initializers inside dyld\n    // dyld C++\n\trunDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);\n#endif\n\n\t// now that we are done bootstrapping dyld, call dyld's main\n    //bootstrap dyld dyld  main \n\tuintptr_t appsSlide = slideOfMainExecutable(appsMachHeader);\n\treturn dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);\n}\n```\n\n`dyld::start`\n1. <span id=\"return_rebaseDyld\">rebase dyld</span>\n[rebase dyld](#jump_rebaseDyld)\n2.  mach_msg\n\t<mach/mach_init.h>\n3. \n\tappleenvp\n4. \n\tapplestack_guard=xx\n5. <span id=\"return_runDyldInitializers\"> dyld </span>\n\tdyld(PIC )dylddyld[](#jump_runDyldInitializers)\n6.  dyld (bootstrap) dyld main\n\nstartdyld\n\n[  dyld _main](#jump__main)\n\n### <span id=\"jump_rebaseDyld\">RebaseDyld</span>\nDyldmach_oload_commanddylddyld\n\n1. Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info\n2. rebase  bind  Opcodes\n\nrebase/bind \n\n[](#return_rebaseDyld)\n\n### <span id=\"jump_runDyldInitializers\">Dyld</span>\n\n```cpp\nextern const Initializer  inits_start  __asm(\"section$start$__DATA$__mod_init_func\");\nextern const Initializer  inits_end    __asm(\"section$end$__DATA$__mod_init_func\");\n\n//\n// For a regular executable, the crt code calls dyld to run the executables initializers.\n// For a static executable, crt directly runs the initializers.\n// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.\n// We pass argc, argv, etc in case libc.a uses those arguments\n//\nstatic void runDyldInitializers(const struct macho_header* mh, intptr_t slide, int argc, const char* argv[], const char* envp[], const char* apple[])\n{\n\tfor (const Initializer* p = &inits_start; p < &inits_end; ++p) {\n\t\t(*p)(argc, argv, envp, apple);\n\t}\n}\n```\n\ndyldcrtdyldcrtdyldhack\n\n`__asm(\"section$start$__DATA$__mod_init_func\")``__DATA``__mod_init_func`\n\nDemo\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png)\n\nmach-o \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png)\n\n`__mod_init_func`,Sectiondemo_init10xED0\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png)\n\n`demo_init2`\n\ndyld`inits_start``inits_end`dyld\n\ndyld\n[](#jump_end) 1  2\n\n[](#return_runDyldInitializers)\n\n## <span id=\"jump__main\">dyld::_main</span>\ndyldrebasebindmach_msgdyld`dyld::_main` \n\n`dyld::_main`Appmain`dyld::start``__dyld_start`main\n\n_main\n\n1.  crashloglog...\n2. `// iOS cannot run without shared region`,iOS\n\tlibpath\n3. <span id=\"return_initMainExecutable\">:</span>\n\t`ImageLoaderMachO`[](#jump_initMainExecutable)\n\tClassicCompressed`ImageLoaderMachOCompressed``ImageLoaderMachOClassic``ImageLoaderMachO`\n4. `loadInsertedDylib`[Load ](#jump_loaddylib)<span id=\"return_loaddylib\">.</span>\n5. <span id=\"return_link_execution\"></span>[](#jump_link_execution)\n6. \n7. \n\n### <span id=\"jump_initMainExecutable\"></span>\ndylddyld macho_headerdyldImageLoaderMachOdyld\n\n```cpp\nstatic ImageLoaderMachO* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path)\n{\n\t// try mach-o loader\n\tif ( isCompatibleMachO((const uint8_t*)mh, path) ) {\n\t\tImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);\n\t\taddImage(image);\n\t\treturn (ImageLoaderMachO*)image;\n\t}\n\t\n\tthrow \"main executable not a known format\";\n}\n```\n\n`instantiateMainExecutable`mach-o(compress  classic)ImageLoader\n\n`addImage(image);`\n1. ImageLoader`sAllImages`\n2.  `sMappedRangesStart`  `ImageLoader`\n\n[](#return_initMainExecutable)\n\n### <span id=\"jump_loaddylib\"></span>\nDYLD_INSERT_LIBRARIESloadInsertedDylib()\n\nload()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH->LD_LIBRARY_PATH->DYLD_FRAMEWORK_PATH->->DYLD_FALLBACK_LIBRARY_PATH\n\nImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() \n\nloadPhase0()ImageLoaderMachO::instantiateFromCache()\n\n\n\n\n```cpp\n// map in file and instantiate an ImageLoader\n// ImagerLoader\nstatic ImageLoader* loadPhase6(int fd, const struct stat& stat_buf, const char* path, const LoadContext& context)\n{\n\t//dyld::log(\"%s(%s)\\n\", __func__ , path);\n\tuint64_t fileOffset = 0;\n\tuint64_t fileLength = stat_buf.st_size;\n\n\t// validate it is a file (not directory)\n\tif ( (stat_buf.st_mode & S_IFMT) != S_IFREG ) \n\t\tthrow \"not a file\";\n\n\tuint8_t firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];\n\tuint8_t *firstPagesPtr = firstPages;\n\tbool shortPage = false;\n\t\n\t// min mach-o file is 4K\n\t// mach-o4k\n\tif ( fileLength < 4096 ) {\n\t\tif ( pread(fd, firstPages, (size_t)fileLength, 0) != (ssize_t)fileLength )\n\t\t\tthrowf(\"pread of short file failed: %d\", errno);\n\t\tshortPage = true;\n\t} \n\telse {\n\t\t// optimistically read only first 4KB\n\t\t// header4kb4k\n\t\tif ( pread(fd, firstPages, 4096, 0) != 4096 )\n\t\t\tthrowf(\"pread of first 4K failed: %d\", errno);\n\t}\n\t\n\t// if fat wrapper, find usable sub-file\n\t// fat\n\tconst fat_header* fileStartAsFat = (fat_header*)firstPages;\n\tif ( fileStartAsFat->magic == OSSwapBigToHostInt32(FAT_MAGIC) ) {\n\t\tif ( OSSwapBigToHostInt32(fileStartAsFat->nfat_arch) > ((4096 - sizeof(fat_header)) / sizeof(fat_arch)) )\n\t\t\tthrowf(\"fat header too large: %u entries\", OSSwapBigToHostInt32(fileStartAsFat->nfat_arch));\n\t\tif ( fatFindBest(fileStartAsFat, &fileOffset, &fileLength) ) {\n\t\t\tif ( (fileOffset+fileLength) > (uint64_t)(stat_buf.st_size) )\n\t\t\t\tthrowf(\"truncated fat file.  file length=%llu, but needed slice goes to %llu\", stat_buf.st_size, fileOffset+fileLength);\n\t\t\tif (pread(fd, firstPages, 4096, fileOffset) != 4096)\n\t\t\t\tthrowf(\"pread of fat file failed: %d\", errno);\n\t\t}\n\t\telse {\n\t\t\tthrow \"no matching architecture in universal wrapper\";\n\t\t}\n\t}\n\t\n\t// try mach-o loader\n\tif ( shortPage ) \n\t\tthrow \"file too short\";\n\n\tif ( isCompatibleMachO(firstPages, path) ) {\n\n\t\t// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded\n\t\tconst mach_header* mh = (mach_header*)firstPages;\n\t\tswitch ( mh->filetype ) {\n\t\t\tcase MH_EXECUTE:\n\t\t\tcase MH_DYLIB:\n\t\t\tcase MH_BUNDLE:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow \"mach-o, but wrong filetype\";\n\t\t}\n\n\t\tuint32_t headerAndLoadCommandsSize = sizeof(macho_header) + mh->sizeofcmds;\n\t\tif ( headerAndLoadCommandsSize > MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )\n\t\t\tthrowf(\"malformed mach-o: load commands size (%u) > %u\", headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);\n\n\t\tif ( headerAndLoadCommandsSize > fileLength )\n\t\t\tdyld::throwf(\"malformed mach-o: load commands size (%u) > mach-o file size (%llu)\", headerAndLoadCommandsSize, fileLength);\n\n\t\tif ( headerAndLoadCommandsSize > 4096 ) {\n\t\t\t// read more pages\n\t\t\t//  head  LC_COMMANDS4096 headerAndLoadCommandsSize \n\t\t\tunsigned readAmount = headerAndLoadCommandsSize - 4096;\n\t\t\tif ( pread(fd, &firstPages[4096], readAmount, fileOffset+4096) != readAmount )\n\t\t\t\tthrowf(\"pread of extra load commands past 4KB failed: %d\", errno);\n\t\t}\n\n#if TARGET_IPHONE_SIMULATOR\t\n\t\t// <rdar://problem/14168872> dyld_sim should restrict loading osx binaries\n\t\tif ( !isSimulatorBinary(firstPages, path) ) {\n\t#if TARGET_OS_WATCH\n\t\t\tthrow \"mach-o, but not built for watchOS simulator\";\n\t#elif TARGET_OS_TV\n\t\t\tthrow \"mach-o, but not built for tvOS simulator\";\n\t#else\n\t\t\tthrow \"mach-o, but not built for iOS simulator\";\n\t#endif\n\t\t}\n#endif\n\n#if __MAC_OS_X_VERSION_MIN_REQUIRED\n\t\tif ( gLinkContext.marzipan ) {\n\t\t\tconst dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;\n\t\t\tbool isiOSMacBinary = mf->supportsPlatform(dyld3::Platform::iOSMac) || iOSMacWhiteListed(path);\n\t\t\tbool isProhibitedMacOSBinary = !isiOSMacBinary && iOSMacBlackListed(path);\n\t\t\tif ( (context.enforceIOSMac && !isiOSMacBinary) || isProhibitedMacOSBinary ) {\n\t\t\t\tthrow \"mach-o, but not built for iOSMac\";\n\t\t\t}\n\t\t}\n#endif\n\n#if __arm64e__\n\t\tif ( (sMainExecutableMachHeader->cpusubtype == CPU_SUBTYPE_ARM64_E) && (mh->cpusubtype != CPU_SUBTYPE_ARM64_E) )\n\t\t\tthrow \"arm64 dylibs cannot be loaded into arm64e processes\";\n#endif\n\t\tImageLoader* image = nullptr;\n\t\t{\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_MAP_IMAGE, path, 0, 0);\n\t\t\t// instantiateFromFile  ImageLoader\n\t\t\timage = ImageLoaderMachO::instantiateFromFile(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);\n\t\t\ttimer.setData4((uint64_t)image->machHeader());\n\t\t}\n\t\t\n\t\t// validate\n\t\t// \n\t\treturn checkandAddImage(image, context);\n\t}\n\t\n\t// try other file formats here...\n\t\n\t\n\t// throw error about what was found\n\tswitch (*(uint32_t*)firstPages) {\n\t\tcase MH_MAGIC:\n\t\tcase MH_CIGAM:\n\t\tcase MH_MAGIC_64:\n\t\tcase MH_CIGAM_64:\n\t\t\tthrow \"mach-o, but wrong architecture\";\n\t\tdefault:\n\t\tthrowf(\"unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X\", \n\t\t\tfirstPages[0], firstPages[1], firstPages[2], firstPages[3], firstPages[4], firstPages[5], firstPages[6],firstPages[7]);\n\t}\n}\n```\n\n`ImageLoader`\n\n\n1. 4k4k, fat_header\n2. fatCPU\n3. \n4.  head  Load_Commands 4k headerAndLoadCommandsSize `ImageLoader``ImageLoader` Load_Commands \n5. checkandAddImage\n\n\n checkandAddImage\n```cpp\nstatic ImageLoader* checkandAddImage(ImageLoader* image, const LoadContext& context)\n{\n\t// now sanity check that this loaded image does not have the same install path as any existing image\n\t// sAllImages \n\tconst char* loadedImageInstallPath = image->getInstallPath();\n\tif ( image->isDylib() && (loadedImageInstallPath != NULL) && (loadedImageInstallPath[0] == '/') ) {\n\t\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\t\tImageLoader* anImage = *it;\n\t\t\tconst char* installPath = anImage->getInstallPath();\n\t\t\tif ( installPath != NULL) {\n\t\t\t\tif ( strcmp(loadedImageInstallPath, installPath) == 0 ) {\n\t\t\t\t\t//dyld::log(\"duplicate(%s) => %p\\n\", installPath, anImage);\n\t\t\t\t\tremoveImage(image);\n\t\t\t\t\tImageLoader::deleteImage(image);\n\t\t\t\t\treturn anImage;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// some API's restrict what they can load\n\tif ( context.mustBeBundle && !image->isBundle() )\n\t\tthrow \"not a bundle\";\n\tif ( context.mustBeDylib && !image->isDylib() )\n\t\tthrow \"not a dylib\";\n\n\t// regular main executables cannot be loaded \n\tif ( image->isExecutable() ) {\n\t\tif ( !context.canBePIE || !image->isPositionIndependentExecutable() )\n\t\t\tthrow \"can't load a main executable\";\n\t}\n\t\n\t// don't add bundles to global list, they can be loaded but not linked.  When linked it will be added to list\n\tif ( ! image->isBundle() )\n\t\t//\n\t\taddImage(image);\n\t\n\treturn image;\n}\n```\n\n`AddImage`\n\n[](#return_loaddylib)\n\n### <span id=\"jump_link_execution\">Link </span>\ndyld\n\n`void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain& loaderRPaths, unsigned cacheIndex)`\n\n_main mach-o   `ImageLoader.link`\n\n```cpp\nvoid ImageLoader::link(const LinkContext& context, bool forceLazysBound, bool preflightOnly, bool neverUnload, const RPathChain& loaderRPaths, const char* imagePath)\n{\n\t//dyld::log(\"ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n\", imagePath, fDlopenReferenceCount, fNeverUnload);\n\t\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\tuint64_t t0 = mach_absolute_time();\n\tthis->recursiveLoadLibraries(context, preflightOnly, loaderRPaths, imagePath);\n\tcontext.notifyBatch(dyld_image_state_dependents_mapped, preflightOnly);\n\n\t// we only do the loading step for preflights\n\tif ( preflightOnly )\n\t\treturn;\n\n\tuint64_t t1 = mach_absolute_time();\n\tcontext.clearAllDepths();\n\tthis->recursiveUpdateDepth(context.imageCount());\n\n\t__block uint64_t t2, t3, t4, t5;\n\t{\n\t\tdyld3::ScopedTimer(DBG_DYLD_TIMING_APPLY_FIXUPS, 0, 0, 0);\n\t\tt2 = mach_absolute_time();\n\t\tthis->recursiveRebase(context);\n\t\tcontext.notifyBatch(dyld_image_state_rebased, false);\n\n\t\tt3 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->recursiveBindWithAccounting(context, forceLazysBound, neverUnload);\n\n\t\tt4 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->weakBind(context);\n\t\tt5 = mach_absolute_time();\n\t}\n\n    if ( !context.linkingMainExecutable )\n        context.notifyBatch(dyld_image_state_bound, false);\n\tuint64_t t6 = mach_absolute_time();\t\n\n\tstd::vector<DOFInfo> dofs;\n\tthis->recursiveGetDOFSections(context, dofs);\n\tcontext.registerDOFs(dofs);\n\tuint64_t t7 = mach_absolute_time();\t\n\n\t// interpose any dynamically loaded images\n\tif ( !context.linkingMainExecutable && (fgInterposingTuples.size() != 0) ) {\n\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_APPLY_INTERPOSING, 0, 0, 0);\n\t\tthis->recursiveApplyInterposing(context);\n\t}\n\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\t//log\n\tfgTotalLoadLibrariesTime += t1 - t0;\n\tfgTotalRebaseTime += t3 - t2;\n\tfgTotalBindTime += t4 - t3;\n\tfgTotalWeakBindTime += t5 - t4;\n\tfgTotalDOF += t7 - t6;\n\t\n\t// done with initial dylib loads\n\tfgNextPIEDylibAddress = 0;\n}\n```\n\n\n1. `this->recursiveLoadLibraries`  (LoadLoadopenImageLoader)Load\n2. `this->recursiveUpdateDepth` \n3. <span id=\"return_rebase\">`this->recursiveRebase`</span>\n\trebaserecursiveRebaserebase`rebase(const LinkContext& context, uintptr_t slide)`[Rebase](#jump_rebase)\n4. `this->recursiveBindWithAccounting`\n\tnon-lazy bindlazy bindRebaserebind`doBind(const LinkContext& context, bool forceLazysBound)`\n5. `this->weakBind` \n6. `this->recursiveGetDOFSections` DOF\n7. `this->recursiveApplyInterposing`\n\nlog\n\n### <span id=\"jump_rebase\">Rebase</span>\n Rebase \n\nRebaseASLRmach-oPIC\"rebase\"\n\nPICrebase\n\n/  ()mach-o`__mod_init_func`dyld vmaddr -- slide\n\ncompressed mach-o(mach-o) `ImageLoaderMachOCompressed`\n\n rebase mach-o\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png)\n\n rebase   --  opcode  immediate\n\n\nREBASE_OPCODE_TYPE_IMM == 11:TypeType\nREBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB == 22:rebase2segmentuleb\nuleb128 == 24:uleb\nREBASE_OPCODE_DO_REBASE_IMM_TIMES == 2:rebase2\n\n224rebase\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png)\n\n02 0x3000 +  24 =0x3018 \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png)\n\n`__mod_init_func`~\n\nrebase    \n```cpp\nvoid ImageLoaderMachOCompressed::rebase(const LinkContext& context, uintptr_t slide)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\t// fLinkEditBase __LINKEDIT    == slide\n\t// start  rebase\n\tconst uint8_t* const start = fLinkEditBase + fDyldInfo->rebase_off;\n\t// end  rebase\n\tconst uint8_t* const end = &start[fDyldInfo->rebase_size];\n\tconst uint8_t* p = start;\n\n\ttry {\n\t\tuint8_t type = 0;\n\t\tint segmentIndex = 0;\n\t\tuintptr_t address = segActualLoadAddress(0);\n\t\tuintptr_t segmentStartAddress = segActualLoadAddress(0);//N\n\t\tuintptr_t segmentEndAddress = segActualEndAddress(0);//N\n\t\tuintptr_t count;\n\t\tuintptr_t skip;\n\t\tbool done = false;\n\t\twhile ( !done && (p < end) ) {\n\t\t\tuint8_t immediate = *p & REBASE_IMMEDIATE_MASK;\n\t\t\tuint8_t opcode = *p & REBASE_OPCODE_MASK;\n\t\t\t++p;\n\t\t\tswitch (opcode) {\n\t\t\t\tcase REBASE_OPCODE_DONE:\n\t\t\t\t\tdone = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_TYPE_IMM:\n\t\t\t\t\ttype = immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:\n\t\t\t\t\tsegmentIndex = immediate;\n\t\t\t\t\tif ( segmentIndex >= fSegmentsCount )\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)\",\n\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount-1);\n\t\t\t#if TEXT_RELOC_SUPPORT\n\t\t\t\t\tif ( !segWriteable(segmentIndex) && !segHasRebaseFixUps(segmentIndex) && !segHasBindFixUps(segmentIndex) )\n\t\t\t#else\n\t\t\t\t\tif ( !segWriteable(segmentIndex) )\n\t\t\t#endif\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)\",\n\t\t\t\t\t\t\t\tsegmentIndex, segName(segmentIndex));\n\t\t\t\t\t//\n\t\t\t\t\tsegmentStartAddress = segActualLoadAddress(segmentIndex);\n\t\t\t\t\tsegmentEndAddress = segActualEndAddress(segmentIndex);\n\t\t\t\t\t\n\t\t\t\t\taddress = segmentStartAddress + read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_ULEB:\n\t\t\t\t\taddress += read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_IMM_SCALED:\n\t\t\t\t\taddress += immediate*sizeof(uintptr_t);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_IMM_TIMES:\n\t\t\t\t\tfor (int i=0; i < immediate; ++i) {//N\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:\n\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\taddress += read_uleb128(p, end) + sizeof(uintptr_t);\n\t\t\t\t\t++fgTotalRebaseFixups;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tskip = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += skip + sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdyld::throwf(\"bad rebase opcode %d\", *(p-1));\n\t\t\t}\n\t\t}\n\t}\n\tcatch (const char* msg) {\n\t\tconst char* newMsg = dyld::mkstringf(\"%s in %s\", msg, this->getPath());\n\t\tfree((void*)msg);\n\t\tthrow newMsg;\n\t}\n\tCRSetCrashLogMessage2(NULL);\n}\n```\n## <span id=\"jump_init_main_execution\">initializeMainExecutable</span>\n/rebase/bind...runtime\n\n```cpp\nvoid initializeMainExecutable()\n{\n\t// record that we've reached this step\n\tgLinkContext.startedInitializingMainExecutable = true;\n\n\t// run initialzers for any inserted dylibs\n\tImageLoader::InitializerTimingList initializerTimes[allImagesCount()];\n\tinitializerTimes[0].count = 0;\n\tconst size_t rootCount = sImageRoots.size();\n\tif ( rootCount > 1 ) {\n\t\tfor(size_t i=1; i < rootCount; ++i) {\n\t\t\tsImageRoots[i]->runInitializers(gLinkContext, initializerTimes[0]);\n\t\t}\n\t}\n\t\n\t// run initializers for main executable and everything it brings up \n\tsMainExecutable->runInitializers(gLinkContext, initializerTimes[0]);\n\t\n\t// register cxa_atexit() handler to run static terminators in all loaded images when this process exits\n\tif ( gLibSystemHelpers != NULL ) \n\t\t(*gLibSystemHelpers->cxa_atexit)(&runAllStaticTerminators, NULL, NULL);\n\n\t// dump info if requested\n\tif ( sEnv.DYLD_PRINT_STATISTICS )\n\t\tImageLoader::printStatistics((unsigned int)allImagesCount(), initializerTimes[0]);\n\tif ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )\n\t\tImageLoaderMachO::printStatisticsDetails((unsigned int)allImagesCount(), initializerTimes[0]);\n}\n\n```\n\n\n\nsMainExecutable->runInitializers \n```cpp\nvoid ImageLoader::runInitializers(const LinkContext& context, InitializerTimingList& timingInfo)\n{\n\tuint64_t t1 = mach_absolute_time();\n\tmach_port_t thisThread = mach_thread_self();\n\tImageLoader::UninitedUpwards up;\n\tup.count = 1;\n\tup.images[0] = this;\n\tprocessInitializers(context, thisThread, timingInfo, up);\n\tcontext.notifyBatch(dyld_image_state_initialized, false);\n\tmach_port_deallocate(mach_task_self(), thisThread);\n\tuint64_t t2 = mach_absolute_time();\n\tfgTotalInitTime += (t2 - t1);\n}\n```\nprocessInitializers \n```cpp\nvoid ImageLoader::processInitializers(const LinkContext& context, mach_port_t thisThread,\n\t\t\t\t\t\t\t\t\t InitializerTimingList& timingInfo, ImageLoader::UninitedUpwards& images)\n{\n\tuint32_t maxImageCount = context.imageCount()+2;\n\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];\n\tImageLoader::UninitedUpwards& ups = upsBuffer[0];\n\tups.count = 0;\n\t// Calling recursive init on all images in images list, building a new list of\n\t// uninitialized upward dependencies.\n\tfor (uintptr_t i=0; i < images.count; ++i) {\n\t\timages.images[i]->recursiveInitialization(context, thisThread, images.images[i]->getPath(), timingInfo, ups);\n\t}\n\t// If any upward dependencies remain, init them.\n\tif ( ups.count > 0 )\n\t\tprocessInitializers(context, thisThread, timingInfo, ups);\n}\n```\n\nrecursiveInitialization \n```cpp\nvoid ImageLoader::recursiveInitialization(const LinkContext& context, mach_port_t this_thread, const char* pathToInitialize,\n\t\t\t\t\t\t\t\t\t\t  InitializerTimingList& timingInfo, UninitedUpwards& uninitUps)\n{\n\trecursive_lock lock_info(this_thread);\n\trecursiveSpinLock(lock_info);\n\n\tif ( fState < dyld_image_state_dependents_initialized-1 ) {\n\t\tuint8_t oldState = fState;\n\t\t// break cycles\n\t\tfState = dyld_image_state_dependents_initialized-1;\n\t\ttry {\n\t\t\t// initialize lower level libraries first\n\t\t\tfor(unsigned int i=0; i < libraryCount(); ++i) {\n\t\t\t\tImageLoader* dependentImage = libImage(i);\n\t\t\t\tif ( dependentImage != NULL ) {\n\t\t\t\t\t// don't try to initialize stuff \"above\" me yet\n\t\t\t\t\tif ( libIsUpward(i) ) {\n\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;\n\t\t\t\t\t\tuninitUps.count++;\n\t\t\t\t\t}\n\t\t\t\t\telse if ( dependentImage->fDepth >= fDepth ) {\n\t\t\t\t\t\tdependentImage->recursiveInitialization(context, this_thread, libPath(i), timingInfo, uninitUps);\n\t\t\t\t\t}\n                }\n\t\t\t}\n\t\t\t\n\t\t\t// record termination order\n\t\t\tif ( this->needsTermination() )\n\t\t\t\tcontext.terminationRecorder(this);\n\t\t\t\n\t\t\t// let objc know we are about to initialize this image\n\t\t\tuint64_t t1 = mach_absolute_time();\n\t\t\tfState = dyld_image_state_dependents_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_dependents_initialized, this, &timingInfo);\n\t\t\t\n\t\t\t// initialize this image\n\t\t\tbool hasInitializers = this->doInitialization(context);\n\n\t\t\t// let anyone know we finished initializing this image\n\t\t\tfState = dyld_image_state_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_initialized, this, NULL);\n\t\t\t\n\t\t\tif ( hasInitializers ) {\n\t\t\t\tuint64_t t2 = mach_absolute_time();\n\t\t\t\ttimingInfo.addTime(this->getShortName(), t2-t1);\n\t\t\t}\n\t\t}\n\t\tcatch (const char* msg) {\n\t\t\t// this image is not initialized\n\t\t\tfState = oldState;\n\t\t\trecursiveSpinUnLock();\n\t\t\tthrow;\n\t\t}\n\t}\n\t\n\trecursiveSpinUnLock();\n}\n```\n\ndoInitialization \n```cpp\nbool ImageLoaderMachO::doInitialization(const LinkContext& context)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\n\t// mach-o has -init and static initializers\n\tdoImageInit(context);\n\tdoModInitFunctions(context);\n\t\n\tCRSetCrashLogMessage2(NULL);\n\t\n\treturn (fHasDashInit || fHasInitializers);\n}\n```\n\n doModInitFunctions dyld_mod_init_func\n\nruntime:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png)\n\n libSystem.B.dylib -> libdispatch.dylib -> libobjc.A.dylib runtime\nruntime dyld\n`_dyld_objc_notify_register(&map_images, load_images, unmap_image);`\n\nloadruntime\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png)\n\n\n```cpp\nvoid registerObjCNotifiers(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)\n{\n\t// record functions to call\n\tsNotifyObjCMapped\t= mapped;\n\tsNotifyObjCInit\t\t= init;\n\tsNotifyObjCUnmapped = unmapped;\n\n\t// call 'mapped' function with all images mapped so far\n\ttry {\n\t\tnotifyBatchPartial(dyld_image_state_bound, true, NULL, false, true);\n\t}\n\tcatch (const char* msg) {\n\t\t// ignore request to abort during registration\n\t}\n\n\t// <rdar://problem/32209809> call 'init' function on all images already init'ed (below libSystem)\n\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\tImageLoader* image = *it;\n\t\tif ( (image->getState() == dyld_image_state_initialized) && image->notifyObjC() ) {\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_OBJC_INIT, (uint64_t)image->machHeader(), 0, 0);\n\t\t\t(*sNotifyObjCInit)(image->getRealPath(), image->machHeader());\n\t\t}\n\t}\n}\n```\n\n sAllImages  `_dyld_objc_notify_init init`runtimemach-o class  section \n\n## <span id=\"jump_end\"></span>\n1. [Mach-O](https://www.dllhook.com/post/249.html)\n2. [Mach-O](https://paper.seebug.org/202/)\n3. [dyld](https://www.dllhook.com/post/238.html)\n4. [iOS  main ](http://blog.sunnyxx.com/2014/08/30/objc-pre-main/)\n5. [dylib](https://feicong.github.io/2017/01/14/dylib/index.html)\n\n","source":"_posts/11.dyld.md","raw":"---\ntitle:  dyld \ndate: 2020-03-13\ntags: []\ncategories: \n---\n\n.......\n\ndyld/dyld ASLRobjcruntimedyld\n\n<!-- more -->\n\n## dyld \ndyld dyldStartup.s :load dyld`__dyld_start``dyld::start` \n\n`dyld::start`\n\n```cpp\nuintptr_t start(const struct macho_header* appsMachHeader, int argc, const char* argv[], \n\t\t\t\tintptr_t slide, const struct macho_header* dyldsMachHeader,\n\t\t\t\tuintptr_t* startGlue)\n{\n\t// if kernel had to slide dyld, we need to fix up load sensitive locations\n\t// we have to do this before using any global variables\n    //dyld\n    slide = slideOfMainExecutable(dyldsMachHeader);\n    bool shouldRebase = slide != 0;\n    if ( shouldRebase ) {\n        //rebase Dyld\n        rebaseDyld(dyldsMachHeader, slide);\n    }\n\n\t// allow dyld to use mach messaging\n    //mach\n\tmach_init();\n\n\t// kernel sets up env pointer to be just past end of agv array\n    //\n\tconst char** envp = &argv[argc+1];\n\t\n\t// kernel sets up apple pointer to be just past end of envp array\n\tconst char** apple = envp;\n\twhile(*apple != NULL) { ++apple; }\n\t++apple;\n\n\t// set up random value for stack canary\n\t__guard_setup(apple);\n\n#if DYLD_INITIALIZER_SUPPORT\n\t// run all C++ initializers inside dyld\n    // dyld C++\n\trunDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);\n#endif\n\n\t// now that we are done bootstrapping dyld, call dyld's main\n    //bootstrap dyld dyld  main \n\tuintptr_t appsSlide = slideOfMainExecutable(appsMachHeader);\n\treturn dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);\n}\n```\n\n`dyld::start`\n1. <span id=\"return_rebaseDyld\">rebase dyld</span>\n[rebase dyld](#jump_rebaseDyld)\n2.  mach_msg\n\t<mach/mach_init.h>\n3. \n\tappleenvp\n4. \n\tapplestack_guard=xx\n5. <span id=\"return_runDyldInitializers\"> dyld </span>\n\tdyld(PIC )dylddyld[](#jump_runDyldInitializers)\n6.  dyld (bootstrap) dyld main\n\nstartdyld\n\n[  dyld _main](#jump__main)\n\n### <span id=\"jump_rebaseDyld\">RebaseDyld</span>\nDyldmach_oload_commanddylddyld\n\n1. Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info\n2. rebase  bind  Opcodes\n\nrebase/bind \n\n[](#return_rebaseDyld)\n\n### <span id=\"jump_runDyldInitializers\">Dyld</span>\n\n```cpp\nextern const Initializer  inits_start  __asm(\"section$start$__DATA$__mod_init_func\");\nextern const Initializer  inits_end    __asm(\"section$end$__DATA$__mod_init_func\");\n\n//\n// For a regular executable, the crt code calls dyld to run the executables initializers.\n// For a static executable, crt directly runs the initializers.\n// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.\n// We pass argc, argv, etc in case libc.a uses those arguments\n//\nstatic void runDyldInitializers(const struct macho_header* mh, intptr_t slide, int argc, const char* argv[], const char* envp[], const char* apple[])\n{\n\tfor (const Initializer* p = &inits_start; p < &inits_end; ++p) {\n\t\t(*p)(argc, argv, envp, apple);\n\t}\n}\n```\n\ndyldcrtdyldcrtdyldhack\n\n`__asm(\"section$start$__DATA$__mod_init_func\")``__DATA``__mod_init_func`\n\nDemo\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png)\n\nmach-o \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png)\n\n`__mod_init_func`,Sectiondemo_init10xED0\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png)\n\n`demo_init2`\n\ndyld`inits_start``inits_end`dyld\n\ndyld\n[](#jump_end) 1  2\n\n[](#return_runDyldInitializers)\n\n## <span id=\"jump__main\">dyld::_main</span>\ndyldrebasebindmach_msgdyld`dyld::_main` \n\n`dyld::_main`Appmain`dyld::start``__dyld_start`main\n\n_main\n\n1.  crashloglog...\n2. `// iOS cannot run without shared region`,iOS\n\tlibpath\n3. <span id=\"return_initMainExecutable\">:</span>\n\t`ImageLoaderMachO`[](#jump_initMainExecutable)\n\tClassicCompressed`ImageLoaderMachOCompressed``ImageLoaderMachOClassic``ImageLoaderMachO`\n4. `loadInsertedDylib`[Load ](#jump_loaddylib)<span id=\"return_loaddylib\">.</span>\n5. <span id=\"return_link_execution\"></span>[](#jump_link_execution)\n6. \n7. \n\n### <span id=\"jump_initMainExecutable\"></span>\ndylddyld macho_headerdyldImageLoaderMachOdyld\n\n```cpp\nstatic ImageLoaderMachO* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path)\n{\n\t// try mach-o loader\n\tif ( isCompatibleMachO((const uint8_t*)mh, path) ) {\n\t\tImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);\n\t\taddImage(image);\n\t\treturn (ImageLoaderMachO*)image;\n\t}\n\t\n\tthrow \"main executable not a known format\";\n}\n```\n\n`instantiateMainExecutable`mach-o(compress  classic)ImageLoader\n\n`addImage(image);`\n1. ImageLoader`sAllImages`\n2.  `sMappedRangesStart`  `ImageLoader`\n\n[](#return_initMainExecutable)\n\n### <span id=\"jump_loaddylib\"></span>\nDYLD_INSERT_LIBRARIESloadInsertedDylib()\n\nload()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH->LD_LIBRARY_PATH->DYLD_FRAMEWORK_PATH->->DYLD_FALLBACK_LIBRARY_PATH\n\nImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() \n\nloadPhase0()ImageLoaderMachO::instantiateFromCache()\n\n\n\n\n```cpp\n// map in file and instantiate an ImageLoader\n// ImagerLoader\nstatic ImageLoader* loadPhase6(int fd, const struct stat& stat_buf, const char* path, const LoadContext& context)\n{\n\t//dyld::log(\"%s(%s)\\n\", __func__ , path);\n\tuint64_t fileOffset = 0;\n\tuint64_t fileLength = stat_buf.st_size;\n\n\t// validate it is a file (not directory)\n\tif ( (stat_buf.st_mode & S_IFMT) != S_IFREG ) \n\t\tthrow \"not a file\";\n\n\tuint8_t firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];\n\tuint8_t *firstPagesPtr = firstPages;\n\tbool shortPage = false;\n\t\n\t// min mach-o file is 4K\n\t// mach-o4k\n\tif ( fileLength < 4096 ) {\n\t\tif ( pread(fd, firstPages, (size_t)fileLength, 0) != (ssize_t)fileLength )\n\t\t\tthrowf(\"pread of short file failed: %d\", errno);\n\t\tshortPage = true;\n\t} \n\telse {\n\t\t// optimistically read only first 4KB\n\t\t// header4kb4k\n\t\tif ( pread(fd, firstPages, 4096, 0) != 4096 )\n\t\t\tthrowf(\"pread of first 4K failed: %d\", errno);\n\t}\n\t\n\t// if fat wrapper, find usable sub-file\n\t// fat\n\tconst fat_header* fileStartAsFat = (fat_header*)firstPages;\n\tif ( fileStartAsFat->magic == OSSwapBigToHostInt32(FAT_MAGIC) ) {\n\t\tif ( OSSwapBigToHostInt32(fileStartAsFat->nfat_arch) > ((4096 - sizeof(fat_header)) / sizeof(fat_arch)) )\n\t\t\tthrowf(\"fat header too large: %u entries\", OSSwapBigToHostInt32(fileStartAsFat->nfat_arch));\n\t\tif ( fatFindBest(fileStartAsFat, &fileOffset, &fileLength) ) {\n\t\t\tif ( (fileOffset+fileLength) > (uint64_t)(stat_buf.st_size) )\n\t\t\t\tthrowf(\"truncated fat file.  file length=%llu, but needed slice goes to %llu\", stat_buf.st_size, fileOffset+fileLength);\n\t\t\tif (pread(fd, firstPages, 4096, fileOffset) != 4096)\n\t\t\t\tthrowf(\"pread of fat file failed: %d\", errno);\n\t\t}\n\t\telse {\n\t\t\tthrow \"no matching architecture in universal wrapper\";\n\t\t}\n\t}\n\t\n\t// try mach-o loader\n\tif ( shortPage ) \n\t\tthrow \"file too short\";\n\n\tif ( isCompatibleMachO(firstPages, path) ) {\n\n\t\t// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded\n\t\tconst mach_header* mh = (mach_header*)firstPages;\n\t\tswitch ( mh->filetype ) {\n\t\t\tcase MH_EXECUTE:\n\t\t\tcase MH_DYLIB:\n\t\t\tcase MH_BUNDLE:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow \"mach-o, but wrong filetype\";\n\t\t}\n\n\t\tuint32_t headerAndLoadCommandsSize = sizeof(macho_header) + mh->sizeofcmds;\n\t\tif ( headerAndLoadCommandsSize > MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )\n\t\t\tthrowf(\"malformed mach-o: load commands size (%u) > %u\", headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);\n\n\t\tif ( headerAndLoadCommandsSize > fileLength )\n\t\t\tdyld::throwf(\"malformed mach-o: load commands size (%u) > mach-o file size (%llu)\", headerAndLoadCommandsSize, fileLength);\n\n\t\tif ( headerAndLoadCommandsSize > 4096 ) {\n\t\t\t// read more pages\n\t\t\t//  head  LC_COMMANDS4096 headerAndLoadCommandsSize \n\t\t\tunsigned readAmount = headerAndLoadCommandsSize - 4096;\n\t\t\tif ( pread(fd, &firstPages[4096], readAmount, fileOffset+4096) != readAmount )\n\t\t\t\tthrowf(\"pread of extra load commands past 4KB failed: %d\", errno);\n\t\t}\n\n#if TARGET_IPHONE_SIMULATOR\t\n\t\t// <rdar://problem/14168872> dyld_sim should restrict loading osx binaries\n\t\tif ( !isSimulatorBinary(firstPages, path) ) {\n\t#if TARGET_OS_WATCH\n\t\t\tthrow \"mach-o, but not built for watchOS simulator\";\n\t#elif TARGET_OS_TV\n\t\t\tthrow \"mach-o, but not built for tvOS simulator\";\n\t#else\n\t\t\tthrow \"mach-o, but not built for iOS simulator\";\n\t#endif\n\t\t}\n#endif\n\n#if __MAC_OS_X_VERSION_MIN_REQUIRED\n\t\tif ( gLinkContext.marzipan ) {\n\t\t\tconst dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;\n\t\t\tbool isiOSMacBinary = mf->supportsPlatform(dyld3::Platform::iOSMac) || iOSMacWhiteListed(path);\n\t\t\tbool isProhibitedMacOSBinary = !isiOSMacBinary && iOSMacBlackListed(path);\n\t\t\tif ( (context.enforceIOSMac && !isiOSMacBinary) || isProhibitedMacOSBinary ) {\n\t\t\t\tthrow \"mach-o, but not built for iOSMac\";\n\t\t\t}\n\t\t}\n#endif\n\n#if __arm64e__\n\t\tif ( (sMainExecutableMachHeader->cpusubtype == CPU_SUBTYPE_ARM64_E) && (mh->cpusubtype != CPU_SUBTYPE_ARM64_E) )\n\t\t\tthrow \"arm64 dylibs cannot be loaded into arm64e processes\";\n#endif\n\t\tImageLoader* image = nullptr;\n\t\t{\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_MAP_IMAGE, path, 0, 0);\n\t\t\t// instantiateFromFile  ImageLoader\n\t\t\timage = ImageLoaderMachO::instantiateFromFile(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);\n\t\t\ttimer.setData4((uint64_t)image->machHeader());\n\t\t}\n\t\t\n\t\t// validate\n\t\t// \n\t\treturn checkandAddImage(image, context);\n\t}\n\t\n\t// try other file formats here...\n\t\n\t\n\t// throw error about what was found\n\tswitch (*(uint32_t*)firstPages) {\n\t\tcase MH_MAGIC:\n\t\tcase MH_CIGAM:\n\t\tcase MH_MAGIC_64:\n\t\tcase MH_CIGAM_64:\n\t\t\tthrow \"mach-o, but wrong architecture\";\n\t\tdefault:\n\t\tthrowf(\"unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X\", \n\t\t\tfirstPages[0], firstPages[1], firstPages[2], firstPages[3], firstPages[4], firstPages[5], firstPages[6],firstPages[7]);\n\t}\n}\n```\n\n`ImageLoader`\n\n\n1. 4k4k, fat_header\n2. fatCPU\n3. \n4.  head  Load_Commands 4k headerAndLoadCommandsSize `ImageLoader``ImageLoader` Load_Commands \n5. checkandAddImage\n\n\n checkandAddImage\n```cpp\nstatic ImageLoader* checkandAddImage(ImageLoader* image, const LoadContext& context)\n{\n\t// now sanity check that this loaded image does not have the same install path as any existing image\n\t// sAllImages \n\tconst char* loadedImageInstallPath = image->getInstallPath();\n\tif ( image->isDylib() && (loadedImageInstallPath != NULL) && (loadedImageInstallPath[0] == '/') ) {\n\t\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\t\tImageLoader* anImage = *it;\n\t\t\tconst char* installPath = anImage->getInstallPath();\n\t\t\tif ( installPath != NULL) {\n\t\t\t\tif ( strcmp(loadedImageInstallPath, installPath) == 0 ) {\n\t\t\t\t\t//dyld::log(\"duplicate(%s) => %p\\n\", installPath, anImage);\n\t\t\t\t\tremoveImage(image);\n\t\t\t\t\tImageLoader::deleteImage(image);\n\t\t\t\t\treturn anImage;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// some API's restrict what they can load\n\tif ( context.mustBeBundle && !image->isBundle() )\n\t\tthrow \"not a bundle\";\n\tif ( context.mustBeDylib && !image->isDylib() )\n\t\tthrow \"not a dylib\";\n\n\t// regular main executables cannot be loaded \n\tif ( image->isExecutable() ) {\n\t\tif ( !context.canBePIE || !image->isPositionIndependentExecutable() )\n\t\t\tthrow \"can't load a main executable\";\n\t}\n\t\n\t// don't add bundles to global list, they can be loaded but not linked.  When linked it will be added to list\n\tif ( ! image->isBundle() )\n\t\t//\n\t\taddImage(image);\n\t\n\treturn image;\n}\n```\n\n`AddImage`\n\n[](#return_loaddylib)\n\n### <span id=\"jump_link_execution\">Link </span>\ndyld\n\n`void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain& loaderRPaths, unsigned cacheIndex)`\n\n_main mach-o   `ImageLoader.link`\n\n```cpp\nvoid ImageLoader::link(const LinkContext& context, bool forceLazysBound, bool preflightOnly, bool neverUnload, const RPathChain& loaderRPaths, const char* imagePath)\n{\n\t//dyld::log(\"ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n\", imagePath, fDlopenReferenceCount, fNeverUnload);\n\t\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\tuint64_t t0 = mach_absolute_time();\n\tthis->recursiveLoadLibraries(context, preflightOnly, loaderRPaths, imagePath);\n\tcontext.notifyBatch(dyld_image_state_dependents_mapped, preflightOnly);\n\n\t// we only do the loading step for preflights\n\tif ( preflightOnly )\n\t\treturn;\n\n\tuint64_t t1 = mach_absolute_time();\n\tcontext.clearAllDepths();\n\tthis->recursiveUpdateDepth(context.imageCount());\n\n\t__block uint64_t t2, t3, t4, t5;\n\t{\n\t\tdyld3::ScopedTimer(DBG_DYLD_TIMING_APPLY_FIXUPS, 0, 0, 0);\n\t\tt2 = mach_absolute_time();\n\t\tthis->recursiveRebase(context);\n\t\tcontext.notifyBatch(dyld_image_state_rebased, false);\n\n\t\tt3 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->recursiveBindWithAccounting(context, forceLazysBound, neverUnload);\n\n\t\tt4 = mach_absolute_time();\n\t\tif ( !context.linkingMainExecutable )\n\t\t\tthis->weakBind(context);\n\t\tt5 = mach_absolute_time();\n\t}\n\n    if ( !context.linkingMainExecutable )\n        context.notifyBatch(dyld_image_state_bound, false);\n\tuint64_t t6 = mach_absolute_time();\t\n\n\tstd::vector<DOFInfo> dofs;\n\tthis->recursiveGetDOFSections(context, dofs);\n\tcontext.registerDOFs(dofs);\n\tuint64_t t7 = mach_absolute_time();\t\n\n\t// interpose any dynamically loaded images\n\tif ( !context.linkingMainExecutable && (fgInterposingTuples.size() != 0) ) {\n\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_APPLY_INTERPOSING, 0, 0, 0);\n\t\tthis->recursiveApplyInterposing(context);\n\t}\n\n\t// clear error strings\n\t(*context.setErrorStrings)(0, NULL, NULL, NULL);\n\n\t//log\n\tfgTotalLoadLibrariesTime += t1 - t0;\n\tfgTotalRebaseTime += t3 - t2;\n\tfgTotalBindTime += t4 - t3;\n\tfgTotalWeakBindTime += t5 - t4;\n\tfgTotalDOF += t7 - t6;\n\t\n\t// done with initial dylib loads\n\tfgNextPIEDylibAddress = 0;\n}\n```\n\n\n1. `this->recursiveLoadLibraries`  (LoadLoadopenImageLoader)Load\n2. `this->recursiveUpdateDepth` \n3. <span id=\"return_rebase\">`this->recursiveRebase`</span>\n\trebaserecursiveRebaserebase`rebase(const LinkContext& context, uintptr_t slide)`[Rebase](#jump_rebase)\n4. `this->recursiveBindWithAccounting`\n\tnon-lazy bindlazy bindRebaserebind`doBind(const LinkContext& context, bool forceLazysBound)`\n5. `this->weakBind` \n6. `this->recursiveGetDOFSections` DOF\n7. `this->recursiveApplyInterposing`\n\nlog\n\n### <span id=\"jump_rebase\">Rebase</span>\n Rebase \n\nRebaseASLRmach-oPIC\"rebase\"\n\nPICrebase\n\n/  ()mach-o`__mod_init_func`dyld vmaddr -- slide\n\ncompressed mach-o(mach-o) `ImageLoaderMachOCompressed`\n\n rebase mach-o\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png)\n\n rebase   --  opcode  immediate\n\n\nREBASE_OPCODE_TYPE_IMM == 11:TypeType\nREBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB == 22:rebase2segmentuleb\nuleb128 == 24:uleb\nREBASE_OPCODE_DO_REBASE_IMM_TIMES == 2:rebase2\n\n224rebase\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png)\n\n02 0x3000 +  24 =0x3018 \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png)\n\n`__mod_init_func`~\n\nrebase    \n```cpp\nvoid ImageLoaderMachOCompressed::rebase(const LinkContext& context, uintptr_t slide)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\t// fLinkEditBase __LINKEDIT    == slide\n\t// start  rebase\n\tconst uint8_t* const start = fLinkEditBase + fDyldInfo->rebase_off;\n\t// end  rebase\n\tconst uint8_t* const end = &start[fDyldInfo->rebase_size];\n\tconst uint8_t* p = start;\n\n\ttry {\n\t\tuint8_t type = 0;\n\t\tint segmentIndex = 0;\n\t\tuintptr_t address = segActualLoadAddress(0);\n\t\tuintptr_t segmentStartAddress = segActualLoadAddress(0);//N\n\t\tuintptr_t segmentEndAddress = segActualEndAddress(0);//N\n\t\tuintptr_t count;\n\t\tuintptr_t skip;\n\t\tbool done = false;\n\t\twhile ( !done && (p < end) ) {\n\t\t\tuint8_t immediate = *p & REBASE_IMMEDIATE_MASK;\n\t\t\tuint8_t opcode = *p & REBASE_OPCODE_MASK;\n\t\t\t++p;\n\t\t\tswitch (opcode) {\n\t\t\t\tcase REBASE_OPCODE_DONE:\n\t\t\t\t\tdone = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_TYPE_IMM:\n\t\t\t\t\ttype = immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:\n\t\t\t\t\tsegmentIndex = immediate;\n\t\t\t\t\tif ( segmentIndex >= fSegmentsCount )\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)\",\n\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount-1);\n\t\t\t#if TEXT_RELOC_SUPPORT\n\t\t\t\t\tif ( !segWriteable(segmentIndex) && !segHasRebaseFixUps(segmentIndex) && !segHasBindFixUps(segmentIndex) )\n\t\t\t#else\n\t\t\t\t\tif ( !segWriteable(segmentIndex) )\n\t\t\t#endif\n\t\t\t\t\t\tdyld::throwf(\"REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)\",\n\t\t\t\t\t\t\t\tsegmentIndex, segName(segmentIndex));\n\t\t\t\t\t//\n\t\t\t\t\tsegmentStartAddress = segActualLoadAddress(segmentIndex);\n\t\t\t\t\tsegmentEndAddress = segActualEndAddress(segmentIndex);\n\t\t\t\t\t\n\t\t\t\t\taddress = segmentStartAddress + read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_ULEB:\n\t\t\t\t\taddress += read_uleb128(p, end);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_ADD_ADDR_IMM_SCALED:\n\t\t\t\t\taddress += immediate*sizeof(uintptr_t);\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_IMM_TIMES:\n\t\t\t\t\tfor (int i=0; i < immediate; ++i) {//N\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += immediate;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:\n\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\taddress += read_uleb128(p, end) + sizeof(uintptr_t);\n\t\t\t\t\t++fgTotalRebaseFixups;\n\t\t\t\t\tbreak;\n\t\t\t\tcase REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:\n\t\t\t\t\tcount = read_uleb128(p, end);\n\t\t\t\t\tskip = read_uleb128(p, end);\n\t\t\t\t\tfor (uint32_t i=0; i < count; ++i) {\n\t\t\t\t\t\tif ( (address < segmentStartAddress) || (address >= segmentEndAddress) )\n\t\t\t\t\t\t\tthrowBadRebaseAddress(address, segmentEndAddress, segmentIndex, start, end, p);\n\t\t\t\t\t\trebaseAt(context, address, slide, type);\n\t\t\t\t\t\taddress += skip + sizeof(uintptr_t);\n\t\t\t\t\t}\n\t\t\t\t\tfgTotalRebaseFixups += count;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tdyld::throwf(\"bad rebase opcode %d\", *(p-1));\n\t\t\t}\n\t\t}\n\t}\n\tcatch (const char* msg) {\n\t\tconst char* newMsg = dyld::mkstringf(\"%s in %s\", msg, this->getPath());\n\t\tfree((void*)msg);\n\t\tthrow newMsg;\n\t}\n\tCRSetCrashLogMessage2(NULL);\n}\n```\n## <span id=\"jump_init_main_execution\">initializeMainExecutable</span>\n/rebase/bind...runtime\n\n```cpp\nvoid initializeMainExecutable()\n{\n\t// record that we've reached this step\n\tgLinkContext.startedInitializingMainExecutable = true;\n\n\t// run initialzers for any inserted dylibs\n\tImageLoader::InitializerTimingList initializerTimes[allImagesCount()];\n\tinitializerTimes[0].count = 0;\n\tconst size_t rootCount = sImageRoots.size();\n\tif ( rootCount > 1 ) {\n\t\tfor(size_t i=1; i < rootCount; ++i) {\n\t\t\tsImageRoots[i]->runInitializers(gLinkContext, initializerTimes[0]);\n\t\t}\n\t}\n\t\n\t// run initializers for main executable and everything it brings up \n\tsMainExecutable->runInitializers(gLinkContext, initializerTimes[0]);\n\t\n\t// register cxa_atexit() handler to run static terminators in all loaded images when this process exits\n\tif ( gLibSystemHelpers != NULL ) \n\t\t(*gLibSystemHelpers->cxa_atexit)(&runAllStaticTerminators, NULL, NULL);\n\n\t// dump info if requested\n\tif ( sEnv.DYLD_PRINT_STATISTICS )\n\t\tImageLoader::printStatistics((unsigned int)allImagesCount(), initializerTimes[0]);\n\tif ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )\n\t\tImageLoaderMachO::printStatisticsDetails((unsigned int)allImagesCount(), initializerTimes[0]);\n}\n\n```\n\n\n\nsMainExecutable->runInitializers \n```cpp\nvoid ImageLoader::runInitializers(const LinkContext& context, InitializerTimingList& timingInfo)\n{\n\tuint64_t t1 = mach_absolute_time();\n\tmach_port_t thisThread = mach_thread_self();\n\tImageLoader::UninitedUpwards up;\n\tup.count = 1;\n\tup.images[0] = this;\n\tprocessInitializers(context, thisThread, timingInfo, up);\n\tcontext.notifyBatch(dyld_image_state_initialized, false);\n\tmach_port_deallocate(mach_task_self(), thisThread);\n\tuint64_t t2 = mach_absolute_time();\n\tfgTotalInitTime += (t2 - t1);\n}\n```\nprocessInitializers \n```cpp\nvoid ImageLoader::processInitializers(const LinkContext& context, mach_port_t thisThread,\n\t\t\t\t\t\t\t\t\t InitializerTimingList& timingInfo, ImageLoader::UninitedUpwards& images)\n{\n\tuint32_t maxImageCount = context.imageCount()+2;\n\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];\n\tImageLoader::UninitedUpwards& ups = upsBuffer[0];\n\tups.count = 0;\n\t// Calling recursive init on all images in images list, building a new list of\n\t// uninitialized upward dependencies.\n\tfor (uintptr_t i=0; i < images.count; ++i) {\n\t\timages.images[i]->recursiveInitialization(context, thisThread, images.images[i]->getPath(), timingInfo, ups);\n\t}\n\t// If any upward dependencies remain, init them.\n\tif ( ups.count > 0 )\n\t\tprocessInitializers(context, thisThread, timingInfo, ups);\n}\n```\n\nrecursiveInitialization \n```cpp\nvoid ImageLoader::recursiveInitialization(const LinkContext& context, mach_port_t this_thread, const char* pathToInitialize,\n\t\t\t\t\t\t\t\t\t\t  InitializerTimingList& timingInfo, UninitedUpwards& uninitUps)\n{\n\trecursive_lock lock_info(this_thread);\n\trecursiveSpinLock(lock_info);\n\n\tif ( fState < dyld_image_state_dependents_initialized-1 ) {\n\t\tuint8_t oldState = fState;\n\t\t// break cycles\n\t\tfState = dyld_image_state_dependents_initialized-1;\n\t\ttry {\n\t\t\t// initialize lower level libraries first\n\t\t\tfor(unsigned int i=0; i < libraryCount(); ++i) {\n\t\t\t\tImageLoader* dependentImage = libImage(i);\n\t\t\t\tif ( dependentImage != NULL ) {\n\t\t\t\t\t// don't try to initialize stuff \"above\" me yet\n\t\t\t\t\tif ( libIsUpward(i) ) {\n\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;\n\t\t\t\t\t\tuninitUps.count++;\n\t\t\t\t\t}\n\t\t\t\t\telse if ( dependentImage->fDepth >= fDepth ) {\n\t\t\t\t\t\tdependentImage->recursiveInitialization(context, this_thread, libPath(i), timingInfo, uninitUps);\n\t\t\t\t\t}\n                }\n\t\t\t}\n\t\t\t\n\t\t\t// record termination order\n\t\t\tif ( this->needsTermination() )\n\t\t\t\tcontext.terminationRecorder(this);\n\t\t\t\n\t\t\t// let objc know we are about to initialize this image\n\t\t\tuint64_t t1 = mach_absolute_time();\n\t\t\tfState = dyld_image_state_dependents_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_dependents_initialized, this, &timingInfo);\n\t\t\t\n\t\t\t// initialize this image\n\t\t\tbool hasInitializers = this->doInitialization(context);\n\n\t\t\t// let anyone know we finished initializing this image\n\t\t\tfState = dyld_image_state_initialized;\n\t\t\toldState = fState;\n\t\t\tcontext.notifySingle(dyld_image_state_initialized, this, NULL);\n\t\t\t\n\t\t\tif ( hasInitializers ) {\n\t\t\t\tuint64_t t2 = mach_absolute_time();\n\t\t\t\ttimingInfo.addTime(this->getShortName(), t2-t1);\n\t\t\t}\n\t\t}\n\t\tcatch (const char* msg) {\n\t\t\t// this image is not initialized\n\t\t\tfState = oldState;\n\t\t\trecursiveSpinUnLock();\n\t\t\tthrow;\n\t\t}\n\t}\n\t\n\trecursiveSpinUnLock();\n}\n```\n\ndoInitialization \n```cpp\nbool ImageLoaderMachO::doInitialization(const LinkContext& context)\n{\n\tCRSetCrashLogMessage2(this->getPath());\n\n\t// mach-o has -init and static initializers\n\tdoImageInit(context);\n\tdoModInitFunctions(context);\n\t\n\tCRSetCrashLogMessage2(NULL);\n\t\n\treturn (fHasDashInit || fHasInitializers);\n}\n```\n\n doModInitFunctions dyld_mod_init_func\n\nruntime:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png)\n\n libSystem.B.dylib -> libdispatch.dylib -> libobjc.A.dylib runtime\nruntime dyld\n`_dyld_objc_notify_register(&map_images, load_images, unmap_image);`\n\nloadruntime\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png)\n\n\n```cpp\nvoid registerObjCNotifiers(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)\n{\n\t// record functions to call\n\tsNotifyObjCMapped\t= mapped;\n\tsNotifyObjCInit\t\t= init;\n\tsNotifyObjCUnmapped = unmapped;\n\n\t// call 'mapped' function with all images mapped so far\n\ttry {\n\t\tnotifyBatchPartial(dyld_image_state_bound, true, NULL, false, true);\n\t}\n\tcatch (const char* msg) {\n\t\t// ignore request to abort during registration\n\t}\n\n\t// <rdar://problem/32209809> call 'init' function on all images already init'ed (below libSystem)\n\tfor (std::vector<ImageLoader*>::iterator it=sAllImages.begin(); it != sAllImages.end(); it++) {\n\t\tImageLoader* image = *it;\n\t\tif ( (image->getState() == dyld_image_state_initialized) && image->notifyObjC() ) {\n\t\t\tdyld3::ScopedTimer timer(DBG_DYLD_TIMING_OBJC_INIT, (uint64_t)image->machHeader(), 0, 0);\n\t\t\t(*sNotifyObjCInit)(image->getRealPath(), image->machHeader());\n\t\t}\n\t}\n}\n```\n\n sAllImages  `_dyld_objc_notify_init init`runtimemach-o class  section \n\n## <span id=\"jump_end\"></span>\n1. [Mach-O](https://www.dllhook.com/post/249.html)\n2. [Mach-O](https://paper.seebug.org/202/)\n3. [dyld](https://www.dllhook.com/post/238.html)\n4. [iOS  main ](http://blog.sunnyxx.com/2014/08/30/objc-pre-main/)\n5. [dylib](https://feicong.github.io/2017/01/14/dylib/index.html)\n\n","slug":"11.dyld","published":1,"updated":"2020-08-29T14:42:58.494Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2kx000693c929wiexfk","content":"<p>.</p>\n<p>dyld&#x2F;dyld ASLRobjcruntimedyld</p>\n<span id=\"more\"></span>\n\n<h2 id=\"dyld-\"><a href=\"#dyld-\" class=\"headerlink\" title=\"dyld \"></a>dyld </h2><p>dyld dyldStartup.s :load dyld<code>__dyld_start</code><code>dyld::start</code> </p>\n<p><code>dyld::start</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">uintptr_t</span> <span class=\"title\">start</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* appsMachHeader, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">intptr_t</span> slide, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* dyldsMachHeader,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">uintptr_t</span>* startGlue)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class=\"line\">\t<span class=\"comment\">// we have to do this before using any global variables</span></span><br><span class=\"line\">    <span class=\"comment\">//dyld</span></span><br><span class=\"line\">    slide = <span class=\"built_in\">slideOfMainExecutable</span>(dyldsMachHeader);</span><br><span class=\"line\">    <span class=\"type\">bool</span> shouldRebase = slide != <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( shouldRebase ) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//rebase Dyld</span></span><br><span class=\"line\">        <span class=\"built_in\">rebaseDyld</span>(dyldsMachHeader, slide);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// allow dyld to use mach messaging</span></span><br><span class=\"line\">    <span class=\"comment\">//mach</span></span><br><span class=\"line\">\t<span class=\"built_in\">mach_init</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** envp = &amp;argv[argc+<span class=\"number\">1</span>];</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** apple = envp;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*apple != <span class=\"literal\">NULL</span>) &#123; ++apple; &#125;</span><br><span class=\"line\">\t++apple;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// set up random value for stack canary</span></span><br><span class=\"line\">\t__guard_setup(apple);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class=\"line\">\t<span class=\"comment\">// run all C++ initializers inside dyld</span></span><br><span class=\"line\">    <span class=\"comment\">// dyld C++</span></span><br><span class=\"line\">\t<span class=\"built_in\">runDyldInitializers</span>(dyldsMachHeader, slide, argc, argv, envp, apple);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class=\"line\">    <span class=\"comment\">//bootstrap dyld dyld  main </span></span><br><span class=\"line\">\t<span class=\"type\">uintptr_t</span> appsSlide = <span class=\"built_in\">slideOfMainExecutable</span>(appsMachHeader);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>dyld::start</code></p>\n<ol>\n<li><span id=\"return_rebaseDyld\">rebase dyld</span><br><a href=\"#jump_rebaseDyld\">rebase dyld</a></li>\n<li> mach_msg<br> &lt;mach&#x2F;mach_init.h&gt;</li>\n<li><br> appleenvp</li>\n<li><br> applestack_guard&#x3D;xx</li>\n<li><span id=\"return_runDyldInitializers\"> dyld </span><br> dyld(PIC )dylddyld<a href=\"#jump_runDyldInitializers\"></a></li>\n<li> dyld (bootstrap) dyld main</li>\n</ol>\n<p>startdyld</p>\n<p><a href=\"#jump__main\">  dyld _main</a></p>\n<h3 id=\"RebaseDyld\"><a href=\"#RebaseDyld\" class=\"headerlink\" title=\"RebaseDyld\"></a><span id=\"jump_rebaseDyld\">RebaseDyld</span></h3><p>Dyldmach_oload_commanddylddyld</p>\n<ol>\n<li>Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info</li>\n<li>rebase  bind  Opcodes</li>\n</ol>\n<p>rebase&#x2F;bind </p>\n<p><a href=\"#return_rebaseDyld\"></a></p>\n<h3 id=\"Dyld\"><a href=\"#Dyld\" class=\"headerlink\" title=\"Dyld\"></a><span id=\"jump_runDyldInitializers\">Dyld</span></h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_start  __asm(<span class=\"string\">&quot;section$start$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_end    __asm(<span class=\"string\">&quot;section$end$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// For a regular executable, the crt code calls dyld to run the executables initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// For a static executable, crt directly runs the initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// We pass argc, argv, etc in case libc.a uses those arguments</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">runDyldInitializers</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* mh, <span class=\"type\">intptr_t</span> slide, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], <span class=\"type\">const</span> <span class=\"type\">char</span>* envp[], <span class=\"type\">const</span> <span class=\"type\">char</span>* apple[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">const</span> Initializer* p = &amp;inits_start; p &lt; &amp;inits_end; ++p) &#123;</span><br><span class=\"line\">\t\t(*p)(argc, argv, envp, apple);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>dyldcrtdyldcrtdyldhack</p>\n<p><code>__asm(&quot;section$start$__DATA$__mod_init_func&quot;)</code><code>__DATA</code><code>__mod_init_func</code></p>\n<p>Demo<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png\"></p>\n<p>mach-o <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png\"></p>\n<p><code>__mod_init_func</code>,Sectiondemo_init10xED0</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png\"></p>\n<p><code>demo_init2</code></p>\n<p>dyld<code>inits_start</code><code>inits_end</code>dyld</p>\n<p>dyld<br><a href=\"#jump_end\"></a> 1  2</p>\n<p><a href=\"#return_runDyldInitializers\"></a></p>\n<h2 id=\"dyld-main\"><a href=\"#dyld-main\" class=\"headerlink\" title=\"dyld::_main\"></a><span id=\"jump__main\">dyld::_main</span></h2><p>dyldrebasebindmach_msgdyld<code>dyld::_main</code> </p>\n<p><code>dyld::_main</code>Appmain<code>dyld::start</code><code>__dyld_start</code>main</p>\n<p>_main</p>\n<ol>\n<li> crashloglog</li>\n<li><code>// iOS cannot run without shared region</code>,iOS<br> libpath</li>\n<li><span id=\"return_initMainExecutable\">:</span><br> <code>ImageLoaderMachO</code><a href=\"#jump_initMainExecutable\"></a><br> ClassicCompressed<code>ImageLoaderMachOCompressed</code><code>ImageLoaderMachOClassic</code><code>ImageLoaderMachO</code></li>\n<li><code>loadInsertedDylib</code><a href=\"#jump_loaddylib\">Load </a><span id=\"return_loaddylib\">.</span></li>\n<li><span id=\"return_link_execution\"></span><a href=\"#jump_link_execution\"></a></li>\n<li></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_initMainExecutable\"></span></h3><p>dylddyld macho_headerdyldImageLoaderMachOdyld</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoaderMachO* <span class=\"title\">instantiateFromLoadedImage</span><span class=\"params\">(<span class=\"type\">const</span> macho_header* mh, <span class=\"type\">uintptr_t</span> slide, <span class=\"type\">const</span> <span class=\"type\">char</span>* path)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>((<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>*)mh, path) ) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = ImageLoaderMachO::<span class=\"built_in\">instantiateMainExecutable</span>(mh, slide, path, gLinkContext);</span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (ImageLoaderMachO*)image;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;main executable not a known format&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>instantiateMainExecutable</code>mach-o(compress  classic)ImageLoader</p>\n<p><code>addImage(image);</code></p>\n<ol>\n<li>ImageLoader<code>sAllImages</code></li>\n<li> <code>sMappedRangesStart</code>  <code>ImageLoader</code></li>\n</ol>\n<p><a href=\"#return_initMainExecutable\"></a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_loaddylib\"></span></h3><p>DYLD_INSERT_LIBRARIESloadInsertedDylib()</p>\n<p>load()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH-&gt;LD_LIBRARY_PATH-&gt;DYLD_FRAMEWORK_PATH-&gt;-&gt;DYLD_FALLBACK_LIBRARY_PATH</p>\n<p>ImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() </p>\n<p>loadPhase0()ImageLoaderMachO::instantiateFromCache()</p>\n<p></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// map in file and instantiate an ImageLoader</span></span><br><span class=\"line\"><span class=\"comment\">// ImagerLoader</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">loadPhase6</span><span class=\"params\">(<span class=\"type\">int</span> fd, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> stat&amp; stat_buf, <span class=\"type\">const</span> <span class=\"type\">char</span>* path, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;%s(%s)\\n&quot;, __func__ , path);</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileOffset = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileLength = stat_buf.st_size;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// validate it is a file (not directory)</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( (stat_buf.st_mode &amp; S_IFMT) != S_IFREG ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a file&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];</span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> *firstPagesPtr = firstPages;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> shortPage = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// min mach-o file is 4K</span></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o4k</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileLength &lt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, (<span class=\"type\">size_t</span>)fileLength, <span class=\"number\">0</span>) != (<span class=\"type\">ssize_t</span>)fileLength )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of short file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\tshortPage = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125; </span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// optimistically read only first 4KB</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// header4kb4k</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, <span class=\"number\">0</span>) != <span class=\"number\">4096</span> )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of first 4K failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// if fat wrapper, find usable sub-file</span></span><br><span class=\"line\">\t<span class=\"comment\">// fat</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> fat_header* fileStartAsFat = (fat_header*)firstPages;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileStartAsFat-&gt;magic == <span class=\"built_in\">OSSwapBigToHostInt32</span>(FAT_MAGIC) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch) &gt; ((<span class=\"number\">4096</span> - <span class=\"built_in\">sizeof</span>(fat_header)) / <span class=\"built_in\">sizeof</span>(fat_arch)) )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;fat header too large: %u entries&quot;</span>, <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch));</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">fatFindBest</span>(fileStartAsFat, &amp;fileOffset, &amp;fileLength) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (fileOffset+fileLength) &gt; (<span class=\"type\">uint64_t</span>)(stat_buf.st_size) )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;truncated fat file.  file length=%llu, but needed slice goes to %llu&quot;</span>, stat_buf.st_size, fileOffset+fileLength);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, fileOffset) != <span class=\"number\">4096</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of fat file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;no matching architecture in universal wrapper&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( shortPage ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;file too short&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>(firstPages, path) ) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded</span></span><br><span class=\"line\">\t\t<span class=\"type\">const</span> mach_header* mh = (mach_header*)firstPages;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> ( mh-&gt;filetype ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_EXECUTE:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_DYLIB:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_BUNDLE:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong filetype&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> headerAndLoadCommandsSize = <span class=\"built_in\">sizeof</span>(macho_header) + mh-&gt;sizeofcmds;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; %u&quot;</span>, headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; fileLength )</span><br><span class=\"line\">\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; mach-o file size (%llu)&quot;</span>, headerAndLoadCommandsSize, fileLength);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// read more pages</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//  head  LC_COMMANDS4096 headerAndLoadCommandsSize </span></span><br><span class=\"line\">\t\t\t<span class=\"type\">unsigned</span> readAmount = headerAndLoadCommandsSize - <span class=\"number\">4096</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, &amp;firstPages[<span class=\"number\">4096</span>], readAmount, fileOffset+<span class=\"number\">4096</span>) != readAmount )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of extra load commands past 4KB failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_IPHONE_SIMULATOR\t</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// &lt;rdar://problem/14168872&gt; dyld_sim should restrict loading osx binaries</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">isSimulatorBinary</span>(firstPages, path) ) &#123;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_OS_WATCH</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for watchOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">elif</span> TARGET_OS_TV</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for tvOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( gLinkContext.marzipan ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isiOSMacBinary = mf-&gt;<span class=\"built_in\">supportsPlatform</span>(dyld3::Platform::iOSMac) || <span class=\"built_in\">iOSMacWhiteListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isProhibitedMacOSBinary = !isiOSMacBinary &amp;&amp; <span class=\"built_in\">iOSMacBlackListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (context.enforceIOSMac &amp;&amp; !isiOSMacBinary) || isProhibitedMacOSBinary ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOSMac&quot;</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __arm64e__</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (sMainExecutableMachHeader-&gt;cpusubtype == CPU_SUBTYPE_ARM64_E) &amp;&amp; (mh-&gt;cpusubtype != CPU_SUBTYPE_ARM64_E) )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;arm64 dylibs cannot be loaded into arm64e processes&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\tImageLoader* image = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_MAP_IMAGE, path, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// instantiateFromFile  ImageLoader</span></span><br><span class=\"line\">\t\t\timage = ImageLoaderMachO::<span class=\"built_in\">instantiateFromFile</span>(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);</span><br><span class=\"line\">\t\t\ttimer.<span class=\"built_in\">setData4</span>((<span class=\"type\">uint64_t</span>)image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"comment\">// validate</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// </span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"built_in\">checkandAddImage</span>(image, context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try other file formats here...</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// throw error about what was found</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> (*(<span class=\"type\">uint32_t</span>*)firstPages) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC_64:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM_64:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong architecture&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X&quot;</span>, </span><br><span class=\"line\">\t\t\tfirstPages[<span class=\"number\">0</span>], firstPages[<span class=\"number\">1</span>], firstPages[<span class=\"number\">2</span>], firstPages[<span class=\"number\">3</span>], firstPages[<span class=\"number\">4</span>], firstPages[<span class=\"number\">5</span>], firstPages[<span class=\"number\">6</span>],firstPages[<span class=\"number\">7</span>]);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>ImageLoader</code></p>\n<p></p>\n<ol>\n<li>4k4k, fat_header</li>\n<li>fatCPU</li>\n<li></li>\n<li> head  Load_Commands 4k headerAndLoadCommandsSize <code>ImageLoader</code><code>ImageLoader</code> Load_Commands </li>\n<li>checkandAddImage</li>\n</ol>\n<p> checkandAddImage</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">checkandAddImage</span><span class=\"params\">(ImageLoader* image, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// now sanity check that this loaded image does not have the same install path as any existing image</span></span><br><span class=\"line\">\t<span class=\"comment\">// sAllImages </span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>* loadedImageInstallPath = image-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isDylib</span>() &amp;&amp; (loadedImageInstallPath != <span class=\"literal\">NULL</span>) &amp;&amp; (loadedImageInstallPath[<span class=\"number\">0</span>] == <span class=\"string\">&#x27;/&#x27;</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\t\tImageLoader* anImage = *it;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* installPath = anImage-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( installPath != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(loadedImageInstallPath, installPath) == <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//dyld::log(&quot;duplicate(%s) =&gt; %p\\n&quot;, installPath, anImage);</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">removeImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\tImageLoader::<span class=\"built_in\">deleteImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> anImage;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// some API&#x27;s restrict what they can load</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeBundle &amp;&amp; !image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a bundle&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeDylib &amp;&amp; !image-&gt;<span class=\"built_in\">isDylib</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a dylib&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// regular main executables cannot be loaded </span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isExecutable</span>() ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.canBePIE || !image-&gt;<span class=\"built_in\">isPositionIndependentExecutable</span>() )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;can&#x27;t load a main executable&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// don&#x27;t add bundles to global list, they can be loaded but not linked.  When linked it will be added to list</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ! image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> image;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>AddImage</code></p>\n<p><a href=\"#return_loaddylib\"></a></p>\n<h3 id=\"Link-\"><a href=\"#Link-\" class=\"headerlink\" title=\"Link \"></a><span id=\"jump_link_execution\">Link </span></h3><p>dyld</p>\n<p><code>void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain&amp; loaderRPaths, unsigned cacheIndex)</code></p>\n<p>_main mach-o   <code>ImageLoader.link</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::link</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">bool</span> forceLazysBound, <span class=\"type\">bool</span> preflightOnly, <span class=\"type\">bool</span> neverUnload, <span class=\"type\">const</span> RPathChain&amp; loaderRPaths, <span class=\"type\">const</span> <span class=\"type\">char</span>* imagePath)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n&quot;, imagePath, fDlopenReferenceCount, fNeverUnload);</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t0 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveLoadLibraries</span>(context, preflightOnly, loaderRPaths, imagePath);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_dependents_mapped, preflightOnly);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// we only do the loading step for preflights</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( preflightOnly )</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">clearAllDepths</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveUpdateDepth</span>(context.<span class=\"built_in\">imageCount</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t__block <span class=\"type\">uint64_t</span> t2, t3, t4, t5;</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdyld3::<span class=\"built_in\">ScopedTimer</span>(DBG_DYLD_TIMING_APPLY_FIXUPS, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t\tt2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveRebase</span>(context);</span><br><span class=\"line\">\t\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_rebased, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt3 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveBindWithAccounting</span>(context, forceLazysBound, neverUnload);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt4 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">weakBind</span>(context);</span><br><span class=\"line\">\t\tt5 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">        context.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_bound, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t6 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::vector&lt;DOFInfo&gt; dofs;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveGetDOFSections</span>(context, dofs);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">registerDOFs</span>(dofs);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t7 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// interpose any dynamically loaded images</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable &amp;&amp; (fgInterposingTuples.<span class=\"built_in\">size</span>() != <span class=\"number\">0</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_APPLY_INTERPOSING, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveApplyInterposing</span>(context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//log</span></span><br><span class=\"line\">\tfgTotalLoadLibrariesTime += t1 - t0;</span><br><span class=\"line\">\tfgTotalRebaseTime += t3 - t2;</span><br><span class=\"line\">\tfgTotalBindTime += t4 - t3;</span><br><span class=\"line\">\tfgTotalWeakBindTime += t5 - t4;</span><br><span class=\"line\">\tfgTotalDOF += t7 - t6;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// done with initial dylib loads</span></span><br><span class=\"line\">\tfgNextPIEDylibAddress = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>this-&gt;recursiveLoadLibraries</code>  (LoadLoadopenImageLoader)Load</li>\n<li><code>this-&gt;recursiveUpdateDepth</code> </li>\n<li><span id=\"return_rebase\"><code>this-&gt;recursiveRebase</code></span><br> rebaserecursiveRebaserebase<code>rebase(const LinkContext&amp; context, uintptr_t slide)</code><a href=\"#jump_rebase\">Rebase</a></li>\n<li><code>this-&gt;recursiveBindWithAccounting</code><br> non-lazy bindlazy bindRebaserebind<code>doBind(const LinkContext&amp; context, bool forceLazysBound)</code></li>\n<li><code>this-&gt;weakBind</code> </li>\n<li><code>this-&gt;recursiveGetDOFSections</code> DOF</li>\n<li><code>this-&gt;recursiveApplyInterposing</code></li>\n</ol>\n<p>log</p>\n<h3 id=\"Rebase\"><a href=\"#Rebase\" class=\"headerlink\" title=\"Rebase\"></a><span id=\"jump_rebase\">Rebase</span></h3><p> Rebase </p>\n<p>RebaseASLRmach-oPICrebase</p>\n<p>PICrebase</p>\n<p>&#x2F;  ()mach-o<code>__mod_init_func</code>dyld vmaddr  slide</p>\n<p>compressed mach-o(mach-o) <code>ImageLoaderMachOCompressed</code></p>\n<p> rebase mach-o<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png\"></p>\n<p> rebase     opcode  immediate</p>\n<p><br>REBASE_OPCODE_TYPE_IMM &#x3D;&#x3D; 11:TypeType<br>REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB &#x3D;&#x3D; 22:rebase2segmentuleb<br>uleb128 &#x3D;&#x3D; 24:uleb<br>REBASE_OPCODE_DO_REBASE_IMM_TIMES &#x3D;&#x3D; 2:rebase2</p>\n<p>224rebase</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png\"></p>\n<p>02 0x3000 +  24 &#x3D;0x3018 </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png\"></p>\n<p><code>__mod_init_func</code>~</p>\n<p>rebase    </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoaderMachOCompressed::rebase</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">uintptr_t</span> slide)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t<span class=\"comment\">// fLinkEditBase __LINKEDIT    == slide</span></span><br><span class=\"line\">\t<span class=\"comment\">// start  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> start = fLinkEditBase + fDyldInfo-&gt;rebase_off;</span><br><span class=\"line\">\t<span class=\"comment\">// end  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> end = &amp;start[fDyldInfo-&gt;rebase_size];</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* p = start;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> type = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> segmentIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> address = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> count;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> skip;</span><br><span class=\"line\">\t\t<span class=\"type\">bool</span> done = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> ( !done &amp;&amp; (p &lt; end) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> immediate = *p &amp; REBASE_IMMEDIATE_MASK;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> opcode = *p &amp; REBASE_OPCODE_MASK;</span><br><span class=\"line\">\t\t\t++p;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span> (opcode) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DONE:</span><br><span class=\"line\">\t\t\t\t\tdone = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_TYPE_IMM:</span><br><span class=\"line\">\t\t\t\t\ttype = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:</span><br><span class=\"line\">\t\t\t\t\tsegmentIndex = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( segmentIndex &gt;= fSegmentsCount )</span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount<span class=\"number\">-1</span>);</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">if</span> TEXT_RELOC_SUPPORT</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasRebaseFixUps</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasBindFixUps</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, <span class=\"built_in\">segName</span>(segmentIndex));</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\t\t\tsegmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\tsegmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\taddress = segmentStartAddress + <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_IMM_SCALED:</span><br><span class=\"line\">\t\t\t\t\taddress += immediate*<span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_IMM_TIMES:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; immediate; ++i) &#123;<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end) + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t++fgTotalRebaseFixups;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\tskip = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += skip + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;bad rebase opcode %d&quot;</span>, *(p<span class=\"number\">-1</span>));</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* newMsg = dyld::<span class=\"built_in\">mkstringf</span>(<span class=\"string\">&quot;%s in %s&quot;</span>, msg, <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>((<span class=\"type\">void</span>*)msg);</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> newMsg;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"initializeMainExecutable\"><a href=\"#initializeMainExecutable\" class=\"headerlink\" title=\"initializeMainExecutable\"></a><span id=\"jump_init_main_execution\">initializeMainExecutable</span></h2><p>&#x2F;rebase&#x2F;bindruntime</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">initializeMainExecutable</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record that we&#x27;ve reached this step</span></span><br><span class=\"line\">\tgLinkContext.startedInitializingMainExecutable = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// run initialzers for any inserted dylibs</span></span><br><span class=\"line\">\tImageLoader::InitializerTimingList initializerTimes[<span class=\"built_in\">allImagesCount</span>()];</span><br><span class=\"line\">\tinitializerTimes[<span class=\"number\">0</span>].count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">size_t</span> rootCount = sImageRoots.<span class=\"built_in\">size</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( rootCount &gt; <span class=\"number\">1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">size_t</span> i=<span class=\"number\">1</span>; i &lt; rootCount; ++i) &#123;</span><br><span class=\"line\">\t\t\tsImageRoots[i]-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// run initializers for main executable and everything it brings up </span></span><br><span class=\"line\">\tsMainExecutable-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// register cxa_atexit() handler to run static terminators in all loaded images when this process exits</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( gLibSystemHelpers != <span class=\"literal\">NULL</span> ) </span><br><span class=\"line\">\t\t(*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// dump info if requested</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS )</span><br><span class=\"line\">\t\tImageLoader::<span class=\"built_in\">printStatistics</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )</span><br><span class=\"line\">\t\tImageLoaderMachO::<span class=\"built_in\">printStatisticsDetails</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>sMainExecutable-&gt;runInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::runInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, InitializerTimingList&amp; timingInfo)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"type\">mach_port_t</span> thisThread = <span class=\"built_in\">mach_thread_self</span>();</span><br><span class=\"line\">\tImageLoader::UninitedUpwards up;</span><br><span class=\"line\">\tup.count = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tup.images[<span class=\"number\">0</span>] = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, up);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_initialized, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">mach_port_deallocate</span>(<span class=\"built_in\">mach_task_self</span>(), thisThread);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tfgTotalInitTime += (t2 - t1);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>processInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::processInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> thisThread,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> maxImageCount = context.<span class=\"built_in\">imageCount</span>()+<span class=\"number\">2</span>;</span><br><span class=\"line\">\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];</span><br><span class=\"line\">\tImageLoader::UninitedUpwards&amp; ups = upsBuffer[<span class=\"number\">0</span>];</span><br><span class=\"line\">\tups.count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">// Calling recursive init on all images in images list, building a new list of</span></span><br><span class=\"line\">\t<span class=\"comment\">// uninitialized upward dependencies.</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">uintptr_t</span> i=<span class=\"number\">0</span>; i &lt; images.count; ++i) &#123;</span><br><span class=\"line\">\t\timages.images[i]-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, thisThread, images.images[i]-&gt;<span class=\"built_in\">getPath</span>(), timingInfo, ups);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// If any upward dependencies remain, init them.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ups.count &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">\t\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, ups);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>recursiveInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::recursiveInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> this_thread, <span class=\"type\">const</span> <span class=\"type\">char</span>* pathToInitialize,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t\t  InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"function\">recursive_lock <span class=\"title\">lock_info</span><span class=\"params\">(this_thread)</span></span>;</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinLock</span>(lock_info);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fState &lt; dyld_image_state_dependents_initialized<span class=\"number\">-1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> oldState = fState;</span><br><span class=\"line\">\t\t<span class=\"comment\">// break cycles</span></span><br><span class=\"line\">\t\tfState = dyld_image_state_dependents_initialized<span class=\"number\">-1</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize lower level libraries first</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span>(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; <span class=\"built_in\">libraryCount</span>(); ++i) &#123;</span><br><span class=\"line\">\t\t\t\tImageLoader* dependentImage = <span class=\"built_in\">libImage</span>(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( dependentImage != <span class=\"literal\">NULL</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// don&#x27;t try to initialize stuff &quot;above&quot; me yet</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">libIsUpward</span>(i) ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.count++;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( dependentImage-&gt;fDepth &gt;= fDepth ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tdependentImage-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, this_thread, <span class=\"built_in\">libPath</span>(i), timingInfo, uninitUps);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// record termination order</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">needsTermination</span>() )</span><br><span class=\"line\">\t\t\t\tcontext.<span class=\"built_in\">terminationRecorder</span>(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let objc know we are about to initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\tfState = dyld_image_state_dependents_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_dependents_initialized, <span class=\"keyword\">this</span>, &amp;timingInfo);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> hasInitializers = <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">doInitialization</span>(context);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let anyone know we finished initializing this image</span></span><br><span class=\"line\">\t\t\tfState = dyld_image_state_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_initialized, <span class=\"keyword\">this</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( hasInitializers ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\t\ttimingInfo.<span class=\"built_in\">addTime</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getShortName</span>(), t2-t1);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// this image is not initialized</span></span><br><span class=\"line\">\t\t\tfState = oldState;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>doInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">ImageLoaderMachO::doInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o has -init and static initializers</span></span><br><span class=\"line\">\t<span class=\"built_in\">doImageInit</span>(context);</span><br><span class=\"line\">\t<span class=\"built_in\">doModInitFunctions</span>(context);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (fHasDashInit || fHasInitializers);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> doModInitFunctions dyld_mod_init_func</p>\n<p>runtime:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png\"></p>\n<p> libSystem.B.dylib -&gt; libdispatch.dylib -&gt; libobjc.A.dylib runtime<br>runtime dyld<br><code>_dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</code></p>\n<p>loadruntime</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png\"></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">registerObjCNotifiers</span><span class=\"params\">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record functions to call</span></span><br><span class=\"line\">\tsNotifyObjCMapped\t= mapped;</span><br><span class=\"line\">\tsNotifyObjCInit\t\t= init;</span><br><span class=\"line\">\tsNotifyObjCUnmapped = unmapped;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// call &#x27;mapped&#x27; function with all images mapped so far</span></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">notifyBatchPartial</span>(dyld_image_state_bound, <span class=\"literal\">true</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// ignore request to abort during registration</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// &lt;rdar://problem/32209809&gt; call &#x27;init&#x27; function on all images already init&#x27;ed (below libSystem)</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = *it;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (image-&gt;<span class=\"built_in\">getState</span>() == dyld_image_state_initialized) &amp;&amp; image-&gt;<span class=\"built_in\">notifyObjC</span>() ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_OBJC_INIT, (<span class=\"type\">uint64_t</span>)image-&gt;machHeader(), <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t(*sNotifyObjCInit)(image-&gt;<span class=\"built_in\">getRealPath</span>(), image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> sAllImages  <code>_dyld_objc_notify_init init</code>runtimemach-o class  section </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_end\"></span></h2><ol>\n<li><a href=\"https://www.dllhook.com/post/249.html\">Mach-O</a></li>\n<li><a href=\"https://paper.seebug.org/202/\">Mach-O</a></li>\n<li><a href=\"https://www.dllhook.com/post/238.html\">dyld</a></li>\n<li><a href=\"http://blog.sunnyxx.com/2014/08/30/objc-pre-main/\">iOS  main </a></li>\n<li><a href=\"https://feicong.github.io/2017/01/14/dylib/index.html\">dylib</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<p>.</p>\n<p>dyld&#x2F;dyld ASLRobjcruntimedyld</p>","more":"<h2 id=\"dyld-\"><a href=\"#dyld-\" class=\"headerlink\" title=\"dyld \"></a>dyld </h2><p>dyld dyldStartup.s :load dyld<code>__dyld_start</code><code>dyld::start</code> </p>\n<p><code>dyld::start</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">uintptr_t</span> <span class=\"title\">start</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* appsMachHeader, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], </span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">intptr_t</span> slide, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* dyldsMachHeader,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t<span class=\"type\">uintptr_t</span>* startGlue)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class=\"line\">\t<span class=\"comment\">// we have to do this before using any global variables</span></span><br><span class=\"line\">    <span class=\"comment\">//dyld</span></span><br><span class=\"line\">    slide = <span class=\"built_in\">slideOfMainExecutable</span>(dyldsMachHeader);</span><br><span class=\"line\">    <span class=\"type\">bool</span> shouldRebase = slide != <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( shouldRebase ) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//rebase Dyld</span></span><br><span class=\"line\">        <span class=\"built_in\">rebaseDyld</span>(dyldsMachHeader, slide);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// allow dyld to use mach messaging</span></span><br><span class=\"line\">    <span class=\"comment\">//mach</span></span><br><span class=\"line\">\t<span class=\"built_in\">mach_init</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** envp = &amp;argv[argc+<span class=\"number\">1</span>];</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>** apple = envp;</span><br><span class=\"line\">\t<span class=\"keyword\">while</span>(*apple != <span class=\"literal\">NULL</span>) &#123; ++apple; &#125;</span><br><span class=\"line\">\t++apple;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// set up random value for stack canary</span></span><br><span class=\"line\">\t__guard_setup(apple);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class=\"line\">\t<span class=\"comment\">// run all C++ initializers inside dyld</span></span><br><span class=\"line\">    <span class=\"comment\">// dyld C++</span></span><br><span class=\"line\">\t<span class=\"built_in\">runDyldInitializers</span>(dyldsMachHeader, slide, argc, argv, envp, apple);</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class=\"line\">    <span class=\"comment\">//bootstrap dyld dyld  main </span></span><br><span class=\"line\">\t<span class=\"type\">uintptr_t</span> appsSlide = <span class=\"built_in\">slideOfMainExecutable</span>(appsMachHeader);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> dyld::   _main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>dyld::start</code></p>\n<ol>\n<li><span id=\"return_rebaseDyld\">rebase dyld</span><br><a href=\"#jump_rebaseDyld\">rebase dyld</a></li>\n<li> mach_msg<br> &lt;mach&#x2F;mach_init.h&gt;</li>\n<li><br> appleenvp</li>\n<li><br> applestack_guard&#x3D;xx</li>\n<li><span id=\"return_runDyldInitializers\"> dyld </span><br> dyld(PIC )dylddyld<a href=\"#jump_runDyldInitializers\"></a></li>\n<li> dyld (bootstrap) dyld main</li>\n</ol>\n<p>startdyld</p>\n<p><a href=\"#jump__main\">  dyld _main</a></p>\n<h3 id=\"RebaseDyld\"><a href=\"#RebaseDyld\" class=\"headerlink\" title=\"RebaseDyld\"></a><span id=\"jump_rebaseDyld\">RebaseDyld</span></h3><p>Dyldmach_oload_commanddylddyld</p>\n<ol>\n<li>Load_Commands __LINKEDIT  LC_DYLD_INFO_ONLY __LINKEDITLC_DYLD_INFO_ONLYRebase,Bind,WeakBind,LazyBind,Export 55Dynamic Loader Info</li>\n<li>rebase  bind  Opcodes</li>\n</ol>\n<p>rebase&#x2F;bind </p>\n<p><a href=\"#return_rebaseDyld\"></a></p>\n<h3 id=\"Dyld\"><a href=\"#Dyld\" class=\"headerlink\" title=\"Dyld\"></a><span id=\"jump_runDyldInitializers\">Dyld</span></h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_start  __asm(<span class=\"string\">&quot;section$start$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">extern</span> <span class=\"type\">const</span> Initializer  inits_end    __asm(<span class=\"string\">&quot;section$end$__DATA$__mod_init_func&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// For a regular executable, the crt code calls dyld to run the executables initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// For a static executable, crt directly runs the initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// dyld (should be static) but is a dynamic executable and needs this hack to run its own initializers.</span></span><br><span class=\"line\"><span class=\"comment\">// We pass argc, argv, etc in case libc.a uses those arguments</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">runDyldInitializers</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"keyword\">struct</span> macho_header* mh, <span class=\"type\">intptr_t</span> slide, <span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span>* argv[], <span class=\"type\">const</span> <span class=\"type\">char</span>* envp[], <span class=\"type\">const</span> <span class=\"type\">char</span>* apple[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">const</span> Initializer* p = &amp;inits_start; p &lt; &amp;inits_end; ++p) &#123;</span><br><span class=\"line\">\t\t(*p)(argc, argv, envp, apple);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>dyldcrtdyldcrtdyldhack</p>\n<p><code>__asm(&quot;section$start$__DATA$__mod_init_func&quot;)</code><code>__DATA</code><code>__mod_init_func</code></p>\n<p>Demo<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/81503ddc20aec519b01d09370a4d1628.png\"></p>\n<p>mach-o <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d61a14b2aeeb66a2eea1be2d8be6b85f.png\"></p>\n<p><code>__mod_init_func</code>,Sectiondemo_init10xED0</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/9ac92176b89d0c92d76d1d98ecddd5f4.png\"></p>\n<p><code>demo_init2</code></p>\n<p>dyld<code>inits_start</code><code>inits_end</code>dyld</p>\n<p>dyld<br><a href=\"#jump_end\"></a> 1  2</p>\n<p><a href=\"#return_runDyldInitializers\"></a></p>\n<h2 id=\"dyld-main\"><a href=\"#dyld-main\" class=\"headerlink\" title=\"dyld::_main\"></a><span id=\"jump__main\">dyld::_main</span></h2><p>dyldrebasebindmach_msgdyld<code>dyld::_main</code> </p>\n<p><code>dyld::_main</code>Appmain<code>dyld::start</code><code>__dyld_start</code>main</p>\n<p>_main</p>\n<ol>\n<li> crashloglog</li>\n<li><code>// iOS cannot run without shared region</code>,iOS<br> libpath</li>\n<li><span id=\"return_initMainExecutable\">:</span><br> <code>ImageLoaderMachO</code><a href=\"#jump_initMainExecutable\"></a><br> ClassicCompressed<code>ImageLoaderMachOCompressed</code><code>ImageLoaderMachOClassic</code><code>ImageLoaderMachO</code></li>\n<li><code>loadInsertedDylib</code><a href=\"#jump_loaddylib\">Load </a><span id=\"return_loaddylib\">.</span></li>\n<li><span id=\"return_link_execution\"></span><a href=\"#jump_link_execution\"></a></li>\n<li></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_initMainExecutable\"></span></h3><p>dylddyld macho_headerdyldImageLoaderMachOdyld</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoaderMachO* <span class=\"title\">instantiateFromLoadedImage</span><span class=\"params\">(<span class=\"type\">const</span> macho_header* mh, <span class=\"type\">uintptr_t</span> slide, <span class=\"type\">const</span> <span class=\"type\">char</span>* path)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>((<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>*)mh, path) ) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = ImageLoaderMachO::<span class=\"built_in\">instantiateMainExecutable</span>(mh, slide, path, gLinkContext);</span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> (ImageLoaderMachO*)image;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;main executable not a known format&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>instantiateMainExecutable</code>mach-o(compress  classic)ImageLoader</p>\n<p><code>addImage(image);</code></p>\n<ol>\n<li>ImageLoader<code>sAllImages</code></li>\n<li> <code>sMappedRangesStart</code>  <code>ImageLoader</code></li>\n</ol>\n<p><a href=\"#return_initMainExecutable\"></a></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_loaddylib\"></span></h3><p>DYLD_INSERT_LIBRARIESloadInsertedDylib()</p>\n<p>load()load()loadPhase0()loadPhase0()phaseloadPhase6()DYLD_ROOT_PATH-&gt;LD_LIBRARY_PATH-&gt;DYLD_FRAMEWORK_PATH-&gt;-&gt;DYLD_FALLBACK_LIBRARY_PATH</p>\n<p>ImageLoaderMachO::instantiateFromFile() ImageLoader checkandAddImage() </p>\n<p>loadPhase0()ImageLoaderMachO::instantiateFromCache()</p>\n<p></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// map in file and instantiate an ImageLoader</span></span><br><span class=\"line\"><span class=\"comment\">// ImagerLoader</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">loadPhase6</span><span class=\"params\">(<span class=\"type\">int</span> fd, <span class=\"type\">const</span> <span class=\"keyword\">struct</span> stat&amp; stat_buf, <span class=\"type\">const</span> <span class=\"type\">char</span>* path, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;%s(%s)\\n&quot;, __func__ , path);</span></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileOffset = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> fileLength = stat_buf.st_size;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// validate it is a file (not directory)</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( (stat_buf.st_mode &amp; S_IFMT) != S_IFREG ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a file&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> firstPages[MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE];</span><br><span class=\"line\">\t<span class=\"type\">uint8_t</span> *firstPagesPtr = firstPages;</span><br><span class=\"line\">\t<span class=\"type\">bool</span> shortPage = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// min mach-o file is 4K</span></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o4k</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileLength &lt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, (<span class=\"type\">size_t</span>)fileLength, <span class=\"number\">0</span>) != (<span class=\"type\">ssize_t</span>)fileLength )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of short file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\tshortPage = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t&#125; </span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// optimistically read only first 4KB</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// header4kb4k</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, <span class=\"number\">0</span>) != <span class=\"number\">4096</span> )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of first 4K failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// if fat wrapper, find usable sub-file</span></span><br><span class=\"line\">\t<span class=\"comment\">// fat</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> fat_header* fileStartAsFat = (fat_header*)firstPages;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fileStartAsFat-&gt;magic == <span class=\"built_in\">OSSwapBigToHostInt32</span>(FAT_MAGIC) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch) &gt; ((<span class=\"number\">4096</span> - <span class=\"built_in\">sizeof</span>(fat_header)) / <span class=\"built_in\">sizeof</span>(fat_arch)) )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;fat header too large: %u entries&quot;</span>, <span class=\"built_in\">OSSwapBigToHostInt32</span>(fileStartAsFat-&gt;nfat_arch));</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">fatFindBest</span>(fileStartAsFat, &amp;fileOffset, &amp;fileLength) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (fileOffset+fileLength) &gt; (<span class=\"type\">uint64_t</span>)(stat_buf.st_size) )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;truncated fat file.  file length=%llu, but needed slice goes to %llu&quot;</span>, stat_buf.st_size, fileOffset+fileLength);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (<span class=\"built_in\">pread</span>(fd, firstPages, <span class=\"number\">4096</span>, fileOffset) != <span class=\"number\">4096</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of fat file failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;no matching architecture in universal wrapper&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try mach-o loader</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( shortPage ) </span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;file too short&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">isCompatibleMachO</span>(firstPages, path) ) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// only MH_BUNDLE, MH_DYLIB, and some MH_EXECUTE can be dynamically loaded</span></span><br><span class=\"line\">\t\t<span class=\"type\">const</span> mach_header* mh = (mach_header*)firstPages;</span><br><span class=\"line\">\t\t<span class=\"keyword\">switch</span> ( mh-&gt;filetype ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_EXECUTE:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_DYLIB:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">case</span> MH_BUNDLE:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong filetype&quot;</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">uint32_t</span> headerAndLoadCommandsSize = <span class=\"built_in\">sizeof</span>(macho_header) + mh-&gt;sizeofcmds;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE )</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; %u&quot;</span>, headerAndLoadCommandsSize, MAX_MACH_O_HEADER_AND_LOAD_COMMANDS_SIZE);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; fileLength )</span><br><span class=\"line\">\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;malformed mach-o: load commands size (%u) &gt; mach-o file size (%llu)&quot;</span>, headerAndLoadCommandsSize, fileLength);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( headerAndLoadCommandsSize &gt; <span class=\"number\">4096</span> ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// read more pages</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\">//  head  LC_COMMANDS4096 headerAndLoadCommandsSize </span></span><br><span class=\"line\">\t\t\t<span class=\"type\">unsigned</span> readAmount = headerAndLoadCommandsSize - <span class=\"number\">4096</span>;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">pread</span>(fd, &amp;firstPages[<span class=\"number\">4096</span>], readAmount, fileOffset+<span class=\"number\">4096</span>) != readAmount )</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;pread of extra load commands past 4KB failed: %d&quot;</span>, errno);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_IPHONE_SIMULATOR\t</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// &lt;rdar://problem/14168872&gt; dyld_sim should restrict loading osx binaries</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">isSimulatorBinary</span>(firstPages, path) ) &#123;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">if</span> TARGET_OS_WATCH</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for watchOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">elif</span> TARGET_OS_TV</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for tvOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOS simulator&quot;</span>;</span><br><span class=\"line\">\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( gLinkContext.marzipan ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> dyld3::MachOFile* mf = (dyld3::MachOFile*)firstPages;</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isiOSMacBinary = mf-&gt;<span class=\"built_in\">supportsPlatform</span>(dyld3::Platform::iOSMac) || <span class=\"built_in\">iOSMacWhiteListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> isProhibitedMacOSBinary = !isiOSMacBinary &amp;&amp; <span class=\"built_in\">iOSMacBlackListed</span>(path);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( (context.enforceIOSMac &amp;&amp; !isiOSMacBinary) || isProhibitedMacOSBinary ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but not built for iOSMac&quot;</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">if</span> __arm64e__</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (sMainExecutableMachHeader-&gt;cpusubtype == CPU_SUBTYPE_ARM64_E) &amp;&amp; (mh-&gt;cpusubtype != CPU_SUBTYPE_ARM64_E) )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;arm64 dylibs cannot be loaded into arm64e processes&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\tImageLoader* image = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_MAP_IMAGE, path, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// instantiateFromFile  ImageLoader</span></span><br><span class=\"line\">\t\t\timage = ImageLoaderMachO::<span class=\"built_in\">instantiateFromFile</span>(path, fd, firstPagesPtr, headerAndLoadCommandsSize, fileOffset, fileLength, stat_buf, gLinkContext);</span><br><span class=\"line\">\t\t\ttimer.<span class=\"built_in\">setData4</span>((<span class=\"type\">uint64_t</span>)image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"comment\">// validate</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// </span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"built_in\">checkandAddImage</span>(image, context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// try other file formats here...</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// throw error about what was found</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> (*(<span class=\"type\">uint32_t</span>*)firstPages) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_MAGIC_64:</span><br><span class=\"line\">\t\t<span class=\"keyword\">case</span> MH_CIGAM_64:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;mach-o, but wrong architecture&quot;</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;unknown file type, first eight bytes: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X&quot;</span>, </span><br><span class=\"line\">\t\t\tfirstPages[<span class=\"number\">0</span>], firstPages[<span class=\"number\">1</span>], firstPages[<span class=\"number\">2</span>], firstPages[<span class=\"number\">3</span>], firstPages[<span class=\"number\">4</span>], firstPages[<span class=\"number\">5</span>], firstPages[<span class=\"number\">6</span>],firstPages[<span class=\"number\">7</span>]);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>ImageLoader</code></p>\n<p></p>\n<ol>\n<li>4k4k, fat_header</li>\n<li>fatCPU</li>\n<li></li>\n<li> head  Load_Commands 4k headerAndLoadCommandsSize <code>ImageLoader</code><code>ImageLoader</code> Load_Commands </li>\n<li>checkandAddImage</li>\n</ol>\n<p> checkandAddImage</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">static</span> ImageLoader* <span class=\"title\">checkandAddImage</span><span class=\"params\">(ImageLoader* image, <span class=\"type\">const</span> LoadContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// now sanity check that this loaded image does not have the same install path as any existing image</span></span><br><span class=\"line\">\t<span class=\"comment\">// sAllImages </span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">char</span>* loadedImageInstallPath = image-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isDylib</span>() &amp;&amp; (loadedImageInstallPath != <span class=\"literal\">NULL</span>) &amp;&amp; (loadedImageInstallPath[<span class=\"number\">0</span>] == <span class=\"string\">&#x27;/&#x27;</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\t\tImageLoader* anImage = *it;</span><br><span class=\"line\">\t\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* installPath = anImage-&gt;<span class=\"built_in\">getInstallPath</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( installPath != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">strcmp</span>(loadedImageInstallPath, installPath) == <span class=\"number\">0</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//dyld::log(&quot;duplicate(%s) =&gt; %p\\n&quot;, installPath, anImage);</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">removeImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\tImageLoader::<span class=\"built_in\">deleteImage</span>(image);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">return</span> anImage;</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// some API&#x27;s restrict what they can load</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeBundle &amp;&amp; !image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a bundle&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( context.mustBeDylib &amp;&amp; !image-&gt;<span class=\"built_in\">isDylib</span>() )</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;not a dylib&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// regular main executables cannot be loaded </span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( image-&gt;<span class=\"built_in\">isExecutable</span>() ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.canBePIE || !image-&gt;<span class=\"built_in\">isPositionIndependentExecutable</span>() )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span> <span class=\"string\">&quot;can&#x27;t load a main executable&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// don&#x27;t add bundles to global list, they can be loaded but not linked.  When linked it will be added to list</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ! image-&gt;<span class=\"built_in\">isBundle</span>() )</span><br><span class=\"line\">\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">addImage</span>(image);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> image;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>AddImage</code></p>\n<p><a href=\"#return_loaddylib\"></a></p>\n<h3 id=\"Link-\"><a href=\"#Link-\" class=\"headerlink\" title=\"Link \"></a><span id=\"jump_link_execution\">Link </span></h3><p>dyld</p>\n<p><code>void link(ImageLoader* image, bool forceLazysBound, bool neverUnload, const ImageLoader::RPathChain&amp; loaderRPaths, unsigned cacheIndex)</code></p>\n<p>_main mach-o   <code>ImageLoader.link</code></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::link</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">bool</span> forceLazysBound, <span class=\"type\">bool</span> preflightOnly, <span class=\"type\">bool</span> neverUnload, <span class=\"type\">const</span> RPathChain&amp; loaderRPaths, <span class=\"type\">const</span> <span class=\"type\">char</span>* imagePath)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//dyld::log(&quot;ImageLoader::link(%s) refCount=%d, neverUnload=%d\\n&quot;, imagePath, fDlopenReferenceCount, fNeverUnload);</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t0 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveLoadLibraries</span>(context, preflightOnly, loaderRPaths, imagePath);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_dependents_mapped, preflightOnly);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// we only do the loading step for preflights</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( preflightOnly )</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">clearAllDepths</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveUpdateDepth</span>(context.<span class=\"built_in\">imageCount</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t__block <span class=\"type\">uint64_t</span> t2, t3, t4, t5;</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tdyld3::<span class=\"built_in\">ScopedTimer</span>(DBG_DYLD_TIMING_APPLY_FIXUPS, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">\t\tt2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveRebase</span>(context);</span><br><span class=\"line\">\t\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_rebased, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt3 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveBindWithAccounting</span>(context, forceLazysBound, neverUnload);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tt4 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">weakBind</span>(context);</span><br><span class=\"line\">\t\tt5 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( !context.linkingMainExecutable )</span><br><span class=\"line\">        context.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_bound, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t6 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\tstd::vector&lt;DOFInfo&gt; dofs;</span><br><span class=\"line\">\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveGetDOFSections</span>(context, dofs);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">registerDOFs</span>(dofs);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t7 = <span class=\"built_in\">mach_absolute_time</span>();\t</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// interpose any dynamically loaded images</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( !context.linkingMainExecutable &amp;&amp; (fgInterposingTuples.<span class=\"built_in\">size</span>() != <span class=\"number\">0</span>) ) &#123;</span><br><span class=\"line\">\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_APPLY_INTERPOSING, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">recursiveApplyInterposing</span>(context);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// clear error strings</span></span><br><span class=\"line\">\t(*context.setErrorStrings)(<span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//log</span></span><br><span class=\"line\">\tfgTotalLoadLibrariesTime += t1 - t0;</span><br><span class=\"line\">\tfgTotalRebaseTime += t3 - t2;</span><br><span class=\"line\">\tfgTotalBindTime += t4 - t3;</span><br><span class=\"line\">\tfgTotalWeakBindTime += t5 - t4;</span><br><span class=\"line\">\tfgTotalDOF += t7 - t6;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// done with initial dylib loads</span></span><br><span class=\"line\">\tfgNextPIEDylibAddress = <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>this-&gt;recursiveLoadLibraries</code>  (LoadLoadopenImageLoader)Load</li>\n<li><code>this-&gt;recursiveUpdateDepth</code> </li>\n<li><span id=\"return_rebase\"><code>this-&gt;recursiveRebase</code></span><br> rebaserecursiveRebaserebase<code>rebase(const LinkContext&amp; context, uintptr_t slide)</code><a href=\"#jump_rebase\">Rebase</a></li>\n<li><code>this-&gt;recursiveBindWithAccounting</code><br> non-lazy bindlazy bindRebaserebind<code>doBind(const LinkContext&amp; context, bool forceLazysBound)</code></li>\n<li><code>this-&gt;weakBind</code> </li>\n<li><code>this-&gt;recursiveGetDOFSections</code> DOF</li>\n<li><code>this-&gt;recursiveApplyInterposing</code></li>\n</ol>\n<p>log</p>\n<h3 id=\"Rebase\"><a href=\"#Rebase\" class=\"headerlink\" title=\"Rebase\"></a><span id=\"jump_rebase\">Rebase</span></h3><p> Rebase </p>\n<p>RebaseASLRmach-oPICrebase</p>\n<p>PICrebase</p>\n<p>&#x2F;  ()mach-o<code>__mod_init_func</code>dyld vmaddr  slide</p>\n<p>compressed mach-o(mach-o) <code>ImageLoaderMachOCompressed</code></p>\n<p> rebase mach-o<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/ffdc0da28d16d220f66e8d638a7d5198.png\"></p>\n<p> rebase     opcode  immediate</p>\n<p><br>REBASE_OPCODE_TYPE_IMM &#x3D;&#x3D; 11:TypeType<br>REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB &#x3D;&#x3D; 22:rebase2segmentuleb<br>uleb128 &#x3D;&#x3D; 24:uleb<br>REBASE_OPCODE_DO_REBASE_IMM_TIMES &#x3D;&#x3D; 2:rebase2</p>\n<p>224rebase</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/69f3c8a3511f6c75d8798c62db21d597.png\"></p>\n<p>02 0x3000 +  24 &#x3D;0x3018 </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/8479e0316c7f0447ff14dd0a1b98ed69.png\"></p>\n<p><code>__mod_init_func</code>~</p>\n<p>rebase    </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoaderMachOCompressed::rebase</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">uintptr_t</span> slide)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t<span class=\"comment\">// fLinkEditBase __LINKEDIT    == slide</span></span><br><span class=\"line\">\t<span class=\"comment\">// start  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> start = fLinkEditBase + fDyldInfo-&gt;rebase_off;</span><br><span class=\"line\">\t<span class=\"comment\">// end  rebase</span></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* <span class=\"type\">const</span> end = &amp;start[fDyldInfo-&gt;rebase_size];</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">uint8_t</span>* p = start;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> type = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">int</span> segmentIndex = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> address = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> segmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(<span class=\"number\">0</span>);<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> count;</span><br><span class=\"line\">\t\t<span class=\"type\">uintptr_t</span> skip;</span><br><span class=\"line\">\t\t<span class=\"type\">bool</span> done = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> ( !done &amp;&amp; (p &lt; end) ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> immediate = *p &amp; REBASE_IMMEDIATE_MASK;</span><br><span class=\"line\">\t\t\t<span class=\"type\">uint8_t</span> opcode = *p &amp; REBASE_OPCODE_MASK;</span><br><span class=\"line\">\t\t\t++p;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">switch</span> (opcode) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DONE:</span><br><span class=\"line\">\t\t\t\t\tdone = <span class=\"literal\">true</span>;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_TYPE_IMM:</span><br><span class=\"line\">\t\t\t\t\ttype = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB:</span><br><span class=\"line\">\t\t\t\t\tsegmentIndex = immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( segmentIndex &gt;= fSegmentsCount )</span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is too large (0..%d)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, fSegmentsCount<span class=\"number\">-1</span>);</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">if</span> TEXT_RELOC_SUPPORT</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasRebaseFixUps</span>(segmentIndex) &amp;&amp; !<span class=\"built_in\">segHasBindFixUps</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( !<span class=\"built_in\">segWriteable</span>(segmentIndex) )</span><br><span class=\"line\">\t\t\t<span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">\t\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;REBASE_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB has segment %d which is not a writable segment (%s)&quot;</span>,</span><br><span class=\"line\">\t\t\t\t\t\t\t\tsegmentIndex, <span class=\"built_in\">segName</span>(segmentIndex));</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\t\t\tsegmentStartAddress = <span class=\"built_in\">segActualLoadAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\tsegmentEndAddress = <span class=\"built_in\">segActualEndAddress</span>(segmentIndex);</span><br><span class=\"line\">\t\t\t\t\t</span><br><span class=\"line\">\t\t\t\t\taddress = segmentStartAddress + <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_ADD_ADDR_IMM_SCALED:</span><br><span class=\"line\">\t\t\t\t\taddress += immediate*<span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_IMM_TIMES:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; immediate; ++i) &#123;<span class=\"comment\">//N</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += immediate;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ADD_ADDR_ULEB:</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\taddress += <span class=\"built_in\">read_uleb128</span>(p, end) + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t++fgTotalRebaseFixups;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">case</span> REBASE_OPCODE_DO_REBASE_ULEB_TIMES_SKIPPING_ULEB:</span><br><span class=\"line\">\t\t\t\t\tcount = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\tskip = <span class=\"built_in\">read_uleb128</span>(p, end);</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> (<span class=\"type\">uint32_t</span> i=<span class=\"number\">0</span>; i &lt; count; ++i) &#123;</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> ( (address &lt; segmentStartAddress) || (address &gt;= segmentEndAddress) )</span><br><span class=\"line\">\t\t\t\t\t\t\t<span class=\"built_in\">throwBadRebaseAddress</span>(address, segmentEndAddress, segmentIndex, start, end, p);</span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"built_in\">rebaseAt</span>(context, address, slide, type);</span><br><span class=\"line\">\t\t\t\t\t\taddress += skip + <span class=\"built_in\">sizeof</span>(<span class=\"type\">uintptr_t</span>);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\tfgTotalRebaseFixups += count;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">break</span>;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">default</span>:</span><br><span class=\"line\">\t\t\t\t\tdyld::<span class=\"built_in\">throwf</span>(<span class=\"string\">&quot;bad rebase opcode %d&quot;</span>, *(p<span class=\"number\">-1</span>));</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"type\">char</span>* newMsg = dyld::<span class=\"built_in\">mkstringf</span>(<span class=\"string\">&quot;%s in %s&quot;</span>, msg, <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\">\t\t<span class=\"built_in\">free</span>((<span class=\"type\">void</span>*)msg);</span><br><span class=\"line\">\t\t<span class=\"keyword\">throw</span> newMsg;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"initializeMainExecutable\"><a href=\"#initializeMainExecutable\" class=\"headerlink\" title=\"initializeMainExecutable\"></a><span id=\"jump_init_main_execution\">initializeMainExecutable</span></h2><p>&#x2F;rebase&#x2F;bindruntime</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">initializeMainExecutable</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record that we&#x27;ve reached this step</span></span><br><span class=\"line\">\tgLinkContext.startedInitializingMainExecutable = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// run initialzers for any inserted dylibs</span></span><br><span class=\"line\">\tImageLoader::InitializerTimingList initializerTimes[<span class=\"built_in\">allImagesCount</span>()];</span><br><span class=\"line\">\tinitializerTimes[<span class=\"number\">0</span>].count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"type\">size_t</span> rootCount = sImageRoots.<span class=\"built_in\">size</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( rootCount &gt; <span class=\"number\">1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span>(<span class=\"type\">size_t</span> i=<span class=\"number\">1</span>; i &lt; rootCount; ++i) &#123;</span><br><span class=\"line\">\t\t\tsImageRoots[i]-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// run initializers for main executable and everything it brings up </span></span><br><span class=\"line\">\tsMainExecutable-&gt;<span class=\"built_in\">runInitializers</span>(gLinkContext, initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">// register cxa_atexit() handler to run static terminators in all loaded images when this process exits</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( gLibSystemHelpers != <span class=\"literal\">NULL</span> ) </span><br><span class=\"line\">\t\t(*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// dump info if requested</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS )</span><br><span class=\"line\">\t\tImageLoader::<span class=\"built_in\">printStatistics</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )</span><br><span class=\"line\">\t\tImageLoaderMachO::<span class=\"built_in\">printStatisticsDetails</span>((<span class=\"type\">unsigned</span> <span class=\"type\">int</span>)<span class=\"built_in\">allImagesCount</span>(), initializerTimes[<span class=\"number\">0</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p></p>\n<p>sMainExecutable-&gt;runInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::runInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, InitializerTimingList&amp; timingInfo)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t<span class=\"type\">mach_port_t</span> thisThread = <span class=\"built_in\">mach_thread_self</span>();</span><br><span class=\"line\">\tImageLoader::UninitedUpwards up;</span><br><span class=\"line\">\tup.count = <span class=\"number\">1</span>;</span><br><span class=\"line\">\tup.images[<span class=\"number\">0</span>] = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, up);</span><br><span class=\"line\">\tcontext.<span class=\"built_in\">notifyBatch</span>(dyld_image_state_initialized, <span class=\"literal\">false</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">mach_port_deallocate</span>(<span class=\"built_in\">mach_task_self</span>(), thisThread);</span><br><span class=\"line\">\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\tfgTotalInitTime += (t2 - t1);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>processInitializers </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::processInitializers</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> thisThread,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">uint32_t</span> maxImageCount = context.<span class=\"built_in\">imageCount</span>()+<span class=\"number\">2</span>;</span><br><span class=\"line\">\tImageLoader::UninitedUpwards upsBuffer[maxImageCount];</span><br><span class=\"line\">\tImageLoader::UninitedUpwards&amp; ups = upsBuffer[<span class=\"number\">0</span>];</span><br><span class=\"line\">\tups.count = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"comment\">// Calling recursive init on all images in images list, building a new list of</span></span><br><span class=\"line\">\t<span class=\"comment\">// uninitialized upward dependencies.</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (<span class=\"type\">uintptr_t</span> i=<span class=\"number\">0</span>; i &lt; images.count; ++i) &#123;</span><br><span class=\"line\">\t\timages.images[i]-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, thisThread, images.images[i]-&gt;<span class=\"built_in\">getPath</span>(), timingInfo, ups);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// If any upward dependencies remain, init them.</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( ups.count &gt; <span class=\"number\">0</span> )</span><br><span class=\"line\">\t\t<span class=\"built_in\">processInitializers</span>(context, thisThread, timingInfo, ups);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>recursiveInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ImageLoader::recursiveInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context, <span class=\"type\">mach_port_t</span> this_thread, <span class=\"type\">const</span> <span class=\"type\">char</span>* pathToInitialize,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">\t\t\t\t\t\t\t\t\t\t  InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"function\">recursive_lock <span class=\"title\">lock_info</span><span class=\"params\">(this_thread)</span></span>;</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinLock</span>(lock_info);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ( fState &lt; dyld_image_state_dependents_initialized<span class=\"number\">-1</span> ) &#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint8_t</span> oldState = fState;</span><br><span class=\"line\">\t\t<span class=\"comment\">// break cycles</span></span><br><span class=\"line\">\t\tfState = dyld_image_state_dependents_initialized<span class=\"number\">-1</span>;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize lower level libraries first</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">for</span>(<span class=\"type\">unsigned</span> <span class=\"type\">int</span> i=<span class=\"number\">0</span>; i &lt; <span class=\"built_in\">libraryCount</span>(); ++i) &#123;</span><br><span class=\"line\">\t\t\t\tImageLoader* dependentImage = <span class=\"built_in\">libImage</span>(i);</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ( dependentImage != <span class=\"literal\">NULL</span> ) &#123;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">// don&#x27;t try to initialize stuff &quot;above&quot; me yet</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ( <span class=\"built_in\">libIsUpward</span>(i) ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.images[uninitUps.count] = dependentImage;</span><br><span class=\"line\">\t\t\t\t\t\tuninitUps.count++;</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ( dependentImage-&gt;fDepth &gt;= fDepth ) &#123;</span><br><span class=\"line\">\t\t\t\t\t\tdependentImage-&gt;<span class=\"built_in\">recursiveInitialization</span>(context, this_thread, <span class=\"built_in\">libPath</span>(i), timingInfo, uninitUps);</span><br><span class=\"line\">\t\t\t\t\t&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// record termination order</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">needsTermination</span>() )</span><br><span class=\"line\">\t\t\t\tcontext.<span class=\"built_in\">terminationRecorder</span>(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let objc know we are about to initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">uint64_t</span> t1 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\tfState = dyld_image_state_dependents_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_dependents_initialized, <span class=\"keyword\">this</span>, &amp;timingInfo);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// initialize this image</span></span><br><span class=\"line\">\t\t\t<span class=\"type\">bool</span> hasInitializers = <span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">doInitialization</span>(context);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// let anyone know we finished initializing this image</span></span><br><span class=\"line\">\t\t\tfState = dyld_image_state_initialized;</span><br><span class=\"line\">\t\t\toldState = fState;</span><br><span class=\"line\">\t\t\tcontext.<span class=\"built_in\">notifySingle</span>(dyld_image_state_initialized, <span class=\"keyword\">this</span>, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> ( hasInitializers ) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"type\">uint64_t</span> t2 = <span class=\"built_in\">mach_absolute_time</span>();</span><br><span class=\"line\">\t\t\t\ttimingInfo.<span class=\"built_in\">addTime</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getShortName</span>(), t2-t1);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// this image is not initialized</span></span><br><span class=\"line\">\t\t\tfState = oldState;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">throw</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">recursiveSpinUnLock</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>doInitialization </p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">ImageLoaderMachO::doInitialization</span><span class=\"params\">(<span class=\"type\">const</span> LinkContext&amp; context)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"keyword\">this</span>-&gt;<span class=\"built_in\">getPath</span>());</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// mach-o has -init and static initializers</span></span><br><span class=\"line\">\t<span class=\"built_in\">doImageInit</span>(context);</span><br><span class=\"line\">\t<span class=\"built_in\">doModInitFunctions</span>(context);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">CRSetCrashLogMessage2</span>(<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> (fHasDashInit || fHasInitializers);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> doModInitFunctions dyld_mod_init_func</p>\n<p>runtime:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/6880c3f245ce10b72f214d8851b959e5.png\"></p>\n<p> libSystem.B.dylib -&gt; libdispatch.dylib -&gt; libobjc.A.dylib runtime<br>runtime dyld<br><code>_dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</code></p>\n<p>loadruntime</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d26ee1e5057ed5fc0c63d13baac4b77b.png\"></p>\n<p></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">registerObjCNotifiers</span><span class=\"params\">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// record functions to call</span></span><br><span class=\"line\">\tsNotifyObjCMapped\t= mapped;</span><br><span class=\"line\">\tsNotifyObjCInit\t\t= init;</span><br><span class=\"line\">\tsNotifyObjCUnmapped = unmapped;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// call &#x27;mapped&#x27; function with all images mapped so far</span></span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">notifyBatchPartial</span>(dyld_image_state_bound, <span class=\"literal\">true</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">false</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">catch</span> (<span class=\"type\">const</span> <span class=\"type\">char</span>* msg) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// ignore request to abort during registration</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// &lt;rdar://problem/32209809&gt; call &#x27;init&#x27; function on all images already init&#x27;ed (below libSystem)</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> (std::vector&lt;ImageLoader*&gt;::iterator it=sAllImages.<span class=\"built_in\">begin</span>(); it != sAllImages.<span class=\"built_in\">end</span>(); it++) &#123;</span><br><span class=\"line\">\t\tImageLoader* image = *it;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> ( (image-&gt;<span class=\"built_in\">getState</span>() == dyld_image_state_initialized) &amp;&amp; image-&gt;<span class=\"built_in\">notifyObjC</span>() ) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"function\">dyld3::ScopedTimer <span class=\"title\">timer</span><span class=\"params\">(DBG_DYLD_TIMING_OBJC_INIT, (<span class=\"type\">uint64_t</span>)image-&gt;machHeader(), <span class=\"number\">0</span>, <span class=\"number\">0</span>)</span></span>;</span><br><span class=\"line\">\t\t\t(*sNotifyObjCInit)(image-&gt;<span class=\"built_in\">getRealPath</span>(), image-&gt;<span class=\"built_in\">machHeader</span>());</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> sAllImages  <code>_dyld_objc_notify_init init</code>runtimemach-o class  section </p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><span id=\"jump_end\"></span></h2><ol>\n<li><a href=\"https://www.dllhook.com/post/249.html\">Mach-O</a></li>\n<li><a href=\"https://paper.seebug.org/202/\">Mach-O</a></li>\n<li><a href=\"https://www.dllhook.com/post/238.html\">dyld</a></li>\n<li><a href=\"http://blog.sunnyxx.com/2014/08/30/objc-pre-main/\">iOS  main </a></li>\n<li><a href=\"https://feicong.github.io/2017/01/14/dylib/index.html\">dylib</a></li>\n</ol>"},{"title":"AutoRelease","date":"2020-03-14T16:00:00.000Z","_content":"\nARCruntime`objc_autoreleaseReturnValue``objc_retainAutoreleaseReturnValue`...\n\n<!-- more -->\n\n## \n:autorelease\n**MRC**\n\nMRC\n\n  1\n\n\n\n**ARC**\n\nARCMRCARCautoreleaseautorelease\n\n\n**runtime**\n\nMRC\n\nps:\n\nARC\n\nruntimeruntimeMRC\n\n`__builtin_return_address(int depth)``objc_retainAutoreleaseReturnValue`MRC`objc_autoreleaseReturnValue`flagTLS\n\n`objc_retainAutoreleaseReturnValue`TLSretain\n\n\n\n\n\nTLSflag\n\n`__builtin_return_address(int depth)`\n\n## \nARC...\n\nXcode Mac DemoARC\n\n..\n\n```objective-c\nextern void _objc_autoreleasePoolPrint(void);\n\nint main(int argc, const char * argv[]) {\n    ///////////////////////////////////////////////////////////////////////////////////////////// 1.\n        id obj0;\n        {\n            id obj1 = [NSMutableArray array];\n            obj0 = obj1;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj0-%@\", obj0);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 2.\n        id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            obj2 = obj3;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 3.\n        id __weak obj4;\n        @autoreleasepool {\n            id obj5 = [NSMutableArray array];\n            obj4 = obj5;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj4-%@\", obj4);\n    return 0;\n}\n```\n\n3__weak\n\n [](https://www.jianshu.com/p/e920d1ff570c)....\n\n\n\nretain\n\n## \nRuntime\n\n...\nARM\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png)\n\nruntime`objc_retainAutoreleasedReturnValue``objc_retainAutoreleasedReturnValue`\n\nweak\n```objective-c\n\t\t id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n```\n\n....\n\n\n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png)\n\nDebug`None`Release`Fastest,Smallest[-Os]`DebugRelease...\n\n......\n\n `objc_retainAutoreleasedReturnValue`...\n\n...\n\nx86iOSmaclevel...","source":"_posts/12.compiler-autorelease-opt.md","raw":"---\ntitle: AutoRelease\ndate: 2020-03-15\ntags: [object-c]\ncategories: object-c\n---\n\nARCruntime`objc_autoreleaseReturnValue``objc_retainAutoreleaseReturnValue`...\n\n<!-- more -->\n\n## \n:autorelease\n**MRC**\n\nMRC\n\n  1\n\n\n\n**ARC**\n\nARCMRCARCautoreleaseautorelease\n\n\n**runtime**\n\nMRC\n\nps:\n\nARC\n\nruntimeruntimeMRC\n\n`__builtin_return_address(int depth)``objc_retainAutoreleaseReturnValue`MRC`objc_autoreleaseReturnValue`flagTLS\n\n`objc_retainAutoreleaseReturnValue`TLSretain\n\n\n\n\n\nTLSflag\n\n`__builtin_return_address(int depth)`\n\n## \nARC...\n\nXcode Mac DemoARC\n\n..\n\n```objective-c\nextern void _objc_autoreleasePoolPrint(void);\n\nint main(int argc, const char * argv[]) {\n    ///////////////////////////////////////////////////////////////////////////////////////////// 1.\n        id obj0;\n        {\n            id obj1 = [NSMutableArray array];\n            obj0 = obj1;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj0-%@\", obj0);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 2.\n        id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            obj2 = obj3;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n        \n    ///////////////////////////////////////////////////////////////////////////////////////////// 3.\n        id __weak obj4;\n        @autoreleasepool {\n            id obj5 = [NSMutableArray array];\n            obj4 = obj5;\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj4-%@\", obj4);\n    return 0;\n}\n```\n\n3__weak\n\n [](https://www.jianshu.com/p/e920d1ff570c)....\n\n\n\nretain\n\n## \nRuntime\n\n...\nARM\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png)\n\nruntime`objc_retainAutoreleasedReturnValue``objc_retainAutoreleasedReturnValue`\n\nweak\n```objective-c\n\t\t id __weak obj2;\n        {\n            id obj3 = [NSMutableArray array];\n            _objc_autoreleasePoolPrint();\n        }\n        NSLog(@\"obj2-%@\", obj2);\n```\n\n....\n\n\n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png)\n\nDebug`None`Release`Fastest,Smallest[-Os]`DebugRelease...\n\n......\n\n `objc_retainAutoreleasedReturnValue`...\n\n...\n\nx86iOSmaclevel...","slug":"12.compiler-autorelease-opt","published":1,"updated":"2020-08-29T14:42:58.495Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2ky000793c9co5a5x1n","content":"<p>ARCruntime<code>objc_autoreleaseReturnValue</code><code>objc_retainAutoreleaseReturnValue</code></p>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:autorelease<br><strong>MRC</strong></p>\n<p>MRC</p>\n<p>  1</p>\n<p></p>\n<p><strong>ARC</strong></p>\n<p>ARCMRCARCautoreleaseautorelease</p>\n<p><strong>runtime</strong></p>\n<p>MRC</p>\n<p>ps:</p>\n<p>ARC</p>\n<p>runtimeruntimeMRC</p>\n<p><code>__builtin_return_address(int depth)</code><code>objc_retainAutoreleaseReturnValue</code>MRC<code>objc_autoreleaseReturnValue</code>flagTLS</p>\n<p><code>objc_retainAutoreleaseReturnValue</code>TLSretain</p>\n<p></p>\n<p></p>\n<p>TLSflag</p>\n<p><code>__builtin_return_address(int depth)</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>ARC</p>\n<p>Xcode Mac DemoARC</p>\n<p>..</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extern void _objc_autoreleasePoolPrint(void);</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, const char * argv[]) &#123;</span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 1.</span><br><span class=\"line\">        id obj0;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj1 = [NSMutableArray array];</span><br><span class=\"line\">            obj0 = obj1;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj0-%@&quot;, obj0);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 2.</span><br><span class=\"line\">        id __weak obj2;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj3 = [NSMutableArray array];</span><br><span class=\"line\">            obj2 = obj3;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj2-%@&quot;, obj2);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 3.</span><br><span class=\"line\">        id __weak obj4;</span><br><span class=\"line\">        @autoreleasepool &#123;</span><br><span class=\"line\">            id obj5 = [NSMutableArray array];</span><br><span class=\"line\">            obj4 = obj5;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj4-%@&quot;, obj4);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>3__weak</p>\n<p> <a href=\"https://www.jianshu.com/p/e920d1ff570c\"></a>.</p>\n<p></p>\n<p>retain</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Runtime</p>\n<p><br>ARM<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png\"></p>\n<p>runtime<code>objc_retainAutoreleasedReturnValue</code><code>objc_retainAutoreleasedReturnValue</code></p>\n<p>weak</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">id __weak obj2;</span><br><span class=\"line\">     &#123;</span><br><span class=\"line\">         id obj3 = [NSMutableArray array];</span><br><span class=\"line\">         _objc_autoreleasePoolPrint();</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     NSLog(@&quot;obj2-%@&quot;, obj2);</span><br></pre></td></tr></table></figure>\n\n<p>.</p>\n<p></p>\n<p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png\"></p>\n<p>Debug<code>None</code>Release<code>Fastest,Smallest[-Os]</code>DebugRelease</p>\n<p></p>\n<p> <code>objc_retainAutoreleasedReturnValue</code></p>\n<p></p>\n<p>x86iOSmaclevel</p>\n","site":{"data":{}},"excerpt":"<p>ARCruntime<code>objc_autoreleaseReturnValue</code><code>objc_retainAutoreleaseReturnValue</code></p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:autorelease<br><strong>MRC</strong></p>\n<p>MRC</p>\n<p>  1</p>\n<p></p>\n<p><strong>ARC</strong></p>\n<p>ARCMRCARCautoreleaseautorelease</p>\n<p><strong>runtime</strong></p>\n<p>MRC</p>\n<p>ps:</p>\n<p>ARC</p>\n<p>runtimeruntimeMRC</p>\n<p><code>__builtin_return_address(int depth)</code><code>objc_retainAutoreleaseReturnValue</code>MRC<code>objc_autoreleaseReturnValue</code>flagTLS</p>\n<p><code>objc_retainAutoreleaseReturnValue</code>TLSretain</p>\n<p></p>\n<p></p>\n<p>TLSflag</p>\n<p><code>__builtin_return_address(int depth)</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>ARC</p>\n<p>Xcode Mac DemoARC</p>\n<p>..</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extern void _objc_autoreleasePoolPrint(void);</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, const char * argv[]) &#123;</span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 1.</span><br><span class=\"line\">        id obj0;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj1 = [NSMutableArray array];</span><br><span class=\"line\">            obj0 = obj1;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj0-%@&quot;, obj0);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 2.</span><br><span class=\"line\">        id __weak obj2;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            id obj3 = [NSMutableArray array];</span><br><span class=\"line\">            obj2 = obj3;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj2-%@&quot;, obj2);</span><br><span class=\"line\">        </span><br><span class=\"line\">    ///////////////////////////////////////////////////////////////////////////////////////////// 3.</span><br><span class=\"line\">        id __weak obj4;</span><br><span class=\"line\">        @autoreleasepool &#123;</span><br><span class=\"line\">            id obj5 = [NSMutableArray array];</span><br><span class=\"line\">            obj4 = obj5;</span><br><span class=\"line\">            _objc_autoreleasePoolPrint();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        NSLog(@&quot;obj4-%@&quot;, obj4);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>3__weak</p>\n<p> <a href=\"https://www.jianshu.com/p/e920d1ff570c\"></a>.</p>\n<p></p>\n<p>retain</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>Runtime</p>\n<p><br>ARM<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/843978e4d9ad66e0db24562ace0f0f61.png\"></p>\n<p>runtime<code>objc_retainAutoreleasedReturnValue</code><code>objc_retainAutoreleasedReturnValue</code></p>\n<p>weak</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">id __weak obj2;</span><br><span class=\"line\">     &#123;</span><br><span class=\"line\">         id obj3 = [NSMutableArray array];</span><br><span class=\"line\">         _objc_autoreleasePoolPrint();</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     NSLog(@&quot;obj2-%@&quot;, obj2);</span><br></pre></td></tr></table></figure>\n\n<p>.</p>\n<p></p>\n<p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/3f92e902bb664855cef64c063158c7d4.png\"></p>\n<p>Debug<code>None</code>Release<code>Fastest,Smallest[-Os]</code>DebugRelease</p>\n<p></p>\n<p> <code>objc_retainAutoreleasedReturnValue</code></p>\n<p></p>\n<p>x86iOSmaclevel</p>"},{"title":"SQLite--OS","date":"2020-03-17T16:00:00.000Z","_content":"\n>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm\n\n<!-- more -->\n\n## Shm-\nshm-shared memory walwal-index()`SQLITE_OMIT_WAL`sqlite osshm\n\n4\n```c\nint sqlite3OsShmMap(sqlite3_file *,int,int,int,void volatile **);//\nint sqlite3OsShmLock(sqlite3_file *id, int, int, int);//mmap\nvoid sqlite3OsShmBarrier(sqlite3_file *id);//\nint sqlite3OsShmUnmap(sqlite3_file *id, int);//\n```\n\nmmap...\n\n### mmap\n\n...mmap\n\nmmapmmapcrashflush...\n\n****\n\n********...memory cachedirtysync\n\nread()write()buffcpucpuDMADMAcpubuff\n\n\n\n**mmap**\n\nmmapvma****\n\n:mmap\n\nmmapmmap\n\n### \n\nunixFileunixShm\n```c\nstruct unixShm {\n  unixShmNode *pShmNode;     /* The underlying unixShmNode object */\n  unixShm *pNext;            /* Next unixShm with the same unixShmNode */\n  u8 hasMutex;               /* True if holding the unixShmNode->pShmMutex */\n  u8 id;                     /* Id of this connection within its unixShmNode */\n  u16 sharedMask;            /* Mask of shared locks held */\n  u16 exclMask;              /* Mask of exclusive locks held */\n};\n```\n\nunixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode\n\nunixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()\n\n```c\nstruct unixShmNode {\n  unixInodeInfo *pInode;     /* unixInodeInfo that owns this SHM node */\n  sqlite3_mutex *pShmMutex;  /* Mutex to access this object */\n  char *zFilename;           /* Name of the mmapped file */\n  int hShm;                  /* Open file descriptor */\n  int szRegion;              /* Size of shared-memory regions */\n  u16 nRegion;               /* Size of array apRegion */\n  u8 isReadonly;             /* True if read-only */\n  u8 isUnlocked;             /* True if no DMS lock held */\n  char **apRegion;           /* Array of mapped shared-memory regions */\n  int nRef;                  /* Number of unixShm objects pointing to this */\n  unixShm *pFirst;           /* All unixShm objects pointing to this */\n};\n```\n\nSqlite4\n\n### sqlite3OsShmMap\nshmMap\n```c\nstatic int unixShmMap(\n  sqlite3_file *fd,               /* Handle open on database file */\n  int iRegion,                    /* Region to retrieve */\n  int szRegion,                   /* Size of regions */\n  int bExtend,                    /* True to extend file if necessary */\n  void volatile **pp              /* OUT: Mapped memory */\n)\n```\n\nsqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(****unixShmNodeszRegion)\n\nshmiRegionszRegionbExtendmmap\n\nsqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region\n\n\n1. unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader\n2. regioniRegionregionnReqRegionnReqRegion<unixShmNode.nRegion,35\n3. \n4. mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion\n5. unixShmNode.apRegioniRegionregionmmap\n\n**mmap**\nSqlitemmapSIGBUS\n\n [mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5) \n\ncachemmap\n\n### sqlite3OsShmUnmap\n\n\n```c\nstatic int unixShmUnmap(\n  sqlite3_file *fd,               /* The underlying database file */\n  int deleteFlag                  /* Delete shared-memory if true */\n)\n```\nUnmapdeleteFlag1\n\n\n1. unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm\n2. unixShmNode0\n3. nShmPerMaposMunmapmmap\n\n### sqlite3OsShmLock\n\n\n```c\nstatic int unixShmLock(\n  sqlite3_file *fd,          /* Database file holding the shared memory */\n  int ofst,                  /* First lock to acquire or release */\n  int n,                     /* Number of locks to acquire or release */\n  int flags                  /* What to do with the lock */\n)\n```\n\n```\n#define SQLITE_SHM_UNLOCK       1\n#define SQLITE_SHM_LOCK         2\n#define SQLITE_SHM_SHARED       4\n#define SQLITE_SHM_EXCLUSIVE    8\n```\nshm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive\n**shmexcl<->sharedunlockunlock**\n\nposix\n unixShm sharedMaskexclMaskshmmmap\n\n1. SQLITE_SHM_UNLOCK\nunixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask\n\n2. SQLITE_SHM_SHARED\nunixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1\n\n3. SQLITE_SHM_EXCLUSIVE\nunixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1\n\n### sqlite3OsShmBarrier\n\n`__sync_synchronize()`\n\n>\nmmap\n[ - ccxikka - ](https://www.cnblogs.com/ccxikka/p/10527056.html)\n[mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5)\n[mmap()](https://blog.csdn.net/Holy_666/article/details/86532671)\n\n[ - ](https://www.jianshu.com/p/64240319ed60)","source":"_posts/13.sqlite-os-shm.md","raw":"---\ntitle: SQLite--OS\ndate: 2020-03-18\ntags: [sqlite3,os,shm]\ncategories: sqlite3\n---\n\n>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm\n\n<!-- more -->\n\n## Shm-\nshm-shared memory walwal-index()`SQLITE_OMIT_WAL`sqlite osshm\n\n4\n```c\nint sqlite3OsShmMap(sqlite3_file *,int,int,int,void volatile **);//\nint sqlite3OsShmLock(sqlite3_file *id, int, int, int);//mmap\nvoid sqlite3OsShmBarrier(sqlite3_file *id);//\nint sqlite3OsShmUnmap(sqlite3_file *id, int);//\n```\n\nmmap...\n\n### mmap\n\n...mmap\n\nmmapmmapcrashflush...\n\n****\n\n********...memory cachedirtysync\n\nread()write()buffcpucpuDMADMAcpubuff\n\n\n\n**mmap**\n\nmmapvma****\n\n:mmap\n\nmmapmmap\n\n### \n\nunixFileunixShm\n```c\nstruct unixShm {\n  unixShmNode *pShmNode;     /* The underlying unixShmNode object */\n  unixShm *pNext;            /* Next unixShm with the same unixShmNode */\n  u8 hasMutex;               /* True if holding the unixShmNode->pShmMutex */\n  u8 id;                     /* Id of this connection within its unixShmNode */\n  u16 sharedMask;            /* Mask of shared locks held */\n  u16 exclMask;              /* Mask of exclusive locks held */\n};\n```\n\nunixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode\n\nunixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()\n\n```c\nstruct unixShmNode {\n  unixInodeInfo *pInode;     /* unixInodeInfo that owns this SHM node */\n  sqlite3_mutex *pShmMutex;  /* Mutex to access this object */\n  char *zFilename;           /* Name of the mmapped file */\n  int hShm;                  /* Open file descriptor */\n  int szRegion;              /* Size of shared-memory regions */\n  u16 nRegion;               /* Size of array apRegion */\n  u8 isReadonly;             /* True if read-only */\n  u8 isUnlocked;             /* True if no DMS lock held */\n  char **apRegion;           /* Array of mapped shared-memory regions */\n  int nRef;                  /* Number of unixShm objects pointing to this */\n  unixShm *pFirst;           /* All unixShm objects pointing to this */\n};\n```\n\nSqlite4\n\n### sqlite3OsShmMap\nshmMap\n```c\nstatic int unixShmMap(\n  sqlite3_file *fd,               /* Handle open on database file */\n  int iRegion,                    /* Region to retrieve */\n  int szRegion,                   /* Size of regions */\n  int bExtend,                    /* True to extend file if necessary */\n  void volatile **pp              /* OUT: Mapped memory */\n)\n```\n\nsqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(****unixShmNodeszRegion)\n\nshmiRegionszRegionbExtendmmap\n\nsqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region\n\n\n1. unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader\n2. regioniRegionregionnReqRegionnReqRegion<unixShmNode.nRegion,35\n3. \n4. mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion\n5. unixShmNode.apRegioniRegionregionmmap\n\n**mmap**\nSqlitemmapSIGBUS\n\n [mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5) \n\ncachemmap\n\n### sqlite3OsShmUnmap\n\n\n```c\nstatic int unixShmUnmap(\n  sqlite3_file *fd,               /* The underlying database file */\n  int deleteFlag                  /* Delete shared-memory if true */\n)\n```\nUnmapdeleteFlag1\n\n\n1. unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm\n2. unixShmNode0\n3. nShmPerMaposMunmapmmap\n\n### sqlite3OsShmLock\n\n\n```c\nstatic int unixShmLock(\n  sqlite3_file *fd,          /* Database file holding the shared memory */\n  int ofst,                  /* First lock to acquire or release */\n  int n,                     /* Number of locks to acquire or release */\n  int flags                  /* What to do with the lock */\n)\n```\n\n```\n#define SQLITE_SHM_UNLOCK       1\n#define SQLITE_SHM_LOCK         2\n#define SQLITE_SHM_SHARED       4\n#define SQLITE_SHM_EXCLUSIVE    8\n```\nshm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive\n**shmexcl<->sharedunlockunlock**\n\nposix\n unixShm sharedMaskexclMaskshmmmap\n\n1. SQLITE_SHM_UNLOCK\nunixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask\n\n2. SQLITE_SHM_SHARED\nunixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1\n\n3. SQLITE_SHM_EXCLUSIVE\nunixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1\n\n### sqlite3OsShmBarrier\n\n`__sync_synchronize()`\n\n>\nmmap\n[ - ccxikka - ](https://www.cnblogs.com/ccxikka/p/10527056.html)\n[mmap   -  - ](https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5)\n[mmap()](https://blog.csdn.net/Holy_666/article/details/86532671)\n\n[ - ](https://www.jianshu.com/p/64240319ed60)","slug":"13.sqlite-os-shm","published":1,"updated":"2020-08-29T14:42:58.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2ky000893c9fo2723uw","content":"<blockquote>\n<p>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"Shm-\"><a href=\"#Shm-\" class=\"headerlink\" title=\"Shm-\"></a>Shm-</h2><p>shm-shared memory walwal-index()<code>SQLITE_OMIT_WAL</code>sqlite osshm</p>\n<p>4</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmMap</span><span class=\"params\">(sqlite3_file *,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmLock</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>, <span class=\"type\">int</span>, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//mmap</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sqlite3OsShmBarrier</span><span class=\"params\">(sqlite3_file *id)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmUnmap</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//</span></span><br></pre></td></tr></table></figure>\n\n<p>mmap</p>\n<h3 id=\"mmap\"><a href=\"#mmap\" class=\"headerlink\" title=\"mmap\"></a>mmap</h3><p>mmap</p>\n<p>mmapmmapcrashflush</p>\n<p><strong></strong></p>\n<p><strong></strong><strong></strong>memory cachedirtysync</p>\n<p>read()write()buffcpucpuDMADMAcpubuff</p>\n<p></p>\n<p><strong>mmap</strong></p>\n<p>mmapvma<strong></strong></p>\n<p>:mmap</p>\n<p>mmapmmap</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>unixFileunixShm</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShm</span> &#123;</span></span><br><span class=\"line\">  unixShmNode *pShmNode;     <span class=\"comment\">/* The underlying unixShmNode object */</span></span><br><span class=\"line\">  unixShm *pNext;            <span class=\"comment\">/* Next unixShm with the same unixShmNode */</span></span><br><span class=\"line\">  u8 hasMutex;               <span class=\"comment\">/* True if holding the unixShmNode-&gt;pShmMutex */</span></span><br><span class=\"line\">  u8 id;                     <span class=\"comment\">/* Id of this connection within its unixShmNode */</span></span><br><span class=\"line\">  u16 sharedMask;            <span class=\"comment\">/* Mask of shared locks held */</span></span><br><span class=\"line\">  u16 exclMask;              <span class=\"comment\">/* Mask of exclusive locks held */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>unixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode</p>\n<p>unixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShmNode</span> &#123;</span></span><br><span class=\"line\">  unixInodeInfo *pInode;     <span class=\"comment\">/* unixInodeInfo that owns this SHM node */</span></span><br><span class=\"line\">  sqlite3_mutex *pShmMutex;  <span class=\"comment\">/* Mutex to access this object */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zFilename;           <span class=\"comment\">/* Name of the mmapped file */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hShm;                  <span class=\"comment\">/* Open file descriptor */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> szRegion;              <span class=\"comment\">/* Size of shared-memory regions */</span></span><br><span class=\"line\">  u16 nRegion;               <span class=\"comment\">/* Size of array apRegion */</span></span><br><span class=\"line\">  u8 isReadonly;             <span class=\"comment\">/* True if read-only */</span></span><br><span class=\"line\">  u8 isUnlocked;             <span class=\"comment\">/* True if no DMS lock held */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **apRegion;           <span class=\"comment\">/* Array of mapped shared-memory regions */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                  <span class=\"comment\">/* Number of unixShm objects pointing to this */</span></span><br><span class=\"line\">  unixShm *pFirst;           <span class=\"comment\">/* All unixShm objects pointing to this */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite4</p>\n<h3 id=\"sqlite3OsShmMap\"><a href=\"#sqlite3OsShmMap\" class=\"headerlink\" title=\"sqlite3OsShmMap\"></a>sqlite3OsShmMap</h3><p>shmMap</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmMap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* Handle open on database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> iRegion,                    <span class=\"comment\">/* Region to retrieve */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> szRegion,                   <span class=\"comment\">/* Size of regions */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> bExtend,                    <span class=\"comment\">/* True to extend file if necessary */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **pp              <span class=\"comment\">/* OUT: Mapped memory */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>sqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(<strong></strong>unixShmNodeszRegion)</p>\n<p>shmiRegionszRegionbExtendmmap</p>\n<p>sqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region</p>\n<p></p>\n<ol>\n<li>unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader</li>\n<li>regioniRegionregionnReqRegionnReqRegion&lt;unixShmNode.nRegion,35</li>\n<li></li>\n<li>mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion</li>\n<li>unixShmNode.apRegioniRegionregionmmap</li>\n</ol>\n<p><strong>mmap</strong><br>SqlitemmapSIGBUS</p>\n<p> <a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a> </p>\n<p>cachemmap</p>\n<h3 id=\"sqlite3OsShmUnmap\"><a href=\"#sqlite3OsShmUnmap\" class=\"headerlink\" title=\"sqlite3OsShmUnmap\"></a>sqlite3OsShmUnmap</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmUnmap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* The underlying database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> deleteFlag                  <span class=\"comment\">/* Delete shared-memory if true */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n<p>UnmapdeleteFlag1</p>\n<p></p>\n<ol>\n<li>unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm</li>\n<li>unixShmNode0</li>\n<li>nShmPerMaposMunmapmmap</li>\n</ol>\n<h3 id=\"sqlite3OsShmLock\"><a href=\"#sqlite3OsShmLock\" class=\"headerlink\" title=\"sqlite3OsShmLock\"></a>sqlite3OsShmLock</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmLock</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,          <span class=\"comment\">/* Database file holding the shared memory */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> ofst,                  <span class=\"comment\">/* First lock to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> n,                     <span class=\"comment\">/* Number of locks to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> flags                  <span class=\"comment\">/* What to do with the lock */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define SQLITE_SHM_UNLOCK       1</span><br><span class=\"line\">#define SQLITE_SHM_LOCK         2</span><br><span class=\"line\">#define SQLITE_SHM_SHARED       4</span><br><span class=\"line\">#define SQLITE_SHM_EXCLUSIVE    8</span><br></pre></td></tr></table></figure>\n<p>shm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive<br><strong>shmexcl&lt;-&gt;sharedunlockunlock</strong></p>\n<p>posix<br> unixShm sharedMaskexclMaskshmmmap</p>\n<ol>\n<li><p>SQLITE_SHM_UNLOCK<br>unixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask</p>\n</li>\n<li><p>SQLITE_SHM_SHARED<br>unixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1</p>\n</li>\n<li><p>SQLITE_SHM_EXCLUSIVE<br>unixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1</p>\n</li>\n</ol>\n<h3 id=\"sqlite3OsShmBarrier\"><a href=\"#sqlite3OsShmBarrier\" class=\"headerlink\" title=\"sqlite3OsShmBarrier\"></a>sqlite3OsShmBarrier</h3><p><code>__sync_synchronize()</code></p>\n<blockquote>\n<p><br>mmap<br><a href=\"https://www.cnblogs.com/ccxikka/p/10527056.html\"> - ccxikka - </a><br><a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a><br><a href=\"https://blog.csdn.net/Holy_666/article/details/86532671\">mmap()</a><br><br><a href=\"https://www.jianshu.com/p/64240319ed60\"> - </a></p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>sqlite waldbdb-shmshared-memoryshmsqliteosshmshm</p>\n</blockquote>","more":"<h2 id=\"Shm-\"><a href=\"#Shm-\" class=\"headerlink\" title=\"Shm-\"></a>Shm-</h2><p>shm-shared memory walwal-index()<code>SQLITE_OMIT_WAL</code>sqlite osshm</p>\n<p>4</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmMap</span><span class=\"params\">(sqlite3_file *,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">int</span>,<span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmLock</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>, <span class=\"type\">int</span>, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//mmap</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">sqlite3OsShmBarrier</span><span class=\"params\">(sqlite3_file *id)</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsShmUnmap</span><span class=\"params\">(sqlite3_file *id, <span class=\"type\">int</span>)</span>;<span class=\"comment\">//</span></span><br></pre></td></tr></table></figure>\n\n<p>mmap</p>\n<h3 id=\"mmap\"><a href=\"#mmap\" class=\"headerlink\" title=\"mmap\"></a>mmap</h3><p>mmap</p>\n<p>mmapmmapcrashflush</p>\n<p><strong></strong></p>\n<p><strong></strong><strong></strong>memory cachedirtysync</p>\n<p>read()write()buffcpucpuDMADMAcpubuff</p>\n<p></p>\n<p><strong>mmap</strong></p>\n<p>mmapvma<strong></strong></p>\n<p>:mmap</p>\n<p>mmapmmap</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>unixFileunixShm</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShm</span> &#123;</span></span><br><span class=\"line\">  unixShmNode *pShmNode;     <span class=\"comment\">/* The underlying unixShmNode object */</span></span><br><span class=\"line\">  unixShm *pNext;            <span class=\"comment\">/* Next unixShm with the same unixShmNode */</span></span><br><span class=\"line\">  u8 hasMutex;               <span class=\"comment\">/* True if holding the unixShmNode-&gt;pShmMutex */</span></span><br><span class=\"line\">  u8 id;                     <span class=\"comment\">/* Id of this connection within its unixShmNode */</span></span><br><span class=\"line\">  u16 sharedMask;            <span class=\"comment\">/* Mask of shared locks held */</span></span><br><span class=\"line\">  u16 exclMask;              <span class=\"comment\">/* Mask of exclusive locks held */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>unixShmunixShmNodeunixShmNodeunixShmpNextunixShmNodeshmunixShmNodepfirstWAL modeunixShmunixShmNode</p>\n<p>unixShmNodeunixInodeInfoshmWAL modeunixInodeInfopShmNodeunixShmNodepInode()</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixShmNode</span> &#123;</span></span><br><span class=\"line\">  unixInodeInfo *pInode;     <span class=\"comment\">/* unixInodeInfo that owns this SHM node */</span></span><br><span class=\"line\">  sqlite3_mutex *pShmMutex;  <span class=\"comment\">/* Mutex to access this object */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zFilename;           <span class=\"comment\">/* Name of the mmapped file */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hShm;                  <span class=\"comment\">/* Open file descriptor */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> szRegion;              <span class=\"comment\">/* Size of shared-memory regions */</span></span><br><span class=\"line\">  u16 nRegion;               <span class=\"comment\">/* Size of array apRegion */</span></span><br><span class=\"line\">  u8 isReadonly;             <span class=\"comment\">/* True if read-only */</span></span><br><span class=\"line\">  u8 isUnlocked;             <span class=\"comment\">/* True if no DMS lock held */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> **apRegion;           <span class=\"comment\">/* Array of mapped shared-memory regions */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                  <span class=\"comment\">/* Number of unixShm objects pointing to this */</span></span><br><span class=\"line\">  unixShm *pFirst;           <span class=\"comment\">/* All unixShm objects pointing to this */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite4</p>\n<h3 id=\"sqlite3OsShmMap\"><a href=\"#sqlite3OsShmMap\" class=\"headerlink\" title=\"sqlite3OsShmMap\"></a>sqlite3OsShmMap</h3><p>shmMap</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmMap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* Handle open on database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> iRegion,                    <span class=\"comment\">/* Region to retrieve */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> szRegion,                   <span class=\"comment\">/* Size of regions */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> bExtend,                    <span class=\"comment\">/* True to extend file if necessary */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">void</span> <span class=\"keyword\">volatile</span> **pp              <span class=\"comment\">/* OUT: Mapped memory */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>sqliteregion(unixShmNodeapRegionregion,nRegion)unixShmMapiRegionmmapregionsizeszRegion(<strong></strong>unixShmNodeszRegion)</p>\n<p>shmiRegionszRegionbExtendmmap</p>\n<p>sqliteregion size32kbmmappage sizepage size 324kmmapnShmPerMap1regionpage size64knShmPerMap2region</p>\n<p></p>\n<ol>\n<li>unixNodeInfopShmNodeunixShmNodeunixNodeInfoshmshm128333shmheader</li>\n<li>regioniRegionregionnReqRegionnReqRegion&lt;unixShmNode.nRegion,35</li>\n<li></li>\n<li>mmapregionunixShmNode.nRegionnReqRegionapRegionnShmPerMapregionnShmPerMapregionapRegion</li>\n<li>unixShmNode.apRegioniRegionregionmmap</li>\n</ol>\n<p><strong>mmap</strong><br>SqlitemmapSIGBUS</p>\n<p> <a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a> </p>\n<p>cachemmap</p>\n<h3 id=\"sqlite3OsShmUnmap\"><a href=\"#sqlite3OsShmUnmap\" class=\"headerlink\" title=\"sqlite3OsShmUnmap\"></a>sqlite3OsShmUnmap</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmUnmap</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,               <span class=\"comment\">/* The underlying database file */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> deleteFlag                  <span class=\"comment\">/* Delete shared-memory if true */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n<p>UnmapdeleteFlag1</p>\n<p></p>\n<ol>\n<li>unixInodeInfounixShmNodeunixShmNodefirstsqlite_fileunixShm</li>\n<li>unixShmNode0</li>\n<li>nShmPerMaposMunmapmmap</li>\n</ol>\n<h3 id=\"sqlite3OsShmLock\"><a href=\"#sqlite3OsShmLock\" class=\"headerlink\" title=\"sqlite3OsShmLock\"></a>sqlite3OsShmLock</h3><p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">unixShmLock</span><span class=\"params\">(</span></span><br><span class=\"line\"><span class=\"params\">  sqlite3_file *fd,          <span class=\"comment\">/* Database file holding the shared memory */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> ofst,                  <span class=\"comment\">/* First lock to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> n,                     <span class=\"comment\">/* Number of locks to acquire or release */</span></span></span><br><span class=\"line\"><span class=\"params\">  <span class=\"type\">int</span> flags                  <span class=\"comment\">/* What to do with the lock */</span></span></span><br><span class=\"line\"><span class=\"params\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define SQLITE_SHM_UNLOCK       1</span><br><span class=\"line\">#define SQLITE_SHM_LOCK         2</span><br><span class=\"line\">#define SQLITE_SHM_SHARED       4</span><br><span class=\"line\">#define SQLITE_SHM_EXCLUSIVE    8</span><br></pre></td></tr></table></figure>\n<p>shm4flagsUNLOCKLOCK  SHAREDEXCLUSIVE4unlocksharedexclusive<br><strong>shmexcl&lt;-&gt;sharedunlockunlock</strong></p>\n<p>posix<br> unixShm sharedMaskexclMaskshmmmap</p>\n<ol>\n<li><p>SQLITE_SHM_UNLOCK<br>unixShmNodeunixShmunixShmunixShmSystemLocksharedMaskexclMask</p>\n</li>\n<li><p>SQLITE_SHM_SHARED<br>unixShmNodeunixShmexclusiveSQLITE_BUSYunixShmSystemLockunixShmsharedMask1</p>\n</li>\n<li><p>SQLITE_SHM_EXCLUSIVE<br>unixShmNodeunixShmSQLITE_BUSYunixShmSystemLockexclMask1</p>\n</li>\n</ol>\n<h3 id=\"sqlite3OsShmBarrier\"><a href=\"#sqlite3OsShmBarrier\" class=\"headerlink\" title=\"sqlite3OsShmBarrier\"></a>sqlite3OsShmBarrier</h3><p><code>__sync_synchronize()</code></p>\n<blockquote>\n<p><br>mmap<br><a href=\"https://www.cnblogs.com/ccxikka/p/10527056.html\"> - ccxikka - </a><br><a href=\"https://www.cnblogs.com/huxiao-tee/p/4660352.html#_label5\">mmap   -  - </a><br><a href=\"https://blog.csdn.net/Holy_666/article/details/86532671\">mmap()</a><br><br><a href=\"https://www.jianshu.com/p/64240319ed60\"> - </a></p>\n</blockquote>"},{"title":"GoMobile\"\"","date":"2020-03-31T16:00:00.000Z","_content":"\n> ...Golanggomobile bind -target=ios xxx framework\n\nGolangOCGoOCGolang\n\nGobind\n\n<!-- more -->\n\nGo\n```\npackage g_mb_test\n\ntype GMBInterface interface {\n\tInterfaceTest()\n}\ntype GMBTest struct {\n}\n\nfunc (t *GMBTest) GMBTestOne(value int32) {\n\n}\n\nfunc (t *GMBTest) GMBTestSecond(data []byte, str string) {\n\n}\n\nfunc (t *GMBTest) GMBTest3() string {\n    return \n}\n\nfunc (t *GMBTest) GMBTest4() []byte {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest5() GMBInterface {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest6() *GMBTest {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest7(i GMBInterface) {\n}\n```\n\n1. Go OC\n2. OCGolang\n3. OCGolangNSData -> []byte, NSString -> string, interface(OC) -> interface\n4. OCGolang GolangOC\n5. Golang[]byte -> NSData, string -> NSString, interface -> interface(OC)?\n6. Golang \n\n\nGolangCGolang\"\"C(cgo)OCCOCCOCGolang C\n\n\n`gomobile bind -target=ios/amd64 -work Caio/g_mb_test`\n\ngo-buildxxxsrcgomobile\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png)\n\n### \n```\n- (instancetype)init {\n    self = [super init];\n    if (self) {\n        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());\n    }\n    return self;\n}\n```\n\nnew_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego\n\niOS frameworknew_g_mb_test_GMBTest()frameworkGo\n\n new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m\n```\nGoSeqRef *go_seq_from_refnum(int32_t refnum) {\n  if (refnum == NULL_REFNUM) {\n    return nil;\n  }\n  if (IS_FROM_GO(refnum)) {\n    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];\n  }\n  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];\n}\n```\n\nGoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj\n\nint32\n*Go*\n\n```\n*go_g_mb_testmain.go*\n//export new_g_mb_test_GMBTest\nfunc new_g_mb_test_GMBTest() C.int32_t {\n    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))\n}\n```\n\n new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org/x/mobile/bind/seq/ref.go bindgo struct\n\n```\n*golang.org/x/mobile/bind/seq/ref.go*\n// ToRefNum increments the reference count for an object and\n// returns its refnum.\nfunc ToRefNum(obj interface{}) int32 {\n    // We dont track foreign objects, so if obj is a proxy\n    // return its refnum.\n    if r, ok := obj.(proxy); ok {\n        refnum := r.Bind_proxy_refnum__()\n        if refnum <= 0 {\n            panic(fmt.Errorf(\"seq: proxy contained invalid Go refnum: %d\", refnum))\n        }\n        return refnum\n    }\n    refs.Lock()\n    num := refs.refs[obj]\n    if num != 0 {\n        s := refs.objs[num]\n        refs.objs[num] = countedObj{s.obj, s.cnt + 1}\n    } else {\n        num = refs.next\n        refs.next--\n        if refs.next > 0 {\n            panic(refs.next underflow)\n        }\n        refs.refs[obj] = num\n        refs.objs[num] = countedObj{obj, 1}\n    }\n    refs.Unlock()\n\n    return int32(num)\n}\n```\n\nproxyrefs\n```\n// refs stores Go objects that have been passed to another language.\nvar refs struct {\n    sync.Mutex\n    next int32 // next reference number to use for Go object, always negative\n    refs map[interface{}]int32\n    objs map[int32]countedObj\n}\n```\n\nrefsGolang\n\nmaprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum\n\nrefobjnumnext-1refnummap\n\n****\n1. GoGo\n2. Gorefnum\n3. +1\n4. Gorefnum\n\n**\n Go oc :\n\nOCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo\n\n#### OC\nGolang gmbTestOne \n\n```\n- (void)gmbTestOne:(int32_t)value {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _value = (int32_t)value;\n    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);\n}\n\n```\ngo_seq_go_to_refnum()Seq_darwin.m\n```\n- (int32_t)incNum {\n  IncGoRef(_refnum);\n  return _refnum;\n}\n```\n_refnumIncGoRef(_refnum);\nref.goGo\n**OC ARCint32_t refnum int\n\nproxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue\n\n refnumGoGo\n*Go*\n```\n//export proxyg_mb_test_GMBTest_GMBTestOne\nfunc proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    _param_value := int32(param_value)\n    v.GMBTestOne(_param_value)\n}\n```\n\n```\n// FromRefNum returns the Ref for a refnum. If the refnum specifies a\n// foreign object, a finalizer is set to track its lifetime.\nfunc FromRefNum(num int32) *Ref {\n    if num == NullRefNum {\n        return nil\n    }\n    ref := &Ref{num}\n    if num > 0 {\n        // This is a foreign object reference.\n        // Track its lifetime with a finalizer.\n        runtime.SetFinalizer(ref, FinalizeRef)\n    }\n\n    return ref\n}\n```\nOCGoRefrefnum\nnum > 0\n\n```\n// Get returns the underlying object.\nfunc (r *Ref) Get() interface{} {\n    refnum := r.Bind_Num\n    refs.Lock()\n    o, ok := refs.objs[refnum]\n    refs.Unlock()\n    if !ok {\n        panic(fmt.Sprintf(unknown ref %d, refnum))\n    }\n    // This is a Go reference and its refnum was incremented\n    // before crossing the language barrier.\n    Delete(refnum)\n    return o.obj\n}\n```\nDelete-10map\n\n**GolangGolang v := ref.Get().(*g_mb_test.GMBTest) GolangGolang\n\nGoint\n\n****\nOCGolangOCself.ref  refnumGoGorefnumGolang\n\n#### Golang\nGolangGoGoGoGoOCNSDataNSString\n\n```\n- (G_mb_testGMBTest*)gmbTest6 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);\n    G_mb_testGMBTest* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest6()intGolang\n```\n//export proxyg_mb_test_GMBTest_GMBTest6\nfunc proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    res_0 := v.GMBTest6()\n    var _res_0 C.int32_t = _seq.NullRefNum\n    if res_0 != nil {\n        _res_0 = C.int32_t(_seq.ToRefNum(res_0))\n    }\n    return _res_0\n}\n```\n\nres_0nil_seq.NullRefNum = 41null\nOCgo_seq_from_refnum()41\n\n****\nGorefnumOCGoSeqRefGo\n\n#### Golang\nGo\n\n```\n- (id<G_mb_testGMBInterface>)gmbTest5 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);\n    G_mb_testGMBInterface* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum\n\n```\n@implementation G_mb_testGMBInterface {\n}\n\n- (instancetype)initWithRef:(id)ref {\n    self = [super init];\n    if (self) { __ref = ref; }\n    return self;\n}\n\n- (void)interfaceTest {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);\n}\n\n@end\n```\n\ng_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo\n\n****\nGoOCrefnumGoSeqRefGoSeqRefGo\n\nGoNSDataNSStringOCGo\n\n#### OCGo\n\n\n```\n- (void)gmbTest7:(id<G_mb_testGMBInterface>)i {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _i;\n    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) {\n        id<goSeqRefInterface> i_proxy = (id<goSeqRefInterface>)(i);\n        _i = go_seq_go_to_refnum(i_proxy._ref);\n    } else {\n        _i = go_seq_to_refnum(i);\n    }\n    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);\n}\n```\ngoSeqRefInterfaceGoGoSeqRef)\nGo\nGoOC newgo_seq_to_refnum()\n\ntracker\nOCGorefsOCGo\nGoOCGoGorefnumOC\n\nproxyg_mb_test_GMBTest_GMBTest7()\n```\n//export proxyg_mb_test_GMBTest_GMBTest7\nfunc proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    var _param_i g_mb_test.GMBInterface\n    _param_i_ref := _seq.FromRefNum(int32(param_i))\n    if _param_i_ref != nil {\n        if param_i < 0 { // go object\n            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)\n        } else { // foreign object\n            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)\n        }\n    }\n    v.GMBTest7(_param_i)\n}\n```\n\n_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface\n\nproxyg_mb_test_GMBInterface \n```\ntype proxyg_mb_test_GMBInterface _seq.Ref\n\nfunc (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 { return (*_seq.Ref)(p).Bind_IncNum() }\n\nfunc (p *proxyg_mb_test_GMBInterface) InterfaceTest() {\n    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))\n}\n```\n\nBind_proxy_refnum__()RefBind_IncNum(),\n```\nfunc init() {\n    _seq.FinalizeRef = func(ref *_seq.Ref) {\n        refnum := ref.Bind_Num\n        if refnum < 0 {\n            panic(fmt.Sprintf(not a foreign ref: %d, refnum))\n        }\n        C.go_seq_dec_ref(C.int32_t(refnum))\n    }\n    _seq.IncForeignRef = func(refnum int32) {\n        if refnum < 0 {\n            panic(fmt.Sprintf(\"not a foreign ref: %d\", refnum))\n        }\n        C.go_seq_inc_ref(C.int32_t(refnum))\n    }\n}\n```\nseqBind_IncNum()_seq.IncForeignRef()\nC.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),\n\n```\nvoid go_seq_dec_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker dec:refnum];\n  }\n}\n\nvoid go_seq_inc_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker inc:refnum];\n  }\n}\n\n```\nseq_darwin.m\n\nFromRefNumGoRef\nGoRefGoRef \n\nInterfaceTest()\n```\nvoid cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) {\n    @autoreleasepool {\n        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);\n        [o interfaceTest];\n    }\n}\n```\n_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];\nOC\n\n****\nOCGoGoGoOC+11GoGoRef -1\nGoGoRefOCOCOCOC-1Go\n\ngo_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum\n\n## \n1. GoCOCOC\n2. GoOCint32(refnum)refnum>0OC<0Go\n3. GoOCrefnumGoRef structGoSeqRef class\n4. GoOC\n5. OCGorefnum\n6. OCGoGoCrefnumGoGo\n7. GoOCC.mrefnumOCOC\n8. OCGoGoSeqRefrefnumGo\n9. GoOCC.mGoRefOCrefnum.mOC\n10. GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1\n11. OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1\n12. GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1\n13. OCGoGoBind_IncNum()+1OCrefnumoc obj -1\n\n\n\n//\n\n## \n NSString  NSDataGo <> OC gomobile \n```\ntypedef struct nstring {\n  void *ptr;\n  int len;\n} nstring;\n\ntypedef struct nbyteslice {\n  void *ptr;\n  int len;\n} nbyteslice;\ntypedef int nint;\n```\nCstruct\n\n### String\n```\n// encodeString copies a Go string and returns it as a nstring.\nfunc encodeString(s string) C.nstring {\n    n := C.int(len(s))\n    if n == 0 {\n        return C.nstring{}\n    }\n    ptr := C.malloc(C.size_t(n))\n    if ptr == nil {\n        panic(\"encodeString: malloc failed\")\n    }\n    copy((*[1<<31 - 1]byte)(ptr)[:n], s)\n    return C.nstring{ptr: ptr, len: n}\n}\n\n// decodeString converts a nstring to a Go string. The\n// data in str is freed after use.\nfunc decodeString(str C.nstring) string {\n    if str.ptr == nil {\n        return \"\"\n    }\n    s := C.GoStringN((*C.char)(str.ptr), str.len)\n    C.free(str.ptr)\n    return s\n}\n```\n\nGo  string encodedecodecstringgo string*copy*\n\n```\nNSString *go_seq_to_objc_string(nstring str) {\n  if (str.len == 0) {  // empty string.\n    return @;\n  }\n  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr\n                                                  length:str.len\n                                                encoding:NSUTF8StringEncoding\n                                            freeWhenDone:YES];\n  return res;\n}\n\nnstring go_seq_from_objc_string(NSString *s) {\n  nstring res = {NULL, 0};\n  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];\n\n  if (len == 0) {\n    if (s.length > 0) {\n      LOG_INFO(@unable to encode an NSString into UTF-8);\n    }\n    return res;\n  }\n\n  char *buf = (char *)malloc(len);\n  if (buf == NULL) {\n    LOG_FATAL(@\"malloc failed\");\n  }\n  NSUInteger used;\n  [s getBytes:buf\n           maxLength:len\n          usedLength:&used\n            encoding:NSUTF8StringEncoding\n             options:0\n               range:NSMakeRange(0, [s length])\n      remainingRange:NULL];\n  res.ptr = buf;\n  res.len = used;\n  return res;\n}\n```\n\nOC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring*copy*\n\ncstring\n\n### Bytes\n```\n\n// fromSlice converts a slice to a nbyteslice.\n// If cpy is set, a malloced copy of the data is returned.\nfunc fromSlice(s []byte, cpy bool) C.nbyteslice {\n    if s == nil || len(s) == 0 {\n        return C.nbyteslice{}\n    }\n    ptr, n := unsafe.Pointer(&s[0]), C.int(len(s))\n    if cpy {\n        nptr := C.malloc(C.size_t(n))\n        if nptr == nil {\n            panic(\"fromSlice: malloc failed\")\n        }\n        copy((*[1<<31 - 1]byte)(nptr)[:n], (*[1<<31 - 1]byte)(ptr)[:n])\n        ptr = nptr\n    }\n    return C.nbyteslice{ptr: ptr, len: n}\n}\n\n// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is\n// set, the slice contains a copy of the data. If not, the generated Go code\n// calls releaseByteSlice after use.\nfunc toSlice(s C.nbyteslice, cpy bool) []byte {\n    if s.ptr == nil || s.len == 0 {\n        return nil\n    }\n    var b []byte\n    if cpy {\n        b = C.GoBytes(s.ptr, C.int(s.len))\n        C.free(s.ptr)\n    } else {\n        b = (*[1<<31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]\n    }\n    return b\n}\n```\n\nGo  nbyteslice fromSlicetoSlicenbyteslicego slice\n\nOC -> Go OCcopy == trueGonbyteslice\nGo -> OC  (copy go->OC copy=true)\n\n```\nNSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) {\n  if (s.ptr == NULL) {\n    return NULL;\n  }\n  BOOL freeWhenDone = copy ? YES : NO;\n  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];\n}\n\nnbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) {\n  struct nbyteslice res = {NULL, 0};\n  int sz = data.length;\n  if (sz == 0) {\n    return res;\n  }\n  void *ptr;\n  // If the argument was not a NSMutableData, copy the data so that\n  // the NSData is not changed from Go. The corresponding free is called\n  // by releaseByteSlice.\n  if (copy || ![data isKindOfClass:[NSMutableData class]]) {\n    void *arr_copy = malloc(sz);\n    if (arr_copy == NULL) {\n      LOG_FATAL(@\"malloc failed\");\n    }\n    memcpy(arr_copy, [data bytes], sz);\n    ptr = arr_copy;\n  } else {\n    ptr = (void *)[data bytes];\n  }\n  res.ptr = ptr;\n  res.len = sz;\n  return res;\n}\n\n```\n\nOC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData\n\nOC -> Go (NSMutableData && !copy OC->Go copy = falseNSDataNSMutableData)*bytes*Goslicebytes\nGo -> OC  OCGobytesOCNSDatanbyteslice.\n\n*copycopyNSDatafalse*\n\n---\n\n2020-3-18 \n[ Dart  Objective-C ](http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/)\n\nDartOCGoMobile...","source":"_posts/14.gomobile-bind.md","raw":"---\ntitle: GoMobile\"\"\ndate: 2020-04-01\ntags: [GoMobile]\ncategories: GoMobile\n---\n\n> ...Golanggomobile bind -target=ios xxx framework\n\nGolangOCGoOCGolang\n\nGobind\n\n<!-- more -->\n\nGo\n```\npackage g_mb_test\n\ntype GMBInterface interface {\n\tInterfaceTest()\n}\ntype GMBTest struct {\n}\n\nfunc (t *GMBTest) GMBTestOne(value int32) {\n\n}\n\nfunc (t *GMBTest) GMBTestSecond(data []byte, str string) {\n\n}\n\nfunc (t *GMBTest) GMBTest3() string {\n    return \n}\n\nfunc (t *GMBTest) GMBTest4() []byte {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest5() GMBInterface {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest6() *GMBTest {\n    return nil\n}\n\nfunc (t *GMBTest) GMBTest7(i GMBInterface) {\n}\n```\n\n1. Go OC\n2. OCGolang\n3. OCGolangNSData -> []byte, NSString -> string, interface(OC) -> interface\n4. OCGolang GolangOC\n5. Golang[]byte -> NSData, string -> NSString, interface -> interface(OC)?\n6. Golang \n\n\nGolangCGolang\"\"C(cgo)OCCOCCOCGolang C\n\n\n`gomobile bind -target=ios/amd64 -work Caio/g_mb_test`\n\ngo-buildxxxsrcgomobile\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png)\n\n### \n```\n- (instancetype)init {\n    self = [super init];\n    if (self) {\n        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());\n    }\n    return self;\n}\n```\n\nnew_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego\n\niOS frameworknew_g_mb_test_GMBTest()frameworkGo\n\n new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m\n```\nGoSeqRef *go_seq_from_refnum(int32_t refnum) {\n  if (refnum == NULL_REFNUM) {\n    return nil;\n  }\n  if (IS_FROM_GO(refnum)) {\n    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];\n  }\n  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];\n}\n```\n\nGoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj\n\nint32\n*Go*\n\n```\n*go_g_mb_testmain.go*\n//export new_g_mb_test_GMBTest\nfunc new_g_mb_test_GMBTest() C.int32_t {\n    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))\n}\n```\n\n new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org/x/mobile/bind/seq/ref.go bindgo struct\n\n```\n*golang.org/x/mobile/bind/seq/ref.go*\n// ToRefNum increments the reference count for an object and\n// returns its refnum.\nfunc ToRefNum(obj interface{}) int32 {\n    // We dont track foreign objects, so if obj is a proxy\n    // return its refnum.\n    if r, ok := obj.(proxy); ok {\n        refnum := r.Bind_proxy_refnum__()\n        if refnum <= 0 {\n            panic(fmt.Errorf(\"seq: proxy contained invalid Go refnum: %d\", refnum))\n        }\n        return refnum\n    }\n    refs.Lock()\n    num := refs.refs[obj]\n    if num != 0 {\n        s := refs.objs[num]\n        refs.objs[num] = countedObj{s.obj, s.cnt + 1}\n    } else {\n        num = refs.next\n        refs.next--\n        if refs.next > 0 {\n            panic(refs.next underflow)\n        }\n        refs.refs[obj] = num\n        refs.objs[num] = countedObj{obj, 1}\n    }\n    refs.Unlock()\n\n    return int32(num)\n}\n```\n\nproxyrefs\n```\n// refs stores Go objects that have been passed to another language.\nvar refs struct {\n    sync.Mutex\n    next int32 // next reference number to use for Go object, always negative\n    refs map[interface{}]int32\n    objs map[int32]countedObj\n}\n```\n\nrefsGolang\n\nmaprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum\n\nrefobjnumnext-1refnummap\n\n****\n1. GoGo\n2. Gorefnum\n3. +1\n4. Gorefnum\n\n**\n Go oc :\n\nOCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo\n\n#### OC\nGolang gmbTestOne \n\n```\n- (void)gmbTestOne:(int32_t)value {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _value = (int32_t)value;\n    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);\n}\n\n```\ngo_seq_go_to_refnum()Seq_darwin.m\n```\n- (int32_t)incNum {\n  IncGoRef(_refnum);\n  return _refnum;\n}\n```\n_refnumIncGoRef(_refnum);\nref.goGo\n**OC ARCint32_t refnum int\n\nproxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue\n\n refnumGoGo\n*Go*\n```\n//export proxyg_mb_test_GMBTest_GMBTestOne\nfunc proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    _param_value := int32(param_value)\n    v.GMBTestOne(_param_value)\n}\n```\n\n```\n// FromRefNum returns the Ref for a refnum. If the refnum specifies a\n// foreign object, a finalizer is set to track its lifetime.\nfunc FromRefNum(num int32) *Ref {\n    if num == NullRefNum {\n        return nil\n    }\n    ref := &Ref{num}\n    if num > 0 {\n        // This is a foreign object reference.\n        // Track its lifetime with a finalizer.\n        runtime.SetFinalizer(ref, FinalizeRef)\n    }\n\n    return ref\n}\n```\nOCGoRefrefnum\nnum > 0\n\n```\n// Get returns the underlying object.\nfunc (r *Ref) Get() interface{} {\n    refnum := r.Bind_Num\n    refs.Lock()\n    o, ok := refs.objs[refnum]\n    refs.Unlock()\n    if !ok {\n        panic(fmt.Sprintf(unknown ref %d, refnum))\n    }\n    // This is a Go reference and its refnum was incremented\n    // before crossing the language barrier.\n    Delete(refnum)\n    return o.obj\n}\n```\nDelete-10map\n\n**GolangGolang v := ref.Get().(*g_mb_test.GMBTest) GolangGolang\n\nGoint\n\n****\nOCGolangOCself.ref  refnumGoGorefnumGolang\n\n#### Golang\nGolangGoGoGoGoOCNSDataNSString\n\n```\n- (G_mb_testGMBTest*)gmbTest6 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);\n    G_mb_testGMBTest* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest6()intGolang\n```\n//export proxyg_mb_test_GMBTest_GMBTest6\nfunc proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    res_0 := v.GMBTest6()\n    var _res_0 C.int32_t = _seq.NullRefNum\n    if res_0 != nil {\n        _res_0 = C.int32_t(_seq.ToRefNum(res_0))\n    }\n    return _res_0\n}\n```\n\nres_0nil_seq.NullRefNum = 41null\nOCgo_seq_from_refnum()41\n\n****\nGorefnumOCGoSeqRefGo\n\n#### Golang\nGo\n\n```\n- (id<G_mb_testGMBInterface>)gmbTest5 {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);\n    G_mb_testGMBInterface* _ret0_ = nil;\n    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);\n    if (_ret0__ref != NULL) {\n        _ret0_ = _ret0__ref.obj;\n        if (_ret0_ == nil) {\n            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];\n        }\n    }\n    return _ret0_;\n}\n```\nproxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum\n\n```\n@implementation G_mb_testGMBInterface {\n}\n\n- (instancetype)initWithRef:(id)ref {\n    self = [super init];\n    if (self) { __ref = ref; }\n    return self;\n}\n\n- (void)interfaceTest {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);\n}\n\n@end\n```\n\ng_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo\n\n****\nGoOCrefnumGoSeqRefGoSeqRefGo\n\nGoNSDataNSStringOCGo\n\n#### OCGo\n\n\n```\n- (void)gmbTest7:(id<G_mb_testGMBInterface>)i {\n    int32_t refnum = go_seq_go_to_refnum(self._ref);\n    int32_t _i;\n    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) {\n        id<goSeqRefInterface> i_proxy = (id<goSeqRefInterface>)(i);\n        _i = go_seq_go_to_refnum(i_proxy._ref);\n    } else {\n        _i = go_seq_to_refnum(i);\n    }\n    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);\n}\n```\ngoSeqRefInterfaceGoGoSeqRef)\nGo\nGoOC newgo_seq_to_refnum()\n\ntracker\nOCGorefsOCGo\nGoOCGoGorefnumOC\n\nproxyg_mb_test_GMBTest_GMBTest7()\n```\n//export proxyg_mb_test_GMBTest_GMBTest7\nfunc proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) {\n    ref := _seq.FromRefNum(int32(refnum))\n    v := ref.Get().(*g_mb_test.GMBTest)\n    var _param_i g_mb_test.GMBInterface\n    _param_i_ref := _seq.FromRefNum(int32(param_i))\n    if _param_i_ref != nil {\n        if param_i < 0 { // go object\n            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)\n        } else { // foreign object\n            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)\n        }\n    }\n    v.GMBTest7(_param_i)\n}\n```\n\n_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface\n\nproxyg_mb_test_GMBInterface \n```\ntype proxyg_mb_test_GMBInterface _seq.Ref\n\nfunc (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 { return (*_seq.Ref)(p).Bind_IncNum() }\n\nfunc (p *proxyg_mb_test_GMBInterface) InterfaceTest() {\n    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))\n}\n```\n\nBind_proxy_refnum__()RefBind_IncNum(),\n```\nfunc init() {\n    _seq.FinalizeRef = func(ref *_seq.Ref) {\n        refnum := ref.Bind_Num\n        if refnum < 0 {\n            panic(fmt.Sprintf(not a foreign ref: %d, refnum))\n        }\n        C.go_seq_dec_ref(C.int32_t(refnum))\n    }\n    _seq.IncForeignRef = func(refnum int32) {\n        if refnum < 0 {\n            panic(fmt.Sprintf(\"not a foreign ref: %d\", refnum))\n        }\n        C.go_seq_inc_ref(C.int32_t(refnum))\n    }\n}\n```\nseqBind_IncNum()_seq.IncForeignRef()\nC.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),\n\n```\nvoid go_seq_dec_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker dec:refnum];\n  }\n}\n\nvoid go_seq_inc_ref(int32_t refnum) {\n  @autoreleasepool {\n    [tracker inc:refnum];\n  }\n}\n\n```\nseq_darwin.m\n\nFromRefNumGoRef\nGoRefGoRef \n\nInterfaceTest()\n```\nvoid cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) {\n    @autoreleasepool {\n        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);\n        [o interfaceTest];\n    }\n}\n```\n_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];\nOC\n\n****\nOCGoGoGoOC+11GoGoRef -1\nGoGoRefOCOCOCOC-1Go\n\ngo_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum\n\n## \n1. GoCOCOC\n2. GoOCint32(refnum)refnum>0OC<0Go\n3. GoOCrefnumGoRef structGoSeqRef class\n4. GoOC\n5. OCGorefnum\n6. OCGoGoCrefnumGoGo\n7. GoOCC.mrefnumOCOC\n8. OCGoGoSeqRefrefnumGo\n9. GoOCC.mGoRefOCrefnum.mOC\n10. GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1\n11. OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1\n12. GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1\n13. OCGoGoBind_IncNum()+1OCrefnumoc obj -1\n\n\n\n//\n\n## \n NSString  NSDataGo <> OC gomobile \n```\ntypedef struct nstring {\n  void *ptr;\n  int len;\n} nstring;\n\ntypedef struct nbyteslice {\n  void *ptr;\n  int len;\n} nbyteslice;\ntypedef int nint;\n```\nCstruct\n\n### String\n```\n// encodeString copies a Go string and returns it as a nstring.\nfunc encodeString(s string) C.nstring {\n    n := C.int(len(s))\n    if n == 0 {\n        return C.nstring{}\n    }\n    ptr := C.malloc(C.size_t(n))\n    if ptr == nil {\n        panic(\"encodeString: malloc failed\")\n    }\n    copy((*[1<<31 - 1]byte)(ptr)[:n], s)\n    return C.nstring{ptr: ptr, len: n}\n}\n\n// decodeString converts a nstring to a Go string. The\n// data in str is freed after use.\nfunc decodeString(str C.nstring) string {\n    if str.ptr == nil {\n        return \"\"\n    }\n    s := C.GoStringN((*C.char)(str.ptr), str.len)\n    C.free(str.ptr)\n    return s\n}\n```\n\nGo  string encodedecodecstringgo string*copy*\n\n```\nNSString *go_seq_to_objc_string(nstring str) {\n  if (str.len == 0) {  // empty string.\n    return @;\n  }\n  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr\n                                                  length:str.len\n                                                encoding:NSUTF8StringEncoding\n                                            freeWhenDone:YES];\n  return res;\n}\n\nnstring go_seq_from_objc_string(NSString *s) {\n  nstring res = {NULL, 0};\n  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];\n\n  if (len == 0) {\n    if (s.length > 0) {\n      LOG_INFO(@unable to encode an NSString into UTF-8);\n    }\n    return res;\n  }\n\n  char *buf = (char *)malloc(len);\n  if (buf == NULL) {\n    LOG_FATAL(@\"malloc failed\");\n  }\n  NSUInteger used;\n  [s getBytes:buf\n           maxLength:len\n          usedLength:&used\n            encoding:NSUTF8StringEncoding\n             options:0\n               range:NSMakeRange(0, [s length])\n      remainingRange:NULL];\n  res.ptr = buf;\n  res.len = used;\n  return res;\n}\n```\n\nOC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring*copy*\n\ncstring\n\n### Bytes\n```\n\n// fromSlice converts a slice to a nbyteslice.\n// If cpy is set, a malloced copy of the data is returned.\nfunc fromSlice(s []byte, cpy bool) C.nbyteslice {\n    if s == nil || len(s) == 0 {\n        return C.nbyteslice{}\n    }\n    ptr, n := unsafe.Pointer(&s[0]), C.int(len(s))\n    if cpy {\n        nptr := C.malloc(C.size_t(n))\n        if nptr == nil {\n            panic(\"fromSlice: malloc failed\")\n        }\n        copy((*[1<<31 - 1]byte)(nptr)[:n], (*[1<<31 - 1]byte)(ptr)[:n])\n        ptr = nptr\n    }\n    return C.nbyteslice{ptr: ptr, len: n}\n}\n\n// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is\n// set, the slice contains a copy of the data. If not, the generated Go code\n// calls releaseByteSlice after use.\nfunc toSlice(s C.nbyteslice, cpy bool) []byte {\n    if s.ptr == nil || s.len == 0 {\n        return nil\n    }\n    var b []byte\n    if cpy {\n        b = C.GoBytes(s.ptr, C.int(s.len))\n        C.free(s.ptr)\n    } else {\n        b = (*[1<<31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]\n    }\n    return b\n}\n```\n\nGo  nbyteslice fromSlicetoSlicenbyteslicego slice\n\nOC -> Go OCcopy == trueGonbyteslice\nGo -> OC  (copy go->OC copy=true)\n\n```\nNSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) {\n  if (s.ptr == NULL) {\n    return NULL;\n  }\n  BOOL freeWhenDone = copy ? YES : NO;\n  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];\n}\n\nnbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) {\n  struct nbyteslice res = {NULL, 0};\n  int sz = data.length;\n  if (sz == 0) {\n    return res;\n  }\n  void *ptr;\n  // If the argument was not a NSMutableData, copy the data so that\n  // the NSData is not changed from Go. The corresponding free is called\n  // by releaseByteSlice.\n  if (copy || ![data isKindOfClass:[NSMutableData class]]) {\n    void *arr_copy = malloc(sz);\n    if (arr_copy == NULL) {\n      LOG_FATAL(@\"malloc failed\");\n    }\n    memcpy(arr_copy, [data bytes], sz);\n    ptr = arr_copy;\n  } else {\n    ptr = (void *)[data bytes];\n  }\n  res.ptr = ptr;\n  res.len = sz;\n  return res;\n}\n\n```\n\nOC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData\n\nOC -> Go (NSMutableData && !copy OC->Go copy = falseNSDataNSMutableData)*bytes*Goslicebytes\nGo -> OC  OCGobytesOCNSDatanbyteslice.\n\n*copycopyNSDatafalse*\n\n---\n\n2020-3-18 \n[ Dart  Objective-C ](http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/)\n\nDartOCGoMobile...","slug":"14.gomobile-bind","published":1,"updated":"2020-08-29T14:42:58.496Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l0000b93c910qu9891","content":"<blockquote>\n<p>Golanggomobile bind -target&#x3D;ios xxx framework</p>\n</blockquote>\n<p>GolangOCGoOCGolang</p>\n<p>Gobind</p>\n<span id=\"more\"></span>\n\n<p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package g_mb_test</span><br><span class=\"line\"></span><br><span class=\"line\">type GMBInterface interface &#123;</span><br><span class=\"line\">\tInterfaceTest()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type GMBTest struct &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestOne(value int32) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestSecond(data []byte, str string) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest3() string &#123;</span><br><span class=\"line\">    return </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest4() []byte &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest5() GMBInterface &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest6() *GMBTest &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest7(i GMBInterface) &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>Go OC</li>\n<li>OCGolang</li>\n<li>OCGolangNSData -&gt; []byte, NSString -&gt; string, interface(OC) -&gt; interface</li>\n<li>OCGolang GolangOC</li>\n<li>Golang[]byte -&gt; NSData, string -&gt; NSString, interface -&gt; interface(OC)?</li>\n<li>Golang </li>\n</ol>\n<p>GolangCGolangC(cgo)OCCOCCOCGolang C</p>\n<p><code>gomobile bind -target=ios/amd64 -work Caio/g_mb_test</code></p>\n<p>go-buildxxxsrcgomobile<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (instancetype)init &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123;</span><br><span class=\"line\">        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>new_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego</p>\n<p>iOS frameworknew_g_mb_test_GMBTest()frameworkGo</p>\n<p> new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GoSeqRef *go_seq_from_refnum(int32_t refnum) &#123;</span><br><span class=\"line\">  if (refnum == NULL_REFNUM) &#123;</span><br><span class=\"line\">    return nil;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  if (IS_FROM_GO(refnum)) &#123;</span><br><span class=\"line\">    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>GoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj</p>\n<p>int32<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*go_g_mb_testmain.go*</span><br><span class=\"line\">//export new_g_mb_test_GMBTest</span><br><span class=\"line\">func new_g_mb_test_GMBTest() C.int32_t &#123;</span><br><span class=\"line\">    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org&#x2F;x&#x2F;mobile&#x2F;bind&#x2F;seq&#x2F;ref.go bindgo struct</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*golang.org/x/mobile/bind/seq/ref.go*</span><br><span class=\"line\">// ToRefNum increments the reference count for an object and</span><br><span class=\"line\">// returns its refnum.</span><br><span class=\"line\">func ToRefNum(obj interface&#123;&#125;) int32 &#123;</span><br><span class=\"line\">    // We dont track foreign objects, so if obj is a proxy</span><br><span class=\"line\">    // return its refnum.</span><br><span class=\"line\">    if r, ok := obj.(proxy); ok &#123;</span><br><span class=\"line\">        refnum := r.Bind_proxy_refnum__()</span><br><span class=\"line\">        if refnum &lt;= 0 &#123;</span><br><span class=\"line\">            panic(fmt.Errorf(&quot;seq: proxy contained invalid Go refnum: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return refnum</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    num := refs.refs[obj]</span><br><span class=\"line\">    if num != 0 &#123;</span><br><span class=\"line\">        s := refs.objs[num]</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;s.obj, s.cnt + 1&#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        num = refs.next</span><br><span class=\"line\">        refs.next--</span><br><span class=\"line\">        if refs.next &gt; 0 &#123;</span><br><span class=\"line\">            panic(refs.next underflow)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        refs.refs[obj] = num</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;obj, 1&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">    return int32(num)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>proxyrefs</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// refs stores Go objects that have been passed to another language.</span><br><span class=\"line\">var refs struct &#123;</span><br><span class=\"line\">    sync.Mutex</span><br><span class=\"line\">    next int32 // next reference number to use for Go object, always negative</span><br><span class=\"line\">    refs map[interface&#123;&#125;]int32</span><br><span class=\"line\">    objs map[int32]countedObj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>refsGolang</p>\n<p>maprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum</p>\n<p>refobjnumnext-1refnummap</p>\n<p><strong></strong></p>\n<ol>\n<li>GoGo</li>\n<li>Gorefnum</li>\n<li>+1</li>\n<li>Gorefnum</li>\n</ol>\n<p><em></em><br> Go oc :</p>\n<p>OCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo</p>\n<h4 id=\"OC\"><a href=\"#OC\" class=\"headerlink\" title=\"OC\"></a>OC</h4><p>Golang gmbTestOne </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTestOne:(int32_t)value &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _value = (int32_t)value;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>go_seq_go_to_refnum()Seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (int32_t)incNum &#123;</span><br><span class=\"line\">  IncGoRef(_refnum);</span><br><span class=\"line\">  return _refnum;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_refnumIncGoRef(_refnum);<br>ref.goGo<br><em></em>OC ARCint32_t refnum int</p>\n<p>proxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue</p>\n<p> refnumGoGo<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTestOne</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    _param_value := int32(param_value)</span><br><span class=\"line\">    v.GMBTestOne(_param_value)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// FromRefNum returns the Ref for a refnum. If the refnum specifies a</span><br><span class=\"line\">// foreign object, a finalizer is set to track its lifetime.</span><br><span class=\"line\">func FromRefNum(num int32) *Ref &#123;</span><br><span class=\"line\">    if num == NullRefNum &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ref := &amp;Ref&#123;num&#125;</span><br><span class=\"line\">    if num &gt; 0 &#123;</span><br><span class=\"line\">        // This is a foreign object reference.</span><br><span class=\"line\">        // Track its lifetime with a finalizer.</span><br><span class=\"line\">        runtime.SetFinalizer(ref, FinalizeRef)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    return ref</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>OCGoRefrefnum<br>num &gt; 0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Get returns the underlying object.</span><br><span class=\"line\">func (r *Ref) Get() interface&#123;&#125; &#123;</span><br><span class=\"line\">    refnum := r.Bind_Num</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    o, ok := refs.objs[refnum]</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\">    if !ok &#123;</span><br><span class=\"line\">        panic(fmt.Sprintf(unknown ref %d, refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // This is a Go reference and its refnum was incremented</span><br><span class=\"line\">    // before crossing the language barrier.</span><br><span class=\"line\">    Delete(refnum)</span><br><span class=\"line\">    return o.obj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Delete-10map</p>\n<p><em></em>GolangGolang v :&#x3D; ref.Get().(*g_mb_test.GMBTest) GolangGolang</p>\n<p>Goint</p>\n<p><strong></strong><br>OCGolangOCself.ref  refnumGoGorefnumGolang</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>GolangGoGoGoGoOCNSDataNSString</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (G_mb_testGMBTest*)gmbTest6 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);</span><br><span class=\"line\">    G_mb_testGMBTest* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest6()intGolang</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest6</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    res_0 := v.GMBTest6()</span><br><span class=\"line\">    var _res_0 C.int32_t = _seq.NullRefNum</span><br><span class=\"line\">    if res_0 != nil &#123;</span><br><span class=\"line\">        _res_0 = C.int32_t(_seq.ToRefNum(res_0))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _res_0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>res_0nil_seq.NullRefNum &#x3D; 41null<br>OCgo_seq_from_refnum()41</p>\n<p><strong></strong><br>GorefnumOCGoSeqRefGo</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (id&lt;G_mb_testGMBInterface&gt;)gmbTest5 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);</span><br><span class=\"line\">    G_mb_testGMBInterface* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@implementation G_mb_testGMBInterface &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (instancetype)initWithRef:(id)ref &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123; __ref = ref; &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (void)interfaceTest &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<p>g_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo</p>\n<p><strong></strong><br>GoOCrefnumGoSeqRefGoSeqRefGo</p>\n<p>GoNSDataNSStringOCGo</p>\n<h4 id=\"OCGo\"><a href=\"#OCGo\" class=\"headerlink\" title=\"OCGo\"></a>OCGo</h4><p></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTest7:(id&lt;G_mb_testGMBInterface&gt;)i &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _i;</span><br><span class=\"line\">    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) &#123;</span><br><span class=\"line\">        id&lt;goSeqRefInterface&gt; i_proxy = (id&lt;goSeqRefInterface&gt;)(i);</span><br><span class=\"line\">        _i = go_seq_go_to_refnum(i_proxy._ref);</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        _i = go_seq_to_refnum(i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>goSeqRefInterfaceGoGoSeqRef)<br>Go<br>GoOC newgo_seq_to_refnum()</p>\n<p>tracker<br>OCGorefsOCGo<br>GoOCGoGorefnumOC</p>\n<p>proxyg_mb_test_GMBTest_GMBTest7()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest7</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    var _param_i g_mb_test.GMBInterface</span><br><span class=\"line\">    _param_i_ref := _seq.FromRefNum(int32(param_i))</span><br><span class=\"line\">    if _param_i_ref != nil &#123;</span><br><span class=\"line\">        if param_i &lt; 0 &#123; // go object</span><br><span class=\"line\">            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)</span><br><span class=\"line\">        &#125; else &#123; // foreign object</span><br><span class=\"line\">            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v.GMBTest7(_param_i)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface</p>\n<p>proxyg_mb_test_GMBInterface </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type proxyg_mb_test_GMBInterface _seq.Ref</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 &#123; return (*_seq.Ref)(p).Bind_IncNum() &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) InterfaceTest() &#123;</span><br><span class=\"line\">    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br>Bind_proxy_refnum__()RefBind_IncNum(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func init() &#123;</span><br><span class=\"line\">    _seq.FinalizeRef = func(ref *_seq.Ref) &#123;</span><br><span class=\"line\">        refnum := ref.Bind_Num</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(not a foreign ref: %d, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_dec_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    _seq.IncForeignRef = func(refnum int32) &#123;</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(&quot;not a foreign ref: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_inc_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>seqBind_IncNum()_seq.IncForeignRef()<br>C.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void go_seq_dec_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker dec:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void go_seq_inc_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker inc:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>seq_darwin.m</p>\n<p>FromRefNumGoRef<br>GoRefGoRef </p>\n<p>InterfaceTest()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) &#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);</span><br><span class=\"line\">        [o interfaceTest];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];<br>OC</p>\n<p><strong></strong><br>OCGoGoGoOC+11GoGoRef -1<br>GoGoRefOCOCOCOC-1Go</p>\n<p>go_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>GoCOCOC</li>\n<li>GoOCint32(refnum)refnum&gt;0OC&lt;0Go</li>\n<li>GoOCrefnumGoRef structGoSeqRef class</li>\n<li>GoOC</li>\n<li>OCGorefnum</li>\n<li>OCGoGoCrefnumGoGo</li>\n<li>GoOCC.mrefnumOCOC</li>\n<li>OCGoGoSeqRefrefnumGo</li>\n<li>GoOCC.mGoRefOCrefnum.mOC</li>\n<li>GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1</li>\n<li>OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1</li>\n<li>GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1</li>\n<li>OCGoGoBind_IncNum()+1OCrefnumoc obj -1</li>\n</ol>\n<p></p>\n<p>&#x2F;&#x2F;</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> NSString  NSDataGo &lt;&gt; OC gomobile </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct nstring &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nstring;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct nbyteslice &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nbyteslice;</span><br><span class=\"line\">typedef int nint;</span><br></pre></td></tr></table></figure>\n<p>Cstruct</p>\n<h3 id=\"String\"><a href=\"#String\" class=\"headerlink\" title=\"String\"></a>String</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// encodeString copies a Go string and returns it as a nstring.</span><br><span class=\"line\">func encodeString(s string) C.nstring &#123;</span><br><span class=\"line\">    n := C.int(len(s))</span><br><span class=\"line\">    if n == 0 &#123;</span><br><span class=\"line\">        return C.nstring&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">    if ptr == nil &#123;</span><br><span class=\"line\">        panic(&quot;encodeString: malloc failed&quot;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    copy((*[1&lt;&lt;31 - 1]byte)(ptr)[:n], s)</span><br><span class=\"line\">    return C.nstring&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// decodeString converts a nstring to a Go string. The</span><br><span class=\"line\">// data in str is freed after use.</span><br><span class=\"line\">func decodeString(str C.nstring) string &#123;</span><br><span class=\"line\">    if str.ptr == nil &#123;</span><br><span class=\"line\">        return &quot;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    s := C.GoStringN((*C.char)(str.ptr), str.len)</span><br><span class=\"line\">    C.free(str.ptr)</span><br><span class=\"line\">    return s</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  string encodedecodecstringgo string<em>copy</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSString *go_seq_to_objc_string(nstring str) &#123;</span><br><span class=\"line\">  if (str.len == 0) &#123;  // empty string.</span><br><span class=\"line\">    return @;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr</span><br><span class=\"line\">                                                  length:str.len</span><br><span class=\"line\">                                                encoding:NSUTF8StringEncoding</span><br><span class=\"line\">                                            freeWhenDone:YES];</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nstring go_seq_from_objc_string(NSString *s) &#123;</span><br><span class=\"line\">  nstring res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];</span><br><span class=\"line\"></span><br><span class=\"line\">  if (len == 0) &#123;</span><br><span class=\"line\">    if (s.length &gt; 0) &#123;</span><br><span class=\"line\">      LOG_INFO(@unable to encode an NSString into UTF-8);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  char *buf = (char *)malloc(len);</span><br><span class=\"line\">  if (buf == NULL) &#123;</span><br><span class=\"line\">    LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSUInteger used;</span><br><span class=\"line\">  [s getBytes:buf</span><br><span class=\"line\">           maxLength:len</span><br><span class=\"line\">          usedLength:&amp;used</span><br><span class=\"line\">            encoding:NSUTF8StringEncoding</span><br><span class=\"line\">             options:0</span><br><span class=\"line\">               range:NSMakeRange(0, [s length])</span><br><span class=\"line\">      remainingRange:NULL];</span><br><span class=\"line\">  res.ptr = buf;</span><br><span class=\"line\">  res.len = used;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>OC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring<em>copy</em></p>\n<p>cstring</p>\n<h3 id=\"Bytes\"><a href=\"#Bytes\" class=\"headerlink\" title=\"Bytes\"></a>Bytes</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">// fromSlice converts a slice to a nbyteslice.</span><br><span class=\"line\">// If cpy is set, a malloced copy of the data is returned.</span><br><span class=\"line\">func fromSlice(s []byte, cpy bool) C.nbyteslice &#123;</span><br><span class=\"line\">    if s == nil || len(s) == 0 &#123;</span><br><span class=\"line\">        return C.nbyteslice&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr, n := unsafe.Pointer(&amp;s[0]), C.int(len(s))</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        nptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">        if nptr == nil &#123;</span><br><span class=\"line\">            panic(&quot;fromSlice: malloc failed&quot;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        copy((*[1&lt;&lt;31 - 1]byte)(nptr)[:n], (*[1&lt;&lt;31 - 1]byte)(ptr)[:n])</span><br><span class=\"line\">        ptr = nptr</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return C.nbyteslice&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is</span><br><span class=\"line\">// set, the slice contains a copy of the data. If not, the generated Go code</span><br><span class=\"line\">// calls releaseByteSlice after use.</span><br><span class=\"line\">func toSlice(s C.nbyteslice, cpy bool) []byte &#123;</span><br><span class=\"line\">    if s.ptr == nil || s.len == 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var b []byte</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        b = C.GoBytes(s.ptr, C.int(s.len))</span><br><span class=\"line\">        C.free(s.ptr)</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        b = (*[1&lt;&lt;31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return b</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  nbyteslice fromSlicetoSlicenbyteslicego slice</p>\n<p>OC -&gt; Go OCcopy &#x3D;&#x3D; trueGonbyteslice<br>Go -&gt; OC  (copy go-&gt;OC copy&#x3D;true)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) &#123;</span><br><span class=\"line\">  if (s.ptr == NULL) &#123;</span><br><span class=\"line\">    return NULL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  BOOL freeWhenDone = copy ? YES : NO;</span><br><span class=\"line\">  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) &#123;</span><br><span class=\"line\">  struct nbyteslice res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int sz = data.length;</span><br><span class=\"line\">  if (sz == 0) &#123;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  // If the argument was not a NSMutableData, copy the data so that</span><br><span class=\"line\">  // the NSData is not changed from Go. The corresponding free is called</span><br><span class=\"line\">  // by releaseByteSlice.</span><br><span class=\"line\">  if (copy || ![data isKindOfClass:[NSMutableData class]]) &#123;</span><br><span class=\"line\">    void *arr_copy = malloc(sz);</span><br><span class=\"line\">    if (arr_copy == NULL) &#123;</span><br><span class=\"line\">      LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    memcpy(arr_copy, [data bytes], sz);</span><br><span class=\"line\">    ptr = arr_copy;</span><br><span class=\"line\">  &#125; else &#123;</span><br><span class=\"line\">    ptr = (void *)[data bytes];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  res.ptr = ptr;</span><br><span class=\"line\">  res.len = sz;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>OC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData</p>\n<p>OC -&gt; Go (NSMutableData &amp;&amp; !copy OC-&gt;Go copy &#x3D; falseNSDataNSMutableData)<em>bytes</em>Goslicebytes<br>Go -&gt; OC  OCGobytesOCNSDatanbyteslice.</p>\n<p><em>copycopyNSDatafalse</em></p>\n<hr>\n<p>2020-3-18 <br><a href=\"http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/\"> Dart  Objective-C </a></p>\n<p>DartOCGoMobile</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Golanggomobile bind -target&#x3D;ios xxx framework</p>\n</blockquote>\n<p>GolangOCGoOCGolang</p>\n<p>Gobind</p>","more":"<p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package g_mb_test</span><br><span class=\"line\"></span><br><span class=\"line\">type GMBInterface interface &#123;</span><br><span class=\"line\">\tInterfaceTest()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">type GMBTest struct &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestOne(value int32) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTestSecond(data []byte, str string) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest3() string &#123;</span><br><span class=\"line\">    return </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest4() []byte &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest5() GMBInterface &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest6() *GMBTest &#123;</span><br><span class=\"line\">    return nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (t *GMBTest) GMBTest7(i GMBInterface) &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>Go OC</li>\n<li>OCGolang</li>\n<li>OCGolangNSData -&gt; []byte, NSString -&gt; string, interface(OC) -&gt; interface</li>\n<li>OCGolang GolangOC</li>\n<li>Golang[]byte -&gt; NSData, string -&gt; NSString, interface -&gt; interface(OC)?</li>\n<li>Golang </li>\n</ol>\n<p>GolangCGolangC(cgo)OCCOCCOCGolang C</p>\n<p><code>gomobile bind -target=ios/amd64 -work Caio/g_mb_test</code></p>\n<p>go-buildxxxsrcgomobile<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/03/d4bb5b927cdeb09f7ba32e3925bfb1c4.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (instancetype)init &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123;</span><br><span class=\"line\">        __ref = go_seq_from_refnum(new_g_mb_test_GMBTest());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>new_g_mb_test_GMBTest  gog_mb_test-amd64.hsrcgo_g_mb_testmain.gonew_g_mb_test_GMBTest()gogomobilego</p>\n<p>iOS frameworknew_g_mb_test_GMBTest()frameworkGo</p>\n<p> new_g_mb_test_GMBTest() int32go_seq_from_refnum()seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GoSeqRef *go_seq_from_refnum(int32_t refnum) &#123;</span><br><span class=\"line\">  if (refnum == NULL_REFNUM) &#123;</span><br><span class=\"line\">    return nil;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  if (IS_FROM_GO(refnum)) &#123;</span><br><span class=\"line\">    return [[GoSeqRef alloc] initWithRefnum:refnum obj:NULL];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  return [[GoSeqRef alloc] initWithRefnum:refnum obj:go_seq_objc_from_refnum(refnum)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>GoSeqRefIS_FROM_GOrefnumnew_g_mb_test_GMBTest()GoGoSeqRefobjNULLGogo_seq_objc_from_refnum()refnumobj</p>\n<p>int32<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*go_g_mb_testmain.go*</span><br><span class=\"line\">//export new_g_mb_test_GMBTest</span><br><span class=\"line\">func new_g_mb_test_GMBTest() C.int32_t &#123;</span><br><span class=\"line\">    return C.int32_t(_seq.ToRefNum(new(g_mb_test.GMBTest)))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> new_g_mb_test_GMBTest() int32int32_seq.ToRefNum()golang.org&#x2F;x&#x2F;mobile&#x2F;bind&#x2F;seq&#x2F;ref.go bindgo struct</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*golang.org/x/mobile/bind/seq/ref.go*</span><br><span class=\"line\">// ToRefNum increments the reference count for an object and</span><br><span class=\"line\">// returns its refnum.</span><br><span class=\"line\">func ToRefNum(obj interface&#123;&#125;) int32 &#123;</span><br><span class=\"line\">    // We dont track foreign objects, so if obj is a proxy</span><br><span class=\"line\">    // return its refnum.</span><br><span class=\"line\">    if r, ok := obj.(proxy); ok &#123;</span><br><span class=\"line\">        refnum := r.Bind_proxy_refnum__()</span><br><span class=\"line\">        if refnum &lt;= 0 &#123;</span><br><span class=\"line\">            panic(fmt.Errorf(&quot;seq: proxy contained invalid Go refnum: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return refnum</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    num := refs.refs[obj]</span><br><span class=\"line\">    if num != 0 &#123;</span><br><span class=\"line\">        s := refs.objs[num]</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;s.obj, s.cnt + 1&#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        num = refs.next</span><br><span class=\"line\">        refs.next--</span><br><span class=\"line\">        if refs.next &gt; 0 &#123;</span><br><span class=\"line\">            panic(refs.next underflow)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        refs.refs[obj] = num</span><br><span class=\"line\">        refs.objs[num] = countedObj&#123;obj, 1&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\"></span><br><span class=\"line\">    return int32(num)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>proxyrefs</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// refs stores Go objects that have been passed to another language.</span><br><span class=\"line\">var refs struct &#123;</span><br><span class=\"line\">    sync.Mutex</span><br><span class=\"line\">    next int32 // next reference number to use for Go object, always negative</span><br><span class=\"line\">    refs map[interface&#123;&#125;]int32</span><br><span class=\"line\">    objs map[int32]countedObj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>refsGolang</p>\n<p>maprefsobjsrefskeyvaluerefnumobjskeyrefnumvalueGonextnextGorefnum</p>\n<p>refobjnumnext-1refnummap</p>\n<p><strong></strong></p>\n<ol>\n<li>GoGo</li>\n<li>Gorefnum</li>\n<li>+1</li>\n<li>Gorefnum</li>\n</ol>\n<p><em></em><br> Go oc :</p>\n<p>OCGoSeqRefGoSeqRef  refnumrefnumGorefsobjsrefsGo</p>\n<h4 id=\"OC\"><a href=\"#OC\" class=\"headerlink\" title=\"OC\"></a>OC</h4><p>Golang gmbTestOne </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTestOne:(int32_t)value &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _value = (int32_t)value;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTestOne(refnum, _value);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>go_seq_go_to_refnum()Seq_darwin.m</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (int32_t)incNum &#123;</span><br><span class=\"line\">  IncGoRef(_refnum);</span><br><span class=\"line\">  return _refnum;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_refnumIncGoRef(_refnum);<br>ref.goGo<br><em></em>OC ARCint32_t refnum int</p>\n<p>proxyg_mb_test_GMBTest_GMBTestOne() frameworkrefnumvalue</p>\n<p> refnumGoGo<br><em>Go</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTestOne</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTestOne(refnum C.int32_t, param_value C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    _param_value := int32(param_value)</span><br><span class=\"line\">    v.GMBTestOne(_param_value)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// FromRefNum returns the Ref for a refnum. If the refnum specifies a</span><br><span class=\"line\">// foreign object, a finalizer is set to track its lifetime.</span><br><span class=\"line\">func FromRefNum(num int32) *Ref &#123;</span><br><span class=\"line\">    if num == NullRefNum &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ref := &amp;Ref&#123;num&#125;</span><br><span class=\"line\">    if num &gt; 0 &#123;</span><br><span class=\"line\">        // This is a foreign object reference.</span><br><span class=\"line\">        // Track its lifetime with a finalizer.</span><br><span class=\"line\">        runtime.SetFinalizer(ref, FinalizeRef)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    return ref</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>OCGoRefrefnum<br>num &gt; 0</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Get returns the underlying object.</span><br><span class=\"line\">func (r *Ref) Get() interface&#123;&#125; &#123;</span><br><span class=\"line\">    refnum := r.Bind_Num</span><br><span class=\"line\">    refs.Lock()</span><br><span class=\"line\">    o, ok := refs.objs[refnum]</span><br><span class=\"line\">    refs.Unlock()</span><br><span class=\"line\">    if !ok &#123;</span><br><span class=\"line\">        panic(fmt.Sprintf(unknown ref %d, refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    // This is a Go reference and its refnum was incremented</span><br><span class=\"line\">    // before crossing the language barrier.</span><br><span class=\"line\">    Delete(refnum)</span><br><span class=\"line\">    return o.obj</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Delete-10map</p>\n<p><em></em>GolangGolang v :&#x3D; ref.Get().(*g_mb_test.GMBTest) GolangGolang</p>\n<p>Goint</p>\n<p><strong></strong><br>OCGolangOCself.ref  refnumGoGorefnumGolang</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>GolangGoGoGoGoOCNSDataNSString</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (G_mb_testGMBTest*)gmbTest6 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest6(refnum);</span><br><span class=\"line\">    G_mb_testGMBTest* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBTest alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest6()intGolang</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest6</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest6(refnum C.int32_t) C.int32_t &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    res_0 := v.GMBTest6()</span><br><span class=\"line\">    var _res_0 C.int32_t = _seq.NullRefNum</span><br><span class=\"line\">    if res_0 != nil &#123;</span><br><span class=\"line\">        _res_0 = C.int32_t(_seq.ToRefNum(res_0))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _res_0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>res_0nil_seq.NullRefNum &#x3D; 41null<br>OCgo_seq_from_refnum()41</p>\n<p><strong></strong><br>GorefnumOCGoSeqRefGo</p>\n<h4 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h4><p>Go</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (id&lt;G_mb_testGMBInterface&gt;)gmbTest5 &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t r0 = proxyg_mb_test_GMBTest_GMBTest5(refnum);</span><br><span class=\"line\">    G_mb_testGMBInterface* _ret0_ = nil;</span><br><span class=\"line\">    GoSeqRef* _ret0__ref = go_seq_from_refnum(r0);</span><br><span class=\"line\">    if (_ret0__ref != NULL) &#123;</span><br><span class=\"line\">        _ret0_ = _ret0__ref.obj;</span><br><span class=\"line\">        if (_ret0_ == nil) &#123;</span><br><span class=\"line\">            _ret0_ = [[G_mb_testGMBInterface alloc] initWithRef:_ret0__ref];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return _ret0_;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>proxyg_mb_test_GMBTest_GMBTest5()proxyg_mb_test_GMBTest_GMBTest6()gorefnum</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@implementation G_mb_testGMBInterface &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (instancetype)initWithRef:(id)ref &#123;</span><br><span class=\"line\">    self = [super init];</span><br><span class=\"line\">    if (self) &#123; __ref = ref; &#125;</span><br><span class=\"line\">    return self;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">- (void)interfaceTest &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    proxyg_mb_test_GMBInterface_InterfaceTest(refnum);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<p>g_mb_test_darwin.mG_mb_testGMBInterfaceG_mb_testGMBInterfaceGOrefnumproxyg_mb_test_GMBInterface_InterfaceTest()refnumGoGo</p>\n<p><strong></strong><br>GoOCrefnumGoSeqRefGoSeqRefGo</p>\n<p>GoNSDataNSStringOCGo</p>\n<h4 id=\"OCGo\"><a href=\"#OCGo\" class=\"headerlink\" title=\"OCGo\"></a>OCGo</h4><p></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- (void)gmbTest7:(id&lt;G_mb_testGMBInterface&gt;)i &#123;</span><br><span class=\"line\">    int32_t refnum = go_seq_go_to_refnum(self._ref);</span><br><span class=\"line\">    int32_t _i;</span><br><span class=\"line\">    if ([i conformsToProtocol:@protocol(goSeqRefInterface)]) &#123;</span><br><span class=\"line\">        id&lt;goSeqRefInterface&gt; i_proxy = (id&lt;goSeqRefInterface&gt;)(i);</span><br><span class=\"line\">        _i = go_seq_go_to_refnum(i_proxy._ref);</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        _i = go_seq_to_refnum(i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    proxyg_mb_test_GMBTest_GMBTest7(refnum, _i);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>goSeqRefInterfaceGoGoSeqRef)<br>Go<br>GoOC newgo_seq_to_refnum()</p>\n<p>tracker<br>OCGorefsOCGo<br>GoOCGoGorefnumOC</p>\n<p>proxyg_mb_test_GMBTest_GMBTest7()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//export proxyg_mb_test_GMBTest_GMBTest7</span><br><span class=\"line\">func proxyg_mb_test_GMBTest_GMBTest7(refnum C.int32_t, param_i C.int32_t) &#123;</span><br><span class=\"line\">    ref := _seq.FromRefNum(int32(refnum))</span><br><span class=\"line\">    v := ref.Get().(*g_mb_test.GMBTest)</span><br><span class=\"line\">    var _param_i g_mb_test.GMBInterface</span><br><span class=\"line\">    _param_i_ref := _seq.FromRefNum(int32(param_i))</span><br><span class=\"line\">    if _param_i_ref != nil &#123;</span><br><span class=\"line\">        if param_i &lt; 0 &#123; // go object</span><br><span class=\"line\">            _param_i = _param_i_ref.Get().(g_mb_test.GMBInterface)</span><br><span class=\"line\">        &#125; else &#123; // foreign object</span><br><span class=\"line\">            _param_i = (*proxyg_mb_test_GMBInterface)(_param_i_ref)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    v.GMBTest7(_param_i)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>_seq.FromRefNumnull41RefGo_param_i_refproxyg_mb_test_GMBInterface</p>\n<p>proxyg_mb_test_GMBInterface </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type proxyg_mb_test_GMBInterface _seq.Ref</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) Bind_proxy_refnum__() int32 &#123; return (*_seq.Ref)(p).Bind_IncNum() &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func (p *proxyg_mb_test_GMBInterface) InterfaceTest() &#123;</span><br><span class=\"line\">    C.cproxyg_mb_test_GMBInterface_InterfaceTest(C.int32_t(p.Bind_proxy_refnum__()))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><br>Bind_proxy_refnum__()RefBind_IncNum(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func init() &#123;</span><br><span class=\"line\">    _seq.FinalizeRef = func(ref *_seq.Ref) &#123;</span><br><span class=\"line\">        refnum := ref.Bind_Num</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(not a foreign ref: %d, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_dec_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    _seq.IncForeignRef = func(refnum int32) &#123;</span><br><span class=\"line\">        if refnum &lt; 0 &#123;</span><br><span class=\"line\">            panic(fmt.Sprintf(&quot;not a foreign ref: %d&quot;, refnum))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        C.go_seq_inc_ref(C.int32_t(refnum))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>seqBind_IncNum()_seq.IncForeignRef()<br>C.cproxyg_mb_test_GMBInterface_InterfaceTest()Cgo_seq_inc_ref()C.go_seq_dec_ref(),</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void go_seq_dec_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker dec:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">void go_seq_inc_ref(int32_t refnum) &#123;</span><br><span class=\"line\">  @autoreleasepool &#123;</span><br><span class=\"line\">    [tracker inc:refnum];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>seq_darwin.m</p>\n<p>FromRefNumGoRef<br>GoRefGoRef </p>\n<p>InterfaceTest()</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void cproxyg_mb_test_GMBInterface_InterfaceTest(int32_t refnum) &#123;</span><br><span class=\"line\">    @autoreleasepool &#123;</span><br><span class=\"line\">        G_mb_testGMBInterface* o = go_seq_objc_from_refnum(refnum);</span><br><span class=\"line\">        [o interfaceTest];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>_seq.FinalizeRefocOCgo_seq_objc_from_refnumoc[tracker dec:refnum];<br>OC</p>\n<p><strong></strong><br>OCGoGoGoOC+11GoGoRef -1<br>GoGoRefOCOCOCOC-1Go</p>\n<p>go_seq_from_refnum()ToRefNum()OCGoGoOCOCGoGoOCGoOCOCGoOCGoSeqRefGoGoRefOCGoSeqRefobjGorefnum</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>GoCOCOC</li>\n<li>GoOCint32(refnum)refnum&gt;0OC&lt;0Go</li>\n<li>GoOCrefnumGoRef structGoSeqRef class</li>\n<li>GoOC</li>\n<li>OCGorefnum</li>\n<li>OCGoGoCrefnumGoGo</li>\n<li>GoOCC.mrefnumOCOC</li>\n<li>OCGoGoSeqRefrefnumGo</li>\n<li>GoOCC.mGoRefOCrefnum.mOC</li>\n<li>GoOCGonew_seq.ToRefNum()1OCGoSeqRefdeallocDestroyRef()-1</li>\n<li>OCGoOCGoassignRefnumAndIncRefcount:1GoGoRefgo_seq_dec_ref()-1</li>\n<li>GoOCOCgo_seq_go_to_refnum()+1Gorefnumgo obj-1</li>\n<li>OCGoGoBind_IncNum()+1OCrefnumoc obj -1</li>\n</ol>\n<p></p>\n<p>&#x2F;&#x2F;</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p> NSString  NSDataGo &lt;&gt; OC gomobile </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct nstring &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nstring;</span><br><span class=\"line\"></span><br><span class=\"line\">typedef struct nbyteslice &#123;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  int len;</span><br><span class=\"line\">&#125; nbyteslice;</span><br><span class=\"line\">typedef int nint;</span><br></pre></td></tr></table></figure>\n<p>Cstruct</p>\n<h3 id=\"String\"><a href=\"#String\" class=\"headerlink\" title=\"String\"></a>String</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// encodeString copies a Go string and returns it as a nstring.</span><br><span class=\"line\">func encodeString(s string) C.nstring &#123;</span><br><span class=\"line\">    n := C.int(len(s))</span><br><span class=\"line\">    if n == 0 &#123;</span><br><span class=\"line\">        return C.nstring&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">    if ptr == nil &#123;</span><br><span class=\"line\">        panic(&quot;encodeString: malloc failed&quot;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    copy((*[1&lt;&lt;31 - 1]byte)(ptr)[:n], s)</span><br><span class=\"line\">    return C.nstring&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// decodeString converts a nstring to a Go string. The</span><br><span class=\"line\">// data in str is freed after use.</span><br><span class=\"line\">func decodeString(str C.nstring) string &#123;</span><br><span class=\"line\">    if str.ptr == nil &#123;</span><br><span class=\"line\">        return &quot;&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    s := C.GoStringN((*C.char)(str.ptr), str.len)</span><br><span class=\"line\">    C.free(str.ptr)</span><br><span class=\"line\">    return s</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  string encodedecodecstringgo string<em>copy</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSString *go_seq_to_objc_string(nstring str) &#123;</span><br><span class=\"line\">  if (str.len == 0) &#123;  // empty string.</span><br><span class=\"line\">    return @;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSString * res = [[NSString alloc] initWithBytesNoCopy:str.ptr</span><br><span class=\"line\">                                                  length:str.len</span><br><span class=\"line\">                                                encoding:NSUTF8StringEncoding</span><br><span class=\"line\">                                            freeWhenDone:YES];</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nstring go_seq_from_objc_string(NSString *s) &#123;</span><br><span class=\"line\">  nstring res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int len = [s lengthOfBytesUsingEncoding:NSUTF8StringEncoding];</span><br><span class=\"line\"></span><br><span class=\"line\">  if (len == 0) &#123;</span><br><span class=\"line\">    if (s.length &gt; 0) &#123;</span><br><span class=\"line\">      LOG_INFO(@unable to encode an NSString into UTF-8);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  char *buf = (char *)malloc(len);</span><br><span class=\"line\">  if (buf == NULL) &#123;</span><br><span class=\"line\">    LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  NSUInteger used;</span><br><span class=\"line\">  [s getBytes:buf</span><br><span class=\"line\">           maxLength:len</span><br><span class=\"line\">          usedLength:&amp;used</span><br><span class=\"line\">            encoding:NSUTF8StringEncoding</span><br><span class=\"line\">             options:0</span><br><span class=\"line\">               range:NSMakeRange(0, [s length])</span><br><span class=\"line\">      remainingRange:NULL];</span><br><span class=\"line\">  res.ptr = buf;</span><br><span class=\"line\">  res.len = used;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>OC  NSString go_seq_to_objc_stringgo_seq_from_objc_stringcstringnsstring<em>copy</em></p>\n<p>cstring</p>\n<h3 id=\"Bytes\"><a href=\"#Bytes\" class=\"headerlink\" title=\"Bytes\"></a>Bytes</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">// fromSlice converts a slice to a nbyteslice.</span><br><span class=\"line\">// If cpy is set, a malloced copy of the data is returned.</span><br><span class=\"line\">func fromSlice(s []byte, cpy bool) C.nbyteslice &#123;</span><br><span class=\"line\">    if s == nil || len(s) == 0 &#123;</span><br><span class=\"line\">        return C.nbyteslice&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ptr, n := unsafe.Pointer(&amp;s[0]), C.int(len(s))</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        nptr := C.malloc(C.size_t(n))</span><br><span class=\"line\">        if nptr == nil &#123;</span><br><span class=\"line\">            panic(&quot;fromSlice: malloc failed&quot;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        copy((*[1&lt;&lt;31 - 1]byte)(nptr)[:n], (*[1&lt;&lt;31 - 1]byte)(ptr)[:n])</span><br><span class=\"line\">        ptr = nptr</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return C.nbyteslice&#123;ptr: ptr, len: n&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// toSlice takes a nbyteslice and returns a byte slice with the data. If cpy is</span><br><span class=\"line\">// set, the slice contains a copy of the data. If not, the generated Go code</span><br><span class=\"line\">// calls releaseByteSlice after use.</span><br><span class=\"line\">func toSlice(s C.nbyteslice, cpy bool) []byte &#123;</span><br><span class=\"line\">    if s.ptr == nil || s.len == 0 &#123;</span><br><span class=\"line\">        return nil</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var b []byte</span><br><span class=\"line\">    if cpy &#123;</span><br><span class=\"line\">        b = C.GoBytes(s.ptr, C.int(s.len))</span><br><span class=\"line\">        C.free(s.ptr)</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        b = (*[1&lt;&lt;31 - 1]byte)(unsafe.Pointer(s.ptr))[:s.len:s.len]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return b</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Go  nbyteslice fromSlicetoSlicenbyteslicego slice</p>\n<p>OC -&gt; Go OCcopy &#x3D;&#x3D; trueGonbyteslice<br>Go -&gt; OC  (copy go-&gt;OC copy&#x3D;true)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NSData *go_seq_to_objc_bytearray(nbyteslice s, int copy) &#123;</span><br><span class=\"line\">  if (s.ptr == NULL) &#123;</span><br><span class=\"line\">    return NULL;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  BOOL freeWhenDone = copy ? YES : NO;</span><br><span class=\"line\">  return [NSData dataWithBytesNoCopy:s.ptr length:s.len freeWhenDone:freeWhenDone];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nbyteslice go_seq_from_objc_bytearray(NSData *data, int copy) &#123;</span><br><span class=\"line\">  struct nbyteslice res = &#123;NULL, 0&#125;;</span><br><span class=\"line\">  int sz = data.length;</span><br><span class=\"line\">  if (sz == 0) &#123;</span><br><span class=\"line\">    return res;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  void *ptr;</span><br><span class=\"line\">  // If the argument was not a NSMutableData, copy the data so that</span><br><span class=\"line\">  // the NSData is not changed from Go. The corresponding free is called</span><br><span class=\"line\">  // by releaseByteSlice.</span><br><span class=\"line\">  if (copy || ![data isKindOfClass:[NSMutableData class]]) &#123;</span><br><span class=\"line\">    void *arr_copy = malloc(sz);</span><br><span class=\"line\">    if (arr_copy == NULL) &#123;</span><br><span class=\"line\">      LOG_FATAL(@&quot;malloc failed&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    memcpy(arr_copy, [data bytes], sz);</span><br><span class=\"line\">    ptr = arr_copy;</span><br><span class=\"line\">  &#125; else &#123;</span><br><span class=\"line\">    ptr = (void *)[data bytes];</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  res.ptr = ptr;</span><br><span class=\"line\">  res.len = sz;</span><br><span class=\"line\">  return res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>OC  NSData go_seq_to_objc_bytearraygo_seq_from_objc_bytearraynbytesliceNSData</p>\n<p>OC -&gt; Go (NSMutableData &amp;&amp; !copy OC-&gt;Go copy &#x3D; falseNSDataNSMutableData)<em>bytes</em>Goslicebytes<br>Go -&gt; OC  OCGobytesOCNSDatanbyteslice.</p>\n<p><em>copycopyNSDatafalse</em></p>\n<hr>\n<p>2020-3-18 <br><a href=\"http://yulingtianxia.com/blog/2019/10/27/Write-Objective-C-Code-using-Dart/\"> Dart  Objective-C </a></p>\n<p>DartOCGoMobile</p>"},{"title":"SQLite--OS","date":"2020-04-18T16:00:00.000Z","_content":"\n>sqlitesqlite :)\n\n<!-- more -->\n\n## \n\nSqliteOS-Interface(os)\n\nOSOS`sqlite3Os`/sqlite`Util``sqlite3OsSleep``sqlite3OsCurrentTimeInt64``os.h`\n\nOS[](https://caio.ink/sqlite-os-shm/)OS  SQLite\n\n> iOSWCDB\n\n## \n\nosvfsvirtual file systemsqlitecacheextension...vfs\n\nsqlite`sqlite3_os_init()`mallocvfs\n\n\n```c\nint sqlite3_os_init(void);\n```\n\n> sqliteunix\n\n## \n\n### \n\nSqliteOS*sqlite3_file**sqlite3_file*vfsvfs*unixFile*Unixvfs\n\n*unixFile**UnixFile**sqlite3_file* file\n\n### inode\n\nUnixsqlite3fileUnixvfsfile node\n\ninode\n\n*unixInodeInfo*unix*unixFile**unixInodeInfo**unixInodeInfo*nRef(*unixFile*)nRef++nRef--Sqlite*unixInodeInfo*`UnixUnusedFd`nRef0Sqlite\n\n\n```c\n/*\n * UNIX,InodeInfoUnixFile\n */\nstruct unixInodeInfo {\n  struct unixFileId fileId;       /* The lookup key */\n  sqlite3_mutex *pLockMutex;      /* Hold this mutex for... */\n  int nShared;                      /* Number of SHARED locks held */\n  int nLock;                        /* Number of outstanding file locks */\n  unsigned char eFileLock;          /* One of SHARED_LOCK, RESERVED_LOCK etc. */\n  unsigned char bProcessLock;       /* An exclusive process lock is held */\n  UnixUnusedFd *pUnused;            /* Unused file descriptors to close */\n  int nRef;                       /* Number of pointers to this structure */\n  unixShmNode *pShmNode;          /* Shared memory associated with this inode */\n  unixInodeInfo *pNext;           /* List of all unixInodeInfo objects */\n  unixInodeInfo *pPrev;           /*    .... doubly linked */\n};\n```\n\nSqlite `static unixInodeInfo *inodeList = 0;` \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png)\n\n## \n\nPOSIXPOSIX\n\n\n> ABAB\n\n\n\n> \n\n1. Sqlite Sqlite\n2. \n\n### Sqlite \n\nSqlite5`UNLOCKED`,`SHARED`,`RESERVED`,`PENDING`,`EXCLUSIVE`5*inode*eFileLock\n\n- UNLOCKED:\n- SHARED:SHARED\n- RESERVED:\n- PENDING:\n- EXCLUSIVE:\n\nos5os4PENDINGos\n\nSqlite\n\n### \n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png)\n\n\n\n:SharedShared->ReservedShared->Reserved->Pending Shared->PendingShared->Reserved->Pending->ExclusiveShared->Pending->Exclusive\n\n- 1GB:\n\tWindowspagepage[512,32768]page512 bytes\n\t\n- SharedBytes:\n\tWin95/98/MEshared bytesqlite510510\n\t\n- fileinodeunixInodeInfo\n\n### \n\n```c\n//os.h 4\nint sqlite3OsLock(sqlite3_file*, int);\n```\n\n\n- UNLOCKED -> SHARED\n\t  \n\t\n\tInodeInfonSharednLock\n\t1. pending byte\n\t2. SHARED_BYTES\n\t3. pending byte\n\t\n- SHARED -> RESERVED\n\t\n\t1. \n\t\n- SHARED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. InodeInfoPendingpending\n\t2. InodeInfonShared>1SQLITE_BUSYInodeInfounixFilePendingPending\n\t3. SHARED_BYTES\n\t\n- RESERVED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. \n\t\n- PENDING -> EXCLUSIVE\n\t\n\t1.  *SHARED -> (PENDING) -> EXCLUSIVE* 3\n\n\n1. unlockedshared\n2. SqlitependingPending\n3. SQLITE_BUSY:\n\t\n\ta. Inode  >= pendingpendingshared\n\tb. Inode  < pending > shared\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png)\n\n>OSPENDING->EXCLUSIVEPENDING*unixFile*Pending\n\n### \n\n```c\n// \nint sqlite3OsUnlock(sqlite3_file*, int);\n```\n\n SHARE_LOCK  NO_LOCK...\n\n\n\n- \n\t1. pending + reserved + shared_size  UNLOCK\n\t2. Inode nShared--  nLock--\n\t\n- \n\n\tpending+reservedUNLOCKshared_sizeBSD NFSbug\n\t\n\tSqlite(shared_size - 1)bytesbytesbyte\n","source":"_posts/15.Sqlite-OS.md","raw":"---\ntitle: SQLite--OS\ndate: 2020-04-19\ntags: [sqlite3,os]\ncategories: sqlite3\n---\n\n>sqlitesqlite :)\n\n<!-- more -->\n\n## \n\nSqliteOS-Interface(os)\n\nOSOS`sqlite3Os`/sqlite`Util``sqlite3OsSleep``sqlite3OsCurrentTimeInt64``os.h`\n\nOS[](https://caio.ink/sqlite-os-shm/)OS  SQLite\n\n> iOSWCDB\n\n## \n\nosvfsvirtual file systemsqlitecacheextension...vfs\n\nsqlite`sqlite3_os_init()`mallocvfs\n\n\n```c\nint sqlite3_os_init(void);\n```\n\n> sqliteunix\n\n## \n\n### \n\nSqliteOS*sqlite3_file**sqlite3_file*vfsvfs*unixFile*Unixvfs\n\n*unixFile**UnixFile**sqlite3_file* file\n\n### inode\n\nUnixsqlite3fileUnixvfsfile node\n\ninode\n\n*unixInodeInfo*unix*unixFile**unixInodeInfo**unixInodeInfo*nRef(*unixFile*)nRef++nRef--Sqlite*unixInodeInfo*`UnixUnusedFd`nRef0Sqlite\n\n\n```c\n/*\n * UNIX,InodeInfoUnixFile\n */\nstruct unixInodeInfo {\n  struct unixFileId fileId;       /* The lookup key */\n  sqlite3_mutex *pLockMutex;      /* Hold this mutex for... */\n  int nShared;                      /* Number of SHARED locks held */\n  int nLock;                        /* Number of outstanding file locks */\n  unsigned char eFileLock;          /* One of SHARED_LOCK, RESERVED_LOCK etc. */\n  unsigned char bProcessLock;       /* An exclusive process lock is held */\n  UnixUnusedFd *pUnused;            /* Unused file descriptors to close */\n  int nRef;                       /* Number of pointers to this structure */\n  unixShmNode *pShmNode;          /* Shared memory associated with this inode */\n  unixInodeInfo *pNext;           /* List of all unixInodeInfo objects */\n  unixInodeInfo *pPrev;           /*    .... doubly linked */\n};\n```\n\nSqlite `static unixInodeInfo *inodeList = 0;` \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png)\n\n## \n\nPOSIXPOSIX\n\n\n> ABAB\n\n\n\n> \n\n1. Sqlite Sqlite\n2. \n\n### Sqlite \n\nSqlite5`UNLOCKED`,`SHARED`,`RESERVED`,`PENDING`,`EXCLUSIVE`5*inode*eFileLock\n\n- UNLOCKED:\n- SHARED:SHARED\n- RESERVED:\n- PENDING:\n- EXCLUSIVE:\n\nos5os4PENDINGos\n\nSqlite\n\n### \n\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png)\n\n\n\n:SharedShared->ReservedShared->Reserved->Pending Shared->PendingShared->Reserved->Pending->ExclusiveShared->Pending->Exclusive\n\n- 1GB:\n\tWindowspagepage[512,32768]page512 bytes\n\t\n- SharedBytes:\n\tWin95/98/MEshared bytesqlite510510\n\t\n- fileinodeunixInodeInfo\n\n### \n\n```c\n//os.h 4\nint sqlite3OsLock(sqlite3_file*, int);\n```\n\n\n- UNLOCKED -> SHARED\n\t  \n\t\n\tInodeInfonSharednLock\n\t1. pending byte\n\t2. SHARED_BYTES\n\t3. pending byte\n\t\n- SHARED -> RESERVED\n\t\n\t1. \n\t\n- SHARED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. InodeInfoPendingpending\n\t2. InodeInfonShared>1SQLITE_BUSYInodeInfounixFilePendingPending\n\t3. SHARED_BYTES\n\t\n- RESERVED -> (PENDING) -> EXCLUSIVE\n\t\n\t1. \n\t\n- PENDING -> EXCLUSIVE\n\t\n\t1.  *SHARED -> (PENDING) -> EXCLUSIVE* 3\n\n\n1. unlockedshared\n2. SqlitependingPending\n3. SQLITE_BUSY:\n\t\n\ta. Inode  >= pendingpendingshared\n\tb. Inode  < pending > shared\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png)\n\n>OSPENDING->EXCLUSIVEPENDING*unixFile*Pending\n\n### \n\n```c\n// \nint sqlite3OsUnlock(sqlite3_file*, int);\n```\n\n SHARE_LOCK  NO_LOCK...\n\n\n\n- \n\t1. pending + reserved + shared_size  UNLOCK\n\t2. Inode nShared--  nLock--\n\t\n- \n\n\tpending+reservedUNLOCKshared_sizeBSD NFSbug\n\t\n\tSqlite(shared_size - 1)bytesbytesbyte\n","slug":"15.Sqlite-OS","published":1,"updated":"2020-08-29T14:42:58.497Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l1000c93c90rsfaasa","content":"<blockquote>\n<p>sqlitesqlite :)</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SqliteOS-Interface(os)</p>\n<p>OSOS<code>sqlite3Os</code>&#x2F;sqlite<code>Util</code><code>sqlite3OsSleep</code><code>sqlite3OsCurrentTimeInt64</code><code>os.h</code></p>\n<p>OS<a href=\"https://caio.ink/sqlite-os-shm/\"></a>OS  SQLite</p>\n<blockquote>\n<p>iOSWCDB</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>osvfsvirtual file systemsqlitecacheextensionvfs</p>\n<p>sqlite<code>sqlite3_os_init()</code>mallocvfs</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3_os_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>sqliteunix</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SqliteOS<em>sqlite3_file</em><em>sqlite3_file</em>vfsvfs<em>unixFile</em>Unixvfs</p>\n<p><em>unixFile</em><em>UnixFile</em><em>sqlite3_file</em> file</p>\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><p>Unixsqlite3fileUnixvfsfile node</p>\n<p>inode</p>\n<p><em>unixInodeInfo</em>unix<em>unixFile</em><em>unixInodeInfo</em><em>unixInodeInfo</em>nRef(<em>unixFile</em>)nRef++nRefSqlite<em>unixInodeInfo</em><code>UnixUnusedFd</code>nRef0Sqlite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * UNIX,InodeInfoUnixFile</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixInodeInfo</span> &#123;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixFileId</span> <span class=\"title\">fileId</span>;</span>       <span class=\"comment\">/* The lookup key */</span></span><br><span class=\"line\">  sqlite3_mutex *pLockMutex;      <span class=\"comment\">/* Hold this mutex for... */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nShared;                      <span class=\"comment\">/* Number of SHARED locks held */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nLock;                        <span class=\"comment\">/* Number of outstanding file locks */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> eFileLock;          <span class=\"comment\">/* One of SHARED_LOCK, RESERVED_LOCK etc. */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> bProcessLock;       <span class=\"comment\">/* An exclusive process lock is held */</span></span><br><span class=\"line\">  UnixUnusedFd *pUnused;            <span class=\"comment\">/* Unused file descriptors to close */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                       <span class=\"comment\">/* Number of pointers to this structure */</span></span><br><span class=\"line\">  unixShmNode *pShmNode;          <span class=\"comment\">/* Shared memory associated with this inode */</span></span><br><span class=\"line\">  unixInodeInfo *pNext;           <span class=\"comment\">/* List of all unixInodeInfo objects */</span></span><br><span class=\"line\">  unixInodeInfo *pPrev;           <span class=\"comment\">/*    .... doubly linked */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite <code>static unixInodeInfo *inodeList = 0;</code> </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>POSIXPOSIX<br></p>\n<blockquote>\n<p>ABAB</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<ol>\n<li>Sqlite Sqlite</li>\n<li></li>\n</ol>\n<h3 id=\"Sqlite-\"><a href=\"#Sqlite-\" class=\"headerlink\" title=\"Sqlite \"></a>Sqlite </h3><p>Sqlite5<code>UNLOCKED</code>,<code>SHARED</code>,<code>RESERVED</code>,<code>PENDING</code>,<code>EXCLUSIVE</code>5<em>inode</em>eFileLock</p>\n<ul>\n<li>UNLOCKED:</li>\n<li>SHARED:SHARED</li>\n<li>RESERVED:</li>\n<li>PENDING:</li>\n<li>EXCLUSIVE:</li>\n</ul>\n<p>os5os4PENDINGos</p>\n<p>Sqlite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png\"></p>\n<p></p>\n<p>:SharedShared-&gt;ReservedShared-&gt;Reserved-&gt;Pending Shared-&gt;PendingShared-&gt;Reserved-&gt;Pending-&gt;ExclusiveShared-&gt;Pending-&gt;Exclusive</p>\n<ul>\n<li><p>1GB:<br>  Windowspagepage[512,32768]page512 bytes</p>\n</li>\n<li><p>SharedBytes:<br>  Win95&#x2F;98&#x2F;MEshared bytesqlite510510</p>\n</li>\n<li><p>fileinodeunixInodeInfo</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//os.h 4</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsLock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p>UNLOCKED -&gt; SHARED<br>    </p>\n<p>  InodeInfonSharednLock</p>\n<ol>\n<li>pending byte</li>\n<li>SHARED_BYTES</li>\n<li>pending byte</li>\n</ol>\n</li>\n<li><p>SHARED -&gt; RESERVED<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li>InodeInfoPendingpending</li>\n<li>InodeInfonShared&gt;1SQLITE_BUSYInodeInfounixFilePendingPending</li>\n<li>SHARED_BYTES</li>\n</ol>\n</li>\n<li><p>RESERVED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>PENDING -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li> <em>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE</em> 3</li>\n</ol>\n</li>\n</ul>\n<p></p>\n<ol>\n<li>unlockedshared</li>\n<li>SqlitependingPending</li>\n<li>SQLITE_BUSY:<br> <br> a. Inode  &gt;&#x3D; pendingpendingshared<br> b. Inode  &lt; pending &gt; shared</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png\"></p>\n<blockquote>\n<p>OSPENDING-&gt;EXCLUSIVEPENDING<em>unixFile</em>Pending</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsUnlock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p> SHARE_LOCK  NO_LOCK</p>\n<p></p>\n<ul>\n<li><p></p>\n<ol>\n<li>pending + reserved + shared_size  UNLOCK</li>\n<li>Inode nShared  nLock</li>\n</ol>\n</li>\n<li><p></p>\n<p>  pending+reservedUNLOCKshared_sizeBSD NFSbug</p>\n<p>  Sqlite(shared_size - 1)bytesbytesbyte</p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>sqlitesqlite :)</p>\n</blockquote>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SqliteOS-Interface(os)</p>\n<p>OSOS<code>sqlite3Os</code>&#x2F;sqlite<code>Util</code><code>sqlite3OsSleep</code><code>sqlite3OsCurrentTimeInt64</code><code>os.h</code></p>\n<p>OS<a href=\"https://caio.ink/sqlite-os-shm/\"></a>OS  SQLite</p>\n<blockquote>\n<p>iOSWCDB</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>osvfsvirtual file systemsqlitecacheextensionvfs</p>\n<p>sqlite<code>sqlite3_os_init()</code>mallocvfs</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3_os_init</span><span class=\"params\">(<span class=\"type\">void</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>sqliteunix</p>\n</blockquote>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SqliteOS<em>sqlite3_file</em><em>sqlite3_file</em>vfsvfs<em>unixFile</em>Unixvfs</p>\n<p><em>unixFile</em><em>UnixFile</em><em>sqlite3_file</em> file</p>\n<h3 id=\"inode\"><a href=\"#inode\" class=\"headerlink\" title=\"inode\"></a>inode</h3><p>Unixsqlite3fileUnixvfsfile node</p>\n<p>inode</p>\n<p><em>unixInodeInfo</em>unix<em>unixFile</em><em>unixInodeInfo</em><em>unixInodeInfo</em>nRef(<em>unixFile</em>)nRef++nRefSqlite<em>unixInodeInfo</em><code>UnixUnusedFd</code>nRef0Sqlite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * UNIX,InodeInfoUnixFile</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixInodeInfo</span> &#123;</span></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">unixFileId</span> <span class=\"title\">fileId</span>;</span>       <span class=\"comment\">/* The lookup key */</span></span><br><span class=\"line\">  sqlite3_mutex *pLockMutex;      <span class=\"comment\">/* Hold this mutex for... */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nShared;                      <span class=\"comment\">/* Number of SHARED locks held */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nLock;                        <span class=\"comment\">/* Number of outstanding file locks */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> eFileLock;          <span class=\"comment\">/* One of SHARED_LOCK, RESERVED_LOCK etc. */</span></span><br><span class=\"line\">  <span class=\"type\">unsigned</span> <span class=\"type\">char</span> bProcessLock;       <span class=\"comment\">/* An exclusive process lock is held */</span></span><br><span class=\"line\">  UnixUnusedFd *pUnused;            <span class=\"comment\">/* Unused file descriptors to close */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> nRef;                       <span class=\"comment\">/* Number of pointers to this structure */</span></span><br><span class=\"line\">  unixShmNode *pShmNode;          <span class=\"comment\">/* Shared memory associated with this inode */</span></span><br><span class=\"line\">  unixInodeInfo *pNext;           <span class=\"comment\">/* List of all unixInodeInfo objects */</span></span><br><span class=\"line\">  unixInodeInfo *pPrev;           <span class=\"comment\">/*    .... doubly linked */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>Sqlite <code>static unixInodeInfo *inodeList = 0;</code> </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/52e0629643e32cd4700b2ccf86cf96fb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>POSIXPOSIX<br></p>\n<blockquote>\n<p>ABAB</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p></p>\n</blockquote>\n<ol>\n<li>Sqlite Sqlite</li>\n<li></li>\n</ol>\n<h3 id=\"Sqlite-\"><a href=\"#Sqlite-\" class=\"headerlink\" title=\"Sqlite \"></a>Sqlite </h3><p>Sqlite5<code>UNLOCKED</code>,<code>SHARED</code>,<code>RESERVED</code>,<code>PENDING</code>,<code>EXCLUSIVE</code>5<em>inode</em>eFileLock</p>\n<ul>\n<li>UNLOCKED:</li>\n<li>SHARED:SHARED</li>\n<li>RESERVED:</li>\n<li>PENDING:</li>\n<li>EXCLUSIVE:</li>\n</ul>\n<p>os5os4PENDINGos</p>\n<p>Sqlite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/f847a348f6011bf85c71903fc41e03de.png\"></p>\n<p></p>\n<p>:SharedShared-&gt;ReservedShared-&gt;Reserved-&gt;Pending Shared-&gt;PendingShared-&gt;Reserved-&gt;Pending-&gt;ExclusiveShared-&gt;Pending-&gt;Exclusive</p>\n<ul>\n<li><p>1GB:<br>  Windowspagepage[512,32768]page512 bytes</p>\n</li>\n<li><p>SharedBytes:<br>  Win95&#x2F;98&#x2F;MEshared bytesqlite510510</p>\n</li>\n<li><p>fileinodeunixInodeInfo</p>\n</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//os.h 4</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsLock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ul>\n<li><p>UNLOCKED -&gt; SHARED<br>    </p>\n<p>  InodeInfonSharednLock</p>\n<ol>\n<li>pending byte</li>\n<li>SHARED_BYTES</li>\n<li>pending byte</li>\n</ol>\n</li>\n<li><p>SHARED -&gt; RESERVED<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li>InodeInfoPendingpending</li>\n<li>InodeInfonShared&gt;1SQLITE_BUSYInodeInfounixFilePendingPending</li>\n<li>SHARED_BYTES</li>\n</ol>\n</li>\n<li><p>RESERVED -&gt; (PENDING) -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li></li>\n</ol>\n</li>\n<li><p>PENDING -&gt; EXCLUSIVE<br>  </p>\n<ol>\n<li> <em>SHARED -&gt; (PENDING) -&gt; EXCLUSIVE</em> 3</li>\n</ol>\n</li>\n</ul>\n<p></p>\n<ol>\n<li>unlockedshared</li>\n<li>SqlitependingPending</li>\n<li>SQLITE_BUSY:<br> <br> a. Inode  &gt;&#x3D; pendingpendingshared<br> b. Inode  &lt; pending &gt; shared</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/04/b04697cfc5624e7286657b74d3096fa7.png\"></p>\n<blockquote>\n<p>OSPENDING-&gt;EXCLUSIVEPENDING<em>unixFile</em>Pending</p>\n</blockquote>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3OsUnlock</span><span class=\"params\">(sqlite3_file*, <span class=\"type\">int</span>)</span>;</span><br></pre></td></tr></table></figure>\n\n<p> SHARE_LOCK  NO_LOCK</p>\n<p></p>\n<ul>\n<li><p></p>\n<ol>\n<li>pending + reserved + shared_size  UNLOCK</li>\n<li>Inode nShared  nLock</li>\n</ol>\n</li>\n<li><p></p>\n<p>  pending+reservedUNLOCKshared_sizeBSD NFSbug</p>\n<p>  Sqlite(shared_size - 1)bytesbytesbyte</p>\n</li>\n</ul>"},{"title":"SQLite","date":"2020-06-11T16:00:00.000Z","_content":"\n> source: inside-sqlite\n\n<!-- more -->\n\n## SQLite \n\nSQLiteVMVMSQLiteVMSQLiteVMVMB+\"\"\n\nVMVM\n\n sqlite3_stmt(Vdbe)\n\nVdbe\n* \n* \n* \n* \n* \n* \n* BTree\n\n### 1 \n\nSQLite<opcode, P1, P2, P3>, opcode P1, P2, P3VMP132P2 31P2P3NullNULL\n\nVMSQLiteSQLiteSQLite\n\n[6-1]() SELECT * FROM t1 t1xy\n\n| Address | Opcode | p1 | p2 | p3 |\n| ---- | ---- | ---- | ---- | ---- |\n| 0 | Goto | 0 | 11 |  |\n| 1 | Integer | 0 | 0 |  |\n| 2 | OpenRead | 0 | 2 |  |\n| 3 | SetNumColumn | 0 | 2 | #t1 |\n| 4 | Rewind | 0 | 9 |\n| 5 | Column | 0 | 0 | #x |\n| 6 | Column | 0 | 1 | #y |\n| 7 | Callback | 2 | 0 |\n| 8 | Next | 0 | 5 |\n| 9 | Close | 0 | 0 |\n| 10 | Halt | 0 | 0 |\n| 11 | Transaction | 0 | 0 |\n| 12 | VerifyCookie | 0 | 1 |\n| 13 | Goto | 0 | 1 |\n\nVM:\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\nSwitchcase OP_ VMaOppcVM0\n\nVMkeyVM/\n\nVMSELECT\n\nVMrcVM\n\n### 2 \n\nVM(record)B/B+**key******VMkeyB+-treeVMVM\n\ndata/keySQLitebytesSQLite\n\nVMSQLSQLiteSQLiteSQLSQLite\n\n\n\n| Header size | Type 1 | Type 2| ... | Data1 | Data2 |\n| ---- | ---- | ---- | ---- | ---- | ---- |\n\n(row data)Header sizeData164integerData1header sizeType i2^64Data i\n\nVM5SQL NULL123NULL\n\n\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\nNULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\nSQLiteB+-TreekeySQLite\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]\n\nSQLSQL:`create table t1(x, y)`rowidSQLiterowidSQLite`insert into t1(rowid, x, y) values(100, 'hello', 'world')`rowid\n\nSQL\n\n| rowid | x | y |\n| ---- | ---- | ---- |\n| -5 | abc | xyz |\n| 1 | abc | 12345 |\n| 2 | 456 | def |\n| 100 | hello | world |\n| 54321 | NULL | 987|\n\n****\n\nrowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid\n\nrowidkeyrowid9rowidSQLiterowid-5\n\nB+key(key)rowidSQLiterowidB+\n\n\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ----|\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nSQLiteyx\n\nyx\n\n| y | x | rowid |\n| ---- | ----| ---- |\n| 987 | NULL | 54321 |\n| 12345 | abc | 1 |\n| def | 456 | 2 |\n| xyz | abc | -5 |\n| world | hello | 100 |\n\n`SELECT y FROM t1 WHERE x=`SQLite `t1(x)`x=?rowidrowidt1B+y\n\n### 3 \n\nSQLiteVMVMVMVMVM\n\nSQLiteSQL\"\"VMSQLSQLiteINTEGERREALTEXT\n\n#### 3.1.1 \n\nVMSQL:\n\n* TEXT\n* INTEGER\n* REAL\n* NULLNULL\n* X'ABCD'BLOB\n\nsqlite3_bind_ * APISQLsqlite3_bind_blob BLOB\n\nSQLSQLVM\n\n#### 3.1.2 \n\nSQLSQLSQLiteSQLite\"\"\n\n****\n\nSQLiterowidSQLiteSQL`create table T1(a, b, c)`SQLiteSQL\n\nTEXT, NUMERIC, INTEGER, REAL, and NONE\"text,\" \"integer,\"\"real\"`CREATE TABLE`SQLSQLiteSQL:\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE`create table table1 as select ...`SQLSQLNONErowid.\n\n#### 3.1.3 \nVM\n\n1. TEXTNULLTEXTBLOBTEXT\n2. NUMERICNUMERICINTEGERREALTEXTNULLBLOB\n3. INTEGERNUMERICINTEGER\n4. REALNUMERIC-\n5. NONE VM\n\n****\n\nSQLSQLiteSQLINTEGER(\"123\"\"abc\")VM(\"123\")REALINTEGER(\"abc\")TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug\n\n#### 3.1.4 \n\n\n\n`CREATE TABLE T1(a,b,c);`\n`INSERT INTO T1 VALUES(177,NULL,'hello');`\n\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\na,b,cintegerNULLTEXTNONEVM11(header+data)16\n\n1. Header440x04\n2. Type 12.\n3. Type 20.NULL\n4. Type 323.(23-13/2=)5\n5. Data 1200B1,117117B1-79177.\n6. Data 2NULL\n7. Data 3568 65 6C 6F0\n\n`sqlite3_column_*`APISQLiteFLOAT( sqlite3_column_text)VM`sprintf()`VM\n\n****\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER |  0 |\n| NULL | FLOAT |  0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() C |\n| TEXT | FLOAT | atof() C |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | atoi()  |\n| BLOB | FLOAT | atof()  |\n| BLOB | TEXT | \\000 |\n\nVM..\n\n\n#### 3.2.1 NULL\n\nNULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n\n#### 3.2.2 \n\nSQLite\n\n*  =, <, <=, >, >=  !=\n*  IN\n*  BETWEEN\n\n\n1. NULLNULL\n2. INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL\n3. TEXTBLOBTEXTCmemcmp\n4. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXTSQL\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)`=(,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)``INSERT INTO t1 VALUES(500500500)`a,b,cTEXTINTEGERTEXT\n\n* `SELECT a < 60,a < 40 FROM t1`6040\"60\"\"40\"aTEXTTEXT`1|0`\"500\"\"60\"\"40\"\n* `SELECT b < 60,b < 600 FROM t1``0|1`\n* `SELECT c < 60,c < 600 FROM t1`cNONENUMERIC\"500\"(TEXT)`0|0`\n\n#### 3.2.3 \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### 3.2.4 ORDER BY\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### 3.2.5 GROUP BY\nGROUP BYINTEGERREAL\n\n#### 3.2.6 SELECT\nSELECT(UNIONINTERSECTEXCEPT)SELECTSELECT","source":"_posts/17.inside-sqlite-chapter-6.md","raw":"---\ntitle: SQLite\ndate: 2020-06-12\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> source: inside-sqlite\n\n<!-- more -->\n\n## SQLite \n\nSQLiteVMVMSQLiteVMSQLiteVMVMB+\"\"\n\nVMVM\n\n sqlite3_stmt(Vdbe)\n\nVdbe\n* \n* \n* \n* \n* \n* \n* BTree\n\n### 1 \n\nSQLite<opcode, P1, P2, P3>, opcode P1, P2, P3VMP132P2 31P2P3NullNULL\n\nVMSQLiteSQLiteSQLite\n\n[6-1]() SELECT * FROM t1 t1xy\n\n| Address | Opcode | p1 | p2 | p3 |\n| ---- | ---- | ---- | ---- | ---- |\n| 0 | Goto | 0 | 11 |  |\n| 1 | Integer | 0 | 0 |  |\n| 2 | OpenRead | 0 | 2 |  |\n| 3 | SetNumColumn | 0 | 2 | #t1 |\n| 4 | Rewind | 0 | 9 |\n| 5 | Column | 0 | 0 | #x |\n| 6 | Column | 0 | 1 | #y |\n| 7 | Callback | 2 | 0 |\n| 8 | Next | 0 | 5 |\n| 9 | Close | 0 | 0 |\n| 10 | Halt | 0 | 0 |\n| 11 | Transaction | 0 | 0 |\n| 12 | VerifyCookie | 0 | 1 |\n| 13 | Goto | 0 | 1 |\n\nVM:\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\nSwitchcase OP_ VMaOppcVM0\n\nVMkeyVM/\n\nVMSELECT\n\nVMrcVM\n\n### 2 \n\nVM(record)B/B+**key******VMkeyB+-treeVMVM\n\ndata/keySQLitebytesSQLite\n\nVMSQLSQLiteSQLiteSQLSQLite\n\n\n\n| Header size | Type 1 | Type 2| ... | Data1 | Data2 |\n| ---- | ---- | ---- | ---- | ---- | ---- |\n\n(row data)Header sizeData164integerData1header sizeType i2^64Data i\n\nVM5SQL NULL123NULL\n\n\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\nNULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\nSQLiteB+-TreekeySQLite\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]\n\nSQLSQL:`create table t1(x, y)`rowidSQLiterowidSQLite`insert into t1(rowid, x, y) values(100, 'hello', 'world')`rowid\n\nSQL\n\n| rowid | x | y |\n| ---- | ---- | ---- |\n| -5 | abc | xyz |\n| 1 | abc | 12345 |\n| 2 | 456 | def |\n| 100 | hello | world |\n| 54321 | NULL | 987|\n\n****\n\nrowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid\n\nrowidkeyrowid9rowidSQLiterowid-5\n\nB+key(key)rowidSQLiterowidB+\n\n\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ----|\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nSQLiteyx\n\nyx\n\n| y | x | rowid |\n| ---- | ----| ---- |\n| 987 | NULL | 54321 |\n| 12345 | abc | 1 |\n| def | 456 | 2 |\n| xyz | abc | -5 |\n| world | hello | 100 |\n\n`SELECT y FROM t1 WHERE x=`SQLite `t1(x)`x=?rowidrowidt1B+y\n\n### 3 \n\nSQLiteVMVMVMVMVM\n\nSQLiteSQL\"\"VMSQLSQLiteINTEGERREALTEXT\n\n#### 3.1.1 \n\nVMSQL:\n\n* TEXT\n* INTEGER\n* REAL\n* NULLNULL\n* X'ABCD'BLOB\n\nsqlite3_bind_ * APISQLsqlite3_bind_blob BLOB\n\nSQLSQLVM\n\n#### 3.1.2 \n\nSQLSQLSQLiteSQLite\"\"\n\n****\n\nSQLiterowidSQLiteSQL`create table T1(a, b, c)`SQLiteSQL\n\nTEXT, NUMERIC, INTEGER, REAL, and NONE\"text,\" \"integer,\"\"real\"`CREATE TABLE`SQLSQLiteSQL:\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE`create table table1 as select ...`SQLSQLNONErowid.\n\n#### 3.1.3 \nVM\n\n1. TEXTNULLTEXTBLOBTEXT\n2. NUMERICNUMERICINTEGERREALTEXTNULLBLOB\n3. INTEGERNUMERICINTEGER\n4. REALNUMERIC-\n5. NONE VM\n\n****\n\nSQLSQLiteSQLINTEGER(\"123\"\"abc\")VM(\"123\")REALINTEGER(\"abc\")TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug\n\n#### 3.1.4 \n\n\n\n`CREATE TABLE T1(a,b,c);`\n`INSERT INTO T1 VALUES(177,NULL,'hello');`\n\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\na,b,cintegerNULLTEXTNONEVM11(header+data)16\n\n1. Header440x04\n2. Type 12.\n3. Type 20.NULL\n4. Type 323.(23-13/2=)5\n5. Data 1200B1,117117B1-79177.\n6. Data 2NULL\n7. Data 3568 65 6C 6F0\n\n`sqlite3_column_*`APISQLiteFLOAT( sqlite3_column_text)VM`sprintf()`VM\n\n****\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER |  0 |\n| NULL | FLOAT |  0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() C |\n| TEXT | FLOAT | atof() C |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | atoi()  |\n| BLOB | FLOAT | atof()  |\n| BLOB | TEXT | \\000 |\n\nVM..\n\n\n#### 3.2.1 NULL\n\nNULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n\n#### 3.2.2 \n\nSQLite\n\n*  =, <, <=, >, >=  !=\n*  IN\n*  BETWEEN\n\n\n1. NULLNULL\n2. INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL\n3. TEXTBLOBTEXTCmemcmp\n4. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXTSQL\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)`=(,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)``INSERT INTO t1 VALUES(500500500)`a,b,cTEXTINTEGERTEXT\n\n* `SELECT a < 60,a < 40 FROM t1`6040\"60\"\"40\"aTEXTTEXT`1|0`\"500\"\"60\"\"40\"\n* `SELECT b < 60,b < 600 FROM t1``0|1`\n* `SELECT c < 60,c < 600 FROM t1`cNONENUMERIC\"500\"(TEXT)`0|0`\n\n#### 3.2.3 \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### 3.2.4 ORDER BY\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### 3.2.5 GROUP BY\nGROUP BYINTEGERREAL\n\n#### 3.2.6 SELECT\nSELECT(UNIONINTERSECTEXCEPT)SELECTSELECT","slug":"17.inside-sqlite-chapter-6","published":1,"updated":"2020-08-29T14:42:58.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l2000g93c92mmz74of","content":"<blockquote>\n<p>source: inside-sqlite</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"SQLite-\"><a href=\"#SQLite-\" class=\"headerlink\" title=\"SQLite \"></a>SQLite </h2><p>SQLiteVMVMSQLiteVMSQLiteVMVMB+</p>\n<p>VMVM</p>\n<p> sqlite3_stmt(Vdbe)</p>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>BTree</li>\n</ul>\n<h3 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1 \"></a>1 </h3><p>SQLite&lt;opcode, P1, P2, P3&gt;, opcode P1, P2, P3VMP132P2 31P2P3NullNULL</p>\n<p>VMSQLiteSQLiteSQLite</p>\n<p><a href=\"\">6-1</a> SELECT * FROM t1 t1xy</p>\n<table>\n<thead>\n<tr>\n<th>Address</th>\n<th>Opcode</th>\n<th>p1</th>\n<th>p2</th>\n<th>p3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>Goto</td>\n<td>0</td>\n<td>11</td>\n<td></td>\n</tr>\n<tr>\n<td>1</td>\n<td>Integer</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>OpenRead</td>\n<td>0</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>SetNumColumn</td>\n<td>0</td>\n<td>2</td>\n<td>#t1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Rewind</td>\n<td>0</td>\n<td>9</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>Column</td>\n<td>0</td>\n<td>0</td>\n<td>#x</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Column</td>\n<td>0</td>\n<td>1</td>\n<td>#y</td>\n</tr>\n<tr>\n<td>7</td>\n<td>Callback</td>\n<td>2</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>Next</td>\n<td>0</td>\n<td>5</td>\n<td></td>\n</tr>\n<tr>\n<td>9</td>\n<td>Close</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>10</td>\n<td>Halt</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>11</td>\n<td>Transaction</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>VerifyCookie</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>13</td>\n<td>Goto</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Switchcase OP_ VMaOppcVM0</p>\n<p>VMkeyVM&#x2F;</p>\n<p>VMSELECT</p>\n<p>VMrcVM</p>\n<h3 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2 \"></a>2 </h3><p>VM(record)B&#x2F;B+<strong>key</strong><strong></strong>VMkeyB+-treeVMVM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<p>VMSQLSQLiteSQLiteSQLSQLite</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n</tr>\n</thead>\n</table>\n<p>(row data)Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>VM5SQL NULL123NULL</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<p>NULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>SQLiteB+-TreekeySQLite</p>\n<p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]</p>\n<p>SQLSQL:<code>create table t1(x, y)</code>rowidSQLiterowidSQLite<code>insert into t1(rowid, x, y) values(100, &#39;hello&#39;, &#39;world&#39;)</code>rowid</p>\n<p>SQL</p>\n<table>\n<thead>\n<tr>\n<th>rowid</th>\n<th>x</th>\n<th>y</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-5</td>\n<td>abc</td>\n<td>xyz</td>\n</tr>\n<tr>\n<td>1</td>\n<td>abc</td>\n<td>12345</td>\n</tr>\n<tr>\n<td>2</td>\n<td>456</td>\n<td>def</td>\n</tr>\n<tr>\n<td>100</td>\n<td>hello</td>\n<td>world</td>\n</tr>\n<tr>\n<td>54321</td>\n<td>NULL</td>\n<td>987</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>rowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid</p>\n<p>rowidkeyrowid9rowidSQLiterowid-5</p>\n<p>B+key(key)rowidSQLiterowidB+</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>SQLiteyx</p>\n<p>yx</p>\n<table>\n<thead>\n<tr>\n<th>y</th>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>987</td>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>12345</td>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>def</td>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>xyz</td>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>world</td>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p><code>SELECT y FROM t1 WHERE x=</code>SQLite <code>t1(x)</code>x&#x3D;?rowidrowidt1B+y</p>\n<h3 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3 \"></a>3 </h3><p>SQLiteVMVMVMVMVM</p>\n<p>SQLiteSQLVMSQLSQLiteINTEGERREALTEXT</p>\n<h4 id=\"3-1-1-\"><a href=\"#3-1-1-\" class=\"headerlink\" title=\"3.1.1 \"></a>3.1.1 </h4><p>VMSQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB</li>\n</ul>\n<p>sqlite3_bind_ * APISQLsqlite3_bind_blob BLOB</p>\n<p>SQLSQLVM</p>\n<h4 id=\"3-1-2-\"><a href=\"#3-1-2-\" class=\"headerlink\" title=\"3.1.2 \"></a>3.1.2 </h4><p>SQLSQLSQLiteSQLite</p>\n<p><strong></strong></p>\n<p>SQLiterowidSQLiteSQL<code>create table T1(a, b, c)</code>SQLiteSQL</p>\n<p>TEXT, NUMERIC, INTEGER, REAL, and NONEtext, integer,real<code>CREATE TABLE</code>SQLSQLiteSQL:</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE<code>create table table1 as select ...</code>SQLSQLNONErowid.</p>\n<h4 id=\"3-1-3-\"><a href=\"#3-1-3-\" class=\"headerlink\" title=\"3.1.3 \"></a>3.1.3 </h4><p>VM</p>\n<ol>\n<li>TEXTNULLTEXTBLOBTEXT</li>\n<li>NUMERICNUMERICINTEGERREALTEXTNULLBLOB</li>\n<li>INTEGERNUMERICINTEGER</li>\n<li>REALNUMERIC-</li>\n<li>NONE VM</li>\n</ol>\n<p><strong></strong></p>\n<p>SQLSQLiteSQLINTEGER(123abc)VM(123)REALINTEGER(abc)TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug</p>\n<h4 id=\"3-1-4-\"><a href=\"#3-1-4-\" class=\"headerlink\" title=\"3.1.4 \"></a>3.1.4 </h4><p></p>\n<p><code>CREATE TABLE T1(a,b,c);</code><br><code>INSERT INTO T1 VALUES(177,NULL,&#39;hello&#39;);</code></p>\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\n<p>a,b,cintegerNULLTEXTNONEVM11(header+data)16</p>\n<ol>\n<li>Header440x04</li>\n<li>Type 12.</li>\n<li>Type 20.NULL</li>\n<li>Type 323.(23-13&#x2F;2&#x3D;)5</li>\n<li>Data 1200B1,117117B1-79177.</li>\n<li>Data 2NULL</li>\n<li>Data 3568 65 6C 6F0</li>\n</ol>\n<p><code>sqlite3_column_*</code>APISQLiteFLOAT( sqlite3_column_text)VM<code>sprintf()</code>VM</p>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>atoi() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>atof() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<p>VM..</p>\n<h4 id=\"3-2-1-NULL\"><a href=\"#3-2-1-NULL\" class=\"headerlink\" title=\"3.2.1 NULL\"></a>3.2.1 NULL</h4><p>NULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"3-2-2-\"><a href=\"#3-2-2-\" class=\"headerlink\" title=\"3.2.2 \"></a>3.2.2 </h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;  !&#x3D;</li>\n<li> IN</li>\n<li> BETWEEN</li>\n</ul>\n<p></p>\n<ol>\n<li>NULLNULL</li>\n<li>INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL</li>\n<li>TEXTBLOBTEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXTSQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code>&#x3D;(,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)</code><code>INSERT INTO t1 VALUES(500500500)</code>a,b,cTEXTINTEGERTEXT</p>\n<ul>\n<li><code>SELECT a &lt; 60,a &lt; 40 FROM t1</code>60406040aTEXTTEXT<code>1|0</code>5006040</li>\n<li><code>SELECT b &lt; 60,b &lt; 600 FROM t1</code><code>0|1</code></li>\n<li><code>SELECT c &lt; 60,c &lt; 600 FROM t1</code>cNONENUMERIC500(TEXT)<code>0|0</code></li>\n</ul>\n<h4 id=\"3-2-3-\"><a href=\"#3-2-3-\" class=\"headerlink\" title=\"3.2.3 \"></a>3.2.3 </h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"3-2-4-ORDER-BY\"><a href=\"#3-2-4-ORDER-BY\" class=\"headerlink\" title=\"3.2.4 ORDER BY\"></a>3.2.4 ORDER BY</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"3-2-5-GROUP-BY\"><a href=\"#3-2-5-GROUP-BY\" class=\"headerlink\" title=\"3.2.5 GROUP BY\"></a>3.2.5 GROUP BY</h4><p>GROUP BYINTEGERREAL</p>\n<h4 id=\"3-2-6-SELECT\"><a href=\"#3-2-6-SELECT\" class=\"headerlink\" title=\"3.2.6 SELECT\"></a>3.2.6 SELECT</h4><p>SELECT(UNIONINTERSECTEXCEPT)SELECTSELECT</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>source: inside-sqlite</p>\n</blockquote>","more":"<h2 id=\"SQLite-\"><a href=\"#SQLite-\" class=\"headerlink\" title=\"SQLite \"></a>SQLite </h2><p>SQLiteVMVMSQLiteVMSQLiteVMVMB+</p>\n<p>VMVM</p>\n<p> sqlite3_stmt(Vdbe)</p>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>BTree</li>\n</ul>\n<h3 id=\"1-\"><a href=\"#1-\" class=\"headerlink\" title=\"1 \"></a>1 </h3><p>SQLite&lt;opcode, P1, P2, P3&gt;, opcode P1, P2, P3VMP132P2 31P2P3NullNULL</p>\n<p>VMSQLiteSQLiteSQLite</p>\n<p><a href=\"\">6-1</a> SELECT * FROM t1 t1xy</p>\n<table>\n<thead>\n<tr>\n<th>Address</th>\n<th>Opcode</th>\n<th>p1</th>\n<th>p2</th>\n<th>p3</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>Goto</td>\n<td>0</td>\n<td>11</td>\n<td></td>\n</tr>\n<tr>\n<td>1</td>\n<td>Integer</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>OpenRead</td>\n<td>0</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>3</td>\n<td>SetNumColumn</td>\n<td>0</td>\n<td>2</td>\n<td>#t1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Rewind</td>\n<td>0</td>\n<td>9</td>\n<td></td>\n</tr>\n<tr>\n<td>5</td>\n<td>Column</td>\n<td>0</td>\n<td>0</td>\n<td>#x</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Column</td>\n<td>0</td>\n<td>1</td>\n<td>#y</td>\n</tr>\n<tr>\n<td>7</td>\n<td>Callback</td>\n<td>2</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>Next</td>\n<td>0</td>\n<td>5</td>\n<td></td>\n</tr>\n<tr>\n<td>9</td>\n<td>Close</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>10</td>\n<td>Halt</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>11</td>\n<td>Transaction</td>\n<td>0</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>VerifyCookie</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>13</td>\n<td>Goto</td>\n<td>0</td>\n<td>1</td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Switchcase OP_ VMaOppcVM0</p>\n<p>VMkeyVM&#x2F;</p>\n<p>VMSELECT</p>\n<p>VMrcVM</p>\n<h3 id=\"2-\"><a href=\"#2-\" class=\"headerlink\" title=\"2 \"></a>2 </h3><p>VM(record)B&#x2F;B+<strong>key</strong><strong></strong>VMkeyB+-treeVMVM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<p>VMSQLSQLiteSQLiteSQLSQLite</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n</tr>\n</thead>\n</table>\n<p>(row data)Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>VM5SQL NULL123NULL</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<p>NULLSQLNULLINTEGER123468REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>SQLiteB+-TreekeySQLite</p>\n<p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid integer primary keykeyrowidrowidrowid[-2^63, 2^63-1]</p>\n<p>SQLSQL:<code>create table t1(x, y)</code>rowidSQLiterowidSQLite<code>insert into t1(rowid, x, y) values(100, &#39;hello&#39;, &#39;world&#39;)</code>rowid</p>\n<p>SQL</p>\n<table>\n<thead>\n<tr>\n<th>rowid</th>\n<th>x</th>\n<th>y</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>-5</td>\n<td>abc</td>\n<td>xyz</td>\n</tr>\n<tr>\n<td>1</td>\n<td>abc</td>\n<td>12345</td>\n</tr>\n<tr>\n<td>2</td>\n<td>456</td>\n<td>def</td>\n</tr>\n<tr>\n<td>100</td>\n<td>hello</td>\n<td>world</td>\n</tr>\n<tr>\n<td>54321</td>\n<td>NULL</td>\n<td>987</td>\n</tr>\n</tbody></table>\n<p><strong></strong></p>\n<p>rowid( INTEGER PRIMARY KEY)rowidSQLiteSQLiterowidSQLiteB+rowid</p>\n<p>rowidkeyrowid9rowidSQLiterowid-5</p>\n<p>B+key(key)rowidSQLiterowidB+</p>\n<p></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteB-TreekeyrowidrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>SQLiteyx</p>\n<p>yx</p>\n<table>\n<thead>\n<tr>\n<th>y</th>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>987</td>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>12345</td>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>def</td>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>xyz</td>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>world</td>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p><code>SELECT y FROM t1 WHERE x=</code>SQLite <code>t1(x)</code>x&#x3D;?rowidrowidt1B+y</p>\n<h3 id=\"3-\"><a href=\"#3-\" class=\"headerlink\" title=\"3 \"></a>3 </h3><p>SQLiteVMVMVMVMVM</p>\n<p>SQLiteSQLVMSQLSQLiteINTEGERREALTEXT</p>\n<h4 id=\"3-1-1-\"><a href=\"#3-1-1-\" class=\"headerlink\" title=\"3.1.1 \"></a>3.1.1 </h4><p>VMSQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB</li>\n</ul>\n<p>sqlite3_bind_ * APISQLsqlite3_bind_blob BLOB</p>\n<p>SQLSQLVM</p>\n<h4 id=\"3-1-2-\"><a href=\"#3-1-2-\" class=\"headerlink\" title=\"3.1.2 \"></a>3.1.2 </h4><p>SQLSQLSQLiteSQLite</p>\n<p><strong></strong></p>\n<p>SQLiterowidSQLiteSQL<code>create table T1(a, b, c)</code>SQLiteSQL</p>\n<p>TEXT, NUMERIC, INTEGER, REAL, and NONEtext, integer,real<code>CREATE TABLE</code>SQLSQLiteSQL:</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE<code>create table table1 as select ...</code>SQLSQLNONErowid.</p>\n<h4 id=\"3-1-3-\"><a href=\"#3-1-3-\" class=\"headerlink\" title=\"3.1.3 \"></a>3.1.3 </h4><p>VM</p>\n<ol>\n<li>TEXTNULLTEXTBLOBTEXT</li>\n<li>NUMERICNUMERICINTEGERREALTEXTNULLBLOB</li>\n<li>INTEGERNUMERICINTEGER</li>\n<li>REALNUMERIC-</li>\n<li>NONE VM</li>\n</ol>\n<p><strong></strong></p>\n<p>SQLSQLiteSQLINTEGER(123abc)VM(123)REALINTEGER(abc)TEXTTEXTASCIIBLOBsTEXTSQLiteSQLitebug</p>\n<h4 id=\"3-1-4-\"><a href=\"#3-1-4-\" class=\"headerlink\" title=\"3.1.4 \"></a>3.1.4 </h4><p></p>\n<p><code>CREATE TABLE T1(a,b,c);</code><br><code>INSERT INTO T1 VALUES(177,NULL,&#39;hello&#39;);</code></p>\n<table>\n    <tr>\n        <th style=\"color:grey\">Header size</th>\n        <th style=\"color:grey\">Type 1</th>\n        <th style=\"color:grey\">Type 2</th>\n        <th style=\"color:grey\">Type 3</th>\n        <th style=\"color:grey\" colspan=\"2\">Data 1</th>\n        <th style=\"color:grey\">Data 2</th>\n        <th style=\"color:grey\" colspan=\"5\">Data 3</th>\n    </tr>\n    <tr>\n        <th>04</th>\n        <th>02</th>\n        <th>00</th>\n        <th>17</th>\n        <th>00</th>\n        <th>B1</th>\n        <th></th>\n        <th>68</th>\n        <th>65</th>\n        <th>6C</th>\n        <th>6C</th>\n        <th>6F</th>\n    </tr>\n</table>\n\n<p>a,b,cintegerNULLTEXTNONEVM11(header+data)16</p>\n<ol>\n<li>Header440x04</li>\n<li>Type 12.</li>\n<li>Type 20.NULL</li>\n<li>Type 323.(23-13&#x2F;2&#x3D;)5</li>\n<li>Data 1200B1,117117B1-79177.</li>\n<li>Data 2NULL</li>\n<li>Data 3568 65 6C 6F0</li>\n</ol>\n<p><code>sqlite3_column_*</code>APISQLiteFLOAT( sqlite3_column_text)VM<code>sprintf()</code>VM</p>\n<p><strong></strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td> 0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof() C</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>atoi() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>atof() </td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<p>VM..</p>\n<h4 id=\"3-2-1-NULL\"><a href=\"#3-2-1-NULL\" class=\"headerlink\" title=\"3.2.1 NULL\"></a>3.2.1 NULL</h4><p>NULLNULLNULLNULLSQLNULLNULLNULLSQLiteDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"3-2-2-\"><a href=\"#3-2-2-\" class=\"headerlink\" title=\"3.2.2 \"></a>3.2.2 </h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;  !&#x3D;</li>\n<li> IN</li>\n<li> BETWEEN</li>\n</ul>\n<p></p>\n<ol>\n<li>NULLNULL</li>\n<li>INTEGERREALTEXTBLOBINTEGERREALINTEGERREAL</li>\n<li>TEXTBLOBTEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXTSQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code>&#x3D;(,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB)</code><code>INSERT INTO t1 VALUES(500500500)</code>a,b,cTEXTINTEGERTEXT</p>\n<ul>\n<li><code>SELECT a &lt; 60,a &lt; 40 FROM t1</code>60406040aTEXTTEXT<code>1|0</code>5006040</li>\n<li><code>SELECT b &lt; 60,b &lt; 600 FROM t1</code><code>0|1</code></li>\n<li><code>SELECT c &lt; 60,c &lt; 600 FROM t1</code>cNONENUMERIC500(TEXT)<code>0|0</code></li>\n</ul>\n<h4 id=\"3-2-3-\"><a href=\"#3-2-3-\" class=\"headerlink\" title=\"3.2.3 \"></a>3.2.3 </h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"3-2-4-ORDER-BY\"><a href=\"#3-2-4-ORDER-BY\" class=\"headerlink\" title=\"3.2.4 ORDER BY\"></a>3.2.4 ORDER BY</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"3-2-5-GROUP-BY\"><a href=\"#3-2-5-GROUP-BY\" class=\"headerlink\" title=\"3.2.5 GROUP BY\"></a>3.2.5 GROUP BY</h4><p>GROUP BYINTEGERREAL</p>\n<h4 id=\"3-2-6-SELECT\"><a href=\"#3-2-6-SELECT\" class=\"headerlink\" title=\"3.2.6 SELECT\"></a>3.2.6 SELECT</h4><p>SELECT(UNIONINTERSECTEXCEPT)SELECTSELECT</p>"},{"title":"SQLite--KeywordHash","date":"2020-07-15T16:00:00.000Z","_content":"\n> SQLite (3.27.2136)SQLTokenize()SQLiteSQLite\"\"SQLite\n\n<!-- more -->\n\n## SQLite\n\nSQLitecmakeautoconfigMakefileMakefile`keywordhash.h`Makefilecommand\n\n``` c\nkeywordhash.h:\t$(TOP)/tool/mkkeywordhash.c\n\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c\n\t./mkkeywordhash >keywordhash.h\n```\n\n`$(TOP)/tool/mkkeywordhash.c`command:`mkkeywordhash.c``keywordhash.h``keywordhash.h``mkkeywordhash`\n\n`keywordhash.h`:\n\n``` c\n** The code in this file has been automatically generated by\n**\n**   sqlite/tool/mkkeywordhash.c\n**\n** The code in this file implements a function that determines whether\n** or not a given identifier is really an SQL keyword.  The same thing\n** might be implemented more directly using a hand-written hash table.\n** But by using this automatically generated code, the size of the code\n** is substantially reduced.  This is important for embedded applications\n** on platforms with limited memory.\n```\n\nhand-written()SQLite\n\n## mkkeywordhash\n\nSQLiteSQLSQLite136`mkkeywordhash`:\n\n1. SQLite(mkkeywordhash)\n2. `mkkeywordhash`:`REINDEX``INDEXED``INDEX``REINDEX`\n3. SQLite**\n\n**SQLite\n\n`mkkeywordhash.c`SQLite:\n\n## mkkeywordhash.c\n\n### \n\n``` c\n/*\n** All the keywords of the SQL language are stored in a hash\n** table composed of instances of the following structure.\n*/\ntypedef struct Keyword Keyword;\nstruct Keyword {\n  char *zName;         /* The keyword name */\n  char *zTokenType;    /* Token value for this keyword */\n  int mask;            /* Code this keyword if non-zero */\n  int id;              /* Unique ID for this record */\n  int hash;            /* Hash on the keyword */\n  int offset;          /* Offset to start of name string */\n  int len;             /* Length of this keyword, not counting final \\000 */\n  int prefix;          /* Number of characters in prefix */\n  int longestSuffix;   /* Longest suffix that is a prefix on another word */\n  int iNext;           /* Index in aKeywordTable[] of next with same hash */\n  int substrId;        /* Id to another keyword this keyword is embedded in */\n  int substrOffset;    /* Offset into substrId for start of this keyword */\n  char zOrigName[20];  /* Original keyword name before processing */\n};\n```\n\n`mkkeywordhash.c``mkkeywordhash``KeyWord``keywordhash.h`\n\n* char *zName:             \n* char *zTokenType:      tokenize\n* int mask:              mask\n* int id:                idid\n* int hash:              \n* int offset:            \n* int len:               \n* int prefix:            \n* int longestSuffix:     \n* int iNext:             \n* int substrId:          substrIdId\n* int substrOffset:      substrIdsubstrOffset\n* char zOrigName[20]:    \n\n aKeywordTable \n\n``` c\nstatic Keyword aKeywordTable[] = {\n  { \"ABORT\",            \"TK_ABORT\",        CONFLICT|TRIGGER       },\n  { \"ACTION\",           \"TK_ACTION\",       FKEY                   },\n  { \"ADD\",              \"TK_ADD\",          ALTER                  },\n  { \"AFTER\",            \"TK_AFTER\",        TRIGGER                },\n  /* ... 136 ... */\n};\n```\n\n### \n\n`mkkeywordhash`:\n\n### \n\n`mkkeywordhash` main\n\n aKeywordTable  `Keyword` maskmasktagmaskmaskmaskmaskSQLitemask\n\n``` c\n#ifdef SQLITE_OMIT_ALTERTABLE\n#  define ALTER      0\n#else\n#  define ALTER      0x00000001\n#endif\n```\n\n`SQLITE_OMIT_ALTERTABLE``ALTER`0`ALTER`maskmask0\n\n``` c\n/* Remove entries from the list of keywords that have mask==0 */\nfor(i=j=0; i<nKeyword; i++){\n    if( aKeywordTable[i].mask==0 ) continue;\n    if( j<i ){\n      aKeywordTable[j] = aKeywordTable[i];\n    }\n    j++;\n}\nnKeyword = j;\n```\n akeywordTable mask0\n\n### \n\n``` c\nfor(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    p->len = (int)strlen(p->zName);\n    assert( p->len<sizeof(p->zOrigName) );\n    memcpy(p->zOrigName, p->zName, p->len+1);\n    totalLen += p->len;\n    p->hash = (charMap(p->zName[0])*4) ^\n              (charMap(p->zName[p->len-1])*3) ^ (p->len*1);\n    p->id = i+1;\n}\n```\n\naKeywordTablenKeywordSQLite\n\n* id\n* p->len \n* p->zOrigName  p->zName \n* :(*4)^(*3)^()) aKeywordTable\n\n### \n\nABABAB\n\n``` c\n/* Sort the table from shortest to longest keyword */\n/*  */\nqsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare1);\n\n/* Look for short keywords embedded in longer keywords */\n/* ,ININDEXINDEXINDEXED*/\nfor(i=nKeyword-2; i>=0; i--){//\n    Keyword *p = &aKeywordTable[i];//p: \n    for(j=nKeyword-1; j>i && p->substrId==0; j--){//()\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->substrId ) continue;\n        if( pOther->len<=p->len ) continue;\n\n        // p  pOther \n        for(k=0; k<=pOther->len-p->len; k++){\n            if( memcmp(p->zName, &pOther->zName[k], p->len)==0 ){\n                p->substrId = pOther->id;\n                p->substrOffset = k;\n                break;\n            }\n        }\n    }\n}\n```\n\n* ABAB\n* ABAsubstrIdBIdAsubstrOffset\n\n### \n\n``` c\n  /* Compute the longestSuffix value for every word */\n  /* \n     */\n  for(i=0; i<nKeyword; i++){//\n    Keyword *p = &aKeywordTable[i];\n    if( p->substrId ) continue;//\n    for(j=0; j<nKeyword; j++){//\n      Keyword *pOther;\n      if( j==i ) continue;//\n      pOther = &aKeywordTable[j];\n      if( pOther->substrId ) continue;//\n\n      // p  pOther \n      for(k=p->longestSuffix+1; k<p->len && k<pOther->len; k++){\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p->longestSuffix = k;\n        }\n      }\n    }\n  }\n\n    /* Sort the table into reverse order by length */\n    /*    */\n    qsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare2);\n```\n\n\n\n### \n\n``` c\n  /* Fill in the offset for all entries */\n  nChar = 0;\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    if( p->offset>0 || p->substrId ) continue;\n    p->offset = nChar;\n    nChar += p->len;\n    for(k=p->len-1; k>=1; k--){\n      for(j=i+1; j<nKeyword; j++){\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->offset>0 || pOther->substrId ) continue;\n        if( pOther->len<=k ) continue;\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p = pOther;\n          p->offset = nChar - k;\n          nChar = p->offset + p->len;\n          p->zName += k;\n          p->len -= k;\n          p->prefix = k;\n          j = i;\n          k = p->len;\n        }\n      }\n    }\n  }\n\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    //subStrId\n    if( p->substrId ){\n      p->offset = findById(p->substrId)->offset + p->substrOffset;\n    }\n  }\n```\n\n: \n\n:`abcde``def``efg`,`def``de``abcde``f`3\n\n\n\n:\n1. \n2. (`k=p->len-1`)break\n\n\n\n\n* SQLiteSQLite\n* `p = pOther;`ppOtherpOther\n* check(i==nKeyword)\n\n### \n\n****\n\nsize\n\nSQLitebestCountscore()\n\n  * 1+ * 2 1+2=1SQLite\n\n\n\n``` c\n  /* Figure out how big to make the hash table in order to minimize the\n  ** number of collisions */\n  /*  */\n  // SQLite  [nKeyword, 2*nKeyword]\n  // \n  bestSize = nKeyword;\n  bestCount = nKeyword*nKeyword;\n  for(i=nKeyword/2; i<=2*nKeyword; i++){\n    for(j=0; j<i; j++) aKWHash[j] = 0;\n    for(j=0; j<nKeyword; j++){\n      h = aKeywordTable[j].hash % i;\n      aKWHash[h] *= 2;\n      aKWHash[h]++;\n    }\n    for(j=count=0; j<i; j++) count += aKWHash[j];\n    if( count<bestCount ){\n      bestCount = count;\n      bestSize = i;\n    }\n  }\n```\n\nSQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount\n\n\n\n1. aKWHash0\n2. \n3. *2 + 111*2+1=33*2+1=7\n4. aKWHashaKWHash\"score\"\n5. [nKeyword, 2 x nKeyword]\"score\"\n\n\n x2 \"\" x2 \"score\"2 \"\" 345...\n\n`keywordhash.h``Hash score`, (3.27.2) 2 `Hash score`*208*\n\n### \n\n``` c\n/* Compute the hash */\n  for(i=0; i<bestSize; i++) aKWHash[i] = 0;\n  for(i=0; i<nKeyword; i++) {\n    //..\n    h = aKeywordTable[i].hash % bestSize;\n    aKeywordTable[i].iNext = aKWHash[h];\n    aKWHash[h] = i+1;\n  }\n```\n\nbestSize -> bestCount -> \n\n+1`iNext`next\n\n......\n\n`aKeywordTable`N\n\n`zKWText`: `aKeywordTable``KeyWord``zName`\n`aKWHash`: ()\n`aKWNext`: \n`aKWLen` : i\n`aKWOffset` : `zKWText`\n`aKWCode` : `parser`\n\n\n## (keywordCode)\n\n`keywordCode(const char *z, int n, int *pType)`\n\n``` c\n/* Check to see if z[0..n-1] is a keyword. If it is, write the\n** parser symbol code for that keyword into *pType.  Always\n** return the integer n (the length of the token). */\nstatic int keywordCode(const char *z, int n, int *pType){\n  int i, j;\n  const char *zKW;\n  if( n>=2 ){\n    i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127;//\n    for(i=((int)aKWHash[i])-1; i>=0; i=((int)aKWNext[i])-1){\n      if( aKWLen[i]!=n ) continue;\n      j = 0;\n      zKW = &zKWText[aKWOffset[i]];\n#ifdef SQLITE_ASCII\n      while( j<n && (z[j]&~0x20)==zKW[j] ){ j++; }\n#endif\n#ifdef SQLITE_EBCDIC\n      while( j<n && toupper(z[j])==zKW[j] ){ j++; }\n#endif\n      if( j<n ) continue;\n      testcase( i==0 ); /* REINDEX */\n      testcase( i==1 ); /* INDEXED */\n    //   ......\n      testcase( i==135 ); /* PRIMARY */\n      *pType = aKWCode[i];\n      break;\n    }\n  }\n  return n;\n}\n```\n\n:(`parser`)n\n\n1. 2\n2. `i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127`127\n3. aKWHash[i]aKWNext\n4. \n5. zKWText\n6. 3\n","source":"_posts/19.SQLite-KeywordHash.md","raw":"---\ntitle: SQLite--KeywordHash\ndate: 2020-07-16\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLite (3.27.2136)SQLTokenize()SQLiteSQLite\"\"SQLite\n\n<!-- more -->\n\n## SQLite\n\nSQLitecmakeautoconfigMakefileMakefile`keywordhash.h`Makefilecommand\n\n``` c\nkeywordhash.h:\t$(TOP)/tool/mkkeywordhash.c\n\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c\n\t./mkkeywordhash >keywordhash.h\n```\n\n`$(TOP)/tool/mkkeywordhash.c`command:`mkkeywordhash.c``keywordhash.h``keywordhash.h``mkkeywordhash`\n\n`keywordhash.h`:\n\n``` c\n** The code in this file has been automatically generated by\n**\n**   sqlite/tool/mkkeywordhash.c\n**\n** The code in this file implements a function that determines whether\n** or not a given identifier is really an SQL keyword.  The same thing\n** might be implemented more directly using a hand-written hash table.\n** But by using this automatically generated code, the size of the code\n** is substantially reduced.  This is important for embedded applications\n** on platforms with limited memory.\n```\n\nhand-written()SQLite\n\n## mkkeywordhash\n\nSQLiteSQLSQLite136`mkkeywordhash`:\n\n1. SQLite(mkkeywordhash)\n2. `mkkeywordhash`:`REINDEX``INDEXED``INDEX``REINDEX`\n3. SQLite**\n\n**SQLite\n\n`mkkeywordhash.c`SQLite:\n\n## mkkeywordhash.c\n\n### \n\n``` c\n/*\n** All the keywords of the SQL language are stored in a hash\n** table composed of instances of the following structure.\n*/\ntypedef struct Keyword Keyword;\nstruct Keyword {\n  char *zName;         /* The keyword name */\n  char *zTokenType;    /* Token value for this keyword */\n  int mask;            /* Code this keyword if non-zero */\n  int id;              /* Unique ID for this record */\n  int hash;            /* Hash on the keyword */\n  int offset;          /* Offset to start of name string */\n  int len;             /* Length of this keyword, not counting final \\000 */\n  int prefix;          /* Number of characters in prefix */\n  int longestSuffix;   /* Longest suffix that is a prefix on another word */\n  int iNext;           /* Index in aKeywordTable[] of next with same hash */\n  int substrId;        /* Id to another keyword this keyword is embedded in */\n  int substrOffset;    /* Offset into substrId for start of this keyword */\n  char zOrigName[20];  /* Original keyword name before processing */\n};\n```\n\n`mkkeywordhash.c``mkkeywordhash``KeyWord``keywordhash.h`\n\n* char *zName:             \n* char *zTokenType:      tokenize\n* int mask:              mask\n* int id:                idid\n* int hash:              \n* int offset:            \n* int len:               \n* int prefix:            \n* int longestSuffix:     \n* int iNext:             \n* int substrId:          substrIdId\n* int substrOffset:      substrIdsubstrOffset\n* char zOrigName[20]:    \n\n aKeywordTable \n\n``` c\nstatic Keyword aKeywordTable[] = {\n  { \"ABORT\",            \"TK_ABORT\",        CONFLICT|TRIGGER       },\n  { \"ACTION\",           \"TK_ACTION\",       FKEY                   },\n  { \"ADD\",              \"TK_ADD\",          ALTER                  },\n  { \"AFTER\",            \"TK_AFTER\",        TRIGGER                },\n  /* ... 136 ... */\n};\n```\n\n### \n\n`mkkeywordhash`:\n\n### \n\n`mkkeywordhash` main\n\n aKeywordTable  `Keyword` maskmasktagmaskmaskmaskmaskSQLitemask\n\n``` c\n#ifdef SQLITE_OMIT_ALTERTABLE\n#  define ALTER      0\n#else\n#  define ALTER      0x00000001\n#endif\n```\n\n`SQLITE_OMIT_ALTERTABLE``ALTER`0`ALTER`maskmask0\n\n``` c\n/* Remove entries from the list of keywords that have mask==0 */\nfor(i=j=0; i<nKeyword; i++){\n    if( aKeywordTable[i].mask==0 ) continue;\n    if( j<i ){\n      aKeywordTable[j] = aKeywordTable[i];\n    }\n    j++;\n}\nnKeyword = j;\n```\n akeywordTable mask0\n\n### \n\n``` c\nfor(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    p->len = (int)strlen(p->zName);\n    assert( p->len<sizeof(p->zOrigName) );\n    memcpy(p->zOrigName, p->zName, p->len+1);\n    totalLen += p->len;\n    p->hash = (charMap(p->zName[0])*4) ^\n              (charMap(p->zName[p->len-1])*3) ^ (p->len*1);\n    p->id = i+1;\n}\n```\n\naKeywordTablenKeywordSQLite\n\n* id\n* p->len \n* p->zOrigName  p->zName \n* :(*4)^(*3)^()) aKeywordTable\n\n### \n\nABABAB\n\n``` c\n/* Sort the table from shortest to longest keyword */\n/*  */\nqsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare1);\n\n/* Look for short keywords embedded in longer keywords */\n/* ,ININDEXINDEXINDEXED*/\nfor(i=nKeyword-2; i>=0; i--){//\n    Keyword *p = &aKeywordTable[i];//p: \n    for(j=nKeyword-1; j>i && p->substrId==0; j--){//()\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->substrId ) continue;\n        if( pOther->len<=p->len ) continue;\n\n        // p  pOther \n        for(k=0; k<=pOther->len-p->len; k++){\n            if( memcmp(p->zName, &pOther->zName[k], p->len)==0 ){\n                p->substrId = pOther->id;\n                p->substrOffset = k;\n                break;\n            }\n        }\n    }\n}\n```\n\n* ABAB\n* ABAsubstrIdBIdAsubstrOffset\n\n### \n\n``` c\n  /* Compute the longestSuffix value for every word */\n  /* \n     */\n  for(i=0; i<nKeyword; i++){//\n    Keyword *p = &aKeywordTable[i];\n    if( p->substrId ) continue;//\n    for(j=0; j<nKeyword; j++){//\n      Keyword *pOther;\n      if( j==i ) continue;//\n      pOther = &aKeywordTable[j];\n      if( pOther->substrId ) continue;//\n\n      // p  pOther \n      for(k=p->longestSuffix+1; k<p->len && k<pOther->len; k++){\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p->longestSuffix = k;\n        }\n      }\n    }\n  }\n\n    /* Sort the table into reverse order by length */\n    /*    */\n    qsort(aKeywordTable, nKeyword, sizeof(aKeywordTable[0]), keywordCompare2);\n```\n\n\n\n### \n\n``` c\n  /* Fill in the offset for all entries */\n  nChar = 0;\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    if( p->offset>0 || p->substrId ) continue;\n    p->offset = nChar;\n    nChar += p->len;\n    for(k=p->len-1; k>=1; k--){\n      for(j=i+1; j<nKeyword; j++){\n        Keyword *pOther = &aKeywordTable[j];\n        if( pOther->offset>0 || pOther->substrId ) continue;\n        if( pOther->len<=k ) continue;\n        if( memcmp(&p->zName[p->len-k], pOther->zName, k)==0 ){\n          p = pOther;\n          p->offset = nChar - k;\n          nChar = p->offset + p->len;\n          p->zName += k;\n          p->len -= k;\n          p->prefix = k;\n          j = i;\n          k = p->len;\n        }\n      }\n    }\n  }\n\n  for(i=0; i<nKeyword; i++){\n    Keyword *p = &aKeywordTable[i];\n    //subStrId\n    if( p->substrId ){\n      p->offset = findById(p->substrId)->offset + p->substrOffset;\n    }\n  }\n```\n\n: \n\n:`abcde``def``efg`,`def``de``abcde``f`3\n\n\n\n:\n1. \n2. (`k=p->len-1`)break\n\n\n\n\n* SQLiteSQLite\n* `p = pOther;`ppOtherpOther\n* check(i==nKeyword)\n\n### \n\n****\n\nsize\n\nSQLitebestCountscore()\n\n  * 1+ * 2 1+2=1SQLite\n\n\n\n``` c\n  /* Figure out how big to make the hash table in order to minimize the\n  ** number of collisions */\n  /*  */\n  // SQLite  [nKeyword, 2*nKeyword]\n  // \n  bestSize = nKeyword;\n  bestCount = nKeyword*nKeyword;\n  for(i=nKeyword/2; i<=2*nKeyword; i++){\n    for(j=0; j<i; j++) aKWHash[j] = 0;\n    for(j=0; j<nKeyword; j++){\n      h = aKeywordTable[j].hash % i;\n      aKWHash[h] *= 2;\n      aKWHash[h]++;\n    }\n    for(j=count=0; j<i; j++) count += aKWHash[j];\n    if( count<bestCount ){\n      bestCount = count;\n      bestSize = i;\n    }\n  }\n```\n\nSQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount\n\n\n\n1. aKWHash0\n2. \n3. *2 + 111*2+1=33*2+1=7\n4. aKWHashaKWHash\"score\"\n5. [nKeyword, 2 x nKeyword]\"score\"\n\n\n x2 \"\" x2 \"score\"2 \"\" 345...\n\n`keywordhash.h``Hash score`, (3.27.2) 2 `Hash score`*208*\n\n### \n\n``` c\n/* Compute the hash */\n  for(i=0; i<bestSize; i++) aKWHash[i] = 0;\n  for(i=0; i<nKeyword; i++) {\n    //..\n    h = aKeywordTable[i].hash % bestSize;\n    aKeywordTable[i].iNext = aKWHash[h];\n    aKWHash[h] = i+1;\n  }\n```\n\nbestSize -> bestCount -> \n\n+1`iNext`next\n\n......\n\n`aKeywordTable`N\n\n`zKWText`: `aKeywordTable``KeyWord``zName`\n`aKWHash`: ()\n`aKWNext`: \n`aKWLen` : i\n`aKWOffset` : `zKWText`\n`aKWCode` : `parser`\n\n\n## (keywordCode)\n\n`keywordCode(const char *z, int n, int *pType)`\n\n``` c\n/* Check to see if z[0..n-1] is a keyword. If it is, write the\n** parser symbol code for that keyword into *pType.  Always\n** return the integer n (the length of the token). */\nstatic int keywordCode(const char *z, int n, int *pType){\n  int i, j;\n  const char *zKW;\n  if( n>=2 ){\n    i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127;//\n    for(i=((int)aKWHash[i])-1; i>=0; i=((int)aKWNext[i])-1){\n      if( aKWLen[i]!=n ) continue;\n      j = 0;\n      zKW = &zKWText[aKWOffset[i]];\n#ifdef SQLITE_ASCII\n      while( j<n && (z[j]&~0x20)==zKW[j] ){ j++; }\n#endif\n#ifdef SQLITE_EBCDIC\n      while( j<n && toupper(z[j])==zKW[j] ){ j++; }\n#endif\n      if( j<n ) continue;\n      testcase( i==0 ); /* REINDEX */\n      testcase( i==1 ); /* INDEXED */\n    //   ......\n      testcase( i==135 ); /* PRIMARY */\n      *pType = aKWCode[i];\n      break;\n    }\n  }\n  return n;\n}\n```\n\n:(`parser`)n\n\n1. 2\n2. `i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127`127\n3. aKWHash[i]aKWNext\n4. \n5. zKWText\n6. 3\n","slug":"19.SQLite-KeywordHash","published":1,"updated":"2020-08-29T14:42:58.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l3000i93c999cn8w1v","content":"<blockquote>\n<p>SQLite (3.27.2136)SQLTokenize()SQLiteSQLiteSQLite</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h2><p>SQLitecmakeautoconfigMakefileMakefile<code>keywordhash.h</code>Makefilecommand</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">keywordhash.h:\t$(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t./mkkeywordhash &gt;keywordhash.h</span><br></pre></td></tr></table></figure>\n\n<p><code>$(TOP)/tool/mkkeywordhash.c</code>command:<code>mkkeywordhash.c</code><code>keywordhash.h</code><code>keywordhash.h</code><code>mkkeywordhash</code></p>\n<p><code>keywordhash.h</code>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">** The code in this file has been automatically generated by</span><br><span class=\"line\">**</span><br><span class=\"line\">**   sqlite/tool/mkkeywordhash.c</span><br><span class=\"line\">**</span><br><span class=\"line\">** The code in this file implements a function that determines whether</span><br><span class=\"line\">** or not a given identifier is really an SQL keyword.  The same thing</span><br><span class=\"line\">** might be implemented more directly using a hand-written hash table.</span><br><span class=\"line\">** But by using this automatically generated code, the size of the code</span><br><span class=\"line\">** is substantially reduced.  This is important <span class=\"keyword\">for</span> embedded applications</span><br><span class=\"line\">** on platforms with limited memory.</span><br></pre></td></tr></table></figure>\n\n<p>hand-written()SQLite</p>\n<h2 id=\"mkkeywordhash\"><a href=\"#mkkeywordhash\" class=\"headerlink\" title=\"mkkeywordhash\"></a>mkkeywordhash</h2><p>SQLiteSQLSQLite136<code>mkkeywordhash</code>:</p>\n<ol>\n<li>SQLite(mkkeywordhash)</li>\n<li><code>mkkeywordhash</code>:<code>REINDEX</code><code>INDEXED</code><code>INDEX</code><code>REINDEX</code></li>\n<li>SQLite<em></em></li>\n</ol>\n<p><em></em>SQLite</p>\n<p><code>mkkeywordhash.c</code>SQLite:</p>\n<h2 id=\"mkkeywordhash-c\"><a href=\"#mkkeywordhash-c\" class=\"headerlink\" title=\"mkkeywordhash.c\"></a>mkkeywordhash.c</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** All the keywords of the SQL language are stored in a hash</span></span><br><span class=\"line\"><span class=\"comment\">** table composed of instances of the following structure.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> <span class=\"title\">Keyword</span>;</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> &#123;</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zName;         <span class=\"comment\">/* The keyword name */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zTokenType;    <span class=\"comment\">/* Token value for this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mask;            <span class=\"comment\">/* Code this keyword if non-zero */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> id;              <span class=\"comment\">/* Unique ID for this record */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hash;            <span class=\"comment\">/* Hash on the keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> offset;          <span class=\"comment\">/* Offset to start of name string */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> len;             <span class=\"comment\">/* Length of this keyword, not counting final \\000 */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> prefix;          <span class=\"comment\">/* Number of characters in prefix */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> longestSuffix;   <span class=\"comment\">/* Longest suffix that is a prefix on another word */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> iNext;           <span class=\"comment\">/* Index in aKeywordTable[] of next with same hash */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrId;        <span class=\"comment\">/* Id to another keyword this keyword is embedded in */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrOffset;    <span class=\"comment\">/* Offset into substrId for start of this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> zOrigName[<span class=\"number\">20</span>];  <span class=\"comment\">/* Original keyword name before processing */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><code>mkkeywordhash.c</code><code>mkkeywordhash</code><code>KeyWord</code><code>keywordhash.h</code></p>\n<ul>\n<li>char *zName:             </li>\n<li>char *zTokenType:      tokenize</li>\n<li>int mask:              mask</li>\n<li>int id:                idid</li>\n<li>int hash:              </li>\n<li>int offset:            </li>\n<li>int len:               </li>\n<li>int prefix:            </li>\n<li>int longestSuffix:     </li>\n<li>int iNext:             </li>\n<li>int substrId:          substrIdId</li>\n<li>int substrOffset:      substrIdsubstrOffset</li>\n<li>char zOrigName[20]:    </li>\n</ul>\n<p> aKeywordTable </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> Keyword aKeywordTable[] = &#123;</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ABORT&quot;</span>,            <span class=\"string\">&quot;TK_ABORT&quot;</span>,        CONFLICT|TRIGGER       &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ACTION&quot;</span>,           <span class=\"string\">&quot;TK_ACTION&quot;</span>,       FKEY                   &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ADD&quot;</span>,              <span class=\"string\">&quot;TK_ADD&quot;</span>,          ALTER                  &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;AFTER&quot;</span>,            <span class=\"string\">&quot;TK_AFTER&quot;</span>,        TRIGGER                &#125;,</span><br><span class=\"line\">  <span class=\"comment\">/* ... 136 ... */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code> main</p>\n<p> aKeywordTable  <code>Keyword</code> maskmasktagmaskmaskmaskmaskSQLitemask</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_OMIT_ALTERTABLE</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0x00000001</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n\n<p><code>SQLITE_OMIT_ALTERTABLE</code><code>ALTER</code>0<code>ALTER</code>maskmask0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Remove entries from the list of keywords that have mask==0 */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=j=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( aKeywordTable[i].mask==<span class=\"number\">0</span> ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j&lt;i )&#123;</span><br><span class=\"line\">      aKeywordTable[j] = aKeywordTable[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    j++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">nKeyword = j;</span><br></pre></td></tr></table></figure>\n<p> akeywordTable mask0</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">    p-&gt;len = (<span class=\"type\">int</span>)<span class=\"built_in\">strlen</span>(p-&gt;zName);</span><br><span class=\"line\">    assert( p-&gt;len&lt;<span class=\"keyword\">sizeof</span>(p-&gt;zOrigName) );</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(p-&gt;zOrigName, p-&gt;zName, p-&gt;len+<span class=\"number\">1</span>);</span><br><span class=\"line\">    totalLen += p-&gt;len;</span><br><span class=\"line\">    p-&gt;hash = (charMap(p-&gt;zName[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^</span><br><span class=\"line\">              (charMap(p-&gt;zName[p-&gt;len<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ (p-&gt;len*<span class=\"number\">1</span>);</span><br><span class=\"line\">    p-&gt;id = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>aKeywordTablenKeywordSQLite</p>\n<ul>\n<li>id</li>\n<li>p-&gt;len </li>\n<li>p-&gt;zOrigName  p-&gt;zName </li>\n<li>:(<em>4)^(</em>3)^()) aKeywordTable</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ABABAB</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Sort the table from shortest to longest keyword */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\">qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare1);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Look for short keywords embedded in longer keywords */</span></span><br><span class=\"line\"><span class=\"comment\">/* ,ININDEXINDEXINDEXED*/</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword<span class=\"number\">-2</span>; i&gt;=<span class=\"number\">0</span>; i--)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];<span class=\"comment\">//p: </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=nKeyword<span class=\"number\">-1</span>; j&gt;i &amp;&amp; p-&gt;substrId==<span class=\"number\">0</span>; j--)&#123;<span class=\"comment\">//()</span></span><br><span class=\"line\">        Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=p-&gt;len ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(k=<span class=\"number\">0</span>; k&lt;=pOther-&gt;len-p-&gt;len; k++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(p-&gt;zName, &amp;pOther-&gt;zName[k], p-&gt;len)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">                p-&gt;substrId = pOther-&gt;id;</span><br><span class=\"line\">                p-&gt;substrOffset = k;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ABAB</li>\n<li>ABAsubstrIdBIdAsubstrOffset</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the longestSuffix value for every word */</span></span><br><span class=\"line\"><span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *pOther;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j==i ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(k=p-&gt;longestSuffix+<span class=\"number\">1</span>; k&lt;p-&gt;len &amp;&amp; k&lt;pOther-&gt;len; k++)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p-&gt;longestSuffix = k;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Sort the table into reverse order by length */</span></span><br><span class=\"line\">  <span class=\"comment\">/*    */</span></span><br><span class=\"line\">  qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare2);</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Fill in the offset for all entries */</span></span><br><span class=\"line\">nChar = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;offset&gt;<span class=\"number\">0</span> || p-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">  p-&gt;offset = nChar;</span><br><span class=\"line\">  nChar += p-&gt;len;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(k=p-&gt;len<span class=\"number\">-1</span>; k&gt;=<span class=\"number\">1</span>; k--)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=i+<span class=\"number\">1</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">      Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;offset&gt;<span class=\"number\">0</span> || pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=k ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p = pOther;</span><br><span class=\"line\">        p-&gt;offset = nChar - k;</span><br><span class=\"line\">        nChar = p-&gt;offset + p-&gt;len;</span><br><span class=\"line\">        p-&gt;zName += k;</span><br><span class=\"line\">        p-&gt;len -= k;</span><br><span class=\"line\">        p-&gt;prefix = k;</span><br><span class=\"line\">        j = i;</span><br><span class=\"line\">        k = p-&gt;len;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"comment\">//subStrId</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId )&#123;</span><br><span class=\"line\">    p-&gt;offset = findById(p-&gt;substrId)-&gt;offset + p-&gt;substrOffset;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>: </p>\n<p>:<code>abcde``def``efg</code>,<code>def</code><code>de</code><code>abcde</code><code>f</code>3</p>\n<p></p>\n<p>:</p>\n<ol>\n<li></li>\n<li>(<code>k=p-&gt;len-1</code>)break</li>\n</ol>\n<p></p>\n<ul>\n<li>SQLiteSQLite</li>\n<li><code>p = pOther;</code>ppOtherpOther</li>\n<li>check(i&#x3D;&#x3D;nKeyword)</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><em></em><em></em></p>\n<p>size</p>\n<p>SQLitebestCountscore()</p>\n<p>  * 1+ * 2 1+2&#x3D;1SQLite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Figure out how big to make the hash table in order to minimize the</span></span><br><span class=\"line\"><span class=\"comment\">** number of collisions */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\"><span class=\"comment\">// SQLite  [nKeyword, 2*nKeyword]</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\">bestSize = nKeyword;</span><br><span class=\"line\">bestCount = nKeyword*nKeyword;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword/<span class=\"number\">2</span>; i&lt;=<span class=\"number\">2</span>*nKeyword; i++)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;i; j++) aKWHash[j] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">    h = aKeywordTable[j].hash % i;</span><br><span class=\"line\">    aKWHash[h] *= <span class=\"number\">2</span>;</span><br><span class=\"line\">    aKWHash[h]++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=count=<span class=\"number\">0</span>; j&lt;i; j++) count += aKWHash[j];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( count&lt;bestCount )&#123;</span><br><span class=\"line\">    bestCount = count;</span><br><span class=\"line\">    bestSize = i;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>SQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount</p>\n<p></p>\n<ol>\n<li>aKWHash0</li>\n<li></li>\n<li><em>2 + 111</em>2+1&#x3D;33*2+1&#x3D;7</li>\n<li>aKWHashaKWHashscore</li>\n<li>[nKeyword, 2 x nKeyword]score</li>\n</ol>\n<p> x2  x2 score2  345</p>\n<p><code>keywordhash.h</code><code>Hash score</code>, (3.27.2) 2 <code>Hash score</code><em>208</em></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the hash */</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;bestSize; i++) aKWHash[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//..</span></span><br><span class=\"line\">    h = aKeywordTable[i].hash % bestSize;</span><br><span class=\"line\">    aKeywordTable[i].iNext = aKWHash[h];</span><br><span class=\"line\">    aKWHash[h] = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>bestSize -&gt; bestCount -&gt; </p>\n<p>+1<code>iNext</code>next</p>\n<p></p>\n<p><code>aKeywordTable</code>N</p>\n<p><code>zKWText</code>: <code>aKeywordTable</code><code>KeyWord</code><code>zName</code><br><code>aKWHash</code>: ()<br><code>aKWNext</code>: <br><code>aKWLen</code> : i<br><code>aKWOffset</code> : <code>zKWText</code><br><code>aKWCode</code> : <code>parser</code></p>\n<h2 id=\"-keywordCode\"><a href=\"#-keywordCode\" class=\"headerlink\" title=\"(keywordCode)\"></a>(keywordCode)</h2><p><code>keywordCode(const char *z, int n, int *pType)</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Check to see if z[0..n-1] is a keyword. If it is, write the</span></span><br><span class=\"line\"><span class=\"comment\">** parser symbol code for that keyword into *pType.  Always</span></span><br><span class=\"line\"><span class=\"comment\">** return the integer n (the length of the token). */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">keywordCode</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> n, <span class=\"type\">int</span> *pType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, j;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *zKW;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( n&gt;=<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">    i = ((charMap(z[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^ (charMap(z[n<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ n) % <span class=\"number\">127</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=((<span class=\"type\">int</span>)aKWHash[i])<span class=\"number\">-1</span>; i&gt;=<span class=\"number\">0</span>; i=((<span class=\"type\">int</span>)aKWNext[i])<span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( aKWLen[i]!=n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      j = <span class=\"number\">0</span>;</span><br><span class=\"line\">      zKW = &amp;zKWText[aKWOffset[i]];</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; (z[j]&amp;~<span class=\"number\">0x20</span>)==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_EBCDIC</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; <span class=\"built_in\">toupper</span>(z[j])==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>( j&lt;n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      testcase( i==<span class=\"number\">0</span> ); <span class=\"comment\">/* REINDEX */</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">1</span> ); <span class=\"comment\">/* INDEXED */</span></span><br><span class=\"line\">    <span class=\"comment\">//   ......</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">135</span> ); <span class=\"comment\">/* PRIMARY */</span></span><br><span class=\"line\">      *pType = aKWCode[i];</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>:(<code>parser</code>)n</p>\n<ol>\n<li>2</li>\n<li><code>i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127</code>127</li>\n<li>aKWHash[i]aKWNext</li>\n<li></li>\n<li>zKWText</li>\n<li>3</li>\n</ol>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLite (3.27.2136)SQLTokenize()SQLiteSQLiteSQLite</p>\n</blockquote>","more":"<h2 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h2><p>SQLitecmakeautoconfigMakefileMakefile<code>keywordhash.h</code>Makefilecommand</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">keywordhash.h:\t$(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t$(BCC) -o mkkeywordhash $(OPTS) $(TOP)/tool/mkkeywordhash.c</span><br><span class=\"line\">\t./mkkeywordhash &gt;keywordhash.h</span><br></pre></td></tr></table></figure>\n\n<p><code>$(TOP)/tool/mkkeywordhash.c</code>command:<code>mkkeywordhash.c</code><code>keywordhash.h</code><code>keywordhash.h</code><code>mkkeywordhash</code></p>\n<p><code>keywordhash.h</code>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">** The code in this file has been automatically generated by</span><br><span class=\"line\">**</span><br><span class=\"line\">**   sqlite/tool/mkkeywordhash.c</span><br><span class=\"line\">**</span><br><span class=\"line\">** The code in this file implements a function that determines whether</span><br><span class=\"line\">** or not a given identifier is really an SQL keyword.  The same thing</span><br><span class=\"line\">** might be implemented more directly using a hand-written hash table.</span><br><span class=\"line\">** But by using this automatically generated code, the size of the code</span><br><span class=\"line\">** is substantially reduced.  This is important <span class=\"keyword\">for</span> embedded applications</span><br><span class=\"line\">** on platforms with limited memory.</span><br></pre></td></tr></table></figure>\n\n<p>hand-written()SQLite</p>\n<h2 id=\"mkkeywordhash\"><a href=\"#mkkeywordhash\" class=\"headerlink\" title=\"mkkeywordhash\"></a>mkkeywordhash</h2><p>SQLiteSQLSQLite136<code>mkkeywordhash</code>:</p>\n<ol>\n<li>SQLite(mkkeywordhash)</li>\n<li><code>mkkeywordhash</code>:<code>REINDEX</code><code>INDEXED</code><code>INDEX</code><code>REINDEX</code></li>\n<li>SQLite<em></em></li>\n</ol>\n<p><em></em>SQLite</p>\n<p><code>mkkeywordhash.c</code>SQLite:</p>\n<h2 id=\"mkkeywordhash-c\"><a href=\"#mkkeywordhash-c\" class=\"headerlink\" title=\"mkkeywordhash.c\"></a>mkkeywordhash.c</h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** All the keywords of the SQL language are stored in a hash</span></span><br><span class=\"line\"><span class=\"comment\">** table composed of instances of the following structure.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> <span class=\"title\">Keyword</span>;</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Keyword</span> &#123;</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zName;         <span class=\"comment\">/* The keyword name */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> *zTokenType;    <span class=\"comment\">/* Token value for this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mask;            <span class=\"comment\">/* Code this keyword if non-zero */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> id;              <span class=\"comment\">/* Unique ID for this record */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> hash;            <span class=\"comment\">/* Hash on the keyword */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> offset;          <span class=\"comment\">/* Offset to start of name string */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> len;             <span class=\"comment\">/* Length of this keyword, not counting final \\000 */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> prefix;          <span class=\"comment\">/* Number of characters in prefix */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> longestSuffix;   <span class=\"comment\">/* Longest suffix that is a prefix on another word */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> iNext;           <span class=\"comment\">/* Index in aKeywordTable[] of next with same hash */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrId;        <span class=\"comment\">/* Id to another keyword this keyword is embedded in */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> substrOffset;    <span class=\"comment\">/* Offset into substrId for start of this keyword */</span></span><br><span class=\"line\">  <span class=\"type\">char</span> zOrigName[<span class=\"number\">20</span>];  <span class=\"comment\">/* Original keyword name before processing */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><code>mkkeywordhash.c</code><code>mkkeywordhash</code><code>KeyWord</code><code>keywordhash.h</code></p>\n<ul>\n<li>char *zName:             </li>\n<li>char *zTokenType:      tokenize</li>\n<li>int mask:              mask</li>\n<li>int id:                idid</li>\n<li>int hash:              </li>\n<li>int offset:            </li>\n<li>int len:               </li>\n<li>int prefix:            </li>\n<li>int longestSuffix:     </li>\n<li>int iNext:             </li>\n<li>int substrId:          substrIdId</li>\n<li>int substrOffset:      substrIdsubstrOffset</li>\n<li>char zOrigName[20]:    </li>\n</ul>\n<p> aKeywordTable </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">static</span> Keyword aKeywordTable[] = &#123;</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ABORT&quot;</span>,            <span class=\"string\">&quot;TK_ABORT&quot;</span>,        CONFLICT|TRIGGER       &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ACTION&quot;</span>,           <span class=\"string\">&quot;TK_ACTION&quot;</span>,       FKEY                   &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;ADD&quot;</span>,              <span class=\"string\">&quot;TK_ADD&quot;</span>,          ALTER                  &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;AFTER&quot;</span>,            <span class=\"string\">&quot;TK_AFTER&quot;</span>,        TRIGGER                &#125;,</span><br><span class=\"line\">  <span class=\"comment\">/* ... 136 ... */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>mkkeywordhash</code> main</p>\n<p> aKeywordTable  <code>Keyword</code> maskmasktagmaskmaskmaskmaskSQLitemask</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_OMIT_ALTERTABLE</span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"meta\">#  <span class=\"keyword\">define</span> ALTER      0x00000001</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br></pre></td></tr></table></figure>\n\n<p><code>SQLITE_OMIT_ALTERTABLE</code><code>ALTER</code>0<code>ALTER</code>maskmask0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Remove entries from the list of keywords that have mask==0 */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=j=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( aKeywordTable[i].mask==<span class=\"number\">0</span> ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j&lt;i )&#123;</span><br><span class=\"line\">      aKeywordTable[j] = aKeywordTable[i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    j++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">nKeyword = j;</span><br></pre></td></tr></table></figure>\n<p> akeywordTable mask0</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">    p-&gt;len = (<span class=\"type\">int</span>)<span class=\"built_in\">strlen</span>(p-&gt;zName);</span><br><span class=\"line\">    assert( p-&gt;len&lt;<span class=\"keyword\">sizeof</span>(p-&gt;zOrigName) );</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(p-&gt;zOrigName, p-&gt;zName, p-&gt;len+<span class=\"number\">1</span>);</span><br><span class=\"line\">    totalLen += p-&gt;len;</span><br><span class=\"line\">    p-&gt;hash = (charMap(p-&gt;zName[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^</span><br><span class=\"line\">              (charMap(p-&gt;zName[p-&gt;len<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ (p-&gt;len*<span class=\"number\">1</span>);</span><br><span class=\"line\">    p-&gt;id = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>aKeywordTablenKeywordSQLite</p>\n<ul>\n<li>id</li>\n<li>p-&gt;len </li>\n<li>p-&gt;zOrigName  p-&gt;zName </li>\n<li>:(<em>4)^(</em>3)^()) aKeywordTable</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>ABABAB</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Sort the table from shortest to longest keyword */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\">qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare1);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Look for short keywords embedded in longer keywords */</span></span><br><span class=\"line\"><span class=\"comment\">/* ,ININDEXINDEXINDEXED*/</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword<span class=\"number\">-2</span>; i&gt;=<span class=\"number\">0</span>; i--)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *p = &amp;aKeywordTable[i];<span class=\"comment\">//p: </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=nKeyword<span class=\"number\">-1</span>; j&gt;i &amp;&amp; p-&gt;substrId==<span class=\"number\">0</span>; j--)&#123;<span class=\"comment\">//()</span></span><br><span class=\"line\">        Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=p-&gt;len ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(k=<span class=\"number\">0</span>; k&lt;=pOther-&gt;len-p-&gt;len; k++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(p-&gt;zName, &amp;pOther-&gt;zName[k], p-&gt;len)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">                p-&gt;substrId = pOther-&gt;id;</span><br><span class=\"line\">                p-&gt;substrOffset = k;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ABAB</li>\n<li>ABAsubstrIdBIdAsubstrOffset</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the longestSuffix value for every word */</span></span><br><span class=\"line\"><span class=\"comment\">/* </span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;<span class=\"comment\">//</span></span><br><span class=\"line\">    Keyword *pOther;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( j==i ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// p  pOther </span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(k=p-&gt;longestSuffix+<span class=\"number\">1</span>; k&lt;p-&gt;len &amp;&amp; k&lt;pOther-&gt;len; k++)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p-&gt;longestSuffix = k;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* Sort the table into reverse order by length */</span></span><br><span class=\"line\">  <span class=\"comment\">/*    */</span></span><br><span class=\"line\">  qsort(aKeywordTable, nKeyword, <span class=\"keyword\">sizeof</span>(aKeywordTable[<span class=\"number\">0</span>]), keywordCompare2);</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Fill in the offset for all entries */</span></span><br><span class=\"line\">nChar = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;offset&gt;<span class=\"number\">0</span> || p-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">  p-&gt;offset = nChar;</span><br><span class=\"line\">  nChar += p-&gt;len;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(k=p-&gt;len<span class=\"number\">-1</span>; k&gt;=<span class=\"number\">1</span>; k--)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(j=i+<span class=\"number\">1</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">      Keyword *pOther = &amp;aKeywordTable[j];</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;offset&gt;<span class=\"number\">0</span> || pOther-&gt;substrId ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( pOther-&gt;len&lt;=k ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( <span class=\"built_in\">memcmp</span>(&amp;p-&gt;zName[p-&gt;len-k], pOther-&gt;zName, k)==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        p = pOther;</span><br><span class=\"line\">        p-&gt;offset = nChar - k;</span><br><span class=\"line\">        nChar = p-&gt;offset + p-&gt;len;</span><br><span class=\"line\">        p-&gt;zName += k;</span><br><span class=\"line\">        p-&gt;len -= k;</span><br><span class=\"line\">        p-&gt;prefix = k;</span><br><span class=\"line\">        j = i;</span><br><span class=\"line\">        k = p-&gt;len;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++)&#123;</span><br><span class=\"line\">  Keyword *p = &amp;aKeywordTable[i];</span><br><span class=\"line\">  <span class=\"comment\">//subStrId</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span>( p-&gt;substrId )&#123;</span><br><span class=\"line\">    p-&gt;offset = findById(p-&gt;substrId)-&gt;offset + p-&gt;substrOffset;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>: </p>\n<p>:<code>abcde``def``efg</code>,<code>def</code><code>de</code><code>abcde</code><code>f</code>3</p>\n<p></p>\n<p>:</p>\n<ol>\n<li></li>\n<li>(<code>k=p-&gt;len-1</code>)break</li>\n</ol>\n<p></p>\n<ul>\n<li>SQLiteSQLite</li>\n<li><code>p = pOther;</code>ppOtherpOther</li>\n<li>check(i&#x3D;&#x3D;nKeyword)</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><em></em><em></em></p>\n<p>size</p>\n<p>SQLitebestCountscore()</p>\n<p>  * 1+ * 2 1+2&#x3D;1SQLite</p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Figure out how big to make the hash table in order to minimize the</span></span><br><span class=\"line\"><span class=\"comment\">** number of collisions */</span></span><br><span class=\"line\"><span class=\"comment\">/*  */</span></span><br><span class=\"line\"><span class=\"comment\">// SQLite  [nKeyword, 2*nKeyword]</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\">bestSize = nKeyword;</span><br><span class=\"line\">bestCount = nKeyword*nKeyword;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i=nKeyword/<span class=\"number\">2</span>; i&lt;=<span class=\"number\">2</span>*nKeyword; i++)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;i; j++) aKWHash[j] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=<span class=\"number\">0</span>; j&lt;nKeyword; j++)&#123;</span><br><span class=\"line\">    h = aKeywordTable[j].hash % i;</span><br><span class=\"line\">    aKWHash[h] *= <span class=\"number\">2</span>;</span><br><span class=\"line\">    aKWHash[h]++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(j=count=<span class=\"number\">0</span>; j&lt;i; j++) count += aKWHash[j];</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( count&lt;bestCount )&#123;</span><br><span class=\"line\">    bestCount = count;</span><br><span class=\"line\">    bestSize = i;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>SQLite[nKeyword, 2 x nKeyword](nKeyword)()x2 1bestCount</p>\n<p></p>\n<ol>\n<li>aKWHash0</li>\n<li></li>\n<li><em>2 + 111</em>2+1&#x3D;33*2+1&#x3D;7</li>\n<li>aKWHashaKWHashscore</li>\n<li>[nKeyword, 2 x nKeyword]score</li>\n</ol>\n<p> x2  x2 score2  345</p>\n<p><code>keywordhash.h</code><code>Hash score</code>, (3.27.2) 2 <code>Hash score</code><em>208</em></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Compute the hash */</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;bestSize; i++) aKWHash[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;nKeyword; i++) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//..</span></span><br><span class=\"line\">    h = aKeywordTable[i].hash % bestSize;</span><br><span class=\"line\">    aKeywordTable[i].iNext = aKWHash[h];</span><br><span class=\"line\">    aKWHash[h] = i+<span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>bestSize -&gt; bestCount -&gt; </p>\n<p>+1<code>iNext</code>next</p>\n<p></p>\n<p><code>aKeywordTable</code>N</p>\n<p><code>zKWText</code>: <code>aKeywordTable</code><code>KeyWord</code><code>zName</code><br><code>aKWHash</code>: ()<br><code>aKWNext</code>: <br><code>aKWLen</code> : i<br><code>aKWOffset</code> : <code>zKWText</code><br><code>aKWCode</code> : <code>parser</code></p>\n<h2 id=\"-keywordCode\"><a href=\"#-keywordCode\" class=\"headerlink\" title=\"(keywordCode)\"></a>(keywordCode)</h2><p><code>keywordCode(const char *z, int n, int *pType)</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Check to see if z[0..n-1] is a keyword. If it is, write the</span></span><br><span class=\"line\"><span class=\"comment\">** parser symbol code for that keyword into *pType.  Always</span></span><br><span class=\"line\"><span class=\"comment\">** return the integer n (the length of the token). */</span></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">keywordCode</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> n, <span class=\"type\">int</span> *pType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, j;</span><br><span class=\"line\">  <span class=\"type\">const</span> <span class=\"type\">char</span> *zKW;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>( n&gt;=<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">    i = ((charMap(z[<span class=\"number\">0</span>])*<span class=\"number\">4</span>) ^ (charMap(z[n<span class=\"number\">-1</span>])*<span class=\"number\">3</span>) ^ n) % <span class=\"number\">127</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i=((<span class=\"type\">int</span>)aKWHash[i])<span class=\"number\">-1</span>; i&gt;=<span class=\"number\">0</span>; i=((<span class=\"type\">int</span>)aKWNext[i])<span class=\"number\">-1</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( aKWLen[i]!=n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      j = <span class=\"number\">0</span>;</span><br><span class=\"line\">      zKW = &amp;zKWText[aKWOffset[i]];</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; (z[j]&amp;~<span class=\"number\">0x20</span>)==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_EBCDIC</span></span><br><span class=\"line\">      <span class=\"keyword\">while</span>( j&lt;n &amp;&amp; <span class=\"built_in\">toupper</span>(z[j])==zKW[j] )&#123; j++; &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"keyword\">if</span>( j&lt;n ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      testcase( i==<span class=\"number\">0</span> ); <span class=\"comment\">/* REINDEX */</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">1</span> ); <span class=\"comment\">/* INDEXED */</span></span><br><span class=\"line\">    <span class=\"comment\">//   ......</span></span><br><span class=\"line\">      testcase( i==<span class=\"number\">135</span> ); <span class=\"comment\">/* PRIMARY */</span></span><br><span class=\"line\">      *pType = aKWCode[i];</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>:(<code>parser</code>)n</p>\n<ol>\n<li>2</li>\n<li><code>i = ((charMap(z[0])*4) ^ (charMap(z[n-1])*3) ^ n) % 127</code>127</li>\n<li>aKWHash[i]aKWNext</li>\n<li></li>\n<li>zKWText</li>\n<li>3</li>\n</ol>"},{"title":"Manacher -- LeetCode[5]","date":"2019-12-10T16:00:00.000Z","_content":"\n>   LeetCodeMedium\n\n\n\n\"\"Mangcher\n\n<!-- more -->\n\n> \n1.Manacher\n2.dp[i]=fn(dp[i-n])\n----->\n\n\n\n\n  i-1    i-1  \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png)\n\niManacher\n\n****dp[i]=fn(dp[i-n])ii\n\n i \n\ni  \n1. i \n2. i \n\n\nm i\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png)\n\n### \n\n\n\ni  c , s,  si\n\nc s  s c\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png)\n\n s c\n\n c  s  c', c si-(i-si) = 2*si - i\n\n\n**1.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png)\ndp[i] = dp[2*si-1]\nc c'\n\nc'  c  c' s\n c  c' \n\n**2.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png)\ndp[i] = (i-si)*2+1\n\nc  s \n\n  c  s  s \n c  s \n\n**3.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png)\ndp[i] = dp[2*si-i] + fn(si+1)\n\n c , c \n\n### \n\n i = s  + 1  c  \n\n### \n1. #if else 2*s+1.\n2. #\n3.  i-1 i-1 i  i-1 <i>\n\n****\n```go\nfunc longestPalindrome(s string) string {\n\tfs := formatString(s)\n\tr := coreCal(fs)\n\tret := cutString(r)\n\treturn ret\n}\n\n//#\nfunc formatString(s string) []byte {\n\tc := byte('#')\n\tos := []byte(s)\n\tns := make([]byte, 2*len(s)+1)\n\tns[0] = c\n\tfor index := 0; index < len(s)*2+1; index++ {\n\t\tif index%2 == 0 {\n\t\t\tns[index] = c\n\t\t} else {\n\t\t\tns[index] = os[index/2]\n\t\t}\n\t}\n\n\treturn ns\n}\n\n// #\nfunc cutString(s []byte) string {\n\trs := make([]byte, len(s)/2)\n\tc := byte('#')\n\tfor index := 0; index < len(s); index++ {\n\t\tif s[index] != c {\n\t\t\trs[index/2] = s[index]\n\t\t}\n\t}\n\n\treturn string(rs)\n}\n\n//\nfunc coreCal(fs []byte) []byte {\n\t// fs.len \n\tdp := make([]int, len(fs))\n\n\tvar longestString []byte\n\n\trightEdge := -1\n\tsi := 0\n\n\tfor i := 0; i < len(fs); i++ {\n\t\tif i > rightEdge {\n\t\t\tpLen := deepFind(fs, i-1, i+1)\n\n\t\t\tsi = i\n\t\t\trightEdge = si + pLen/2\n\n\t\t\tif pLen > len(longestString) {\n\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t}\n\n\t\t\tdp[i] = pLen\n\t\t} else {\n\t\t\tii := 2*si - i //\n\t\t\tiiLeft := ii - dp[ii]/2\n\n\t\t\tsiLeft := si - dp[si]/2\n\t\t\tsiRight := si + dp[si]/2\n\n\t\t\tif iiLeft > siLeft {\n\t\t\t\tdp[i] = dp[ii]\n\t\t\t} else if iiLeft < siLeft {\n\t\t\t\tdp[i] = 2*(siRight-i) + 1\n\t\t\t} else {\n\t\t\t\tpLen := deepFind(fs, 2*i-siRight-1, siRight+1)\n\n\t\t\t\tsi = i\n\t\t\t\trightEdge = si + pLen/2\n\n\t\t\t\tif pLen > len(longestString) {\n\t\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t\t}\n\n\t\t\t\tdp[i] = pLen\n\t\t\t}\n\t\t}\n\t}\n\n\treturn longestString\n}\n\n//left=l,right=r\nfunc deepFind(fs []byte, l int, r int) int {\n\tfor l >= 0 && r < len(fs) {\n\t\tif fs[l] != fs[r] {\n\t\t\tbreak\n\t\t}\n\t\tl--\n\t\tr++\n\t}\n\n\treturn r - l - 1\n}\n```","source":"_posts/2.leetcode5.md","raw":"---\ntitle: Manacher -- LeetCode[5]\ndate: 2019-12-11\ntags: [leetcode,]\ncategories: \n---\n\n>   LeetCodeMedium\n\n\n\n\"\"Mangcher\n\n<!-- more -->\n\n> \n1.Manacher\n2.dp[i]=fn(dp[i-n])\n----->\n\n\n\n\n  i-1    i-1  \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png)\n\niManacher\n\n****dp[i]=fn(dp[i-n])ii\n\n i \n\ni  \n1. i \n2. i \n\n\nm i\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png)\n\n### \n\n\n\ni  c , s,  si\n\nc s  s c\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png)\n\n s c\n\n c  s  c', c si-(i-si) = 2*si - i\n\n\n**1.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png)\ndp[i] = dp[2*si-1]\nc c'\n\nc'  c  c' s\n c  c' \n\n**2.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png)\ndp[i] = (i-si)*2+1\n\nc  s \n\n  c  s  s \n c  s \n\n**3.  c'  s **\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png)\ndp[i] = dp[2*si-i] + fn(si+1)\n\n c , c \n\n### \n\n i = s  + 1  c  \n\n### \n1. #if else 2*s+1.\n2. #\n3.  i-1 i-1 i  i-1 <i>\n\n****\n```go\nfunc longestPalindrome(s string) string {\n\tfs := formatString(s)\n\tr := coreCal(fs)\n\tret := cutString(r)\n\treturn ret\n}\n\n//#\nfunc formatString(s string) []byte {\n\tc := byte('#')\n\tos := []byte(s)\n\tns := make([]byte, 2*len(s)+1)\n\tns[0] = c\n\tfor index := 0; index < len(s)*2+1; index++ {\n\t\tif index%2 == 0 {\n\t\t\tns[index] = c\n\t\t} else {\n\t\t\tns[index] = os[index/2]\n\t\t}\n\t}\n\n\treturn ns\n}\n\n// #\nfunc cutString(s []byte) string {\n\trs := make([]byte, len(s)/2)\n\tc := byte('#')\n\tfor index := 0; index < len(s); index++ {\n\t\tif s[index] != c {\n\t\t\trs[index/2] = s[index]\n\t\t}\n\t}\n\n\treturn string(rs)\n}\n\n//\nfunc coreCal(fs []byte) []byte {\n\t// fs.len \n\tdp := make([]int, len(fs))\n\n\tvar longestString []byte\n\n\trightEdge := -1\n\tsi := 0\n\n\tfor i := 0; i < len(fs); i++ {\n\t\tif i > rightEdge {\n\t\t\tpLen := deepFind(fs, i-1, i+1)\n\n\t\t\tsi = i\n\t\t\trightEdge = si + pLen/2\n\n\t\t\tif pLen > len(longestString) {\n\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t}\n\n\t\t\tdp[i] = pLen\n\t\t} else {\n\t\t\tii := 2*si - i //\n\t\t\tiiLeft := ii - dp[ii]/2\n\n\t\t\tsiLeft := si - dp[si]/2\n\t\t\tsiRight := si + dp[si]/2\n\n\t\t\tif iiLeft > siLeft {\n\t\t\t\tdp[i] = dp[ii]\n\t\t\t} else if iiLeft < siLeft {\n\t\t\t\tdp[i] = 2*(siRight-i) + 1\n\t\t\t} else {\n\t\t\t\tpLen := deepFind(fs, 2*i-siRight-1, siRight+1)\n\n\t\t\t\tsi = i\n\t\t\t\trightEdge = si + pLen/2\n\n\t\t\t\tif pLen > len(longestString) {\n\t\t\t\t\tlongestString = fs[si-pLen/2 : si+pLen/2+1]\n\t\t\t\t}\n\n\t\t\t\tdp[i] = pLen\n\t\t\t}\n\t\t}\n\t}\n\n\treturn longestString\n}\n\n//left=l,right=r\nfunc deepFind(fs []byte, l int, r int) int {\n\tfor l >= 0 && r < len(fs) {\n\t\tif fs[l] != fs[r] {\n\t\t\tbreak\n\t\t}\n\t\tl--\n\t\tr++\n\t}\n\n\treturn r - l - 1\n}\n```","slug":"2.leetcode5","published":1,"updated":"2020-08-29T14:42:58.499Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l5000n93c9e2ctfcg8","content":"<blockquote>\n<p>  LeetCodeMedium</p>\n</blockquote>\n<p></p>\n<p>Mangcher</p>\n<span id=\"more\"></span>\n\n<blockquote>\n<p><br>1.Manacher<br>2.dp[i]&#x3D;fn(dp[i-n])<br>&gt;</p>\n</blockquote>\n<p></p>\n<p>  i-1    i-1  </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png\"></p>\n<p>iManacher</p>\n<p><strong></strong>dp[i]&#x3D;fn(dp[i-n])ii</p>\n<p> i </p>\n<p>i  </p>\n<ol>\n<li>i </li>\n<li>i </li>\n</ol>\n<p><br>m i<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>i  c , s,  si</p>\n<p>c s  s c<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png\"></p>\n<p> s c</p>\n<p> c  s  c, c si-(i-si) &#x3D; 2*si - i<br></p>\n<p><strong>1.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png\"><br>dp[i] &#x3D; dp[2*si-1]<br>c c</p>\n<p>c  c  c s<br> c  c </p>\n<p><strong>2.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png\"><br>dp[i] &#x3D; (i-si)*2+1</p>\n<p>c  s </p>\n<p>  c  s  s <br> c  s </p>\n<p><strong>3.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png\"><br>dp[i] &#x3D; dp[2*si-i] + fn(si+1)</p>\n<p> c , c </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> i &#x3D; s  + 1  c  </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li>#if else 2*s+1.</li>\n<li>#</li>\n<li> i-1 i-1 i  i-1 &lt;i&gt;</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">longestPalindrome</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\tfs := formatString(s)</span><br><span class=\"line\">\tr := coreCal(fs)</span><br><span class=\"line\">\tret := cutString(r)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//#</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">formatString</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\tos := []<span class=\"type\">byte</span>(s)</span><br><span class=\"line\">\tns := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"number\">2</span>*<span class=\"built_in\">len</span>(s)+<span class=\"number\">1</span>)</span><br><span class=\"line\">\tns[<span class=\"number\">0</span>] = c</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s)*<span class=\"number\">2</span>+<span class=\"number\">1</span>; index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> index%<span class=\"number\">2</span> == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = c</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = os[index/<span class=\"number\">2</span>]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ns</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// #</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">cutString</span><span class=\"params\">(s []<span class=\"type\">byte</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\trs := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"built_in\">len</span>(s)/<span class=\"number\">2</span>)</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s); index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> s[index] != c &#123;</span><br><span class=\"line\">\t\t\trs[index/<span class=\"number\">2</span>] = s[index]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">string</span>(rs)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">coreCal</span><span class=\"params\">(fs []<span class=\"type\">byte</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// fs.len </span></span><br><span class=\"line\">\tdp := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"built_in\">len</span>(fs))</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> longestString []<span class=\"type\">byte</span></span><br><span class=\"line\"></span><br><span class=\"line\">\trightEdge := <span class=\"number\">-1</span></span><br><span class=\"line\">\tsi := <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(fs); i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i &gt; rightEdge &#123;</span><br><span class=\"line\">\t\t\tpLen := deepFind(fs, i<span class=\"number\">-1</span>, i+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsi = i</span><br><span class=\"line\">\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tii := <span class=\"number\">2</span>*si - i <span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\tiiLeft := ii - dp[ii]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsiLeft := si - dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\">\t\t\tsiRight := si + dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> iiLeft &gt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = dp[ii]</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> iiLeft &lt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = <span class=\"number\">2</span>*(siRight-i) + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tpLen := deepFind(fs, <span class=\"number\">2</span>*i-siRight<span class=\"number\">-1</span>, siRight+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tsi = i</span><br><span class=\"line\">\t\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> longestString</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//left=l,right=r</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">deepFind</span><span class=\"params\">(fs []<span class=\"type\">byte</span>, l <span class=\"type\">int</span>, r <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> l &gt;= <span class=\"number\">0</span> &amp;&amp; r &lt; <span class=\"built_in\">len</span>(fs) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> fs[l] != fs[r] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tl--</span><br><span class=\"line\">\t\tr++</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> r - l - <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<blockquote>\n<p>  LeetCodeMedium</p>\n</blockquote>\n<p></p>\n<p>Mangcher</p>","more":"<blockquote>\n<p><br>1.Manacher<br>2.dp[i]&#x3D;fn(dp[i-n])<br>&gt;</p>\n</blockquote>\n<p></p>\n<p>  i-1    i-1  </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/ee8ab9d8c2692bd40a4f791003760a7f.png\"></p>\n<p>iManacher</p>\n<p><strong></strong>dp[i]&#x3D;fn(dp[i-n])ii</p>\n<p> i </p>\n<p>i  </p>\n<ol>\n<li>i </li>\n<li>i </li>\n</ol>\n<p><br>m i<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog//2019/12/19fc8764fa0e1773234f34a1d9a497fa.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>i  c , s,  si</p>\n<p>c s  s c<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/10e38e0c55390f8a15bc190b125faad6.png\"></p>\n<p> s c</p>\n<p> c  s  c, c si-(i-si) &#x3D; 2*si - i<br></p>\n<p><strong>1.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/a78abcc5d265dd94b8a735c9f0fcc899.png\"><br>dp[i] &#x3D; dp[2*si-1]<br>c c</p>\n<p>c  c  c s<br> c  c </p>\n<p><strong>2.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/71925b1f859701ebf763399e59266672.png\"><br>dp[i] &#x3D; (i-si)*2+1</p>\n<p>c  s </p>\n<p>  c  s  s <br> c  s </p>\n<p><strong>3.  c  s </strong><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b0d22609c8522fe8e2558601a14414a5.png\"><br>dp[i] &#x3D; dp[2*si-i] + fn(si+1)</p>\n<p> c , c </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p> i &#x3D; s  + 1  c  </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><ol>\n<li>#if else 2*s+1.</li>\n<li>#</li>\n<li> i-1 i-1 i  i-1 &lt;i&gt;</li>\n</ol>\n<p><strong></strong></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">longestPalindrome</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\tfs := formatString(s)</span><br><span class=\"line\">\tr := coreCal(fs)</span><br><span class=\"line\">\tret := cutString(r)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ret</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//#</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">formatString</span><span class=\"params\">(s <span class=\"type\">string</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\tos := []<span class=\"type\">byte</span>(s)</span><br><span class=\"line\">\tns := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"number\">2</span>*<span class=\"built_in\">len</span>(s)+<span class=\"number\">1</span>)</span><br><span class=\"line\">\tns[<span class=\"number\">0</span>] = c</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s)*<span class=\"number\">2</span>+<span class=\"number\">1</span>; index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> index%<span class=\"number\">2</span> == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = c</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tns[index] = os[index/<span class=\"number\">2</span>]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ns</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// #</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">cutString</span><span class=\"params\">(s []<span class=\"type\">byte</span>)</span></span> <span class=\"type\">string</span> &#123;</span><br><span class=\"line\">\trs := <span class=\"built_in\">make</span>([]<span class=\"type\">byte</span>, <span class=\"built_in\">len</span>(s)/<span class=\"number\">2</span>)</span><br><span class=\"line\">\tc := <span class=\"type\">byte</span>(<span class=\"string\">&#x27;#&#x27;</span>)</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> index := <span class=\"number\">0</span>; index &lt; <span class=\"built_in\">len</span>(s); index++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> s[index] != c &#123;</span><br><span class=\"line\">\t\t\trs[index/<span class=\"number\">2</span>] = s[index]</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"type\">string</span>(rs)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">coreCal</span><span class=\"params\">(fs []<span class=\"type\">byte</span>)</span></span> []<span class=\"type\">byte</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// fs.len </span></span><br><span class=\"line\">\tdp := <span class=\"built_in\">make</span>([]<span class=\"type\">int</span>, <span class=\"built_in\">len</span>(fs))</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">var</span> longestString []<span class=\"type\">byte</span></span><br><span class=\"line\"></span><br><span class=\"line\">\trightEdge := <span class=\"number\">-1</span></span><br><span class=\"line\">\tsi := <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">len</span>(fs); i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> i &gt; rightEdge &#123;</span><br><span class=\"line\">\t\t\tpLen := deepFind(fs, i<span class=\"number\">-1</span>, i+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsi = i</span><br><span class=\"line\">\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\tii := <span class=\"number\">2</span>*si - i <span class=\"comment\">//</span></span><br><span class=\"line\">\t\t\tiiLeft := ii - dp[ii]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\tsiLeft := si - dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\">\t\t\tsiRight := si + dp[si]/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> iiLeft &gt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = dp[ii]</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> iiLeft &lt; siLeft &#123;</span><br><span class=\"line\">\t\t\t\tdp[i] = <span class=\"number\">2</span>*(siRight-i) + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\tpLen := deepFind(fs, <span class=\"number\">2</span>*i-siRight<span class=\"number\">-1</span>, siRight+<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tsi = i</span><br><span class=\"line\">\t\t\t\trightEdge = si + pLen/<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> pLen &gt; <span class=\"built_in\">len</span>(longestString) &#123;</span><br><span class=\"line\">\t\t\t\t\tlongestString = fs[si-pLen/<span class=\"number\">2</span> : si+pLen/<span class=\"number\">2</span>+<span class=\"number\">1</span>]</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t\tdp[i] = pLen</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> longestString</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//left=l,right=r</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">deepFind</span><span class=\"params\">(fs []<span class=\"type\">byte</span>, l <span class=\"type\">int</span>, r <span class=\"type\">int</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> l &gt;= <span class=\"number\">0</span> &amp;&amp; r &lt; <span class=\"built_in\">len</span>(fs) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> fs[l] != fs[r] &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tl--</span><br><span class=\"line\">\t\tr++</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> r - l - <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"SQLite--Tokenize()","date":"2020-07-20T16:00:00.000Z","_content":"\n> SQLiteSQLiteSQLite\n\n<!-- more -->\n\n## \n\nTokenizeSQLiteSQL*ID*Parserparser*ID*\n\nParser\n\nParserSQLite`$root/tool/``lemon.c`SQLite`cmake``autoconf`Makefile:\n\n```\n# lemon.clemon\n#\nlemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c\n\t$(BCC) -o $@ $(TOP)/tool/lemon.c\n\tcp $(TOP)/tool/lempar.c .\n```\n\n```\n# parse.h  parse.clemon\n# commandlemonparse.yparse.hparse.c\n#\nparse.h:\tparse.c\n\nparse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl\n\tcp $(TOP)/src/parse.y .\n\trm -f parse.h\n\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y\n\tmv parse.h parse.h.temp\n\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp >parse.h\n```\n\n```\n# fts5lemonfts5parse.y\nfts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon\n\tcp $(TOP)/ext/fts5/fts5parse.y .\n\trm -f fts5parse.h\n\t./lemon$(BEXE) $(OPTS) fts5parse.y\n```\n\nParserlemonparse.hID\n\nIDTokenize\n\nSQLite API\n`int sqlite3_prepare();`\n`int sqlite3_prepare_v2();`\n`int sqlite3_prepare_v3();`\n\nSQLtokenizeparservm****\n\n:\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg)\n\n## \n\n`tokenize.c` `int sqlite3GetToken(const unsigned char *z, int *tokenType)`  `int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)`\n\n`prepare``sqlite3RunParser`\n\n```c\nint sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg){\n  int nErr = 0;                   /* Number of errors encountered */\n  void *pEngine;                  /* The LEMON-generated LALR(1) parser */\n  int n = 0;                      /* Length of the next token token */\n  int tokenType;                  /* type of the next token */\n  int lastTokenParsed = -1;       /* type of the previous token */\n  sqlite3 *db = pParse->db;       /* The database connection */\n  int mxSqlLen;                   /* Max length of an SQL string */\n  pParse->zTail = zSql;\n\n  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);\n\n  while( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    mxSqlLen -= n;\n    if( mxSqlLen<0 ){\n      pParse->rc = SQLITE_TOOBIG;\n      break;\n    }\n    if( tokenType>=TK_SPACE ){\n      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );\n      if( db->u1.isInterrupted ){\n        pParse->rc = SQLITE_INTERRUPT;\n        break;\n      }\n      if( tokenType==TK_SPACE ){\n        zSql += n;\n        continue;\n      }\n      if( zSql[0]==0 ){\n        /* Upon reaching the end of input, call the parser two more times\n        ** with tokens TK_SEMI and 0, in that order. */\n        if( lastTokenParsed==TK_SEMI ){\n          tokenType = 0;\n        }else if( lastTokenParsed==0 ){\n          break;\n        }else{\n          tokenType = TK_SEMI;\n        }\n        n = 0;\n      }else{\n        sqlite3ErrorMsg(pParse, \"unrecognized token: \\\"%.*s\\\"\", n, zSql);\n        break;\n      }\n    }\n    pParse->sLastToken.z = zSql;\n    pParse->sLastToken.n = n;\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);\n    lastTokenParsed = tokenType;\n    zSql += n;\n    if( pParse->rc!=SQLITE_OK || db->mallocFailed ) break;\n  }\n  // mem free code...\n  return nErr;\n}\n```\n\n\n\n```c\nwhile( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);    \n}\n```\n\nparser\n\nSQLSQLite\n\n\n\n## \n\n`sqlite3RunParser``sqlite3GetToken`\n\n```c\n/*\n** Return the length (in bytes) of the token that begins at z[0]. \n** Store the token type in *tokenType before returning.\n*/\nint sqlite3GetToken(const unsigned char *z, int *tokenType){\n  int i, c;\n  switch( aiClass[*z] ){  /* Switch on the character-class of the first byte\n                          ** of the token. See the comment on the CC_ defines\n                          ** above. */\n    case CC_SPACE: {\n      testcase( z[0]==' ' );\n      testcase( z[0]=='\\t' );\n      testcase( z[0]=='\\n' );\n      testcase( z[0]=='\\f' );\n      testcase( z[0]=='\\r' );\n      for(i=1; sqlite3Isspace(z[i]); i++){}\n      *tokenType = TK_SPACE;\n      return i;\n    }\n    case CC_VARNUM: {\n      *tokenType = TK_VARIABLE;\n      for(i=1; sqlite3Isdigit(z[i]); i++){}\n      return i;\n    }\n\n    // .... more case\n\n    case CC_KYWD: {\n      for(i=1; aiClass[z[i]]<=CC_KYWD; i++){}\n      if( IdChar(z[i]) ){\n        /* This token started out using characters that can appear in keywords,\n        ** but z[i] is a character not allowed within keywords, so this must\n        ** be an identifier instead */\n        i++;\n        break;\n      }\n      *tokenType = TK_ID;\n      return keywordCode((char*)z, i, tokenType);\n    }\n    case CC_X: {\n#ifndef SQLITE_OMIT_BLOB_LITERAL\n      testcase( z[0]=='x' ); testcase( z[0]=='X' );\n      if( z[1]=='\\'' ){\n        *tokenType = TK_BLOB;\n        for(i=2; sqlite3Isxdigit(z[i]); i++){}\n        if( z[i]!='\\'' || i%2 ){\n          *tokenType = TK_ILLEGAL;\n          while( z[i] && z[i]!='\\'' ){ i++; }\n        }\n        if( z[i] ) i++;\n        return i;\n      }\n#endif\n      /* If it is not a BLOB literal, then it must be an ID, since no\n      ** SQL keywords start with the letter 'x'.  Fall through */\n    }\n    case CC_ID: {\n      i = 1;\n      break;\n    }\n    case CC_NUL: {\n      *tokenType = TK_ILLEGAL;\n      return 0;\n    }\n    default: {\n      *tokenType = TK_ILLEGAL;\n      return 1;\n    }\n  }\n  while( IdChar(z[i]) ){ i++; }\n  *tokenType = TK_ID;\n  return i;\n}\n```\n\n`sqlite3GetToken`SQL(CC_SPACE,CC_NUL,...)switch-case**(tokenType)Parser.h\n\n...`aiClass[*z]``switch(*z)`\n\n *Switch-Case* \n\nswitch-casecaseconstant[C/C++ switch](http://blog.csdn.net/simmerlee/article/details/50845706)\n\n1. casecase\n2. casecase\n3. O(logn)\n\ncaseO(1)O(logn)SQLite\"\"\n\nASCII:\n\nASCII7bit8bit128256128ASCIISQLite256ASCII256`aiClass`ASCIISQLite29tokenize.c29switch-caseO(1)\n\nASCII aiClass  \n\n``` c\n/* Character classes for tokenizing\n**\n** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented\n** using a lookup table, whereas a switch() directly on c uses a binary search.\n** The lookup table is much faster.  To maximize speed, and to ensure that\n** a lookup table is used, all of the classes need to be small integers and\n** all of them need to be used within the switch.\n*/\n#define CC_X          0    /* The letter 'x', or start of BLOB literal */\n#define CC_KYWD       1    /* Alphabetics or '_'.  Usable in a keyword */\n#define CC_ID         2    /* unicode characters usable in IDs */\n#define CC_DIGIT      3    /* Digits */\n#define CC_DOLLAR     4    /* '$' */\n#define CC_VARALPHA   5    /* '@', '#', ':'.  Alphabetic SQL variables */\n#define CC_VARNUM     6    /* '?'.  Numeric SQL variables */\n#define CC_SPACE      7    /* Space characters */\n#define CC_QUOTE      8    /* '\"', '\\'', or '`'.  String literals, quoted ids */\n#define CC_QUOTE2     9    /* '['.   [...] style quoted ids */\n#define CC_PIPE      10    /* '|'.   Bitwise OR or concatenate */\n#define CC_MINUS     11    /* '-'.  Minus or SQL-style comment */\n#define CC_LT        12    /* '<'.  Part of < or <= or <> */\n#define CC_GT        13    /* '>'.  Part of > or >= */\n#define CC_EQ        14    /* '='.  Part of = or == */\n#define CC_BANG      15    /* '!'.  Part of != */\n#define CC_SLASH     16    /* '/'.  / or c-style comment */\n#define CC_LP        17    /* '(' */\n#define CC_RP        18    /* ')' */\n#define CC_SEMI      19    /* ';' */\n#define CC_PLUS      20    /* '+' */\n#define CC_STAR      21    /* '*' */\n#define CC_PERCENT   22    /* '%' */\n#define CC_COMMA     23    /* ',' */\n#define CC_AND       24    /* '&' */\n#define CC_TILDA     25    /* '~' */\n#define CC_DOT       26    /* '.' */\n#define CC_ILLEGAL   27    /* Illegal character */\n#define CC_NUL       28    /* 0x00 */\n\nstatic const unsigned char aiClass[] = {\n#ifdef SQLITE_ASCII\n/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */\n/* 0x */   28, 27, 27, 27, 27, 27, 27, 27, 27,  7,  7, 27,  7,  7, 27, 27,\n/* 1x */   27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27,\n/* 2x */    7, 15,  8,  5,  4, 22, 24,  8, 17, 18, 21, 20, 23, 11, 26, 16,\n/* 3x */    3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  5, 19, 12, 14, 13,  6,\n/* 4x */    5,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 5x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1,  9, 27, 27, 27,  1,\n/* 6x */    8,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 7x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1, 27, 10, 27, 25, 27,\n/* 8x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2, //128 2 CC_ID\n/* 9x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ax */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Bx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Cx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Dx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ex */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Fx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2\n#endif\n};\n```\n\ncase CC_KYWD`keywordCode`SQLite*ID*`keywordCode`[SQLite--KeywordHash](https://caio.ink/2020/07/16/19.SQLite-KeywordHash/)","source":"_posts/20.SQLite-Tokenize.md","raw":"title: SQLite--Tokenize()\ndate: 2020-07-21\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLiteSQLiteSQLite\n\n<!-- more -->\n\n## \n\nTokenizeSQLiteSQL*ID*Parserparser*ID*\n\nParser\n\nParserSQLite`$root/tool/``lemon.c`SQLite`cmake``autoconf`Makefile:\n\n```\n# lemon.clemon\n#\nlemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c\n\t$(BCC) -o $@ $(TOP)/tool/lemon.c\n\tcp $(TOP)/tool/lempar.c .\n```\n\n```\n# parse.h  parse.clemon\n# commandlemonparse.yparse.hparse.c\n#\nparse.h:\tparse.c\n\nparse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl\n\tcp $(TOP)/src/parse.y .\n\trm -f parse.h\n\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y\n\tmv parse.h parse.h.temp\n\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp >parse.h\n```\n\n```\n# fts5lemonfts5parse.y\nfts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon\n\tcp $(TOP)/ext/fts5/fts5parse.y .\n\trm -f fts5parse.h\n\t./lemon$(BEXE) $(OPTS) fts5parse.y\n```\n\nParserlemonparse.hID\n\nIDTokenize\n\nSQLite API\n`int sqlite3_prepare();`\n`int sqlite3_prepare_v2();`\n`int sqlite3_prepare_v3();`\n\nSQLtokenizeparservm****\n\n:\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg)\n\n## \n\n`tokenize.c` `int sqlite3GetToken(const unsigned char *z, int *tokenType)`  `int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)`\n\n`prepare``sqlite3RunParser`\n\n```c\nint sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg){\n  int nErr = 0;                   /* Number of errors encountered */\n  void *pEngine;                  /* The LEMON-generated LALR(1) parser */\n  int n = 0;                      /* Length of the next token token */\n  int tokenType;                  /* type of the next token */\n  int lastTokenParsed = -1;       /* type of the previous token */\n  sqlite3 *db = pParse->db;       /* The database connection */\n  int mxSqlLen;                   /* Max length of an SQL string */\n  pParse->zTail = zSql;\n\n  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);\n\n  while( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    mxSqlLen -= n;\n    if( mxSqlLen<0 ){\n      pParse->rc = SQLITE_TOOBIG;\n      break;\n    }\n    if( tokenType>=TK_SPACE ){\n      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );\n      if( db->u1.isInterrupted ){\n        pParse->rc = SQLITE_INTERRUPT;\n        break;\n      }\n      if( tokenType==TK_SPACE ){\n        zSql += n;\n        continue;\n      }\n      if( zSql[0]==0 ){\n        /* Upon reaching the end of input, call the parser two more times\n        ** with tokens TK_SEMI and 0, in that order. */\n        if( lastTokenParsed==TK_SEMI ){\n          tokenType = 0;\n        }else if( lastTokenParsed==0 ){\n          break;\n        }else{\n          tokenType = TK_SEMI;\n        }\n        n = 0;\n      }else{\n        sqlite3ErrorMsg(pParse, \"unrecognized token: \\\"%.*s\\\"\", n, zSql);\n        break;\n      }\n    }\n    pParse->sLastToken.z = zSql;\n    pParse->sLastToken.n = n;\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);\n    lastTokenParsed = tokenType;\n    zSql += n;\n    if( pParse->rc!=SQLITE_OK || db->mallocFailed ) break;\n  }\n  // mem free code...\n  return nErr;\n}\n```\n\n\n\n```c\nwhile( 1 ){\n    n = sqlite3GetToken((u8*)zSql, &tokenType);\n    sqlite3Parser(pEngine, tokenType, pParse->sLastToken);    \n}\n```\n\nparser\n\nSQLSQLite\n\n\n\n## \n\n`sqlite3RunParser``sqlite3GetToken`\n\n```c\n/*\n** Return the length (in bytes) of the token that begins at z[0]. \n** Store the token type in *tokenType before returning.\n*/\nint sqlite3GetToken(const unsigned char *z, int *tokenType){\n  int i, c;\n  switch( aiClass[*z] ){  /* Switch on the character-class of the first byte\n                          ** of the token. See the comment on the CC_ defines\n                          ** above. */\n    case CC_SPACE: {\n      testcase( z[0]==' ' );\n      testcase( z[0]=='\\t' );\n      testcase( z[0]=='\\n' );\n      testcase( z[0]=='\\f' );\n      testcase( z[0]=='\\r' );\n      for(i=1; sqlite3Isspace(z[i]); i++){}\n      *tokenType = TK_SPACE;\n      return i;\n    }\n    case CC_VARNUM: {\n      *tokenType = TK_VARIABLE;\n      for(i=1; sqlite3Isdigit(z[i]); i++){}\n      return i;\n    }\n\n    // .... more case\n\n    case CC_KYWD: {\n      for(i=1; aiClass[z[i]]<=CC_KYWD; i++){}\n      if( IdChar(z[i]) ){\n        /* This token started out using characters that can appear in keywords,\n        ** but z[i] is a character not allowed within keywords, so this must\n        ** be an identifier instead */\n        i++;\n        break;\n      }\n      *tokenType = TK_ID;\n      return keywordCode((char*)z, i, tokenType);\n    }\n    case CC_X: {\n#ifndef SQLITE_OMIT_BLOB_LITERAL\n      testcase( z[0]=='x' ); testcase( z[0]=='X' );\n      if( z[1]=='\\'' ){\n        *tokenType = TK_BLOB;\n        for(i=2; sqlite3Isxdigit(z[i]); i++){}\n        if( z[i]!='\\'' || i%2 ){\n          *tokenType = TK_ILLEGAL;\n          while( z[i] && z[i]!='\\'' ){ i++; }\n        }\n        if( z[i] ) i++;\n        return i;\n      }\n#endif\n      /* If it is not a BLOB literal, then it must be an ID, since no\n      ** SQL keywords start with the letter 'x'.  Fall through */\n    }\n    case CC_ID: {\n      i = 1;\n      break;\n    }\n    case CC_NUL: {\n      *tokenType = TK_ILLEGAL;\n      return 0;\n    }\n    default: {\n      *tokenType = TK_ILLEGAL;\n      return 1;\n    }\n  }\n  while( IdChar(z[i]) ){ i++; }\n  *tokenType = TK_ID;\n  return i;\n}\n```\n\n`sqlite3GetToken`SQL(CC_SPACE,CC_NUL,...)switch-case**(tokenType)Parser.h\n\n...`aiClass[*z]``switch(*z)`\n\n *Switch-Case* \n\nswitch-casecaseconstant[C/C++ switch](http://blog.csdn.net/simmerlee/article/details/50845706)\n\n1. casecase\n2. casecase\n3. O(logn)\n\ncaseO(1)O(logn)SQLite\"\"\n\nASCII:\n\nASCII7bit8bit128256128ASCIISQLite256ASCII256`aiClass`ASCIISQLite29tokenize.c29switch-caseO(1)\n\nASCII aiClass  \n\n``` c\n/* Character classes for tokenizing\n**\n** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented\n** using a lookup table, whereas a switch() directly on c uses a binary search.\n** The lookup table is much faster.  To maximize speed, and to ensure that\n** a lookup table is used, all of the classes need to be small integers and\n** all of them need to be used within the switch.\n*/\n#define CC_X          0    /* The letter 'x', or start of BLOB literal */\n#define CC_KYWD       1    /* Alphabetics or '_'.  Usable in a keyword */\n#define CC_ID         2    /* unicode characters usable in IDs */\n#define CC_DIGIT      3    /* Digits */\n#define CC_DOLLAR     4    /* '$' */\n#define CC_VARALPHA   5    /* '@', '#', ':'.  Alphabetic SQL variables */\n#define CC_VARNUM     6    /* '?'.  Numeric SQL variables */\n#define CC_SPACE      7    /* Space characters */\n#define CC_QUOTE      8    /* '\"', '\\'', or '`'.  String literals, quoted ids */\n#define CC_QUOTE2     9    /* '['.   [...] style quoted ids */\n#define CC_PIPE      10    /* '|'.   Bitwise OR or concatenate */\n#define CC_MINUS     11    /* '-'.  Minus or SQL-style comment */\n#define CC_LT        12    /* '<'.  Part of < or <= or <> */\n#define CC_GT        13    /* '>'.  Part of > or >= */\n#define CC_EQ        14    /* '='.  Part of = or == */\n#define CC_BANG      15    /* '!'.  Part of != */\n#define CC_SLASH     16    /* '/'.  / or c-style comment */\n#define CC_LP        17    /* '(' */\n#define CC_RP        18    /* ')' */\n#define CC_SEMI      19    /* ';' */\n#define CC_PLUS      20    /* '+' */\n#define CC_STAR      21    /* '*' */\n#define CC_PERCENT   22    /* '%' */\n#define CC_COMMA     23    /* ',' */\n#define CC_AND       24    /* '&' */\n#define CC_TILDA     25    /* '~' */\n#define CC_DOT       26    /* '.' */\n#define CC_ILLEGAL   27    /* Illegal character */\n#define CC_NUL       28    /* 0x00 */\n\nstatic const unsigned char aiClass[] = {\n#ifdef SQLITE_ASCII\n/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */\n/* 0x */   28, 27, 27, 27, 27, 27, 27, 27, 27,  7,  7, 27,  7,  7, 27, 27,\n/* 1x */   27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27,\n/* 2x */    7, 15,  8,  5,  4, 22, 24,  8, 17, 18, 21, 20, 23, 11, 26, 16,\n/* 3x */    3,  3,  3,  3,  3,  3,  3,  3,  3,  3,  5, 19, 12, 14, 13,  6,\n/* 4x */    5,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 5x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1,  9, 27, 27, 27,  1,\n/* 6x */    8,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,\n/* 7x */    1,  1,  1,  1,  1,  1,  1,  1,  0,  1,  1, 27, 10, 27, 25, 27,\n/* 8x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2, //128 2 CC_ID\n/* 9x */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ax */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Bx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Cx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Dx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Ex */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,\n/* Fx */    2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2,  2\n#endif\n};\n```\n\ncase CC_KYWD`keywordCode`SQLite*ID*`keywordCode`[SQLite--KeywordHash](https://caio.ink/2020/07/16/19.SQLite-KeywordHash/)","slug":"20.SQLite-Tokenize","published":1,"updated":"2020-08-29T14:42:58.500Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l5000o93c93g595tld","content":"<blockquote>\n<p>SQLiteSQLiteSQLite</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>TokenizeSQLiteSQL<em>ID</em>Parserparser<em>ID</em></p>\n<p>Parser</p>\n<p>ParserSQLite<code>$root/tool/</code><code>lemon.c</code>SQLite<code>cmake</code><code>autoconf</code>Makefile:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># lemon.clemon</span><br><span class=\"line\">#</span><br><span class=\"line\">lemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c</span><br><span class=\"line\">\t$(BCC) -o $@ $(TOP)/tool/lemon.c</span><br><span class=\"line\">\tcp $(TOP)/tool/lempar.c .</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># parse.h  parse.clemon</span><br><span class=\"line\"># commandlemonparse.yparse.hparse.c</span><br><span class=\"line\">#</span><br><span class=\"line\">parse.h:\tparse.c</span><br><span class=\"line\"></span><br><span class=\"line\">parse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl</span><br><span class=\"line\">\tcp $(TOP)/src/parse.y .</span><br><span class=\"line\">\trm -f parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y</span><br><span class=\"line\">\tmv parse.h parse.h.temp</span><br><span class=\"line\">\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp &gt;parse.h</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># fts5lemonfts5parse.y</span><br><span class=\"line\">fts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon</span><br><span class=\"line\">\tcp $(TOP)/ext/fts5/fts5parse.y .</span><br><span class=\"line\">\trm -f fts5parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPTS) fts5parse.y</span><br></pre></td></tr></table></figure>\n\n<p>Parserlemonparse.hID</p>\n<p>IDTokenize</p>\n<p>SQLite API<br><code>int sqlite3_prepare();</code><br><code>int sqlite3_prepare_v2();</code><br><code>int sqlite3_prepare_v3();</code></p>\n<p>SQLtokenizeparservm<em></em><em></em></p>\n<p>:</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>tokenize.c</code> <code>int sqlite3GetToken(const unsigned char *z, int *tokenType)</code>  <code>int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)</code></p>\n<p><code>prepare</code><code>sqlite3RunParser</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3RunParser</span><span class=\"params\">(Parse *pParse, <span class=\"type\">const</span> <span class=\"type\">char</span> *zSql, <span class=\"type\">char</span> **pzErrMsg)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> nErr = <span class=\"number\">0</span>;                   <span class=\"comment\">/* Number of errors encountered */</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *pEngine;                  <span class=\"comment\">/* The LEMON-generated LALR(1) parser */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> n = <span class=\"number\">0</span>;                      <span class=\"comment\">/* Length of the next token token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> tokenType;                  <span class=\"comment\">/* type of the next token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> lastTokenParsed = <span class=\"number\">-1</span>;       <span class=\"comment\">/* type of the previous token */</span></span><br><span class=\"line\">  sqlite3 *db = pParse-&gt;db;       <span class=\"comment\">/* The database connection */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mxSqlLen;                   <span class=\"comment\">/* Max length of an SQL string */</span></span><br><span class=\"line\">  pParse-&gt;zTail = zSql;</span><br><span class=\"line\"></span><br><span class=\"line\">  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    mxSqlLen -= n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( mxSqlLen&lt;<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">      pParse-&gt;rc = SQLITE_TOOBIG;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( tokenType&gt;=TK_SPACE )&#123;</span><br><span class=\"line\">      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( db-&gt;u1.isInterrupted )&#123;</span><br><span class=\"line\">        pParse-&gt;rc = SQLITE_INTERRUPT;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( tokenType==TK_SPACE )&#123;</span><br><span class=\"line\">        zSql += n;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( zSql[<span class=\"number\">0</span>]==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* Upon reaching the end of input, call the parser two more times</span></span><br><span class=\"line\"><span class=\"comment\">        ** with tokens TK_SEMI and 0, in that order. */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>( lastTokenParsed==TK_SEMI )&#123;</span><br><span class=\"line\">          tokenType = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>( lastTokenParsed==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">          tokenType = TK_SEMI;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        n = <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        sqlite3ErrorMsg(pParse, <span class=\"string\">&quot;unrecognized token: \\&quot;%.*s\\&quot;&quot;</span>, n, zSql);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    pParse-&gt;sLastToken.z = zSql;</span><br><span class=\"line\">    pParse-&gt;sLastToken.n = n;</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);</span><br><span class=\"line\">    lastTokenParsed = tokenType;</span><br><span class=\"line\">    zSql += n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pParse-&gt;rc!=SQLITE_OK || db-&gt;mallocFailed ) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// mem free code...</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> nErr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>parser</p>\n<p>SQLSQLite</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3RunParser</code><code>sqlite3GetToken</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** Return the length (in bytes) of the token that begins at z[0]. </span></span><br><span class=\"line\"><span class=\"comment\">** Store the token type in *tokenType before returning.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3GetToken</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> *tokenType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, c;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>( aiClass[*z] )&#123;  <span class=\"comment\">/* Switch on the character-class of the first byte</span></span><br><span class=\"line\"><span class=\"comment\">                          ** of the token. See the comment on the CC_ defines</span></span><br><span class=\"line\"><span class=\"comment\">                          ** above. */</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_SPACE: &#123;</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27; &#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\t&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\n&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\f&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\r&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isspace(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      *tokenType = TK_SPACE;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_VARNUM: &#123;</span><br><span class=\"line\">      *tokenType = TK_VARIABLE;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// .... more case</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_KYWD: &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; aiClass[z[i]]&lt;=CC_KYWD; i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( IdChar(z[i]) )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* This token started out using characters that can appear in keywords,</span></span><br><span class=\"line\"><span class=\"comment\">        ** but z[i] is a character not allowed within keywords, so this must</span></span><br><span class=\"line\"><span class=\"comment\">        ** be an identifier instead */</span></span><br><span class=\"line\">        i++;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      *tokenType = TK_ID;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> keywordCode((<span class=\"type\">char</span>*)z, i, tokenType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_X: &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> SQLITE_OMIT_BLOB_LITERAL</span></span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;x&#x27;</span> ); testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;X&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( z[<span class=\"number\">1</span>]==<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123;</span><br><span class=\"line\">        *tokenType = TK_BLOB;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(i=<span class=\"number\">2</span>; sqlite3Isxdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> || i%<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">          *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">          <span class=\"keyword\">while</span>( z[i] &amp;&amp; z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123; i++; &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i] ) i++;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"comment\">/* If it is not a BLOB literal, then it must be an ID, since no</span></span><br><span class=\"line\"><span class=\"comment\">      ** SQL keywords start with the letter &#x27;x&#x27;.  Fall through */</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_ID: &#123;</span><br><span class=\"line\">      i = <span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_NUL: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span>( IdChar(z[i]) )&#123; i++; &#125;</span><br><span class=\"line\">  *tokenType = TK_ID;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3GetToken</code>SQL(CC_SPACE,CC_NUL,)switch-case<em></em>(tokenType)Parser.h</p>\n<p><code>aiClass[*z]</code><code>switch(*z)</code></p>\n<p> <em>Switch-Case</em> </p>\n<p>switch-casecaseconstant<a href=\"http://blog.csdn.net/simmerlee/article/details/50845706\">C&#x2F;C++ switch</a></p>\n<ol>\n<li>casecase</li>\n<li>casecase</li>\n<li>O(logn)</li>\n</ol>\n<p>caseO(1)O(logn)SQLite</p>\n<p>ASCII:</p>\n<p>ASCII7bit8bit128256128ASCIISQLite256ASCII256<code>aiClass</code>ASCIISQLite29tokenize.c29switch-caseO(1)</p>\n<p>ASCII aiClass  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Character classes for tokenizing</span></span><br><span class=\"line\"><span class=\"comment\">**</span></span><br><span class=\"line\"><span class=\"comment\">** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented</span></span><br><span class=\"line\"><span class=\"comment\">** using a lookup table, whereas a switch() directly on c uses a binary search.</span></span><br><span class=\"line\"><span class=\"comment\">** The lookup table is much faster.  To maximize speed, and to ensure that</span></span><br><span class=\"line\"><span class=\"comment\">** a lookup table is used, all of the classes need to be small integers and</span></span><br><span class=\"line\"><span class=\"comment\">** all of them need to be used within the switch.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_X          0    <span class=\"comment\">/* The letter &#x27;x&#x27;, or start of BLOB literal */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_KYWD       1    <span class=\"comment\">/* Alphabetics or &#x27;_&#x27;.  Usable in a keyword */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ID         2    <span class=\"comment\">/* unicode characters usable in IDs */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DIGIT      3    <span class=\"comment\">/* Digits */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOLLAR     4    <span class=\"comment\">/* &#x27;$&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARALPHA   5    <span class=\"comment\">/* &#x27;@&#x27;, &#x27;#&#x27;, &#x27;:&#x27;.  Alphabetic SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARNUM     6    <span class=\"comment\">/* &#x27;?&#x27;.  Numeric SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SPACE      7    <span class=\"comment\">/* Space characters */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE      8    <span class=\"comment\">/* &#x27;&quot;&#x27;, &#x27;\\&#x27;&#x27;, or &#x27;`&#x27;.  String literals, quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE2     9    <span class=\"comment\">/* &#x27;[&#x27;.   [...] style quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PIPE      10    <span class=\"comment\">/* &#x27;|&#x27;.   Bitwise OR or concatenate */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_MINUS     11    <span class=\"comment\">/* &#x27;-&#x27;.  Minus or SQL-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LT        12    <span class=\"comment\">/* &#x27;&lt;&#x27;.  Part of &lt; or &lt;= or &lt;&gt; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_GT        13    <span class=\"comment\">/* &#x27;&gt;&#x27;.  Part of &gt; or &gt;= */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_EQ        14    <span class=\"comment\">/* &#x27;=&#x27;.  Part of = or == */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_BANG      15    <span class=\"comment\">/* &#x27;!&#x27;.  Part of != */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SLASH     16    <span class=\"comment\">/* &#x27;/&#x27;.  / or c-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LP        17    <span class=\"comment\">/* &#x27;(&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_RP        18    <span class=\"comment\">/* &#x27;)&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SEMI      19    <span class=\"comment\">/* &#x27;;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PLUS      20    <span class=\"comment\">/* &#x27;+&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_STAR      21    <span class=\"comment\">/* &#x27;*&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PERCENT   22    <span class=\"comment\">/* &#x27;%&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_COMMA     23    <span class=\"comment\">/* &#x27;,&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_AND       24    <span class=\"comment\">/* &#x27;&amp;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_TILDA     25    <span class=\"comment\">/* &#x27;~&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOT       26    <span class=\"comment\">/* &#x27;.&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ILLEGAL   27    <span class=\"comment\">/* Illegal character */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_NUL       28    <span class=\"comment\">/* 0x00 */</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> aiClass[] = &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\"><span class=\"comment\">/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */</span></span><br><span class=\"line\"><span class=\"comment\">/* 0x */</span>   <span class=\"number\">28</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 1x */</span>   <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 2x */</span>    <span class=\"number\">7</span>, <span class=\"number\">15</span>,  <span class=\"number\">8</span>,  <span class=\"number\">5</span>,  <span class=\"number\">4</span>, <span class=\"number\">22</span>, <span class=\"number\">24</span>,  <span class=\"number\">8</span>, <span class=\"number\">17</span>, <span class=\"number\">18</span>, <span class=\"number\">21</span>, <span class=\"number\">20</span>, <span class=\"number\">23</span>, <span class=\"number\">11</span>, <span class=\"number\">26</span>, <span class=\"number\">16</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 3x */</span>    <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">5</span>, <span class=\"number\">19</span>, <span class=\"number\">12</span>, <span class=\"number\">14</span>, <span class=\"number\">13</span>,  <span class=\"number\">6</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 4x */</span>    <span class=\"number\">5</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 5x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">9</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 6x */</span>    <span class=\"number\">8</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 7x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>, <span class=\"number\">27</span>, <span class=\"number\">10</span>, <span class=\"number\">27</span>, <span class=\"number\">25</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 8x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>, <span class=\"comment\">//128 2 CC_ID</span></span><br><span class=\"line\"><span class=\"comment\">/* 9x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ax */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Bx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Cx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Dx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ex */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Fx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>case CC_KYWD<code>keywordCode</code>SQLite<em>ID</em><code>keywordCode</code><a href=\"https://caio.ink/2020/07/16/19.SQLite-KeywordHash/\">SQLiteKeywordHash</a></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLiteSQLiteSQLite</p>\n</blockquote>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>TokenizeSQLiteSQL<em>ID</em>Parserparser<em>ID</em></p>\n<p>Parser</p>\n<p>ParserSQLite<code>$root/tool/</code><code>lemon.c</code>SQLite<code>cmake</code><code>autoconf</code>Makefile:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># lemon.clemon</span><br><span class=\"line\">#</span><br><span class=\"line\">lemon$(BEXE):\t$(TOP)/tool/lemon.c $(TOP)/tool/lempar.c</span><br><span class=\"line\">\t$(BCC) -o $@ $(TOP)/tool/lemon.c</span><br><span class=\"line\">\tcp $(TOP)/tool/lempar.c .</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># parse.h  parse.clemon</span><br><span class=\"line\"># commandlemonparse.yparse.hparse.c</span><br><span class=\"line\">#</span><br><span class=\"line\">parse.h:\tparse.c</span><br><span class=\"line\"></span><br><span class=\"line\">parse.c:\t$(TOP)/src/parse.y lemon$(BEXE) $(TOP)/tool/addopcodes.tcl</span><br><span class=\"line\">\tcp $(TOP)/src/parse.y .</span><br><span class=\"line\">\trm -f parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPT_FEATURE_FLAGS) $(OPTS) parse.y</span><br><span class=\"line\">\tmv parse.h parse.h.temp</span><br><span class=\"line\">\t$(TCLSH_CMD) $(TOP)/tool/addopcodes.tcl parse.h.temp &gt;parse.h</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># fts5lemonfts5parse.y</span><br><span class=\"line\">fts5parse.c:\t$(TOP)/ext/fts5/fts5parse.y lemon</span><br><span class=\"line\">\tcp $(TOP)/ext/fts5/fts5parse.y .</span><br><span class=\"line\">\trm -f fts5parse.h</span><br><span class=\"line\">\t./lemon$(BEXE) $(OPTS) fts5parse.y</span><br></pre></td></tr></table></figure>\n\n<p>Parserlemonparse.hID</p>\n<p>IDTokenize</p>\n<p>SQLite API<br><code>int sqlite3_prepare();</code><br><code>int sqlite3_prepare_v2();</code><br><code>int sqlite3_prepare_v3();</code></p>\n<p>SQLtokenizeparservm<em></em><em></em></p>\n<p>:</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/2020-07-23-00-11.jpg\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>tokenize.c</code> <code>int sqlite3GetToken(const unsigned char *z, int *tokenType)</code>  <code>int sqlite3RunParser(Parse *pParse, const char *zSql, char **pzErrMsg)</code></p>\n<p><code>prepare</code><code>sqlite3RunParser</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3RunParser</span><span class=\"params\">(Parse *pParse, <span class=\"type\">const</span> <span class=\"type\">char</span> *zSql, <span class=\"type\">char</span> **pzErrMsg)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> nErr = <span class=\"number\">0</span>;                   <span class=\"comment\">/* Number of errors encountered */</span></span><br><span class=\"line\">  <span class=\"type\">void</span> *pEngine;                  <span class=\"comment\">/* The LEMON-generated LALR(1) parser */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> n = <span class=\"number\">0</span>;                      <span class=\"comment\">/* Length of the next token token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> tokenType;                  <span class=\"comment\">/* type of the next token */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> lastTokenParsed = <span class=\"number\">-1</span>;       <span class=\"comment\">/* type of the previous token */</span></span><br><span class=\"line\">  sqlite3 *db = pParse-&gt;db;       <span class=\"comment\">/* The database connection */</span></span><br><span class=\"line\">  <span class=\"type\">int</span> mxSqlLen;                   <span class=\"comment\">/* Max length of an SQL string */</span></span><br><span class=\"line\">  pParse-&gt;zTail = zSql;</span><br><span class=\"line\"></span><br><span class=\"line\">  pEngine = sqlite3ParserAlloc(sqlite3Malloc, pParse);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    mxSqlLen -= n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( mxSqlLen&lt;<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">      pParse-&gt;rc = SQLITE_TOOBIG;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( tokenType&gt;=TK_SPACE )&#123;</span><br><span class=\"line\">      assert( tokenType==TK_SPACE || tokenType==TK_ILLEGAL );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( db-&gt;u1.isInterrupted )&#123;</span><br><span class=\"line\">        pParse-&gt;rc = SQLITE_INTERRUPT;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( tokenType==TK_SPACE )&#123;</span><br><span class=\"line\">        zSql += n;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( zSql[<span class=\"number\">0</span>]==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* Upon reaching the end of input, call the parser two more times</span></span><br><span class=\"line\"><span class=\"comment\">        ** with tokens TK_SEMI and 0, in that order. */</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>( lastTokenParsed==TK_SEMI )&#123;</span><br><span class=\"line\">          tokenType = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>( lastTokenParsed==<span class=\"number\">0</span> )&#123;</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">          tokenType = TK_SEMI;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        n = <span class=\"number\">0</span>;</span><br><span class=\"line\">      &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        sqlite3ErrorMsg(pParse, <span class=\"string\">&quot;unrecognized token: \\&quot;%.*s\\&quot;&quot;</span>, n, zSql);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    pParse-&gt;sLastToken.z = zSql;</span><br><span class=\"line\">    pParse-&gt;sLastToken.n = n;</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);</span><br><span class=\"line\">    lastTokenParsed = tokenType;</span><br><span class=\"line\">    zSql += n;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( pParse-&gt;rc!=SQLITE_OK || db-&gt;mallocFailed ) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// mem free code...</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> nErr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">while</span>( <span class=\"number\">1</span> )&#123;</span><br><span class=\"line\">    n = sqlite3GetToken((u8*)zSql, &amp;tokenType);</span><br><span class=\"line\">    sqlite3Parser(pEngine, tokenType, pParse-&gt;sLastToken);    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>parser</p>\n<p>SQLSQLite</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3RunParser</code><code>sqlite3GetToken</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">** Return the length (in bytes) of the token that begins at z[0]. </span></span><br><span class=\"line\"><span class=\"comment\">** Store the token type in *tokenType before returning.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">sqlite3GetToken</span><span class=\"params\">(<span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> *z, <span class=\"type\">int</span> *tokenType)</span>&#123;</span><br><span class=\"line\">  <span class=\"type\">int</span> i, c;</span><br><span class=\"line\">  <span class=\"keyword\">switch</span>( aiClass[*z] )&#123;  <span class=\"comment\">/* Switch on the character-class of the first byte</span></span><br><span class=\"line\"><span class=\"comment\">                          ** of the token. See the comment on the CC_ defines</span></span><br><span class=\"line\"><span class=\"comment\">                          ** above. */</span></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_SPACE: &#123;</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27; &#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\t&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\n&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\f&#x27;</span> );</span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;\\r&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isspace(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      *tokenType = TK_SPACE;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_VARNUM: &#123;</span><br><span class=\"line\">      *tokenType = TK_VARIABLE;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; sqlite3Isdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// .... more case</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_KYWD: &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(i=<span class=\"number\">1</span>; aiClass[z[i]]&lt;=CC_KYWD; i++)&#123;&#125;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( IdChar(z[i]) )&#123;</span><br><span class=\"line\">        <span class=\"comment\">/* This token started out using characters that can appear in keywords,</span></span><br><span class=\"line\"><span class=\"comment\">        ** but z[i] is a character not allowed within keywords, so this must</span></span><br><span class=\"line\"><span class=\"comment\">        ** be an identifier instead */</span></span><br><span class=\"line\">        i++;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      *tokenType = TK_ID;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> keywordCode((<span class=\"type\">char</span>*)z, i, tokenType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_X: &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifndef</span> SQLITE_OMIT_BLOB_LITERAL</span></span><br><span class=\"line\">      testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;x&#x27;</span> ); testcase( z[<span class=\"number\">0</span>]==<span class=\"string\">&#x27;X&#x27;</span> );</span><br><span class=\"line\">      <span class=\"keyword\">if</span>( z[<span class=\"number\">1</span>]==<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123;</span><br><span class=\"line\">        *tokenType = TK_BLOB;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(i=<span class=\"number\">2</span>; sqlite3Isxdigit(z[i]); i++)&#123;&#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> || i%<span class=\"number\">2</span> )&#123;</span><br><span class=\"line\">          *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">          <span class=\"keyword\">while</span>( z[i] &amp;&amp; z[i]!=<span class=\"string\">&#x27;\\&#x27;&#x27;</span> )&#123; i++; &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>( z[i] ) i++;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">      <span class=\"comment\">/* If it is not a BLOB literal, then it must be an ID, since no</span></span><br><span class=\"line\"><span class=\"comment\">      ** SQL keywords start with the letter &#x27;x&#x27;.  Fall through */</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_ID: &#123;</span><br><span class=\"line\">      i = <span class=\"number\">1</span>;</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> CC_NUL: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>: &#123;</span><br><span class=\"line\">      *tokenType = TK_ILLEGAL;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">while</span>( IdChar(z[i]) )&#123; i++; &#125;</span><br><span class=\"line\">  *tokenType = TK_ID;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3GetToken</code>SQL(CC_SPACE,CC_NUL,)switch-case<em></em>(tokenType)Parser.h</p>\n<p><code>aiClass[*z]</code><code>switch(*z)</code></p>\n<p> <em>Switch-Case</em> </p>\n<p>switch-casecaseconstant<a href=\"http://blog.csdn.net/simmerlee/article/details/50845706\">C&#x2F;C++ switch</a></p>\n<ol>\n<li>casecase</li>\n<li>casecase</li>\n<li>O(logn)</li>\n</ol>\n<p>caseO(1)O(logn)SQLite</p>\n<p>ASCII:</p>\n<p>ASCII7bit8bit128256128ASCIISQLite256ASCII256<code>aiClass</code>ASCIISQLite29tokenize.c29switch-caseO(1)</p>\n<p>ASCII aiClass  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* Character classes for tokenizing</span></span><br><span class=\"line\"><span class=\"comment\">**</span></span><br><span class=\"line\"><span class=\"comment\">** In the sqlite3GetToken() function, a switch() on aiClass[c] is implemented</span></span><br><span class=\"line\"><span class=\"comment\">** using a lookup table, whereas a switch() directly on c uses a binary search.</span></span><br><span class=\"line\"><span class=\"comment\">** The lookup table is much faster.  To maximize speed, and to ensure that</span></span><br><span class=\"line\"><span class=\"comment\">** a lookup table is used, all of the classes need to be small integers and</span></span><br><span class=\"line\"><span class=\"comment\">** all of them need to be used within the switch.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_X          0    <span class=\"comment\">/* The letter &#x27;x&#x27;, or start of BLOB literal */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_KYWD       1    <span class=\"comment\">/* Alphabetics or &#x27;_&#x27;.  Usable in a keyword */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ID         2    <span class=\"comment\">/* unicode characters usable in IDs */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DIGIT      3    <span class=\"comment\">/* Digits */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOLLAR     4    <span class=\"comment\">/* &#x27;$&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARALPHA   5    <span class=\"comment\">/* &#x27;@&#x27;, &#x27;#&#x27;, &#x27;:&#x27;.  Alphabetic SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_VARNUM     6    <span class=\"comment\">/* &#x27;?&#x27;.  Numeric SQL variables */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SPACE      7    <span class=\"comment\">/* Space characters */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE      8    <span class=\"comment\">/* &#x27;&quot;&#x27;, &#x27;\\&#x27;&#x27;, or &#x27;`&#x27;.  String literals, quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_QUOTE2     9    <span class=\"comment\">/* &#x27;[&#x27;.   [...] style quoted ids */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PIPE      10    <span class=\"comment\">/* &#x27;|&#x27;.   Bitwise OR or concatenate */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_MINUS     11    <span class=\"comment\">/* &#x27;-&#x27;.  Minus or SQL-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LT        12    <span class=\"comment\">/* &#x27;&lt;&#x27;.  Part of &lt; or &lt;= or &lt;&gt; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_GT        13    <span class=\"comment\">/* &#x27;&gt;&#x27;.  Part of &gt; or &gt;= */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_EQ        14    <span class=\"comment\">/* &#x27;=&#x27;.  Part of = or == */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_BANG      15    <span class=\"comment\">/* &#x27;!&#x27;.  Part of != */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SLASH     16    <span class=\"comment\">/* &#x27;/&#x27;.  / or c-style comment */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_LP        17    <span class=\"comment\">/* &#x27;(&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_RP        18    <span class=\"comment\">/* &#x27;)&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_SEMI      19    <span class=\"comment\">/* &#x27;;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PLUS      20    <span class=\"comment\">/* &#x27;+&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_STAR      21    <span class=\"comment\">/* &#x27;*&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_PERCENT   22    <span class=\"comment\">/* &#x27;%&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_COMMA     23    <span class=\"comment\">/* &#x27;,&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_AND       24    <span class=\"comment\">/* &#x27;&amp;&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_TILDA     25    <span class=\"comment\">/* &#x27;~&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_DOT       26    <span class=\"comment\">/* &#x27;.&#x27; */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_ILLEGAL   27    <span class=\"comment\">/* Illegal character */</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">define</span> CC_NUL       28    <span class=\"comment\">/* 0x00 */</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">const</span> <span class=\"type\">unsigned</span> <span class=\"type\">char</span> aiClass[] = &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">ifdef</span> SQLITE_ASCII</span></span><br><span class=\"line\"><span class=\"comment\">/*         x0  x1  x2  x3  x4  x5  x6  x7  x8  x9  xa  xb  xc  xd  xe  xf */</span></span><br><span class=\"line\"><span class=\"comment\">/* 0x */</span>   <span class=\"number\">28</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>,  <span class=\"number\">7</span>,  <span class=\"number\">7</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 1x */</span>   <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 2x */</span>    <span class=\"number\">7</span>, <span class=\"number\">15</span>,  <span class=\"number\">8</span>,  <span class=\"number\">5</span>,  <span class=\"number\">4</span>, <span class=\"number\">22</span>, <span class=\"number\">24</span>,  <span class=\"number\">8</span>, <span class=\"number\">17</span>, <span class=\"number\">18</span>, <span class=\"number\">21</span>, <span class=\"number\">20</span>, <span class=\"number\">23</span>, <span class=\"number\">11</span>, <span class=\"number\">26</span>, <span class=\"number\">16</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 3x */</span>    <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">3</span>,  <span class=\"number\">5</span>, <span class=\"number\">19</span>, <span class=\"number\">12</span>, <span class=\"number\">14</span>, <span class=\"number\">13</span>,  <span class=\"number\">6</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 4x */</span>    <span class=\"number\">5</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 5x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">9</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>, <span class=\"number\">27</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 6x */</span>    <span class=\"number\">8</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 7x */</span>    <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>,  <span class=\"number\">0</span>,  <span class=\"number\">1</span>,  <span class=\"number\">1</span>, <span class=\"number\">27</span>, <span class=\"number\">10</span>, <span class=\"number\">27</span>, <span class=\"number\">25</span>, <span class=\"number\">27</span>,</span><br><span class=\"line\"><span class=\"comment\">/* 8x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>, <span class=\"comment\">//128 2 CC_ID</span></span><br><span class=\"line\"><span class=\"comment\">/* 9x */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ax */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Bx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Cx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Dx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Ex */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,</span><br><span class=\"line\"><span class=\"comment\">/* Fx */</span>    <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span>,  <span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">endif</span></span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>case CC_KYWD<code>keywordCode</code>SQLite<em>ID</em><code>keywordCode</code><a href=\"https://caio.ink/2020/07/16/19.SQLite-KeywordHash/\">SQLiteKeywordHash</a></p>"},{"title":"The Virtual Machine Module","date":"2020-06-28T16:00:00.000Z","_content":"\nSQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+\n\n<!-- more -->\n\n****\n\n* 5\n* SQL\n* SQLC\n* \n* \n\n# \n\nSQLiteVMVMSQLite()VMSQLiteVMVMB+\"\"\n\nSQLiteVMVMSQLVMSQLiteSQL\n\n****:VM--SQLite\n\n`sqlite3_stmt`(Vdbe)SQLite API SQL\n\n1. sqlite3_bind_*:SQL\n2. sqlite3_step:\n3. sqlite3_reset:\n4. sqlite3_column_*:\n5. sqlite3_finalize:sqlite3_stmt\n\nVdbe\n* \n* \n* \n* \n* \n* (BTree...)\n\nVMVM\n\n## \n\nSQLiteJava5<opcode,P1,P2,P3,P4,P5>,opcodeP1,P2,P3,P4,P532P2P432/6464SQLP55\n\n****\nVMSQLiteSQLiteSQLite\n\n`SELECT * FROM t1`x,y0\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png)\n\n### \n\n14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B/ B+, (ii)    B/B+ , (iii)     key, (iv),(v),  B/B+ ,(vi),    (a)rowid,(b)n(c)i\n\nVdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp\n\nSQLite[SQLite](http://www.sqlite.org/opcode.html)SQLiteOP_\n\n1. Trace: SQLitetracing modeP4(UTF8)`sqlite3_trace`API\n2. Goto: P2VMP2\n3. OpenRead: B/B+root pageP2P50P2pageP2P3--011P1()P4KeyInfoBSQLKeyInfo  P4\n    \nSQLITE_BUSY\n4. RewindP1P2 > 0,P2\n5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3\n6. MakeRecordP1P2keyP1P1+1\n7. ResultRow: P1P1+P2-1`sqlite_step`SQLITE_ROW\n8. Next: P1P2\n9. Close: P1P1\n10. Halt: FIFOsRowSetP1`sqlite3_exec`,`sqlite3_reset`,`sqlite3_finalize`APISQLITE_OK(=0)P1!=0P2P2=OE_FailP2=OE_RollbackP2=OE_AbortP4\n\n`Halt 0 0 0 0 0`\n11. Transaction: P1011P20P2P22\n12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead / Open Write\n13. TableLock: P1pageP2P30P31P4\n\nSQL insert joinVMSQL\n\n### \n\nT1c1 textc2 integer;`insert into T1 values('Hello,Wold!', 2000)`VM:\n\n1. \n2. schema\n3. \"T1\"B+\n4. rowid'Hello,Wold!'2000\n5. B+\n6. \n7. \n\nT1VM\n\n### \n\nSQLiteFROM\n\nSQL : `select * from t1, t2 where ...`\n\n1. \n2. schema\n3. T1t2\n4. \n``` c\nfor each record in T1, do:\n    for each record in T2, do:\n        if WHERETRUE\n            \n            \n            \n```\n5. \n\n### \n\nVM0(1)(2)(2)\n\nCVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\n`sqlite3_prepare`API`sqlite3_stmt`Vbe()VM`aOp``nMem``aMem`\n\n|  |  |\n| ---- | ---- |\n| db | sqlite3 |\n| aOp | VM |\n| nOp | aOp |\n| apCsr |  |\n| nCursor | apCsr |\n| aMem |  |\n| nMem | aMem |\n| rc |  |\n| pc |  |\n| ... |  |\n\nVM(Tree`BtCursors`)keyVMkey/value\n\nVMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM\n\n|  |  |\n| ---- | ---- |\n| pCursor | (BtCursor) |\n| iDb |  |\n| pBt |  |\n| pKeyInfo | key |\n| aType |  |\n| aOffset |  |\n| aRow | (page) |\n| ... |  |\n\n## \n\nVMVM:\n1. INTEGER: \n2. REAL: \n3. TEXT: \n4. BLOB: \n5. NULL: SQL NULL\n\nVM5123BLOBNULLSQLiteSQLite`typeof`--`select a,typeof(a) from t1`a`sqlite3_step`API`sqlite3_column_type`\n\nVMMemMem(Mem): (Vbe.aMemaMem)\n\n|  |  |\n| ---- | ---- |\n| type | Mem |\n| i |  |\n| r |  |\n| z |  |\n| n | z |\n| enc | zUTF |\n| ... |  |\n\n## \n\nVMBB+keyvalueVM(TreeVM)VM\n\ndata/keySQLitebytesSQLite\n\n\n### \n\nSQL:SQLiteSQLite(`integer primary key`[-2^63, 2^63-1])\n\n### \n\nNULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\n**:**89\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\n### \n\nsize(SQLite)\n\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\nHeader sizeData164integerData1header sizeType i2^64Data i\n\n**:**08912130\n\n### key\n\nSQLiteB+-TreekeySQLiterowid\n\n#### Rowid\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,_rowid_),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+\n\n#### Rowid\n\nrowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL\n\n#### Rowid\n\nRowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite\n\n### key\n\nB+keykeyrowidVMrowidB+SQLite\n\nSQLiteB''BrowidBVMTree\n\nSQLitecreate`UNIQUE``PRIMARY KEY``CREATE INDEX`SQLiteT1(a,b,c)a,b\n\n1. \n* `CREATE TABLE T1(a,b,c)`\n* `CREATE INDEX idx1 ON T1(a,b)`\n2. \n* `CREATE TABLE T1(a,b,c,UNIQUE(a,b))`\n3. \n* `CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))`\n\n**:**`INTEGER PRIMARY KEY`B+rowid\n\nSQLite\n`CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);`\n`CREATE INDEX idx2 ON T2(x);`\n\nSQLitex`PRIMARY KEY`,`UNIQUE``INSERT`,`UPDATE``DELETE`\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteBrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ---- |\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nB+\n\n**:**SQLiteSQLorder bygroup byexceptunionintersect\n\n## \n\nSQLiteVMVMVMSQLiteSQLiteVMVM\n\n### \n\nSQLite:(1)SQL,(2)(VM)VM\n\nVMSQLSQLiteINTEGERREALTEXT(SQL)\n\n#### \n\nSQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL`create table T1(a,b,c)`SQLiteSQLVM\n\nVMSQLite\n\n1. SQL:\n    * TEXT\n    * INTEGER\n    * REAL\n    * NULLNULL\n    * X'ABCD'BLOB(ABCD)\n\n    VM\n2. `sqlite3_bind_*`APISQL`sqlite3_bind_blob`BLOB\n\nSQLSQLVM\n\n#### \n\nSQLiteSQLSQLiteSQLiteSQLiteSQL\"\"\n\n5:TEXT,NUMERIC,INTEGER,REALNONE`CREATE TABLE`SQLSQLite\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE\n\n**:**`create table table1 as select ...`SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  \"\"SQL NULLrowidNULL\n\n#### \n\nSQLiteVM:\n\n1. TEXTNULL,TEXT,BLOB()TEXT\n2. NUMERIC5VM()TEXTVMNULLBLOB\n3. INTEGERNUMERIC:VMINTEGER\n4. REALNUMERIC:(SQLite)\n5. NONE5\n\n**:**SQLSQLiteSQL(123\"abc\"),VM()TEXTTEXTASCII\n\n#### \n\nT1B+(a,b,c)NULLNONEVM(+)11(SQLite:)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png)\n\n1. :\n2. 122\n3. 20NULL\n4. 322(22-12)/2=5\n5. 1200B1,177(177B1-79)\n6. 2NULL\n7. 35 68 65 6C 6C 6F\n\n#### \n\nSQL`create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)`SQL`insert into T1 values('1.0', '1.0', '1.0', '1.0', '1.0')`TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC'1.0'1NONE`insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)`REALTEXTINTEGERINTEGERREAL  REALTEXT1.0\"1.0\"TEXT`insert into T1 values(1, 1, 1, 1, 1)`INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER[](http://www.sqlite.org/datatype3.html.)\n\n#### \n\n''SQLite\n\n* **** \n* **** VM\n\n### \n\n`sqlite3_column_*`APISQLiteREALAPI`sqlite3_column_text`VMsprintf()VM\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER | 0 |\n| NULL | FLOAT | 0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() |\n| TEXT | FLOAT | atof() |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | TEXTatoi() |\n| BLOB | FLOAT | TEXTatof() |\n| BLOB | TEXT | \\000 |\n\n### \n\nVMVM\n\n#### SQL NULL\n\nSQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n#### \n\nSQLite\n\n*  =, ==, <, <=, >, >=, <>,  !=\n*  'BETWEEN'\n*  'IN'  'NOT IN'\n*  'IS NULL'  'IS NOT NULL'\n\n**:**'IS NULL''IS NOT NULL''=''!='\n\n\n1. NULLNULLNULL\n2. INTEGERREALTEXTBLOB\n3. INTEGERREALINTEGERREAL\n4. TEXTBLOB\n5. TEXTCmemcmp\n6. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL\n\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)` = (,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n[](http://www.sqlite.org/datatype3.html)`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)``INSERT INTO t1 VALUES(500500500, 500)`a,b,cTEXTINTEGERTEXT  INTEGER\n\n* `SELECT a < 600, a < 60, a < 40 FROM t1`600,6040\"600\",\"60\"\"40\"aTEXTTEXT`1|1|0`\"500\"\"600\"\"60\"\"40\"\n* `SELECT b < 40, b < 60, b < 600 FROM t1``0|0|1`\n* `SELECT c < 40, c < 60, c < 600 FROM t1`cNONE(NUMERIC)\"500\"(TEXT)`0|0|0`\n* `SELECT d < 40, d < 60, d < 600 FROM t1`dNUMERIC`0|0|1`\n\n#### \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### order by\n\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### group by\n\nGROUP BYINTEGERREALGROUP BY\n\n#### SELECTs\nSELECT(UNIONINTERSECTEXCEPT)VM\n\n# \nVM5\n\n`Vdbe`(`sqlite3_stmt`)SQLite API`sqlite3_step`API\n\nVMinteger,real,text,blobSQL NULLVMtypeof SQL\n\nVMSQLiteSQL\n\nSQLiteSQLiteSQL SQLite","source":"_posts/18.db-system-design-imp(VM).md","raw":"---\ntitle: The Virtual Machine Module\ndate: 2020-06-29\ntags: [sqlite3]\ncategories: sqlite3\n---\n\nSQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+\n\n<!-- more -->\n\n****\n\n* 5\n* SQL\n* SQLC\n* \n* \n\n# \n\nSQLiteVMVMSQLite()VMSQLiteVMVMB+\"\"\n\nSQLiteVMVMSQLVMSQLiteSQL\n\n****:VM--SQLite\n\n`sqlite3_stmt`(Vdbe)SQLite API SQL\n\n1. sqlite3_bind_*:SQL\n2. sqlite3_step:\n3. sqlite3_reset:\n4. sqlite3_column_*:\n5. sqlite3_finalize:sqlite3_stmt\n\nVdbe\n* \n* \n* \n* \n* \n* (BTree...)\n\nVMVM\n\n## \n\nSQLiteJava5<opcode,P1,P2,P3,P4,P5>,opcodeP1,P2,P3,P4,P532P2P432/6464SQLP55\n\n****\nVMSQLiteSQLiteSQLite\n\n`SELECT * FROM t1`x,y0\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png)\n\n### \n\n14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B/ B+, (ii)    B/B+ , (iii)     key, (iv),(v),  B/B+ ,(vi),    (a)rowid,(b)n(c)i\n\nVdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp\n\nSQLite[SQLite](http://www.sqlite.org/opcode.html)SQLiteOP_\n\n1. Trace: SQLitetracing modeP4(UTF8)`sqlite3_trace`API\n2. Goto: P2VMP2\n3. OpenRead: B/B+root pageP2P50P2pageP2P3--011P1()P4KeyInfoBSQLKeyInfo  P4\n    \nSQLITE_BUSY\n4. RewindP1P2 > 0,P2\n5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3\n6. MakeRecordP1P2keyP1P1+1\n7. ResultRow: P1P1+P2-1`sqlite_step`SQLITE_ROW\n8. Next: P1P2\n9. Close: P1P1\n10. Halt: FIFOsRowSetP1`sqlite3_exec`,`sqlite3_reset`,`sqlite3_finalize`APISQLITE_OK(=0)P1!=0P2P2=OE_FailP2=OE_RollbackP2=OE_AbortP4\n\n`Halt 0 0 0 0 0`\n11. Transaction: P1011P20P2P22\n12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead / Open Write\n13. TableLock: P1pageP2P30P31P4\n\nSQL insert joinVMSQL\n\n### \n\nT1c1 textc2 integer;`insert into T1 values('Hello,Wold!', 2000)`VM:\n\n1. \n2. schema\n3. \"T1\"B+\n4. rowid'Hello,Wold!'2000\n5. B+\n6. \n7. \n\nT1VM\n\n### \n\nSQLiteFROM\n\nSQL : `select * from t1, t2 where ...`\n\n1. \n2. schema\n3. T1t2\n4. \n``` c\nfor each record in T1, do:\n    for each record in T2, do:\n        if WHERETRUE\n            \n            \n            \n```\n5. \n\n### \n\nVM0(1)(2)(2)\n\nCVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)\n\n```c\nfor (; pc < nOp && rc == SQLITE_OK; pc++){ \n    switch (aOp[pc].opcode){\n    case OP_Add:\n        /* Implementation of the ADD operation here */\n        break; \n    case OP_Goto:\n        pc = op[pc].p2-1;\n        break; \n    case OP_Halt:\n        pc = nOp;\n        break;\n    /* other cases for other opcodes */ }\n}\n```\n\n`sqlite3_prepare`API`sqlite3_stmt`Vbe()VM`aOp``nMem``aMem`\n\n|  |  |\n| ---- | ---- |\n| db | sqlite3 |\n| aOp | VM |\n| nOp | aOp |\n| apCsr |  |\n| nCursor | apCsr |\n| aMem |  |\n| nMem | aMem |\n| rc |  |\n| pc |  |\n| ... |  |\n\nVM(Tree`BtCursors`)keyVMkey/value\n\nVMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM\n\n|  |  |\n| ---- | ---- |\n| pCursor | (BtCursor) |\n| iDb |  |\n| pBt |  |\n| pKeyInfo | key |\n| aType |  |\n| aOffset |  |\n| aRow | (page) |\n| ... |  |\n\n## \n\nVMVM:\n1. INTEGER: \n2. REAL: \n3. TEXT: \n4. BLOB: \n5. NULL: SQL NULL\n\nVM5123BLOBNULLSQLiteSQLite`typeof`--`select a,typeof(a) from t1`a`sqlite3_step`API`sqlite3_column_type`\n\nVMMemMem(Mem): (Vbe.aMemaMem)\n\n|  |  |\n| ---- | ---- |\n| type | Mem |\n| i |  |\n| r |  |\n| z |  |\n| n | z |\n| enc | zUTF |\n| ... |  |\n\n## \n\nVMBB+keyvalueVM(TreeVM)VM\n\ndata/keySQLitebytesSQLite\n\n\n### \n\nSQL:SQLiteSQLite(`integer primary key`[-2^63, 2^63-1])\n\n### \n\nNULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB\n\n**:**89\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | NULL | 0 |\n| N in {1..4} |  | N |\n| 5 |  | 6 |\n| 6 |  | 8 |\n| 7 | IEEE  | 8 |\n| 8 |  0 | 0 |\n| 9 |  1 | 0 |\n| 1011 |  | N/A |\n| N>=12  |  | (N-12)/2 |\n| N>=12  |  | (N-13)/2 |\n\n### \n\nsize(SQLite)\n\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\nHeader sizeData164integerData1header sizeType i2^64Data i\n\n**:**08912130\n\n### key\n\nSQLiteB+-TreekeySQLiterowid\n\n#### Rowid\n\nSQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,_rowid_),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+\n\n#### Rowid\n\nrowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL\n\n#### Rowid\n\nRowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite\n\n### key\n\nB+keykeyrowidVMrowidB+SQLite\n\nSQLiteB''BrowidBVMTree\n\nSQLitecreate`UNIQUE``PRIMARY KEY``CREATE INDEX`SQLiteT1(a,b,c)a,b\n\n1. \n* `CREATE TABLE T1(a,b,c)`\n* `CREATE INDEX idx1 ON T1(a,b)`\n2. \n* `CREATE TABLE T1(a,b,c,UNIQUE(a,b))`\n3. \n* `CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))`\n\n**:**`INTEGER PRIMARY KEY`B+rowid\n\nSQLite\n`CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);`\n`CREATE INDEX idx2 ON T2(x);`\n\nSQLitex`PRIMARY KEY`,`UNIQUE``INSERT`,`UPDATE``DELETE`\n\n|Header size| Type 1 | Type 2|  | Data1 | Data2 | rowid |\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- |\n\nSQLiteBrowidB-Treekeyrowidrowidrowidx.\n\n| x | rowid |\n| ---- | ---- |\n| NULL | 54321 |\n| 456 | 2 |\n| abc | -5 |\n| abc | 1 |\n| hello | 100 |\n\nB+\n\n**:**SQLiteSQLorder bygroup byexceptunionintersect\n\n## \n\nSQLiteVMVMVMSQLiteSQLiteVMVM\n\n### \n\nSQLite:(1)SQL,(2)(VM)VM\n\nVMSQLSQLiteINTEGERREALTEXT(SQL)\n\n#### \n\nSQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL`create table T1(a,b,c)`SQLiteSQLVM\n\nVMSQLite\n\n1. SQL:\n    * TEXT\n    * INTEGER\n    * REAL\n    * NULLNULL\n    * X'ABCD'BLOB(ABCD)\n\n    VM\n2. `sqlite3_bind_*`APISQL`sqlite3_bind_blob`BLOB\n\nSQLSQLVM\n\n#### \n\nSQLiteSQLSQLiteSQLiteSQLiteSQL\"\"\n\n5:TEXT,NUMERIC,INTEGER,REALNONE`CREATE TABLE`SQLSQLite\n\n1. SQLINTINTEGER\n2. SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT\n3. SQLBLOBNONE\n4. SQLREALFLOADOUBREAL\n5. , NUMERIC\n\nVMSQLBLOBINTINTEGERNONE\n\n**:**`create table table1 as select ...`SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  \"\"SQL NULLrowidNULL\n\n#### \n\nSQLiteVM:\n\n1. TEXTNULL,TEXT,BLOB()TEXT\n2. NUMERIC5VM()TEXTVMNULLBLOB\n3. INTEGERNUMERIC:VMINTEGER\n4. REALNUMERIC:(SQLite)\n5. NONE5\n\n**:**SQLSQLiteSQL(123\"abc\"),VM()TEXTTEXTASCII\n\n#### \n\nT1B+(a,b,c)NULLNONEVM(+)11(SQLite:)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png)\n\n1. :\n2. 122\n3. 20NULL\n4. 322(22-12)/2=5\n5. 1200B1,177(177B1-79)\n6. 2NULL\n7. 35 68 65 6C 6C 6F\n\n#### \n\nSQL`create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)`SQL`insert into T1 values('1.0', '1.0', '1.0', '1.0', '1.0')`TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC'1.0'1NONE`insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)`REALTEXTINTEGERINTEGERREAL  REALTEXT1.0\"1.0\"TEXT`insert into T1 values(1, 1, 1, 1, 1)`INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER[](http://www.sqlite.org/datatype3.html.)\n\n#### \n\n''SQLite\n\n* **** \n* **** VM\n\n### \n\n`sqlite3_column_*`APISQLiteREALAPI`sqlite3_column_text`VMsprintf()VM\n\n|  |  |  |\n| ---- | ---- | ---- |\n| NULL | INTEGER | 0 |\n| NULL | FLOAT | 0 |\n| NULL | TEXT | NULL |\n| NULL | BLOB | NULL |\n| INTEGER | FLOAT |  |\n| INTEGER | TEXT | ASCII |\n| INTEGER | BLOB |  |\n| FLOAT | INTEGER |  |\n| FLOAT | TEXT | ASCII |\n| FLOAT | BLOB |  |\n| TEXT | INTEGER | atoi() |\n| TEXT | FLOAT | atof() |\n| TEXT | BLOB |  |\n| BLOB | INTEGER | TEXTatoi() |\n| BLOB | FLOAT | TEXTatof() |\n| BLOB | TEXT | \\000 |\n\n### \n\nVMVM\n\n#### SQL NULL\n\nSQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL\n\n#### \n\nSQLite\n\n*  =, ==, <, <=, >, >=, <>,  !=\n*  'BETWEEN'\n*  'IN'  'NOT IN'\n*  'IS NULL'  'IS NOT NULL'\n\n**:**'IS NULL''IS NOT NULL''=''!='\n\n\n1. NULLNULLNULL\n2. INTEGERREALTEXTBLOB\n3. INTEGERREALINTEGERREAL\n4. TEXTBLOB\n5. TEXTCmemcmp\n6. BLOBmemcmp\n\nVM\n\nrowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL\n\n* NUMERICVM\n* \n* \n\nSQLite`a BETWEEN b AND c``a >= b AND a <= c`a\n\n`a IN (SELECT b ...)` = (,a=b)babaSQLite`a IN (x,y,z)``a = x OR a = y OR a = z`a\n\n[](http://www.sqlite.org/datatype3.html)`CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)``INSERT INTO t1 VALUES(500500500, 500)`a,b,cTEXTINTEGERTEXT  INTEGER\n\n* `SELECT a < 600, a < 60, a < 40 FROM t1`600,6040\"600\",\"60\"\"40\"aTEXTTEXT`1|1|0`\"500\"\"600\"\"60\"\"40\"\n* `SELECT b < 40, b < 60, b < 600 FROM t1``0|0|1`\n* `SELECT c < 40, c < 60, c < 600 FROM t1`cNONE(NUMERIC)\"500\"(TEXT)`0|0|0`\n* `SELECT d < 40, d < 60, d < 600 FROM t1`dNUMERIC`0|0|1`\n\n#### \n\n( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL\n\n#### order by\n\nORDER BYNULLINTEGERREALTEXTBLOBmemcmp()\n\n#### group by\n\nGROUP BYINTEGERREALGROUP BY\n\n#### SELECTs\nSELECT(UNIONINTERSECTEXCEPT)VM\n\n# \nVM5\n\n`Vdbe`(`sqlite3_stmt`)SQLite API`sqlite3_step`API\n\nVMinteger,real,text,blobSQL NULLVMtypeof SQL\n\nVMSQLiteSQL\n\nSQLiteSQLiteSQL SQLite","slug":"18.db-system-design-imp(VM)","published":1,"updated":"2020-08-31T07:16:13.373Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l6000s93c95jvsavs0","content":"<p>SQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+</p>\n<span id=\"more\"></span>\n\n<p><strong></strong></p>\n<ul>\n<li>5</li>\n<li>SQL</li>\n<li>SQLC</li>\n<li></li>\n<li></li>\n</ul>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteVMVMSQLite()VMSQLiteVMVMB+</p>\n<p>SQLiteVMVMSQLVMSQLiteSQL</p>\n<p><strong></strong>:VMSQLite</p>\n<p><code>sqlite3_stmt</code>(Vdbe)SQLite API SQL</p>\n<ol>\n<li>sqlite3_bind_*:SQL</li>\n<li>sqlite3_step:</li>\n<li>sqlite3_reset:</li>\n<li>sqlite3_column_*:</li>\n<li>sqlite3_finalize:sqlite3_stmt</li>\n</ol>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>(BTree)</li>\n</ul>\n<p>VMVM</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteJava5&lt;opcode,P1,P2,P3,P4,P5&gt;,opcodeP1,P2,P3,P4,P532P2P432&#x2F;6464SQLP55</p>\n<p><strong></strong><br>VMSQLiteSQLiteSQLite</p>\n<p><code>SELECT * FROM t1</code>x,y0<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B&#x2F; B+, (ii)    B&#x2F;B+ , (iii)     key, (iv),(v),  B&#x2F;B+ ,(vi),    (a)rowid,(b)n(c)i</p>\n<p>VdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp</p>\n<p>SQLite<a href=\"http://www.sqlite.org/opcode.html\">SQLite</a>SQLiteOP_</p>\n<ol>\n<li>Trace: SQLitetracing modeP4(UTF8)<code>sqlite3_trace</code>API</li>\n<li>Goto: P2VMP2</li>\n<li>OpenRead: B&#x2F;B+root pageP2P50P2pageP2P3011P1()P4KeyInfoBSQLKeyInfo  P4</li>\n</ol>\n<p>SQLITE_BUSY<br>4. RewindP1P2 &gt; 0,P2<br>5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3<br>6. MakeRecordP1P2keyP1P1+1<br>7. ResultRow: P1P1+P2-1<code>sqlite_step</code>SQLITE_ROW<br>8. Next: P1P2<br>9. Close: P1P1<br>10. Halt: FIFOsRowSetP1<code>sqlite3_exec</code>,<code>sqlite3_reset</code>,<code>sqlite3_finalize</code>APISQLITE_OK(&#x3D;0)P1!&#x3D;0P2P2&#x3D;OE_FailP2&#x3D;OE_RollbackP2&#x3D;OE_AbortP4</p>\n<p><code>Halt 0 0 0 0 0</code><br>11. Transaction: P1011P20P2P22<br>12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead &#x2F; Open Write<br>13. TableLock: P1pageP2P30P31P4</p>\n<p>SQL insert joinVMSQL</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>T1c1 textc2 integer;<code>insert into T1 values(&#39;Hello,Wold!&#39;, 2000)</code>VM:</p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1B+</li>\n<li>rowidHello,Wold!2000</li>\n<li>B+</li>\n<li></li>\n<li></li>\n</ol>\n<p>T1VM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteFROM</p>\n<p>SQL : <code>select * from t1, t2 where ...</code></p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1t2</li>\n<li><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> each record in T1, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> each record in T2, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> WHERETRUE</span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br></pre></td></tr></table></figure></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VM0(1)(2)(2)</p>\n<p>CVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3_prepare</code>API<code>sqlite3_stmt</code>Vbe()VM<code>aOp</code><code>nMem</code><code>aMem</code></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>db</td>\n<td>sqlite3</td>\n</tr>\n<tr>\n<td>aOp</td>\n<td>VM</td>\n</tr>\n<tr>\n<td>nOp</td>\n<td>aOp</td>\n</tr>\n<tr>\n<td>apCsr</td>\n<td></td>\n</tr>\n<tr>\n<td>nCursor</td>\n<td>apCsr</td>\n</tr>\n<tr>\n<td>aMem</td>\n<td></td>\n</tr>\n<tr>\n<td>nMem</td>\n<td>aMem</td>\n</tr>\n<tr>\n<td>rc</td>\n<td></td>\n</tr>\n<tr>\n<td>pc</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM(Tree<code>BtCursors</code>)keyVMkey&#x2F;value</p>\n<p>VMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>pCursor</td>\n<td>(BtCursor)</td>\n</tr>\n<tr>\n<td>iDb</td>\n<td></td>\n</tr>\n<tr>\n<td>pBt</td>\n<td></td>\n</tr>\n<tr>\n<td>pKeyInfo</td>\n<td>key</td>\n</tr>\n<tr>\n<td>aType</td>\n<td></td>\n</tr>\n<tr>\n<td>aOffset</td>\n<td></td>\n</tr>\n<tr>\n<td>aRow</td>\n<td>(page)</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMVM:</p>\n<ol>\n<li>INTEGER: </li>\n<li>REAL: </li>\n<li>TEXT: </li>\n<li>BLOB: </li>\n<li>NULL: SQL NULL</li>\n</ol>\n<p>VM5123BLOBNULLSQLiteSQLite<code>typeof</code><code>select a,typeof(a) from t1</code>a<code>sqlite3_step</code>API<code>sqlite3_column_type</code></p>\n<p>VMMemMem(Mem): (Vbe.aMemaMem)</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>type</td>\n<td>Mem</td>\n</tr>\n<tr>\n<td>i</td>\n<td></td>\n</tr>\n<tr>\n<td>r</td>\n<td></td>\n</tr>\n<tr>\n<td>z</td>\n<td></td>\n</tr>\n<tr>\n<td>n</td>\n<td>z</td>\n</tr>\n<tr>\n<td>enc</td>\n<td>zUTF</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMBB+keyvalueVM(TreeVM)VM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQL:SQLiteSQLite(<code>integer primary key</code>[-2^63, 2^63-1])</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>**:**89</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>size(SQLite)</p>\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\n<p>Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>**:**08912130</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>SQLiteB+-TreekeySQLiterowid</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,<em>rowid</em>),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>rowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>RowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>B+keykeyrowidVMrowidB+SQLite</p>\n<p>SQLiteBBrowidBVMTree</p>\n<p>SQLitecreate<code>UNIQUE</code><code>PRIMARY KEY</code><code>CREATE INDEX</code>SQLiteT1(a,b,c)a,b</p>\n<ol>\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c)</code></li>\n<li><code>CREATE INDEX idx1 ON T1(a,b)</code></li>\n</ul>\n<ol start=\"2\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,UNIQUE(a,b))</code></li>\n</ul>\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))</code></li>\n</ul>\n<p><strong>:</strong><code>INTEGER PRIMARY KEY</code>B+rowid</p>\n<p>SQLite<br><code>CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);</code><br><code>CREATE INDEX idx2 ON T2(x);</code></p>\n<p>SQLitex<code>PRIMARY KEY</code>,<code>UNIQUE</code><code>INSERT</code>,<code>UPDATE</code><code>DELETE</code></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteBrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>B+</p>\n<p>**:**SQLiteSQLorder bygroup byexceptunionintersect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteVMVMVMSQLiteSQLiteVMVM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite:(1)SQL,(2)(VM)VM</p>\n<p>VMSQLSQLiteINTEGERREALTEXT(SQL)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL<code>create table T1(a,b,c)</code>SQLiteSQLVM</p>\n<p>VMSQLite</p>\n<ol>\n<li><p>SQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB(ABCD)</li>\n</ul>\n<p> VM</p>\n</li>\n<li><p><code>sqlite3_bind_*</code>APISQL<code>sqlite3_bind_blob</code>BLOB</p>\n</li>\n</ol>\n<p>SQLSQLVM</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteSQLSQLiteSQLiteSQLiteSQL</p>\n<p>5:TEXT,NUMERIC,INTEGER,REALNONE<code>CREATE TABLE</code>SQLSQLite</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE</p>\n<p>**:**<code>create table table1 as select ...</code>SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  SQL NULLrowidNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteVM:</p>\n<ol>\n<li>TEXTNULL,TEXT,BLOB()TEXT</li>\n<li>NUMERIC5VM()TEXTVMNULLBLOB</li>\n<li>INTEGERNUMERIC:VMINTEGER</li>\n<li>REALNUMERIC:(SQLite)</li>\n<li>NONE5</li>\n</ol>\n<p>**:**SQLSQLiteSQL(123abc),VM()TEXTTEXTASCII</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>T1B+(a,b,c)NULLNONEVM(+)11(SQLite:)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png\"></p>\n<ol>\n<li>:</li>\n<li>122</li>\n<li>20NULL</li>\n<li>322(22-12)&#x2F;2&#x3D;5</li>\n<li>1200B1,177(177B1-79)</li>\n<li>2NULL</li>\n<li>35 68 65 6C 6C 6F</li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQL<code>create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)</code>SQL<code>insert into T1 values(&#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;)</code>TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC1.01NONE<code>insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)</code>REALTEXTINTEGERINTEGERREAL  REALTEXT1.01.0TEXT<code>insert into T1 values(1, 1, 1, 1, 1)</code>INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER<a href=\"http://www.sqlite.org/datatype3.html.\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li><strong></strong> </li>\n<li><strong></strong> VM</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>sqlite3_column_*</code>APISQLiteREALAPI<code>sqlite3_column_text</code>VMsprintf()VM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>TEXTatoi()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>TEXTatof()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VMVM</p>\n<h4 id=\"SQL-NULL\"><a href=\"#SQL-NULL\" class=\"headerlink\" title=\"SQL NULL\"></a>SQL NULL</h4><p>SQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &#x3D;&#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;, &lt;&gt;,  !&#x3D;</li>\n<li> BETWEEN</li>\n<li> IN  NOT IN</li>\n<li> IS NULL  IS NOT NULL</li>\n</ul>\n<p>**:**IS NULLIS NOT NULL&#x3D;!&#x3D;</p>\n<p></p>\n<ol>\n<li>NULLNULLNULL</li>\n<li>INTEGERREALTEXTBLOB</li>\n<li>INTEGERREALINTEGERREAL</li>\n<li>TEXTBLOB</li>\n<li>TEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code> &#x3D; (,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><a href=\"http://www.sqlite.org/datatype3.html\"></a><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)</code><code>INSERT INTO t1 VALUES(500500500, 500)</code>a,b,cTEXTINTEGERTEXT  INTEGER</p>\n<ul>\n<li><code>SELECT a &lt; 600, a &lt; 60, a &lt; 40 FROM t1</code>600,6040600,6040aTEXTTEXT<code>1|1|0</code>5006006040</li>\n<li><code>SELECT b &lt; 40, b &lt; 60, b &lt; 600 FROM t1</code><code>0|0|1</code></li>\n<li><code>SELECT c &lt; 40, c &lt; 60, c &lt; 600 FROM t1</code>cNONE(NUMERIC)500(TEXT)<code>0|0|0</code></li>\n<li><code>SELECT d &lt; 40, d &lt; 60, d &lt; 600 FROM t1</code>dNUMERIC<code>0|0|1</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"order-by\"><a href=\"#order-by\" class=\"headerlink\" title=\"order by\"></a>order by</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"group-by\"><a href=\"#group-by\" class=\"headerlink\" title=\"group by\"></a>group by</h4><p>GROUP BYINTEGERREALGROUP BY</p>\n<h4 id=\"SELECTs\"><a href=\"#SELECTs\" class=\"headerlink\" title=\"SELECTs\"></a>SELECTs</h4><p>SELECT(UNIONINTERSECTEXCEPT)VM</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>VM5</p>\n<p><code>Vdbe</code>(<code>sqlite3_stmt</code>)SQLite API<code>sqlite3_step</code>API</p>\n<p>VMinteger,real,text,blobSQL NULLVMtypeof SQL</p>\n<p>VMSQLiteSQL</p>\n<p>SQLiteSQLiteSQL SQLite</p>\n","site":{"data":{}},"excerpt":"<p>SQLiteVMSQLiteVM5:NULL,integer,real,character string,blob,VMVMB-B+</p>","more":"<p><strong></strong></p>\n<ul>\n<li>5</li>\n<li>SQL</li>\n<li>SQLC</li>\n<li></li>\n<li></li>\n</ul>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteVMVMSQLite()VMSQLiteVMVMB+</p>\n<p>SQLiteVMVMSQLVMSQLiteSQL</p>\n<p><strong></strong>:VMSQLite</p>\n<p><code>sqlite3_stmt</code>(Vdbe)SQLite API SQL</p>\n<ol>\n<li>sqlite3_bind_*:SQL</li>\n<li>sqlite3_step:</li>\n<li>sqlite3_reset:</li>\n<li>sqlite3_column_*:</li>\n<li>sqlite3_finalize:sqlite3_stmt</li>\n</ol>\n<p>Vdbe</p>\n<ul>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li></li>\n<li>(BTree)</li>\n</ul>\n<p>VMVM</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteJava5&lt;opcode,P1,P2,P3,P4,P5&gt;,opcodeP1,P2,P3,P4,P532P2P432&#x2F;6464SQLP55</p>\n<p><strong></strong><br>VMSQLiteSQLiteSQLite</p>\n<p><code>SELECT * FROM t1</code>x,y0<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/06/UOiFYp.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>14251.2.3.4.B-B+5. , , , , , , , , , ,   goto , gosub, return , halt  (i) , ,   B&#x2F; B+, (ii)    B&#x2F;B+ , (iii)     key, (iv),(v),  B&#x2F;B+ ,(vi),    (a)rowid,(b)n(c)i</p>\n<p>VdbeOp(1)opcode(2)(3)(4)(5)(6)p1-p55(7)p4typep4p413VdbeOp</p>\n<p>SQLite<a href=\"http://www.sqlite.org/opcode.html\">SQLite</a>SQLiteOP_</p>\n<ol>\n<li>Trace: SQLitetracing modeP4(UTF8)<code>sqlite3_trace</code>API</li>\n<li>Goto: P2VMP2</li>\n<li>OpenRead: B&#x2F;B+root pageP2P50P2pageP2P3011P1()P4KeyInfoBSQLKeyInfo  P4</li>\n</ol>\n<p>SQLITE_BUSY<br>4. RewindP1P2 &gt; 0,P2<br>5. Column: P1P2(P1MakeRecordMakeRecord)P2NULLP4P4_MEM,P4P3<br>6. MakeRecordP1P2keyP1P1+1<br>7. ResultRow: P1P1+P2-1<code>sqlite_step</code>SQLITE_ROW<br>8. Next: P1P2<br>9. Close: P1P1<br>10. Halt: FIFOsRowSetP1<code>sqlite3_exec</code>,<code>sqlite3_reset</code>,<code>sqlite3_finalize</code>APISQLITE_OK(&#x3D;0)P1!&#x3D;0P2P2&#x3D;OE_FailP2&#x3D;OE_RollbackP2&#x3D;OE_AbortP4</p>\n<p><code>Halt 0 0 0 0 0</code><br>11. Transaction: P1011P20P2P22<br>12. VerifyCookie: 0(schemacookie)P2P3(?)P1cookiecookieschemaOpenRead &#x2F; Open Write<br>13. TableLock: P1pageP2P30P31P4</p>\n<p>SQL insert joinVMSQL</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>T1c1 textc2 integer;<code>insert into T1 values(&#39;Hello,Wold!&#39;, 2000)</code>VM:</p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1B+</li>\n<li>rowidHello,Wold!2000</li>\n<li>B+</li>\n<li></li>\n<li></li>\n</ol>\n<p>T1VM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteFROM</p>\n<p>SQL : <code>select * from t1, t2 where ...</code></p>\n<ol>\n<li></li>\n<li>schema</li>\n<li>T1t2</li>\n<li><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> each record in T1, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> each record in T2, <span class=\"keyword\">do</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> WHERETRUE</span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br></pre></td></tr></table></figure></li>\n<li></li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VM0(1)(2)(2)</p>\n<p>CVMVdbesqlite3VdbeExecforcaseSwitchcaseOP_prefixSQLiteSQLiteVMaOppc(Vdbe)(pc++)pcforVM(pc)</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (; pc &lt; nOp &amp;&amp; rc == SQLITE_OK; pc++)&#123; </span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (aOp[pc].opcode)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Add:</span><br><span class=\"line\">        <span class=\"comment\">/* Implementation of the ADD operation here */</span></span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Goto:</span><br><span class=\"line\">        pc = op[pc].p2<span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>; </span><br><span class=\"line\">    <span class=\"keyword\">case</span> OP_Halt:</span><br><span class=\"line\">        pc = nOp;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">/* other cases for other opcodes */</span> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>sqlite3_prepare</code>API<code>sqlite3_stmt</code>Vbe()VM<code>aOp</code><code>nMem</code><code>aMem</code></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>db</td>\n<td>sqlite3</td>\n</tr>\n<tr>\n<td>aOp</td>\n<td>VM</td>\n</tr>\n<tr>\n<td>nOp</td>\n<td>aOp</td>\n</tr>\n<tr>\n<td>apCsr</td>\n<td></td>\n</tr>\n<tr>\n<td>nCursor</td>\n<td>apCsr</td>\n</tr>\n<tr>\n<td>aMem</td>\n<td></td>\n</tr>\n<tr>\n<td>nMem</td>\n<td>aMem</td>\n</tr>\n<tr>\n<td>rc</td>\n<td></td>\n</tr>\n<tr>\n<td>pc</td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>VM(Tree<code>BtCursors</code>)keyVMkey&#x2F;value</p>\n<p>VMVdbeCursorVdbeCursorOP_OpenReadOP_OpenWriteOP_ColumnOP_NextVM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>pCursor</td>\n<td>(BtCursor)</td>\n</tr>\n<tr>\n<td>iDb</td>\n<td></td>\n</tr>\n<tr>\n<td>pBt</td>\n<td></td>\n</tr>\n<tr>\n<td>pKeyInfo</td>\n<td>key</td>\n</tr>\n<tr>\n<td>aType</td>\n<td></td>\n</tr>\n<tr>\n<td>aOffset</td>\n<td></td>\n</tr>\n<tr>\n<td>aRow</td>\n<td>(page)</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMVM:</p>\n<ol>\n<li>INTEGER: </li>\n<li>REAL: </li>\n<li>TEXT: </li>\n<li>BLOB: </li>\n<li>NULL: SQL NULL</li>\n</ol>\n<p>VM5123BLOBNULLSQLiteSQLite<code>typeof</code><code>select a,typeof(a) from t1</code>a<code>sqlite3_step</code>API<code>sqlite3_column_type</code></p>\n<p>VMMemMem(Mem): (Vbe.aMemaMem)</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>type</td>\n<td>Mem</td>\n</tr>\n<tr>\n<td>i</td>\n<td></td>\n</tr>\n<tr>\n<td>r</td>\n<td></td>\n</tr>\n<tr>\n<td>z</td>\n<td></td>\n</tr>\n<tr>\n<td>n</td>\n<td>z</td>\n</tr>\n<tr>\n<td>enc</td>\n<td>zUTF</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>VMBB+keyvalueVM(TreeVM)VM</p>\n<p>data&#x2F;keySQLitebytesSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQL:SQLiteSQLite(<code>integer primary key</code>[-2^63, 2^63-1])</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NULLSQL NULLINTEGER(1,2,3,4,68)REALIEEE88901.TEXT(UTF-8, UTF-16BE, or UTF-16-LE)UTFBLOB</p>\n<p>**:**89</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>NULL</td>\n<td>0</td>\n</tr>\n<tr>\n<td>N in {1..4}</td>\n<td></td>\n<td>N</td>\n</tr>\n<tr>\n<td>5</td>\n<td></td>\n<td>6</td>\n</tr>\n<tr>\n<td>6</td>\n<td></td>\n<td>8</td>\n</tr>\n<tr>\n<td>7</td>\n<td>IEEE </td>\n<td>8</td>\n</tr>\n<tr>\n<td>8</td>\n<td> 0</td>\n<td>0</td>\n</tr>\n<tr>\n<td>9</td>\n<td> 1</td>\n<td>0</td>\n</tr>\n<tr>\n<td>1011</td>\n<td></td>\n<td>N&#x2F;A</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-12)&#x2F;2</td>\n</tr>\n<tr>\n<td>N&gt;&#x3D;12 </td>\n<td></td>\n<td>(N-13)&#x2F;2</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>size(SQLite)</p>\n<table>\n<tr>\n        <th style=\"color:grey\" colspan=\"5\"></th>\n        <th style=\"color:grey\" colspan=\"4\"></th>\n    </tr>\n    <tr>\n        <th>Header size</th>\n        <th>Type 1</th>\n        <th>Type 2</th>\n        <th>...</th>\n        <th>Type N</th>\n        <th>Data 1</th>\n        <th>Data 2</th>\n        <th>...</th>\n        <th>Data N</th>\n    </tr>\n</table>\n\n<p>Header sizeData164integerData1header sizeType i2^64Data i</p>\n<p>**:**08912130</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>SQLiteB+-TreekeySQLiterowid</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>SQLSQLiterowid(oid_rowid_)B+ integer primary keyrowidSQLiterowid((rowid,oid,<em>rowid</em>),rowid) integer primary keykeyrowidrowidrowid[-2^63, 2^63-1](rowid32)B+B+rowidB+</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>rowid(INTEGER PRIMARY KEY),SQLiterowidrowidSQLiterowidSQLiteB+rowidSQLiteSQLITE_FULL</p>\n<h4 id=\"Rowid\"><a href=\"#Rowid\" class=\"headerlink\" title=\"Rowid\"></a>Rowid</h4><p>RowidrowidSQLiteNULL0SQLitekeyrowid9rowidSQLite</p>\n<h3 id=\"key\"><a href=\"#key\" class=\"headerlink\" title=\"key\"></a>key</h3><p>B+keykeyrowidVMrowidB+SQLite</p>\n<p>SQLiteBBrowidBVMTree</p>\n<p>SQLitecreate<code>UNIQUE</code><code>PRIMARY KEY</code><code>CREATE INDEX</code>SQLiteT1(a,b,c)a,b</p>\n<ol>\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c)</code></li>\n<li><code>CREATE INDEX idx1 ON T1(a,b)</code></li>\n</ul>\n<ol start=\"2\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,UNIQUE(a,b))</code></li>\n</ul>\n<ol start=\"3\">\n<li></li>\n</ol>\n<ul>\n<li><code>CREATE TABLE T1(a,b,c,PRIMARY KEY(a,b))</code></li>\n</ul>\n<p><strong>:</strong><code>INTEGER PRIMARY KEY</code>B+rowid</p>\n<p>SQLite<br><code>CREATE TABLE T2(x VARCHAR(5) UNIQUE PRIMARY KEY , y BLOB);</code><br><code>CREATE INDEX idx2 ON T2(x);</code></p>\n<p>SQLitex<code>PRIMARY KEY</code>,<code>UNIQUE</code><code>INSERT</code>,<code>UPDATE</code><code>DELETE</code></p>\n<table>\n<thead>\n<tr>\n<th>Header size</th>\n<th>Type 1</th>\n<th>Type 2</th>\n<th></th>\n<th>Data1</th>\n<th>Data2</th>\n<th>rowid</th>\n</tr>\n</thead>\n</table>\n<p>SQLiteBrowidB-Treekeyrowidrowidrowidx.</p>\n<table>\n<thead>\n<tr>\n<th>x</th>\n<th>rowid</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>54321</td>\n</tr>\n<tr>\n<td>456</td>\n<td>2</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>-5</td>\n</tr>\n<tr>\n<td>abc</td>\n<td>1</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>100</td>\n</tr>\n</tbody></table>\n<p>B+</p>\n<p>**:**SQLiteSQLorder bygroup byexceptunionintersect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteVMVMVMSQLiteSQLiteVMVM</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite:(1)SQL,(2)(VM)VM</p>\n<p>VMSQLSQLiteINTEGERREALTEXT(SQL)</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite(SQLite)(INTEGER PRIMARY KEYVM)SQLiteSQL<code>create table T1(a,b,c)</code>SQLiteSQLVM</p>\n<p>VMSQLite</p>\n<ol>\n<li><p>SQL:</p>\n<ul>\n<li>TEXT</li>\n<li>INTEGER</li>\n<li>REAL</li>\n<li>NULLNULL</li>\n<li>XABCDBLOB(ABCD)</li>\n</ul>\n<p> VM</p>\n</li>\n<li><p><code>sqlite3_bind_*</code>APISQL<code>sqlite3_bind_blob</code>BLOB</p>\n</li>\n</ol>\n<p>SQLSQLVM</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteSQLSQLiteSQLiteSQLiteSQL</p>\n<p>5:TEXT,NUMERIC,INTEGER,REALNONE<code>CREATE TABLE</code>SQLSQLite</p>\n<ol>\n<li>SQLINTINTEGER</li>\n<li>SQLCHARBLOBTEXTTEXT SQLVARCHARCHARTEXT</li>\n<li>SQLBLOBNONE</li>\n<li>SQLREALFLOADOUBREAL</li>\n<li>, NUMERIC</li>\n</ol>\n<p>VMSQLBLOBINTINTEGERNONE</p>\n<p>**:**<code>create table table1 as select ...</code>SQLcreate tableselecttext, numeric, integer, real,  nonetext, num, int, real,  SQL NULLrowidNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLiteVM:</p>\n<ol>\n<li>TEXTNULL,TEXT,BLOB()TEXT</li>\n<li>NUMERIC5VM()TEXTVMNULLBLOB</li>\n<li>INTEGERNUMERIC:VMINTEGER</li>\n<li>REALNUMERIC:(SQLite)</li>\n<li>NONE5</li>\n</ol>\n<p>**:**SQLSQLiteSQL(123abc),VM()TEXTTEXTASCII</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>T1B+(a,b,c)NULLNONEVM(+)11(SQLite:)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/07/KZKZlm.png\"></p>\n<ol>\n<li>:</li>\n<li>122</li>\n<li>20NULL</li>\n<li>322(22-12)&#x2F;2&#x3D;5</li>\n<li>1200B1,177(177B1-79)</li>\n<li>2NULL</li>\n<li>35 68 65 6C 6C 6F</li>\n</ol>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQL<code>create table T1(t TEXT,n NUMERIC,i INTEGER, r REAL,b BLOB)</code>SQL<code>insert into T1 values(&#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;, &#39;1.0&#39;)</code>TEXTt,n,i,r,bTEXTNUMERICINTEGERREAL  NONEt,n,i,r,bTEXTINTEGERINTEGERREAL  TEXTNUMERIC1.01NONE<code>insert into T1 values(1.0, 1.0, 1.0, 1.0, 1.0)</code>REALTEXTINTEGERINTEGERREAL  REALTEXT1.01.0TEXT<code>insert into T1 values(1, 1, 1, 1, 1)</code>INTEGERTEXT, INTEGER, INTEGER, REAL  INTEGER<a href=\"http://www.sqlite.org/datatype3.html.\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li><strong></strong> </li>\n<li><strong></strong> VM</li>\n</ul>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>sqlite3_column_*</code>APISQLiteREALAPI<code>sqlite3_column_text</code>VMsprintf()VM</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>NULL</td>\n<td>INTEGER</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>FLOAT</td>\n<td>0</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>TEXT</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>NULL</td>\n<td>BLOB</td>\n<td>NULL</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>FLOAT</td>\n<td></td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>INTEGER</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>INTEGER</td>\n<td></td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>TEXT</td>\n<td>ASCII</td>\n</tr>\n<tr>\n<td>FLOAT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>INTEGER</td>\n<td>atoi()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>FLOAT</td>\n<td>atof()</td>\n</tr>\n<tr>\n<td>TEXT</td>\n<td>BLOB</td>\n<td></td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>INTEGER</td>\n<td>TEXTatoi()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>FLOAT</td>\n<td>TEXTatof()</td>\n</tr>\n<tr>\n<td>BLOB</td>\n<td>TEXT</td>\n<td>\\000</td>\n</tr>\n</tbody></table>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>VMVM</p>\n<h4 id=\"SQL-NULL\"><a href=\"#SQL-NULL\" class=\"headerlink\" title=\"SQL NULL\"></a>SQL NULL</h4><p>SQL NULLNULLNULLNULLSQLNULLNULLNULLSQLiteRDBMSNULLSELECT DISTINCTUNIONSELECTGROUP BYNULLNULLUNIQUENULLSQLSUMNULLNULL</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>SQLite</p>\n<ul>\n<li> &#x3D;, &#x3D;&#x3D;, &lt;, &lt;&#x3D;, &gt;, &gt;&#x3D;, &lt;&gt;,  !&#x3D;</li>\n<li> BETWEEN</li>\n<li> IN  NOT IN</li>\n<li> IS NULL  IS NOT NULL</li>\n</ul>\n<p>**:**IS NULLIS NOT NULL&#x3D;!&#x3D;</p>\n<p></p>\n<ol>\n<li>NULLNULLNULL</li>\n<li>INTEGERREALTEXTBLOB</li>\n<li>INTEGERREALINTEGERREAL</li>\n<li>TEXTBLOB</li>\n<li>TEXTCmemcmp</li>\n<li>BLOBmemcmp</li>\n</ol>\n<p>VM</p>\n<p>rowidSQLNONESQLiteINTEGERREALTEXT(expr.csqlite3CompareAffinity)SQL</p>\n<ul>\n<li>NUMERICVM</li>\n<li></li>\n<li></li>\n</ul>\n<p>SQLite<code>a BETWEEN b AND c</code><code>a &gt;= b AND a &lt;= c</code>a</p>\n<p><code>a IN (SELECT b ...)</code> &#x3D; (,a&#x3D;b)babaSQLite<code>a IN (x,y,z)</code><code>a = x OR a = y OR a = z</code>a</p>\n<p><a href=\"http://www.sqlite.org/datatype3.html\"></a><code>CREATE TABLE t1(a TEXT,b NUMERIC, c BLOB, d)</code><code>INSERT INTO t1 VALUES(500500500, 500)</code>a,b,cTEXTINTEGERTEXT  INTEGER</p>\n<ul>\n<li><code>SELECT a &lt; 600, a &lt; 60, a &lt; 40 FROM t1</code>600,6040600,6040aTEXTTEXT<code>1|1|0</code>5006006040</li>\n<li><code>SELECT b &lt; 40, b &lt; 60, b &lt; 600 FROM t1</code><code>0|0|1</code></li>\n<li><code>SELECT c &lt; 40, c &lt; 60, c &lt; 600 FROM t1</code>cNONE(NUMERIC)500(TEXT)<code>0|0|0</code></li>\n<li><code>SELECT d &lt; 40, d &lt; 60, d &lt; 600 FROM t1</code>dNUMERIC<code>0|0|1</code></li>\n</ul>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p>( || )NUMERICNUMERICNULLTEXTTEXT(NULLBLOB)NULL</p>\n<h4 id=\"order-by\"><a href=\"#order-by\" class=\"headerlink\" title=\"order by\"></a>order by</h4><p>ORDER BYNULLINTEGERREALTEXTBLOBmemcmp()</p>\n<h4 id=\"group-by\"><a href=\"#group-by\" class=\"headerlink\" title=\"group by\"></a>group by</h4><p>GROUP BYINTEGERREALGROUP BY</p>\n<h4 id=\"SELECTs\"><a href=\"#SELECTs\" class=\"headerlink\" title=\"SELECTs\"></a>SELECTs</h4><p>SELECT(UNIONINTERSECTEXCEPT)VM</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>VM5</p>\n<p><code>Vdbe</code>(<code>sqlite3_stmt</code>)SQLite API<code>sqlite3_step</code>API</p>\n<p>VMinteger,real,text,blobSQL NULLVMtypeof SQL</p>\n<p>VMSQLiteSQL</p>\n<p>SQLiteSQLiteSQL SQLite</p>"},{"title":"Transaction Management","date":"2020-08-20T16:00:00.000Z","_content":"\n> DBMSDBMSSQLiteACIDSQLiteSQLiteACID`Pager`SQLitepager\n\n<!-- more -->\n\n# \nDBMSDBMS()DBMSDBMSDBMSDBMSSQLite\n\n## \nSQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite\n\nSELECTSELECT\n\nselectSQLiteselectselectselectselectselectselectselect\n\n## \nselectSQL()SQL`BEGIN TRANSACTION`(`COMMIT TRANACTION``ROLLBACKTRANACTION`)SQL`begin-commit``begin-rolback`selectselect\n\n`BEGIN`SQLiteSQLselectselect`COMMIT``ROLLBACK`SQLiteSQLite\n\nSQLite\n\n## \nSQLiteSQLiteOK\n\n## \nselectSQLiteCOMMITABORTSQLite();SQLSQLite:\n\n```\nBEGIN TRANSACTION;\n    INSERT INTO table1 VALUES(100);\n    INSERT INTO table2 VALUES(20,100);\n    UPDATE table1 SET x=x+1 WHERE y > 10;\n    INSERT INTO table3 VALUES(1,2,3);\nCOMMIT TRANSACTION;\n```\n\ntable1table2table3`begin transaction`UPDATEINSERT`COMMIT TRANSACTIOIN`\n\n****:insertupdate5`Rollback`:`Abort`:`Fail`:`Ignore`:;`Replace`:;\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n# \nSQLite()-journal\n\n**vs**:SQLite`journal mode`(wal)(`pragma locking_mode=exclusive`)SQLite\n\nSQLite/SQLite(SQLite)SQLite\n\n:()SQLite\n\n****:SQLitemap\n\n****:page\n\nSQLiteattach(attach)\n\n****:()\n\n## \nSQLiteWALSQLite:SQLite\n\n## \nSQLiteflush\n\n****:SQLiteSQLiteSQLiteflushflush\n\n# \nSQLiteSQLite\n","source":"_posts/2020-08-21_db-system-design-imp(Transaction).md","raw":"---\ntitle: Transaction Management\ndate: 2020-08-21\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> DBMSDBMSSQLiteACIDSQLiteSQLiteACID`Pager`SQLitepager\n\n<!-- more -->\n\n# \nDBMSDBMS()DBMSDBMSDBMSDBMSSQLite\n\n## \nSQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite\n\nSELECTSELECT\n\nselectSQLiteselectselectselectselectselectselectselect\n\n## \nselectSQL()SQL`BEGIN TRANSACTION`(`COMMIT TRANACTION``ROLLBACKTRANACTION`)SQL`begin-commit``begin-rolback`selectselect\n\n`BEGIN`SQLiteSQLselectselect`COMMIT``ROLLBACK`SQLiteSQLite\n\nSQLite\n\n## \nSQLiteSQLiteOK\n\n## \nselectSQLiteCOMMITABORTSQLite();SQLSQLite:\n\n```\nBEGIN TRANSACTION;\n    INSERT INTO table1 VALUES(100);\n    INSERT INTO table2 VALUES(20,100);\n    UPDATE table1 SET x=x+1 WHERE y > 10;\n    INSERT INTO table3 VALUES(1,2,3);\nCOMMIT TRANSACTION;\n```\n\ntable1table2table3`begin transaction`UPDATEINSERT`COMMIT TRANSACTIOIN`\n\n****:insertupdate5`Rollback`:`Abort`:`Fail`:`Ignore`:;`Replace`:;\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n# \nSQLite()-journal\n\n**vs**:SQLite`journal mode`(wal)(`pragma locking_mode=exclusive`)SQLite\n\nSQLite/SQLite(SQLite)SQLite\n\n:()SQLite\n\n****:SQLitemap\n\n****:page\n\nSQLiteattach(attach)\n\n****:()\n\n## \nSQLiteWALSQLite:SQLite\n\n## \nSQLiteflush\n\n****:SQLiteSQLiteSQLiteflushflush\n\n# \nSQLiteSQLite\n","slug":"2020-08-21_db-system-design-imp(Transaction)","published":1,"updated":"2020-08-31T07:21:34.085Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l7000u93c95lk8gefu","content":"<blockquote>\n<p>DBMSDBMSSQLiteACIDSQLiteSQLiteACID<code>Pager</code>SQLitepager</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>DBMSDBMS()DBMSDBMSDBMSDBMSSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite</p>\n<p>SELECTSELECT</p>\n<p>selectSQLiteselectselectselectselectselectselectselect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQL()SQL<code>BEGIN TRANSACTION</code>(<code>COMMIT TRANACTION</code><code>ROLLBACKTRANACTION</code>)SQL<code>begin-commit</code><code>begin-rolback</code>selectselect</p>\n<p><code>BEGIN</code>SQLiteSQLselectselect<code>COMMIT</code><code>ROLLBACK</code>SQLiteSQLite</p>\n<p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQLiteOK</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQLiteCOMMITABORTSQLite();SQLSQLite:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BEGIN TRANSACTION;</span><br><span class=\"line\">    INSERT INTO table1 VALUES(100);</span><br><span class=\"line\">    INSERT INTO table2 VALUES(20,100);</span><br><span class=\"line\">    UPDATE table1 SET x=x+1 WHERE y &gt; 10;</span><br><span class=\"line\">    INSERT INTO table3 VALUES(1,2,3);</span><br><span class=\"line\">COMMIT TRANSACTION;</span><br></pre></td></tr></table></figure>\n\n<p>table1table2table3<code>begin transaction</code>UPDATEINSERT<code>COMMIT TRANSACTIOIN</code></p>\n<p><strong></strong>:insertupdate5<code>Rollback</code>:<code>Abort</code>:<code>Fail</code>:<code>Ignore</code>:;<code>Replace</code>:;</p>\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()-journal</p>\n<p><strong>vs</strong>:SQLite<code>journal mode</code>(wal)(<code>pragma locking_mode=exclusive</code>)SQLite</p>\n<p>SQLite&#x2F;SQLite(SQLite)SQLite</p>\n<p>:()SQLite</p>\n<p><strong></strong>:SQLitemap</p>\n<p><strong></strong>:page</p>\n<p>SQLiteattach(attach)</p>\n<p><strong></strong>:()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteWALSQLite:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteflush</p>\n<p><strong></strong>:SQLiteSQLiteSQLiteflushflush</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteSQLite</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>DBMSDBMSSQLiteACIDSQLiteSQLiteACID<code>Pager</code>SQLitepager</p>\n</blockquote>","more":"<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>DBMSDBMS()DBMSDBMSDBMSDBMSSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQL(SQLite)SQLiteSQLSQLiteSELECTSQLiteSELECTSQLiteSQLiteSQLite</p>\n<p>SELECTSELECT</p>\n<p>selectSQLiteselectselectselectselectselectselectselect</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQL()SQL<code>BEGIN TRANSACTION</code>(<code>COMMIT TRANACTION</code><code>ROLLBACKTRANACTION</code>)SQL<code>begin-commit</code><code>begin-rolback</code>selectselect</p>\n<p><code>BEGIN</code>SQLiteSQLselectselect<code>COMMIT</code><code>ROLLBACK</code>SQLiteSQLite</p>\n<p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteSQLiteOK</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>selectSQLiteCOMMITABORTSQLite();SQLSQLite:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BEGIN TRANSACTION;</span><br><span class=\"line\">    INSERT INTO table1 VALUES(100);</span><br><span class=\"line\">    INSERT INTO table2 VALUES(20,100);</span><br><span class=\"line\">    UPDATE table1 SET x=x+1 WHERE y &gt; 10;</span><br><span class=\"line\">    INSERT INTO table3 VALUES(1,2,3);</span><br><span class=\"line\">COMMIT TRANSACTION;</span><br></pre></td></tr></table></figure>\n\n<p>table1table2table3<code>begin transaction</code>UPDATEINSERT<code>COMMIT TRANSACTIOIN</code></p>\n<p><strong></strong>:insertupdate5<code>Rollback</code>:<code>Abort</code>:<code>Fail</code>:<code>Ignore</code>:;<code>Replace</code>:;</p>\n<!---\n# \n//TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## \n////TODO:\n## Linux\n////TODO:\n## SQLite\n////TODO:\n### SQLite\n//////TODO:\n### \n//////TODO:\n### Linux\n//////TODO:\n### \n//////TODO:\n## API\n////TODO:\n### sqlite3OsLock\n//////TODO:\n### sqlite3OsUnlock\n//////TODO:\n--->\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()-journal</p>\n<p><strong>vs</strong>:SQLite<code>journal mode</code>(wal)(<code>pragma locking_mode=exclusive</code>)SQLite</p>\n<p>SQLite&#x2F;SQLite(SQLite)SQLite</p>\n<p>:()SQLite</p>\n<p><strong></strong>:SQLitemap</p>\n<p><strong></strong>:page</p>\n<p>SQLiteattach(attach)</p>\n<p><strong></strong>:()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteWALSQLite:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteflush</p>\n<p><strong></strong>:SQLiteSQLiteSQLiteflushflush</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLiteSQLite</p>"},{"title":"Storage","date":"2020-08-24T16:00:00.000Z","_content":"\n> SQLiteB/B+WAL\n\n<!-- more -->\n\n<!---\n# \n--->\n\n# \nSQLite//(flush)\n\n## \n/SQLite()112001(Pager)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png)\n\n## \n10242[512(=2^9),65536(=2^16)]2(2^31-1)pager.c`PAGER_MAX_PGNO`140TB\n\n****:SQLitepragmaSQLiteSQLite\n\n## \nSQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()\n\n## \nSQLite1B+`sqlite_master``sqlite_temp_master`1000\n\nSQLite\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 16 | \"SQLite format 3\" |\n| 16 | 2 |  |\n| 18 | 1 |  |\n| 19 | 1 |  |\n| 20 | 1 |  |\n| 21 | 1 |  |\n| 22 | 1 |  |\n| 23 | 1 |  |\n| 24 | 4 |  |\n| 28 | 4 |  |\n| 32 | 4 |  |\n| 36 | 4 |  |\n| 40 | 4 |  |\n| 44 | 56 | 144 |\n\n* ****:16UTF-8\"SQLite format 3\"\n* ****:2n[51232768]165536SQLite()\n* ****:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)\n* ****:SQLite255200SQLite480\n* ****:21B/B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B\n* ****:0pager(WAL)\n* ****:28\n* ****:3236\n* ****:4040()\n* ****:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296\n\n** vs. **:5246440`vacuum`\n\n1B+`sqlite_master``sqlite_temp_master`1SQLite\n\n## \n3236()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png)\n\n:(1)4(0)(2)(3)\n\nSQLiteSQLite()SQLite\n\n`VACUUM``autovacuum`\n\n****`vacuum`\n\n# \nSQLite(SQLite3.7.0SQLiteWALWAL)\n\n## \nSQLite()SQLite\n\nSQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png)\n\n### \n8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 `nRec`)`nRec`-10\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png)\n\n****:SQLite512SQLite\n\nSQLite(pager****)`nRec`-1\n\n****:00\n\n****:SQLite`nRec`-1SQLite`pragma`case\n\n### \nselectSQLite432432SQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png)\n\n****:SQLite\n\n## \nSQLiteetilqs_SQLite`nRec`\n\n****:SAVEPOINTSQLite\n\n## \n`ATTACH`SQLiteSQLiteUTF-8()'-mj'816\n\n()UTF-8SQLitewindowsPOSIX()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png)","source":"_posts/2020-08-25_db-system-design-im(storage).md","raw":"---\ntitle: Storage\ndate: 2020-08-25\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLiteB/B+WAL\n\n<!-- more -->\n\n<!---\n# \n--->\n\n# \nSQLite//(flush)\n\n## \n/SQLite()112001(Pager)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png)\n\n## \n10242[512(=2^9),65536(=2^16)]2(2^31-1)pager.c`PAGER_MAX_PGNO`140TB\n\n****:SQLitepragmaSQLiteSQLite\n\n## \nSQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()\n\n## \nSQLite1B+`sqlite_master``sqlite_temp_master`1000\n\nSQLite\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 16 | \"SQLite format 3\" |\n| 16 | 2 |  |\n| 18 | 1 |  |\n| 19 | 1 |  |\n| 20 | 1 |  |\n| 21 | 1 |  |\n| 22 | 1 |  |\n| 23 | 1 |  |\n| 24 | 4 |  |\n| 28 | 4 |  |\n| 32 | 4 |  |\n| 36 | 4 |  |\n| 40 | 4 |  |\n| 44 | 56 | 144 |\n\n* ****:16UTF-8\"SQLite format 3\"\n* ****:2n[51232768]165536SQLite()\n* ****:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)\n* ****:SQLite255200SQLite480\n* ****:21B/B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B\n* ****:0pager(WAL)\n* ****:28\n* ****:3236\n* ****:4040()\n* ****:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296\n\n** vs. **:5246440`vacuum`\n\n1B+`sqlite_master``sqlite_temp_master`1SQLite\n\n## \n3236()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png)\n\n:(1)4(0)(2)(3)\n\nSQLiteSQLite()SQLite\n\n`VACUUM``autovacuum`\n\n****`vacuum`\n\n# \nSQLite(SQLite3.7.0SQLiteWALWAL)\n\n## \nSQLite()SQLite\n\nSQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png)\n\n### \n8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 `nRec`)`nRec`-10\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png)\n\n****:SQLite512SQLite\n\nSQLite(pager****)`nRec`-1\n\n****:00\n\n****:SQLite`nRec`-1SQLite`pragma`case\n\n### \nselectSQLite432432SQLite\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png)\n\n****:SQLite\n\n## \nSQLiteetilqs_SQLite`nRec`\n\n****:SAVEPOINTSQLite\n\n## \n`ATTACH`SQLiteSQLiteUTF-8()'-mj'816\n\n()UTF-8SQLitewindowsPOSIX()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png)","slug":"2020-08-25_db-system-design-im(storage)","published":1,"updated":"2020-08-31T07:21:34.086Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l8000y93c961a23m26","content":"<blockquote>\n<p>SQLiteB&#x2F;B+WAL</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<!---\n# \n--->\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite&#x2F;&#x2F;(flush)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>&#x2F;SQLite()112001(Pager)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>10242[512(&#x3D;2^9),65536(&#x3D;2^16)]2(2^31-1)pager.c<code>PAGER_MAX_PGNO</code>140TB</p>\n<p><strong></strong>:SQLitepragmaSQLiteSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1000</p>\n<p>SQLite</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>16</td>\n<td>SQLite format 3</td>\n</tr>\n<tr>\n<td>16</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>18</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>19</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>20</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>21</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>22</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>23</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>32</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>36</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>40</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>44</td>\n<td>56</td>\n<td>144</td>\n</tr>\n</tbody></table>\n<ul>\n<li><strong></strong>:16UTF-8SQLite format 3</li>\n<li><strong></strong>:2n[51232768]165536SQLite()</li>\n<li><strong></strong>:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)</li>\n<li><strong></strong>:SQLite255200SQLite480</li>\n<li><strong></strong>:21B&#x2F;B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B</li>\n<li><strong></strong>:0pager(WAL)</li>\n<li><strong></strong>:28</li>\n<li><strong></strong>:3236</li>\n<li><strong></strong>:4040()</li>\n<li><strong></strong>:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296</li>\n</ul>\n<p><strong> vs. </strong>:5246440<code>vacuum</code></p>\n<p>1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>3236()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png\"></p>\n<p>:(1)4(0)(2)(3)</p>\n<p>SQLiteSQLite()SQLite</p>\n<p><code>VACUUM</code><code>autovacuum</code></p>\n<p><strong></strong><code>vacuum</code></p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite(SQLite3.7.0SQLiteWALWAL)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()SQLite</p>\n<p>SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 <code>nRec</code>)<code>nRec</code>-10</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png\"></p>\n<p><strong></strong>:SQLite512SQLite</p>\n<p>SQLite(pager<strong></strong>)<code>nRec</code>-1</p>\n<p><strong></strong>:00</p>\n<p><strong></strong>:SQLite<code>nRec</code>-1SQLite<code>pragma</code>case</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>selectSQLite432432SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png\"></p>\n<p><strong></strong>:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteetilqs_SQLite<code>nRec</code></p>\n<p><strong></strong>:SAVEPOINTSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>ATTACH</code>SQLiteSQLiteUTF-8()-mj816</p>\n<p>()UTF-8SQLitewindowsPOSIX()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png\"></p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLiteB&#x2F;B+WAL</p>\n</blockquote>","more":"<!---\n# \n--->\n\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite&#x2F;&#x2F;(flush)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>&#x2F;SQLite()112001(Pager)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/XLYFMb.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>10242[512(&#x3D;2^9),65536(&#x3D;2^16)]2(2^31-1)pager.c<code>PAGER_MAX_PGNO</code>140TB</p>\n<p><strong></strong>:SQLitepragmaSQLiteSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite(SQLite)4:(autovacuumincremental vacuum):BB+B+(B)B+()</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1000</p>\n<p>SQLite</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>16</td>\n<td>SQLite format 3</td>\n</tr>\n<tr>\n<td>16</td>\n<td>2</td>\n<td></td>\n</tr>\n<tr>\n<td>18</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>19</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>20</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>21</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>22</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>23</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>32</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>36</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>40</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>44</td>\n<td>56</td>\n<td>144</td>\n</tr>\n</tbody></table>\n<ul>\n<li><strong></strong>:16UTF-8SQLite format 3</li>\n<li><strong></strong>:2n[51232768]165536SQLite()</li>\n<li><strong></strong>:1819SQLite121(SQLite3.7.0)2WAL(SQLite3.7.0)</li>\n<li><strong></strong>:SQLite255200SQLite480</li>\n<li><strong></strong>:21B&#x2F;B+255100%<br/>6425):SQLite2232(12.5%)<br/>(23)B+32(12.5%)100255B</li>\n<li><strong></strong>:0pager(WAL)</li>\n<li><strong></strong>:28</li>\n<li><strong></strong>:3236</li>\n<li><strong></strong>:4040()</li>\n<li><strong></strong>:4414TreeVM4448520561UTF-82UTF-16 LE3UTF-16 BE60SQLite6409296</li>\n</ul>\n<p><strong> vs. </strong>:5246440<code>vacuum</code></p>\n<p>1B+<code>sqlite_master</code><code>sqlite_temp_master</code>1SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>3236()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/obFGdI.png\"></p>\n<p>:(1)4(0)(2)(3)</p>\n<p>SQLiteSQLite()SQLite</p>\n<p><code>VACUUM</code><code>autovacuum</code></p>\n<p><strong></strong><code>vacuum</code></p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite(SQLite3.7.0SQLiteWALWAL)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()SQLite</p>\n<p>SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/gRdkE3.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>8:0xD9, 0xD5, 0x05, 0xF9, 0x20, 0xAl, 0x63, 0xD7, (4 <code>nRec</code>)<code>nRec</code>-10</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/4IGQSO.png\"></p>\n<p><strong></strong>:SQLite512SQLite</p>\n<p>SQLite(pager<strong></strong>)<code>nRec</code>-1</p>\n<p><strong></strong>:00</p>\n<p><strong></strong>:SQLite<code>nRec</code>-1SQLite<code>pragma</code>case</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>selectSQLite432432SQLite</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hhJK3N.png\"></p>\n<p><strong></strong>:SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLiteetilqs_SQLite<code>nRec</code></p>\n<p><strong></strong>:SAVEPOINTSQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>ATTACH</code>SQLiteSQLiteUTF-8()-mj816</p>\n<p>()UTF-8SQLitewindowsPOSIX()</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/82fzFb.png\"></p>"},{"title":"The Pager Module","date":"2020-08-16T16:00:00.000Z","_content":"\n> SQLitePagerBTreeACID\n\n<!-- more -->\n\n# Pager\nSQLite;SQLitepage cache()\n\npageSQLitePagerPagerTreePagerTree\n\nSQLite()PagerPager(SQLite)Tree\n\nSQLitePagerI/O APIPager(file change counter)\n\nPagerTreePager\n\npagerDBMS:ACID\n\n# Pager\nPagerTreePagerTree\n\n## Pager-client\nPagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager\n\n### Pager\nPager`Pager``Pager``Pager`(Pager)TreePagerPager`Pager`(`Pager`)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png)\n\n`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png)\n\nSQlite(insert,delete,update)savepointaSavepointSQLitesavepoint`iHdrOffset`0savepoint`iHdrOffset``PagerSavepoint`,`iOffset`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png)\n\n### Pager\nPagerTree`sqlite3Pager`SQLite\n\n1. sqlite3PagerOpen:`Pager``Pager`/()\n\n2. sqlite3PagerClose:`Pager`pager\n\n3. sqlite3PagerGet:--(244)()()pager0.()\n\n4. sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite\n\n5. sqlite3PagerLookup:NULL\n\n6. sqlite3PagerRef:+1\n\n7. sqlite3PagerUnref:-10(`Pager`\n\n8. sqlite3PagerBegin:()`sqlite3PagerWrite`Tree\n\n9. sqlite3PagerCommitPhaseOne::+1()\n\n10. sqlite3PagerCommitPhaseTwo:()\n\n11. sqlite3PagerRollback::\n\n12. sqlite3PagerOpenSavepoint:\n\n13. sqlite3PagerSavepoint:\n\n# \nSQLite()SQLite`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png)\n\n## \n(`Pager`)Pager`eState``eLock`Pager7(`Pager.eState`)7\n\n1. **PAGER_OPEN**:`Pager`pager`Pager`\n\n2. **PAGER_READER**:pager()\n\n3. **PAGER_WRITER_LOCKED**:`Pager`pager\n\n4. **PAGER_WRITER_CACHEMOD**:`Pager`pagerTreeTree\n\n5. **PAGER_WRITER_DBMOD**:`Pager`pager\n\n6. **PAGER_WRITER_FINISHED**:`Pager`pager\n\n7. **PAGER_ERROR**:I/O\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png)\n\n`eLock``Pager`4\n\n1. **NO_LOCK**:\n\n2. **SHARED_LOCK**:Pager`Pager`\n\n3. **RESERVED_LOCK**:pagerpagerPager\n\n4. **EXCLUSIVE_LOCK**:pagerpagerpager\n\nNO_LOCKTree`sqlite3PagerGet`pagerSHARED_LOCKTree`sqlite3PagerUnref`pagerNO_LOCK()Tree`sqlite3PagerWrite`pagerRESERVED_LOCK(`sqlite3PagerWrite`pager)pagerEXCLUSIVE_LOCK`sqlite3PagerRollback``sqlite3PagerCommitPhasTwo`pagerNO_LOCK\n\n* `Pager.eLock`EXCLUSICE_LOCK\n\n## \n\n`PCache`pager`PCache`(pager)`PCache`SQLite(pcache1.c)`PCache`pCache,\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png)\n\nSQLitepager`PCache.nMax`attach2000500\n\nSQLite`PgHdr`pagerSQLite`PCache1``PgHdr1`pager`PgHdr1``PCache1.szSize``PgHdr`Tree(:pager)pager0`PCache1.aphash``PCache1.nHash`(bucket)\n\n`PgHdr`pagerTree`pgno``needSync`flush`dirty``nRef``nRef`0`pDirtyNext``pDirtyPrev`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png)\n\n****:SQLite`PCache1`\n\n## \n`PCache1.apHash`(Tree)`sqlite3PagerGet`P\n\n1. \n    * P`apHash`:`apHash`\n    * `apHash`\n    * `pNext`P(`PgHdr.nRef`+1)\n\n2. P(`PCache.nMax`)\n\n3. P()\n\n4. (WAL)\n\n5. (a)PP(`PgHdr.nRef`1)(b)P00(`PgHdr.nRef`1)\n\nSQLite()\n\n(Tree)pagerSQLite:()SQLite3.7.810\n\n## \n`sqlite3PagerWrite`\n\n`sqlite3PagerWrite`pager`PgHdr.needSync`pager(SQLiteSQL:`needSync`)`sqlite3PagerWrite``PgHdr.dirty`pagerpagerpager\n\n\n\n## \nSQLite\n\n## \n:\n\n1. \n\n2. \n\n3. \n\n()265\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png)\n\n### \n\n\nPSQLite(LRU)\n\n### LRU\nLRU()\n\n### SQLite\nSQLitepager()LRUSQLiteSQLite\n\n# \nSQLitePagerACIDSQLitepager\n\nDBMSSQLite:1. 2.pager\n\n## \npager\n\n### \n(Tree)`sqlite3PagerGet`:pagerSQLITE_BUSY\n\n0Tree\n\npager()pager`sqlite3PagerGet`\n\npager\n\n### \n(Tree)(`sqlite3PagerGet`)`sqlite3PagerWrite`pagerpager`sqlite3PagerWrite`pagerpagerpagerSQLITE_BUSY\n\npager()pager('-journal')()\n\npagerlog\n\n****:SQLitelog\n\n**log**:`sqlite3PagerWrite`\n\n### \npager(Tree)pager():1.2.pagerpagerSQLiteWALpager:\n\n1. ()pagerflush`fsync`pager(`nRec`)(`nRec`0-1)pager`nRec``fsync``nRec`pagerSQLite\n\n2. (pagerSQLITE_BUSY)\n\n3. ()()\n\npager\n\n****:\n\n### \nSQLite\n\n****:Tree`sqlite3PagerCommitPhaseOne``sqlite3PagerCommitPhaseTwo`pagerNO_LOCK(\"\")pager:\n\n1. (`sqlite3PagerCommitPhaseOne`SQLITE_BUSY)metadata+1(****1-3)\n\n2. Linuxpager`fsync`\n\n3. \n\n4. SHARED_LOCKNO_LOCK\n\n\n\n****:VM`VdbeCommit`pager():\n\n1. ()\n\n2.  \n\n3. ('-mj',8)flush()\n\n4. flush(pager)\n\n5. flush\n\n6. flush\n\n7. \n\n8. pagerSHARED_LOCKNO_LOCKpager\n\n\n\n****:journal_mode\n\n****:SQLiteVM\n\n****:COMMITSQLiteSQLITE_BUSYSQLite\n\n### \n\n\n****:\n\n****::(`etilqs_`pager`sqlite3PagerWrite`\n\n1. pager(log)\n\n2. pager(logpager)\n\npagerflush\n\n****:pager()\n\n### \nSQLiteSQLite:\n\n### \n`release sp`SQLite`PagerSavepoint``sp`\n\n## \nSQLite()(),4\n\n### \nSQLitepagerpagerpager\n\npagerpagerpagerflush\n\n### \nSQLite\n\n### \n`roll to sp`SQLite`sp``PagerSavepoint``iOffset``iHdrOffset``iSubRec`iOffset`iSubRec``iHdrOffset`:(1)`iOffset``iHdrOffset`(2)pager`Pager.dbSize`(PagerSavepoint.nOrig)SQLite`sp``PagerSavepoint``sp`\n\n### \nSQLite\n\n****::(1)(0)(2)\n\n****:SQLite\n\npager\n\n1. (SQLITE_BUSY)\n\n2. \n\n3. (pagerpager) pagerSQLITE_BUSY\n\n4. ()\n\n5. flush\n\n6. ()\n\n7. \n\n8. (pager`sqlite3PagerGet`)\n\n\n\n****:pagerpager\n\n## \n### \nSQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)\n\n### \nDBMSDBMSSQLite:SQLite\n\n:pagerSQLITE_FULLSQLite","source":"_posts/2020-08-17_db-system-design-imp(Pager).md","raw":"---\ntitle: The Pager Module\ndate: 2020-08-17\ntags: [sqlite3]\ncategories: sqlite3\n---\n\n> SQLitePagerBTreeACID\n\n<!-- more -->\n\n# Pager\nSQLite;SQLitepage cache()\n\npageSQLitePagerPagerTreePagerTree\n\nSQLite()PagerPager(SQLite)Tree\n\nSQLitePagerI/O APIPager(file change counter)\n\nPagerTreePager\n\npagerDBMS:ACID\n\n# Pager\nPagerTreePagerTree\n\n## Pager-client\nPagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager\n\n### Pager\nPager`Pager``Pager``Pager`(Pager)TreePagerPager`Pager`(`Pager`)\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png)\n\n`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png)\n\nSQlite(insert,delete,update)savepointaSavepointSQLitesavepoint`iHdrOffset`0savepoint`iHdrOffset``PagerSavepoint`,`iOffset`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png)\n\n### Pager\nPagerTree`sqlite3Pager`SQLite\n\n1. sqlite3PagerOpen:`Pager``Pager`/()\n\n2. sqlite3PagerClose:`Pager`pager\n\n3. sqlite3PagerGet:--(244)()()pager0.()\n\n4. sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite\n\n5. sqlite3PagerLookup:NULL\n\n6. sqlite3PagerRef:+1\n\n7. sqlite3PagerUnref:-10(`Pager`\n\n8. sqlite3PagerBegin:()`sqlite3PagerWrite`Tree\n\n9. sqlite3PagerCommitPhaseOne::+1()\n\n10. sqlite3PagerCommitPhaseTwo:()\n\n11. sqlite3PagerRollback::\n\n12. sqlite3PagerOpenSavepoint:\n\n13. sqlite3PagerSavepoint:\n\n# \nSQLite()SQLite`Pager`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png)\n\n## \n(`Pager`)Pager`eState``eLock`Pager7(`Pager.eState`)7\n\n1. **PAGER_OPEN**:`Pager`pager`Pager`\n\n2. **PAGER_READER**:pager()\n\n3. **PAGER_WRITER_LOCKED**:`Pager`pager\n\n4. **PAGER_WRITER_CACHEMOD**:`Pager`pagerTreeTree\n\n5. **PAGER_WRITER_DBMOD**:`Pager`pager\n\n6. **PAGER_WRITER_FINISHED**:`Pager`pager\n\n7. **PAGER_ERROR**:I/O\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png)\n\n`eLock``Pager`4\n\n1. **NO_LOCK**:\n\n2. **SHARED_LOCK**:Pager`Pager`\n\n3. **RESERVED_LOCK**:pagerpagerPager\n\n4. **EXCLUSIVE_LOCK**:pagerpagerpager\n\nNO_LOCKTree`sqlite3PagerGet`pagerSHARED_LOCKTree`sqlite3PagerUnref`pagerNO_LOCK()Tree`sqlite3PagerWrite`pagerRESERVED_LOCK(`sqlite3PagerWrite`pager)pagerEXCLUSIVE_LOCK`sqlite3PagerRollback``sqlite3PagerCommitPhasTwo`pagerNO_LOCK\n\n* `Pager.eLock`EXCLUSICE_LOCK\n\n## \n\n`PCache`pager`PCache`(pager)`PCache`SQLite(pcache1.c)`PCache`pCache,\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png)\n\nSQLitepager`PCache.nMax`attach2000500\n\nSQLite`PgHdr`pagerSQLite`PCache1``PgHdr1`pager`PgHdr1``PCache1.szSize``PgHdr`Tree(:pager)pager0`PCache1.aphash``PCache1.nHash`(bucket)\n\n`PgHdr`pagerTree`pgno``needSync`flush`dirty``nRef``nRef`0`pDirtyNext``pDirtyPrev`\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png)\n\n****:SQLite`PCache1`\n\n## \n`PCache1.apHash`(Tree)`sqlite3PagerGet`P\n\n1. \n    * P`apHash`:`apHash`\n    * `apHash`\n    * `pNext`P(`PgHdr.nRef`+1)\n\n2. P(`PCache.nMax`)\n\n3. P()\n\n4. (WAL)\n\n5. (a)PP(`PgHdr.nRef`1)(b)P00(`PgHdr.nRef`1)\n\nSQLite()\n\n(Tree)pagerSQLite:()SQLite3.7.810\n\n## \n`sqlite3PagerWrite`\n\n`sqlite3PagerWrite`pager`PgHdr.needSync`pager(SQLiteSQL:`needSync`)`sqlite3PagerWrite``PgHdr.dirty`pagerpagerpager\n\n\n\n## \nSQLite\n\n## \n:\n\n1. \n\n2. \n\n3. \n\n()265\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png)\n\n### \n\n\nPSQLite(LRU)\n\n### LRU\nLRU()\n\n### SQLite\nSQLitepager()LRUSQLiteSQLite\n\n# \nSQLitePagerACIDSQLitepager\n\nDBMSSQLite:1. 2.pager\n\n## \npager\n\n### \n(Tree)`sqlite3PagerGet`:pagerSQLITE_BUSY\n\n0Tree\n\npager()pager`sqlite3PagerGet`\n\npager\n\n### \n(Tree)(`sqlite3PagerGet`)`sqlite3PagerWrite`pagerpager`sqlite3PagerWrite`pagerpagerpagerSQLITE_BUSY\n\npager()pager('-journal')()\n\npagerlog\n\n****:SQLitelog\n\n**log**:`sqlite3PagerWrite`\n\n### \npager(Tree)pager():1.2.pagerpagerSQLiteWALpager:\n\n1. ()pagerflush`fsync`pager(`nRec`)(`nRec`0-1)pager`nRec``fsync``nRec`pagerSQLite\n\n2. (pagerSQLITE_BUSY)\n\n3. ()()\n\npager\n\n****:\n\n### \nSQLite\n\n****:Tree`sqlite3PagerCommitPhaseOne``sqlite3PagerCommitPhaseTwo`pagerNO_LOCK(\"\")pager:\n\n1. (`sqlite3PagerCommitPhaseOne`SQLITE_BUSY)metadata+1(****1-3)\n\n2. Linuxpager`fsync`\n\n3. \n\n4. SHARED_LOCKNO_LOCK\n\n\n\n****:VM`VdbeCommit`pager():\n\n1. ()\n\n2.  \n\n3. ('-mj',8)flush()\n\n4. flush(pager)\n\n5. flush\n\n6. flush\n\n7. \n\n8. pagerSHARED_LOCKNO_LOCKpager\n\n\n\n****:journal_mode\n\n****:SQLiteVM\n\n****:COMMITSQLiteSQLITE_BUSYSQLite\n\n### \n\n\n****:\n\n****::(`etilqs_`pager`sqlite3PagerWrite`\n\n1. pager(log)\n\n2. pager(logpager)\n\npagerflush\n\n****:pager()\n\n### \nSQLiteSQLite:\n\n### \n`release sp`SQLite`PagerSavepoint``sp`\n\n## \nSQLite()(),4\n\n### \nSQLitepagerpagerpager\n\npagerpagerpagerflush\n\n### \nSQLite\n\n### \n`roll to sp`SQLite`sp``PagerSavepoint``iOffset``iHdrOffset``iSubRec`iOffset`iSubRec``iHdrOffset`:(1)`iOffset``iHdrOffset`(2)pager`Pager.dbSize`(PagerSavepoint.nOrig)SQLite`sp``PagerSavepoint``sp`\n\n### \nSQLite\n\n****::(1)(0)(2)\n\n****:SQLite\n\npager\n\n1. (SQLITE_BUSY)\n\n2. \n\n3. (pagerpager) pagerSQLITE_BUSY\n\n4. ()\n\n5. flush\n\n6. ()\n\n7. \n\n8. (pager`sqlite3PagerGet`)\n\n\n\n****:pagerpager\n\n## \n### \nSQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)\n\n### \nDBMSDBMSSQLite:SQLite\n\n:pagerSQLITE_FULLSQLite","slug":"2020-08-17_db-system-design-imp(Pager)","published":1,"updated":"2020-08-31T07:21:34.085Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2l9001293c98xug1hap","content":"<blockquote>\n<p>SQLitePagerBTreeACID</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>SQLite;SQLitepage cache()</p>\n<p>pageSQLitePagerPagerTreePagerTree</p>\n<p>SQLite()PagerPager(SQLite)Tree</p>\n<p>SQLitePagerI&#x2F;O APIPager(file change counter)</p>\n<p>PagerTreePager</p>\n<p>pagerDBMS:ACID</p>\n<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>PagerTreePagerTree</p>\n<h2 id=\"Pager-client\"><a href=\"#Pager-client\" class=\"headerlink\" title=\"Pager-client\"></a>Pager-client</h2><p>PagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager</p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>Pager<code>Pager</code><code>Pager</code><code>Pager</code>(Pager)TreePagerPager<code>Pager</code>(<code>Pager</code>)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png\"></p>\n<p><code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png\"></p>\n<p>SQlite(insert,delete,update)savepointaSavepointSQLitesavepoint<code>iHdrOffset</code>0savepoint<code>iHdrOffset</code><code>PagerSavepoint</code>,<code>iOffset</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png\"></p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>PagerTree<code>sqlite3Pager</code>SQLite</p>\n<ol>\n<li><p>sqlite3PagerOpen:<code>Pager</code><code>Pager</code>&#x2F;()</p>\n</li>\n<li><p>sqlite3PagerClose:<code>Pager</code>pager</p>\n</li>\n<li><p>sqlite3PagerGet:(244)()()pager0.()</p>\n</li>\n<li><p>sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite</p>\n</li>\n<li><p>sqlite3PagerLookup:NULL</p>\n</li>\n<li><p>sqlite3PagerRef:+1</p>\n</li>\n<li><p>sqlite3PagerUnref:-10(<code>Pager</code></p>\n</li>\n<li><p>sqlite3PagerBegin:()<code>sqlite3PagerWrite</code>Tree</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseOne::+1()</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseTwo:()</p>\n</li>\n<li><p>sqlite3PagerRollback::</p>\n</li>\n<li><p>sqlite3PagerOpenSavepoint:</p>\n</li>\n<li><p>sqlite3PagerSavepoint:</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()SQLite<code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>(<code>Pager</code>)Pager<code>eState</code><code>eLock</code>Pager7(<code>Pager.eState</code>)7</p>\n<ol>\n<li><p><strong>PAGER_OPEN</strong>:<code>Pager</code>pager<code>Pager</code></p>\n</li>\n<li><p><strong>PAGER_READER</strong>:pager()</p>\n</li>\n<li><p><strong>PAGER_WRITER_LOCKED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_CACHEMOD</strong>:<code>Pager</code>pagerTreeTree</p>\n</li>\n<li><p><strong>PAGER_WRITER_DBMOD</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_FINISHED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_ERROR</strong>:I&#x2F;O</p>\n</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png\"></p>\n<p><code>eLock</code><code>Pager</code>4</p>\n<ol>\n<li><p><strong>NO_LOCK</strong>:</p>\n</li>\n<li><p><strong>SHARED_LOCK</strong>:Pager<code>Pager</code></p>\n</li>\n<li><p><strong>RESERVED_LOCK</strong>:pagerpagerPager</p>\n</li>\n<li><p><strong>EXCLUSIVE_LOCK</strong>:pagerpagerpager</p>\n</li>\n</ol>\n<p>NO_LOCKTree<code>sqlite3PagerGet</code>pagerSHARED_LOCKTree<code>sqlite3PagerUnref</code>pagerNO_LOCK()Tree<code>sqlite3PagerWrite</code>pagerRESERVED_LOCK(<code>sqlite3PagerWrite</code>pager)pagerEXCLUSIVE_LOCK<code>sqlite3PagerRollback</code><code>sqlite3PagerCommitPhasTwo</code>pagerNO_LOCK</p>\n<ul>\n<li><code>Pager.eLock</code>EXCLUSICE_LOCK</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache</code>pager<code>PCache</code>(pager)<code>PCache</code>SQLite(pcache1.c)<code>PCache</code>pCache,</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png\"></p>\n<p>SQLitepager<code>PCache.nMax</code>attach2000500</p>\n<p>SQLite<code>PgHdr</code>pagerSQLite<code>PCache1</code><code>PgHdr1</code>pager<code>PgHdr1</code><code>PCache1.szSize</code><code>PgHdr</code>Tree(:pager)pager0<code>PCache1.aphash</code><code>PCache1.nHash</code>(bucket)</p>\n<p><code>PgHdr</code>pagerTree<code>pgno</code><code>needSync</code>flush<code>dirty</code><code>nRef</code><code>nRef</code>0<code>pDirtyNext</code><code>pDirtyPrev</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png\"></p>\n<p><strong></strong>:SQLite<code>PCache1</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache1.apHash</code>(Tree)<code>sqlite3PagerGet</code>P</p>\n<ol>\n<li><p></p>\n<ul>\n<li>P<code>apHash</code>:<code>apHash</code></li>\n<li><code>apHash</code></li>\n<li><code>pNext</code>P(<code>PgHdr.nRef</code>+1)</li>\n</ul>\n</li>\n<li><p>P(<code>PCache.nMax</code>)</p>\n</li>\n<li><p>P()</p>\n</li>\n<li><p>(WAL)</p>\n</li>\n<li><p>(a)PP(<code>PgHdr.nRef</code>1)(b)P00(<code>PgHdr.nRef</code>1)</p>\n</li>\n</ol>\n<p>SQLite()</p>\n<p>(Tree)pagerSQLite:()SQLite3.7.810</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3PagerWrite</code></p>\n<p><code>sqlite3PagerWrite</code>pager<code>PgHdr.needSync</code>pager(SQLiteSQL:<code>needSync</code>)<code>sqlite3PagerWrite</code><code>PgHdr.dirty</code>pagerpagerpager</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:</p>\n<ol>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<p>()265</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>PSQLite(LRU)</p>\n<h3 id=\"LRU\"><a href=\"#LRU\" class=\"headerlink\" title=\"LRU\"></a>LRU</h3><p>LRU()</p>\n<h3 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h3><p>SQLitepager()LRUSQLiteSQLite</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLitePagerACIDSQLitepager</p>\n<p>DBMSSQLite:1. 2.pager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)<code>sqlite3PagerGet</code>:pagerSQLITE_BUSY</p>\n<p>0Tree</p>\n<p>pager()pager<code>sqlite3PagerGet</code></p>\n<p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)(<code>sqlite3PagerGet</code>)<code>sqlite3PagerWrite</code>pagerpager<code>sqlite3PagerWrite</code>pagerpagerpagerSQLITE_BUSY</p>\n<p>pager()pager(-journal)()</p>\n<p>pagerlog</p>\n<p><strong></strong>:SQLitelog</p>\n<p><strong>log</strong>:<code>sqlite3PagerWrite</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>pager(Tree)pager():1.2.pagerpagerSQLiteWALpager:</p>\n<ol>\n<li><p>()pagerflush<code>fsync</code>pager(<code>nRec</code>)(<code>nRec</code>0-1)pager<code>nRec</code><code>fsync</code><code>nRec</code>pagerSQLite</p>\n</li>\n<li><p>(pagerSQLITE_BUSY)</p>\n</li>\n<li><p>()()</p>\n</li>\n</ol>\n<p>pager</p>\n<p><strong></strong>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>:Tree<code>sqlite3PagerCommitPhaseOne</code><code>sqlite3PagerCommitPhaseTwo</code>pagerNO_LOCK()pager:</p>\n<ol>\n<li><p>(<code>sqlite3PagerCommitPhaseOne</code>SQLITE_BUSY)metadata+1(<strong></strong>1-3)</p>\n</li>\n<li><p>Linuxpager<code>fsync</code></p>\n</li>\n<li><p></p>\n</li>\n<li><p>SHARED_LOCKNO_LOCK</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:VM<code>VdbeCommit</code>pager():</p>\n<ol>\n<li><p>()</p>\n</li>\n<li><p> </p>\n</li>\n<li><p>(-mj,8)flush()</p>\n</li>\n<li><p>flush(pager)</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p></p>\n</li>\n<li><p>pagerSHARED_LOCKNO_LOCKpager</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:journal_mode</p>\n<p><strong></strong>:SQLiteVM</p>\n<p><strong></strong>:COMMITSQLiteSQLITE_BUSYSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><strong></strong>:</p>\n<p><strong></strong>::(<code>etilqs_</code>pager<code>sqlite3PagerWrite</code></p>\n<ol>\n<li><p>pager(log)</p>\n</li>\n<li><p>pager(logpager)</p>\n</li>\n</ol>\n<p>pagerflush</p>\n<p><strong></strong>:pager()</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLite:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>release sp</code>SQLite<code>PagerSavepoint</code><code>sp</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()(),4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLitepagerpagerpager</p>\n<p>pagerpagerpagerflush</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>roll to sp</code>SQLite<code>sp</code><code>PagerSavepoint</code><code>iOffset</code><code>iHdrOffset</code><code>iSubRec</code>iOffset<code>iSubRec</code><code>iHdrOffset</code>:(1)<code>iOffset</code><code>iHdrOffset</code>(2)pager<code>Pager.dbSize</code>(PagerSavepoint.nOrig)SQLite<code>sp</code><code>PagerSavepoint</code><code>sp</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>::(1)(0)(2)</p>\n<p><strong></strong>:SQLite</p>\n<p>pager</p>\n<ol>\n<li><p>(SQLITE_BUSY)</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pagerpager) pagerSQLITE_BUSY</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pager<code>sqlite3PagerGet</code>)</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:pagerpager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DBMSDBMSSQLite:SQLite</p>\n<p>:pagerSQLITE_FULLSQLite</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>SQLitePagerBTreeACID</p>\n</blockquote>","more":"<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>SQLite;SQLitepage cache()</p>\n<p>pageSQLitePagerPagerTreePagerTree</p>\n<p>SQLite()PagerPager(SQLite)Tree</p>\n<p>SQLitePagerI&#x2F;O APIPager(file change counter)</p>\n<p>PagerTreePager</p>\n<p>pagerDBMS:ACID</p>\n<h1 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h1><p>PagerTreePagerTree</p>\n<h2 id=\"Pager-client\"><a href=\"#Pager-client\" class=\"headerlink\" title=\"Pager-client\"></a>Pager-client</h2><p>PagerTreeACIDPagerTreePagerPagerTreePagerPagerPagerPager</p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>Pager<code>Pager</code><code>Pager</code><code>Pager</code>(Pager)TreePagerPager<code>Pager</code>(<code>Pager</code>)</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/lLkn3u.png\"></p>\n<p><code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/hWBtgL.png\"></p>\n<p>SQlite(insert,delete,update)savepointaSavepointSQLitesavepoint<code>iHdrOffset</code>0savepoint<code>iHdrOffset</code><code>PagerSavepoint</code>,<code>iOffset</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/1ijSOI.png\"></p>\n<h3 id=\"Pager\"><a href=\"#Pager\" class=\"headerlink\" title=\"Pager\"></a>Pager</h3><p>PagerTree<code>sqlite3Pager</code>SQLite</p>\n<ol>\n<li><p>sqlite3PagerOpen:<code>Pager</code><code>Pager</code>&#x2F;()</p>\n</li>\n<li><p>sqlite3PagerClose:<code>Pager</code>pager</p>\n</li>\n<li><p>sqlite3PagerGet:(244)()()pager0.()</p>\n</li>\n<li><p>sqlite3PagerWrite:()TreePager(SQLiteTreePagerTreePager)PagerSQLite</p>\n</li>\n<li><p>sqlite3PagerLookup:NULL</p>\n</li>\n<li><p>sqlite3PagerRef:+1</p>\n</li>\n<li><p>sqlite3PagerUnref:-10(<code>Pager</code></p>\n</li>\n<li><p>sqlite3PagerBegin:()<code>sqlite3PagerWrite</code>Tree</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseOne::+1()</p>\n</li>\n<li><p>sqlite3PagerCommitPhaseTwo:()</p>\n</li>\n<li><p>sqlite3PagerRollback::</p>\n</li>\n<li><p>sqlite3PagerOpenSavepoint:</p>\n</li>\n<li><p>sqlite3PagerSavepoint:</p>\n</li>\n</ol>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLite()SQLite<code>Pager</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/It7kz3.png\"></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>(<code>Pager</code>)Pager<code>eState</code><code>eLock</code>Pager7(<code>Pager.eState</code>)7</p>\n<ol>\n<li><p><strong>PAGER_OPEN</strong>:<code>Pager</code>pager<code>Pager</code></p>\n</li>\n<li><p><strong>PAGER_READER</strong>:pager()</p>\n</li>\n<li><p><strong>PAGER_WRITER_LOCKED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_CACHEMOD</strong>:<code>Pager</code>pagerTreeTree</p>\n</li>\n<li><p><strong>PAGER_WRITER_DBMOD</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_WRITER_FINISHED</strong>:<code>Pager</code>pager</p>\n</li>\n<li><p><strong>PAGER_ERROR</strong>:I&#x2F;O</p>\n</li>\n</ol>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/yUn3tG.png\"></p>\n<p><code>eLock</code><code>Pager</code>4</p>\n<ol>\n<li><p><strong>NO_LOCK</strong>:</p>\n</li>\n<li><p><strong>SHARED_LOCK</strong>:Pager<code>Pager</code></p>\n</li>\n<li><p><strong>RESERVED_LOCK</strong>:pagerpagerPager</p>\n</li>\n<li><p><strong>EXCLUSIVE_LOCK</strong>:pagerpagerpager</p>\n</li>\n</ol>\n<p>NO_LOCKTree<code>sqlite3PagerGet</code>pagerSHARED_LOCKTree<code>sqlite3PagerUnref</code>pagerNO_LOCK()Tree<code>sqlite3PagerWrite</code>pagerRESERVED_LOCK(<code>sqlite3PagerWrite</code>pager)pagerEXCLUSIVE_LOCK<code>sqlite3PagerRollback</code><code>sqlite3PagerCommitPhasTwo</code>pagerNO_LOCK</p>\n<ul>\n<li><code>Pager.eLock</code>EXCLUSICE_LOCK</li>\n</ul>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache</code>pager<code>PCache</code>(pager)<code>PCache</code>SQLite(pcache1.c)<code>PCache</code>pCache,</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/EWLiFD.png\"></p>\n<p>SQLitepager<code>PCache.nMax</code>attach2000500</p>\n<p>SQLite<code>PgHdr</code>pagerSQLite<code>PCache1</code><code>PgHdr1</code>pager<code>PgHdr1</code><code>PCache1.szSize</code><code>PgHdr</code>Tree(:pager)pager0<code>PCache1.aphash</code><code>PCache1.nHash</code>(bucket)</p>\n<p><code>PgHdr</code>pagerTree<code>pgno</code><code>needSync</code>flush<code>dirty</code><code>nRef</code><code>nRef</code>0<code>pDirtyNext</code><code>pDirtyPrev</code></p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/zIdkXn.png\"></p>\n<p><strong></strong>:SQLite<code>PCache1</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>PCache1.apHash</code>(Tree)<code>sqlite3PagerGet</code>P</p>\n<ol>\n<li><p></p>\n<ul>\n<li>P<code>apHash</code>:<code>apHash</code></li>\n<li><code>apHash</code></li>\n<li><code>pNext</code>P(<code>PgHdr.nRef</code>+1)</li>\n</ul>\n</li>\n<li><p>P(<code>PCache.nMax</code>)</p>\n</li>\n<li><p>P()</p>\n</li>\n<li><p>(WAL)</p>\n</li>\n<li><p>(a)PP(<code>PgHdr.nRef</code>1)(b)P00(<code>PgHdr.nRef</code>1)</p>\n</li>\n</ol>\n<p>SQLite()</p>\n<p>(Tree)pagerSQLite:()SQLite3.7.810</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><code>sqlite3PagerWrite</code></p>\n<p><code>sqlite3PagerWrite</code>pager<code>PgHdr.needSync</code>pager(SQLiteSQL:<code>needSync</code>)<code>sqlite3PagerWrite</code><code>PgHdr.dirty</code>pagerpagerpager</p>\n<p></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>:</p>\n<ol>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n<li><p></p>\n</li>\n</ol>\n<p>()265</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2020/08/UK0ZuX.png\"></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p>PSQLite(LRU)</p>\n<h3 id=\"LRU\"><a href=\"#LRU\" class=\"headerlink\" title=\"LRU\"></a>LRU</h3><p>LRU()</p>\n<h3 id=\"SQLite\"><a href=\"#SQLite\" class=\"headerlink\" title=\"SQLite\"></a>SQLite</h3><p>SQLitepager()LRUSQLiteSQLite</p>\n<h1 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h1><p>SQLitePagerACIDSQLitepager</p>\n<p>DBMSSQLite:1. 2.pager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)<code>sqlite3PagerGet</code>:pagerSQLITE_BUSY</p>\n<p>0Tree</p>\n<p>pager()pager<code>sqlite3PagerGet</code></p>\n<p>pager</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>(Tree)(<code>sqlite3PagerGet</code>)<code>sqlite3PagerWrite</code>pagerpager<code>sqlite3PagerWrite</code>pagerpagerpagerSQLITE_BUSY</p>\n<p>pager()pager(-journal)()</p>\n<p>pagerlog</p>\n<p><strong></strong>:SQLitelog</p>\n<p><strong>log</strong>:<code>sqlite3PagerWrite</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>pager(Tree)pager():1.2.pagerpagerSQLiteWALpager:</p>\n<ol>\n<li><p>()pagerflush<code>fsync</code>pager(<code>nRec</code>)(<code>nRec</code>0-1)pager<code>nRec</code><code>fsync</code><code>nRec</code>pagerSQLite</p>\n</li>\n<li><p>(pagerSQLITE_BUSY)</p>\n</li>\n<li><p>()()</p>\n</li>\n</ol>\n<p>pager</p>\n<p><strong></strong>:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>:Tree<code>sqlite3PagerCommitPhaseOne</code><code>sqlite3PagerCommitPhaseTwo</code>pagerNO_LOCK()pager:</p>\n<ol>\n<li><p>(<code>sqlite3PagerCommitPhaseOne</code>SQLITE_BUSY)metadata+1(<strong></strong>1-3)</p>\n</li>\n<li><p>Linuxpager<code>fsync</code></p>\n</li>\n<li><p></p>\n</li>\n<li><p>SHARED_LOCKNO_LOCK</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:VM<code>VdbeCommit</code>pager():</p>\n<ol>\n<li><p>()</p>\n</li>\n<li><p> </p>\n</li>\n<li><p>(-mj,8)flush()</p>\n</li>\n<li><p>flush(pager)</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p></p>\n</li>\n<li><p>pagerSHARED_LOCKNO_LOCKpager</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:journal_mode</p>\n<p><strong></strong>:SQLiteVM</p>\n<p><strong></strong>:COMMITSQLiteSQLITE_BUSYSQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p><strong></strong>:</p>\n<p><strong></strong>::(<code>etilqs_</code>pager<code>sqlite3PagerWrite</code></p>\n<ol>\n<li><p>pager(log)</p>\n</li>\n<li><p>pager(logpager)</p>\n</li>\n</ol>\n<p>pagerflush</p>\n<p><strong></strong>:pager()</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLite:</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>release sp</code>SQLite<code>PagerSavepoint</code><code>sp</code></p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p>SQLite()(),4</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLitepagerpagerpager</p>\n<p>pagerpagerpagerflush</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><code>roll to sp</code>SQLite<code>sp</code><code>PagerSavepoint</code><code>iOffset</code><code>iHdrOffset</code><code>iSubRec</code>iOffset<code>iSubRec</code><code>iHdrOffset</code>:(1)<code>iOffset</code><code>iHdrOffset</code>(2)pager<code>Pager.dbSize</code>(PagerSavepoint.nOrig)SQLite<code>sp</code><code>PagerSavepoint</code><code>sp</code></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLite</p>\n<p><strong></strong>::(1)(0)(2)</p>\n<p><strong></strong>:SQLite</p>\n<p>pager</p>\n<ol>\n<li><p>(SQLITE_BUSY)</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pagerpager) pagerSQLITE_BUSY</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p>flush</p>\n</li>\n<li><p>()</p>\n</li>\n<li><p></p>\n</li>\n<li><p>(pager<code>sqlite3PagerGet</code>)</p>\n</li>\n</ol>\n<p></p>\n<p><strong></strong>:pagerpager</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>SQLiteSQLiteSQLite(SQLite3.7.0SQLiteWAL)</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>DBMSDBMSSQLite:SQLite</p>\n<p>:pagerSQLITE_FULLSQLite</p>"},{"title":"WAL Mode","date":"2020-08-28T16:00:00.000Z","_content":"\nrelease 3.7.0SQLiteWAL`pragma journal_mode=WAL`WAL(Pager182)SQLiteWALwal'-wal'\n\n<!-- more -->\n\n()walwal\n\nwal32wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 | :0x377f0682()  0x377f0683() |\n| 4 | 4 |  |\n| 8 | 4 |  |\n| 12 | 4 |  |\n| 16 | 4 | -1:  |\n| 20 | 4 | -2:  |\n| 24 | 4 | -1: 24 |\n| 28 | 4 | -2: 24 |\n\nwal24wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 |  |\n| 4 | 4 | <br/>0 |\n| 8 | 4 | -1 WAL |\n| 12 | 4 | -2 WAL |\n| 16 | 4 | -1:8 |\n| 20 | 4 | -2:8 |\n\nwalpagerWAL()pagerpWALppagerpwalpagerpSQLite`wal-index`p\n\n`wal-index`'-shm'(wal)SQLite`wal-index``wal-index`wal`wal-index`\n\nwalwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:\n\n* flushwal\n* \n* flush(wal)\n* wal-1-2(wal)\n* `wal-index`\n\nwal;wal\n\nflush(journalflushflush`nRec`)WALflushflush(`PRAGMA synchronous=FULL`flush`PRAGMA synchronous=NORMAL`flush)\n\n`sqlite3_wal_hook()`WALhook`sqlite3_wal_checkpoint()`  `sqlite3_wal_checkpoint_v2()` `sqlite3_wal_hook()`checkpointPASSIVEFULLRESTART`sqlite3_wal_checkpoint()`PASSIVEFULLRESTART`sqlite3_wal_checkpoint_v2()`\n\n**:**48x(0)-x(N),x4N:\n\n```c\ns0 = s1 = 0\nfor i from 0 to n-1 step 2:\n   s0 += x(i) + s1;\n   s1 += x(i+1) + s0;\nend for\n//result in s0 and s1\n```\n\ns0s1()s132s0\n\n\n\n:\n1. flush\n2. \n3. \n\n:\n1. \n2. \n3. NFS\n4. \n5. \n6. (-wal,-shm)\n7. ","source":"_posts/2020-08-29_db_system_design_imp(WAL).md","raw":"---\ntitle: WAL Mode\ndate: 2020-08-29\ntags: [sqlite3]\ncategories: sqlite3\n---\n\nrelease 3.7.0SQLiteWAL`pragma journal_mode=WAL`WAL(Pager182)SQLiteWALwal'-wal'\n\n<!-- more -->\n\n()walwal\n\nwal32wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 | :0x377f0682()  0x377f0683() |\n| 4 | 4 |  |\n| 8 | 4 |  |\n| 12 | 4 |  |\n| 16 | 4 | -1:  |\n| 20 | 4 | -2:  |\n| 24 | 4 | -1: 24 |\n| 28 | 4 | -2: 24 |\n\nwal24wal4\n\n|  |  |  |\n| ---- | ---- | ---- |\n| 0 | 4 |  |\n| 4 | 4 | <br/>0 |\n| 8 | 4 | -1 WAL |\n| 12 | 4 | -2 WAL |\n| 16 | 4 | -1:8 |\n| 20 | 4 | -2:8 |\n\nwalpagerWAL()pagerpWALppagerpwalpagerpSQLite`wal-index`p\n\n`wal-index`'-shm'(wal)SQLite`wal-index``wal-index`wal`wal-index`\n\nwalwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:\n\n* flushwal\n* \n* flush(wal)\n* wal-1-2(wal)\n* `wal-index`\n\nwal;wal\n\nflush(journalflushflush`nRec`)WALflushflush(`PRAGMA synchronous=FULL`flush`PRAGMA synchronous=NORMAL`flush)\n\n`sqlite3_wal_hook()`WALhook`sqlite3_wal_checkpoint()`  `sqlite3_wal_checkpoint_v2()` `sqlite3_wal_hook()`checkpointPASSIVEFULLRESTART`sqlite3_wal_checkpoint()`PASSIVEFULLRESTART`sqlite3_wal_checkpoint_v2()`\n\n**:**48x(0)-x(N),x4N:\n\n```c\ns0 = s1 = 0\nfor i from 0 to n-1 step 2:\n   s0 += x(i) + s1;\n   s1 += x(i+1) + s0;\nend for\n//result in s0 and s1\n```\n\ns0s1()s132s0\n\n\n\n:\n1. flush\n2. \n3. \n\n:\n1. \n2. \n3. NFS\n4. \n5. \n6. (-wal,-shm)\n7. ","slug":"2020-08-29_db_system_design_imp(WAL)","published":1,"updated":"2022-05-21T12:03:48.558Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2la001493c984lf57h1","content":"<p>release 3.7.0SQLiteWAL<code>pragma journal_mode=WAL</code>WAL(Pager182)SQLiteWALwal-wal</p>\n<span id=\"more\"></span>\n\n<p>()walwal</p>\n<p>wal32wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td>:0x377f0682()  0x377f0683()</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1: </td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2: </td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td>-1: 24</td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td>-2: 24</td>\n</tr>\n</tbody></table>\n<p>wal24wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td><br/>0</td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td>-1 WAL</td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td>-2 WAL</td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1:8</td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2:8</td>\n</tr>\n</tbody></table>\n<p>walpagerWAL()pagerpWALppagerpwalpagerpSQLite<code>wal-index</code>p</p>\n<p><code>wal-index</code>-shm(wal)SQLite<code>wal-index</code><code>wal-index</code>wal<code>wal-index</code></p>\n<p>walwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:</p>\n<ul>\n<li>flushwal</li>\n<li></li>\n<li>flush(wal)</li>\n<li>wal-1-2(wal)</li>\n<li><code>wal-index</code></li>\n</ul>\n<p>wal;wal</p>\n<p>flush(journalflushflush<code>nRec</code>)WALflushflush(<code>PRAGMA synchronous=FULL</code>flush<code>PRAGMA synchronous=NORMAL</code>flush)</p>\n<p><code>sqlite3_wal_hook()</code>WALhook<code>sqlite3_wal_checkpoint()</code>  <code>sqlite3_wal_checkpoint_v2()</code> <code>sqlite3_wal_hook()</code>checkpointPASSIVEFULLRESTART<code>sqlite3_wal_checkpoint()</code>PASSIVEFULLRESTART<code>sqlite3_wal_checkpoint_v2()</code></p>\n<p>**:**48x(0)-x(N),x4N:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s0 = s1 = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i from <span class=\"number\">0</span> to n<span class=\"number\">-1</span> step <span class=\"number\">2</span>:</span><br><span class=\"line\">   s0 += x(i) + s1;</span><br><span class=\"line\">   s1 += x(i+<span class=\"number\">1</span>) + s0;</span><br><span class=\"line\">end <span class=\"keyword\">for</span></span><br><span class=\"line\"><span class=\"comment\">//result in s0 and s1</span></span><br></pre></td></tr></table></figure>\n\n<p>s0s1()s132s0</p>\n<p></p>\n<p>:</p>\n<ol>\n<li>flush</li>\n<li></li>\n<li></li>\n</ol>\n<p>:</p>\n<ol>\n<li></li>\n<li></li>\n<li>NFS</li>\n<li></li>\n<li></li>\n<li>(-wal,-shm)</li>\n<li></li>\n</ol>\n","site":{"data":{}},"excerpt":"<p>release 3.7.0SQLiteWAL<code>pragma journal_mode=WAL</code>WAL(Pager182)SQLiteWALwal-wal</p>","more":"<p>()walwal</p>\n<p>wal32wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td>:0x377f0682()  0x377f0683()</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1: </td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2: </td>\n</tr>\n<tr>\n<td>24</td>\n<td>4</td>\n<td>-1: 24</td>\n</tr>\n<tr>\n<td>28</td>\n<td>4</td>\n<td>-2: 24</td>\n</tr>\n</tbody></table>\n<p>wal24wal4</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>4</td>\n<td></td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td><br/>0</td>\n</tr>\n<tr>\n<td>8</td>\n<td>4</td>\n<td>-1 WAL</td>\n</tr>\n<tr>\n<td>12</td>\n<td>4</td>\n<td>-2 WAL</td>\n</tr>\n<tr>\n<td>16</td>\n<td>4</td>\n<td>-1:8</td>\n</tr>\n<tr>\n<td>20</td>\n<td>4</td>\n<td>-2:8</td>\n</tr>\n</tbody></table>\n<p>walpagerWAL()pagerpWALppagerpwalpagerpSQLite<code>wal-index</code>p</p>\n<p><code>wal-index</code>-shm(wal)SQLite<code>wal-index</code><code>wal-index</code>wal<code>wal-index</code></p>\n<p>walwal1000SQLite(SQLITE_DEFAULT_WAL_AUTOCHECKPOINT)SQLite:</p>\n<ul>\n<li>flushwal</li>\n<li></li>\n<li>flush(wal)</li>\n<li>wal-1-2(wal)</li>\n<li><code>wal-index</code></li>\n</ul>\n<p>wal;wal</p>\n<p>flush(journalflushflush<code>nRec</code>)WALflushflush(<code>PRAGMA synchronous=FULL</code>flush<code>PRAGMA synchronous=NORMAL</code>flush)</p>\n<p><code>sqlite3_wal_hook()</code>WALhook<code>sqlite3_wal_checkpoint()</code>  <code>sqlite3_wal_checkpoint_v2()</code> <code>sqlite3_wal_hook()</code>checkpointPASSIVEFULLRESTART<code>sqlite3_wal_checkpoint()</code>PASSIVEFULLRESTART<code>sqlite3_wal_checkpoint_v2()</code></p>\n<p>**:**48x(0)-x(N),x4N:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s0 = s1 = <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i from <span class=\"number\">0</span> to n<span class=\"number\">-1</span> step <span class=\"number\">2</span>:</span><br><span class=\"line\">   s0 += x(i) + s1;</span><br><span class=\"line\">   s1 += x(i+<span class=\"number\">1</span>) + s0;</span><br><span class=\"line\">end <span class=\"keyword\">for</span></span><br><span class=\"line\"><span class=\"comment\">//result in s0 and s1</span></span><br></pre></td></tr></table></figure>\n\n<p>s0s1()s132s0</p>\n<p></p>\n<p>:</p>\n<ol>\n<li>flush</li>\n<li></li>\n<li></li>\n</ol>\n<p>:</p>\n<ol>\n<li></li>\n<li></li>\n<li>NFS</li>\n<li></li>\n<li></li>\n<li>(-wal,-shm)</li>\n<li></li>\n</ol>"},{"title":"","date":"2019-12-16T16:00:00.000Z","_content":"\n## Linux\n\n\n1. \n2. PIC\n\n### \n\n\n\n\n\n...TEXT\n\n\n\n\n\nTEXT\n\nPIC\n\n### PIC\n\nPIC\n\n1. \n\nTEXT\n\n +\n\nTEXTDATA\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png)\n\n\n\nx86\n```\n    call TMPLABEL\nTMPLABEL:\n    pop ebx\n```\n\ncall TMPLABEL TMPLABEL pop ebxebxebx\n\n2. \n\nGOTGOT\n\nTEXT(A)TEXTAGOTA\n\nGOT\n\nPIC\n1. PICGOTPICGOT\n2. PICPIC\n\n### PIC\n\nPICPICGOT\n\n80%20%\n\n\n\nBind\n\n\n\nPLT\n\n1. \"\",GOT.\n2. GOT\n3. GOT\n\nPLT()\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png)\n\nGOTBindGOT\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png)\n\n## iOS\niOSLinux\n\nDemoNSLog\n\n```\n@interface ViewController ()\n@end\n\n@implementation ViewController\n- (void)viewDidLoad {\n    [super viewDidLoad];\n    // Do any additional setup after loading the view.\n    NSLog(@\"1\");\n    NSLog(@\"2\");\n}\n@end\n```\n\n### \n\n\n __TEXT  __text \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png)\n\nNSLogbl  0x100006558NSLog\n\n0x6558Text0x100000000,Load Commands\n\n0x6558__TEXT__stubsLinuxNSLog\n\n...MachOView\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png)\n\n...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png)\n\n__stubsimp__sthubs_NSLog\n```\nldr x16#0x10000c000\nbl x16\n```\nNSLog #0x10000c000 ...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png)\n\n__la_symbol_ptr,---GOTGOTNSLog0x660C\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png)\n\n__stub_helper...PLT\n\n```\nldr w16,0x100006614\nb 0x1000065f4\n.long 0x000000000\n```\n 0x100006614 w160 0x1000065f4\n0x1000065f4 __stub_helper dyld_stub_binder\n 0x100006614 dyld\n\n __la_symbol_ptr Bind\n\n**iOS**\n1. \n2. GOTGOT__stub_helper\n3. helperdyldBindBind\n\niOSLinuxiOSdyld\"__stub_helper\" \n\n### \nNSLog...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png)\n\n bl 0x100f46558 (NSLog)\n\n Xcode dis\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png)\n\n`ldr  x16, #0x5aa4` x1  +0x5aa4 = 0x100F4C000 Xcode\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png)\n\n 0x100f4660c  __la_symbol_ptr  __stubs_helper \n\n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png)\n\nNSLog...\n\n 0x100F4C000 \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png)\n\n 0x109c76e754\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png)\n\nNSLog~\n\n> Linux iOSiOSdyld\n\n\n\n[iOS  - ](https://www.jianshu.com/p/857855cda602)\n[](https://blog.csdn.net/parallelyk/article/details/42747239)\n[](https://blog.csdn.net/wuhui_gdnt/article/details/51035557)\n[PIC](https://blog.csdn.net/wuhui_gdnt/article/details/51094732)\n\n","source":"_posts/3.binding-symbols.md","raw":"---\ntitle: \ndate: 2019-12-17\ntags: [,]\ncategories: \n---\n\n## Linux\n\n\n1. \n2. PIC\n\n### \n\n\n\n\n\n...TEXT\n\n\n\n\n\nTEXT\n\nPIC\n\n### PIC\n\nPIC\n\n1. \n\nTEXT\n\n +\n\nTEXTDATA\n\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png)\n\n\n\nx86\n```\n    call TMPLABEL\nTMPLABEL:\n    pop ebx\n```\n\ncall TMPLABEL TMPLABEL pop ebxebxebx\n\n2. \n\nGOTGOT\n\nTEXT(A)TEXTAGOTA\n\nGOT\n\nPIC\n1. PICGOTPICGOT\n2. PICPIC\n\n### PIC\n\nPICPICGOT\n\n80%20%\n\n\n\nBind\n\n\n\nPLT\n\n1. \"\",GOT.\n2. GOT\n3. GOT\n\nPLT()\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png)\n\nGOTBindGOT\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png)\n\n## iOS\niOSLinux\n\nDemoNSLog\n\n```\n@interface ViewController ()\n@end\n\n@implementation ViewController\n- (void)viewDidLoad {\n    [super viewDidLoad];\n    // Do any additional setup after loading the view.\n    NSLog(@\"1\");\n    NSLog(@\"2\");\n}\n@end\n```\n\n### \n\n\n __TEXT  __text \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png)\n\nNSLogbl  0x100006558NSLog\n\n0x6558Text0x100000000,Load Commands\n\n0x6558__TEXT__stubsLinuxNSLog\n\n...MachOView\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png)\n\n...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png)\n\n__stubsimp__sthubs_NSLog\n```\nldr x16#0x10000c000\nbl x16\n```\nNSLog #0x10000c000 ...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png)\n\n__la_symbol_ptr,---GOTGOTNSLog0x660C\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png)\n\n__stub_helper...PLT\n\n```\nldr w16,0x100006614\nb 0x1000065f4\n.long 0x000000000\n```\n 0x100006614 w160 0x1000065f4\n0x1000065f4 __stub_helper dyld_stub_binder\n 0x100006614 dyld\n\n __la_symbol_ptr Bind\n\n**iOS**\n1. \n2. GOTGOT__stub_helper\n3. helperdyldBindBind\n\niOSLinuxiOSdyld\"__stub_helper\" \n\n### \nNSLog...\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png)\n\n bl 0x100f46558 (NSLog)\n\n Xcode dis\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png)\n\n`ldr  x16, #0x5aa4` x1  +0x5aa4 = 0x100F4C000 Xcode\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png)\n\n 0x100f4660c  __la_symbol_ptr  __stubs_helper \n\n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png)\n\nNSLog...\n\n 0x100F4C000 \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png)\n\n 0x109c76e754\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png)\n\nNSLog~\n\n> Linux iOSiOSdyld\n\n\n\n[iOS  - ](https://www.jianshu.com/p/857855cda602)\n[](https://blog.csdn.net/parallelyk/article/details/42747239)\n[](https://blog.csdn.net/wuhui_gdnt/article/details/51035557)\n[PIC](https://blog.csdn.net/wuhui_gdnt/article/details/51094732)\n\n","slug":"3.binding-symbols","published":1,"updated":"2020-08-29T14:42:58.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2lb001993c9512sabx2","content":"<h2 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h2><p></p>\n<ol>\n<li></li>\n<li>PIC</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p></p>\n<p>TEXT</p>\n<p></p>\n<p></p>\n<p>TEXT</p>\n<p>PIC</p>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PIC</p>\n<ol>\n<li></li>\n</ol>\n<p>TEXT</p>\n<p> +</p>\n<p>TEXTDATA</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png\"></p>\n<p></p>\n<p>x86</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    call TMPLABEL</span><br><span class=\"line\">TMPLABEL:</span><br><span class=\"line\">    pop ebx</span><br></pre></td></tr></table></figure>\n\n<p>call TMPLABEL TMPLABEL pop ebxebxebx</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>GOTGOT</p>\n<p>TEXT(A)TEXTAGOTA</p>\n<p>GOT</p>\n<p>PIC</p>\n<ol>\n<li>PICGOTPICGOT</li>\n<li>PICPIC</li>\n</ol>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PICPICGOT</p>\n<p>80%20%</p>\n<p></p>\n<p>Bind</p>\n<p></p>\n<p>PLT</p>\n<ol>\n<li>,GOT.</li>\n<li>GOT</li>\n<li>GOT</li>\n</ol>\n<p>PLT()<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png\"></p>\n<p>GOTBindGOT</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png\"></p>\n<h2 id=\"iOS\"><a href=\"#iOS\" class=\"headerlink\" title=\"iOS\"></a>iOS</h2><p>iOSLinux</p>\n<p>DemoNSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@interface ViewController ()</span><br><span class=\"line\">@end</span><br><span class=\"line\"></span><br><span class=\"line\">@implementation ViewController</span><br><span class=\"line\">- (void)viewDidLoad &#123;</span><br><span class=\"line\">    [super viewDidLoad];</span><br><span class=\"line\">    // Do any additional setup after loading the view.</span><br><span class=\"line\">    NSLog(@&quot;1&quot;);</span><br><span class=\"line\">    NSLog(@&quot;2&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p> __TEXT  __text </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png\"></p>\n<p>NSLogbl  0x100006558NSLog</p>\n<p>0x6558Text0x100000000,Load Commands</p>\n<p>0x6558__TEXT__stubsLinuxNSLog</p>\n<p>MachOView<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png\"></p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png\"></p>\n<p>__stubsimp__sthubs_NSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr x16#0x10000c000</span><br><span class=\"line\">bl x16</span><br></pre></td></tr></table></figure>\n<p>NSLog #0x10000c000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png\"></p>\n<p>__la_symbol_ptr,GOTGOTNSLog0x660C</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png\"></p>\n<p>__stub_helperPLT</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr w16,0x100006614</span><br><span class=\"line\">b 0x1000065f4</span><br><span class=\"line\">.long 0x000000000</span><br></pre></td></tr></table></figure>\n<p> 0x100006614 w160 0x1000065f4<br>0x1000065f4 __stub_helper dyld_stub_binder<br> 0x100006614 dyld</p>\n<p> __la_symbol_ptr Bind</p>\n<p><strong>iOS</strong></p>\n<ol>\n<li></li>\n<li>GOTGOT__stub_helper</li>\n<li>helperdyldBindBind</li>\n</ol>\n<p>iOSLinuxiOSdyld__stub_helper </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NSLog<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png\"></p>\n<p> bl 0x100f46558 (NSLog)</p>\n<p> Xcode dis<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png\"></p>\n<p><code>ldr  x16, #0x5aa4</code> x1  +0x5aa4 &#x3D; 0x100F4C000 Xcode<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png\"></p>\n<p> 0x100f4660c  __la_symbol_ptr  __stubs_helper </p>\n<p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png\"></p>\n<p>NSLog</p>\n<p> 0x100F4C000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png\"></p>\n<p> 0x109c76e754<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png\"></p>\n<p>NSLog~</p>\n<blockquote>\n<p>Linux iOSiOSdyld</p>\n</blockquote>\n<p><br><a href=\"https://www.jianshu.com/p/857855cda602\">iOS  - </a><br><a href=\"https://blog.csdn.net/parallelyk/article/details/42747239\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51035557\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51094732\">PIC</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h2><p></p>\n<ol>\n<li></li>\n<li>PIC</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p></p>\n<p>TEXT</p>\n<p></p>\n<p></p>\n<p>TEXT</p>\n<p>PIC</p>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PIC</p>\n<ol>\n<li></li>\n</ol>\n<p>TEXT</p>\n<p> +</p>\n<p>TEXTDATA</p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711225490-300x280.png\"></p>\n<p></p>\n<p>x86</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    call TMPLABEL</span><br><span class=\"line\">TMPLABEL:</span><br><span class=\"line\">    pop ebx</span><br></pre></td></tr></table></figure>\n\n<p>call TMPLABEL TMPLABEL pop ebxebxebx</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>GOTGOT</p>\n<p>TEXT(A)TEXTAGOTA</p>\n<p>GOT</p>\n<p>PIC</p>\n<ol>\n<li>PICGOTPICGOT</li>\n<li>PICPIC</li>\n</ol>\n<h3 id=\"PIC\"><a href=\"#PIC\" class=\"headerlink\" title=\"PIC\"></a>PIC</h3><p>PICPICGOT</p>\n<p>80%20%</p>\n<p></p>\n<p>Bind</p>\n<p></p>\n<p>PLT</p>\n<ol>\n<li>,GOT.</li>\n<li>GOT</li>\n<li>GOT</li>\n</ol>\n<p>PLT()<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2019121711250179-300x154.png\"></p>\n<p>GOTBindGOT</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/201912171125358-300x184.png\"></p>\n<h2 id=\"iOS\"><a href=\"#iOS\" class=\"headerlink\" title=\"iOS\"></a>iOS</h2><p>iOSLinux</p>\n<p>DemoNSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@interface ViewController ()</span><br><span class=\"line\">@end</span><br><span class=\"line\"></span><br><span class=\"line\">@implementation ViewController</span><br><span class=\"line\">- (void)viewDidLoad &#123;</span><br><span class=\"line\">    [super viewDidLoad];</span><br><span class=\"line\">    // Do any additional setup after loading the view.</span><br><span class=\"line\">    NSLog(@&quot;1&quot;);</span><br><span class=\"line\">    NSLog(@&quot;2&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">@end</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p></p>\n<p> __TEXT  __text </p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/2995f8ee2c76a2b85054185cc0fe56c4.png\"></p>\n<p>NSLogbl  0x100006558NSLog</p>\n<p>0x6558Text0x100000000,Load Commands</p>\n<p>0x6558__TEXT__stubsLinuxNSLog</p>\n<p>MachOView<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e401b01710523114905587681e611b87.png\"></p>\n<p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/8fd0ad5d02a843cfe7f22f291972a7bd.png\"></p>\n<p>__stubsimp__sthubs_NSLog</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr x16#0x10000c000</span><br><span class=\"line\">bl x16</span><br></pre></td></tr></table></figure>\n<p>NSLog #0x10000c000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/acca5b46a20c2d549fbbe8e53bfc21d0.png\"></p>\n<p>__la_symbol_ptr,GOTGOTNSLog0x660C</p>\n<p><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/fd4c678b7b1035438732b918cd91d426.png\"></p>\n<p>__stub_helperPLT</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ldr w16,0x100006614</span><br><span class=\"line\">b 0x1000065f4</span><br><span class=\"line\">.long 0x000000000</span><br></pre></td></tr></table></figure>\n<p> 0x100006614 w160 0x1000065f4<br>0x1000065f4 __stub_helper dyld_stub_binder<br> 0x100006614 dyld</p>\n<p> __la_symbol_ptr Bind</p>\n<p><strong>iOS</strong></p>\n<ol>\n<li></li>\n<li>GOTGOT__stub_helper</li>\n<li>helperdyldBindBind</li>\n</ol>\n<p>iOSLinuxiOSdyld__stub_helper </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NSLog<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0ed614a79304fe82ebd32bbd65cff51a.png\"></p>\n<p> bl 0x100f46558 (NSLog)</p>\n<p> Xcode dis<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/12b7e4719dd20339a6cbd1ba7020ed7c.png\"></p>\n<p><code>ldr  x16, #0x5aa4</code> x1  +0x5aa4 &#x3D; 0x100F4C000 Xcode<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b03ec9a2e1f26e74a557fed9bd87db79.png\"></p>\n<p> 0x100f4660c  __la_symbol_ptr  __stubs_helper </p>\n<p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/036b6c1e611cf344da64f74cf774626a.png\"></p>\n<p>NSLog</p>\n<p> 0x100F4C000 <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/099695463b49a2eb7f6f2972f6ceb739.png\"></p>\n<p> 0x109c76e754<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/826557c3c1e53c4da1529fbfe29dc6ed.png\"></p>\n<p>NSLog~</p>\n<blockquote>\n<p>Linux iOSiOSdyld</p>\n</blockquote>\n<p><br><a href=\"https://www.jianshu.com/p/857855cda602\">iOS  - </a><br><a href=\"https://blog.csdn.net/parallelyk/article/details/42747239\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51035557\"></a><br><a href=\"https://blog.csdn.net/wuhui_gdnt/article/details/51094732\">PIC</a></p>\n"},{"title":"oc@synchronized","date":"2019-12-19T16:00:00.000Z","_content":"\n## @synchronized\n\nOC `clang --rewrite-objc code.m` clang  c  c++ [ocblock](https://caio.ink/oc-block-imp/)@autoreleasepool@synchronized\n\n<!-- more -->\n\n:\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = [NSObject new];\n    @synchronized (o) {\n        NSLog(@\"helloworld\");\n    }\n}\n```\n\nclang :\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = ((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(\"NSObject\"), sel_registerName(\"new\"));\n    {\n        id _rethrow = 0;\n        id _sync_obj = (id)o;\n\t\t\n        objc_sync_enter(_sync_obj);\n\t\t\n        try {\n            struct _SYNC_EXIT {\n                _SYNC_EXIT(id arg) : sync_exit(arg) {}\n                ~_SYNC_EXIT()\n                {\n                    objc_sync_exit(sync_exit);\n                }\n                id sync_exit;\n            } _sync_exit(_sync_obj);\n\n            NSLog((NSString *)&__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);\n        } catch (id e) {\n            _rethrow = e;\n        }\n\t\t\n        {\n            struct _FIN {\n                _FIN(id reth) : rethrow(reth) {}\n                ~_FIN() {\n                    if (rethrow)\n                        objc_exception_throw(rethrow);\n                }\n                id rethrow;\n            } _fin_force_rethow(_rethrow);\n        }\n    }\n}\n```\n\n\n1. `@synchronized` try\n2. try `objc_sync_enter(_sync_obj)` \n3. tryC++C++\"\"C++\n4. tryC++`objc_sync_exit(sync_exit)`\"\"\n5. `@synchronized` catch\n\n> ``OC\n\n\n1. objc_sync_enter(obj); \n2. objc_sync_exit(obj); \n\n### objc_sync_enter  objc_sync_exit\n\n`libobjc.A.dylib`(Runtime) objc-sync.h/.m  \n\n```c\nint objc_sync_enter(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n\n    if (obj) {\n        SyncData* data = id2data(obj, ACQUIRE);\n        data->mutex.lock();\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\n    return result;\n}\n\nint objc_sync_exit(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n    \n    if (obj) {\n        SyncData* data = id2data(obj, RELEASE); \n        if (!data) {\n            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n        } else {\n            bool okay = data->mutex.tryUnlock();\n            if (!okay) {\n                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n            }\n        }\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\t\n    return result;\n}\n```\n\n`id2data`, obj  `SyncData`, mutex `@synchronized`ocmutex\n\n## id2data\n\n\n#### SyncData\n```c\ntypedef struct alignas(CacheLineSize) SyncData {\n    struct SyncData* nextData;\n    DisguisedPtr<objc_object> object;\n    int32_t threadCount;  // number of THREADS using this block\n    recursive_mutex_t mutex;\n} SyncData;\n```\n1. SyncData\"\"\n2. SyncDatanextData\n3. object\"\"\n4. threadCount\n5. mutex (os_unfair_recursive_lock),\n\n#### SyncCache\n```c\ntypedef struct SyncCache {\n    unsigned int allocated;\n    unsigned int used;\n    SyncCacheItem list[0];\n} SyncCache;\n```\n1. SyncCache TLS()`SyncData`TLS\n2. list`SyncCacheItem`,`SyncCacheItem``SyncData`lockCountlockCount@synchronized\n3. allocatedcacheused4size\n\n\nid2dataid()SyncData,...syncData.mutex.lock()\n\n**SyncData**\n\n\n1. `TLS`:****`TLS``SyncData``TLS`fast cache\n2. `SyncCache`:`TLS``SyncCache``SyncCache``SyncData`\n3.  12`static StripedMap<SyncList> sDataLists``sDataList`Mapkeyvalue`SyncList`\n\n aDataLists\n- StripedMapkey(id)mapsize64iPhone8`SyncData``SyncList``SyncList``spinlock_t`,\n- StripedMapSyncList`SyncData`(threadCount==0)\n\n\n`id2data`\n1.  `SYNC_DATA_DIRECT_KEY``SYNC_COUNT_DIRECT_KEY`keyTLS`SyncData`,TLS`SyncData`\n2. TLS`SyncCache``SyncData``SyncCacheItem`lockCount`SyncData`\n3. 12`SyncData``sDataLists``SyncList``SyncList``SyncData`\n4. 3`SyncData``SyncList`\n5. `TLS``SYNC_DATA_DIRECT_KEY`****`SyncCache`\n\n:\n12lockCount0SyncData`SyncData`threadCount,3`SyncData`\n\n### @synchronized\n\n@synchronized\n\n@synchronized\n\n\n1. `id2data``TLS`,`SyncCache`,`sDataLists`\n2. `SyncData`\n\n\n\n****\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n}\n```\n pthread_mutex  synchronized  \npthread_mutex:200ms\nsynchronized:6800ms\n\n...em......\n\n`..TLS....TLS`,`TLS`\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t@synchronized(t){\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n\t}\n}\n```\npthread_mutex:200ms\nsynchronized:2700ms\n\n......\n\nRuntime\n\n----\n:\n\n`synchronized`objc-sync.mm `objc_sync_enter`  `objc_sync_exit`\n\nsynchronized1000ms+\n\nobjc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png)\n\nsynchronized\n\nmrc\n\n 40ms+objc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png)\n\n1000ms+mrc\n\n#### \n\n `objc_sync_enter`  `objc_sync_exit`\n\n 900ms+\n\n#### \n\n`SyncData``os_unfair_recursive_lock`\n\n OSPinLock OSPinLockCPUGCD[](https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/)\n\n`os_unfair_lock`\n![](https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png)\n\n\n```c\ntypedef struct os_unfair_recursive_lock_s {\n    os_unfair_lock ourl_lock;\n    uint32_t ourl_count;\n} os_unfair_recursive_lock;\n```\n``` c\n        os_unfair_recursive_lock lock = ((os_unfair_recursive_lock){OS_UNFAIR_LOCK_INIT, 0});\n        os_unfair_recursive_lock *mlock = &lock;\n        for (int index = 0; index < 10000000; index++) {\n            os_unfair_recursive_lock_lock_with_options(&lock, 0x00000000);\n                count ++;\n            os_unfair_recursive_lock_tryunlock4objc(&lock);\n        }\n```\n\n200ms`os_unfair_lock``pthread_mutex`10%\n\n 1000ms+900ms+200ms = 2100ms\n\n500ms500ms\n\nobjc-os.hLOCKDEBUGdebug2900ms -> 2100ms\n\n> :\n1.synchronized os_unfair_lock pthread_mutex\n2.synchronizedTLSCache","source":"_posts/4.synchronized.md","raw":"---\ntitle: oc@synchronized\ndate: 2019-12-20\ntags: [object-c,]\ncategories: \n---\n\n## @synchronized\n\nOC `clang --rewrite-objc code.m` clang  c  c++ [ocblock](https://caio.ink/oc-block-imp/)@autoreleasepool@synchronized\n\n<!-- more -->\n\n:\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = [NSObject new];\n    @synchronized (o) {\n        NSLog(@\"helloworld\");\n    }\n}\n```\n\nclang :\n```c\nint main(int argc, const char * argv[]) {\n    NSObject *o = ((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(\"NSObject\"), sel_registerName(\"new\"));\n    {\n        id _rethrow = 0;\n        id _sync_obj = (id)o;\n\t\t\n        objc_sync_enter(_sync_obj);\n\t\t\n        try {\n            struct _SYNC_EXIT {\n                _SYNC_EXIT(id arg) : sync_exit(arg) {}\n                ~_SYNC_EXIT()\n                {\n                    objc_sync_exit(sync_exit);\n                }\n                id sync_exit;\n            } _sync_exit(_sync_obj);\n\n            NSLog((NSString *)&__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);\n        } catch (id e) {\n            _rethrow = e;\n        }\n\t\t\n        {\n            struct _FIN {\n                _FIN(id reth) : rethrow(reth) {}\n                ~_FIN() {\n                    if (rethrow)\n                        objc_exception_throw(rethrow);\n                }\n                id rethrow;\n            } _fin_force_rethow(_rethrow);\n        }\n    }\n}\n```\n\n\n1. `@synchronized` try\n2. try `objc_sync_enter(_sync_obj)` \n3. tryC++C++\"\"C++\n4. tryC++`objc_sync_exit(sync_exit)`\"\"\n5. `@synchronized` catch\n\n> ``OC\n\n\n1. objc_sync_enter(obj); \n2. objc_sync_exit(obj); \n\n### objc_sync_enter  objc_sync_exit\n\n`libobjc.A.dylib`(Runtime) objc-sync.h/.m  \n\n```c\nint objc_sync_enter(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n\n    if (obj) {\n        SyncData* data = id2data(obj, ACQUIRE);\n        data->mutex.lock();\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\n    return result;\n}\n\nint objc_sync_exit(id obj)\n{\n    int result = OBJC_SYNC_SUCCESS;\n    \n    if (obj) {\n        SyncData* data = id2data(obj, RELEASE); \n        if (!data) {\n            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n        } else {\n            bool okay = data->mutex.tryUnlock();\n            if (!okay) {\n                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;\n            }\n        }\n    } else {\n        // @synchronized(nil) does nothing\n    }\n\t\n    return result;\n}\n```\n\n`id2data`, obj  `SyncData`, mutex `@synchronized`ocmutex\n\n## id2data\n\n\n#### SyncData\n```c\ntypedef struct alignas(CacheLineSize) SyncData {\n    struct SyncData* nextData;\n    DisguisedPtr<objc_object> object;\n    int32_t threadCount;  // number of THREADS using this block\n    recursive_mutex_t mutex;\n} SyncData;\n```\n1. SyncData\"\"\n2. SyncDatanextData\n3. object\"\"\n4. threadCount\n5. mutex (os_unfair_recursive_lock),\n\n#### SyncCache\n```c\ntypedef struct SyncCache {\n    unsigned int allocated;\n    unsigned int used;\n    SyncCacheItem list[0];\n} SyncCache;\n```\n1. SyncCache TLS()`SyncData`TLS\n2. list`SyncCacheItem`,`SyncCacheItem``SyncData`lockCountlockCount@synchronized\n3. allocatedcacheused4size\n\n\nid2dataid()SyncData,...syncData.mutex.lock()\n\n**SyncData**\n\n\n1. `TLS`:****`TLS``SyncData``TLS`fast cache\n2. `SyncCache`:`TLS``SyncCache``SyncCache``SyncData`\n3.  12`static StripedMap<SyncList> sDataLists``sDataList`Mapkeyvalue`SyncList`\n\n aDataLists\n- StripedMapkey(id)mapsize64iPhone8`SyncData``SyncList``SyncList``spinlock_t`,\n- StripedMapSyncList`SyncData`(threadCount==0)\n\n\n`id2data`\n1.  `SYNC_DATA_DIRECT_KEY``SYNC_COUNT_DIRECT_KEY`keyTLS`SyncData`,TLS`SyncData`\n2. TLS`SyncCache``SyncData``SyncCacheItem`lockCount`SyncData`\n3. 12`SyncData``sDataLists``SyncList``SyncList``SyncData`\n4. 3`SyncData``SyncList`\n5. `TLS``SYNC_DATA_DIRECT_KEY`****`SyncCache`\n\n:\n12lockCount0SyncData`SyncData`threadCount,3`SyncData`\n\n### @synchronized\n\n@synchronized\n\n@synchronized\n\n\n1. `id2data``TLS`,`SyncCache`,`sDataLists`\n2. `SyncData`\n\n\n\n****\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n}\n```\n pthread_mutex  synchronized  \npthread_mutex:200ms\nsynchronized:6800ms\n\n...em......\n\n`..TLS....TLS`,`TLS`\n\n```c\nvoid main(){\n\t\tNSObject *t = [NSObject new];\n\t@synchronized(t){\n\t\tuint64_t pre = mach_absolute_time();\n        int count = 0;\n        for (int index = 0; index < 10000000; index++) {\n            @synchronized (t) {\n                count ++;\n            }\n        }\n        uint64_t now = mach_absolute_time();\n        uint64_t deltaA = now-pre;\n        NSLog(@\"synchronized count:%d time:%llu\", count, deltaA/1000000);\n\t\n        uint64_t pre1 = mach_absolute_time();\n        count = 0;\n        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;\n        for (int index = 0; index < 10000000; index++) {\n            pthread_mutex_lock(&mutex);\n            count ++;\n            pthread_mutex_unlock(&mutex);\n        }\n\t\n        uint64_t now1 = mach_absolute_time();\n\t\n        uint64_t deltaB = now1-pre1;\n        NSLog(@\"count:%d time:%llu\", count, deltaB/1000000);\n\t}\n}\n```\npthread_mutex:200ms\nsynchronized:2700ms\n\n......\n\nRuntime\n\n----\n:\n\n`synchronized`objc-sync.mm `objc_sync_enter`  `objc_sync_exit`\n\nsynchronized1000ms+\n\nobjc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png)\n\nsynchronized\n\nmrc\n\n 40ms+objc_retain\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png)\n\n1000ms+mrc\n\n#### \n\n `objc_sync_enter`  `objc_sync_exit`\n\n 900ms+\n\n#### \n\n`SyncData``os_unfair_recursive_lock`\n\n OSPinLock OSPinLockCPUGCD[](https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/)\n\n`os_unfair_lock`\n![](https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png)\n\n\n```c\ntypedef struct os_unfair_recursive_lock_s {\n    os_unfair_lock ourl_lock;\n    uint32_t ourl_count;\n} os_unfair_recursive_lock;\n```\n``` c\n        os_unfair_recursive_lock lock = ((os_unfair_recursive_lock){OS_UNFAIR_LOCK_INIT, 0});\n        os_unfair_recursive_lock *mlock = &lock;\n        for (int index = 0; index < 10000000; index++) {\n            os_unfair_recursive_lock_lock_with_options(&lock, 0x00000000);\n                count ++;\n            os_unfair_recursive_lock_tryunlock4objc(&lock);\n        }\n```\n\n200ms`os_unfair_lock``pthread_mutex`10%\n\n 1000ms+900ms+200ms = 2100ms\n\n500ms500ms\n\nobjc-os.hLOCKDEBUGdebug2900ms -> 2100ms\n\n> :\n1.synchronized os_unfair_lock pthread_mutex\n2.synchronizedTLSCache","slug":"4.synchronized","published":1,"updated":"2020-08-29T14:42:58.501Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2lc001b93c9ej8w51iu","content":"<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ <a href=\"https://caio.ink/oc-block-imp/\">ocblock</a>@autoreleasepool@synchronized</p>\n<span id=\"more\"></span>\n\n<p>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = [NSObject new];</span><br><span class=\"line\">    @synchronized (o) &#123;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;helloworld&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>clang :</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = ((NSObject *(*)(id, SEL))(<span class=\"type\">void</span> *)objc_msgSend)((id)objc_getClass(<span class=\"string\">&quot;NSObject&quot;</span>), sel_registerName(<span class=\"string\">&quot;new&quot;</span>));</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        id _rethrow = <span class=\"number\">0</span>;</span><br><span class=\"line\">        id _sync_obj = (id)o;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        objc_sync_enter(_sync_obj);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">SYNC_EXIT</span> &#123;</span></span><br><span class=\"line\">                _SYNC_EXIT(id arg) : sync_exit(arg) &#123;&#125;</span><br><span class=\"line\">                ~_SYNC_EXIT()</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    objc_sync_exit(sync_exit);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id sync_exit;</span><br><span class=\"line\">            &#125; _sync_exit(_sync_obj);</span><br><span class=\"line\"></span><br><span class=\"line\">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);</span><br><span class=\"line\">        &#125; catch (id e) &#123;</span><br><span class=\"line\">            _rethrow = e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">FIN</span> &#123;</span></span><br><span class=\"line\">                _FIN(id reth) : rethrow(reth) &#123;&#125;</span><br><span class=\"line\">                ~_FIN() &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (rethrow)</span><br><span class=\"line\">                        objc_exception_throw(rethrow);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id rethrow;</span><br><span class=\"line\">            &#125; _fin_force_rethow(_rethrow);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>@synchronized</code> try</li>\n<li>try <code>objc_sync_enter(_sync_obj)</code> </li>\n<li>tryC++C++C++</li>\n<li>tryC++<code>objc_sync_exit(sync_exit)</code></li>\n<li><code>@synchronized</code> catch</li>\n</ol>\n<blockquote>\n<p><code></code>OC</p>\n</blockquote>\n<p></p>\n<ol>\n<li>objc_sync_enter(obj); </li>\n<li>objc_sync_exit(obj); </li>\n</ol>\n<h3 id=\"objc-sync-enter--objc-sync-exit\"><a href=\"#objc-sync-enter--objc-sync-exit\" class=\"headerlink\" title=\"objc_sync_enter  objc_sync_exit\"></a>objc_sync_enter  objc_sync_exit</h3><p><code>libobjc.A.dylib</code>(Runtime) objc-sync.h&#x2F;.m  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_enter</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, ACQUIRE);</span><br><span class=\"line\">        data-&gt;mutex.lock();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_exit</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, RELEASE); </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!data) &#123;</span><br><span class=\"line\">            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">bool</span> okay = data-&gt;mutex.tryUnlock();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!okay) &#123;</span><br><span class=\"line\">                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>id2data</code>, obj  <code>SyncData</code>, mutex <code>@synchronized</code>ocmutex</p>\n<h2 id=\"id2data\"><a href=\"#id2data\" class=\"headerlink\" title=\"id2data\"></a>id2data</h2><p></p>\n<h4 id=\"SyncData\"><a href=\"#SyncData\" class=\"headerlink\" title=\"SyncData\"></a>SyncData</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> <span class=\"title function_\">alignas</span><span class=\"params\">(CacheLineSize)</span> SyncData &#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncData</span>* <span class=\"title\">nextData</span>;</span></span><br><span class=\"line\">    DisguisedPtr&lt;objc_object&gt; object;</span><br><span class=\"line\">    <span class=\"type\">int32_t</span> threadCount;  <span class=\"comment\">// number of THREADS using this block</span></span><br><span class=\"line\">    <span class=\"type\">recursive_mutex_t</span> mutex;</span><br><span class=\"line\">&#125; SyncData;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncData</li>\n<li>SyncDatanextData</li>\n<li>object</li>\n<li>threadCount</li>\n<li>mutex (os_unfair_recursive_lock),</li>\n</ol>\n<h4 id=\"SyncCache\"><a href=\"#SyncCache\" class=\"headerlink\" title=\"SyncCache\"></a>SyncCache</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncCache</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> allocated;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> used;</span><br><span class=\"line\">    SyncCacheItem <span class=\"built_in\">list</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125; SyncCache;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncCache TLS()<code>SyncData</code>TLS</li>\n<li>list<code>SyncCacheItem</code>,<code>SyncCacheItem</code><code>SyncData</code>lockCountlockCount@synchronized</li>\n<li>allocatedcacheused4size</li>\n</ol>\n<p>id2dataid()SyncData,syncData.mutex.lock()</p>\n<p><strong>SyncData</strong></p>\n<p></p>\n<ol>\n<li><code>TLS</code>:<strong></strong><code>TLS</code><code>SyncData</code><code>TLS</code>fast cache</li>\n<li><code>SyncCache</code>:<code>TLS</code><code>SyncCache</code><code>SyncCache</code><code>SyncData</code></li>\n<li> 12<code>static StripedMap&lt;SyncList&gt; sDataLists</code><code>sDataList</code>Mapkeyvalue<code>SyncList</code></li>\n</ol>\n<p> aDataLists</p>\n<ul>\n<li>StripedMapkey(id)mapsize64iPhone8<code>SyncData</code><code>SyncList</code><code>SyncList</code><code>spinlock_t</code>,</li>\n<li>StripedMapSyncList<code>SyncData</code>(threadCount&#x3D;&#x3D;0)</li>\n</ul>\n<p><code>id2data</code></p>\n<ol>\n<li> <code>SYNC_DATA_DIRECT_KEY</code><code>SYNC_COUNT_DIRECT_KEY</code>keyTLS<code>SyncData</code>,TLS<code>SyncData</code></li>\n<li>TLS<code>SyncCache</code><code>SyncData</code><code>SyncCacheItem</code>lockCount<code>SyncData</code></li>\n<li>12<code>SyncData</code><code>sDataLists</code><code>SyncList</code><code>SyncList</code><code>SyncData</code></li>\n<li>3<code>SyncData</code><code>SyncList</code></li>\n<li><code>TLS</code><code>SYNC_DATA_DIRECT_KEY</code><strong></strong><code>SyncCache</code></li>\n</ol>\n<p>:<br>12lockCount0SyncData<code>SyncData</code>threadCount,3<code>SyncData</code></p>\n<h3 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h3><p>@synchronized</p>\n<p>@synchronized</p>\n<p></p>\n<ol>\n<li><code>id2data</code><code>TLS</code>,<code>SyncCache</code>,<code>sDataLists</code></li>\n<li><code>SyncData</code></li>\n</ol>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> pthread_mutex  synchronized  <br>pthread_mutex:200ms<br>synchronized:6800ms</p>\n<p>em</p>\n<p><code>..TLS....TLS</code>,<code>TLS</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t@synchronized(t)&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>pthread_mutex:200ms<br>synchronized:2700ms</p>\n<p>......</p>\n<p>Runtime</p>\n<hr>\n<p>:</p>\n<p><code>synchronized</code>objc-sync.mm <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p>synchronized1000ms+</p>\n<p>objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png\"></p>\n<p>synchronized</p>\n<p>mrc</p>\n<p> 40ms+objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png\"></p>\n<p>1000ms+mrc</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p> 900ms+</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>SyncData</code><code>os_unfair_recursive_lock</code></p>\n<p> OSPinLock OSPinLockCPUGCD<a href=\"https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/\"></a></p>\n<p><code>os_unfair_lock</code><br><img src=\"https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png\"></p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">os_unfair_recursive_lock_s</span> &#123;</span></span><br><span class=\"line\">    os_unfair_lock ourl_lock;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> ourl_count;</span><br><span class=\"line\">&#125; os_unfair_recursive_lock;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">os_unfair_recursive_lock lock = ((os_unfair_recursive_lock)&#123;OS_UNFAIR_LOCK_INIT, <span class=\"number\">0</span>&#125;);</span><br><span class=\"line\">os_unfair_recursive_lock *mlock = &amp;lock;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">    os_unfair_recursive_lock_lock_with_options(&amp;lock, <span class=\"number\">0x00000000</span>);</span><br><span class=\"line\">        count ++;</span><br><span class=\"line\">    os_unfair_recursive_lock_tryunlock4objc(&amp;lock);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>200ms<code>os_unfair_lock</code><code>pthread_mutex</code>10%</p>\n<p> 1000ms+900ms+200ms &#x3D; 2100ms</p>\n<p>500ms500ms</p>\n<p>objc-os.hLOCKDEBUGdebug2900ms -&gt; 2100ms</p>\n<blockquote>\n<p>:<br>1.synchronized os_unfair_lock pthread_mutex<br>2.synchronizedTLSCache</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"<h2 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ <a href=\"https://caio.ink/oc-block-imp/\">ocblock</a>@autoreleasepool@synchronized</p>","more":"<p>:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = [NSObject new];</span><br><span class=\"line\">    @synchronized (o) &#123;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;helloworld&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>clang :</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">const</span> <span class=\"type\">char</span> * argv[])</span> &#123;</span><br><span class=\"line\">    NSObject *o = ((NSObject *(*)(id, SEL))(<span class=\"type\">void</span> *)objc_msgSend)((id)objc_getClass(<span class=\"string\">&quot;NSObject&quot;</span>), sel_registerName(<span class=\"string\">&quot;new&quot;</span>));</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        id _rethrow = <span class=\"number\">0</span>;</span><br><span class=\"line\">        id _sync_obj = (id)o;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        objc_sync_enter(_sync_obj);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">SYNC_EXIT</span> &#123;</span></span><br><span class=\"line\">                _SYNC_EXIT(id arg) : sync_exit(arg) &#123;&#125;</span><br><span class=\"line\">                ~_SYNC_EXIT()</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    objc_sync_exit(sync_exit);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id sync_exit;</span><br><span class=\"line\">            &#125; _sync_exit(_sync_obj);</span><br><span class=\"line\"></span><br><span class=\"line\">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_vt_qgsk8yps0js52hgrjtwg9ch80000gn_T_main2_73ab4e_mi_0);</span><br><span class=\"line\">        &#125; catch (id e) &#123;</span><br><span class=\"line\">            _rethrow = e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"class\"><span class=\"keyword\">struct</span> _<span class=\"title\">FIN</span> &#123;</span></span><br><span class=\"line\">                _FIN(id reth) : rethrow(reth) &#123;&#125;</span><br><span class=\"line\">                ~_FIN() &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (rethrow)</span><br><span class=\"line\">                        objc_exception_throw(rethrow);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                id rethrow;</span><br><span class=\"line\">            &#125; _fin_force_rethow(_rethrow);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p></p>\n<ol>\n<li><code>@synchronized</code> try</li>\n<li>try <code>objc_sync_enter(_sync_obj)</code> </li>\n<li>tryC++C++C++</li>\n<li>tryC++<code>objc_sync_exit(sync_exit)</code></li>\n<li><code>@synchronized</code> catch</li>\n</ol>\n<blockquote>\n<p><code></code>OC</p>\n</blockquote>\n<p></p>\n<ol>\n<li>objc_sync_enter(obj); </li>\n<li>objc_sync_exit(obj); </li>\n</ol>\n<h3 id=\"objc-sync-enter--objc-sync-exit\"><a href=\"#objc-sync-enter--objc-sync-exit\" class=\"headerlink\" title=\"objc_sync_enter  objc_sync_exit\"></a>objc_sync_enter  objc_sync_exit</h3><p><code>libobjc.A.dylib</code>(Runtime) objc-sync.h&#x2F;.m  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_enter</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, ACQUIRE);</span><br><span class=\"line\">        data-&gt;mutex.lock();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">objc_sync_exit</span><span class=\"params\">(id obj)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (obj) &#123;</span><br><span class=\"line\">        SyncData* data = id2data(obj, RELEASE); </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!data) &#123;</span><br><span class=\"line\">            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"type\">bool</span> okay = data-&gt;mutex.tryUnlock();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!okay) &#123;</span><br><span class=\"line\">                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// @synchronized(nil) does nothing</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>id2data</code>, obj  <code>SyncData</code>, mutex <code>@synchronized</code>ocmutex</p>\n<h2 id=\"id2data\"><a href=\"#id2data\" class=\"headerlink\" title=\"id2data\"></a>id2data</h2><p></p>\n<h4 id=\"SyncData\"><a href=\"#SyncData\" class=\"headerlink\" title=\"SyncData\"></a>SyncData</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"keyword\">struct</span> <span class=\"title function_\">alignas</span><span class=\"params\">(CacheLineSize)</span> SyncData &#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncData</span>* <span class=\"title\">nextData</span>;</span></span><br><span class=\"line\">    DisguisedPtr&lt;objc_object&gt; object;</span><br><span class=\"line\">    <span class=\"type\">int32_t</span> threadCount;  <span class=\"comment\">// number of THREADS using this block</span></span><br><span class=\"line\">    <span class=\"type\">recursive_mutex_t</span> mutex;</span><br><span class=\"line\">&#125; SyncData;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncData</li>\n<li>SyncDatanextData</li>\n<li>object</li>\n<li>threadCount</li>\n<li>mutex (os_unfair_recursive_lock),</li>\n</ol>\n<h4 id=\"SyncCache\"><a href=\"#SyncCache\" class=\"headerlink\" title=\"SyncCache\"></a>SyncCache</h4><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">SyncCache</span> &#123;</span></span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> allocated;</span><br><span class=\"line\">    <span class=\"type\">unsigned</span> <span class=\"type\">int</span> used;</span><br><span class=\"line\">    SyncCacheItem <span class=\"built_in\">list</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125; SyncCache;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>SyncCache TLS()<code>SyncData</code>TLS</li>\n<li>list<code>SyncCacheItem</code>,<code>SyncCacheItem</code><code>SyncData</code>lockCountlockCount@synchronized</li>\n<li>allocatedcacheused4size</li>\n</ol>\n<p>id2dataid()SyncData,syncData.mutex.lock()</p>\n<p><strong>SyncData</strong></p>\n<p></p>\n<ol>\n<li><code>TLS</code>:<strong></strong><code>TLS</code><code>SyncData</code><code>TLS</code>fast cache</li>\n<li><code>SyncCache</code>:<code>TLS</code><code>SyncCache</code><code>SyncCache</code><code>SyncData</code></li>\n<li> 12<code>static StripedMap&lt;SyncList&gt; sDataLists</code><code>sDataList</code>Mapkeyvalue<code>SyncList</code></li>\n</ol>\n<p> aDataLists</p>\n<ul>\n<li>StripedMapkey(id)mapsize64iPhone8<code>SyncData</code><code>SyncList</code><code>SyncList</code><code>spinlock_t</code>,</li>\n<li>StripedMapSyncList<code>SyncData</code>(threadCount&#x3D;&#x3D;0)</li>\n</ul>\n<p><code>id2data</code></p>\n<ol>\n<li> <code>SYNC_DATA_DIRECT_KEY</code><code>SYNC_COUNT_DIRECT_KEY</code>keyTLS<code>SyncData</code>,TLS<code>SyncData</code></li>\n<li>TLS<code>SyncCache</code><code>SyncData</code><code>SyncCacheItem</code>lockCount<code>SyncData</code></li>\n<li>12<code>SyncData</code><code>sDataLists</code><code>SyncList</code><code>SyncList</code><code>SyncData</code></li>\n<li>3<code>SyncData</code><code>SyncList</code></li>\n<li><code>TLS</code><code>SYNC_DATA_DIRECT_KEY</code><strong></strong><code>SyncCache</code></li>\n</ol>\n<p>:<br>12lockCount0SyncData<code>SyncData</code>threadCount,3<code>SyncData</code></p>\n<h3 id=\"synchronized\"><a href=\"#synchronized\" class=\"headerlink\" title=\"@synchronized\"></a>@synchronized</h3><p>@synchronized</p>\n<p>@synchronized</p>\n<p></p>\n<ol>\n<li><code>id2data</code><code>TLS</code>,<code>SyncCache</code>,<code>sDataLists</code></li>\n<li><code>SyncData</code></li>\n</ol>\n<p></p>\n<p><strong></strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> pthread_mutex  synchronized  <br>pthread_mutex:200ms<br>synchronized:6800ms</p>\n<p>em</p>\n<p><code>..TLS....TLS</code>,<code>TLS</code></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">main</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">\t\tNSObject *t = [NSObject new];</span><br><span class=\"line\">\t@synchronized(t)&#123;</span><br><span class=\"line\">\t\t<span class=\"type\">uint64_t</span> pre = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            @synchronized (t) &#123;</span><br><span class=\"line\">                count ++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now = mach_absolute_time();</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaA = now-pre;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;synchronized count:%d time:%llu&quot;</span>, count, deltaA/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> pre1 = mach_absolute_time();</span><br><span class=\"line\">        count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"type\">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">            pthread_mutex_lock(&amp;mutex);</span><br><span class=\"line\">            count ++;</span><br><span class=\"line\">            pthread_mutex_unlock(&amp;mutex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> now1 = mach_absolute_time();</span><br><span class=\"line\">\t</span><br><span class=\"line\">        <span class=\"type\">uint64_t</span> deltaB = now1-pre1;</span><br><span class=\"line\">        NSLog(@<span class=\"string\">&quot;count:%d time:%llu&quot;</span>, count, deltaB/<span class=\"number\">1000000</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>pthread_mutex:200ms<br>synchronized:2700ms</p>\n<p>......</p>\n<p>Runtime</p>\n<hr>\n<p>:</p>\n<p><code>synchronized</code>objc-sync.mm <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p>synchronized1000ms+</p>\n<p>objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1ff8b0b7aa6cc03e763e5e3c693c19bf.png\"></p>\n<p>synchronized</p>\n<p>mrc</p>\n<p> 40ms+objc_retain<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6c4e55e070f1d49f795e3a440fc2cffd.png\"></p>\n<p>1000ms+mrc</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p> <code>objc_sync_enter</code>  <code>objc_sync_exit</code></p>\n<p> 900ms+</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><code>SyncData</code><code>os_unfair_recursive_lock</code></p>\n<p> OSPinLock OSPinLockCPUGCD<a href=\"https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/\"></a></p>\n<p><code>os_unfair_lock</code><br><img src=\"https://caio.ink/wp-content/uploads/2019/12/e9b18665440cf264a15213547cfc6860.png\"></p>\n<p></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">os_unfair_recursive_lock_s</span> &#123;</span></span><br><span class=\"line\">    os_unfair_lock ourl_lock;</span><br><span class=\"line\">    <span class=\"type\">uint32_t</span> ourl_count;</span><br><span class=\"line\">&#125; os_unfair_recursive_lock;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">os_unfair_recursive_lock lock = ((os_unfair_recursive_lock)&#123;OS_UNFAIR_LOCK_INIT, <span class=\"number\">0</span>&#125;);</span><br><span class=\"line\">os_unfair_recursive_lock *mlock = &amp;lock;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"type\">int</span> index = <span class=\"number\">0</span>; index &lt; <span class=\"number\">10000000</span>; index++) &#123;</span><br><span class=\"line\">    os_unfair_recursive_lock_lock_with_options(&amp;lock, <span class=\"number\">0x00000000</span>);</span><br><span class=\"line\">        count ++;</span><br><span class=\"line\">    os_unfair_recursive_lock_tryunlock4objc(&amp;lock);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>200ms<code>os_unfair_lock</code><code>pthread_mutex</code>10%</p>\n<p> 1000ms+900ms+200ms &#x3D; 2100ms</p>\n<p>500ms500ms</p>\n<p>objc-os.hLOCKDEBUGdebug2900ms -&gt; 2100ms</p>\n<blockquote>\n<p>:<br>1.synchronized os_unfair_lock pthread_mutex<br>2.synchronizedTLSCache</p>\n</blockquote>"},{"title":"oc block","date":"2019-12-20T16:00:00.000Z","_content":"\n## Block\n\nOC `clang --rewrite-objc code.m` clang  c  c++ ocblock@autoreleasepool[@synchronized](https://caio.ink/article-for-synchronized/)\n\n<!-- more -->\n\n## \n\n1. BlockCStructCStruct\n```c\ntypedef int (^blk_t) (int)\nblk_t blk = ^(int count){return count;};\nblk_t *blkptr = &blk;\n(*blkptr)(10);\n```\n2. Block C\n```c\n//const char text[] = hello;\nconst char *text = hello;\nvoid (^blk)(void) = ^{\n\ttext[0];\n};\n```\n\n## &\nBlock\n\n### \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png)\n\nBlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl\n\n### \n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png)\n\nBlockBlockBlockvoid *FuncPtr\n\n**C**\n```c\n//C\n//C\nvoid funcA(char a[20]){\n    char b[20] = a;\n}\n```\n\n###  &&  && \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png)\n\n\n\nBlockBlock\n\n### ()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png)\n\nBlockcopydesc0__main_block_copy_0OC\n\nBlockreleasedesc0__main_block_dispose_0OC\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png)\n\n i __Block_byref_val_0block_imp\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png)\n\n`__Block_byref` Copydispose\n\n`__Block_byref` BlockCopy`__Block_byref`copydispose\n\n:ARCbyrefretainMRC\n\n## QA.\n###  __block\n\n`__block`\n\n### forwarding\n\nObjective-C iOSOS X\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png)\n\n__block__block`__Block_byref_id_object_copy_131``__forwarding`\n\n**BlockCopyCopy `__Block_byref`, __forwarding **\n\n### Block\n\n1.  ARC `__NSStackBlock__`blockblockcopy\n2. Block`__NSGlobalBlock__` \n3. GCDblockCocoaUsingBlockcopy\n4. `__NSStackBlock__`copy`__NSMallocBlock__`\n5. `__NSMallocBlock__`copy\n6. `__NSGlobalBlock__`copy\n\n### BlockObjc\n\n1. block oc objc_objectobjc_objectisaclassBlock `__NSMallocBlock__``__NSMallocBlock__``__NSMallocBlock__`classclassruntimeclass\n2. block  object\n","source":"_posts/5.OC-Block-imp.md","raw":"---\ntitle: oc block\ndate: 2019-12-21\ntags: [object-c]\ncategories: \n---\n\n## Block\n\nOC `clang --rewrite-objc code.m` clang  c  c++ ocblock@autoreleasepool[@synchronized](https://caio.ink/article-for-synchronized/)\n\n<!-- more -->\n\n## \n\n1. BlockCStructCStruct\n```c\ntypedef int (^blk_t) (int)\nblk_t blk = ^(int count){return count;};\nblk_t *blkptr = &blk;\n(*blkptr)(10);\n```\n2. Block C\n```c\n//const char text[] = hello;\nconst char *text = hello;\nvoid (^blk)(void) = ^{\n\ttext[0];\n};\n```\n\n## &\nBlock\n\n### \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png)\n\nBlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl\n\n### \n:\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png)\n\nBlockBlockBlockvoid *FuncPtr\n\n**C**\n```c\n//C\n//C\nvoid funcA(char a[20]){\n    char b[20] = a;\n}\n```\n\n###  &&  && \n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png)\n\n\n\nBlockBlock\n\n### ()\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png)\n\nBlockcopydesc0__main_block_copy_0OC\n\nBlockreleasedesc0__main_block_dispose_0OC\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png)\n\n i __Block_byref_val_0block_imp\n\n### __block\n\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png)\n\nclang \n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png)\n\n`__Block_byref` Copydispose\n\n`__Block_byref` BlockCopy`__Block_byref`copydispose\n\n:ARCbyrefretainMRC\n\n## QA.\n###  __block\n\n`__block`\n\n### forwarding\n\nObjective-C iOSOS X\n![](https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png)\n\n__block__block`__Block_byref_id_object_copy_131``__forwarding`\n\n**BlockCopyCopy `__Block_byref`, __forwarding **\n\n### Block\n\n1.  ARC `__NSStackBlock__`blockblockcopy\n2. Block`__NSGlobalBlock__` \n3. GCDblockCocoaUsingBlockcopy\n4. `__NSStackBlock__`copy`__NSMallocBlock__`\n5. `__NSMallocBlock__`copy\n6. `__NSGlobalBlock__`copy\n\n### BlockObjc\n\n1. block oc objc_objectobjc_objectisaclassBlock `__NSMallocBlock__``__NSMallocBlock__``__NSMallocBlock__`classclassruntimeclass\n2. block  object\n","slug":"5.OC-Block-imp","published":1,"updated":"2020-08-29T14:42:58.502Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2ld001f93c94bf23fkf","content":"<h2 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ ocblock@autoreleasepool<a href=\"https://caio.ink/article-for-synchronized/\">@synchronized</a></p>\n<span id=\"more\"></span>\n\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>BlockCStructCStruct<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"title function_\">int</span> <span class=\"params\">(^<span class=\"type\">blk_t</span>)</span> <span class=\"params\">(<span class=\"type\">int</span>)</span></span><br><span class=\"line\"><span class=\"type\">blk_t</span> blk = ^(<span class=\"type\">int</span> count)&#123;<span class=\"keyword\">return</span> count;&#125;;</span><br><span class=\"line\"><span class=\"type\">blk_t</span> *blkptr = &amp;blk;</span><br><span class=\"line\">(*blkptr)(<span class=\"number\">10</span>);</span><br></pre></td></tr></table></figure></li>\n<li>Block C<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//const char text[] = hello;</span></span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> *text = hello;</span><br><span class=\"line\"><span class=\"type\">void</span> (^blk)(<span class=\"type\">void</span>) = ^&#123;</span><br><span class=\"line\">\ttext[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"-amp-\"><a href=\"#-amp-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Block</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png\"></p>\n<p>BlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png\"></p>\n<p>BlockBlockBlockvoid *FuncPtr</p>\n<p><strong>C</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">funcA</span><span class=\"params\">(<span class=\"type\">char</span> a[<span class=\"number\">20</span>])</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> b[<span class=\"number\">20</span>] = a;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"-amp-amp--amp-amp-\"><a href=\"#-amp-amp--amp-amp-\" class=\"headerlink\" title=\" &amp;&amp;  &amp;&amp; \"></a> &amp;&amp;  &amp;&amp; </h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png\"></p>\n<p></p>\n<p>BlockBlock</p>\n<h3 id=\"--\"><a href=\"#--\" class=\"headerlink\" title=\"()\"></a>()</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png\"></p>\n<p>Blockcopydesc0__main_block_copy_0OC</p>\n<p>Blockreleasedesc0__main_block_dispose_0OC</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png\"></p>\n<p> i __Block_byref_val_0block_imp</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png\"></p>\n<p><code>__Block_byref</code> Copydispose</p>\n<p><code>__Block_byref</code> BlockCopy<code>__Block_byref</code>copydispose</p>\n<p>:ARCbyrefretainMRC</p>\n<h2 id=\"QA\"><a href=\"#QA\" class=\"headerlink\" title=\"QA.\"></a>QA.</h2><h3 id=\"block\"><a href=\"#block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><code>__block</code></p>\n<h3 id=\"forwarding\"><a href=\"#forwarding\" class=\"headerlink\" title=\"forwarding\"></a>forwarding</h3><p>Objective-C iOSOS X<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png\"></p>\n<p>__block__block<code>__Block_byref_id_object_copy_131</code><code>__forwarding</code></p>\n<p><strong>BlockCopyCopy <code>__Block_byref</code>, __forwarding </strong></p>\n<h3 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h3><ol>\n<li> ARC <code>__NSStackBlock__</code>blockblockcopy</li>\n<li>Block<code>__NSGlobalBlock__</code> </li>\n<li>GCDblockCocoaUsingBlockcopy</li>\n<li><code>__NSStackBlock__</code>copy<code>__NSMallocBlock__</code></li>\n<li><code>__NSMallocBlock__</code>copy</li>\n<li><code>__NSGlobalBlock__</code>copy</li>\n</ol>\n<h3 id=\"BlockObjc\"><a href=\"#BlockObjc\" class=\"headerlink\" title=\"BlockObjc\"></a>BlockObjc</h3><ol>\n<li>block oc objc_objectobjc_objectisaclassBlock <code>__NSMallocBlock__</code><code>__NSMallocBlock__</code><code>__NSMallocBlock__</code>classclassruntimeclass</li>\n<li>block  object</li>\n</ol>\n","site":{"data":{}},"excerpt":"<h2 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h2><p>OC <code>clang --rewrite-objc code.m</code> clang  c  c++ ocblock@autoreleasepool<a href=\"https://caio.ink/article-for-synchronized/\">@synchronized</a></p>","more":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><ol>\n<li>BlockCStructCStruct<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"title function_\">int</span> <span class=\"params\">(^<span class=\"type\">blk_t</span>)</span> <span class=\"params\">(<span class=\"type\">int</span>)</span></span><br><span class=\"line\"><span class=\"type\">blk_t</span> blk = ^(<span class=\"type\">int</span> count)&#123;<span class=\"keyword\">return</span> count;&#125;;</span><br><span class=\"line\"><span class=\"type\">blk_t</span> *blkptr = &amp;blk;</span><br><span class=\"line\">(*blkptr)(<span class=\"number\">10</span>);</span><br></pre></td></tr></table></figure></li>\n<li>Block C<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//const char text[] = hello;</span></span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"type\">char</span> *text = hello;</span><br><span class=\"line\"><span class=\"type\">void</span> (^blk)(<span class=\"type\">void</span>) = ^&#123;</span><br><span class=\"line\">\ttext[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"-amp-\"><a href=\"#-amp-\" class=\"headerlink\" title=\"&amp;\"></a>&amp;</h2><p>Block</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/e26327c7a8252fbb2df5b1fc39d64cda.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/1c595347ea6f38eb59d8d6801db5a5a0.png\"></p>\n<p>BlockCstructstructBlockimpvoid *FuncPtrBlockstruct__block_impl</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>:<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/9982c40af54e96e97aa13b0b29efdfdc.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/b317fc859fa2d1b0afc1477a73cc7f39.png\"></p>\n<p>BlockBlockBlockvoid *FuncPtr</p>\n<p><strong>C</strong></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"comment\">//C</span></span><br><span class=\"line\"><span class=\"type\">void</span> <span class=\"title function_\">funcA</span><span class=\"params\">(<span class=\"type\">char</span> a[<span class=\"number\">20</span>])</span>&#123;</span><br><span class=\"line\">    <span class=\"type\">char</span> b[<span class=\"number\">20</span>] = a;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"-amp-amp--amp-amp-\"><a href=\"#-amp-amp--amp-amp-\" class=\"headerlink\" title=\" &amp;&amp;  &amp;&amp; \"></a> &amp;&amp;  &amp;&amp; </h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/d24f45909549cba411ff8ef19e8dc548.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0af0536f3686b6366a21ed365e22f437.png\"></p>\n<p></p>\n<p>BlockBlock</p>\n<h3 id=\"--\"><a href=\"#--\" class=\"headerlink\" title=\"()\"></a>()</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/dd51589cfa5279abd032d17d217173d6.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/ae2340f59a762a58e2d0edbfadc9c397.png\"></p>\n<p>Blockcopydesc0__main_block_copy_0OC</p>\n<p>Blockreleasedesc0__main_block_dispose_0OC</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/6215c228093c8e9d52dc2e9568e56fa7.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/29e2701bbf1eb9514c8aa230801bc576.png\"></p>\n<p> i __Block_byref_val_0block_imp</p>\n<h3 id=\"-block\"><a href=\"#-block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/0f6bf9053dada99721d8e83858e6e709.png\"></p>\n<p>clang <br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/63595834f2342745c0191f4babc0ca94.png\"></p>\n<p><code>__Block_byref</code> Copydispose</p>\n<p><code>__Block_byref</code> BlockCopy<code>__Block_byref</code>copydispose</p>\n<p>:ARCbyrefretainMRC</p>\n<h2 id=\"QA\"><a href=\"#QA\" class=\"headerlink\" title=\"QA.\"></a>QA.</h2><h3 id=\"block\"><a href=\"#block\" class=\"headerlink\" title=\"__block\"></a>__block</h3><p><code>__block</code></p>\n<h3 id=\"forwarding\"><a href=\"#forwarding\" class=\"headerlink\" title=\"forwarding\"></a>forwarding</h3><p>Objective-C iOSOS X<br><img src=\"https://blog-caio.oss-cn-hongkong.aliyuncs.com/blog/2019/12/053f17c28960744f29a443720914d877.png\"></p>\n<p>__block__block<code>__Block_byref_id_object_copy_131</code><code>__forwarding</code></p>\n<p><strong>BlockCopyCopy <code>__Block_byref</code>, __forwarding </strong></p>\n<h3 id=\"Block\"><a href=\"#Block\" class=\"headerlink\" title=\"Block\"></a>Block</h3><ol>\n<li> ARC <code>__NSStackBlock__</code>blockblockcopy</li>\n<li>Block<code>__NSGlobalBlock__</code> </li>\n<li>GCDblockCocoaUsingBlockcopy</li>\n<li><code>__NSStackBlock__</code>copy<code>__NSMallocBlock__</code></li>\n<li><code>__NSMallocBlock__</code>copy</li>\n<li><code>__NSGlobalBlock__</code>copy</li>\n</ol>\n<h3 id=\"BlockObjc\"><a href=\"#BlockObjc\" class=\"headerlink\" title=\"BlockObjc\"></a>BlockObjc</h3><ol>\n<li>block oc objc_objectobjc_objectisaclassBlock <code>__NSMallocBlock__</code><code>__NSMallocBlock__</code><code>__NSMallocBlock__</code>classclassruntimeclass</li>\n<li>block  object</li>\n</ol>"},{"title":" -- LeetCode[32]","date":"2019-12-20T16:00:00.000Z","_content":"\n> Hard '('  ')' \n\n<!-- more -->\n\nS\n\n## \n\n...\n\nidp[i]iS[i] `)`  `(`  dp 0 `)` dp\n\n `e()`  `(e)`edp[i-1]\n\n1. S[i] == `)` && S[i-1] == `(`:\n\tdp[i] = dp[i-2] + 2\n\t\n2. S[i] == `)` && S[i-1] == `)` && S[i-dp[i-1]-1] == `(`\n\tdp[i] = dp[i-1] + dp[i-dp[i-1]-2] + 2\n\t\ndp[i-dp[i-1]-2]...\n\n\nO(n)\nO(n)\n\ndiscuss\n\n## \n\n**A......B**\n\n\n1.  `(` \n2.  `)`\n\ndp[<i]i\n\nO(n)\nO(n)\n\n## \n\n...\n\n  \n1. `(`  `)` \n2.  `(`, `)`\n\n\n\n`)` >`(` `e)` e\n\n`(` >`)` `(e` e\n\nO(n)\nO(1)\n","source":"_posts/6.leetcode32.md","raw":"---\ntitle:  -- LeetCode[32]\ndate: 2019-12-21\ntags: [leetcode,]\ncategories: \n---\n\n> Hard '('  ')' \n\n<!-- more -->\n\nS\n\n## \n\n...\n\nidp[i]iS[i] `)`  `(`  dp 0 `)` dp\n\n `e()`  `(e)`edp[i-1]\n\n1. S[i] == `)` && S[i-1] == `(`:\n\tdp[i] = dp[i-2] + 2\n\t\n2. S[i] == `)` && S[i-1] == `)` && S[i-dp[i-1]-1] == `(`\n\tdp[i] = dp[i-1] + dp[i-dp[i-1]-2] + 2\n\t\ndp[i-dp[i-1]-2]...\n\n\nO(n)\nO(n)\n\ndiscuss\n\n## \n\n**A......B**\n\n\n1.  `(` \n2.  `)`\n\ndp[<i]i\n\nO(n)\nO(n)\n\n## \n\n...\n\n  \n1. `(`  `)` \n2.  `(`, `)`\n\n\n\n`)` >`(` `e)` e\n\n`(` >`)` `(e` e\n\nO(n)\nO(1)\n","slug":"6.leetcode32","published":1,"updated":"2020-08-29T14:42:58.502Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2le001h93c97uo53a25","content":"<blockquote>\n<p>Hard (  ) </p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p>S</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>idp[i]iS[i] <code>)</code>  <code>(</code>  dp 0 <code>)</code> dp</p>\n<p> <code>e()</code>  <code>(e)</code>edp[i-1]</p>\n<ol>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>(</code>:<br> dp[i] &#x3D; dp[i-2] + 2</p>\n</li>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-dp[i-1]-1] &#x3D;&#x3D; <code>(</code><br> dp[i] &#x3D; dp[i-1] + dp[i-dp[i-1]-2] + 2</p>\n</li>\n</ol>\n<p>dp[i-dp[i-1]-2]</p>\n<p><br>O(n)<br>O(n)</p>\n<p>discuss</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>AB</strong></p>\n<p></p>\n<ol>\n<li> <code>(</code> </li>\n<li> <code>)</code></li>\n</ol>\n<p>dp[&lt;i]i</p>\n<p>O(n)<br>O(n)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>  </p>\n<ol>\n<li><code>(</code>  <code>)</code> </li>\n<li> <code>(</code>, <code>)</code></li>\n</ol>\n<p></p>\n<p><code>)</code> &gt;<code>(</code> <code>e)</code> e</p>\n<p><code>(</code> &gt;<code>)</code> <code>(e</code> e</p>\n<p>O(n)<br>O(1)</p>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Hard (  ) </p>\n</blockquote>","more":"<p>S</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>idp[i]iS[i] <code>)</code>  <code>(</code>  dp 0 <code>)</code> dp</p>\n<p> <code>e()</code>  <code>(e)</code>edp[i-1]</p>\n<ol>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>(</code>:<br> dp[i] &#x3D; dp[i-2] + 2</p>\n</li>\n<li><p>S[i] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-1] &#x3D;&#x3D; <code>)</code> &amp;&amp; S[i-dp[i-1]-1] &#x3D;&#x3D; <code>(</code><br> dp[i] &#x3D; dp[i-1] + dp[i-dp[i-1]-2] + 2</p>\n</li>\n</ol>\n<p>dp[i-dp[i-1]-2]</p>\n<p><br>O(n)<br>O(n)</p>\n<p>discuss</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p><strong>AB</strong></p>\n<p></p>\n<ol>\n<li> <code>(</code> </li>\n<li> <code>)</code></li>\n</ol>\n<p>dp[&lt;i]i</p>\n<p>O(n)<br>O(n)</p>\n<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><p></p>\n<p>  </p>\n<ol>\n<li><code>(</code>  <code>)</code> </li>\n<li> <code>(</code>, <code>)</code></li>\n</ol>\n<p></p>\n<p><code>)</code> &gt;<code>(</code> <code>e)</code> e</p>\n<p><code>(</code> &gt;<code>)</code> <code>(e</code> e</p>\n<p>O(n)<br>O(1)</p>"},{"title":" -- LeetCode[46]","date":"2020-01-04T16:00:00.000Z","_content":"\n> Medium\n\n<!-- more -->\n\n:\n: [1,2,3]\n:\n[\n  [1,2,3],\n  [1,3,2],\n  [2,1,3],\n  [2,3,1],\n  [3,1,2],\n  [3,2,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n\n     **** \n\n:\n\n, \n\n### \n\n```java\npublic class Solution46 {\n  public List<List<Integer>> permute(int[] nums) {\n\n    List<List<Integer>> res = new ArrayList<>();\n    int[] visited = new int[nums.length];//\n    backtrack(res, nums, new ArrayList<Integer>(), visited);\n    return res;\n\n  }\n\n  private void backtrack(List<List<Integer>> res, int[] nums, ArrayList<Integer> tmp, int[] visited) {\n    if (tmp.size() == nums.length) {\n      res.add(new ArrayList<>(tmp));\n      return;\n    }\n    for (int i = 0; i < nums.length; i++) {\n      if (visited[i] == 1)//\n        continue;\n      tmp.add(nums[i]);//\n      visited[i] = 1;//\n\n      backtrack(res, nums, tmp, visited);\n      //\n      visited[i] = 0;\n      tmp.remove(tmp.size() - 1);\n    }\n  }\n}\n```\n\n[]\n\n\n\nNValueN\nNValuevisited\n\n\n\n\nNvalue\n\n\n### \n\n```java\nclass Solution {\n    public void backtrack(int n, ArrayList<Integer> nums, List<List<Integer>> output, int first) {\n        // if all integers are used up\n        if (first == n)\n            output.add(new ArrayList<Integer>(nums));\n\n        for (int i = first; i < n; i++) {\n            // place i-th integer first\n            // in the current permutation\n            Collections.swap(nums, first, i);\n            // use next integers to complete the permutations\n            backtrack(n, nums, output, first + 1);\n            // backtrack\n            Collections.swap(nums, first, i);\n        }\n    }\n\n    public List<List<Integer>> permute(int[] nums) {\n        // init output list\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        // convert nums into list since the output is a list of lists\n        ArrayList<Integer> nums_lst = new ArrayList<Integer>();\n        for (int num : nums)\n            nums_lst.add(num);\n\n        int n = nums.length;\n        backtrack(n, nums_lst, output, 0);\n        return output;\n    }\n}\n```\n\n LeetCode\n\ntmpswapswap\n\nNvalue Arr[N]\n1. valueNi<NArr[i]N-1\n2.  1 ValueArr\n3. swap\n\n### \nNN-1N-2...\nO(n!)O(n^n)\nO(1) O(n)\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)\n","source":"_posts/7.leetcode46.md","raw":"---\ntitle:  -- LeetCode[46]\ndate: 2020-01-05\ntags: [leetcode,]\ncategories: \n---\n\n> Medium\n\n<!-- more -->\n\n:\n: [1,2,3]\n:\n[\n  [1,2,3],\n  [1,3,2],\n  [2,1,3],\n  [2,3,1],\n  [3,1,2],\n  [3,2,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n\n     **** \n\n:\n\n, \n\n### \n\n```java\npublic class Solution46 {\n  public List<List<Integer>> permute(int[] nums) {\n\n    List<List<Integer>> res = new ArrayList<>();\n    int[] visited = new int[nums.length];//\n    backtrack(res, nums, new ArrayList<Integer>(), visited);\n    return res;\n\n  }\n\n  private void backtrack(List<List<Integer>> res, int[] nums, ArrayList<Integer> tmp, int[] visited) {\n    if (tmp.size() == nums.length) {\n      res.add(new ArrayList<>(tmp));\n      return;\n    }\n    for (int i = 0; i < nums.length; i++) {\n      if (visited[i] == 1)//\n        continue;\n      tmp.add(nums[i]);//\n      visited[i] = 1;//\n\n      backtrack(res, nums, tmp, visited);\n      //\n      visited[i] = 0;\n      tmp.remove(tmp.size() - 1);\n    }\n  }\n}\n```\n\n[]\n\n\n\nNValueN\nNValuevisited\n\n\n\n\nNvalue\n\n\n### \n\n```java\nclass Solution {\n    public void backtrack(int n, ArrayList<Integer> nums, List<List<Integer>> output, int first) {\n        // if all integers are used up\n        if (first == n)\n            output.add(new ArrayList<Integer>(nums));\n\n        for (int i = first; i < n; i++) {\n            // place i-th integer first\n            // in the current permutation\n            Collections.swap(nums, first, i);\n            // use next integers to complete the permutations\n            backtrack(n, nums, output, first + 1);\n            // backtrack\n            Collections.swap(nums, first, i);\n        }\n    }\n\n    public List<List<Integer>> permute(int[] nums) {\n        // init output list\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        // convert nums into list since the output is a list of lists\n        ArrayList<Integer> nums_lst = new ArrayList<Integer>();\n        for (int num : nums)\n            nums_lst.add(num);\n\n        int n = nums.length;\n        backtrack(n, nums_lst, output, 0);\n        return output;\n    }\n}\n```\n\n LeetCode\n\ntmpswapswap\n\nNvalue Arr[N]\n1. valueNi<NArr[i]N-1\n2.  1 ValueArr\n3. swap\n\n### \nNN-1N-2...\nO(n!)O(n^n)\nO(1) O(n)\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)\n","slug":"7.leetcode46","published":1,"updated":"2020-08-29T14:42:58.502Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2lf001m93c933zk76am","content":"<blockquote>\n<p>Medium</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p>:<br>: [1,2,3]<br>:<br>[<br>  [1,2,3],<br>  [1,3,2],<br>  [2,1,3],<br>  [2,3,1],<br>  [3,1,2],<br>  [3,2,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p><br>     <strong></strong> </p>\n<p>:<br><br>, </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution46</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    List&lt;List&lt;Integer&gt;&gt; res = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">    <span class=\"type\">int</span>[] visited = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];<span class=\"comment\">//</span></span><br><span class=\"line\">    backtrack(res, nums, <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(), visited);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; res, <span class=\"type\">int</span>[] nums, ArrayList&lt;Integer&gt; tmp, <span class=\"type\">int</span>[] visited)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">      res.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;(tmp));</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (visited[i] == <span class=\"number\">1</span>)<span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      tmp.add(nums[i]);<span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">1</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">      backtrack(res, nums, tmp, visited);</span><br><span class=\"line\">      <span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">      tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>[]</p>\n<p></p>\n<p>NValueN<br>NValuevisited<br></p>\n<p></p>\n<p>Nvalue<br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(<span class=\"type\">int</span> n, ArrayList&lt;Integer&gt; nums, List&lt;List&lt;Integer&gt;&gt; output, <span class=\"type\">int</span> first)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// if all integers are used up</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first == n)</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(nums));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> first; i &lt; n; i++) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// place i-th integer first</span></span><br><span class=\"line\">            <span class=\"comment\">// in the current permutation</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">            <span class=\"comment\">// use next integers to complete the permutations</span></span><br><span class=\"line\">            backtrack(n, nums, output, first + <span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// backtrack</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// init output list</span></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// convert nums into list since the output is a list of lists</span></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; nums_lst = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> num : nums)</span><br><span class=\"line\">            nums_lst.add(num);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> nums.length;</span><br><span class=\"line\">        backtrack(n, nums_lst, output, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> LeetCode</p>\n<p>tmpswapswap</p>\n<p>Nvalue Arr[N]</p>\n<ol>\n<li>valueNi&lt;NArr[i]N-1</li>\n<li> 1 ValueArr</li>\n<li>swap</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NN-1N-2<br>O(n!)O(n^n)<br>O(1) O(n)</p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Medium</p>\n</blockquote>","more":"<p>:<br>: [1,2,3]<br>:<br>[<br>  [1,2,3],<br>  [1,3,2],<br>  [2,1,3],<br>  [2,3,1],<br>  [3,1,2],<br>  [3,2,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p><br>     <strong></strong> </p>\n<p>:<br><br>, </p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution46</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    List&lt;List&lt;Integer&gt;&gt; res = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">    <span class=\"type\">int</span>[] visited = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];<span class=\"comment\">//</span></span><br><span class=\"line\">    backtrack(res, nums, <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(), visited);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; res, <span class=\"type\">int</span>[] nums, ArrayList&lt;Integer&gt; tmp, <span class=\"type\">int</span>[] visited)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">      res.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;(tmp));</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (visited[i] == <span class=\"number\">1</span>)<span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">      tmp.add(nums[i]);<span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">1</span>;<span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">      backtrack(res, nums, tmp, visited);</span><br><span class=\"line\">      <span class=\"comment\">//</span></span><br><span class=\"line\">      visited[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">      tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>[]</p>\n<p></p>\n<p>NValueN<br>NValuevisited<br></p>\n<p></p>\n<p>Nvalue<br></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Solution</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backtrack</span><span class=\"params\">(<span class=\"type\">int</span> n, ArrayList&lt;Integer&gt; nums, List&lt;List&lt;Integer&gt;&gt; output, <span class=\"type\">int</span> first)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// if all integers are used up</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (first == n)</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;(nums));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> first; i &lt; n; i++) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// place i-th integer first</span></span><br><span class=\"line\">            <span class=\"comment\">// in the current permutation</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">            <span class=\"comment\">// use next integers to complete the permutations</span></span><br><span class=\"line\">            backtrack(n, nums, output, first + <span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// backtrack</span></span><br><span class=\"line\">            Collections.swap(nums, first, i);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permute</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// init output list</span></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// convert nums into list since the output is a list of lists</span></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; nums_lst = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Integer&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> num : nums)</span><br><span class=\"line\">            nums_lst.add(num);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> nums.length;</span><br><span class=\"line\">        backtrack(n, nums_lst, output, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p> LeetCode</p>\n<p>tmpswapswap</p>\n<p>Nvalue Arr[N]</p>\n<ol>\n<li>valueNi&lt;NArr[i]N-1</li>\n<li> 1 ValueArr</li>\n<li>swap</li>\n</ol>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p>NN-1N-2<br>O(n!)O(n^n)<br>O(1) O(n)</p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>"},{"title":"II -- LeetCode[37]","date":"2020-01-06T16:00:00.000Z","_content":"\n> Medium\n\n<!-- more -->\n\n:\n: [1,1,2]\n:\n[\n  [1,1,2],\n  [1,2,1],\n  [2,1,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n [LeetCode 46](https://caio.ink/leetcode46/) case\n\n [LeetCode 46](https://caio.ink/leetcode46/) \n\n46\n\n### \n\n```java\npublic class Solution47 {\n    public void backTrace(int[] nums, int[] usedMark, List<List<Integer>> output, LinkedList<Integer> tmp) {\n        if (tmp.size() == nums.length) {\n            output.add(new LinkedList<Integer>(tmp));\n        }\n\n        for (int i = 0; i < nums.length;) {\n            if (usedMark[i] == 1){\n                i++;\n                continue;\n            }\n\n            tmp.add(nums[i]);\n\n            usedMark[i] = 1;\n\n            int startIndex = i;\n            int endIndex = i;\n\n            while ((endIndex != (nums.length - 1)) && (nums[endIndex + 1] == nums[i])) {\n                endIndex++;\n            }\n\n            backTrace(nums, usedMark, output, tmp);\n\n            // backtrace\n            tmp.remove(tmp.size() - 1);\n            usedMark[i] = 0;\n            // next index \n            i = endIndex + 1;\n        }\n\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        LinkedList<Integer> tmp = new LinkedList<Integer>();\n\n        int[] usedMark = new int[nums.length];\n\n        backTrace(nums, usedMark, output, tmp);\n        return output;\n    }\n}\n```\n\n46used\n\nmap\n\nindex=0used\n\n\n\n\n### \n\n```java\npublic class Solution47_2 {\n    private void backTrace(List<List<Integer>> output, ArrayList<Integer> data, int start) {\n        if (start == data.size()) {\n            output.add(new LinkedList<>(data));\n        }\n\n        int lastValue = 0;\n        for (int i = start; i < data.size(); i++) {\n            int value = data.get(i);\n            if (i != start && lastValue == value){\n                continue;\n            }\n            lastValue = value;\n            // \n            for (int j = i; j > start; j--) {\n                data.set(j, data.get(j-1));\n            }\n            data.set(start, value);\n\n            backTrace(output, data, start+1);\n            // \n            for (int j = start; j < i; j++) {\n                data.set(j, data.get(j+1));\n            }\n            data.set(i, value);\n        }\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        ArrayList<Integer> data = new ArrayList<>();\n\n        for (int value : nums) {\n            data.add(value);\n        }\n\n        backTrace(output, data, 0);\n\n        return output;\n    }\n}\n```\n\n4647\n\n46 ````range ````range``\n\n\n\n\n\n  `a a b c`a<b<c\n  `a` `a`\n `a``b`,`a``b` `a`\n `c``a`,`c``c`...\n\nrange start -> N (N) i ``\n\n`[start i)` ,istart``range\n\n`(start i]`starti\n\n### \n\n\n O(n)\n O(n^n)\n\n\n O(1)\nO(n!)\n\n``usedMark``\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)","source":"_posts/8.leetcode47.md","raw":"---\ntitle: II -- LeetCode[37]\ndate: 2020-01-07\ntags: [leetcode,]\ncategories: \n---\n\n> Medium\n\n<!-- more -->\n\n:\n: [1,1,2]\n:\n[\n  [1,1,2],\n  [1,2,1],\n  [2,1,1]\n]\n\n****\n[](https://caio.ink/tag/arg-backtrack/)\n\n [LeetCode 46](https://caio.ink/leetcode46/) case\n\n [LeetCode 46](https://caio.ink/leetcode46/) \n\n46\n\n### \n\n```java\npublic class Solution47 {\n    public void backTrace(int[] nums, int[] usedMark, List<List<Integer>> output, LinkedList<Integer> tmp) {\n        if (tmp.size() == nums.length) {\n            output.add(new LinkedList<Integer>(tmp));\n        }\n\n        for (int i = 0; i < nums.length;) {\n            if (usedMark[i] == 1){\n                i++;\n                continue;\n            }\n\n            tmp.add(nums[i]);\n\n            usedMark[i] = 1;\n\n            int startIndex = i;\n            int endIndex = i;\n\n            while ((endIndex != (nums.length - 1)) && (nums[endIndex + 1] == nums[i])) {\n                endIndex++;\n            }\n\n            backTrace(nums, usedMark, output, tmp);\n\n            // backtrace\n            tmp.remove(tmp.size() - 1);\n            usedMark[i] = 0;\n            // next index \n            i = endIndex + 1;\n        }\n\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        LinkedList<Integer> tmp = new LinkedList<Integer>();\n\n        int[] usedMark = new int[nums.length];\n\n        backTrace(nums, usedMark, output, tmp);\n        return output;\n    }\n}\n```\n\n46used\n\nmap\n\nindex=0used\n\n\n\n\n### \n\n```java\npublic class Solution47_2 {\n    private void backTrace(List<List<Integer>> output, ArrayList<Integer> data, int start) {\n        if (start == data.size()) {\n            output.add(new LinkedList<>(data));\n        }\n\n        int lastValue = 0;\n        for (int i = start; i < data.size(); i++) {\n            int value = data.get(i);\n            if (i != start && lastValue == value){\n                continue;\n            }\n            lastValue = value;\n            // \n            for (int j = i; j > start; j--) {\n                data.set(j, data.get(j-1));\n            }\n            data.set(start, value);\n\n            backTrace(output, data, start+1);\n            // \n            for (int j = start; j < i; j++) {\n                data.set(j, data.get(j+1));\n            }\n            data.set(i, value);\n        }\n    }\n\n    public List<List<Integer>> permuteUnique(int[] nums) {\n        quickSort(nums, 0, nums.length - 1);\n\n        List<List<Integer>> output = new LinkedList<List<Integer>>();\n\n        ArrayList<Integer> data = new ArrayList<>();\n\n        for (int value : nums) {\n            data.add(value);\n        }\n\n        backTrace(output, data, 0);\n\n        return output;\n    }\n}\n```\n\n4647\n\n46 ````range ````range``\n\n\n\n\n\n  `a a b c`a<b<c\n  `a` `a`\n `a``b`,`a``b` `a`\n `c``a`,`c``c`...\n\nrange start -> N (N) i ``\n\n`[start i)` ,istart``range\n\n`(start i]`starti\n\n### \n\n\n O(n)\n O(n^n)\n\n\n O(1)\nO(n!)\n\n``usedMark``\n\n:\n1. [39](https://leetcode-cn.com/problems/combination-sum)\n2. [40II](https://leetcode-cn.com/problems/combination-sum-ii)\n3. [46](https://leetcode-cn.com/problems/permutations)--[](https://caio.ink/leetcode46/)\n4. [47II](https://leetcode-cn.com/problems/permutations-ii)--[](https://caio.ink/leetcode47/)\n5. [77](https://leetcode-cn.com/problems/combinations)\n6. [78](https://leetcode-cn.com/problems/subsets)\n7. [90II](https://leetcode-cn.com/problems/subsets-ii)","slug":"8.leetcode47","published":1,"updated":"2020-08-29T14:42:58.503Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2lg001o93c977t96ga3","content":"<blockquote>\n<p>Medium</p>\n</blockquote>\n<span id=\"more\"></span>\n\n<p>:<br>: [1,1,2]<br>:<br>[<br>  [1,1,2],<br>  [1,2,1],<br>  [2,1,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> case</p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> </p>\n<p>46</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(<span class=\"type\">int</span>[] nums, <span class=\"type\">int</span>[] usedMark, List&lt;List&lt;Integer&gt;&gt; output, LinkedList&lt;Integer&gt; tmp)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;(tmp));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length;) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (usedMark[i] == <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">                i++;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            tmp.add(nums[i]);</span><br><span class=\"line\"></span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">startIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">endIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((endIndex != (nums.length - <span class=\"number\">1</span>)) &amp;&amp; (nums[endIndex + <span class=\"number\">1</span>] == nums[i])) &#123;</span><br><span class=\"line\">                endIndex++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// backtrace</span></span><br><span class=\"line\">            tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"comment\">// next index </span></span><br><span class=\"line\">            i = endIndex + <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        LinkedList&lt;Integer&gt; tmp = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span>[] usedMark = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>46used</p>\n<p>map</p>\n<p>index&#x3D;0used</p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47_2</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; output, ArrayList&lt;Integer&gt; data, <span class=\"type\">int</span> start)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (start == data.size()) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;&gt;(data));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">lastValue</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> start; i &lt; data.size(); i++) &#123;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> data.get(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i != start &amp;&amp; lastValue == value)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            lastValue = value;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> i; j &gt; start; j--) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j-<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(start, value);</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(output, data, start+<span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> start; j &lt; i; j++) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j+<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(i, value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; data = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> value : nums) &#123;</span><br><span class=\"line\">            data.add(value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(output, data, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>4647</p>\n<p>46 <code></code><code></code>range <code></code><code></code>range<code></code></p>\n<p></p>\n<p></p>\n<p>  <code>a a b c</code>a&lt;b&lt;c<br>  <code>a</code> <code>a</code><br> <code>a</code><code>b</code>,<code>a</code><code>b</code> <code>a</code><br> <code>c</code><code>a</code>,<code>c</code><code>c</code></p>\n<p>range start -&gt; N (N) i <code></code></p>\n<p><code>[start i)</code> ,istart<code></code>range</p>\n<p><code>(start i]</code>starti</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br> O(n)<br> O(n^n)</p>\n<p><br> O(1)<br>O(n!)</p>\n<p><code></code>usedMark<code></code></p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<blockquote>\n<p>Medium</p>\n</blockquote>","more":"<p>:<br>: [1,1,2]<br>:<br>[<br>  [1,1,2],<br>  [1,2,1],<br>  [2,1,1]<br>]</p>\n<p><strong></strong><br><a href=\"https://caio.ink/tag/arg-backtrack/\"></a></p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> case</p>\n<p> <a href=\"https://caio.ink/leetcode46/\">LeetCode 46</a> </p>\n<p>46</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(<span class=\"type\">int</span>[] nums, <span class=\"type\">int</span>[] usedMark, List&lt;List&lt;Integer&gt;&gt; output, LinkedList&lt;Integer&gt; tmp)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tmp.size() == nums.length) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;(tmp));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; nums.length;) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (usedMark[i] == <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">                i++;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            tmp.add(nums[i]);</span><br><span class=\"line\"></span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">startIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">endIndex</span> <span class=\"operator\">=</span> i;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((endIndex != (nums.length - <span class=\"number\">1</span>)) &amp;&amp; (nums[endIndex + <span class=\"number\">1</span>] == nums[i])) &#123;</span><br><span class=\"line\">                endIndex++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// backtrace</span></span><br><span class=\"line\">            tmp.remove(tmp.size() - <span class=\"number\">1</span>);</span><br><span class=\"line\">            usedMark[i] = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"comment\">// next index </span></span><br><span class=\"line\">            i = endIndex + <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        LinkedList&lt;Integer&gt; tmp = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;Integer&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span>[] usedMark = <span class=\"keyword\">new</span> <span class=\"title class_\">int</span>[nums.length];</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(nums, usedMark, output, tmp);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>46used</p>\n<p>map</p>\n<p>index&#x3D;0used</p>\n<p></p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Solution47_2</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">backTrace</span><span class=\"params\">(List&lt;List&lt;Integer&gt;&gt; output, ArrayList&lt;Integer&gt; data, <span class=\"type\">int</span> start)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (start == data.size()) &#123;</span><br><span class=\"line\">            output.add(<span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;&gt;(data));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">int</span> <span class=\"variable\">lastValue</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> start; i &lt; data.size(); i++) &#123;</span><br><span class=\"line\">            <span class=\"type\">int</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> data.get(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (i != start &amp;&amp; lastValue == value)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            lastValue = value;</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> i; j &gt; start; j--) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j-<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(start, value);</span><br><span class=\"line\"></span><br><span class=\"line\">            backTrace(output, data, start+<span class=\"number\">1</span>);</span><br><span class=\"line\">            <span class=\"comment\">// </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">j</span> <span class=\"operator\">=</span> start; j &lt; i; j++) &#123;</span><br><span class=\"line\">                data.set(j, data.get(j+<span class=\"number\">1</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            data.set(i, value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> List&lt;List&lt;Integer&gt;&gt; <span class=\"title function_\">permuteUnique</span><span class=\"params\">(<span class=\"type\">int</span>[] nums)</span> &#123;</span><br><span class=\"line\">        quickSort(nums, <span class=\"number\">0</span>, nums.length - <span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;List&lt;Integer&gt;&gt; output = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedList</span>&lt;List&lt;Integer&gt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        ArrayList&lt;Integer&gt; data = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"type\">int</span> value : nums) &#123;</span><br><span class=\"line\">            data.add(value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        backTrace(output, data, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>4647</p>\n<p>46 <code></code><code></code>range <code></code><code></code>range<code></code></p>\n<p></p>\n<p></p>\n<p>  <code>a a b c</code>a&lt;b&lt;c<br>  <code>a</code> <code>a</code><br> <code>a</code><code>b</code>,<code>a</code><code>b</code> <code>a</code><br> <code>c</code><code>a</code>,<code>c</code><code>c</code></p>\n<p>range start -&gt; N (N) i <code></code></p>\n<p><code>[start i)</code> ,istart<code></code>range</p>\n<p><code>(start i]</code>starti</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><p><br> O(n)<br> O(n^n)</p>\n<p><br> O(1)<br>O(n!)</p>\n<p><code></code>usedMark<code></code></p>\n<p>:</p>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum\">39</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combination-sum-ii\">40II</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations\">46</a><a href=\"https://caio.ink/leetcode46/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/permutations-ii\">47II</a><a href=\"https://caio.ink/leetcode47/\"></a></li>\n<li><a href=\"https://leetcode-cn.com/problems/combinations\">77</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets\">78</a></li>\n<li><a href=\"https://leetcode-cn.com/problems/subsets-ii\">90II</a></li>\n</ol>"},{"title":"leetcode -- ","date":"2020-01-12T16:00:00.000Z","_content":"\n## \n\n<!-- more -->\n\n### 2020-01-11 17\n\n#### \n[]()\n\n#### \n[]()\n\n\n#### \n[](https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/)\n\n****sumEvenGrandparent\n#### \n[](https://leetcode-cn.com/problems/distinct-echo-substrings/)\n\n\n---","source":"_posts/9.LeetCode-week-match.md","raw":"---\ntitle: leetcode -- \ndate: 2020-01-13\ntags: [leetcode,]\ncategories: \n---\n\n## \n\n<!-- more -->\n\n### 2020-01-11 17\n\n#### \n[]()\n\n#### \n[]()\n\n\n#### \n[](https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/)\n\n****sumEvenGrandparent\n#### \n[](https://leetcode-cn.com/problems/distinct-echo-substrings/)\n\n\n---","slug":"9.LeetCode-week-match","published":1,"updated":"2020-08-29T14:42:58.503Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3fts2lh001s93c9aaxg0n4g","content":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2><span id=\"more\"></span>\n\n<h3 id=\"2020-01-11-17\"><a href=\"#2020-01-11-17\" class=\"headerlink\" title=\"2020-01-11 17\"></a>2020-01-11 17</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/\"></a></p>\n<p><strong></strong>sumEvenGrandparent</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/distinct-echo-substrings/\"></a><br></p>\n<hr>\n","site":{"data":{}},"excerpt":"<h2 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h2>","more":"<h3 id=\"2020-01-11-17\"><a href=\"#2020-01-11-17\" class=\"headerlink\" title=\"2020-01-11 17\"></a>2020-01-11 17</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"\"></a></p>\n<p></p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/sum-of-nodes-with-even-valued-grandparent/\"></a></p>\n<p><strong></strong>sumEvenGrandparent</p>\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><p><a href=\"https://leetcode-cn.com/problems/distinct-echo-substrings/\"></a><br></p>\n<hr>"}],"PostAsset":[],"PostCategory":[{"post_id":"cl3fts2kr000193c9etco91wu","category_id":"cl3fts2kv000493c903wp17p1","_id":"cl3fts2l2000e93c982f64os4"},{"post_id":"cl3fts2kt000393c91dvigoxa","category_id":"cl3fts2kv000493c903wp17p1","_id":"cl3fts2l4000j93c969vk39qc"},{"post_id":"cl3fts2kx000693c929wiexfk","category_id":"cl3fts2l2000d93c9ga3vg2ez","_id":"cl3fts2l6000p93c98ym29h9b"},{"post_id":"cl3fts2l5000n93c9e2ctfcg8","category_id":"cl3fts2kv000493c903wp17p1","_id":"cl3fts2l8000v93c92y8a8t1s"},{"post_id":"cl3fts2ky000793c9co5a5x1n","category_id":"cl3fts2l4000l93c9h7l5fdgu","_id":"cl3fts2l9000z93c939z50md8"},{"post_id":"cl3fts2l6000s93c95jvsavs0","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2la001393c9gv1o2wmz"},{"post_id":"cl3fts2ky000893c9fo2723uw","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2la001593c9796m90wu"},{"post_id":"cl3fts2l7000u93c95lk8gefu","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2lb001a93c92f9d43k2"},{"post_id":"cl3fts2l8000y93c961a23m26","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2lc001c93c9bldmdiuy"},{"post_id":"cl3fts2l9001293c98xug1hap","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2ld001g93c9187dgq7x"},{"post_id":"cl3fts2l0000b93c910qu9891","category_id":"cl3fts2l8000x93c9edyrb5uf","_id":"cl3fts2le001i93c9er9vcvky"},{"post_id":"cl3fts2la001493c984lf57h1","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2lf001n93c9func4x54"},{"post_id":"cl3fts2lb001993c9512sabx2","category_id":"cl3fts2l2000d93c9ga3vg2ez","_id":"cl3fts2lg001p93c94u7ogbh7"},{"post_id":"cl3fts2l1000c93c90rsfaasa","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2lh001t93c93y0t24ek"},{"post_id":"cl3fts2l2000g93c92mmz74of","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2li001v93c96l9s5hyx"},{"post_id":"cl3fts2le001h93c97uo53a25","category_id":"cl3fts2kv000493c903wp17p1","_id":"cl3fts2li001y93c96gf6g0po"},{"post_id":"cl3fts2lf001m93c933zk76am","category_id":"cl3fts2kv000493c903wp17p1","_id":"cl3fts2lj002193c9byioaomv"},{"post_id":"cl3fts2l3000i93c999cn8w1v","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2lk002493c906z84w2p"},{"post_id":"cl3fts2lg001o93c977t96ga3","category_id":"cl3fts2kv000493c903wp17p1","_id":"cl3fts2lk002693c9emt64vir"},{"post_id":"cl3fts2lh001s93c9aaxg0n4g","category_id":"cl3fts2kv000493c903wp17p1","_id":"cl3fts2lk002793c9d8nf1a7u"},{"post_id":"cl3fts2l5000o93c93g595tld","category_id":"cl3fts2l6000q93c954anbdah","_id":"cl3fts2ll002a93c9f7lp2mxm"},{"post_id":"cl3fts2lc001b93c9ej8w51iu","category_id":"cl3fts2li001w93c9ak64a850","_id":"cl3fts2ll002c93c9g7eq26es"},{"post_id":"cl3fts2ld001f93c94bf23fkf","category_id":"cl3fts2li001w93c9ak64a850","_id":"cl3fts2lm002f93c988rf2mnp"}],"PostTag":[{"post_id":"cl3fts2kr000193c9etco91wu","tag_id":"cl3fts2kw000593c9hbsdg0h0","_id":"cl3fts2l3000h93c93xeu6kg4"},{"post_id":"cl3fts2kr000193c9etco91wu","tag_id":"cl3fts2kz000a93c9bka18cyp","_id":"cl3fts2l4000k93c9dfmrbrya"},{"post_id":"cl3fts2kt000393c91dvigoxa","tag_id":"cl3fts2l2000f93c95iyr234s","_id":"cl3fts2l7000t93c991i78neh"},{"post_id":"cl3fts2kt000393c91dvigoxa","tag_id":"cl3fts2l4000m93c9608y5idk","_id":"cl3fts2l8000w93c991a0hw0e"},{"post_id":"cl3fts2kx000693c929wiexfk","tag_id":"cl3fts2l6000r93c90nzgh24b","_id":"cl3fts2l9001193c9hkd333dg"},{"post_id":"cl3fts2ky000793c9co5a5x1n","tag_id":"cl3fts2l2000f93c95iyr234s","_id":"cl3fts2lb001893c94a0z2mir"},{"post_id":"cl3fts2ld001f93c94bf23fkf","tag_id":"cl3fts2l2000f93c95iyr234s","_id":"cl3fts2lf001l93c90wv94ybp"},{"post_id":"cl3fts2ky000893c9fo2723uw","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2li001u93c9drjhg9x7"},{"post_id":"cl3fts2ky000893c9fo2723uw","tag_id":"cl3fts2lc001e93c93ew33gly","_id":"cl3fts2li001x93c9bcub283f"},{"post_id":"cl3fts2ky000893c9fo2723uw","tag_id":"cl3fts2lf001k93c99mal2gxr","_id":"cl3fts2lj002093c9hwzgdy9d"},{"post_id":"cl3fts2l0000b93c910qu9891","tag_id":"cl3fts2lh001r93c92avjdx31","_id":"cl3fts2lj002393c9gc489umk"},{"post_id":"cl3fts2l1000c93c90rsfaasa","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2ll002993c9hcafdvwq"},{"post_id":"cl3fts2l1000c93c90rsfaasa","tag_id":"cl3fts2lc001e93c93ew33gly","_id":"cl3fts2ll002b93c95d344kqs"},{"post_id":"cl3fts2l2000g93c92mmz74of","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2lm002e93c98smxdwd6"},{"post_id":"cl3fts2l3000i93c999cn8w1v","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2lm002h93c9duz0fwru"},{"post_id":"cl3fts2l5000n93c9e2ctfcg8","tag_id":"cl3fts2kw000593c9hbsdg0h0","_id":"cl3fts2ln002j93c903x1hi3r"},{"post_id":"cl3fts2l5000n93c9e2ctfcg8","tag_id":"cl3fts2lm002g93c9c2me5n7l","_id":"cl3fts2ln002k93c99pf3d7zw"},{"post_id":"cl3fts2l5000o93c93g595tld","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2ln002m93c9hh1rekvi"},{"post_id":"cl3fts2l6000s93c95jvsavs0","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2lo002o93c9exqs6grd"},{"post_id":"cl3fts2l7000u93c95lk8gefu","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2lo002q93c98utr1vl8"},{"post_id":"cl3fts2l8000y93c961a23m26","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2lo002s93c9ch0j5zww"},{"post_id":"cl3fts2l9001293c98xug1hap","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2lo002u93c9fjku8aun"},{"post_id":"cl3fts2la001493c984lf57h1","tag_id":"cl3fts2la001793c9doxq5zhw","_id":"cl3fts2lp002w93c9b7p6bhl9"},{"post_id":"cl3fts2lb001993c9512sabx2","tag_id":"cl3fts2l6000r93c90nzgh24b","_id":"cl3fts2lp002y93c975smhrko"},{"post_id":"cl3fts2lb001993c9512sabx2","tag_id":"cl3fts2lp002v93c96l690naz","_id":"cl3fts2lp002z93c96r87hosb"},{"post_id":"cl3fts2lc001b93c9ej8w51iu","tag_id":"cl3fts2l2000f93c95iyr234s","_id":"cl3fts2lp003193c9ge0c5zwf"},{"post_id":"cl3fts2lc001b93c9ej8w51iu","tag_id":"cl3fts2lp002x93c92z39egta","_id":"cl3fts2lq003293c9hlbtfngz"},{"post_id":"cl3fts2le001h93c97uo53a25","tag_id":"cl3fts2kw000593c9hbsdg0h0","_id":"cl3fts2lq003493c9gzsffwi9"},{"post_id":"cl3fts2le001h93c97uo53a25","tag_id":"cl3fts2lp003093c92qw0a3vc","_id":"cl3fts2lq003593c9gk5hh9l2"},{"post_id":"cl3fts2lf001m93c933zk76am","tag_id":"cl3fts2kw000593c9hbsdg0h0","_id":"cl3fts2lq003793c9el35b998"},{"post_id":"cl3fts2lf001m93c933zk76am","tag_id":"cl3fts2lq003393c912zxf0c3","_id":"cl3fts2lq003893c938er6q4p"},{"post_id":"cl3fts2lg001o93c977t96ga3","tag_id":"cl3fts2kw000593c9hbsdg0h0","_id":"cl3fts2lq003a93c951hh212w"},{"post_id":"cl3fts2lg001o93c977t96ga3","tag_id":"cl3fts2lq003393c912zxf0c3","_id":"cl3fts2lr003b93c91h8663ib"},{"post_id":"cl3fts2lh001s93c9aaxg0n4g","tag_id":"cl3fts2kw000593c9hbsdg0h0","_id":"cl3fts2lr003c93c98wu69job"},{"post_id":"cl3fts2lh001s93c9aaxg0n4g","tag_id":"cl3fts2lq003993c92wcm55wi","_id":"cl3fts2lr003d93c94n3j0nuo"}],"Tag":[{"name":"leetcode","_id":"cl3fts2kw000593c9hbsdg0h0"},{"name":"","_id":"cl3fts2kz000a93c9bka18cyp"},{"name":"object-c","_id":"cl3fts2l2000f93c95iyr234s"},{"name":"","_id":"cl3fts2l4000m93c9608y5idk"},{"name":"","_id":"cl3fts2l6000r93c90nzgh24b"},{"name":"sqlite3","_id":"cl3fts2la001793c9doxq5zhw"},{"name":"os","_id":"cl3fts2lc001e93c93ew33gly"},{"name":"shm","_id":"cl3fts2lf001k93c99mal2gxr"},{"name":"GoMobile","_id":"cl3fts2lh001r93c92avjdx31"},{"name":"","_id":"cl3fts2lm002g93c9c2me5n7l"},{"name":"","_id":"cl3fts2lp002v93c96l690naz"},{"name":"","_id":"cl3fts2lp002x93c92z39egta"},{"name":"","_id":"cl3fts2lp003093c92qw0a3vc"},{"name":"","_id":"cl3fts2lq003393c912zxf0c3"},{"name":"","_id":"cl3fts2lq003993c92wcm55wi"}]}}